<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ¬Ø§Ø± - ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±</title>
    <!-- Leaflet & Routing CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bootstrap (Ù„Ù„Ù€ modals Ùˆ Ø§Ù„Ø£Ø²Ø±Ø§Ø±) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #f8f9fa;
            --accent-color: #28a745;
            --text-color: #333;
            --light-text: #6c757d;
            --border-color: #dee2e6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; margin: 0; font-family: 'Tahoma', 'Arial', sans-serif; background: #f5f5f5; color: var(--text-color); }
        body { display: flex; flex-direction: column; }

        header {
            background: var(--primary-color);
            color: #fff;
            padding: 12px 18px;
            position: sticky; top: 0;
            z-index: 1100;
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }

        .header-content{ display:flex; align-items:center; gap:10px }
        .back-button{ background: rgba(255,255,255,0.15); border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer }
        .back-button i{ transform: rotate(180deg); }
        #globalMerchantName{ font-weight:700 }

        #mapType{ position:absolute; top:72px; left:12px; z-index:1000; background:#fff; padding:8px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.12); }

        #container{ display:flex; flex:1; height: calc(100vh - 120px); gap:12px; padding:12px; }

        #merchant-details{ width:400px; max-width:40%; background:#fff; padding:16px; border-radius:10px; overflow:auto; box-shadow:0 6px 18px rgba(0,0,0,0.06); }

        #map{ flex:1; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); }

        .merchant-header{ display:flex; align-items:center; gap:12px; margin-bottom:14px; }
        .merchant-avatar{ width:76px; height:76px; border-radius:50%; background:var(--primary-color); display:flex; align-items:center; justify-content:center; color:#fff; font-size:34px }
        .merchant-name{ font-size:20px; font-weight:700; color:var(--primary-color) }
        .merchant-category{ color:var(--light-text); font-size:13px }

        .section-title{ font-weight:700; color:var(--primary-color); margin-bottom:8px; display:flex; align-items:center; gap:8px }
        .detail-item{ display:flex; gap:10px; margin-bottom:12px; align-items:flex-start }
        .detail-icon{ width:36px; height:36px; border-radius:8px; background:#f1f3f5; display:flex; align-items:center; justify-content:center; color:var(--primary-color) }
        .detail-content{ flex:1 }
        .detail-label{ font-size:12px; color:var(--light-text); margin-bottom:4px }
        .detail-value{ font-size:15px; word-break:break-word }

        .action-buttons{ display:flex; gap:8px; margin-top:8px }
        .action-btn{ padding:8px 10px; border-radius:8px; border:none; cursor:pointer; display:inline-flex; gap:8px; align-items:center }
        .call-btn{ background:var(--accent-color); color:#fff }
        .whatsapp-btn{ background:#25D366; color:#fff }
        .share-btn{ background:var(--primary-color); color:#fff }
        .secondary-btn{ background:#f8f9fa; color:var(--text-color); border:1px solid var(--border-color) }

        .route-info{ background:#fff; padding:10px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.06); margin-top:10px }

        .loading{ display:flex; justify-content:center; align-items:center; height:150px; flex-direction:column; gap:12px }
        .spinner{ width:40px; height:40px; border:4px solid rgba(0,123,255,0.18); border-top-color:var(--primary-color); border-radius:50%; animation:spin 1s linear infinite }
        @keyframes spin{ to{ transform:rotate(360deg) } }

        footer{ text-align:center; padding:12px; background:var(--secondary-color); font-size:13px; color:var(--light-text); margin-top:auto }

        /* Ø¥Ø´Ø¹Ø§Ø± ÙØªØ­ Ø§Ù„ØµÙØ­Ø© */
        #pageAlert {
            position: fixed;
            top: 70px;
            right: 12px;
            z-index: 1200;
            display: none;
            min-width: 260px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            border-radius: 8px;
            background: #fff;
            padding: 10px 12px;
            font-weight: 600;
            transition: opacity 0.5s;
        }

        /* Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„ØªØ§Ø¬Ø± */
        #productMerchantAlert {
            position: fixed;
            top: 70px;
            left: 12px;
            z-index: 1200;
            background: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            border-right: 4px solid var(--accent-color);
            max-width: 300px;
            animation: slideInLeft 0.5s ease-out;
        }

        #productMerchantAlert .alert-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #productMerchantAlert .alert-content {
            font-size: 14px;
            color: var(--text-color);
            line-height: 1.4;
        }

        #productMerchantAlert .alert-close {
            position: absolute;
            top: 8px;
            left: 8px;
            background: none;
            border: none;
            color: var(--light-text);
            cursor: pointer;
            font-size: 14px;
        }

        @keyframes slideInLeft {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Responsive */
        @media(max-width:900px){ 
            #container{ flex-direction:column } 
            #merchant-details{ width:100%; max-width:100%; height:40vh } 
            #map{ height:56vh } 
            #mapType{ top:58px } 
            #productMerchantAlert {
                max-width: 90%;
                left: 5%;
                right: 5%;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <button class="back-button" onclick="goBack()"><i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</button>
            <div>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±</div>
        </div>
        <div id="globalMerchantName">...</div>
    </header>

    <!-- Ø¥Ø´Ø¹Ø§Ø± ÙŠØ¸Ù‡Ø± Ø¹Ù†Ø¯ Ø§Ù„ÙØªØ­ -->
    <div id="pageAlert">
        <i class="fas fa-bell"></i>&nbsp; ØªÙ… ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±
        <div style="font-weight:400;font-size:13px;color:#666;margin-top:6px" id="alertSub">...</div>
    </div>

    <!-- Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„ØªØ§Ø¬Ø± -->
    <div id="productMerchantAlert" style="display: none;">
        <button class="alert-close" onclick="closeProductAlert()"><i class="fas fa-times"></i></button>
        <div class="alert-title">
            <i class="fas fa-info-circle"></i> Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± ÙˆØ§Ù„Ù…Ù†ØªØ¬
        </div>
        <div class="alert-content">
            <div><strong>Ø§Ù„ØªØ§Ø¬Ø±:</strong> <span id="alertMerchantName">...</span></div>
            <div><strong>Ø§Ù„Ù…Ù†ØªØ¬:</strong> <span id="alertProductName">...</span></div>
        </div>
    </div>

    <div id="mapType">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:
        <select id="mapSelect" style="border:none;background:transparent;font-weight:600">
            <option value="street">Street</option>
            <option value="satellite">Satellite</option>
            <option value="terrain">Terrain</option>
        </select>
    </div>

    <div id="container">
        <div id="merchant-details">
            <div class="loading" id="loadingBox">
                <div class="spinner"></div>
                <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±...</div>
            </div>
            <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠÙ…Ù„Ø¤Ù‡ JavaScript -->
        </div>

        <div id="map"></div>
    </div>

    <footer>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ Ø§Ù„Ù…Ù…ÙŠØ² Ø³ÙˆÙØª Ù„Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</footer>

    <!-- Modals (Bootstrap) -->
    <!-- ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ -->
    <div class="modal fade" id="whatsappMsgModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="whatsappMsgInput" class="form-control" rows="5"></textarea>
                    <div class="form-text mt-2">Ø§Ø³ØªØ®Ø¯Ù… ${'{'}globalProductName{'}'} Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.</div>
                </div>
                <div class="modal-footer">
                    <button id="saveMsgBtn" class="btn btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div class="modal fade" id="productsModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-scrollable">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Ù‚Ø§Ø¦Ù…Ø© Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="productsList">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // ====== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ======
        function goBack(){ window.history.back(); }
        
        const selectedMerchantName = localStorage.getItem("selectedMerchant") || "Ø§Ù„ØªØ§Ø¬Ø±";
        document.getElementById('globalMerchantName').textContent = selectedMerchantName;
        
        const globalProductName = localStorage.getItem("globalProductName") || "Ø§Ù„Ù…Ù†ØªØ¬";
        let defaultWhatsAppMsg = localStorage.getItem('whatsappMsg') || `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù€ ${globalProductName} Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ AZ.`;

        // ====== ØªÙ‡ÙŠØ¦Ø© Firebase (Ø®Ø° Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£ØµÙ„ÙŠ) ======
        const firebaseConfig = {
            apiKey: "AIzaSyCZPqfq2Q6edvLkMogu1jR6RgLkLf-gQk0",
            authDomain: "chat-fat-free-default-rtdb.firebaseapp.com",
            databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com",
            projectId: "chat-fat-free-default-rtdb",
            storageBucket: "chat-fat-free-default-rtdb.appspot.com",
            messagingSenderId: "106886157687",
            appId: "1:106886157687:web:5d6c8e3e5c7d5d7a8d8b9c"
        };
        try{ firebase.initializeApp(firebaseConfig); } catch(e){ console.warn('firebase init:', e); }
        const db = firebase.database();

        // ====== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª ======
        const map = L.map('map').setView([24.7136,46.6753],10);
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: 'Â© OpenStreetMap' });
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{ attribution: 'Â© Esri' });
        const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{ attribution: 'Â© OpenTopoMap' });
        streetLayer.addTo(map);

        // ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        const mapSelect = document.getElementById('mapSelect');
        mapSelect.addEventListener('change', ()=>{
            const type = mapSelect.value;
            map.eachLayer(layer=>{ if(layer instanceof L.TileLayer) map.removeLayer(layer); });
            if(userMarker) userMarker.addTo(map);
            if(currentRoute && typeof currentRoute.addTo === 'function') currentRoute.addTo(map);
            if(type==='street') streetLayer.addTo(map);
            else if(type==='satellite') satelliteLayer.addTo(map);
            else if(type==='terrain') terrainLayer.addTo(map);
        });

        // ====== Ø¹Ù†Ø§ØµØ± Ùˆ Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ======
        const merchantDetailsDiv = document.getElementById('merchant-details');
        let currentRoute = null; let userMarker = null; let currentMerchantCoords = null; let userCoords = null; let currentMerchantData = null;

        // ====== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ======
        function hasValidPhoneNumber(merchant){
            const phone = merchant.phone?merchant.phone.replace(/\D/g,'') : '';
            const mobile = merchant.mobile?merchant.mobile.replace(/\D/g,'') : '';
            return phone.length>=6 || mobile.length>=6;
        }

        function updateDistanceField(distance){
            const distanceField = document.getElementById('distanceField');
            const distanceValue = document.getElementById('distanceValue');
            if(distanceField && distanceValue){ distanceValue.textContent = `${distance} ÙƒÙ…`; }
        }

        // Ø¥Ø´Ø¹Ø§Ø± Ø¹Ø±Ø¶ Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØµÙØ­Ø©
        function showPageAlert(sub){
            const a = document.getElementById('pageAlert');
            document.getElementById('alertSub').textContent = sub || '';
            a.style.display = 'block';
            setTimeout(()=>{ a.style.opacity = '1'; },50);
            setTimeout(()=>{ 
                a.style.transition='opacity 0.5s'; 
                a.style.opacity='0'; 
                setTimeout(()=>a.style.display='none',500); 
            },5000);
        }

        // Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„ØªØ§Ø¬Ø±
        function showProductMerchantAlert(){
            const alert = document.getElementById('productMerchantAlert');
            document.getElementById('alertMerchantName').textContent = selectedMerchantName;
            document.getElementById('alertProductName').textContent = globalProductName;
            
            alert.style.display = 'block';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 5 Ø«ÙˆØ§Ù†Ù
            setTimeout(() => {
                closeProductAlert();
            }, 5000);
        }

        function closeProductAlert(){
            const alert = document.getElementById('productMerchantAlert');
            alert.style.animation = 'slideInLeft 0.5s ease-out reverse';
            setTimeout(() => {
                alert.style.display = 'none';
                alert.style.animation = 'slideInLeft 0.5s ease-out';
            }, 500);
        }

        // ====== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø± (Ù…Ø­Ø³Ù†Ø©) ======
        function displayMerchantDetails(merchant){
            currentMerchantData = merchant;
            const showDistanceField = hasValidPhoneNumber(merchant);

            // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‡Ø§ØªÙ
            let phoneContent = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            if(merchant.phone){
                phoneContent = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span>${merchant.phone}</span>
                        <button class="action-btn call-btn" onclick="callNumber('${merchant.phone.replace(/'/g,'\'')}')">
                            <i class="fas fa-phone"></i> Ø§ØªØµØ§Ù„
                        </button>
                    </div>`;
            }

            // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬ÙˆØ§Ù„
            let mobileContent = 'ØºÙŠØ± Ù…ØªÙˆÙØ±';
            if(merchant.mobile){
                mobileContent = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span>${merchant.mobile}</span>
                        <div class="action-buttons">
                            <button class="action-btn call-btn" onclick="callNumber('${merchant.mobile.replace(/'/g,'\'')}')"><i class="fas fa-phone"></i></button>
                            <button class="action-btn whatsapp-btn" id="openWhatsAppBtn"><i class="fab fa-whatsapp"></i></button>
                            <button class="action-btn share-btn" id="shareLocationBtn"><i class="fas fa-share-alt"></i></button>
                        </div>
                    </div>`;
            } else {
                // Ø²Ø± Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø­ØªÙ‰ Ù„Ùˆ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø¬ÙˆØ§Ù„ (ÙŠØ±Ø³Ù„ Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù… Ø¥Ø°Ø§ Ù„Ø²Ù…)
                mobileContent = `<div style="display:flex;justify-content:space-between;align-items:center;"><span>ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
                    <div class="action-buttons">
                        <button class="action-btn share-btn" id="shareLocationBtnSmall"><i class="fas fa-share-alt"></i> Ù…Ø´Ø§Ø±ÙƒØ©</button>
                    </div>
                </div>`;
            }

            // ØªÙˆÙ„ÙŠØ¯ HTML
            merchantDetailsDiv.innerHTML = `
                <div class="merchant-header">
                    <div class="merchant-avatar"><i class="fas fa-store"></i></div>
                    <div class="merchant-info">
                        <div class="merchant-name">${merchant.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div class="merchant-category">${merchant.category || 'Ù„Ù… ÙŠØªÙ… ØªØ­Ø¯ÙŠØ¯ ÙØ¦Ø©'}</div>
                        ${showDistanceField?`<div class="merchant-distance" id="distanceField"><i class="fas fa-road"></i> <span id="distanceValue">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©...</span></div>`:''}
                    </div>
                </div>

                <div class="details-section">
                    <div class="section-title"><i class="fas fa-info-circle"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>

                    ${merchant.phone?`<div class="detail-item"><div class="detail-icon"><i class="fas fa-phone"></i></div><div class="detail-content"><div class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</div><div class="detail-value">${phoneContent}</div></div></div>`:''}

                    <div class="detail-item"><div class="detail-icon"><i class="fas fa-mobile-alt"></i></div><div class="detail-content"><div class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ / ÙˆØ§ØªØ³Ø§Ø¨</div><div class="detail-value">${mobileContent}</div></div></div>

                    <div class="detail-item"><div class="detail-icon"><i class="fas fa-map-marker-alt"></i></div><div class="detail-content"><div class="detail-label">Ø§Ù„Ù…ÙˆÙ‚Ø¹</div><div class="detail-value">${merchant.address || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</div></div></div>

                    <div class="action-buttons" style="margin-top:8px">
                        <button class="action-btn secondary-btn" id="showProductsBtn"><i class="fas fa-box-open"></i> Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±</button>
                        <button class="action-btn secondary-btn" id="editWhatsAppMsgBtn"><i class="fas fa-edit"></i> ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨</button>
                    </div>
                </div>

                <div class="details-section">
                    <div class="section-title"><i class="fas fa-link"></i> Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
                        ${merchant.googleSite?`<a class="social-link" href="${merchant.googleSite}" target="_blank" title="Ù…ÙˆÙ‚Ø¹ Ø¬ÙˆØ¬Ù„"><i class="fas fa-globe"></i></a>`:''}
                        ${merchant.youtubeSite?`<a class="social-link" href="${merchant.youtubeSite}" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>`:''}
                        ${merchant.telegramSite?`<a class="social-link" href="${merchant.telegramSite}" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>`:''}
                        ${merchant.twitterSite?`<a class="social-link" href="${merchant.twitterSite}" target="_blank" title="Twitter"><i class="fab fa-twitter"></i></a>`:''}
                    </div>
                </div>

                <div class="details-section">
                    <div class="section-title"><i class="fas fa-route"></i> Ø§ØªØ¬Ø§Ù‡Ø§Øª Ø§Ù„ÙˆØµÙˆÙ„</div>
                    <div class="route-info" id="routeInfo">Ø§Ù†Ù‚Ø± Ø¹Ù„Ù‰ "Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±" Ù„Ø¹Ø±Ø¶ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³Ø§ÙØ© ÙˆØ§Ù„ÙˆÙ‚Øª</div>
                    <button class="back-button" id="calcRouteBtn" style="background:var(--accent-color); width:100%; justify-content:center; margin-top:10px;"><i class="fas fa-route"></i> Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±</button>
                </div>
            `;

            // Ø¨Ø¹Ø¯ Ø¥Ø¯Ø±Ø§Ø¬ HTMLØŒ Ø£Ø¶Ù Ù…Ø³ØªÙ…Ø¹Ø§Øª Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
            const openWhatsBtn = document.getElementById('openWhatsAppBtn');
            if(openWhatsBtn){ openWhatsBtn.addEventListener('click', ()=>{ openWhatsApp(merchant.mobile||merchant.phone); }); }

            const shareBtn = document.getElementById('shareLocationBtn');
            const shareBtnSmall = document.getElementById('shareLocationBtnSmall');
            const finalShareBtn = shareBtn || shareBtnSmall;
            if(finalShareBtn){ finalShareBtn.addEventListener('click', ()=>{ shareMerchantDetailsViaWhatsApp(merchant); }); }

            document.getElementById('showProductsBtn').addEventListener('click', ()=>{ showProductsModal(merchant); });
            document.getElementById('editWhatsAppMsgBtn').addEventListener('click', ()=>{ openEditWhatsAppModal(); });
            document.getElementById('calcRouteBtn').addEventListener('click', ()=>{ calculateRoute(); });

            // Ø§Ø®ØªÙØ§Ø¡ Ù„ÙˆØ¯Ø±
            const loader = document.getElementById('loadingBox'); if(loader) loader.style.display = 'none';

            // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± ØµØºÙŠØ±
            showPageAlert(`Ø§Ù„ØªØ§Ø¬Ø±: ${merchant.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`);
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬ ÙˆØ§Ù„ØªØ§Ø¬Ø±
            showProductMerchantAlert();
        }

        // ====== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ùˆ ÙˆØ§ØªØ³Ø§Ø¨ ======
        function callNumber(phoneNumber){ window.open(`tel:${phoneNumber}`,'_self'); }

        function openWhatsApp(phoneNumber){
            if(!phoneNumber){ alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù„Ù„ØªÙˆØ§ØµÙ„.'); return; }
            let clean = phoneNumber.replace(/\D/g,'');
            if(clean.startsWith('0') && clean.length===10) clean = '967' + clean.substring(1);
            if(!clean.startsWith('967') && clean.length===9) clean = '967' + clean;
            const msg = defaultWhatsAppMsg.replace('${globalProductName}', globalProductName);
            const url = `https://wa.me/${clean}?text=${encodeURIComponent(msg)}`;
            window.open(url,'_blank');
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ + ØªÙØ§ØµÙŠÙ„ + Ù…Ù†ØªØ¬Ø§Øª Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
        function shareMerchantDetailsViaWhatsApp(merchant){
            // Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹
            const mapLink = merchant.location? `https://www.google.com/maps?q=${merchant.location}` : 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±';

            // Ø±Ù‚Ù…
            let phone = (merchant.mobile || merchant.phone || '').replace(/\D/g,'');
            if(phone.startsWith('0') && phone.length===10) phone = '967' + phone.substring(1);
            if(phone && !phone.startsWith('967') && phone.length===9) phone = '967' + phone;

            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            let productsText = '';
            if(merchant.products){
                productsText = '\n\nğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:\n';
                Object.values(merchant.products).forEach(p=>{ productsText += `- ${p.name || p.title || ''} ${p.price?(' - '+p.price):''}\n`; });
            }

            const msg = `ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±:\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${merchant.name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}\nğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${merchant.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}\nğŸ“± Ø§Ù„Ø¬ÙˆØ§Ù„: ${merchant.mobile || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}\nğŸŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${mapLink}${productsText}\nğŸ”— Ø¹Ø¨Ø± ØªØ·Ø¨ÙŠÙ‚ AZ`;

            const encoded = encodeURIComponent(msg);

            if(phone){
                window.open(`https://wa.me/${phone}?text=${encoded}`,'_blank');
            } else {
                // Ø§ÙØªØ­ ÙˆØ§Ø¬Ù‡Ø© Ù…Ø´Ø§Ø±ÙƒØ© ÙˆØ§ØªØ³Ø§Ø¨ Ø¨Ø¯ÙˆÙ† Ø±Ù‚Ù…
                window.open(`https://wa.me/?text=${encoded}`,'_blank');
            }
        }

        // Ù†Ø³Ø®Ø© Ø§Ø­ØªÙŠØ§Ø·ÙŠØ©: Ù†Ø³Ø® Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ù„Ù„Ø­Ø§ÙØ¸Ø©
        async function copyMerchantMessageToClipboard(merchant){
            const mapLink = merchant.location? `https://www.google.com/maps?q=${merchant.location}` : 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±';
            let productsText = '';
            if(merchant.products){ productsText = '\n\nØ§Ù„Ù…Ù†ØªØ¬Ø§Øª:\n'; Object.values(merchant.products).forEach(p=>{ productsText += `- ${p.name || ''} ${p.price?(' - '+p.price):''}\n`; }); }
            const msg = `Ø§Ù„ØªØ§Ø¬Ø±: ${merchant.name || ''}\nØ§Ù„Ù‡Ø§ØªÙ: ${merchant.phone || ''}\nØ§Ù„Ø¬ÙˆØ§Ù„: ${merchant.mobile || ''}\nØ§Ù„Ù…ÙˆÙ‚Ø¹: ${mapLink}${productsText}`;
            try{ await navigator.clipboard.writeText(msg); alert('ØªÙ… Ù†Ø³Ø® Ø±Ø³Ø§Ù„Ø© Ø§Ù„ØªØ§Ø¬Ø± Ù„Ù„Ø­Ø§ÙØ¸Ø©'); }
            catch(e){ alert('Ù†Ø³Ø® ØºÙŠØ± Ù…Ù…ÙƒÙ†'); }
        }

        // ====== Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Leaflet Routing Ø£Ùˆ ØªØ¹ÙˆÙŠØ¶ Ø¨Ø®Ø· Ø¨Ø³ÙŠØ· ======
        function calculateRoute(){
            if(userMarker && currentMerchantCoords){
                if(currentRoute){ try{ map.removeControl(currentRoute); }catch(e){} }
                currentRoute = L.Routing.control({
                    waypoints: [ userMarker.getLatLng(), L.latLng(currentMerchantCoords[0], currentMerchantCoords[1]) ],
                    lineOptions: { styles: [{ color: 'blue', weight: 5 }] },
                    router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                    addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true, show: false
                }).on('routesfound', function(e){
                    const route = e.routes && e.routes[0];
                    if(route){
                        const distance = (route.summary.totalDistance/1000).toFixed(2);
                        const duration = Math.ceil(route.summary.totalTime/60);
                        document.getElementById('routeInfo').innerHTML = `<strong>Ø§Ù„Ù…Ø³Ø§ÙØ©:</strong> ${distance} ÙƒÙ…<br><strong>Ø§Ù„ÙˆÙ‚Øª:</strong> ${duration} Ø¯Ù‚ÙŠÙ‚Ø©`;
                    }
                }).addTo(map);
            } else {
                alert('ØªØ¹Ø°Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù…ÙˆÙ‚Ø¹Ùƒ Ø£Ùˆ ÙˆØ¬ÙˆØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ§Ø¬Ø±.');
            }
        }

        // ====== Ø¥Ø¸Ù‡Ø§Ø± Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª (Modal) ======
        function showProductsModal(merchant){
            const box = document.getElementById('productsList'); box.innerHTML = '';
            if(merchant.products){
                Object.values(merchant.products).forEach(p=>{
                    const el = document.createElement('div'); el.className='p-2 mb-2 border rounded';
                    el.innerHTML = `<strong>${p.name||p.title||'Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…'}</strong> ${p.price?('<span style="float:left">'+p.price+'</span>'):''}<div style=\"clear:both\"></div>`;
                    box.appendChild(el);
                });
            } else { box.innerHTML = '<div class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª</div>'; }
            new bootstrap.Modal(document.getElementById('productsModal')).show();
        }

        // ====== ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ ÙˆØ­ÙØ¸Ù‡Ø§ ======
        function openEditWhatsAppModal(){
            document.getElementById('whatsappMsgInput').value = localStorage.getItem('whatsappMsg') || defaultWhatsAppMsg;
            new bootstrap.Modal(document.getElementById('whatsappMsgModal')).show();
        }

        document.getElementById('saveMsgBtn').addEventListener('click', ()=>{
            const v = document.getElementById('whatsappMsgInput').value;
            localStorage.setItem('whatsappMsg', v);
            defaultWhatsAppMsg = v;
            bootstrap.Modal.getInstance(document.getElementById('whatsappMsgModal')).hide();
            alert('ØªÙ… Ø­ÙØ¸ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©');
        });

        // ====== Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ======
        function getUserLocationAndPlaceMarker(merchant){
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(pos=>{
                    userCoords = [pos.coords.latitude, pos.coords.longitude];
                    userMarker = L.marker(userCoords,{title:'Ù…ÙˆÙ‚Ø¹Ùƒ'}).addTo(map).bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ').openPopup();

                    if(merchant && merchant.location){
                        const dist = calculateDistance(userCoords[0],userCoords[1], currentMerchantCoords[0], currentMerchantCoords[1]);
                        const routeInfo = document.getElementById('routeInfo');
                        if(routeInfo) routeInfo.innerHTML += `<br><strong>Ø§Ù„Ù…Ø³Ø§ÙØ© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±Ø©:</strong> ${dist} ÙƒÙ…`;
                        if(hasValidPhoneNumber(merchant)) updateDistanceField(dist);

                        // Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø·Ø§Ø± Ù„Ø¹Ø±Ø¶ ÙƒÙ„Ø§ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†
                        try{ const bounds = L.latLngBounds([userCoords, currentMerchantCoords]); map.fitBounds(bounds, { padding:[50,50] }); }catch(e){}
                    }
                }, err=>{
                    console.warn('gps err', err);
                    if(hasValidPhoneNumber(merchant)) updateDistanceField('ØºÙŠØ± Ù…ØªÙˆÙØ±');
                }, { timeout:10000 });
            } else {
                if(hasValidPhoneNumber(merchant)) updateDistanceField('ØºÙŠØ± Ù…ØªÙˆÙØ±');
            }
        }

        // ====== Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Haversine) ======
        function calculateDistance(lat1, lon1, lat2, lon2){
            const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(2);
        }

        // ====== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ù…Ù† Firebase ======
        function loadMerchantData(){
            const merchantsRef = db.ref('merchants');
            merchantsRef.once('value').then(snapshot=>{
                const merchants = snapshot.val(); let merchantFound=false;
                if(merchants){
                    for(let key in merchants){
                        const merchant = merchants[key];
                        if(merchant.name === selectedMerchantName){
                            merchantFound=true; displayMerchantDetails(merchant);

                            if(merchant.location){
                                const coords = merchant.location.split(',').map(Number);
                                if(coords.length===2 && !coords.some(isNaN)){
                                    currentMerchantCoords = coords;
                                    L.marker(coords).addTo(map).bindPopup(`<strong>${merchant.name}</strong><br>${merchant.category||''}`).openPopup();
                                    map.setView(coords, 15);

                                    // Ø¶Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                                    getUserLocationAndPlaceMarker(merchant);
                                }
                            }
                            break;
                        }
                    }
                }
                if(!merchantFound){
                    merchantDetailsDiv.innerHTML = `<div style="text-align:center;padding:40px 20px;color:var(--light-text)"><i class="fas fa-store-slash fa-2x"></i><h3>Ø§Ù„ØªØ§Ø¬Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h3><p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ§Ø¬Ø± "${selectedMerchantName}"</p></div>`;
                    const loader = document.getElementById('loadingBox'); if(loader) loader.style.display = 'none';
                }
            }).catch(err=>{
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err);
                merchantDetailsDiv.innerHTML = `<div style="text-align:center;padding:40px 20px;color:#dc3545"><i class="fas fa-exclamation-triangle fa-2x"></i><h3>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3><p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p></div>`;
            });
        }

        // Ø¨Ø¯Ø¡
        window.addEventListener('DOMContentLoaded', ()=>{ loadMerchantData(); });
    </script>
</body>
    </html>
