<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø®Ø±ÙŠØ·Ø© Ø§Ù„ØªØ¬Ø§Ø± - ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±</title>
    <!-- Leaflet & Routing CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.css" />
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Bootstrap (Ù„Ù„Ù€ modals Ùˆ Ø§Ù„Ø£Ø²Ø±Ø§Ø±) -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.rtl.min.css" rel="stylesheet">

    <style>
        :root {
            --primary-color: #007bff;
            --secondary-color: #f8f9fa;
            --accent-color: #28a745;
            --text-color: #333;
            --light-text: #6c757d;
            --border-color: #dee2e6;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; margin: 0; font-family: 'Tahoma', 'Arial', sans-serif; background: #f5f5f5; color: var(--text-color); }
        body { display: flex; flex-direction: column; }

        header {
            background: var(--primary-color);
            color: #fff;
            padding: 12px 18px;
            position: sticky; top: 0;
            z-index: 1100;
            display: flex; align-items: center; justify-content: space-between; gap: 10px;
        }

        .header-content{ display:flex; align-items:center; gap:10px }
        .back-button{ background: rgba(255,255,255,0.15); border:none; color:#fff; padding:8px 12px; border-radius:6px; cursor:pointer }
        .back-button i{ transform: rotate(180deg); }
        #globalMerchantName{ font-weight:700 }

        #mapType{ position:absolute; top:72px; left:12px; z-index:1000; background:#fff; padding:8px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.12); }

        #container{ display:flex; flex:1; height: calc(100vh - 120px); gap:12px; padding:12px; }

        #merchant-details{ width:400px; max-width:40%; background:#fff; padding:16px; border-radius:10px; overflow:auto; box-shadow:0 6px 18px rgba(0,0,0,0.06); }

        #map{ flex:1; border-radius:10px; box-shadow:0 6px 18px rgba(0,0,0,0.06); position: relative; }

        .merchant-header{ display:flex; align-items:center; gap:12px; margin-bottom:14px; }
        .merchant-avatar{ width:76px; height:76px; border-radius:50%; background:var(--primary-color); display:flex; align-items:center; justify-content:center; color:#fff; font-size:34px }
        .merchant-name{ font-size:20px; font-weight:700; color:var(--primary-color) }
        .merchant-category{ color:var(--light-text); font-size:13px }

        .section-title{ font-weight:700; color:var(--primary-color); margin-bottom:8px; display:flex; align-items:center; gap:8px }
        .detail-item{ display:flex; gap:10px; margin-bottom:12px; align-items:flex-start }
        .detail-icon{ width:36px; height:36px; border-radius:8px; background:#f1f3f5; display:flex; align-items:center; justify-content:center; color:var(--primary-color) }
        .detail-content{ flex:1 }
        .detail-label{ font-size:12px; color:var(--light-text); margin-bottom:4px }
        .detail-value{ font-size:15px; word-break:break-word }

        .action-buttons{ display:flex; gap:8px; margin-top:8px; flex-wrap: wrap; }
        .action-btn{ padding:8px 10px; border-radius:8px; border:none; cursor:pointer; display:inline-flex; gap:8px; align-items:center; flex: 1; min-width: 140px; justify-content: center; }
        .call-btn{ background:var(--accent-color); color:#fff }
        .whatsapp-btn{ background:#25D366; color:#fff }
        .share-btn{ background:var(--primary-color); color:#fff }
        .secondary-btn{ background:#f8f9fa; color:var(--text-color); border:1px solid var(--border-color) }

        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ù…ØµØºØ±Ø© */
        .mini-action-buttons { display: flex; gap: 6px; margin-top: 8px; }
        .mini-action-btn { width: 40px; height: 40px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; }
        .mini-call-btn { background: var(--accent-color); color: #fff; }
        .mini-whatsapp-btn { background: #25D366; color: #fff; }
        .mini-share-btn { background: var(--primary-color); color: #fff; }

        .route-info{ background:#fff; padding:10px; border-radius:8px; box-shadow:0 1px 6px rgba(0,0,0,0.06); margin-top:10px }

        .loading{ display:flex; justify-content:center; align-items:center; height:150px; flex-direction:column; gap:12px }
        .spinner{ width:40px; height:40px; border:4px solid rgba(0,123,255,0.18); border-top-color:var(--primary-color); border-radius:50%; animation:spin 1s linear infinite }
        @keyframes spin{ to{ transform:rotate(360deg) } }

        footer{ text-align:center; padding:12px; background:var(--secondary-color); font-size:13px; color:var(--light-text); margin-top:auto }

        /* Ø²Ø± Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
        #fixedRouteBtn {
            position: absolute;
            top: 10px;
            right: 10px;
            z-index: 1000;
            background: var(--accent-color);
            color: #fff;
            border: none;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }

        /* Ø¥Ø´Ø¹Ø§Ø± ØªÙØ¹ÙŠÙ„ GPS */
        #gpsAlert {
            position: fixed;
            top: 70px;
            right: 12px;
            z-index: 1200;
            background: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            border-right: 4px solid #ffc107;
            max-width: 300px;
            animation: slideInRight 0.5s ease-out;
        }

        #gpsAlert .alert-title {
            font-weight: 700;
            color: #856404;
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #gpsAlert .alert-content {
            font-size: 14px;
            color: var(--text-color);
            line-height: 1.4;
        }

        #gpsAlert .alert-close {
            position: absolute;
            top: 8px;
            left: 8px;
            background: none;
            border: none;
            color: var(--light-text);
            cursor: pointer;
            font-size: 14px;
        }

        /* Ø¥Ø´Ø¹Ø§Ø± ØªØ¹Ù„ÙŠÙ…ÙŠ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ */
        #locationHelpAlert {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 1200;
            background: #fff;
            padding: 12px 16px;
            border-radius: 8px;
            box-shadow: 0 6px 18px rgba(0,0,0,0.08);
            border-right: 4px solid var(--primary-color);
            max-width: 300px;
            animation: slideInRight 0.5s ease-out;
        }

        #locationHelpAlert .alert-title {
            font-weight: 700;
            color: var(--primary-color);
            margin-bottom: 6px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        #locationHelpAlert .alert-content {
            font-size: 14px;
            color: var(--text-color);
            line-height: 1.4;
        }

        #locationHelpAlert .alert-close {
            position: absolute;
            top: 8px;
            left: 8px;
            background: none;
            border: none;
            color: var(--light-text);
            cursor: pointer;
            font-size: 14px;
        }

        @keyframes slideInRight {
            from { transform: translateX(100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes slideInDown {
            from { transform: translateX(-50%) translateY(-20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }

        /* Responsive */
        @media(max-width:900px){ 
            #container{ flex-direction:column } 
            #merchant-details{ width:100%; max-width:100%; height:40vh } 
            #map{ height:56vh } 
            #mapType{ top:58px } 
            #gpsAlert, #locationHelpAlert {
                max-width: 90%;
                left: 5%;
                right: 5%;
                transform: none;
            }
            #fixedRouteBtn {
                top: 5px;
                right: 5px;
                padding: 8px 12px;
                font-size: 14px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="header-content">
            <button class="back-button" onclick="goBack()"><i class="fas fa-arrow-right"></i> Ø±Ø¬ÙˆØ¹</button>
            <div>ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±</div>
        </div>
        <div id="globalMerchantName">...</div>
    </header>

    <!-- Ø¥Ø´Ø¹Ø§Ø± ØªÙØ¹ÙŠÙ„ GPS -->
    <div id="gpsAlert" style="display: none;">
        <button class="alert-close" onclick="closeGpsAlert()"><i class="fas fa-times"></i></button>
        <div class="alert-title">
            <i class="fas fa-map-marker-alt"></i> ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
        </div>
        <div class="alert-content">
            <p>Ù„Ù… ÙŠØªÙ… ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø© Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø¹Ù„Ù‰ Ø¬Ù‡Ø§Ø²Ùƒ.</p>
            <p><strong>Ù„ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹:</strong></p>
            <ol style="padding-right: 15px; margin-top: 8px;">
                <li>Ø§ÙØªØ­ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¬Ù‡Ø§Ø²Ùƒ</li>
                <li>Ø§Ø°Ù‡Ø¨ Ø¥Ù„Ù‰ Ù‚Ø³Ù… "Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ§Ù„Ù…ÙˆÙ‚Ø¹"</li>
                <li>Ù‚Ù… Ø¨ØªÙØ¹ÙŠÙ„ Ø®Ø¯Ù…Ø§Øª Ø§Ù„Ù…ÙˆÙ‚Ø¹</li>
                <li>Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ</li>
            </ol>
        </div>
    </div>

    <!-- Ø¥Ø´Ø¹Ø§Ø± ØªØ¹Ù„ÙŠÙ…ÙŠ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ -->
    <div id="locationHelpAlert" style="display: none;">
        <button class="alert-close" onclick="closeLocationHelpAlert()"><i class="fas fa-times"></i></button>
        <div class="alert-title">
            <i class="fas fa-info-circle"></i> ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
        </div>
        <div class="alert-content">
            <p>Ù„ØªØ­Ø¯ÙŠØ¯ Ù…ÙˆÙ‚Ø¹Ùƒ Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±:</p>
            <ol style="padding-right: 15px; margin-top: 8px;">
                <li>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø²Ø± "Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±" Ø£Ø¹Ù„Ù‰ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</li>
                <li>Ø§Ø³Ù…Ø­ Ù„Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù…ÙˆÙ‚Ø¹Ùƒ</li>
                <li>Ø§Ù†ØªØ¸Ø± Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± ÙˆØ§Ù„Ù…Ø³Ø§ÙØ©</li>
            </ol>
        </div>
    </div>

    <div id="mapType">Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©:
        <select id="mapSelect" style="border:none;background:transparent;font-weight:600">
            <option value="street">Street</option>
            <option value="satellite">Satellite</option>
            <option value="terrain">Terrain</option>
        </select>
    </div>

    <div id="container">
        <div id="merchant-details">
            <div class="loading" id="loadingBox">
                <div class="spinner"></div>
                <div>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±...</div>
            </div>
            <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø³ÙŠÙ…Ù„Ø¤Ù‡ JavaScript -->
        </div>

        <div id="map">
            <!-- Ø²Ø± Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ø«Ø§Ø¨Øª -->
            <button id="fixedRouteBtn" style="display: none;">
                <i class="fas fa-route"></i> Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±
            </button>
        </div>
    </div>

    <footer>Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ Ø§Ù„Ù…Ù…ÙŠØ² Ø³ÙˆÙØª Ù„Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©</footer>

    <!-- Modals (Bootstrap) -->
    <!-- ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨ -->
    <div class="modal fade" id="whatsappMsgModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">ØªØ¹Ø¯ÙŠÙ„ Ø±Ø³Ø§Ù„Ø© ÙˆØ§ØªØ³Ø§Ø¨</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <textarea id="whatsappMsgInput" class="form-control" rows="5"></textarea>
                    <div class="form-text mt-2">Ø§Ø³ØªØ®Ø¯Ù… ${'{'}globalProductName{'}'} Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø§Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø©.</div>
                </div>
                <div class="modal-footer">
                    <button id="saveMsgBtn" class="btn btn-primary">Ø­ÙØ¸</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-routing-machine/dist/leaflet-routing-machine.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    
    <script>
        // ====== Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© ======
        function goBack(){ window.history.back(); }
        
        // ====== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„ Ù„ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± ======
        const merchantGlobal = {
            // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„
            setMerchantName: function(name) {
                sessionStorage.setItem('merchantName', name);
                localStorage.setItem('merchantName', name);
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„:', name);
            },
            
            getMerchantName: function() {
                return sessionStorage.getItem('merchantName') || localStorage.getItem('merchantName') || '';
            },
            
            // Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„
            setMerchantId: function(merchantId) {
                sessionStorage.setItem('merchantId', merchantId);
                localStorage.setItem('merchantId', merchantId);
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„:', merchantId);
            },
            
            getMerchantId: function() {
                return sessionStorage.getItem('merchantId') || localStorage.getItem('merchantId') || '';
            },
            
            // Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„/Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„
            setMerchantPhone: function(phone) {
                sessionStorage.setItem('merchantPhone', phone);
                localStorage.setItem('merchantPhone', phone);
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„:', phone);
            },
            
            getMerchantPhone: function() {
                return sessionStorage.getItem('merchantPhone') || localStorage.getItem('merchantPhone') || '';
            },
            
            // Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ù…Ù† Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„
            clearAll: function() {
                sessionStorage.removeItem('merchantName');
                sessionStorage.removeItem('merchantId');
                sessionStorage.removeItem('merchantPhone');
                localStorage.removeItem('merchantName');
                localStorage.removeItem('merchantId');
                localStorage.removeItem('merchantPhone');
                console.log('ğŸ§¹ ØªÙ… Ø¥ÙØ±Ø§Øº Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ù…Ù† Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„');
            },
            
            // Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ø¯ÙØ¹Ø© ÙˆØ§Ø­Ø¯Ø©
            setMerchantData: function(merchantData) {
                this.setMerchantName(merchantData.name || '');
                this.setMerchantId(merchantData.userId || '');
                this.setMerchantPhone(merchantData.mobile || merchantData.phone || '');
                console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„:', merchantData);
            }
        };

        // ====== ØªØµØ­ÙŠØ­ Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage ======
        // Ù‚Ø±Ø§Ø¡Ø© Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ù…Ù† localStorage
        function getLocalStorageData() {
            console.log('=== ÙØ­Øµ localStorage ===');
            
            // Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…Ø­ØªÙ…Ù„Ø© Ø§Ù„ØªÙŠ Ù‚Ø¯ ØªØ³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚
            const possibleKeys = [
                'selectedMerchantName', 'selectedMerchant', 'merchantName',
                'selectedMerchantId', 'merchantId', 'userId',
                'selectedProductName', 'globalProductName', 'productName'
            ];
            
            let merchantName = '';
            let merchantId = '';
            let productName = '';
            
            // ÙØ­Øµ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…ÙØ§ØªÙŠØ­ ÙÙŠ localStorage
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                const value = localStorage.getItem(key);
                console.log(`localStorage[${key}] = ${value}`);
                
                // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØ§ØªÙŠØ­
                if (key.includes('MerchantName') || key.includes('merchantName')) {
                    merchantName = value;
                }
                if (key.includes('MerchantId') || key.includes('merchantId') || key.includes('userId')) {
                    merchantId = value;
                }
                if (key.includes('ProductName') || key.includes('productName')) {
                    productName = value;
                }
            }
            
            // Ø¥Ø°Ø§ Ù„Ù… Ù†Ø¬Ø¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø§Ù„Ù…ÙØ§ØªÙŠØ­ Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø©ØŒ Ù†Ø¨Ø­Ø« ÙÙŠ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù‚ÙŠÙ…
            if (!merchantName || !merchantId || !productName) {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    
                    // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ù‚ÙŠÙ…
                    if (value && value.length > 0) {
                        if (!merchantName && (value.includes('ØªØ§Ø¬Ø±') || value.length < 50)) {
                            merchantName = value;
                        }
                        if (!productName && value.length > 5 && value.length < 100) {
                            productName = value;
                        }
                    }
                }
            }
            
            return {
                merchantName: merchantName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯',
                merchantId: merchantId || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                productName: productName || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'
            };
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† localStorage
        const localStorageData = getLocalStorageData();
        const selectedMerchantName = localStorageData.merchantName;
        const selectedMerchantId = localStorageData.merchantId;
        const globalProductName = localStorageData.productName;
        
        console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø±Ø¬Ø©:', {
            selectedMerchantName,
            selectedMerchantId, 
            globalProductName
        });
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø§Ø³Ù… ÙÙŠ Ø§Ù„Ù‡ÙŠØ¯Ø±
        document.getElementById('globalMerchantName').textContent = selectedMerchantName;
        
        let defaultWhatsAppMsg = localStorage.getItem('whatsappMsg') || `Ù…Ø±Ø­Ø¨Ø§Ù‹ØŒ Ø£Ù†Ø§ Ù…Ù‡ØªÙ… Ø¨Ù€ ${globalProductName} Ù…Ù† ØªØ·Ø¨ÙŠÙ‚ AZ.`;

        // ====== ØªÙ‡ÙŠØ¦Ø© Firebase ======
        const firebaseConfig = {
            apiKey: "AIzaSyCZPqfq2Q6edvLkMogu1jR6RgLkLf-gQk0",
            authDomain: "chat-fat-free-default-rtdb.firebaseapp.com",
            databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com",
            projectId: "chat-fat-free-default-rtdb",
            storageBucket: "chat-fat-free-default-rtdb.appspot.com",
            messagingSenderId: "106886157687",
            appId: "1:106886157687:web:5d6c8e3e5c7d5d7a8d8b9c"
        };
        try{ firebase.initializeApp(firebaseConfig); } catch(e){ console.warn('firebase init:', e); }
        const db = firebase.database();

        // ====== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ø®Ø±ÙŠØ·Ø© ÙˆØ§Ù„Ø·Ø¨Ù‚Ø§Øª ======
        const map = L.map('map').setView([24.7136,46.6753],10);
        const streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{ attribution: 'Â© OpenStreetMap' });
        const satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{ attribution: 'Â© Esri' });
        const terrainLayer = L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{ attribution: 'Â© OpenTopoMap' });
        streetLayer.addTo(map);

        // ØªØºÙŠÙŠØ± Ù†ÙˆØ¹ Ø§Ù„Ø®Ø±ÙŠØ·Ø©
        const mapSelect = document.getElementById('mapSelect');
        mapSelect.addEventListener('change', ()=>{
            const type = mapSelect.value;
            map.eachLayer(layer=>{ if(layer instanceof L.TileLayer) map.removeLayer(layer); });
            if(userMarker) userMarker.addTo(map);
            if(currentRoute && typeof currentRoute.addTo === 'function') currentRoute.addTo(map);
            if(type==='street') streetLayer.addTo(map);
            else if(type==='satellite') satelliteLayer.addTo(map);
            else if(type==='terrain') terrainLayer.addTo(map);
        });

        // ====== Ø¹Ù†Ø§ØµØ± Ùˆ Ù…ØªØºÙŠØ±Ø§Øª Ø¹Ø§Ù…Ø© ======
        const merchantDetailsDiv = document.getElementById('merchant-details');
        const fixedRouteBtn = document.getElementById('fixedRouteBtn');
        let currentRoute = null; let userMarker = null; let currentMerchantCoords = null; let userCoords = null; let currentMerchantData = null;
        
        // ====== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© ======
        function hasValidPhoneNumber(merchant){
            const phone = merchant.phone?merchant.phone.replace(/\D/g,'') : '';
            const mobile = merchant.mobile?merchant.mobile.replace(/\D/g,'') : '';
            return phone.length>=6 || mobile.length>=6;
        }

        function updateDistanceField(distance){
            const distanceField = document.getElementById('distanceField');
            const distanceValue = document.getElementById('distanceValue');
            if(distanceField && distanceValue){ distanceValue.textContent = `${distance} ÙƒÙ…`; }
        }

        // Ø¥Ø´Ø¹Ø§Ø± ØªÙØ¹ÙŠÙ„ GPS
        function showGpsAlert(){
            const alert = document.getElementById('gpsAlert');
            alert.style.display = 'block';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 8 Ø«ÙˆØ§Ù†Ù
            setTimeout(() => {
                closeGpsAlert();
            }, 8000);
        }

        function closeGpsAlert(){
            const alert = document.getElementById('gpsAlert');
            alert.style.animation = 'slideInRight 0.5s ease-out reverse';
            setTimeout(() => {
                alert.style.display = 'none';
                alert.style.animation = 'slideInRight 0.5s ease-out';
            }, 500);
        }

        // Ø¥Ø´Ø¹Ø§Ø± ØªØ¹Ù„ÙŠÙ…ÙŠ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ
        function showLocationHelpAlert(){
            const alert = document.getElementById('locationHelpAlert');
            alert.style.display = 'block';
            
            // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ 10 Ø«ÙˆØ§Ù†Ù
            setTimeout(() => {
                closeLocationHelpAlert();
            }, 10000);
        }

        function closeLocationHelpAlert(){
            const alert = document.getElementById('locationHelpAlert');
            alert.style.animation = 'slideInRight 0.5s ease-out reverse';
            setTimeout(() => {
                alert.style.display = 'none';
                alert.style.animation = 'slideInRight 0.5s ease-out';
            }, 500);
        }

        // ====== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ======
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                left: 50%;
                transform: translateX(-50%);
                background: ${type === 'success' ? '#28a745' : type === 'info' ? '#17a2b8' : '#dc3545'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                box-shadow: 0 6px 18px rgba(0,0,0,0.15);
                z-index: 3000;
                animation: slideInDown 0.5s ease-out;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }

        // ====== Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… ======
        function shouldShowPhoneNumber(merchant) {
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ù‚Ù„ showNumber ÙÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© 1 Ø£Ùˆ true Ø£Ùˆ "1" ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù…
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù‚ÙŠÙ…Ø© 0 Ø£Ùˆ false Ø£Ùˆ "0" Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ Ù„Ø§ ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù…
            const showNumber = merchant.showNumber;
            
            console.log('Ø­Ù‚Ù„ showNumber Ù„Ù„ØªØ§Ø¬Ø±:', showNumber, 'Ù†ÙˆØ¹:', typeof showNumber);
            
            if (showNumber === undefined || showNumber === null) {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ø§Ù„Ø­Ù‚Ù„ Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ù„Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„ØªÙˆØ§ÙÙ‚
                console.log('Ø­Ù‚Ù„ showNumber ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹');
                return true;
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù‚ÙŠÙ… Ø§Ù„Ù…Ø®ØªÙ„ÙØ©
            if (showNumber === 1 || showNumber === '1' || showNumber === true) {
                console.log('Ø­Ù‚Ù„ showNumber Ù…ÙØ¹Ù„ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù…');
                return true;
            }
            
            if (showNumber === 0 || showNumber === '0' || showNumber === false) {
                console.log('Ø­Ù‚Ù„ showNumber ØºÙŠØ± Ù…ÙØ¹Ù„ØŒ Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø±Ù‚Ù…');
                return false;
            }
            
            // ÙÙŠ Ø­Ø§Ù„Ø© ÙˆØ¬ÙˆØ¯ Ù‚ÙŠÙ…Ø© ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©ØŒ Ù†Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹
            console.log('Ù‚ÙŠÙ…Ø© showNumber ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹Ø©ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹');
            return true;
        }

        // ====== Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø± ======
        function displayMerchantDetails(merchant){
            currentMerchantData = merchant;
            const showDistanceField = hasValidPhoneNumber(merchant);
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù…
            const shouldShowPhone = shouldShowPhoneNumber(merchant);

            // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù‡Ø§ØªÙ - Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø­Ù‚Ù„ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù†Øµ "ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ" Ø£Ùˆ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ù…Ø¹Ø·Ù„Ø§Ù‹
            let phoneContent = '';
            if(merchant.phone && merchant.phone !== 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' && shouldShowPhone){
                phoneContent = `
                    <div class="detail-item">
                        <div class="detail-icon"><i class="fas fa-phone"></i></div>
                        <div class="detail-content">
                            <div class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</div>
                            <div class="detail-value">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span>${merchant.phone}</span>
                                    <button class="mini-action-btn mini-call-btn" onclick="callNumber('${merchant.phone.replace(/'/g,'\'')}')" title="Ø§ØªØµØ§Ù„">
                                        <i class="fas fa-phone"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>`;
            } else if (merchant.phone && merchant.phone !== 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ' && !shouldShowPhone) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙˆÙ„ÙƒÙ† Ø¹Ø±Ø¶Ù‡ Ù…Ø¹Ø·Ù„
                phoneContent = `
                    <div class="detail-item">
                        <div class="detail-icon"><i class="fas fa-phone"></i></div>
                        <div class="detail-content">
                            <div class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ</div>
                            <div class="detail-value">
                                <div style="display:flex;justify-content:space-between;align-items:center;">
                                    <span style="color: var(--light-text); font-style: italic;">ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ø§Ù…Ø©</span>
                                </div>
                            </div>
                        </div>
                    </div>`;
            }

            // Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¬ÙˆØ§Ù„ - Ø§Ù„ØªØ­ÙƒÙ… ÙÙŠ Ø§Ù„Ø¹Ø±Ø¶ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±
            let mobileContent = '';
            if(merchant.mobile && shouldShowPhone){
                mobileContent = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span>${merchant.mobile}</span>
                        <div class="mini-action-buttons">
                            <button class="mini-action-btn mini-call-btn" onclick="callNumber('${merchant.mobile.replace(/'/g,'\'')}')" title="Ø§ØªØµØ§Ù„">
                                <i class="fas fa-phone"></i>
                            </button>
                            <button class="mini-action-btn mini-whatsapp-btn" id="openWhatsAppBtn" title="ÙˆØ§ØªØ³Ø§Ø¨">
                                <i class="fab fa-whatsapp"></i>
                            </button>
                            <button class="mini-action-btn mini-share-btn" id="shareLocationBtn" title="Ù…Ø´Ø§Ø±ÙƒØ©">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                    </div>`;
            } else if (merchant.mobile && !shouldShowPhone) {
                // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø±Ù‚Ù… Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹ ÙˆÙ„ÙƒÙ† Ø¹Ø±Ø¶Ù‡ Ù…Ø¹Ø·Ù„
                mobileContent = `
                    <div style="display:flex;justify-content:space-between;align-items:center;">
                        <span style="color: var(--light-text); font-style: italic;">ØºÙŠØ± Ù…ØªØ§Ø­ Ù„Ù„Ø¹Ø§Ù…Ø©</span>
                        <div class="mini-action-buttons">
                            <button class="mini-action-btn mini-share-btn" id="shareLocationBtnSmall" title="Ù…Ø´Ø§Ø±ÙƒØ©">
                                <i class="fas fa-share-alt"></i>
                            </button>
                        </div>
                    </div>`;
            } else {
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„
                mobileContent = `<div style="display:flex;justify-content:space-between;align-items:center;"><span>ØºÙŠØ± Ù…ØªÙˆÙØ±</span>
                    <div class="mini-action-buttons">
                        <button class="mini-action-btn mini-share-btn" id="shareLocationBtnSmall" title="Ù…Ø´Ø§Ø±ÙƒØ©">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>`;
            }

            // ØªÙˆÙ„ÙŠØ¯ HTML
            merchantDetailsDiv.innerHTML = `
                <div class="merchant-header">
                    <div class="merchant-avatar"><i class="fas fa-store"></i></div>
                    <div class="merchant-info">
                        <div class="merchant-name">${merchant.name || 'ØºÙŠØ± Ù…Ø­Ø¯Ø¯'}</div>
                        <div class="merchant-category">Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span id="userIdField">${merchant.userId || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}</span></div>
                        ${showDistanceField && shouldShowPhone ?`<div class="merchant-distance" id="distanceField"><i class="fas fa-road"></i> <span id="distanceValue">Ø¬Ø§Ø±ÙŠ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ©...</span></div>`:''}
                    </div>
                </div>

                <div class="details-section">
                    <div class="section-title"><i class="fas fa-info-circle"></i> Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©</div>

                    ${phoneContent}

                    <div class="detail-item"><div class="detail-icon"><i class="fas fa-mobile-alt"></i></div><div class="detail-content"><div class="detail-label">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ / ÙˆØ§ØªØ³Ø§Ø¨</div><div class="detail-value">${mobileContent}</div></div></div>

                    <div class="action-buttons" style="margin-top:8px">
                        <button class="action-btn secondary-btn" id="showOurProductsBtn"><i class="fas fa-boxes"></i> Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±</button>
                    </div>
                </div>

                <div class="details-section">
                    <div class="section-title"><i class="fas fa-link"></i> Ø§Ù„Ø±ÙˆØ§Ø¨Ø· ÙˆØ§Ù„Ù…ÙˆØ§Ù‚Ø¹</div>
                    <div style="display:flex;gap:8px;flex-wrap:wrap;margin-top:6px">
                        ${merchant.googleSite?`<a class="social-link" href="${merchant.googleSite}" target="_blank" title="Ù…ÙˆÙ‚Ø¹ Ø¬ÙˆØ¬Ù„"><i class="fas fa-globe"></i></a>`:''}
                        ${merchant.facebookSite?`<a class="social-link" href="${merchant.facebookSite}" target="_blank" title="ÙÙŠØ³Ø¨ÙˆÙƒ"><i class="fab fa-facebook"></i></a>`:''}
                        ${merchant.twitterSite?`<a class="social-link" href="${merchant.twitterSite}" target="_blank" title="ØªÙˆÙŠØªØ±"><i class="fab fa-twitter"></i></a>`:''}
                        ${merchant.instagramSite?`<a class="social-link" href="${merchant.instagramSite}" target="_blank" title="Ø§Ù†Ø³ØªØ¬Ø±Ø§Ù…"><i class="fab fa-instagram"></i></a>`:''}
                        ${merchant.youtubeSite?`<a class="social-link" href="${merchant.youtubeSite}" target="_blank" title="YouTube"><i class="fab fa-youtube"></i></a>`:''}
                        ${merchant.telegramSite?`<a class="social-link" href="${merchant.telegramSite}" target="_blank" title="Telegram"><i class="fab fa-telegram"></i></a>`:''}
                    </div>
                </div>
            `;

            // Ø¨Ø¹Ø¯ Ø¥Ø¯Ø±Ø§Ø¬ HTMLØŒ Ø£Ø¶Ù Ù…Ø³ØªÙ…Ø¹Ø§Øª Ù„Ù„Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
            const openWhatsBtn = document.getElementById('openWhatsAppBtn');
            if(openWhatsBtn && shouldShowPhone){ 
                openWhatsBtn.addEventListener('click', ()=>{ openWhatsApp(merchant.mobile||merchant.phone); }); 
            }

            const shareBtn = document.getElementById('shareLocationBtn');
            const shareBtnSmall = document.getElementById('shareLocationBtnSmall');
            const finalShareBtn = shareBtn || shareBtnSmall;
            if(finalShareBtn){ 
                finalShareBtn.addEventListener('click', ()=>{ shareMerchantDetails(merchant); }); 
            }

            // ====== Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ù„Ø²Ø± "Ø¹Ø±Ø¶ Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±" ======
            document.getElementById('showOurProductsBtn').addEventListener('click', ()=>{ 
                // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„ (sessionStorage Ùˆ localStorage)
                merchantGlobal.setMerchantData(merchant);
                
                console.log('ğŸ“¦ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„ (Ù„ØµÙØ­Ø© Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±):', {
                    name: merchantGlobal.getMerchantName(),
                    id: merchantGlobal.getMerchantId(),
                    phone: merchantGlobal.getMerchantPhone()
                });
                
                // ÙØªØ­ ØµÙØ­Ø© mnt.html Ø¨Ø¹Ø¯ ØªØ£Ø®ÙŠØ± Ø¨Ø³ÙŠØ·
                setTimeout(() => {
                    window.location.href = 'mnt.html';
                }, 500);
            });

            // Ø§Ø®ØªÙØ§Ø¡ Ù„ÙˆØ¯Ø±
            const loader = document.getElementById('loadingBox'); if(loader) loader.style.display = 'none';
            
            // Ø¥Ø¸Ù‡Ø§Ø± Ø²Ø± Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø¥Ø°Ø§ ÙƒØ§Ù† Ù‡Ù†Ø§Ùƒ Ù…ÙˆÙ‚Ø¹ Ù„Ù„ØªØ§Ø¬Ø±
            if (merchant.location) {
                fixedRouteBtn.style.display = 'flex';
            }
        }

        // ====== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ùˆ ÙˆØ§ØªØ³Ø§Ø¨ ======
        function callNumber(phoneNumber){ 
            if (!phoneNumber || phoneNumber === 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ') {
                showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù„Ù„ØªÙˆØ§ØµÙ„', 'error');
                return;
            }
            window.open(`tel:${phoneNumber}`,'_self'); 
        }

        function openWhatsApp(phoneNumber){
            if(!phoneNumber || phoneNumber === 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'){ 
                showNotification('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø±Ù‚Ù… Ù„Ù„ØªÙˆØ§ØµÙ„.', 'error'); 
                return; 
            }
            let clean = phoneNumber.replace(/\D/g,'');
            if(clean.startsWith('0') && clean.length===10) clean = '967' + clean.substring(1);
            if(!clean.startsWith('967') && clean.length===9) clean = '967' + clean;
            const msg = defaultWhatsAppMsg.replace('${globalProductName}', globalProductName);
            const url = `https://wa.me/${clean}?text=${encodeURIComponent(msg)}`;
            window.open(url,'_blank');
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…ÙˆÙ‚Ø¹ + ØªÙØ§ØµÙŠÙ„ + Ù…Ù†ØªØ¬Ø§Øª Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨
        function shareMerchantDetails(merchant){
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù…
            const shouldShowPhone = shouldShowPhoneNumber(merchant);
            
            // Ø±Ø§Ø¨Ø· Ø§Ù„Ù…ÙˆÙ‚Ø¹
            const mapLink = merchant.location? `https://www.google.com/maps?q=${merchant.location}` : 'Ø§Ù„Ù…ÙˆÙ‚Ø¹ ØºÙŠØ± Ù…ØªÙˆÙØ±';

            // Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
            let productsText = '';
            if(merchant.products){
                productsText = '\n\nğŸ›’ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª:\n';
                Object.values(merchant.products).forEach(p=>{ productsText += `- ${p.name || p.title || ''} ${p.price?(' - '+p.price):''}\n`; });
            }

            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù†Øµ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù…
            let phoneText = '';
            if (shouldShowPhone) {
                phoneText = `ğŸ“ Ø§Ù„Ù‡Ø§ØªÙ: ${merchant.phone || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}\nğŸ“± Ø§Ù„Ø¬ÙˆØ§Ù„: ${merchant.mobile || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}\n`;
            } else {
                phoneText = `ğŸ“ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø§ØªØµØ§Ù„: ØºÙŠØ± Ù…ØªØ§Ø­Ø© Ù„Ù„Ø¹Ø§Ù…Ø©\n`;
            }

            const msg = `ğŸ“ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±:\nğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${merchant.name || 'ØºÙŠØ± Ù…ØªÙˆÙØ±'}\n${phoneText}ğŸŒ Ø§Ù„Ù…ÙˆÙ‚Ø¹: ${mapLink}${productsText}\nğŸ”— Ø¹Ø¨Ø± ØªØ·Ø¨ÙŠÙ‚ AZ`;

            // Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ø¹Ø§Ù…Ø©
            if (navigator.share) {
                navigator.share({
                    title: `ØªÙØ§ØµÙŠÙ„ Ø§Ù„ØªØ§Ø¬Ø±: ${merchant.name || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ'}`,
                    text: msg,
                    url: window.location.href
                })
                .catch(error => console.log('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©:', error));
            } else {
                // Ø¨Ø¯ÙŠÙ„ Ù„Ù„Ù…ØªØµÙØ­Ø§Øª Ø§Ù„ØªÙŠ Ù„Ø§ ØªØ¯Ø¹Ù… ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©
                const encoded = encodeURIComponent(msg);
                window.open(`https://wa.me/?text=${encoded}`,'_blank');
            }
        }

        // ====== Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Leaflet Routing Ø£Ùˆ ØªØ¹ÙˆÙŠØ¶ Ø¨Ø®Ø· Ø¨Ø³ÙŠØ· ======
        function calculateRoute(){
            if(userMarker && currentMerchantCoords){
                if(currentRoute){ try{ map.removeControl(currentRoute); }catch(e){} }
                currentRoute = L.Routing.control({
                    waypoints: [ userMarker.getLatLng(), L.latLng(currentMerchantCoords[0], currentMerchantCoords[1]) ],
                    lineOptions: { styles: [{ color: 'blue', weight: 5 }] },
                    router: L.Routing.osrmv1({ serviceUrl: 'https://router.project-osrm.org/route/v1' }),
                    addWaypoints: false, draggableWaypoints: false, fitSelectedRoutes: true, show: false
                }).on('routesfound', function(e){
                    const route = e.routes && e.routes[0];
                    if(route){
                        const distance = (route.summary.totalDistance/1000).toFixed(2);
                        const duration = Math.ceil(route.summary.totalTime/60);
                        showNotification(`ØªÙ… Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±: ${distance} ÙƒÙ…ØŒ ${duration} Ø¯Ù‚ÙŠÙ‚Ø©`, 'success');
                    }
                }).addTo(map);
            } else {
                showNotification('ØªØ¹Ø°Ø± Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±. ØªØ£ÙƒØ¯ Ù…Ù† ØªÙØ¹ÙŠÙ„ Ù…ÙˆÙ‚Ø¹Ùƒ Ø£Ùˆ ÙˆØ¬ÙˆØ¯ Ù…ÙˆÙ‚Ø¹ Ø§Ù„ØªØ§Ø¬Ø±.', 'error');
            }
        }

        // ====== Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ======
        function getUserLocationAndPlaceMarker(merchant){
            if(navigator.geolocation){
                navigator.geolocation.getCurrentPosition(pos=>{
                    userCoords = [pos.coords.latitude, pos.coords.longitude];
                    userMarker = L.marker(userCoords,{title:'Ù…ÙˆÙ‚Ø¹Ùƒ'}).addTo(map).bindPopup('Ù…ÙˆÙ‚Ø¹Ùƒ Ø§Ù„Ø­Ø§Ù„ÙŠ').openPopup();

                    if(merchant && merchant.location){
                        const dist = calculateDistance(userCoords[0],userCoords[1], currentMerchantCoords[0], currentMerchantCoords[1]);
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§ÙØ©
                        const shouldShowPhone = shouldShowPhoneNumber(merchant);
                        if(hasValidPhoneNumber(merchant) && shouldShowPhone) updateDistanceField(dist);

                        // Ø¶Ø¨Ø· Ø§Ù„Ø¥Ø·Ø§Ø± Ù„Ø¹Ø±Ø¶ ÙƒÙ„Ø§ Ø§Ù„Ù†Ù‚Ø·ØªÙŠÙ†
                        try{ const bounds = L.latLngBounds([userCoords, currentMerchantCoords]); map.fitBounds(bounds, { padding:[50,50] }); }catch(e){}
                        
                        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
                        calculateRoute();
                    }
                }, err=>{
                    console.warn('gps err', err);
                    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§ÙØ©
                    const shouldShowPhone = shouldShowPhoneNumber(merchant);
                    if(hasValidPhoneNumber(merchant) && shouldShowPhone) updateDistanceField('ØºÙŠØ± Ù…ØªÙˆÙØ±');
                    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± ØªÙØ¹ÙŠÙ„ GPS
                    showGpsAlert();
                }, { timeout:10000 });
            } else {
                // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¹Ø±Ø¶ Ø§Ù„Ø±Ù‚Ù… Ù‚Ø¨Ù„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø³Ø§ÙØ©
                const shouldShowPhone = shouldShowPhoneNumber(merchant);
                if(hasValidPhoneNumber(merchant) && shouldShowPhone) updateDistanceField('ØºÙŠØ± Ù…ØªÙˆÙØ±');
                // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± ØªÙØ¹ÙŠÙ„ GPS
                showGpsAlert();
            }
        }

        // ====== Ø¯Ø§Ù„Ø© Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³Ø§ÙØ© (Haversine) ======
        function calculateDistance(lat1, lon1, lat2, lon2){
            const R = 6371; const dLat = (lat2-lat1)*Math.PI/180; const dLon = (lon2-lon1)*Math.PI/180;
            const a = Math.sin(dLat/2)*Math.sin(dLat/2) + Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180)*Math.sin(dLon/2)*Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return (R * c).toFixed(2);
        }

        // ====== ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ù…Ù† Firebase ======
        function loadMerchantData(){
            const merchantsRef = db.ref('merchants');
            merchantsRef.once('value').then(snapshot=>{
                const merchants = snapshot.val(); let merchantFound=false;
                if(merchants){
                    for(let key in merchants){
                        const merchant = merchants[key];
                        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø¹Ø±Ù Ø§Ù„ØªØ§Ø¬Ø± Ø£Ùˆ Ø§Ù„Ø§Ø³Ù…
                        if(merchant.userId === selectedMerchantId || merchant.name === selectedMerchantName){
                            merchantFound=true; 
                            
                            // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¥Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±
                            merchant.userId = merchant.userId || selectedMerchantId;
                            displayMerchantDetails(merchant);

                            if(merchant.location){
                                const coords = merchant.location.split(',').map(Number);
                                if(coords.length===2 && !coords.some(isNaN)){
                                    currentMerchantCoords = coords;
                                    L.marker(coords).addTo(map).bindPopup(`<strong>${merchant.name}</strong><br>${merchant.category||''}`).openPopup();
                                    map.setView(coords, 15);

                                    // Ø¶Ø¹ Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
                                    setTimeout(() => {
                                        getUserLocationAndPlaceMarker(merchant);
                                    }, 1000);
                                }
                            }
                            break;
                        }
                    }
                }
                if(!merchantFound){
                    merchantDetailsDiv.innerHTML = `<div style="text-align:center;padding:40px 20px;color:var(--light-text)"><i class="fas fa-store-slash fa-2x"></i><h3>Ø§Ù„ØªØ§Ø¬Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h3><p>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØªØ§Ø¬Ø± "${selectedMerchantName}"</p></div>`;
                    const loader = document.getElementById('loadingBox'); if(loader) loader.style.display = 'none';
                }
            }).catch(err=>{
                console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', err);
                merchantDetailsDiv.innerHTML = `<div style="text-align:center;padding:40px 20px;color:#dc3545"><i class="fas fa-exclamation-triangle fa-2x"></i><h3>Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</h3><p>ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</p></div>`;
            });
        }

        // Ø¨Ø¯Ø¡ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
        window.addEventListener('DOMContentLoaded', ()=>{ 
            loadMerchantData(); 
            
            // Ø¥Ø¶Ø§ÙØ© Ù…Ø³ØªÙ…Ø¹ Ù„Ø²Ø± Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³Ø§Ø±
            fixedRouteBtn.addEventListener('click', calculateRoute);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ…ÙŠ Ù„ØªØ´ØºÙŠÙ„ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ø§Ù„Ø¬ØºØ±Ø§ÙÙŠ Ø¨Ø¹Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
            setTimeout(() => {
                showLocationHelpAlert();
            }, 2000);
            
            // Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª localStorage ÙÙŠ Ø§Ù„ÙƒÙˆÙ†Ø³ÙˆÙ„ Ù„Ù„Ù…Ø³Ø§Ø¹Ø¯Ø© ÙÙŠ Ø§Ù„ØªØ´Ø®ÙŠØµ
            console.log('Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª localStorage:', localStorage);
        });
    </script>
</body>
</html>
