<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>عرض المنتجات مع المطابقات</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
            direction: rtl;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            margin-bottom: 40px;
            padding: 20px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }
        
        h1 {
            color: #2c3e50;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
        }
        
        .info-box {
            background-color: #e8f4fc;
            border-right: 5px solid #3498db;
            padding: 15px;
            border-radius: 8px;
            margin: 20px 0;
            font-size: 0.95rem;
            color: #2c3e50;
        }
        
        .filters {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-btn {
            padding: 10px 20px;
            background-color: white;
            border: 2px solid #3498db;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        .filter-btn.active {
            background-color: #3498db;
            color: white;
        }
        
        .filter-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        
        .product-card {
            background-color: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            height: auto;
            position: relative;
            cursor: pointer;
        }
        
        .product-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }
        
        .product-card.highlight {
            animation: highlight 2s ease;
            border: 2px solid #3498db;
        }
        
        @keyframes highlight {
            0% { background-color: rgba(52, 152, 219, 0.1); }
            100% { background-color: white; }
        }
        
        .product-name {
            font-size: 1.4rem;
            color: #2c3e50;
            margin-bottom: 15px;
            font-weight: 600;
        }
        
        .product-details {
            color: #7f8c8d;
            font-size: 0.95rem;
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .product-price {
            color: #e74c3c;
            font-weight: bold;
            font-size: 1.2rem;
            text-align: left;
            margin-bottom: 15px;
        }
        
        .matches-count {
            display: none; /* إخفاء عداد المطابقات */
        }
        
        .matches-label {
            display: none; /* إخفاء تسمية المطابقات */
        }
        
        .first-word {
            color: #3498db;
            font-weight: bold;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.5rem;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #e74c3c;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            margin: 20px 0;
        }
        
        /* شريط المنتجات المطابقة داخل البطاقة */
        .matches-bar-container {
            position: relative;
            margin-top: 15px;
            overflow: hidden;
            border-radius: 12px;
        }
        
        .matches-bar {
            display: flex; 
            gap: 8px; 
            padding: 12px; 
            overflow-x: auto;
            background: white; /* تغيير اللون إلى الأبيض */
            color: #2c3e50; /* تغيير لون النص إلى داكن */
            white-space: nowrap;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
            max-height: 0;
            opacity: 0;
            transition: max-height 0.4s ease, opacity 0.4s ease;
            overflow: hidden;
            cursor: grab;
            border: 1px solid #e0e0e0;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }
        
        /* شريط مفتوح تلقائياً على أجهزة سطح المكتب */
        .matches-bar.auto-open {
            max-height: 200px;
            opacity: 1;
            overflow-x: auto;
        }
        
        .matches-bar.active {
            max-height: 200px;
            opacity: 1;
            overflow-x: auto;
        }
        
        .matches-bar::-webkit-scrollbar {
            display: none;
        }
        
        .match-item {
            padding: 8px 12px; 
            background: #f8f9fa; /* تغيير الخلفية إلى فاتح */
            border-radius: 15px;
            border: 1px solid #e0e0e0; /* تغيير اللون الحدود */
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 13px;
            flex-shrink: 0;
            transition: all 0.3s ease;
            cursor: pointer;
            min-width: 160px;
            color: #2c3e50; /* تغيير لون النص */
            text-decoration: none;
        }
        
        .match-item:hover { 
            background: #e9ecef; /* تغيير لون الخلفية عند التمرير */
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            text-decoration: none;
            color: #2c3e50;
        }
        
        .match-image {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            object-fit: cover;
            border: 2px solid #e0e0e0; /* تغيير لون الحدود */
        }
        
        .match-info {
            display: flex;
            flex-direction: column;
            gap: 3px;
        }
        
        .match-name {
            font-weight: bold;
            font-size: 12px;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .match-price {
            font-size: 10px;
            opacity: 0.7;
            color: #e74c3c; /* تغيير لون السعر */
        }
        
        /* أزرار تمرير الأقسام - زينة فقط */
        .scroll-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(52, 152, 219, 0.15);
            color: #3498db;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            font-size: 12px;
            pointer-events: none;
            opacity: 0;
        }
        
        .matches-bar.active + .scroll-btn,
        .matches-bar.auto-open + .scroll-btn {
            opacity: 0.6;
        }
        
        .scroll-left {
            right: 5px;
        }
        
        .scroll-right {
            left: 5px;
        }
        
        .toggle-matches {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-size: 0.9rem;
            margin-top: 5px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            padding: 5px 10px;
            border-radius: 20px;
            background: rgba(52, 152, 219, 0.1);
        }
        
        /* إخفاء زر التبديل على أجهزة سطح المكتب عندما يكون الشريط مفتوحاً تلقائياً */
        .toggle-matches.desktop-hide {
            display: none;
        }
        
        .toggle-matches.mobile-show {
            display: flex;
        }
        
        .toggle-matches:hover {
            color: #2980b9;
            background: rgba(52, 152, 219, 0.2);
        }
        
        .no-matches {
            color: #7f8c8d;
            font-style: italic;
            padding: 10px;
            text-align: center;
            width: 100%;
        }
        
        /* مؤشر السحب */
        .matches-bar:active {
            cursor: grabbing;
        }
        
        /* مؤشر النقر على البطاقة */
        .product-card.has-matches {
            cursor: pointer;
        }
        
        /* تحسينات للهواتف المحمولة */
        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            }
            
            h1 {
                font-size: 2rem;
            }
            
            .match-item {
                padding: 6px 10px;
                min-width: 140px;
            }
            
            .match-image {
                width: 35px;
                height: 35px;
            }
            
            .match-name {
                max-width: 100px;
            }
            
            .scroll-btn {
                opacity: 0.4;
            }
            
            /* على الهواتف، إخفاء الشريط التلقائي وإظهار زر التبديل */
            .matches-bar.auto-open {
                max-height: 0;
                opacity: 0;
            }
            
            .toggle-matches.mobile-show {
                display: flex;
            }
            
            .toggle-matches.desktop-hide {
                display: none;
            }
        }
        
        /* تحسينات لأجهزة سطح المكتب */
        @media (min-width: 769px) {
            .toggle-matches.mobile-show {
                display: none;
            }
            
            .toggle-matches.desktop-hide {
                display: flex;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>منتجاتنا</h1>
            <p class="subtitle">استعرض مجموعة منتجاتنا المميزة مع نظام المطابقات</p>
        </header>
        
        <div class="info-box">
            <strong>معلومات:</strong> يعرض النظام المنتجات المطابقة تلقائياً على أجهزة الكمبيوتر. على الهواتف، انقر على بطاقة المنتج لعرض المنتجات المطابقة.
        </div>
        
        <div class="filters">
            <button class="filter-btn active" data-filter="all">جميع المنتجات</button>
            <button class="filter-btn" data-filter="high">أعلى مطابقات</button>
            <button class="filter-btn" data-filter="low">أقل مطابقات</button>
        </div>
        
        <div id="productsContainer" class="products-grid">
            <div class="loading">جاري تحميل المنتجات...</div>
        </div>
    </div>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database-compat.js"></script>
    
    <!-- Font Awesome للأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/"
        };
        
        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // مرجع للمنتجات
        const productsRef = database.ref("products");
        
        // عناصر DOM
        const productsContainer = document.getElementById("productsContainer");
        
        // بيانات التطبيق
        let productsData = [];
        let allProducts = {};
        let productCards = {};
        
        // دالة للتحقق إذا كان الجهاز محمولاً
        function isMobileDevice() {
            return window.innerWidth <= 768;
        }
        
        // دالة لاستخراج الكلمة الأولى من النص
        function getFirstWord(text) {
            if (!text || text.trim() === '') return '';
            
            const words = text
                .replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFFa-zA-Z0-9\s]/g, '')
                .trim()
                .split(/\s+/);
                
            return words.length > 0 ? words[0] : '';
        }
        
        // دالة لاستخراج رابط الصورة من بيانات المنتج
        function extractImageUrl(product) {
            if (!product) return '';
            
            let imageUrl = '';
            
            if (product.imageUrls) {
                if (Array.isArray(product.imageUrls) && product.imageUrls.length > 0) {
                    imageUrl = product.imageUrls[0];
                } else if (typeof product.imageUrls === 'string') {
                    const urls = product.imageUrls.split(',').map(u => u.trim()).filter(Boolean);
                    if (urls.length > 0) imageUrl = urls[0];
                }
            }
            
            if (!imageUrl && product.image && typeof product.image === 'string') {
                const urls = product.image.split(/[,\n]/).map(u => u.trim()).filter(Boolean);
                if (urls.length > 0) imageUrl = urls[0];
            }
            
            if (!imageUrl) {
                imageUrl = 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w800';
            }
            
            return imageUrl;
        }
        
        // دالة لتنسيق رابط الصورة
        function formatDriveUrl(url, mode = 'thumb') {
            if (!url) return '';
            
            if (url.includes('1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC')) {
                return url;
            }
            
            let id = '';
            
            if (url.includes('/d/')) {
                id = url.split('/d/')[1].split('/')[0];
            } 
            else if (url.includes('id=')) {
                try { 
                    id = new URLSearchParams(url.split('?')[1]).get('id') || ''; 
                } catch { 
                    return url; 
                }
            }
            else if (url.includes('/file/d/')) {
                id = url.split('/file/d/')[1].split('/')[0];
            }
            else if (url.includes('drive.google.com/uc?id=')) {
                id = url.split('drive.google.com/uc?id=')[1].split('&')[0];
            }
            
            if (!id) return url;

            if (mode === 'thumb') {
                return `https://drive.google.com/thumbnail?id=${id}&sz=w400`;
            } else if (mode === 'main') {
                return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
            }
            return url;
        }
        
        // دالة لحساب عدد المطابقات لمنتج معين (بنفس القسم)
        function calculateMatches(currentProductName, currentProductCategory, allProducts, currentProductId) {
            const firstWord = getFirstWord(currentProductName);
            if (!firstWord) return 0;
            
            let matchCount = 0;
            
            Object.keys(allProducts).forEach(productId => {
                if (productId !== currentProductId) {
                    const otherProduct = allProducts[productId];
                    const otherProductName = otherProduct.name || '';
                    
                    if (otherProductName.includes(firstWord) && otherProduct.category === currentProductCategory) {
                        matchCount++;
                    }
                }
            });
            
            return matchCount;
        }
        
        // دالة للحصول على المنتجات المطابقة لمنتج معين (بنفس القسم)
        function getMatchingProducts(currentProductName, currentProductCategory, allProducts, currentProductId) {
            const firstWord = getFirstWord(currentProductName);
            if (!firstWord) return [];
            
            let matchingProducts = [];
            
            Object.keys(allProducts).forEach(productId => {
                if (productId !== currentProductId) {
                    const otherProduct = allProducts[productId];
                    const otherProductName = otherProduct.name || '';
                    
                    if (otherProductName.includes(firstWord) && otherProduct.category === currentProductCategory) {
                        matchingProducts.push({
                            id: productId,
                            ...otherProduct
                        });
                    }
                }
            });
            
            return matchingProducts;
        }
        
        // دالة لتصفية المنتجات حسب عدد المطابقات
        function filterProducts(products, filterType) {
            const sortedProducts = [...products];
            
            switch(filterType) {
                case 'high':
                    return sortedProducts.sort((a, b) => b.matches - a.matches);
                case 'low':
                    return sortedProducts.sort((a, b) => a.matches - b.matches);
                default:
                    return sortedProducts;
            }
        }
        
        // دالة لإعداد أزرار التمرير (زينة فقط)
        function setupScrollButtons(container, leftBtn, rightBtn) {
            const checkScrollButtons = () => {
                const scrollLeftVisible = container.scrollLeft > 0;
                const scrollRightVisible = container.scrollLeft < container.scrollWidth - container.clientWidth;
                
                if (container.children.length > 2 && 
                    (container.classList.contains('active') || container.classList.contains('auto-open'))) {
                    leftBtn.style.display = scrollLeftVisible ? 'flex' : 'none';
                    rightBtn.style.display = scrollRightVisible ? 'flex' : 'none';
                } else {
                    leftBtn.style.display = 'none';
                    rightBtn.style.display = 'none';
                }
            };

            container.addEventListener('scroll', checkScrollButtons);
            
            setTimeout(checkScrollButtons, 100);
        }
        
        // دالة للانتقال إلى منتج في نفس الصفحة
        function goToProduct(productId) {
            const productCard = productCards[productId];
            if (productCard) {
                productCard.classList.add('highlight');
                
                productCard.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                setTimeout(() => {
                    productCard.classList.remove('highlight');
                }, 2000);
            }
        }
        
        // دالة لعرض المنتجات المطابقة في الشريط
        function loadMatchingProducts(matchesBar, product, scrollLeftBtn, scrollRightBtn) {
            const matchingProducts = getMatchingProducts(
                product.name, 
                product.category, 
                allProducts, 
                product.id
            );
            
            matchesBar.innerHTML = '';
            
            if (matchingProducts.length === 0) {
                matchesBar.innerHTML = '<div class="no-matches">لا توجد منتجات مطابقة في نفس القسم</div>';
            } else {
                matchingProducts.forEach(match => {
                    const matchImageUrl = formatDriveUrl(extractImageUrl(match), 'thumb');
                    
                    const matchItem = document.createElement('a');
                    matchItem.className = 'match-item';
                    matchItem.href = 'javascript:void(0)';
                    matchItem.innerHTML = `
                        <img src="${matchImageUrl}" alt="${match.name || 'منتج'}" class="match-image">
                        <div class="match-info">
                            <div class="match-name">${match.name || 'منتج بدون اسم'}</div>
                            <div class="match-price">${match.price ? match.price + ' ريال' : 'بدون سعر'}</div>
                        </div>
                    `;
                    
                    matchItem.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        goToProduct(match.id);
                    });
                    
                    matchesBar.appendChild(matchItem);
                });
                
                setupScrollButtons(matchesBar, scrollLeftBtn, scrollRightBtn);
            }
        }
        
        // دالة لعرض المنتجات
        function renderProducts(products) {
            productsContainer.innerHTML = '';
            productCards = {};
            
            if (products.length === 0) {
                productsContainer.innerHTML = '<div class="error">لا توجد منتجات متاحة حالياً</div>';
                return;
            }
            
            products.forEach(product => {
                const firstWord = getFirstWord(product.name || '');
                const productImageUrl = formatDriveUrl(extractImageUrl(product), 'thumb');
                
                // إنشاء بطاقة المنتج
                const productCard = document.createElement('div');
                productCard.className = 'product-card';
                productCard.id = `product-${product.id}`;
                
                productCards[product.id] = productCard;
                
                // إضافة اسم المنتج مع تمييز الكلمة الأولى
                const productName = document.createElement('div');
                productName.className = 'product-name';
                
                if (firstWord && product.name) {
                    const highlightedName = product.name.replace(
                        firstWord, 
                        `<span class="first-word">${firstWord}</span>`
                    );
                    productName.innerHTML = highlightedName;
                } else {
                    productName.textContent = product.name || 'منتج بدون اسم';
                }
                
                // إضافة وصف المنتج (إن وجد)
                const productDetails = document.createElement('div');
                productDetails.className = 'product-details';
                productDetails.textContent = product.description || 'وصف المنتج غير متوفر';
                
                // إضافة سعر المنتج (إن وجد)
                const productPrice = document.createElement('div');
                productPrice.className = 'product-price';
                productPrice.textContent = product.price ? `${product.price} ريال` : 'السعر غير متوفر';
                
                // إضافة عدد المطابقات (مخفي)
                const matchesCount = document.createElement('div');
                matchesCount.className = 'matches-count';
                matchesCount.textContent = product.matches;
                
                const matchesLabel = document.createElement('div');
                matchesLabel.className = 'matches-label';
                matchesLabel.textContent = 'مطابق';
                
                // إنشاء حاوية للمنتجات المطابقة
                const matchesContainer = document.createElement('div');
                matchesContainer.className = 'matches-bar-container';
                
                // شريط المنتجات المطابقة
                const matchesBar = document.createElement('div');
                matchesBar.className = 'matches-bar';
                
                // أزرار التمرير (زينة فقط)
                const scrollLeftBtn = document.createElement('button');
                scrollLeftBtn.className = 'scroll-btn scroll-left';
                scrollLeftBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                scrollLeftBtn.disabled = true;
                
                const scrollRightBtn = document.createElement('button');
                scrollRightBtn.className = 'scroll-btn scroll-right';
                scrollRightBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                scrollRightBtn.disabled = true;
                
                // زر تبديل عرض المنتجات المطابقة (للهواتف)
                const toggleMatchesBtnMobile = document.createElement('button');
                toggleMatchesBtnMobile.className = 'toggle-matches mobile-show';
                toggleMatchesBtnMobile.innerHTML = `<i class="fas fa-chevron-down"></i> عرض المنتجات المطابقة`;
                
                // زر تبديل عرض المنتجات المطابقة (للسطح المكتب)
                const toggleMatchesBtnDesktop = document.createElement('button');
                toggleMatchesBtnDesktop.className = 'toggle-matches desktop-hide';
                toggleMatchesBtnDesktop.innerHTML = `<i class="fas fa-chevron-up"></i> إخفاء المنتجات المطابقة`;
                
                // تحميل المنتجات المطابقة تلقائياً على أجهزة سطح المكتب
                if (!isMobileDevice() && product.matches > 0) {
                    matchesBar.classList.add('auto-open');
                    loadMatchingProducts(matchesBar, product, scrollLeftBtn, scrollRightBtn);
                }
                
                // إعداد حدث النقر لعرض/إخفاء المنتجات المطابقة
                const toggleMatches = () => {
                    const isActive = matchesBar.classList.contains('active');
                    
                    if (!isActive && !matchesBar.classList.contains('auto-open')) {
                        loadMatchingProducts(matchesBar, product, scrollLeftBtn, scrollRightBtn);
                    }
                    
                    matchesBar.classList.toggle('active');
                    matchesBar.classList.remove('auto-open');
                    
                    toggleMatchesBtnMobile.innerHTML = matchesBar.classList.contains('active') 
                        ? `<i class="fas fa-chevron-up"></i> إخفاء المنتجات المطابقة`
                        : `<i class="fas fa-chevron-down"></i> عرض المنتجات المطابقة`;
                        
                    toggleMatchesBtnDesktop.innerHTML = matchesBar.classList.contains('active') 
                        ? `<i class="fas fa-chevron-up"></i> إخفاء المنتجات المطابقة`
                        : `<i class="fas fa-chevron-down"></i> عرض المنتجات المطابقة`;
                        
                    setTimeout(() => {
                        setupScrollButtons(matchesBar, scrollLeftBtn, scrollRightBtn);
                    }, 100);
                };
                
                // إضافة حدث النقر على بطاقة المنتج (للهواتف فقط)
                if (product.matches > 0) {
                    productCard.classList.add('has-matches');
                    
                    if (isMobileDevice()) {
                        productCard.addEventListener('click', (e) => {
                            if (!e.target.closest('.toggle-matches') && !e.target.closest('.match-item')) {
                                toggleMatches();
                            }
                        });
                    }
                }
                
                // إضافة حدث النقر على أزرار التبديل
                toggleMatchesBtnMobile.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMatches();
                });
                
                toggleMatchesBtnDesktop.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleMatches();
                });
                
                // إضافة العناصر إلى الحاوية
                matchesContainer.appendChild(matchesBar);
                matchesContainer.appendChild(scrollLeftBtn);
                matchesContainer.appendChild(scrollRightBtn);
                
                // إضافة العناصر إلى البطاقة
                productCard.appendChild(productName);
                productCard.appendChild(productDetails);
                productCard.appendChild(productPrice);
                productCard.appendChild(matchesCount);
                productCard.appendChild(matchesLabel);
                productCard.appendChild(matchesContainer);
                productCard.appendChild(toggleMatchesBtnMobile);
                productCard.appendChild(toggleMatchesBtnDesktop);
                
                // إضافة البطاقة إلى الحاوية
                productsContainer.appendChild(productCard);
            });
        }
        
        // دالة لتحميل البيانات بسرعة
        function loadData() {
            productsContainer.innerHTML = '<div class="loading">جاري تحميل المنتجات...</div>';
            
            productsRef.once('value')
                .then((snapshot) => {
                    const products = snapshot.val();
                    
                    if (products) {
                        allProducts = products;
                        
                        productsData = Object.keys(products).map(productId => {
                            const product = products[productId];
                            const matches = calculateMatches(
                                product.name || '', 
                                product.category,
                                products, 
                                productId
                            );
                            
                            return {
                                id: productId,
                                ...product,
                                matches
                            };
                        });
                        
                        renderProducts(productsData);
                    } else {
                        productsContainer.innerHTML = '<div class="error">لا توجد منتجات متاحة حالياً</div>';
                    }
                })
                .catch((error) => {
                    productsContainer.innerHTML = `<div class="error">حدث خطأ في جلب البيانات: ${error.message}</div>`;
                });
        }
        
        // تحميل البيانات عند فتح الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            
            // تحديث الواجهة عند تغيير حجم النافذة
            window.addEventListener('resize', () => {
                // إعادة تحميل الواجهة للتأكد من التكيف مع حجم الشاشة
                if (productsData.length > 0) {
                    renderProducts(productsData);
                }
            });
            
            // إضافة أحداث لأزرار التصفية
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.filter-btn').forEach(b => {
                        b.classList.remove('active');
                    });
                    
                    this.classList.add('active');
                    
                    const filterType = this.getAttribute('data-filter');
                    const filteredProducts = filterProducts(productsData, filterType);
                    renderProducts(filteredProducts);
                });
            });
        });
    </script>
</body>
</html>
