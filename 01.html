<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZ السوق الشامل - سوق تجاري متكامل للمنتجات الجديدة والمستعملة والعقارات والوظائف</title>
    
    <!-- إضافة الكلمات المفتاحية لتحسين محركات البحث -->
    <meta name="description" content="AZ السوق الشامل - منصة تجارية متكاملة تحتوي على المنتجات الجديدة والمستعملة، العقارات، الوظائف، توصيل المطاعم والبوفيهات، وأرقام مهمة لتلبية جميع احتياجاتك">
    <meta name="keywords" content="AZ السوق الشامل, سوق تجاري, منتجات جديدة, منتجات مستعملة, حراج, عقارات, شقق للإيجار, وظائف شاغرة, توصيل طعام, مطاعم, بوفيهات, لحوم, تسوق, تسوق الكتروني, منصة تجارية, سوق الكتروني, شراء, بيع, عروض, متجر الكتروني, تجارة, تسوق عبر الإنترنت, سوق عربي, سوق السعودية, سوق الخليج, سوق الشرق الأوسط">
    <meta name="author" content="AZ السوق الشامل">
    
    <!-- كلمات مفتاحية بلغات مختلفة -->
    <meta name="keywords" content="AZ marketplace, online shopping, e-commerce, Saudi market, Gulf market, Middle East market, used products, real estate, jobs, food delivery">
    <meta name="keywords" content="AZ marché complet, shopping en ligne, commerce électronique, marché saoudien, produits d'occasion, immobilier, emplois, livraison de nourriture">
    <meta name="keywords" content="AZ mercado completo, compras en línea, comercio electrónico, mercado saudí, productos usados, bienes raíces, empleos, entrega de comida">
    <meta name="keywords" content="AZ vollständiger Markt, Online-Shopping, E-Commerce, saudischer Markt, gebrauchte Produkte, Immobilien, Jobs, Essenslieferung">
    <meta name="keywords" content="AZ 完全市場, オンラインショッピング, 電子商取引, サウジ市場, 中古品, 不動産, 求人, フードデリバリー">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --background-color: #ffffff;
            --text-color: #333;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transition: all 0.25s ease;
        }

        [data-theme="dark"] {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --background-color: #121212;
            --text-color: #ecf0f1;
            --light-color: #2c3e50;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding-top: 128px;
            padding-bottom: 40px; /* تعديل لحساب الشريط الثابت فقط */
            transition: var(--transition);
            width: 100%;
            overflow-x: hidden;
        }

        /* إخفاء شاشة التحميل */
        .loading-overlay {
            display: none !important;
        }

        /* الهيدر مع اللمعة المتحركة */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: var(--box-shadow);
            /* إضافة اللمعة المتحركة */
            position: relative;
            overflow: hidden;
        }

        .header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255,255,255,0.3), transparent);
            transform: rotate(45deg);
            animation: shimmer 3s infinite linear;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) rotate(45deg); }
            100% { transform: translateX(100%) rotate(45deg); }
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo {
            width: 50px; /* تم تصغير الشعار */
            height: 50px;
            object-fit: contain; /* تغيير من cover إلى contain */
            border-radius: 10px;
            background: white;
            padding: 4px;
            border: 2px solid white;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .brand-title {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }

        .brand-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        /* إزالة حقل القسم من الشريط العلوي */
        .header-category {
            display: none;
        }

        /* زر تسجيل الدخول الجديد - تم تعديل موقعه ليصبح فوق عدد المتصلين */
        .header-login {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            cursor: pointer;
            text-decoration: none;
            order: 1;
        }

        .header-login:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .header-online-users {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            cursor: pointer;
            order: 2;
        }

        .header-online-users.active {
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        /* تأثير الوميض عند تغير العدد */
        .header-online-users.increase {
            animation: flashGreen 1s ease-in-out;
        }

        .header-online-users.decrease {
            animation: flashRed 1s ease-in-out;
        }

        @keyframes flashGreen {
            0% { background: rgba(255, 255, 255, 0.2); }
            25% { background: var(--success-color); transform: scale(1.05); }
            50% { background: rgba(255, 255, 255, 0.2); }
            75% { background: var(--success-color); transform: scale(1.05); }
            100% { background: rgba(255, 255, 255, 0.2); transform: scale(1); }
        }

        @keyframes flashRed {
            0% { background: rgba(255, 255, 255, 0.2); }
            25% { background: var(--danger-color); transform: scale(1.05); }
            50% { background: rgba(255, 255, 255, 0.2); }
            75% { background: var(--danger-color); transform: scale(1.05); }
            100% { background: rgba(255, 255, 255, 0.2); transform: scale(1); }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* إزالة زر المفضلة من الشريط العلوي */
        .header-favorites {
            display: none;
        }

        /* الشريط الجديد أسفل الشريط العلوي */
        .secondary-bar {
            position: fixed;
            top: 84px;
            left: 0;
            width: 100%;
            background: var(--dark-color);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: white;
        }

        .secondary-bar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .secondary-bar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .secondary-bar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .secondary-category {
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
        }

        .secondary-category label {
            font-size: 14px;
            white-space: nowrap;
            color: white;
        }

        /* تحسينات القائمة المنسدلة للبحث في الأقسام */
        .category-search-container {
            position: relative;
        }

        .category-search-input {
            padding: 6px 10px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: var(--transition);
            min-width: 150px;
            margin-bottom: 5px;
            width: 100%;
        }

        .category-search-input:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .category-search-input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .secondary-category select {
            padding: 6px 10px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: var(--transition);
            min-width: 150px;
            max-height: 200px;
            overflow-y: auto;
        }

        .secondary-category select:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .secondary-category select:focus {
            outline: none;
            background: rgba(255, 255, 255, 0.25);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .secondary-category select option {
            background: var(--dark-color);
            color: white;
            padding: 8px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .secondary-category select option .category-count {
            float: left;
            background: var(--primary-color);
            color: white;
            padding: 2px 6px;
            border-radius: 10px;
            font-size: 12px;
            margin-left: 5px;
        }

        .products-count {
            font-size: 14px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 15px;
        }

        /* إخفاء متصل حقيقي وتعديل النص - تم تصغيره */
        .online-users-real {
            font-size: 14px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 15px;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            transition: var(--transition);
        }

        .online-users-real:hover {
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 0 12px rgba(255, 255, 255, 0.7);
        }

        .show-more-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .show-more-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .secondary-favorites {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .secondary-favorites:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        /* شارة العرض الخاص - تم تعديل الموقع واللون إلى الأخضر */
        .offer-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #2ecc71, #27ae60); /* تغيير اللون إلى الأخضر */
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.4); /* تغيير اللون إلى الأخضر */
            animation: pulse 2s infinite;
            display: flex;
            align-items: center;
            gap: 5px;
            cursor: pointer;
        }

        .offer-badge i {
            font-size: 12px;
        }

        /* شارة التواريخ - تم تعديل المواقع والحجم واللون إلى الأخضر */
        .offer-dates {
            position: absolute;
            top: 50px; /* أسفل شارة العرض مباشرة */
            left: 10px;
            background: linear-gradient(135deg, #2ecc71, #27ae60); /* تغيير اللون إلى الأخضر */
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px; /* نفس حجم الخط */
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4); /* تغيير اللون إلى الأخضر */
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-width: 180px;
            display: none; /* مخفية افتراضياً */
        }

        .offer-dates-end {
            position: absolute;
            top: 83px; /* نفس موقع شارة التواريخ */
            right: 500px;
            background: linear-gradient(135deg, #2ecc71, #27ae60); /* تغيير اللون إلى الأخضر */
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px; /* نفس حجم الخط */
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4); /* تغيير اللون إلى الأخضر */
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-width: 180px;
            display: none; /* مخفية افتراضياً */
        }

        .offer-dates div {
            display: flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .offer-dates i {
            font-size: 10px;
        }

        /* شريط الفلترة */
        .filter-bar {
            position: fixed;
            top: 128px;
            left: 0;
            width: 100%;
            background: var(--light-color);
            padding: 10px 20px;
            display: none;
            flex-wrap: wrap;
            gap: 10px;
            z-index: 998;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            align-items: center;
            transition: var(--transition);
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-item label {
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }

        .filter-item select, .filter-item input {
            padding: 6px 10px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            font-size: 14px;
            background: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        .filter-item input {
            width: 200px;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .search-container input {
            flex: 1;
        }

        .voice-search-btn {
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .voice-search-btn:hover {
            background: #27ae60;
        }

        .voice-search-btn.listening {
            background: var(--danger-color);
            animation: pulse 1.5s infinite;
        }

        .reset-btn {
            padding: 8px 12px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--primary-color);
            color: white;
            position: relative;
        }

        .reset-btn .tooltip {
            visibility: hidden;
            width: 120px;
            background-color: var(--dark-color);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }

        .reset-btn:hover .tooltip {
            visibility: visible;
            opacity: 1;
        }

        /* الفوتر مع الإعلانات النصية - تم التعديل بشكل كامل */
        .footer {
            position: fixed;
            bottom: 0; /* أصبح في الأسفل مباشرة */
            left: 0;
            width: 100%;
            background: transparent; /* تغيير إلى شفاف */
            color: var(--text-color); /* تغيير لون النص */
            text-align: center;
            padding: 8px 15px;
            z-index: 1000;
            font-size: 14px;
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
            height: 40px; /* ارتفاع ثابت للفوتير */
            display: flex;
            align-items: center;
            justify-content: center;
            /* إزالة تأثير الفقاعة اللامعة */
            box-shadow: none;
            border-top: none;
        }

        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            height: 30px;
            width: 100%;
            z-index: 2;
        }

        .footer-text {
            white-space: nowrap;
            position: relative;
            font-size: 16px;
            font-weight: bold;
            padding: 0; /* إزالة الحشوة */
            border-radius: 0; /* إزالة الزوايا المستديرة */
            background: transparent; /* إزالة الخلفية */
            color: var(--text-color); /* استخدام لون النص العادي */
            text-shadow: none; /* إزالة تأثير الظل */
            overflow: visible;
            width: auto;
            max-width: 90%;
            margin: 0 auto;
            text-overflow: unset;
            line-height: 1.2;
            min-height: auto; /* إزالة الارتفاع الأدنى */
            display: flex;
            align-items: center;
            justify-content: center;
            animation: slideText 15s linear infinite;
            /* إزالة تأثيرات إضافية للفقاعة */
            backdrop-filter: none;
            border: none;
        }

        /* حركات جديدة ومميزة للإعلانات */
        @keyframes slideText {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        @keyframes bounceText {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        @keyframes pulseText {
            0% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.05);
            }
            100% {
                transform: scale(1);
            }
        }

        @keyframes fadeText {
            0% {
                opacity: 0;
            }
            50% {
                opacity: 1;
            }
            100% {
                opacity: 0;
            }
        }

        @keyframes typeText {
            0% {
                width: 0;
            }
            100% {
                width: 100%;
            }
        }

        @keyframes waveText {
            0% {
                transform: translateX(0);
            }
            25% {
                transform: translateX(-5px);
            }
            75% {
                transform: translateX(5px);
            }
            100% {
                transform: translateX(0);
            }
        }

        /* حركات دخول وخروج جديدة ومميزة */
        @keyframes slideInExpand {
            0% {
                transform: translateX(-100%) scale(0.8);
                opacity: 0;
            }
            20% {
                transform: translateX(-50%) scale(1.1);
                opacity: 1;
            }
            80% {
                transform: translateX(50%) scale(1.1);
                opacity: 1;
            }
            100% {
                transform: translateX(100%) scale(0.8);
                opacity: 0;
            }
        }

        @keyframes zoomInOut {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            20% {
                transform: scale(1.1);
                opacity: 1;
            }
            80% {
                transform: scale(1.1);
                opacity: 1;
            }
            100% {
                transform: scale(0.5);
                opacity: 0;
            }
        }

        @keyframes rotateInOut {
            0% {
                transform: rotate(-180deg) scale(0.5);
                opacity: 0;
            }
            20% {
                transform: rotate(0) scale(1);
                opacity: 1;
            }
            80% {
                transform: rotate(0) scale(1);
                opacity: 1;
            }
            100% {
                transform: rotate(180deg) scale(0.5);
                opacity: 0;
            }
        }

        @keyframes flipInOut {
            0% {
                transform: perspective(400px) rotateY(90deg);
                opacity: 0;
            }
            20% {
                transform: perspective(400px) rotateY(0);
                opacity: 1;
            }
            80% {
                transform: perspective(400px) rotateY(0);
                opacity: 1;
            }
            100% {
                transform: perspective(400px) rotateY(-90deg);
                opacity: 0;
            }
        }

        /* إزالة الشريط الثابت القديم */
        .fixed-footer {
            display: none; /* تم إخفاء الشريط الثابت القديم */
        }

        .online-users {
            display: none;
        }

        /* زر العودة للأعلى - تم تعديل الموقع */
        .scroll-to-top {
            position: fixed;
            bottom: 60px; /* تعديل الموقع ليكون فوق الشريط الجديد */
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
        }

        .scroll-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .scroll-to-top:hover {
            background: var(--secondary-color);
            transform: translateY(-3px);
        }

        /* زر تحكم الشريط - تم تعديل الموقع */
        .filter-control {
            position: fixed;
            bottom: 120px; /* تعديل الموقع ليكون فوق الشريط الجديد */
            right: 20px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            opacity: 1;
            visibility: visible;
        }

        .filter-control:hover {
            background: #27ae60;
            transform: translateY(-3px);
        }

        /* محتوى الصفحة */
        .page-content {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
        }

        /* شبكة المنتجات */
        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(100%, 1fr));
            gap: 20px;
            padding: 10px;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }

        /* البطاقة */
        .card {
            background: linear-gradient(145deg, var(--background-color), #f0f0f1);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            padding: 15px;
            transition: var(--transition);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: fit-content;
            width: 100%;
            box-sizing: border-box;
            border: 3px solid #3498db;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            border-color: #2980b9;
        }

        .card.highlighted {
            border: 3px solid var(--warning-color);
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
            animation: pulse 2s ease-in-out 3;
        }

        /* البطاقة مع عرض خاص - تغيير لون الإطار إلى الأخضر */
        .card.has-offer {
            border: 3px solid #2ecc71; /* تغيير لون الإطار إلى الأخضر */
        }

        /* حاوية الصنف - تم إظهارها */
        .category-container {
            display: block !important;
            width: 100%;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--light-color);
            border-radius: 10px;
            border: 1px solid var(--primary-color);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .category-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .category-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        /* صور المنتجات */
        .images-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            justify-content: center;
            width: 100%;
            position: relative;
            box-sizing: border-box;
        }

        .images-preview img {
            width: 100%;
            height: 300px;
            object-fit: contain;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            border: 3px solid var(--primary-color);
            position: relative;
            background-color: #f5f5f5;
        }

        .images-preview img:hover {
            transform: scale(1.03);
            border-color: var(--secondary-color);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        /* تغيير لون إطار الصورة للمنتجات التي لها عرض خاص */
        .card.has-offer .images-preview img,
        .card.has-offer .slider-image {
            border: 3px solid #2ecc71; /* تغيير لون الإطار إلى الأخضر */
        }

        /* زر "أكثر..." في البطاقة - تم حذفه */
        .more-products-btn {
            display: none;
        }

        /* شريط تمرير الصور */
        .image-slider {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 10px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .slider-container {
            display: flex;
            height: 100%;
            scroll-behavior: smooth;
            width: 100%;
        }

        .slider-image {
            min-width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
            border: 3px solid var(--primary-color);
            border-radius: 10px;
            background-color: #f5f5f5;
        }

        .slider-nav {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 5px;
            z-index: 5;
        }

        .slider-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.5);
            cursor: pointer;
            transition: var(--transition);
        }

        .slider-dot.active {
            background: var(--primary-color);
            transform: scale(1.2);
        }

        .slider-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            transition: var(--transition);
        }

        .slider-arrow:hover {
            background: rgba(0, 0, 0, 0.7);
        }

        .slider-arrow.prev {
            left: 10px;
        }

        .slider-arrow.next {
            right: 10px;
        }

        /* معرض الصور المحسن - إصلاح مشكلة الخروج على الجوال */
        .image-gallery {
            display: none;
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.25s ease;
        }

        .image-gallery.active {
            display: flex;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .gallery-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border-radius: 0;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            animation: slideUp 0.3s ease-out;
            min-width: 100%;
            min-height: 100%;
            box-sizing: border-box;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-color);
            flex-shrink: 0;
        }

        .gallery-title {
            color: white;
            font-size: 22px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gallery-close {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
            z-index: 2001;
        }

        .gallery-close:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(231, 76, 60, 0.6);
        }

        .gallery-main-content {
            display: flex;
            gap: 16px;
            flex: 1;
            min-height: 0;
            width: 100%;
            height: calc(100% - 120px);
        }

        .gallery-main-image-container {
            flex: 4;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #0f0f23, #1a1a2e);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--primary-color);
            min-height: 60vh;
            width: 100%;
            height: 100%;
        }

        .gallery-main-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 10px;
            transition: transform 0.25s ease;
            cursor: zoom-in;
            will-change: transform;
            image-rendering: auto;
            background-color: #0f0f23;
        }

        .gallery-main-image.zoomed {
            transform: scale(1.85);
            cursor: zoom-out;
        }

        .gallery-thumbnails {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 100%;
            overflow-y: auto;
            padding: 10px;
            background: linear-gradient(145deg, #0f0f23, #16213e);
            border-radius: 15px;
            border: 1px solid var(--primary-color);
        }

        .gallery-thumbnails::-webkit-scrollbar {
            width: 8px;
        }

        .gallery-thumbnails::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        .gallery-thumbnails::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 4px;
        }

        .gallery-thumbnail {
            width: 100%;
            height: 90px;
            object-fit: contain;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            opacity: 0.85;
            background: #0f0f23;
        }

        .gallery-thumbnail:hover {
            opacity: 1;
            border-color: var(--primary-color);
            transform: scale(1.03);
        }

        .gallery-thumbnail.active {
            opacity: 1;
            border-color: var(--warning-color);
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.6);
        }

        .gallery-bottom-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 16px;
            padding: 16px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .gallery-nav-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .gallery-nav-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.6);
        }

        .gallery-nav-btn:active {
            transform: scale(0.95);
        }

        .gallery-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
            flex-shrink: 0;
        }

        .gallery-counter {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 8px 14px;
            border-radius: 18px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        .gallery-zoom-btn {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
            color: white;
            border: none;
            padding: 8px 14px;
            border-radius: 18px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
        }

        .gallery-zoom-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.5);
        }

        /* باقي العناصر */
        .info {
            width: 100%;
            text-align: center;
        }

        /* تم التعديل: جعل اسم المنتج يظهر باللون الأحمر */
        .info h3 {
            margin: 5px 0;
            font-size: 20px;
            color: #e74c3c !important; /* اللون الأحمر */
            font-weight: bold;
        }

        .product-price {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
            padding: 8px;
            background-color: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            width: 100%;
        }

        .product-details {
            margin: 10px 0;
            font-size: 14px;
            color: #666;
            text-align: right;
            width: 100%;
            direction: rtl;
            position: relative;
            max-height: none;
            overflow: visible;
        }

        .product-detail-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
        }

        .product-detail-item .label {
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 10px;
        }

        /* تحسينات لعرض بيانات التاجر */
        .merchant-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
            padding: 12px;
            background: linear-gradient(135deg, var(--light-color), #d5dbdb);
            border-radius: 10px;
            width: 100%;
            transition: var(--transition);
            border: 1px solid rgba(52, 152, 219, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .merchant-info:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            transform: translateY(-1px);
        }

        .merchant-name {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            color: var(--primary-color);
            font-weight: bold;
            transition: var(--transition);
            text-align: center;
            font-size: 16px;
            padding: 5px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.5);
        }

        .merchant-name:hover {
            color: var(--secondary-color);
            text-decoration: underline;
            background: rgba(255, 255, 255, 0.8);
        }

        /* قسم التعليقات */
        .comments-section {
            width: 100%;
            margin-top: 15px;
            display: none;
            background: var(--light-color);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid var(--primary-color);
            animation: slideDown 0.25s ease-out;
        }

        .comments-section.active {
            display: block;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                max-height: 0;
                padding: 0 15px;
            }
            to {
                opacity: 1;
                max-height: 500px;
                padding: 15px;
            }
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .comments-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .close-comments {
            background: none;
            border: none;
            color: var(--danger-color);
            font-size: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .close-comments:hover {
            color: #c0392b;
            transform: scale(1.1);
        }

        .comments-list {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--background-color);
            border-radius: 8px;
        }

        .comment-item {
            padding: 10px;
            margin-bottom: 10px;
            background: var(--light-color);
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: var(--transition);
        }

        .comment-item:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .comment-date {
            color: #666;
            font-size: 12px;
        }

        .comment-text {
            line-height: 1.6;
            font-size: 14px;
            color: var(--text-color);
            text-align: right;
            direction: rtl;
        }

        .add-comment {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .comment-form textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 14px;
            background: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
            text-align: right;
            direction: rtl;
        }

        .comment-form textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1);
        }

        .comment-form button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            align-self: flex-end;
            transition: var(--transition);
            font-size: 14px;
            font-weight: bold;
        }

        .comment-form button:hover {
            background: var(--secondary-color);
            transform: translateY(-1px);
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--primary-color);
        }

        .error {
            text-align: center;
            padding: 20px;
            color: var(--danger-color);
            background-color: #f8d7da;
            border-radius: 5px;
            margin: 20px;
        }

        .no-products {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 16px;
            grid-column: 1 / -1;
        }

        .no-comments {
            text-align: center;
            padding: 15px;
            color: #666;
            font-style: italic;
        }

        .category-value-display {
            display: none;
        }

        /* إشعارات */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 3000;
            animation: slideInDown 0.3s ease;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        /* ==========================================
           🎯 أزرار الإجراءات - التنسيقات المعدلة
           ========================================== */

        /* شريط الأزرار الجديد - تم تعديله بالكامل */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin: 15px 0;
            padding: 12px;
            background: var(--light-color);
            border-radius: 12px;
            gap: 10px;
        }

        .stats-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            flex: 1;
        }

        /* التنسيقات الجديدة للإحصائيات فوق الأزرار */
        .stat-with-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 60px;
        }

        .stat-number {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            background: rgba(255, 255, 255, 0.9);
            padding: 3px 8px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            min-width: 35px;
            text-align: center;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .like-stat {
            color: var(--danger-color);
        }

        .view-stat {
            color: var(--primary-color);
        }

        .comment-stat {
            color: var(--success-color);
        }

        /* أزرار الإجراءات - التصميم الموحد */
        .action-button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .action-button:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-like {
            color: var(--danger-color);
        }

        .btn-comment {
            color: var(--success-color);
        }

        .btn-view {
            color: var(--primary-color);
        }

        /* زر المفضلة - تم توحيد المقاسات */
        .favorite-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: var(--transition);
            color: #f39c12;
            font-size: 18px;
            position: relative;
            box-shadow: 0 3px 10px rgba(243, 156, 18, 0.3);
        }

        .favorite-btn.active {
            color: var(--danger-color);
            background: rgba(255, 255, 255, 1);
        }

        .favorite-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        /* زر المشاركة - تم توحيد المقاسات */
        .share-button {
            background: rgba(255, 255, 255, 0.9);
            color: var(--warning-color);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        .share-button:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        /* نافذة المشاركة */
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .share-modal.active {
            display: flex;
        }

        .share-modal-content {
            background: var(--background-color);
            border-radius: 15px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .share-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-color);
        }

        .share-modal-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .share-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--danger-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .share-modal-close:hover {
            transform: scale(1.1);
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px 10px;
            border-radius: 10px;
            background: var(--light-color);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        .share-option:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border-color: var(--primary-color);
        }

        .share-option i {
            font-size: 24px;
            color: var(--primary-color);
        }

        .share-option span {
            font-size: 14px;
            font-weight: bold;
            color: var(--text-color);
        }

        .share-whatsapp {
            background: linear-gradient(135deg, #25D366, #128C7E);
            color: white;
        }

        .share-whatsapp i {
            color: white;
        }

        .share-whatsapp span {
            color: white;
        }

        .share-facebook {
            background: linear-gradient(135deg, #4267B2, #365899);
            color: white;
        }

        .share-facebook i {
            color: white;
        }

        .share-facebook span {
            color: white;
        }

        .share-twitter {
            background: linear-gradient(135deg, #1DA1F2, #1A91DA);
            color: white;
        }

        .share-twitter i {
            color: white;
        }

        .share-twitter span {
            color: white;
        }

        .share-telegram {
            background: linear-gradient(135deg, #0088cc, #0077b5);
            color: white;
        }

        .share-telegram i {
            color: white;
        }

        .share-telegram span {
            color: white;
        }

        .share-link {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .share-link i {
            color: white;
        }

        .share-link span {
            color: white;
        }

        .share-other {
            background: linear-gradient(135deg, var(--warning-color), #e67e22);
            color: white;
        }

        .share-other i {
            color: white;
        }

        .share-other span {
            color: white;
        }

        /* تحسينات للأجهزة المحمولة */
        @media (max-width: 1024px) {
            .gallery-main-image-container {
                min-height: 50vh;
            }
        }

        @media (max-width: 768px) {
            body { padding-top: 128px; padding-bottom: 40px; }
            .filter-bar { top: 128px; padding: 8px 10px; }
            .filter-item { flex: 1 0 100%; }
            .filter-item input { width: 100%; }
            .products { grid-template-columns: 1fr; }
            .images-preview img, .slider-image { height: 250px; }
            .image-slider { height: 250px; }
            .product-price { font-size: 18px; }
            .comments-list { max-height: 200px; }

            .gallery-container {
                width: 100%;
                height: 100%;
                padding: 15px;
            }

            .gallery-main-content {
                flex-direction: column;
                gap: 12px;
            }

            .gallery-thumbnails {
                flex-direction: row;
                overflow-x: auto;
                overflow-y: hidden;
                max-height: 100px;
            }

            .gallery-thumbnail {
                min-width: 90px;
                height: 70px;
            }

            .gallery-title {
                font-size: 18px;
            }

            .gallery-nav-btn {
                width: 50px;
                height: 50px;
                font-size: 20px;
            }

            .gallery-main-image-container {
                min-height: 50vh;
            }

            .brand {
                align-items: center;
            }
            
            .brand-title {
                font-size: 16px;
            }
            
            .brand-subtitle {
                font-size: 11px;
            }

            /* تعديل موقع أزرار التحكم لتكون في يمين الشاشة */
            .scroll-to-top, .filter-control {
                bottom: auto;
                right: 20px;
                left: auto;
                transform: none;
                width: 45px;
                height: 45px;
            }

            .scroll-to-top {
                bottom: 60px;
            }

            .filter-control {
                bottom: 120px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .stats-buttons {
                justify-content: space-around;
                width: 100%;
                gap: 10px;
            }
            
            .stat-with-button {
                min-width: 55px;
            }
            
            .action-button, .share-button, .favorite-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .stat-number {
                font-size: 12px;
                min-width: 30px;
                height: 20px;
            }

            .header-online-users {
                font-size: 12px;
                padding: 4px 8px;
            }

            .header-login {
                font-size: 12px;
                padding: 4px 8px;
            }

            .secondary-bar {
                padding: 6px 10px;
            }

            .secondary-bar-left, .secondary-bar-right {
                gap: 8px;
            }

            .secondary-category select {
                min-width: 120px;
                font-size: 12px;
            }

            .products-count {
                font-size: 12px;
            }

            .online-users-real {
                font-size: 12px;
                padding: 4px 8px;
            }

            .show-more-btn {
                font-size: 12px;
                padding: 4px 8px;
            }

            .secondary-favorites {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }

            /* تعديلات الفوتر على الجوال */
            .footer {
                height: 40px;
            }
            
            .footer-text {
                font-size: 14px;
                padding: 6px 12px;
                min-height: 30px;
            }

            /* تعديلات نافذة المشاركة على الجوال */
            .share-options {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 480px) {
            .images-preview img, .slider-image { 
                width: 100%;
                height: 250px; 
            }
            .image-slider { 
                width: 100%;
                height: 250px; 
            }

            .gallery-nav-btn {
                width: 45px;
                height: 45px;
                font-size: 18px;
            }

            .gallery-main-image {
                max-width: 100%;
                max-height: 100%;
            }

            .brand-logo {
                width: 40px;
                height: 40px;
            }
            
            .action-buttons {
                padding: 8px;
                gap: 10px;
            }
            
            .stats-buttons {
                gap: 8px;
            }
            
            .stat-with-button {
                min-width: 50px;
            }
            
            .action-button, .share-button, .favorite-btn {
                width: 38px;
                height: 38px;
                font-size: 15px;
            }

            .stat-number {
                font-size: 11px;
                min-width: 28px;
                height: 18px;
            }

            .header-online-users {
                font-size: 11px;
                padding: 3px 6px;
            }

            .header-login {
                font-size: 11px;
                padding: 3px 6px;
            }

            .secondary-bar {
                padding: 4px 8px;
            }

            .secondary-bar-left, .secondary-bar-right {
                gap: 6px;
            }

            .secondary-category {
                flex-direction: column;
                gap: 3px;
            }

            .secondary-category label {
                font-size: 11px;
            }

            .secondary-category select {
                min-width: 100px;
                font-size: 11px;
                padding: 4px 6px;
            }

            .products-count {
                font-size: 11px;
            }

            .online-users-real {
                font-size: 11px;
                padding: 3px 6px;
            }

            .show-more-btn {
                font-size: 11px;
                padding: 3px 6px;
            }

            .secondary-favorites {
                width: 28px;
                height: 28px;
                font-size: 11px;
            }

            /* تعديلات الفوتر على الجوال الصغير */
            .footer {
                height: 35px;
                padding: 5px 10px;
            }
            
            .footer-text {
                font-size: 12px;
                padding: 5px 10px;
                min-height: 25px;
            }

            /* تعديلات شارة العرض على الجوال الصغير */
            .offer-dates {
                font-size: 10px;
                max-width: 150px;
                padding: 4px 8px;
            }
        }
    </style>
</head>
<body>
    <!-- شاشة التحميل - مخفية -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">جاري تحميل البيانات...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loading-progress-bar"></div>
        </div>
    </div>

    <!-- الهيدر -->
    <header class="header">
        <div class="header-content">
            <!-- الشعار والعنوان في أقصى اليسار -->
            <div class="brand">
                <img src="https://raw.githubusercontent.com/e772299420-hue/Call/main/icon-512x5122.png" alt="شعار AZ" class="brand-logo">
                <div class="brand-text">
                    <div class="brand-title">AZ السوق الشامل</div>
                    <div class="brand-subtitle">لتلبية احتياجك بالكامل</div>
                </div>
            </div>

            <!-- زر تسجيل الدخول وعدد المتصلين في أقصى اليمين -->
            <div class="header-right">
                <!-- زر تسجيل الدخول الجديد - تم تعديل موقعه ليصبح فوق عدد المتصلين -->
                <a href="manjr_tagr_snf.html" class="header-login" title="تسجيل الدخول">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </a>
                
                <!-- عدد المتصلين في الشريط العلوي - تم تعديل موقعه ليصبح تحت زر تسجيل الدخول -->
                <div class="header-online-users" id="header-online-users">
                    <i class="fas fa-users"></i>
                    <span id="header-users-count">0</span> متصل الآن
                </div>
            </div>
        </div>
    </header>

    <!-- الشريط الجديد أسفل الشريط العلوي -->
    <div class="secondary-bar">
        <div class="secondary-bar-content">
            <div class="secondary-bar-left">
                <!-- حقل القسم في الشريط الجديد - تم نقله من الشريط العلوي -->
                <div class="secondary-category">
                   
                    <div class="category-search-container">
                        <select id="secondary-category-select">
                            <option value="">جميع الأقسام</option>
                        </select>
                    </div>
                </div>

                <!-- عدد المنتجات - تم تعديل النص والإضافة -->
                <div class="products-count">
                    <i class="fas fa-box"></i>
                    <span id="products-count"> : 0</span>
                </div>

                <!-- عدد المتصلين الحقيقي - تم إضافته وتصغيره -->
               
                    <span id="real-online-users">0</span>
                </div>
            </div>

            <div class="secondary-bar-right">
                <!-- زر عرض أكثر -->
                <button class="show-more-btn" id="show-more-btn">
                    <i class="fas fa-bars"></i>
                    عرض أكثر
                </button>

                <!-- زر المفضلة في الشريط الجديد - تم نقله من الشريط العلوي -->
                <button class="secondary-favorites" id="secondary-favorites" title="عرض المفضلة">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- شريط الفلاتر - مخفي افتراضياً -->
    <div class="filter-bar" id="filter-bar">
        <div class="filter-item">
            <label for="governorate">المحافظة:</label>
            <select id="governorate"><option value="">جميع المحافظات</option></select>
        </div>
        <div class="filter-item">
            <label for="region">المنطقة:</label>
            <select id="region"><option value="">جميع المناطق</option></select>
        </div>
        <div class="filter-item">
            <label for="merchant">التاجر:</label>
            <select id="merchant"><option value="">جميع التجار</option></select>
        </div>
        <div class="filter-item">
            <label for="category">القسم:</label>
            <select id="category"><option value="">جميع الأقسام</option></select>
            <span class="category-value-display" id="category-value-display"></span>
        </div>
        <div class="filter-item">
            <label for="search">بحث:</label>
            <div class="search-container">
                <input type="text" id="search" placeholder="ابحث عن منتج...">
                <button class="voice-search-btn" id="voice-search-btn" title="البحث الصوتي">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
        <div class="filter-item">
            <label for="sort-by">ترتيب:</label>
            <select id="sort-by">
                <option value="date">التاريخ (الأحدث أولاً)</option>
                <option value="name">الاسم</option>
                <option value="category">القسم</option>
                <option value="price">السعر</option>
                <option value="merchant">التاجر</option>
                <option value="preference">رغبتي</option>
                <option value="offers">العروض</option>
            </select>
        </div>
        <button class="reset-btn" id="reset-filters" title="إعادة تعيين جميع الفلاتر">
            <i class="fas fa-redo"></i>
            <span class="tooltip">إعادة تعيين جميع الفلاتر</span>
        </button>
    </div>

    <!-- زر العودة للأعلى - تم تعديل الموقع -->
    <button class="scroll-to-top" id="scroll-to-top" title="العودة للأعلى">
        <i class="fas fa-chevron-up"></i>
    </button>

    <!-- زر تحكم الشريط - تم تعديل الموقع -->
    <button class="filter-control" id="filter-control" title="إظهار/إخفاء شريط الفلاتر">
        <i class="fas fa-sliders-h"></i>
    </button>

    <!-- المحتوى -->
    <div class="page-content">
        <div id="products-container">
            <div class="loading">جاري تحميل البيانات...</div>
        </div>
    </div>

    <!-- معرض الصور المحسن -->
    <div class="image-gallery" id="image-gallery">
        <div class="gallery-container">
            <div class="gallery-header">
                <div class="gallery-title">
                    <i class="fas fa-images"></i>
                    <span id="gallery-product-name">معرض الصور</span>
                </div>
                <button class="gallery-close" id="gallery-close">×</button>
            </div>

            <div class="gallery-main-content">
                <div class="gallery-main-image-container">
                    <img id="gallery-main-image" class="gallery-main-image" alt="صورة المنتج" decoding="async" fetchpriority="high">
                </div>

                <div class="gallery-thumbnails" id="gallery-thumbnails">
                    <!-- الصور المصغرة ستُدرج هنا -->
                </div>
            </div>

            <!-- أزرار التنقل في الأسفل كما طلب المستخدم -->
            <div class="gallery-bottom-navigation">
                <button class="gallery-nav-btn" id="gallery-prev" title="الصورة السابقة">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="gallery-counter" id="gallery-counter">1 من 1</div>
                <button class="gallery-nav-btn" id="gallery-next" title="الصورة التالية">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>

            <div class="gallery-info">
                <button class="gallery-zoom-btn" id="gallery-zoom">
                    <i class="fas fa-search-plus"></i>
                    تكبير/تصغير
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة المشاركة -->
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-header">
                <div class="share-modal-title">مشاركة المنتج</div>
                <button class="share-modal-close" id="share-modal-close">×</button>
            </div>
            <div class="share-options">
                <div class="share-option share-whatsapp" data-platform="whatsapp">
                    <i class="fab fa-whatsapp"></i>
                    <span>واتساب</span>
                </div>
                <div class="share-option share-facebook" data-platform="facebook">
                    <i class="fab fa-facebook"></i>
                    <span>فيسبوك</span>
                </div>
                <div class="share-option share-twitter" data-platform="twitter">
                    <i class="fab fa-twitter"></i>
                    <span>تويتر</span>
                </div>
                <div class="share-option share-telegram" data-platform="telegram">
                    <i class="fab fa-telegram"></i>
                    <span>تيليجرام</span>
                </div>
                <div class="share-option share-link" data-platform="copy">
                    <i class="fas fa-link"></i>
                    <span>نسخ الرابط</span>
                </div>
                <div class="share-option share-other" data-platform="other">
                    <i class="fas fa-share-alt"></i>
                    <span>تطبيقات أخرى</span>
                </div>
            </div>
        </div>
    </div>

    <!-- الفوتر مع الإعلانات النصية - تم التعديل -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-text" id="footer-text">
                جميع الحقوق محفوظة لدى المميز سوفت للأنظمة المحاسبية المتكاملة
            </div>
            <!-- تم إخفاء عدد المتصلين من الفوتر -->
            <div class="online-users" id="online-users" style="display: none;">
                <i class="fas fa-users"></i>
                <span id="users-count">0</span> موجد الآن
            </div>
        </div>
    </footer>

    <script>
        // ==========================================
        // 🔥 إصلاح مشكلة عرض الصور من جوجل درايف
        // ==========================================
        
        // تهيئة Firebase
        const firebaseConfig = { 
            databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/" 
        };
        
        // تهيئة Firebase أولاً قبل أي شيء آخر
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log('✅ Firebase initialized successfully');
            }
        } catch (error) {
            console.error("❌ خطأ في تهيئة Firebase:", error);
        }
        
        const db = firebase.database();

        // متغيرات التطبيق
        let allProducts = [];
        let allMerchants = [];
        let allGovernorates = [];
        let allRegions = [];
        let allCategories = [];
        let favoriteProducts = JSON.parse(localStorage.getItem('favoriteProducts')) || {};
        let userInterests = JSON.parse(localStorage.getItem('userInterests')) || {};
        let showFavoritesOnly = false;
        let isCommentsOpen = false;
        
        // متغيرات نظام تتبع المستخدمين المتصلين
        let currentUserId = null;
        let onlineUsersRef = null;
        let userPresenceRef = null;
        let connectedRef = null;

        // متغيرات معرض الصور
        let galleryImages = [];
        let currentGalleryIndex = 0;
        let isImageZoomed = false;

        // متغيرات التعرف الصوتي
        let recognition = null;
        let isListening = false;

        // متغيرات الإعلانات النصية
        let advertisementTexts = [];
        let currentAdIndex = 0;
        let adInterval = null;
        let currentAnimation = null;

        // ==========================================
        // 🔄 نظام العداد العشوائي للمتصلين والمشاهدات
        // ==========================================
        
        // متغيرات عداد المتصلين العشوائي
        let onlineUsersCount = 0;
        let onlineUsersInterval = null;
        let onlineUsersDirection = 1; // 1 للزيادة, -1 للنقصان
        let consecutiveChanges = 0;
        
        // متغيرات عداد المشاهدات التلقائي
        let autoViewInterval = null;
        
        // ==========================================
        // 🔧 نظام تتبع الإجراءات المحسّن - الإصلاحات الجديدة
        // ==========================================
        
        // تخزين إجراءات المستخدم الدائمة
        let userActions = JSON.parse(localStorage.getItem('userActions')) || {
            likes: {},
            views: {},
            comments: {}
        };

        // ==========================================
        // ❤️ نظام الإعجابات والتعليقات التلقائية
        // ==========================================
        let autoLikeInterval = null;
        let autoCommentInterval = null;
        let commentTexts = [
            "منتج رائع! أنصح به بشدة",
            "جودة ممتازة وسعر مناسب",
            "اشتريت هذا المنتج وكان تجربة رائعة",
            "أنصح الجميع بهذا المنتج",
            "سعر معقول وجودة ممتازة",
            "منتج يستحق التجربة",
            " شباب من صلى على النبي اليوم",
            "تجربة شراء ناجحة وممتازة",
            "أنصح بهذا المنتج لكل الأصدقاء",
            "جودة تفوق التوقعات",
            "سعر مناسب وجودة عالية",
            "منتج مميز وأنصح به",
            "  جميل لقد اعجبني",
            "تجربة شراء رائعة",
            "منتج يستحق كل ريال",
            "جودة وسعر لا يصدق",
            "أنصح بهذا المنتج بشدة",
            "تجاوز توقعاتي بكثير",
            "منتج رائع ومميز"
        ];

        // عناصر الواجهة
        const productsContainer = document.getElementById('products-container');
        const governorateSelect = document.getElementById('governorate');
        const regionSelect = document.getElementById('region');
        const categorySelect = document.getElementById('category');
        const merchantSelect = document.getElementById('merchant');
        const searchInput = document.getElementById('search');
        const resetButton = document.getElementById('reset-filters');
        const sortSelect = document.getElementById('sort-by');
        const filterBar = document.getElementById('filter-bar');
        const scrollToTopBtn = document.getElementById('scroll-to-top');
        const filterControlBtn = document.getElementById('filter-control');
        const categoryValueDisplay = document.getElementById('category-value-display');
        const usersCountEl = document.getElementById('users-count');
        const headerUsersCountEl = document.getElementById('header-users-count');
        const realOnlineUsersEl = document.getElementById('real-online-users');
        const voiceSearchBtn = document.getElementById('voice-search-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingProgressBar = document.getElementById('loading-progress-bar');
        const footerTextEl = document.getElementById('footer-text');

        // عناصر الشريط الجديد
        const secondaryCategorySelect = document.getElementById('secondary-category-select');
        const productsCountEl = document.getElementById('products-count');
        const showMoreBtn = document.getElementById('show-more-btn');
        const secondaryFavoritesBtn = document.getElementById('secondary-favorites');

        // عناصر نافذة المشاركة
        const shareModal = document.getElementById('share-modal');
        const shareModalClose = document.getElementById('share-modal-close');
        const shareOptions = document.querySelectorAll('.share-option');

        // ==========================================
        // 🎯 بدء التطبيق - الترتيب الصحيح
        // ==========================================

        // بدء التطبيق فور تحميل الصفحة
        document.addEventListener('DOMContentLoaded', () => {
            console.log('🏁 بدء تحميل التطبيق...');
            
            // 1. تهيئة معرف المستخدم المستقر أولاً
            initializeStableUserId();
            
            // 2. بدء نظام العداد العشوائي للمتصلين
            startRandomOnlineUsers();
            
            // 3. بدء نظام زيادة المشاهدات التلقائي
            startAutoViewIncrement();
            
            // 4. تهيئة نظام تتبع المستخدمين المتصلين
            initializeUserPresence();
            
            // 5. تهيئة التعرف الصوتي
            initializeSpeechRecognition();
            
            // 6. تهيئة التطبيق
            initializeApp();
            
            // 7. إعداد مستمعي الأحداث
            setupEventListeners();
            
            // 8. تحميل البيانات
            loadAllData().then(() => {
                checkUrlForProduct();
                displayPersonalizedProducts();
                console.log('🎉 تم تحميل التطبيق بالكامل بنجاح');
            }).catch(error => {
                console.error('❌ خطأ في تحميل البيانات:', error);
            });
            
            // 9. بدء تحديث المنتجات الجديدة تلقائياً
            startAutoUpdate();
            
            // 10. تحميل وعرض الإعلانات النصية
            loadAdvertisementTexts();
            
            // 11. بدء نظام الإعجابات والتعليقات التلقائية
            startAutoInteractions();
        });

        // ==========================================
        // 🎯 وظيفة التحقق من صحة العرض
        // ==========================================
        function isOfferValid(product) {
            // إذا كان نوع المنتج ليس "عرض" فلا نعرض شارة العرض
            if (!product.productType || product.productType !== 'عرض') {
                return false;
            }
            
            const today = new Date();
            
            // إذا كان هناك تاريخ انتهاء وتاريخ اليوم أكبر من تاريخ الانتهاء، العرض غير صالح
            if (product.endDate) {
                const endDate = new Date(product.endDate);
                if (today > endDate) {
                    return false;
                }
            }
            
            // إذا كان هناك تاريخ بدء وتاريخ اليوم أقل من تاريخ البدء، العرض لم يبدأ بعد
            if (product.startDate) {
                const startDate = new Date(product.startDate);
                if (today < startDate) {
                    return false;
                }
            }
            
            return true;
        }

        // ==========================================
        // ❤️ نظام الإعجابات والتعليقات التلقائية
        // ==========================================
        function startAutoInteractions() {
            // بدء الإعجابات التلقائية كل 8 ثواني
            autoLikeInterval = setInterval(() => {
                autoLikeRandomProduct();
            }, 8000);
            
            // بدء التعليقات التلقائية كل 30 دقيقة (1800000 مللي ثانية)
            autoCommentInterval = setInterval(() => {
                autoCommentRandomProduct();
            }, 1800000); // تغيير من 12000 إلى 1800000
        }

        function autoLikeRandomProduct() {
            if (allProducts.length === 0) return;
            
            // ترتيب المنتجات حسب الجدة (الأحدث أولاً)
            const sortedProducts = [...allProducts].sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                return bDate - aDate;
            });
            
            // التركيز على المنتجات الجديدة (70% للمنتجات الجديدة، 30% للمنتجات القديمة)
            let product;
            if (Math.random() < 0.7 && sortedProducts.length > 0) {
                // اختر من المنتجات الجديدة (الأولى في القائمة)
                const recentCount = Math.min(10, sortedProducts.length);
                const randomIndex = getRandomInt(0, recentCount - 1);
                product = sortedProducts[randomIndex];
            } else if (sortedProducts.length > 10) {
                // اختر من المنتجات القديمة
                const oldProducts = sortedProducts.slice(10);
                const randomIndex = getRandomInt(0, oldProducts.length - 1);
                product = oldProducts[randomIndex];
            } else {
                return;
            }
            
            if (!product || !product.id) return;
            
            // إضافة إعجاب عشوائي
            addAutoLike(product.id);
        }

        async function addAutoLike(productId) {
            try {
                const likesRef = db.ref(`products_stats/${productId}/likes`);
                const snapshot = await likesRef.once('value');
                let likes = snapshot.val() || [];
                if (!Array.isArray(likes)) likes = [];
                
                // إنشاء معرف مستخدم عشوائي للإعجاب
                const randomUserId = 'auto_user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                
                // التحقق من عدم وجود هذا المستخدم مسبقاً
                if (!likes.includes(randomUserId)) {
                    likes.push(randomUserId);
                    await likesRef.set(likes);
                    
                    // تحديث العداد في الواجهة إذا كان المنتج معروضاً
                    const likeStatEl = document.getElementById(`like-stat-${productId}`);
                    if (likeStatEl) {
                        likeStatEl.textContent = likes.length;
                    }
                    
                    console.log(`❤️ تم إضافة إعجاب تلقائي للمنتج ${productId}`);
                }
            } catch (e) { 
                console.error('خطأ في إضافة الإعجاب التلقائي:', e); 
            }
        }

        function autoCommentRandomProduct() {
            if (allProducts.length === 0) return;
            
            // ترتيب المنتجات حسب الجدة (الأحدث أولاً)
            const sortedProducts = [...allProducts].sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                return bDate - aDate;
            });
            
            // التركيز على المنتجات الجديدة (80% للمنتجات الجديدة، 20% للمنتجات القديمة)
            let product;
            if (Math.random() < 0.8 && sortedProducts.length > 0) {
                // اختر من المنتجات الجديدة (الأولى في القائمة)
                const recentCount = Math.min(5, sortedProducts.length);
                const randomIndex = getRandomInt(0, recentCount - 1);
                product = sortedProducts[randomIndex];
            } else if (sortedProducts.length > 5) {
                // اختر من المنتجات القديمة
                const oldProducts = sortedProducts.slice(5);
                const randomIndex = getRandomInt(0, oldProducts.length - 1);
                product = oldProducts[randomIndex];
            } else {
                return;
            }
            
            if (!product || !product.id) return;
            
            // إضافة تعليق عشوائي
            addAutoComment(product.id, product.name);
        }

        async function addAutoComment(productId, productName) {
            try {
                // اختيار تعليق عشوائي من القائمة
                const randomCommentIndex = getRandomInt(0, commentTexts.length - 1);
                let commentText = commentTexts[randomCommentIndex];
                
                // تخصيص التعليق حسب اسم المنتج إذا أمكن
                if (productName && productName.trim() !== '') {
                    // إضافة اسم المنتج إلى التعليق لجعله أكثر تخصيصاً
                    if (Math.random() < 0.5) {
                        commentText = commentText.replace("المنتج", `منتج ${productName}`);
                    }
                }
                
                // أسماء مستخدمين عشوائية
                const userNames = ["مستخدم", "مستخد جديد"];
                const randomUserName = userNames[getRandomInt(0, userNames.length - 1)];
                
                const commentId = Date.now().toString();
                const comment = { 
                    text: commentText, 
                    author: randomUserName, 
                    date: new Date().toISOString() 
                };
                
                await db.ref(`comments/${productId}/${commentId}`).set(comment);
                
                // تحديث العداد في الواجهة إذا كان المنتج معروضاً
                const commentStatEl = document.getElementById(`comment-stat-${productId}`);
                if (commentStatEl) {
                    commentStatEl.textContent = (parseInt(commentStatEl.textContent) || 0) + 1;
                }
                
                // تحديث عدد التعليقات في قسم التعليقات إذا كان مفتوحاً
                const commentsCountEl = document.querySelector(`#comments-${productId} .comments-count`);
                if (commentsCountEl) {
                    commentsCountEl.textContent = (parseInt(commentsCountEl.textContent) || 0) + 1;
                }
                
                console.log(`💬 تم إضافة تعليق تلقائي للمنتج ${productId}: ${commentText}`);
            } catch (e) {
                console.error('خطأ في إضافة التعليق التلقائي:', e);
            }
        }

        // ==========================================
        // 🔄 نظام العداد العشوائي للمتصلين
        // ==========================================
        function startRandomOnlineUsers() {
            // تحميل القيمة المحفوظة أو البدء بقيمة عشوائية بين 200 و 800
            const savedCount = localStorage.getItem('randomOnlineUsersCount');
            onlineUsersCount = savedCount ? parseInt(savedCount) : getRandomInt(200, 800);
            
            // تحديث العداد في الواجهة
            updateOnlineUsersCount(onlineUsersCount);
            
            // بدء التحديث كل 8 ثواني
            onlineUsersInterval = setInterval(() => {
                updateRandomOnlineUsers();
            }, 8000);
        }

        function updateRandomOnlineUsers() {
            const oldCount = onlineUsersCount;
            
            // تحديد إذا كان سنزيد أو ننقص (5-7 مرات زيادة ثم نقصان)
            if (consecutiveChanges >= getRandomInt(5, 7)) {
                onlineUsersDirection = -1;
                consecutiveChanges = 0;
            } else if (consecutiveChanges <= -getRandomInt(3, 5)) {
                onlineUsersDirection = 1;
                consecutiveChanges = 0;
            }
            
            // تحديد مقدار التغيير (1-8)
            const changeAmount = getRandomInt(1, 8) * onlineUsersDirection;
            
            // حساب القيمة الجديدة مع التأكد من بقائها بين 200 و 800
            let newCount = onlineUsersCount + changeAmount;
            newCount = Math.max(200, Math.min(800, newCount));
            
            // تحديث العداد
            onlineUsersCount = newCount;
            consecutiveChanges += onlineUsersDirection;
            
            // حفظ القيمة الجديدة في localStorage
            localStorage.setItem('randomOnlineUsersCount', onlineUsersCount.toString());
            
            // تحديث الواجهة مع تأثير الوميض
            updateOnlineUsersCount(onlineUsersCount, oldCount);
        }

        function updateOnlineUsersCount(newCount, oldCount = null) {
            const onlineUsersEl = document.getElementById('header-online-users');
            
            // إضافة تأثير الوميض بناءً على التغيير
            if (oldCount !== null) {
                if (newCount > oldCount) {
                    onlineUsersEl.classList.add('increase');
                    setTimeout(() => onlineUsersEl.classList.remove('increase'), 1000);
                } else if (newCount < oldCount) {
                    onlineUsersEl.classList.add('decrease');
                    setTimeout(() => onlineUsersEl.classList.remove('decrease'), 1000);
                }
            }
            
            // تحديث النص في جميع العناصر
            usersCountEl.textContent = newCount;
            headerUsersCountEl.textContent = newCount;
        }

        // ==========================================
        // 🔄 نظام زيادة المشاهدات التلقائي - تم التعديل
        // ==========================================
        function startAutoViewIncrement() {
            // بدء التحديث كل 3 ثواني
            autoViewInterval = setInterval(() => {
                incrementProductViews();
            }, 3000);
        }

        function incrementProductViews() {
            if (allProducts.length === 0) return;
            
            // ترتيب المنتجات حسب الجدة (الأحدث أولاً)
            const sortedProducts = [...allProducts].sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                return bDate - aDate;
            });
            
            // زيادة مشاهدات المنتجات الجديدة أولاً
            const recentProducts = sortedProducts.slice(0, Math.min(10, sortedProducts.length));
            const otherProducts = sortedProducts.slice(10);
            
            // 70% من المرات نزيد مشاهدات المنتجات الجديدة، 30% المنتجات القديمة
            let product;
            if (Math.random() < 0.7 && recentProducts.length > 0) {
                const randomIndex = getRandomInt(0, recentProducts.length - 1);
                product = recentProducts[randomIndex];
            } else if (otherProducts.length > 0) {
                const randomIndex = getRandomInt(0, otherProducts.length - 1);
                product = otherProducts[randomIndex];
            } else {
                return;
            }
            
            if (!product || !product.id) return;
            
            // زيادة عداد المشاهدات بمقدار 1-3
            const productId = product.id;
            const viewStatEl = document.getElementById(`view-stat-${productId}`);
            
            if (viewStatEl) {
                const increment = getRandomInt(1, 3);
                const currentViews = parseInt(viewStatEl.textContent) || 150;
                const newViews = currentViews + increment;
                viewStatEl.textContent = newViews;
                
                // تحديث في Firebase
                db.ref(`products_stats/${productId}/views`).transaction(current => (current || 0) + increment);
                
                console.log(`🔄 تم زيادة مشاهدات المنتج ${productId} إلى ${newViews}`);
            }
        }

        // ==========================================
        // 🔧 نظام معرف المستخدم المستقر - الإصلاح الجديد
        // ==========================================
        function initializeStableUserId() {
            // إنشاء معرف مستقر للمستخدم يبقى ثابتاً بين الجلسات
            let userId = localStorage.getItem('stableUserId');
            
            if (!userId) {
                // إنشاء معرف فريد ومستقر
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('stableUserId', userId);
                console.log('🆔 تم إنشاء معرف مستقر جديد للمستخدم:', userId);
            } else {
                console.log('🆔 تم تحميل معرف المستخدم المستقر:', userId);
            }
            
            currentUserId = userId;
            return userId;
        }

        // ==========================================
        // 👥 نظام تتبع المستخدمين المتصلين - تم الإصلاح بالكامل
        // ==========================================
        function initializeUserPresence() {
            // استخدام المعرف المستقر بدلاً من إنشاء جديد
            console.log('🆔 معرف المستخدم الحالي:', currentUserId);
            
            // إنشاء مرجع لبيانات المستخدم المتصل
            userPresenceRef = db.ref('online_users/' + currentUserId);
            onlineUsersRef = db.ref('online_users');
            connectedRef = db.ref('.info/connected');
            
            // تسجيل وقت دخول المستخدم
            const userVisitData = {
                userId: currentUserId,
                entryTime: new Date().toISOString(),
                userAgent: navigator.userAgent,
                screenResolution: `${screen.width}x${screen.height}`
            };
            
            // حفظ بيانات الزيارة
            db.ref('user_visits/' + currentUserId).set(userVisitData);
            
            // مراقبة حالة الاتصال
            connectedRef.on('value', function(snap) {
                if (snap.val() === true) {
                    // المستخدم متصل - إضافة/تحديث بياناته
                    userPresenceRef.onDisconnect().remove();
                    userPresenceRef.set({
                        id: currentUserId,
                        name: 'مستخدم ' + currentUserId.substring(0, 6),
                        lastOnline: firebase.database.ServerValue.TIMESTAMP,
                        joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        visitStart: new Date().toISOString()
                    });
                    
                    console.log('✅ تم تسجيل دخول المستخدم:', currentUserId);
                } else {
                    // المستخدم خرج - حفظ وقت الخروج
                    const exitTime = new Date().toISOString();
                    db.ref('user_visits/' + currentUserId).update({
                        exitTime: exitTime,
                        duration: Math.floor((new Date(exitTime) - new Date(userVisitData.entryTime)) / 1000) // المدة بالثواني
                    });
                }
            });

            // تحديث عدد المتصلين الحقيقي
            onlineUsersRef.on('value', (snapshot) => {
                const onlineUsers = snapshot.val();
                const realOnlineCount = onlineUsers ? Object.keys(onlineUsers).length : 0;
                document.getElementById('real-online-users').textContent = realOnlineCount;
                console.log('👥 عدد المتصلين الحقيقي:', realOnlineCount);
            });
        }

        // ==========================================
        // 📊 حفظ مصطلحات البحث غير الموجودة
        // ==========================================
        function saveSearchTermToAsnaf(term) {
            if (!term || term.trim().length === 0) return;
            
            // التحقق إذا كان المصطلح موجوداً في المنتجات
            const termExists = allProducts.some(product => {
                const productName = (product.name || '').toLowerCase();
                const productDesc = (product.description || '').toLowerCase();
                const searchTerm = term.toLowerCase();
                
                return productName.includes(searchTerm) || productDesc.includes(searchTerm);
            });
            
            // إذا لم يوجد المصطلح في المنتجات، نقوم بحفظه
            if (!termExists) {
                const searchData = {
                    term: term,
                    timestamp: new Date().toISOString(),
                    userId: currentUserId
                };
                
                db.ref('asnaf_slect/' + Date.now()).set(searchData)
                    .then(() => {
                        console.log('✅ تم حفظ مصطلح البحث في asnaf_slect:', term);
                    })
                    .catch(error => {
                        console.error('❌ خطأ في حفظ مصطلح البحث:', error);
                    });
            }
        }

        // ==========================================
        // 📢 نظام الإعلانات النصية - تم التعديل حسب الطلب
        // ==========================================
        async function loadAdvertisementTexts() {
            try {
                const adsSnapshot = await db.ref('اعلانات نصيه').once('value');
                const adsData = adsSnapshot.val();
                
                advertisementTexts = [];
                
                if (adsData) {
                    console.log('🔍 جاري فحص حقول الإعلانات:', Object.keys(adsData));
                    
                    // طريقة مرنة للبحث عن جميع الحقول الممكنة
                    const allFields = Object.keys(adsData);
                    
                    // تحميل جميع الحقول التي تحتوي على نصوص
                    allFields.forEach(fieldName => {
                        const adText = adsData[fieldName];
                        
                        if (adText && typeof adText === 'string' && adText.trim().length > 0) {
                            advertisementTexts.push(adText.trim());
                            console.log(`✅ تم تحميل الإعلان ${fieldName}: ${adText.trim()}`);
                        }
                    });
                    
                    console.log('📢 تم تحميل الإعلانات النصية:', advertisementTexts.length, 'إعلان');
                    
                    // بدء عرض الإعلانات إذا كان هناك نصوص
                    if (advertisementTexts.length > 0) {
                        startAdvertisementRotation();
                    } else {
                        // عرض نص افتراضي إذا لم توجد إعلانات
                        footerTextEl.textContent = 'جميع الحقوق محفوظة لدى المميز سوفت للأنظمة المحاسبية المتكاملة';
                        console.log('⚠️ لم يتم العثور على إعلانات نصية صالحة');
                    }
                } else {
                    console.log('⚠️ لا توجد بيانات إعلانات في قاعدة البيانات');
                    footerTextEl.textContent = 'جميع الحقوق محفوظة لدى المميز سوفت للأنظمة المحاسبية المتكاملة';
                }
            } catch (error) {
                console.error('❌ خطأ في تحميل الإعلانات النصية:', error);
                footerTextEl.textContent = 'جميع الحقوق محفوظة لدى المميز سوفت للأنظمة المحاسبية المتكاملة';
            }
        }

        function startAdvertisementRotation() {
            if (advertisementTexts.length === 0) return;
            
            currentAdIndex = 0;
            
            // عرض الإعلان الأول
            showNextAdvertisement();
        }

        function showNextAdvertisement() {
            if (advertisementTexts.length === 0) return;
            
            // الانتقال للإعلان التالي
            currentAdIndex = (currentAdIndex + 1) % advertisementTexts.length;
            const currentAd = advertisementTexts[currentAdIndex];
            
            // عرض الإعلان الحالي
            footerTextEl.textContent = currentAd;
            
            // الانتقال للإعلان التالي عند انتهاء الحركة
            setTimeout(() => {
                showNextAdvertisement();
            }, 15000); // 15 ثانية لكل إعلان
        }

        // ==========================================
        // 🎤 تهيئة نظام التعرف الصوتي - تم الإصلاح
        // ==========================================
        function initializeSpeechRecognition() {
            // التحقق من دعم المتصفح للتعرف الصوتي
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.warn('المتصفح لا يدعم التعرف الصوتي');
                voiceSearchBtn.style.display = 'none';
                return;
            }
            
            recognition = new SpeechRecognition();
            
            // إعدادات التعرف الصوتي
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'ar-SA'; // اللغة العربية للمملكة العربية السعودية
            
            // معالجة النتائج
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                if (transcript.trim().length > 0) {
                    searchInput.value = transcript;
                    filterProducts();
                    showNotification('تم تحويل الكلام إلى نص: ' + transcript, 'success');
                } else {
                    // إذا كان الصوت غير مفهوم
                    speakText('عفوا الصوت غير مفهوم اعد مره اخرى');
                    showNotification('عفوا الصوت غير مفهوم اعد مره اخرى', 'error');
                }
            };
            
            // معالجة الأخطاء
            recognition.onerror = function(event) {
                console.error('خطأ في التعرف الصوتي:', event.error);
                if (event.error === 'not-allowed') {
                    showNotification('يرجى السماح للموقع باستخدام الميكروفون', 'error');
                } else if (event.error === 'audio-capture') {
                    showNotification('لم يتم العثور على ميكروفون', 'error');
                } else if (event.error === 'no-speech') {
                    speakText('عفوا الصوت غير مفهوم اعد مره اخرى');
                    showNotification('عفوا الصوت غير مفهوم اعد مره اخرى', 'error');
                } else {
                    showNotification('حدث خطأ في التعرف الصوتي، يرجى المحاولة مرة أخرى', 'error');
                }
                stopListening();
            };
            
            // عند انتهاء التعرف
            recognition.onend = function() {
                stopListening();
            };
        }

        // ==========================================
        // 🎤 وظيفة النطق
        // ==========================================
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA';
                utterance.rate = 1;
                utterance.pitch = 1;
                window.speechSynthesis.speak(utterance);
            }
        }

        // ==========================================
        // 🎤 بدء/إيقاف التعرف الصوتي - تم الإصلاح
        // ==========================================
        function toggleVoiceSearch() {
            if (!recognition) {
                showNotification('المتصفح لا يدعم التعرف الصوتي', 'error');
                return;
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                startListening();
            }
        }

        function startListening() {
            try {
                recognition.start();
                isListening = true;
                voiceSearchBtn.classList.add('listening');
                voiceSearchBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                voiceSearchBtn.title = 'إيقاف التعرف الصوتي';
                showNotification('جاري الاستماع... تحدث الآن', 'info');
            } catch (error) {
                console.error('خطأ في بدء التعرف الصوتي:', error);
                showNotification('خطأ في بدء التعرف الصوتي. تأكد من السماح باستخدام الميكروفون', 'error');
                stopListening();
            }
        }

        function stopListening() {
            isListening = false;
            voiceSearchBtn.classList.remove('listening');
            voiceSearchBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceSearchBtn.title = 'البحث الصوتي';
        }

        function initializeApp() {
            // تطبيق السمة المحفوظة
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            
            // إخفاء شريط الفلاتر افتراضياً
            hideFilterBar();
        }

        function setupEventListeners() {
            // مستمعي الأحداث للفلاتر
            searchInput.addEventListener('input', filterProducts);
            governorateSelect.addEventListener('change', handleGovernorateChange);
            regionSelect.addEventListener('change', handleRegionChange);
            categorySelect.addEventListener('change', handleCategoryChange);
            merchantSelect.addEventListener('change', handleMerchantChange);
            sortSelect.addEventListener('change', filterProducts);
            resetButton.addEventListener('click', resetFilters);
            filterControlBtn.addEventListener('click', toggleFilterBar);
            
            // أحداث الشريط الجديد
            secondaryCategorySelect.addEventListener('change', handleSecondaryCategoryChange);
            showMoreBtn.addEventListener('click', toggleFilterBar);
            secondaryFavoritesBtn.addEventListener('click', toggleFavoritesView);

            // حدث البحث الصوتي
            voiceSearchBtn.addEventListener('click', toggleVoiceSearch);

            // إغلاق التعليقات عند النقر خارج البطاقة
            document.addEventListener('click', (e) => {
                if (isCommentsOpen && !e.target.closest('.comments-section') && 
                    !e.target.closest('.btn-comment') && !e.target.closest('.btn-comment-toggle')) {
                    closeAllComments();
                }
            });

            // ==========================================
            // 🚫 تم حذف الكود الخاص بإخفاء شريط الفلاتر عند النقر خارجها
            // ==========================================

            // مستمعي الأحداث لمعرض الصور - إصلاح مشكلة الخروج على الجوال
            document.addEventListener('keydown', (e) => {
                const gallery = document.getElementById('image-gallery');
                if (!gallery.classList.contains('active')) return;
                
                switch(e.key) {
                    case 'Escape':
                        closeImageGallery();
                        break;
                    case 'ArrowLeft':
                        navigateGallery(1);
                        break;
                    case 'ArrowRight':
                        navigateGallery(-1);
                        break;
                    case ' ':
                        e.preventDefault();
                        toggleImageZoom();
                        break;
                }
            });

            // إصلاح مشكلة إغلاق المعرض على الجوال
            document.getElementById('gallery-close').addEventListener('click', closeImageGallery);
            document.getElementById('gallery-prev').addEventListener('click', () => navigateGallery(-1));
            document.getElementById('gallery-next').addEventListener('click', () => navigateGallery(1));
            document.getElementById('gallery-zoom').addEventListener('click', toggleImageZoom);

            // إغلاق المعرض عند النقر خارج المحتوى - إصلاح مشكلة الجوال
            document.getElementById('image-gallery').addEventListener('click', (e) => {
                if (e.target.id === 'image-gallery') {
                    closeImageGallery();
                }
            });

            // النقر على الصورة الرئيسية للتكبير/التصغير
            const mainImage = document.getElementById('gallery-main-image');
            mainImage.addEventListener('click', toggleImageZoom);

            // حدث التمرير لزر العودة للأعلى
            window.addEventListener('scroll', handleScroll);
            scrollToTopBtn.addEventListener('click', scrollToTop);

            // أحداث نافذة المشاركة
            shareModalClose.addEventListener('click', closeShareModal);
            shareOptions.forEach(option => {
                option.addEventListener('click', handleShareOption);
            });
            shareModal.addEventListener('click', (e) => {
                if (e.target.id === 'share-modal') {
                    closeShareModal();
                }
            });
        }

        function handleScroll() {
            if (window.pageYOffset > 300) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function toggleFavoritesView() {
            showFavoritesOnly = !showFavoritesOnly;
            
            if (showFavoritesOnly) {
                displayFavoriteProducts();
                showNotification('عرض المنتجات المفضلة فقط', 'info');
            } else {
                // إغلاق شاشة عرض المفضلة والعودة للعرض العادي
                showFavoritesOnly = false;
                filterProducts();
                showNotification('عرض جميع المنتجات', 'info');
            }
        }

        function toggleFilterBar() {
            const isFilterBarHidden = localStorage.getItem('filterBarHidden');
            if (isFilterBarHidden === 'true') {
                showFilterBar();
                showNotification('تم إظهار شريط الفلاتر', 'success');
            } else {
                hideFilterBar();
                showNotification('تم إخفاء شريط الفلاتر', 'info');
            }
        }

        // فحص الرابط للمنتج المحدد
        function checkUrlForProduct() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('productId');
            if (productId) {
                setTimeout(() => {
                    highlightProduct(productId);
                }, 800);
            }
        }

        function highlightProduct(productId) {
            const productCard = document.getElementById(`product-${productId}`);
            if (!productCard) return;
            productCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            productCard.classList.add('highlighted');
            setTimeout(() => productCard.classList.remove('highlighted'), 6000);
        }

        // تحميل البيانات من Firebase - محسّن للأداء
        async function loadAllData() {
            try {
                // محاولة تحميل البيانات من التخزين المحلي أولاً
                const cachedData = loadCachedData();
                if (cachedData) {
                    allProducts = cachedData.products;
                    allMerchants = cachedData.merchants;
                    allGovernorates = cachedData.governorates;
                    allRegions = cachedData.regions;
                    allCategories = cachedData.categories;
                    
                    populateFilterOptions();
                    displayProducts(allProducts);
                }
                
                // تحميل البيانات من Firebase بشكل متوازي
                const [productsSnap, merchantsSnap, governoratesSnap, regionsSnap, categoriesSnap] = await Promise.all([
                    db.ref("products").once("value"),
                    db.ref("merchants").once("value"),
                    db.ref("governorates").once("value"),
                    db.ref("regions").once("value"),
                    db.ref("categories").once("value")
                ]);

                allProducts = convertFirebaseData(productsSnap.val()) || [];
                allMerchants = convertFirebaseData(merchantsSnap.val()) || [];
                allGovernorates = convertFirebaseData(governoratesSnap.val()) || [];
                allRegions = convertFirebaseData(regionsSnap.val()) || [];
                allCategories = convertFirebaseData(categoriesSnap.val()) || [];

                saveDataToCache();
                populateFilterOptions();
                displayProducts(allProducts);
                
            } catch (error) {
                console.error("خطأ في تحميل البيانات:", error);
                productsContainer.innerHTML = `
                    <div class="error">
                        <h3>حدث خطأ في تحميل البيانات</h3>
                        <p>${error.message || 'تعذر التحميل'}</p>
                        <p>يرجاء التحقق من اتصال الإنترنت وإعادة تحميل الصفحة</p>
                        <button onclick="location.reload()">إعادة تحميل</button>
                    </div>
                `;
            }
        }

        // تحميل البيانات من التخزين المحلي
        function loadCachedData() {
            try {
                const cachedProducts = localStorage.getItem('cachedProducts');
                const cachedMerchants = localStorage.getItem('cachedMerchants');
                const cachedGovernorates = localStorage.getItem('cachedGovernorates');
                const cachedRegions = localStorage.getItem('cachedRegions');
                const cachedCategories = localStorage.getItem('cachedCategories');
                
                if (cachedProducts && cachedMerchants && cachedGovernorates && cachedRegions && cachedCategories) {
                    return {
                        products: JSON.parse(cachedProducts),
                        merchants: JSON.parse(cachedMerchants),
                        governorates: JSON.parse(cachedGovernorates),
                        regions: JSON.parse(cachedRegions),
                        categories: JSON.parse(cachedCategories)
                    };
                }
            } catch (e) {
                console.warn('تعذر تحميل البيانات المخزنة محلياً', e);
            }
            return null;
        }

        function convertFirebaseData(firebaseData) {
            if (!firebaseData) return [];
            try {
                return Object.entries(firebaseData).map(([id, data]) => 
                    data && data.id ? ({ ...data }) : ({ id, ...data }));
            } catch (e) {
                console.error("خطأ في تحويل البيانات:", e);
                return [];
            }
        }

        function saveDataToCache() {
            try {
                localStorage.setItem('cachedProducts', JSON.stringify(allProducts));
                localStorage.setItem('cachedMerchants', JSON.stringify(allMerchants));
                localStorage.setItem('cachedGovernorates', JSON.stringify(allGovernorates));
                localStorage.setItem('cachedRegions', JSON.stringify(allRegions));
                localStorage.setItem('cachedCategories', JSON.stringify(allCategories));
                localStorage.setItem('lastCacheUpdate', Date.now().toString());
            } catch (e) { 
                console.warn('تعذر حفظ التخزين المحلي', e); 
            }
        }

        function populateFilterOptions() {
            // المحافظات
            governorateSelect.innerHTML = '<option value="">جميع المحافظات</option>';
            allGovernorates.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.id || g.name;
                opt.textContent = g.name || g.id;
                governorateSelect.appendChild(opt);
            });

            // التجار النشطون مع شرط الوظيفة "تاجر" - مرتبة أبجدياً
            updateMerchantOptions();

            // الأقسام (الفئات) - مرتبة حسب عدد المنتجات
            updateCategoryOptions();

            updateRegionOptions();
        }

        function updateMerchantOptions() {
            merchantSelect.innerHTML = '<option value="">جميع التجار</option>';
            
            // الحصول على المحافظة والمنطقة المحددة
            const selectedGovernorate = governorateSelect.value;
            const selectedRegion = regionSelect.value;
            
            // فلترة التجار بناءً على المحافظة والمنطقة المحددة
            let filteredMerchants = allMerchants.filter(m => {
                const isActive = m.status === "active" || m.status === "نشط";
                const isMerchant = m.job === "تاجر" || m.type === "تاجر";
                
                // إذا كانت هناك محافظة محددة، نتحقق من تطابق المحافظة
                if (selectedGovernorate) {
                    const merchantGovernorate = m.governorate || m.region;
                    if (merchantGovernorate !== selectedGovernorate) {
                        return false;
                    }
                }
                
                // إذا كانت هناك منطقة محددة، نتحقق من تطابق المنطقة
                if (selectedRegion) {
                    const merchantArea = m.area || m.city;
                    if (merchantArea !== selectedRegion) {
                        return false;
                    }
                }
                
                return isActive && isMerchant;
            });
            
            // إذا لم يكن هناك تجار بعد التصفية، نعرض جميع التجار
            if (filteredMerchants.length === 0 && (selectedGovernorate || selectedRegion)) {
                filteredMerchants = allMerchants.filter(m => {
                    const isActive = m.status === "active" || m.status === "نشط";
                    const isMerchant = m.job === "تاجر" || m.type === "تاجر";
                    return isActive && isMerchant;
                });
            }
            
            // ترتيب التجار أبجدياً
            filteredMerchants.sort((a, b) => {
                const nameA = (a.name || a.username || '').toLowerCase();
                const nameB = (b.name || b.username || '').toLowerCase();
                return nameA.localeCompare(nameB);
            });
            
            filteredMerchants.forEach(m => {
                const opt = document.createElement('option');
                opt.value = m.id || m.name;
                opt.textContent = m.name || m.username || m.id;
                merchantSelect.appendChild(opt);
            });
        }

        function updateRegionOptions() {
            const selectedGovernorate = governorateSelect.value;
            regionSelect.innerHTML = '<option value="">جميع المناطق</option>';

            if (selectedGovernorate) {
                const gov = allGovernorates.find(g => 
                    (g.id === selectedGovernorate) || (g.name === selectedGovernorate));
                if (gov && gov.areas) {
                    Object.entries(gov.areas).forEach(([areaId, areaName]) => {
                        const opt = document.createElement('option');
                        opt.value = areaId;
                        opt.textContent = areaName;
                        regionSelect.appendChild(opt);
                    });
                }
            } else {
                allRegions.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id || r.name;
                    opt.textContent = r.name || r.id;
                    regionSelect.appendChild(opt);
                });
            }
            
            // تحديث قائمة التجار بعد تغيير المحافظة أو المنطقة
            updateMerchantOptions();
        }

        function updateCategoryOptions() {
            categorySelect.innerHTML = '<option value="">جميع الأقسام</option>';
            secondaryCategorySelect.innerHTML = '<option value="">جميع الأقسام</option>';
            
            // حساب عدد المنتجات لكل قسم
            const categoryCounts = {};
            allProducts.forEach(product => {
                if (product.categoryId) {
                    categoryCounts[product.categoryId] = (categoryCounts[product.categoryId] || 0) + 1;
                }
            });
            
            // ترتيب الأقسام حسب عدد المنتجات (من الأكثر إلى الأقل)
            const sortedCategories = [...allCategories].sort((a, b) => {
                const countA = categoryCounts[a.id] || 0;
                const countB = categoryCounts[b.id] || 0;
                return countB - countA;
            });
            
            // إضافة جميع الأقسام مرتبة حسب عدد المنتجات
            sortedCategories.forEach(c => {
                const count = categoryCounts[c.id] || 0;
                
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                if (count > 0) {
                    const countSpan = document.createElement('span');
                    countSpan.className = 'category-count';
                    countSpan.textContent = count;
                    opt.appendChild(countSpan);
                }
                categorySelect.appendChild(opt);
                
                const secondaryOpt = document.createElement('option');
                secondaryOpt.value = c.id;
                secondaryOpt.textContent = c.name;
                if (count > 0) {
                    const countSpan = document.createElement('span');
                    countSpan.className = 'category-count';
                    countSpan.textContent = count;
                    secondaryOpt.appendChild(countSpan);
                }
                secondaryCategorySelect.appendChild(secondaryOpt);
            });
        }

        function handleGovernorateChange() { 
            updateRegionOptions(); 
            filterProducts(); 
        }

        function handleRegionChange() { 
            updateMerchantOptions();
            filterProducts(); 
        }

        function handleMerchantChange() { 
            filterProducts(); 
        }

        function handleCategoryChange() { 
            currentCategoryFilter = categorySelect.value;
            // مزامنة القائمة المنسدلة في الشريط الجديد
            secondaryCategorySelect.value = currentCategoryFilter;
            filterProducts(); 
        }

        // ==========================================
        // 🔄 معالجة تغيير القائمة المنسدلة في الشريط الجديد
        // ==========================================
        function handleSecondaryCategoryChange() {
            currentCategoryFilter = secondaryCategorySelect.value;
            // مزامنة القائمة المنسدلة في شريط الفلاتر
            categorySelect.value = currentCategoryFilter;
            filterProducts();
        }

        function displayProducts(products) {
            if (showFavoritesOnly) {
                displayFavoriteProducts();
                return;
            }
            
            productsContainer.innerHTML = '';
            
            // ==========================================
            // 🎯 فلترة المنتجات لإخفاء العروض المنتهية
            // ==========================================
            const filteredProducts = products.filter(product => {
                // إذا كان المنتج من نوع "عرض" ولم يعد صالحاً، نخفيه
                if (product.productType === 'عرض' && !isOfferValid(product)) {
                    return false;
                }
                return true;
            });
            
            if (!filteredProducts || filteredProducts.length === 0) {
                productsContainer.innerHTML = `
                    <div class="no-products">
                        <p>لا توجد منتجات متاحة حالياً</p>
                        <p>المنتجات الإجمالية: ${allProducts.length}</p>
                        <p>التجار النشطين: ${allMerchants.filter(m => (m.status === "active" || m.status === "نشط") && (m.job === "تاجر" || m.type === "تاجر")).length}</p>
                        <div style="margin-top:15px; text-align:center;">
                            <p style="color:#e74c3c; font-weight:bold; margin-bottom:10px;">لا توجد أي منتجات للعرض حالياً</p>
                            <button onclick="resetFilters()" style="padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:16px;">موافق - إعادة تعيين الفلاتر</button>
                        </div>
                    </div>
                `;
                return;
            }

            // تحديث عدد المنتجات في الشريط الجديد
            productsCountEl.textContent = ` ${filteredProducts.length}`;

            // ترتيب المنتجات حسب الأولوية الجديدة
            const sorted = sortProductsByPriority(filteredProducts);

            // تجميع المنتجات حسب الفئة
            const groupedProducts = groupProductsByCategory(sorted);

            displayGroupedProducts(groupedProducts);
        }

        // ==========================================
        // 🗂️ تجميع المنتجات حسب الفئة
        // ==========================================
        function groupProductsByCategory(products) {
            const groups = {};
            
            products.forEach(p => {
                const merchant = allMerchants.find(m => m.id === p.userId);
                if (!merchant) return;
                
                // التحقق من أن التاجر نشط ووظيفته "تاجر"
                const isActive = merchant.status === "active" || merchant.status === "نشط";
                const isMerchant = merchant.job === "تاجر" || merchant.type === "تاجر";
                
                if (!isActive || !isMerchant) return;
                
                const categoryId = p.categoryId || 'غير مصنف';
                const categoryName = p.categoryId ? 
                    (allCategories.find(c => c.id === p.categoryId)?.name || 'غير مصنف') : 'غير مصنف';
                
                if (!groups[categoryId]) {
                    groups[categoryId] = {
                        name: categoryName,
                        products: []
                    };
                }
                
                groups[categoryId].products.push(p);
            });
            
            return groups;
        }

        // ==========================================
        // 🗂️ عرض المنتجات المجمعة حسب الفئة
        // ==========================================
        function displayGroupedProducts(groupedProducts) {
            const grid = document.createElement('div');
            grid.className = 'products';

            // عرض كل مجموعة فئة
            Object.keys(groupedProducts).forEach(categoryId => {
                const group = groupedProducts[categoryId];
                
                // إنشاء حاوية الصنف
                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'category-container';
                categoryContainer.id = `category-${categoryId}`;
                
                // رأس الصنف
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = group.name;
                
                const categoryCount = document.createElement('div');
                categoryCount.className = 'category-count';
                categoryCount.textContent = `${group.products.length} منتج`;
                
                categoryHeader.appendChild(categoryTitle);
                categoryHeader.appendChild(categoryCount);
                categoryContainer.appendChild(categoryHeader);
                
                // عرض منتجات الفئة
                group.products.forEach(p => {
                    const merchant = allMerchants.find(m => m.id === p.userId);
                    if (!merchant) return;
                    
                    const card = createProductCard(p, merchant);
                    categoryContainer.appendChild(card);
                });
                
                grid.appendChild(categoryContainer);
            });

            if (grid.children.length === 0) {
                productsContainer.innerHTML = `
                    <div class="no-products">
                        <p>لا توجد منتجات تطابق معايير البحث</p>
                        <div style="margin-top:15px; text-align:center;">
                            <p style="color:#e74c3c; font-weight:bold; margin-bottom:10px;">لا توجد أي منتجات للعرض حالياً</p>
                            <button onclick="resetFilters()" style="padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:16px;">موافق - عرض جميع المنتجات</button>
                        </div>
                    </div>
                `;
            } else {
                productsContainer.appendChild(grid);
            }
        }

        // ==========================================
        // 🚀 نظام ترتيب المنتجات الجديد - تم التعديل حسب الطلب
        // ==========================================
        function sortProductsByPriority(products) {
            const sortBy = sortSelect.value;
            
            // إذا كان هناك خيار ترتيب محدد من المستخدم، نستخدمه مع إضافة التاريخ كمعيار ثانوي
            if (sortBy && sortBy !== 'date' && sortBy !== 'preference' && sortBy !== 'offers') {
                return sortProductsByOption(products, sortBy);
            }
            
            // إذا كان الخيار هو "رغبتي" - نستخدم العرض الذكي فقط هنا
            if (sortBy === 'preference') {
                return sortProductsByPreference(products);
            }
            
            // إذا كان الخيار هو "العروض" - نرتب العروض أولاً
            if (sortBy === 'offers') {
                return sortProductsByOffers(products);
            }
            
            // وإلا نستخدم الترتيب العادي حسب التاريخ (الأحدث أولاً)
            return [...products].sort((a, b) => {
                // المنتجات الأحدث تأتي أولاً
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                
                return bDate - aDate;
            });
        }

        // دالة الترتيب حسب خيارات المستخدم مع إضافة التاريخ كمعيار ثانوي
        function sortProductsByOption(products, sortBy) {
            return [...products].sort((a, b) => {
                let result = 0;
                
                switch(sortBy) {
                    case 'name':
                        const nameA = (a.name || '').toLowerCase();
                        const nameB = (b.name || '').toLowerCase();
                        result = nameA.localeCompare(nameB);
                        break;
                    
                    case 'category':
                        const categoryA = getCategoryName(a.categoryId) || '';
                        const categoryB = getCategoryName(b.categoryId) || '';
                        result = categoryA.localeCompare(categoryB);
                        break;
                    
                    case 'price':
                        const priceA = parseFloat(a.price) || 0;
                        const priceB = parseFloat(b.price) || 0;
                        result = priceA - priceB;
                        break;
                    
                    case 'merchant':
                        const merchantA = getMerchantName(a.userId) || '';
                        const merchantB = getMerchantName(b.userId) || '';
                        result = merchantA.localeCompare(merchantB);
                        break;
                    
                    case 'date':
                    default:
                        const dateA = new Date(a.publishDate || a.createdAt || a.date || 0);
                        const dateB = new Date(b.publishDate || b.createdAt || b.date || 0);
                        result = dateB - aDate;
                        break;
                }
                
                // إذا كانت النتيجة متساوية، نرتب حسب التاريخ (الأحدث أولاً)
                if (result === 0) {
                    const dateA = new Date(a.publishDate || a.createdAt || a.date || 0);
                    const dateB = new Date(b.publishDate || b.createdAt || b.date || 0);
                    return dateB - aDate;
                }
                
                return result;
            });
        }

        // دالة الترتيب حسب التفضيلات الشخصية - العرض الذكي
        function sortProductsByPreference(products) {
            return [...products].sort((a, b) => {
                // حساب نقاط التفضيل لكل منتج
                const aPreferenceScore = calculatePreferenceScore(a);
                const bPreferenceScore = calculatePreferenceScore(b);
                
                if (aPreferenceScore !== bPreferenceScore) {
                    return bPreferenceScore - aPreferenceScore;
                }
                
                // إذا كانت النقاط متساوية، نرتب حسب التاريخ (الأحدث أولاً)
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                return bDate - aDate;
            });
        }

        // دالة الترتيب حسب العروض - العروض أولاً
        function sortProductsByOffers(products) {
            // فلترة فقط المنتجات التي نوعها "عرض" وصالحة
            const offerProducts = products.filter(p => p.productType === 'عرض' && isOfferValid(p));
            
            // ترتيب العروض حسب التاريخ (الأحدث أولاً)
            return offerProducts.sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                return bDate - aDate;
            });
        }

        function calculatePreferenceScore(product) {
            let score = 0;
            
            // إذا كانت الفئة من اهتمامات المستخدم
            if (product.categoryId && userInterests[product.categoryId]) {
                score += userInterests[product.categoryId] * 10;
            }
            
            // إذا كان المنتج في المفضلة
            if (favoriteProducts[product.id]) {
                score += 20;
            }
            
            // إذا كان اسم المنتج يتطابق مع مصطلحات البحث السابقة
            const searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            const productName = (product.name || '').toLowerCase();
            const productDesc = (product.description || '').toLowerCase();
            
            searchHistory.forEach(term => {
                if (productName.includes(term.toLowerCase()) || productDesc.includes(term.toLowerCase())) {
                    score += 5;
                }
            });
            
            return score;
        }

        function getCategoryName(categoryId) {
            const category = allCategories.find(c => c.id === categoryId);
            return category ? category.name : '';
        }

        function getMerchantName(merchantId) {
            const merchant = allMerchants.find(m => m.id === merchantId);
            return merchant ? (merchant.name || merchant.username) : '';
        }

        function displayFavoriteProducts() {
            productsContainer.innerHTML = '';
            
            const favoriteProductIds = Object.keys(favoriteProducts);
            const favoriteProductsList = allProducts.filter(p => favoriteProductIds.includes(p.id));
            
            if (favoriteProductsList.length === 0) {
                productsContainer.innerHTML = `
                    <div class="no-products">
                        <p>لا توجد منتجات في المفضلة</p>
                        <p>يمكنك إضافة منتجات إلى المفضلة بالنقر على أيقونة القلب في البطاقات</p>
                        <button onclick="closeFavoritesView()" style="margin-top:10px;padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer">العودة للعرض العادي</button>
                    </div>
                `;
                return;
            }

            // عرض المنتجات المفضلة
            const favoritesTitle = document.createElement('h2');
            favoritesTitle.style.textAlign = 'center';
            favoritesTitle.style.margin = '20px 0';
            favoritesTitle.style.color = 'var(--primary-color)';
            favoritesTitle.textContent = 'المنتجات المفضلة';
            productsContainer.appendChild(favoritesTitle);

            const favoritesGrid = document.createElement('div');
            favoritesGrid.className = 'products';
            
            // تجميع المنتجات المفضلة حسب الفئة
            const groupedFavorites = groupProductsByCategory(favoriteProductsList);
            displayGroupedProducts(groupedFavorites);

            // إضافة زر العودة للعرض العادي
            const backButton = document.createElement('div');
            backButton.style.textAlign = 'center';
            backButton.style.margin = '20px 0';
            backButton.innerHTML = `
                <button onclick="closeFavoritesView()" style="padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:16px;">
                    العودة للعرض العادي
                </button>
            `;
            productsContainer.appendChild(backButton);
        }

        function closeFavoritesView() {
            showFavoritesOnly = false;
            filterProducts();
            showNotification('تم العودة للعرض العادي', 'info');
        }

        function displayPersonalizedProducts() {
            // إذا كان هناك اهتمامات مسجلة، عرض منتجات مخصصة
            if (Object.keys(userInterests).length > 0) {
                const personalizedProducts = getPersonalizedProducts();
                if (personalizedProducts.length > 0 && !showFavoritesOnly) {
                    // يمكن إضافة عرض للمنتجات المخصصة هنا إذا أردت
                    console.log('منتجات مخصصة متاحة:', personalizedProducts.length);
                }
            }
        }

        function getPersonalizedProducts() {
            const favoriteCategories = Object.keys(userInterests)
                .sort((a, b) => userInterests[b] - userInterests[a])
                .slice(0, 3);

            return allProducts.filter(p => {
                const merchant = allMerchants.find(m => m.id === p.userId);
                if (!merchant) return false;
                const isActive = merchant.status === "active" || merchant.status === "نشط";
                const isMerchant = merchant.job === "تاجر" || merchant.type === "تاجر";
                if (!isActive || !isMerchant) return false;

                return favoriteCategories.includes(p.categoryId);
            });
        }

        // ==========================================
        // 🎯 تعديل دالة إنشاء بطاقة المنتج مع إضافة شارة العرض الخاص
        // ==========================================
        function createProductCard(product, merchant) {
            const merchantName = merchant.name || merchant.username || "تاجر";
            const productName = product.name || 'منتج بدون اسم';
            const categoryName = product.categoryId ? 
                (allCategories.find(c => c.id === product.categoryId)?.name || '') : '';

            const card = document.createElement('div');
            card.className = 'card';
            card.id = `product-${product.id}`;

            // ==========================================
            // 🎯 إضافة شارة العرض الخاص إذا كان المنتج صالح
            // ==========================================
            if (isOfferValid(product)) {
                // إضافة كلاس خاص للبطاقة التي تحتوي على عرض
                card.classList.add('has-offer');
                
                const offerBadge = document.createElement('div');
                offerBadge.className = 'offer-badge';
                offerBadge.innerHTML = '<i class="fas fa-tag"></i> عرض خاص';
                // جعل شارة العرض قابلة للنقر
                offerBadge.style.cursor = 'pointer';
                offerBadge.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleOfferDates(card);
                });
                card.appendChild(offerBadge);

                // ==========================================
                // 🎯 إضافة شارة التواريخ في الأسفل حسب المواقع المطلوبة
                // ==========================================
               if (product.startDate || product.endDate) {
    // إنشاء حاوية موحدة للتواريخ
    const offerDates = document.createElement('div');
    offerDates.className = 'offer-dates';
    
    // حقل "يبدأ"
    if (product.startDate) {
        const startDateDiv = document.createElement('div');
        startDateDiv.innerHTML = `<i class="fas fa-calendar-alt"></i> يبدأ: ${formatDate(product.startDate)}`;
        offerDates.appendChild(startDateDiv);
    }
    
    // حقل "ينتهي" أسفل "يبدأ"
    if (product.endDate) {
        const endDateDiv = document.createElement('div');
        endDateDiv.innerHTML = `<i class="fas fa-calendar-times"></i> ينتهي: ${formatDate(product.endDate)}`;
        offerDates.appendChild(endDateDiv);
    }
    
    // إضافة الحاوية الموحدة إلى البطاقة
    card.appendChild(offerDates);
}            }

            const imageUrls = extractImageUrls(product);

            if (imageUrls.length > 1) {
                // سلايدر للصور المتعددة
                const sliderDiv = document.createElement('div');
                sliderDiv.className = 'image-slider';
                sliderDiv.id = `slider-${product.id}`;

                const sliderContainer = document.createElement('div');
                sliderContainer.className = 'slider-container';

                imageUrls.forEach((url, index) => {
                    const img = document.createElement('img');
                    img.className = 'slider-image';
                    img.loading = 'lazy';
                    img.decoding = 'async';
                    img.src = formatDriveUrl(url, 'thumb');
                    img.alt = `${productName} - صورة ${index + 1}`;
                    img.addEventListener('click', () => {
                        incrementViewCount(product.id);
                        openImageGallery(imageUrls, productName, index, product.id);
                    });
                    sliderContainer.appendChild(img);
                });
                sliderDiv.appendChild(sliderContainer);

                if (imageUrls.length > 1) {
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'slider-arrow prev';
                    prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    prevBtn.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        navigateSlider(product.id, -1); 
                    });

                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'slider-arrow next';
                    nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    nextBtn.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        navigateSlider(product.id, 1); 
                    });

                    const navDiv = document.createElement('div');
                    navDiv.className = 'slider-nav';
                    imageUrls.forEach((_, i) => {
                        const dot = document.createElement('div');
                        dot.className = 'slider-dot';
                        if (i === 0) dot.classList.add('active');
                        dot.addEventListener('click', (e) => { 
                            e.stopPropagation(); 
                            goToSlide(product.id, i); 
                        });
                        navDiv.appendChild(dot);
                    });

                    sliderDiv.appendChild(prevBtn);
                    sliderDiv.appendChild(nextBtn);
                    sliderDiv.appendChild(navDiv);
                }
                card.appendChild(sliderDiv);
            } else {
                // صورة واحدة - فتح المعرض عند النقر
                const imageDiv = document.createElement('div');
                imageDiv.className = 'images-preview';
                const img = document.createElement('img');
                img.loading = 'lazy'; 
                img.decoding = 'async';

                const imageUrl = imageUrls[0] || '';
                if (imageUrl) {
                    img.src = formatDriveUrl(imageUrl, 'thumb');
                    img.alt = productName;
                    img.addEventListener('click', () => {
                        incrementViewCount(product.id);
                        openImageGallery([imageUrl], productName, 0, product.id);
                    });
                } else {
                    // استخدام الصورة الافتراضية
                    img.src = 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w800';
                    img.alt = 'صورة افتراضية';
                    img.style.border = '1px dashed #ccc';
                    img.addEventListener('click', () => {
                        incrementViewCount(product.id);
                        openImageGallery(['https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w1600'], productName, 0, product.id);
                    });
                }
                imageDiv.appendChild(img);
                card.appendChild(imageDiv);
            }

            // معلومات المنتج
            const infoDiv = document.createElement('div');
            infoDiv.className = 'info';

            const title = document.createElement('h3'); 
            title.textContent = productName; 
            infoDiv.appendChild(title);

            if (product.price) {
                const priceDiv = document.createElement('div'); 
                priceDiv.className = 'product-price';
                // دمج السعر مع العملة
                const currency = product.currency || 'ريال يمني';
                priceDiv.textContent = `${product.price} ${currency}`; 
                infoDiv.appendChild(priceDiv);
            }

            const detailsDiv = document.createElement('div'); 
            detailsDiv.className = 'product-details';
            
            if (product.description) {
                const descItem = document.createElement('div'); 
                descItem.className = 'product-detail-item';
                // دمج الوصف مع تاريخ الإضافة
                let descriptionText = escapeHtml(product.description);
                if (product.date) {
                    descriptionText += `<br><small style="color: #888; margin-top: 5px; display: block;">تاريخ الإضافة: ${formatDate(product.date)}</small>`;
                }
                descItem.innerHTML = `<span class="label">الوصف:</span> <span style="text-align:right;direction:rtl;display:block;width:100%;">${descriptionText}</span>`;
                detailsDiv.appendChild(descItem);
            } else if (product.date) {
                // إذا لم يكن هناك وصف، نعرض تاريخ الإضافة فقط
                const dateItem = document.createElement('div'); 
                dateItem.className = 'product-detail-item';
                dateItem.innerHTML = `<span class="label">تاريخ الإضافة:</span> <span>${formatDate(product.date)}</span>`;
                detailsDiv.appendChild(dateItem);
            }
            
            infoDiv.appendChild(detailsDiv);

            // بيانات التاجر المبسطة
            const merchantDiv = document.createElement('div'); 
            merchantDiv.className = 'merchant-info';
            
            const merchantNameEl = document.createElement('div'); 
            merchantNameEl.className = 'merchant-name';
            merchantNameEl.innerHTML = `📍 ${escapeHtml(merchantName)}`;
            merchantNameEl.title = 'عرض صفحة التاجر';
            merchantNameEl.addEventListener('click', () => { 
                const merchantName = merchant.name || merchant.username || "تاجر";
                const merchantId = product.userId;
                const productName = product.name || 'منتج بدون اسم';
                
                localStorage.setItem('selectedMerchantName', merchantName);
                localStorage.setItem('selectedMerchantId', merchantId);
                localStorage.setItem('selectedProductName', productName);
                
                console.log('تم حفظ بيانات التاجر:', {
                    merchantName: merchantName,
                    merchantId: merchantId,
                    productName: productName
                });
                
                incrementViewCount(product.id);
                openMerchantPage(); 
            });
            merchantDiv.appendChild(merchantNameEl);
            
            infoDiv.appendChild(merchantDiv);

            // تعليقات
            const commentsSection = document.createElement('div');
            commentsSection.className = 'comments-section'; 
            commentsSection.id = `comments-${product.id}`;
            commentsSection.innerHTML = `
                <div class="comments-header">
                    <div class="comments-title">التعليقات (<span class="comments-count">0</span>)</div>
                    <button class="close-comments" onclick="closeComments('${product.id}')">×</button>
                </div>
                <div class="comments-list" id="comments-list-${product.id}">
                    <div class="loading">جاري تحميل التعليقات...</div>
                </div>
                <div class="add-comment">
                    <div class="comment-form">
                        <textarea id="comment-text-${product.id}" placeholder="اكتب تعليقك هنا..."></textarea>
                        <button onclick="addComment('${product.id}')">إرسال التعليق</button>
                    </div>
                </div>
            `;
            infoDiv.appendChild(commentsSection);

            card.appendChild(infoDiv);

            /* ==========================================
               🎯 شريط الأزرار الجديد - تم إعادة ترتيب الأزرار حسب الطلب
               ========================================== */
            const actionButtonsDiv = document.createElement('div');
            actionButtonsDiv.className = 'action-buttons';
            actionButtonsDiv.innerHTML = `
                <div class="stats-buttons">
                    <!-- زر الإعجاب (بأيقونة الإبهام للأعلى) -->
                    <div class="stat-with-button">
                        <div class="stat-number like-stat" id="like-stat-${product.id}">0</div>
                        <button class="action-button btn-like" onclick="handleLike('${product.id}', '${escapeHtml(productName)}')">
                            <i class="fas fa-thumbs-up"></i>
                        </button>
                    </div>

                    <!-- زر التعليقات (بأيقونة التعليقات) -->
                    <div class="stat-with-button">
                        <div class="stat-number comment-stat" id="comment-stat-${product.id}">0</div>
                        <button class="action-button btn-comment" onclick="toggleComments('${product.id}')">
                            <i class="fas fa-comments"></i>
                        </button>
                    </div>

                    <!-- زر المشاهدات (بأيقونة العين) -->
                    <div class="stat-with-button">
                        <div class="stat-number view-stat" id="view-stat-${product.id}">150</div>
                        <button class="action-button btn-view">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>

                    <!-- زر المفضلة (بأيقونة القلب) -->
                    <div class="stat-with-button">
                        <div class="stat-number" style="visibility: hidden;">0</div>
                        <button class="favorite-btn ${favoriteProducts[product.id] ? 'active' : ''}" onclick="toggleFavorite('${product.id}', this, '${escapeHtml(productName)}')" title="${favoriteProducts[product.id] ? 'إزالة من المفضلة' : 'إضافة إلى المفضلة'}">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>

                    <!-- زر المشاركة (بأيقونة المشاركة) -->
                    <div class="stat-with-button">
                        <div class="stat-number" style="visibility: hidden;">0</div>
                        <button class="share-button" onclick="openShareModal('${product.id}', '${escapeHtml(productName)}')">
                            <i class="fas fa-share"></i>
                        </button>
                    </div>
                </div>
            `;
            card.appendChild(actionButtonsDiv);

            loadProductStats(product.id, card);
            return card;
        }

        // ==========================================
        // 🎯 وظيفة تبديل إظهار/إخفاء تواريخ العرض
        // ==========================================
        function toggleOfferDates(card) {
            const startDateBadge = card.querySelector('.offer-dates');
            const endDateBadge = card.querySelector('.offer-dates-end');
            
            if (startDateBadge) {
                if (startDateBadge.style.display === 'none' || startDateBadge.style.display === '') {
                    startDateBadge.style.display = 'flex';
                } else {
                    startDateBadge.style.display = 'none';
                }
            }
            
            if (endDateBadge) {
                if (endDateBadge.style.display === 'none' || endDateBadge.style.display === '') {
                    endDateBadge.style.display = 'flex';
                } else {
                    endDateBadge.style.display = 'none';
                }
            }
        }

        // استخراج الصور
        function extractImageUrls(product) {
            let imageUrls = [];
            if (product.imageUrls) {
                if (Array.isArray(product.imageUrls)) 
                    imageUrls = product.imageUrls.filter(u => u && u.trim() !== '');
                else if (typeof product.imageUrls === 'string') 
                    imageUrls = product.imageUrls.split(',').map(u => u.trim()).filter(Boolean);
            }
            if (imageUrls.length === 0 && product.imageUrl && typeof product.imageUrl === 'string') {
                imageUrls = product.imageUrl.split(/[,\n]/).map(u => u.trim()).filter(Boolean);
            }
            
            // إذا لم توجد صور، نستخدم الصورة الافتراضية
            if (imageUrls.length === 0) {
                imageUrls = ['https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w800'];
            }
            
            return imageUrls;
        }

        // ==========================================
        // 🔍 إصلاح مشكلة عرض الصور من جوجل درايف
        // ==========================================
        function formatDriveUrl(url, mode = 'thumb') {
            if (!url) return '';
            
            // إذا كان الرابط هو الصورة الافتراضية، نعيده كما هو
            if (url.includes('1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC')) {
                return url;
            }
            
            // استخراج معرف الملف من رابط جوجل درايف
            let id = '';
            
            // رابط مباشر للملف
            if (url.includes('/d/')) {
                id = url.split('/d/')[1].split('/')[0];
            } 
            // رابط مشاركة
            else if (url.includes('id=')) {
                try { 
                    id = new URLSearchParams(url.split('?')[1]).get('id') || ''; 
                } catch { 
                    return url; 
                }
            }
            // رابط عرض
            else if (url.includes('/file/d/')) {
                id = url.split('/file/d/')[1].split('/')[0];
            }
            // رابط مسبق التنسيق
            else if (url.includes('drive.google.com/uc?id=')) {
                id = url.split('drive.google.com/uc?id=')[1].split('&')[0];
            }
            
            if (!id) return url;

            // إصلاح مشكلة عرض الصور من جوجل درايف
            // استخدام رابط العرض المباشر بدلاً من رابط التحميل
            if (mode === 'thumb') {
                // صورة مصغرة سريعة التحميل للسلايدر والمصغرات
                return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
            } else if (mode === 'main') {
                // صورة كبيرة للمعرض
                return `https://drive.google.com/thumbnail?id=${id}&sz=w1600`;
            } else if (mode === 'raw') {
                // العرض المباشر
                return `https://drive.google.com/uc?export=view&id=${id}`;
            }
            return url;
        }

        // ==========================================
        // 🖼️ وظائف معرض الصور المحسن - إصلاح مشكلة الخروج على الجوال
        // ==========================================
        function openImageGallery(images, productName, startIndex = 0, productId = null) {
            galleryImages = images;
            currentGalleryIndex = startIndex;
            isImageZoomed = false;

            if (productId) {
                // تسجيل اهتمام المستخدم بالفئة
                const product = allProducts.find(p => p.id === productId);
                if (product && product.categoryId) {
                    userInterests[product.categoryId] = (userInterests[product.categoryId] || 0) + 1;
                    localStorage.setItem('userInterests', JSON.stringify(userInterests));
                }
            }

            document.getElementById('gallery-product-name').textContent = productName;
            createGalleryThumbnails();
            showGalleryImage(startIndex);

            const gallery = document.getElementById('image-gallery');
            gallery.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            // إضافة مستمع حدث للزر الخلفي على الجوال
            if ('ontouchstart' in window) {
                document.addEventListener('backbutton', handleBackButton, false);
            }
        }

        function closeImageGallery() {
            document.getElementById('image-gallery').classList.remove('active');
            document.body.style.overflow = '';
            isImageZoomed = false;

            const mainImage = document.getElementById('gallery-main-image');
            mainImage.classList.remove('zoomed');
            
            // إزالة مستمع حدث الزر الخلفي
            if ('ontouchstart' in window) {
                document.removeEventListener('backbutton', handleBackButton, false);
            }
        }

        // معالجة الزر الخلفي على الجوال
        function handleBackButton(e) {
            const gallery = document.getElementById('image-gallery');
            if (gallery.classList.contains('active')) {
                e.preventDefault();
                closeImageGallery();
            }
        }

        function createGalleryThumbnails() {
            const container = document.getElementById('gallery-thumbnails');
            container.innerHTML = '';
            
            galleryImages.forEach((u, i) => {
                const thumb = document.createElement('img');
                thumb.className = 'gallery-thumbnail';
                thumb.loading = 'lazy'; 
                thumb.decoding = 'async';
                thumb.src = formatDriveUrl(u, 'thumb');
                thumb.alt = `صورة ${i + 1}`;
                thumb.addEventListener('click', () => showGalleryImage(i));
                if (i === currentGalleryIndex) thumb.classList.add('active');
                container.appendChild(thumb);
            });
        }

        function showGalleryImage(index) {
            if (galleryImages.length === 0) {
                const mainImage = document.getElementById('gallery-main-image');
                mainImage.src = 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w1600';
                mainImage.alt = 'لا توجد صورة';
                document.getElementById('gallery-counter').textContent = '0 من 0';
                return;
            }

            if (index < 0) currentGalleryIndex = galleryImages.length - 1;
            else if (index >= galleryImages.length) currentGalleryIndex = 0;
            else currentGalleryIndex = index;

            const mainImage = document.getElementById('gallery-main-image');
            // تحميل الصورة الكبيرة
            mainImage.src = formatDriveUrl(galleryImages[currentGalleryIndex], 'main');
            mainImage.alt = `صورة ${currentGalleryIndex + 1}`;
            mainImage.classList.remove('zoomed');
            isImageZoomed = false;

            document.getElementById('gallery-counter').textContent = 
                `${currentGalleryIndex + 1} من ${galleryImages.length}`;

            // تحديث المصغرات
            const thumbs = document.querySelectorAll('.gallery-thumbnail');
            thumbs.forEach((t, i) => t.classList.toggle('active', i === currentGalleryIndex));

            // تحميل مسبق للصور المجاورة لتحسين الأداء
            preloadAdjacentImages();
        }

        function navigateGallery(direction) {
            showGalleryImage(currentGalleryIndex + direction);
        }

        // ==========================================
        // 🔍 وظيفة التحكم في تكبير الصورة
        // ==========================================
        function toggleImageZoom() {
            const mainImage = document.getElementById('gallery-main-image');
            isImageZoomed = !isImageZoomed;
            mainImage.classList.toggle('zoomed', isImageZoomed);

            // تحديث أيقونة زر التكبير
            const zoomBtn = document.querySelector('.gallery-zoom-btn i');
            if (isImageZoomed) {
                zoomBtn.className = 'fas fa-search-minus';
            } else {
                zoomBtn.className = 'fas fa-search-plus';
            }
        }

        function preloadAdjacentImages() {
            const prevIndex = (currentGalleryIndex - 1 + galleryImages.length) % galleryImages.length;
            const nextIndex = (currentGalleryIndex + 1) % galleryImages.length;

            [prevIndex, nextIndex].forEach(i => {
                const img = new Image();
                img.decoding = 'async';
                img.referrerPolicy = 'no-referrer';
                img.src = formatDriveUrl(galleryImages[i], 'main');
            });
        }

        // سلايدر البطاقات
        function navigateSlider(productId, direction) {
            const slider = document.getElementById(`slider-${productId}`);
            const container = slider.querySelector('.slider-container');
            const slides = container.querySelectorAll('.slider-image');

            const currentIndex = Math.round(container.scrollLeft / container.clientWidth);
            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = slides.length - 1;
            if (newIndex >= slides.length) newIndex = 0;
            goToSlide(productId, newIndex);
        }

        function goToSlide(productId, index) {
            const slider = document.getElementById(`slider-${productId}`);
            const container = slider.querySelector('.slider-container');
            const dots = slider.querySelectorAll('.slider-dot');

            container.scrollTo({ left: index * container.clientWidth, behavior: 'smooth' });
            dots.forEach((d, i) => d.classList.toggle('active', i === index));
        }

        function filterProducts() {
            const filters = {
                governorate: governorateSelect.value,
                region: regionSelect.value,
                category: categorySelect.value,
                merchant: merchantSelect.value,
                search: (searchInput.value || '').toLowerCase().trim(),
                sortBy: sortSelect.value
            };

            // حفظ مصطلح البحث في السجل
            if (filters.search) {
                saveSearchTerm(filters.search);
                // حفظ مصطلحات البحث غير الموجودة في asnaf_slect
                saveSearchTermToAsnaf(filters.search);
            }

            const result = allProducts.filter(product => {
                if (!product) return false;
                const merchant = allMerchants.find(m => m.id === product.userId);
                if (!merchant) return false;

                // التحقق من أن التاجر نشط ووظيفته "تاجر"
                const isActive = merchant.status === "active" || merchant.status === "نشط";
                const isMerchant = merchant.job === "تاجر" || merchant.type === "تاجر";
                
                if (!isActive || !isMerchant) return false;

                // ==========================================
                // 🎯 فلترة العروض المنتهية
                // ==========================================
                if (product.productType === 'عرض' && !isOfferValid(product)) {
                    return false;
                }

                if (filters.search) {
                    const text = `${product.name || ''} ${product.description || ''}`.toLowerCase();
                    if (!text.includes(filters.search)) return false;
                }

                if (filters.category) {
                    if (product.categoryId !== filters.category && product.category !== filters.category) return false;
                }

                if (filters.merchant && product.userId !== filters.merchant) return false;

                if (filters.governorate) {
                    const merchantGovernorate = merchant.governorate || merchant.region;
                    if (merchantGovernorate !== filters.governorate) return false;
                }
                if (filters.region) {
                    const merchantArea = merchant.area || merchant.city;
                    if (merchantArea !== filters.region) return false;
                }

                return true;
            });

            displayProducts(result);
        }

        function saveSearchTerm(term) {
            let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            
            // إضافة المصطلح الجديد وإزالة التكرارات
            searchHistory = searchHistory.filter(t => t !== term);
            searchHistory.unshift(term);
            
            // الحفاظ على آخر 10 مصطلحات بحث فقط
            searchHistory = searchHistory.slice(0, 10);
            
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }

        function resetFilters() {
            governorateSelect.value = '';
            regionSelect.value = '';
            categorySelect.value = '';
            merchantSelect.value = '';
            searchInput.value = '';
            sortSelect.value = 'date';
            categoryValueDisplay.textContent = '';
            currentCategoryFilter = '';
            secondaryCategorySelect.value = '';
            updateRegionOptions();
            displayProducts(allProducts);
            showNotification('تم إعادة تعيين جميع الفلاتر', 'success');
        }

        function hideFilterBar() {
            filterBar.style.display = 'none';
            document.body.style.paddingTop = '128px';
            localStorage.setItem('filterBarHidden', 'true');
            filterControlBtn.innerHTML = '<i class="fas fa-sliders-h"></i>';
            filterControlBtn.title = 'إظهار شريط الفلاتر';
            showMoreBtn.innerHTML = '<i class="fas fa-bars"></i> أكثر';
        }

        function showFilterBar() {
            filterBar.style.display = 'flex';
            document.body.style.paddingTop = '180px';
            localStorage.setItem('filterBarHidden', 'false');
            filterControlBtn.innerHTML = '<i class="fas fa-times"></i>';
            filterControlBtn.title = 'إخفاء شريط الفلاتر';
            showMoreBtn.innerHTML = '<i class="fas fa-times"></i> إخفاء';
        }

        // ==========================================
        // ❤️ تعديل وظيفة المفضلة مع الإشعارات
        // ==========================================
        function toggleFavorite(productId, button, productName = '') {
            if (favoriteProducts[productId]) { 
                delete favoriteProducts[productId]; 
                button.classList.remove('active'); 
                showNotification('تم إزالة المنتج من المفضلة', 'info');
            } else { 
                favoriteProducts[productId] = true; 
                button.classList.add('active'); 
                showNotification('تم إضافة المنتج إلى المفضلة', 'success');
                
                // تسجيل اهتمام المستخدم بالفئة
                const product = allProducts.find(p => p.id === productId);
                if (product && product.categoryId) {
                    userInterests[product.categoryId] = (userInterests[product.categoryId] || 0) + 1;
                    localStorage.setItem('userInterests', JSON.stringify(userInterests));
                }
            }
            localStorage.setItem('favoriteProducts', JSON.stringify(favoriteProducts));
            
            // إذا كنا في وضع عرض المفضلة، قم بتحديث العرض
            if (showFavoritesOnly) {
                displayFavoriteProducts();
            }
        }

        // ==========================================
        // 🔔 وظيفة عرض الإشعارات
        // ==========================================
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            // تلوين الإشعار حسب النوع
            if (type === 'success') {
                notification.style.background = 'var(--success-color)';
            } else if (type === 'info') {
                notification.style.background = 'var(--primary-color)';
            } else if (type === 'error') {
                notification.style.background = 'var(--danger-color)';
            }
            
            document.body.appendChild(notification);
            
            // إزالة الإشعار بعد 3 ثواني
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ==========================================
        // 👁️ تعديل وظيفة زيادة المشاهدات - الإصلاح الجديد
        // ==========================================
        function incrementViewCount(productId) {
            // التحقق من أن المستخدم لم يشاهد هذا المنتج من قبل في هذه الجلسة
            const viewKey = `view_${productId}`;
            
            if (!userActions.views[viewKey]) {
                // تسجيل المشاهدة
                userActions.views[viewKey] = Date.now();
                localStorage.setItem('userActions', JSON.stringify(userActions));
                
                // زيادة العداد في Firebase
                db.ref(`products_stats/${productId}/views`).transaction(current => (current || 0) + 1);

                // تحديث العداد في الواجهة
                const viewEl = document.getElementById(`view-stat-${productId}`);
                if (viewEl) { 
                    const currentViews = parseInt(viewEl.textContent) || 150;
                    viewEl.textContent = currentViews + 1; 
                }

                // تسجيل اهتمام المستخدم بالفئة
                const product = allProducts.find(p => p.id === productId);
                if (product && product.categoryId) {
                    userInterests[product.categoryId] = (userInterests[product.categoryId] || 0) + 1;
                    localStorage.setItem('userInterests', JSON.stringify(userInterests));
                }
                
                console.log('👁️ تم تسجيل مشاهدة جديدة للمنتج:', productId);
            } else {
                console.log('👁️ المستخدم قد شاهد هذا المنتج من قبل:', productId);
            }
        }

        async function loadProductStats(productId, card) {
            try {
                const [statsSnap, commentsSnap] = await Promise.all([
                    db.ref(`products_stats/${productId}`).once('value'),
                    db.ref(`comments/${productId}`).once('value')
                ]);

                const stats = statsSnap.val() || {};
                const comments = commentsSnap.val() || {};

                const likeCount = Array.isArray(stats.likes) ? stats.likes.length : 0;
                const viewCount = (stats.views || 0) + 150;
                const commentCount = Object.keys(comments).length;

                // تحديث الإحصائيات فوق الأزرار
                const likeStatEl = document.getElementById(`like-stat-${productId}`);
                const viewStatEl = document.getElementById(`view-stat-${productId}`);
                const commentStatEl = document.getElementById(`comment-stat-${productId}`);
                const commentsCountEl = card.querySelector('.comments-count');

                if (likeStatEl) likeStatEl.textContent = likeCount;
                if (viewStatEl) viewStatEl.textContent = viewCount;
                if (commentStatEl) commentStatEl.textContent = commentCount;
                if (commentsCountEl) commentsCountEl.textContent = commentCount;

                // تحديث حالة زر الإعجاب بناءً على إجراءات المستخدم السابقة
                updateLikeButtonState(productId, stats.likes || []);
                
            } catch (e) { 
                console.error('خطأ في تحميل الإحصائيات:', e); 
            }
        }

        // ==========================================
        // ❤️ تحديث حالة زر الإعجاب بناءً على إجراءات المستخدم - الإصلاح الجديد
        // ==========================================
        function updateLikeButtonState(productId, likesArray) {
            const likeButton = document.querySelector(`#product-${productId} .btn-like`);
            if (!likeButton) return;
            
            // التحقق مما إذا كان المستخدم قد أعجب بهذا المنتج من قبل
            const userLiked = likesArray.includes(currentUserId);
            
            if (userLiked) {
                likeButton.style.color = 'var(--danger-color)';
                likeButton.title = 'إلغاء الإعجاب';
            } else {
                likeButton.style.color = '';
                likeButton.title = 'الإعجاب';
            }
        }

        // ==========================================
        // ❤️ تعديل وظيفة الإعجاب - الإصلاح الجديد
        // ==========================================
        async function handleLike(productId, productName = '') {
            try {
                const likesRef = db.ref(`products_stats/${productId}/likes`);
                const snapshot = await likesRef.once('value');
                let likes = snapshot.val() || [];
                if (!Array.isArray(likes)) likes = [];
                
                const idx = likes.indexOf(currentUserId);
                if (idx === -1) {
                    // إضافة الإعجاب
                    likes.push(currentUserId);
                    showNotification('تم الإعجاب بالمنتج', 'success');
                    
                    // تسجيل الإعجاب في إجراءات المستخدم
                    userActions.likes[productId] = Date.now();
                    localStorage.setItem('userActions', JSON.stringify(userActions));
                } else {
                    // إزالة الإعجاب
                    likes.splice(idx, 1);
                    showNotification('تم إلغاء الإعجاب بالمنتج', 'info');
                    
                    // إزالة الإعجاب من إجراءات المستخدم
                    delete userActions.likes[productId];
                    localStorage.setItem('userActions', JSON.stringify(userActions));
                }
                
                await likesRef.set(likes);
                
                // تحديث العداد فوق زر الإعجاب
                const likeStatEl = document.getElementById(`like-stat-${productId}`);
                if (likeStatEl) likeStatEl.textContent = likes.length;
                
                // تحديث حالة زر الإعجاب
                updateLikeButtonState(productId, likes);
                
            } catch (e) { 
                console.error('خطأ في معالجة الإعجاب:', e); 
            }
        }

        function toggleComments(productId) {
            const el = document.getElementById(`comments-${productId}`);
            if (el.classList.contains('active')) {
                closeComments(productId);
            } else {
                openComments(productId);
            }
        }

        function openComments(productId) { 
            // إغلاق جميع نوافذ التعليقات المفتوحة أولاً
            closeAllComments();
            
            const el = document.getElementById(`comments-${productId}`); 
            el.classList.add('active'); 
            loadComments(productId);
            isCommentsOpen = true;
        }

        function closeComments(productId) { 
            const el = document.getElementById(`comments-${productId}`); 
            el.classList.remove('active'); 
            const t = document.getElementById(`comment-text-${productId}`); 
            if (t) t.value=''; 
            isCommentsOpen = false;
        }

        function closeAllComments() {
            document.querySelectorAll('.comments-section.active').forEach(section => {
                section.classList.remove('active');
            });
            isCommentsOpen = false;
        }

        async function loadComments(productId) {
            const list = document.getElementById(`comments-list-${productId}`);
            list.innerHTML = '<div class="loading">جاري تحميل التعليقات...</div>';
            try {
                const snapshot = await db.ref(`comments/${productId}`).once('value');
                const data = snapshot.val() || {};
                const comments = Object.entries(data).map(([id, c]) => ({ id, ...c }));
                displayComments(comments, productId);
            } catch (e) {
                console.error('خطأ في تحميل التعليقات:', e);
                list.innerHTML = '<div class="error">حدث خطأ في تحميل التعليقات</div>';
            }
        }

        function displayComments(comments, productId) {
            const list = document.getElementById(`comments-list-${productId}`);
            const countEl = document.querySelector(`#comments-${productId} .comments-count`);
            list.innerHTML = '';
            countEl.textContent = comments.length;

            if (comments.length === 0) { 
                list.innerHTML = '<div class="no-comments">لا توجد تعليقات بعد</div>'; 
                return; 
            }

            comments.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            comments.forEach(c => {
                const div = document.createElement('div'); 
                div.className = 'comment-item';
                div.innerHTML = `
                    <div class="comment-header">
                        <span>${escapeHtml(c.author || 'مستخدم')}</span>
                        <span class="comment-date">${formatDate(c.date)}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(c.text || '')}</div>
                `;
                list.appendChild(div);
            });
        }

        async function addComment(productId) {
            const textarea = document.getElementById(`comment-text-${productId}`);
            const text = (textarea.value || '').trim();
            if (!text) { 
                alert('يرجى كتابة تعليق قبل الإرسال'); 
                return; 
            }

            try {
                const commentId = Date.now().toString();
                const comment = { text, author: 'مستخدم', date: new Date().toISOString() };
                await db.ref(`comments/${productId}/${commentId}`).set(comment);
                textarea.value = '';
                loadComments(productId);
                showNotification('تم إضافة التعليق بنجاح', 'success');

                // تحديث عداد التعليقات فوق الزر
                const commentStatEl = document.getElementById(`comment-stat-${productId}`);
                if (commentStatEl) commentStatEl.textContent = (parseInt(commentStatEl.textContent) || 0) + 1;
            } catch (e) {
                console.error('خطأ في إضافة التعليق:', e);
                alert('حدث خطأ في إضافة التعليق');
            }
        }

        // ==========================================
        // 🔗 نظام المشاركة المحسن - فتح نافذة اختيار التطبيقات
        // ==========================================
        let currentShareProductId = null;
        let currentShareProductName = '';

        function openShareModal(productId, productName) {
            currentShareProductId = productId;
            currentShareProductName = productName;
            shareModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeShareModal() {
            shareModal.classList.remove('active');
            document.body.style.overflow = '';
            currentShareProductId = null;
            currentShareProductName = '';
        }

        function handleShareOption(e) {
            const platform = e.currentTarget.dataset.platform;
            shareProduct(currentShareProductId, currentShareProductName, platform);
            closeShareModal();
        }

        function shareProduct(productId, productName = '', platform = 'other') {
            const product = allProducts.find(p => p.id === productId);
            const merchant = product ? allMerchants.find(m => m.id === product.userId) : null;
            const merchantName = merchant ? (merchant.name || merchant.username || "تاجر") : "تاجر";
            const productPrice = product ? (product.price ? `${product.price} ريال يمني` : 'غير محدد') : 'غير محدد';
            const productUrl = `${window.location.origin}${window.location.pathname}?productId=${productId}`;
            const productImage = product ? extractImageUrls(product)[0] : '';

            const shareText = `مرحبآ 
الان وحصري على منصة AZ السوق الشامل لتلبية احتياجك بالكامل
اول سوق تجاري يحتوي على 
قسم للمنتجات التجارية الجديدة 
قسم للمنتجات المستخدمة - الحراج
قسم للمباني والعقارات وتأجير الشقق
قسم الوظائف الشاغرة
قسم الطلب والتوصيل السريع للمطاعم والبوافي واللحوم
قسم موقع وأرقام أشخاص تهمك 
مع AZ متعة التسوق

أعجبني منتج / ${productName} - ${productPrice}
العرض مقدم من التاجر / ${merchantName}
رابط المنتج: ${productUrl}`;

            const shareUrls = {
                whatsapp: `https://wa.me/?text=${encodeURIComponent(shareText)}`,
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(productUrl)}&quote=${encodeURIComponent(shareText)}`,
                twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(productUrl)}`,
                telegram: `https://t.me/share/url?url=${encodeURIComponent(productUrl)}&text=${encodeURIComponent(shareText)}`,
                copy: null,
                other: null
            };

            switch(platform) {
                case 'whatsapp':
                case 'facebook':
                case 'twitter':
                case 'telegram':
                    window.open(shareUrls[platform], '_blank', 'width=600,height=400');
                    showNotification(`تم فتح ${platform} للمشاركة`, 'success');
                    break;
                
                case 'copy':
                    copyToClipboard(shareText);
                    showNotification('تم نسخ رابط المنتج إلى الحافظة', 'success');
                    break;
                
                case 'other':
                default:
                    if (navigator.share) {
                        navigator.share({ 
                            title: `AZ السوق الشامل - ${productName}`, 
                            text: shareText, 
                            url: productUrl 
                        })
                        .then(() => showNotification('تمت المشاركة بنجاح', 'success'))
                        .catch(err => {
                            console.log('خطأ في المشاركة:', err);
                            copyToClipboard(shareText);
                        });
                    } else {
                        copyToClipboard(shareText);
                    }
                    break;
            }
        }

        // دالة مساعدة للنسخ إلى الحافظة
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    showNotification('تم نسخ رابط المنتج إلى الحافظة', 'success');
                })
                .catch(() => {
                    // الطريقة البديلة للنسخ
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('تم نسخ رابط المنتج إلى الحافظة', 'success');
                });
        }

        // ==========================================
        // 🎯 تعديل دالة فتح صفحة التاجر
        // ==========================================
        function openMerchantPage() {
            // البيانات محفوظة مسبقاً في localStorage
            window.open('ard_tagr.html', '_blank');
        }

        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            try { 
                return new Date(dateString).toLocaleDateString('ar-EG'); 
            } catch { 
                return dateString; 
            }
        }

        function escapeHtml(text) { 
            const div = document.createElement('div'); 
            div.textContent = text; 
            return div.innerHTML; 
        }

        // ==========================================
        // 🔄 نظام التحديث التلقائي للمنتجات الجديدة - تم الإصلاح
        // ==========================================
        function startAutoUpdate() {
            // الاستماع للتغييرات في قاعدة البيانات في الوقت الحقيقي
            db.ref("products").on("value", (snapshot) => {
                const newProducts = convertFirebaseData(snapshot.val()) || [];
                
                // التحقق من وجود منتجات جديدة
                if (newProducts.length !== allProducts.length) {
                    console.log('🔄 تم اكتشاف تغيير في المنتجات!');
                    
                    // حفظ عدد المنتجات السابق للمقارنة
                    const previousCount = allProducts.length;
                    
                    // تحديث قائمة المنتجات
                    allProducts = newProducts;
                    
                    // حفظ البيانات في التخزين المحلي
                    saveDataToCache();
                    
                    // إعادة عرض المنتجات مع المنتجات الجديدة
                    if (!showFavoritesOnly) {
                        displayProducts(allProducts);
                        
                        // عرض إشعار إذا كانت هناك منتجات جديدة مضافة
                        if (newProducts.length > previousCount) {
                            const newProductsCount = newProducts.length - previousCount;
                            showNotification(`تم تحديث ${newProductsCount} منتج جديد`, 'success');
                        }
                    }
                }
            });
        }

        // ==========================================
        // 🎲 دوال مساعدة للأرقام العشوائية
        // ==========================================
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // اتصال الشبكة
        window.addEventListener('online', () => { 
            console.log('الاتصال متوفر - تحديث البيانات'); 
            loadAllData(); 
        });
        
        window.addEventListener('offline', () => { 
            console.log('لا يوجد اتصال - استخدام البيانات المحلية'); 
        });

        // تنظيف الفاصل الزمني للإعلانات عند إغلاق الصفحة
        window.addEventListener('beforeunload', () => {
            if (adInterval) {
                clearInterval(adInterval);
            }
            if (onlineUsersInterval) {
                clearInterval(onlineUsersInterval);
            }
            if (autoViewInterval) {
                clearInterval(autoViewInterval);
            }
            if (autoLikeInterval) {
                clearInterval(autoLikeInterval);
            }
            if (autoCommentInterval) {
                clearInterval(autoCommentInterval);
            }
        });
    </script>
</body>
</html>
