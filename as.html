<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>تتبع الموقع المباشر</title>
  <style>
    body { font-family: Arial, sans-serif; text-align: center; padding: 20px; direction: rtl; }
    #map { height: 400px; margin-top: 20px; border: 1px solid #ccc; }
    #msg { margin-top: 15px; font-weight: bold; color: red; }
  </style>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
</head>
<body>

<h2>تتبع الموقع المباشر</h2>
<p>الرجاء الضغط على <strong>"سماح"</strong> عند طلب الإذن لتحديد موقعك.</p>

<div id="msg">جاري محاولة تحديد الموقع...</div>
<div id="map"></div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
let map, marker, circle;

// التحقق من دعم المتصفح
if (!navigator.geolocation) {
  document.getElementById("msg").innerText = "متصفحك لا يدعم تحديد الموقع.";
} else {
  // تتبع الموقع بشكل مستمر
  navigator.geolocation.watchPosition(success, error, { enableHighAccuracy: true });
}

function success(pos) {
  const lat = pos.coords.latitude;
  const lon = pos.coords.longitude;
  const acc = pos.coords.accuracy;

  document.getElementById("msg").style.color = "green";
  document.getElementById("msg").innerText = `موقعك الحالي (دقة تقريبية ${acc} متر)`;

  if (!map) {
    // إنشاء الخريطة أول مرة
    map = L.map('map').setView([lat, lon], 16);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '&copy; OpenStreetMap'
    }).addTo(map);

    marker = L.marker([lat, lon]).addTo(map).bindPopup("موقعك الحالي").openPopup();
    circle = L.circle([lat, lon], { radius: acc, color: "blue", fillOpacity: 0.1 }).addTo(map);
  } else {
    // تحديث الموقع إذا تغير
    marker.setLatLng([lat, lon]);
    circle.setLatLng([lat, lon]);
    circle.setRadius(acc);
    map.setView([lat, lon]);
  }
}

function error(err) {
  if (err.code === 1) {
    document.getElementById("msg").innerText = "❌ تم رفض إذن الموقع. الرجاء السماح من إعدادات المتصفح.";
  } else if (err.code === 2) {
    document.getElementById("msg").innerText = "⚠️ الموقع غير متاح حالياً.";
  } else if (err.code === 3) {
    document.getElementById("msg").innerText = "⏳ انتهت مهلة تحديد الموقع.";
  } else {
    document.getElementById("msg").innerText = "حدث خطأ غير معروف.";
  }
}
</script>

</body>
</html>
