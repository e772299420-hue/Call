
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø£ØµÙ†Ø§Ù - Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<!-- SweetAlert2 -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css">
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

/* ===== Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ ===== */
.top-header {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 70px;
    background-color: #2575fc;
    box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 0 20px;
    z-index: 1000;
    flex-direction: row-reverse;
}

.app-info {
    display: flex;
    align-items: center;
}

.app-logo {
    width: 40px;
    height: 40px;
    border-radius: 8px;
    margin-right: 10px;
    overflow: hidden;
    background-color: white;
    padding: 3px;
    cursor: pointer;
}

.app-logo img {
    width: 100%;
    height: 100%;
    object-fit: contain;
}

.app-name {
    font-size: 18px;
    font-weight: bold;
    color: white;
}

.management-title {
    font-size: 18px;
    font-weight: bold;
    color: white;
}

/* ===== Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¬Ø§Ø± ===== */
.merchant-bar {
    position: fixed;
    top: 70px;
    left: 0;
    width: 100%;
    height: 40px;
    background-color: #f5f5f5;
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 999;
    border-bottom: 1px solid #e0e0e0;
}

.merchant-name {
    font-size: 16px;
    color: #333;
    font-weight: 500;
}

/* ===== Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ù„ÙˆØ¨Ù„Ø§Øª - Ù…Ø®ÙÙŠ ===== */
.globals-bar {
    display: none;
}

/* ===== Ø²Ø± Ø§Ù„Ø±Ø¬ÙˆØ¹ - Ù…Ø®ÙÙŠ ===== */
.back-button {
    display: none;
}

/* ===== Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª ===== */
.notifications-container {
    position: fixed;
    top: 120px;
    left: 20px;
    z-index: 997;
    display: flex;
    flex-direction: column;
    gap: 10px;
    max-width: 350px;
}

.notification {
    background: rgba(255, 255, 255, 0.95);
    border-radius: 10px;
    padding: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    border-right: 4px solid #1976D2;
    transform: translateX(-100%);
    opacity: 0;
    transition: all 0.3s ease;
    max-height: 0;
    overflow: hidden;
}

.notification.show {
    transform: translateX(0);
    opacity: 1;
    max-height: 200px;
}

.notification.success {
    border-right-color: #4CAF50;
}

.notification.error {
    border-right-color: #f44336;
}

.notification.warning {
    border-right-color: #FF9800;
}

.notification-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 8px;
}

.notification-title {
    font-weight: bold;
    font-size: 16px;
}

.notification-close {
    background: none;
    border: none;
    cursor: pointer;
    color: #666;
    font-size: 16px;
}

.notification-message {
    font-size: 14px;
    color: #333;
    line-height: 1.4;
}

/* ===== Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ ===== */
.welcome-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0,0,0,0.85);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 3000;
    backdrop-filter: blur(10px);
    animation: fadeIn 0.6s ease;
}

.welcome-modal.show {
    display: flex;
}

.welcome-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 20px;
    padding: 30px;
    width: 90%;
    max-width: 600px;
    box-shadow: 0 20px 50px rgba(0,0,0,0.4);
    position: relative;
    animation: modalSlideIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    border: 2px solid rgba(106, 17, 203, 0.3);
    text-align: center;
}

.welcome-header {
    margin-bottom: 25px;
}

.welcome-logo {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: 15px;
    margin-bottom: 20px;
}

.welcome-logo i {
    font-size: 50px;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
    animation: logoRotate 4s ease-in-out infinite;
}

.welcome-logo span {
    font-size: 32px;
    font-weight: bold;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    -webkit-background-clip: text;
    background-clip: text;
    color: transparent;
}

.welcome-title {
    font-size: 28px;
    color: #333;
    margin-bottom: 8px;
    font-weight: bold;
}

.welcome-subtitle {
    color: #666;
    font-size: 16px;
    margin-bottom: 20px;
}

.welcome-content {
    text-align: right;
    margin-bottom: 25px;
}

.welcome-greeting {
    font-size: 20px;
    color: #333;
    margin-bottom: 15px;
    font-weight: bold;
}

.welcome-offer {
    font-size: 18px;
    color: #d32f2f;
    text-decoration: underline;
    margin-bottom: 15px;
    font-weight: bold;
}

.welcome-message {
    font-size: 16px;
    color: #555;
    margin-bottom: 15px;
    line-height: 1.5;
}

.welcome-highlight {
    font-size: 18px;
    color: #333;
    margin-bottom: 20px;
    font-weight: bold;
}

.welcome-conditions {
    text-align: right;
    margin-top: 20px;
}

.welcome-conditions-title {
    font-size: 18px;
    color: #333;
    margin-bottom: 10px;
    font-weight: bold;
}

.welcome-conditions-list {
    list-style-type: none;
    padding-right: 0;
}

.welcome-conditions-list li {
    margin-bottom: 10px;
    font-size: 16px;
    color: #555;
    line-height: 1.4;
}

.welcome-close-btn {
    display: block;
    width: 100%;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
    padding: 15px;
    border-radius: 12px;
    border: none;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    margin-top: 15px;
    position: relative;
    overflow: hidden;
}

.welcome-close-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: all 0.6s ease;
}

.welcome-close-btn:hover::before {
    width: 400px;
    height: 400px;
}

.welcome-close-btn:hover {
    background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 10px 25px rgba(106, 17, 203, 0.4);
}

/* ===== Ø§Ù„ØªØ°ÙŠÙŠÙ„ ===== */
.footer {
    position: fixed;
    bottom: 0;
    left: 0;
    width: 100%;
    height: 50px;
    background-color: #fff;
    display: flex;
    justify-content: center;
    align-items: center;
    border-top: 1px solid #e0e0e0;
    color: #1976D2;
    font-weight: 500;
    z-index: 1000;
}

/* ===== Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© ===== */
body {
    background: white;
    color: #333;
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 130px 20px 70px 20px;
    position: relative;
}

/* ===== Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ===== */
.container {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    max-width: 1000px;
    width: 100%;
}

.card {
    background: white;
    border-radius: 15px;
    overflow: hidden;
    width: 300px;
    text-align: center;
    box-shadow: 0 10px 20px rgba(0,0,0,0.1);
    transition: transform 0.3s, box-shadow 0.3s, filter 0.3s;
    cursor: pointer;
    position: relative;
    border: 1px solid #e0e0e0;
}

.card:hover {
    transform: translateY(-8px);
    box-shadow: 0 12px 25px rgba(0,0,0,0.2);
}

.card-header {
    background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
    color: white;
    padding: 20px;
}

.card-header i {
    font-size: 45px;
    margin-bottom: 10px;
}

.card-header h2 {
    font-size: 1.5rem;
    margin-bottom: 8px;
}

.card-body {
    padding: 20px;
}

.card-body p {
    color: #333;
    line-height: 1.5;
    margin-bottom: 15px;
    font-size: 1rem;
}

/* ===== Ø§Ù„Ø£Ø²Ø±Ø§Ø± ===== */
.btn, .home-btn {
    display: inline-block;
    color: white;
    padding: 10px 22px;
    border-radius: 50px;
    text-decoration: none;
    font-weight: bold;
    transition: background 0.3s, transform 0.3s;
    border: none;
    cursor: pointer;
    font-size: 1rem;
}

.btn {
    background: #6a11cb;
}

.btn:hover {
    background: #2575fc;
    transform: scale(1.05);
}

.home-btn {
    background: #4CAF50;
    margin-top: 20px;
}

.home-btn:hover {
    background: #388E3C;
    transform: scale(1.05);
}

.button-container {
    display: flex;
    justify-content: center;
    margin-top: 20px;
    width: 100%;
}

/* ===== Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ - Ù…Ø®ÙÙŠ Ø§Ù„Ø¢Ù† ===== */
.input-container {
    display: none;
}

.transfer-btn {
    display: none;
}

/* ===== Ø´Ø§Ø´Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===== */
.login-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); display: none; justify-content: center;
    align-items: center; z-index: 2000; backdrop-filter: blur(10px);
    animation: fadeIn 0.6s ease;
}

.login-modal.show { display: flex; }

.login-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 20px; padding: 40px;
    width: 90%; max-width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.4);
    position: relative;
    animation: modalSlideIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    border: 2px solid rgba(106, 17, 203, 0.3);
    font-size: 18px;
}

.login-header { text-align: center; margin-bottom: 30px; }

.login-logo {
    display: flex; align-items: center; justify-content: center;
    gap: 15px; margin-bottom: 20px;
}

.login-logo i {
    font-size: 50px;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    -webkit-background-clip: text; background-clip: text; color: transparent;
    animation: logoRotate 4s ease-in-out infinite;
}

@keyframes logoRotate {
    0%, 100% { transform: rotate(0deg) scale(1); }
    50% { transform: rotate(10deg) scale(1.1); }
}

.login-logo span {
    font-size: 32px; font-weight: bold;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    -webkit-background-clip: text; background-clip: text; color: transparent;
}

.login-title { 
    font-size: 28px; 
    color: #333; 
    margin-bottom: 8px; 
    font-weight: bold; 
    text-align: center;
}

.login-subtitle { 
    color: #666; 
    font-size: 16px; 
    text-align: center;
    margin-bottom: 20px;
}

.form-group { margin-bottom: 25px; position: relative; }
.form-group label {
    display: block; margin-bottom: 10px; font-weight: bold; color: #555;
    font-size: 18px;
}
.form-group input {
    width: 100%; padding: 15px 18px; border: 2px solid #ddd;
    border-radius: 12px; font-size: 18px;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    background: rgba(255,255,255,0.9);
}
.form-group input:focus {
    border-color: #6a11cb; outline: none;
    box-shadow: 0 0 0 4px rgba(106, 17, 203, 0.2);
    transform: scale(1.02);
}

.password-toggle {
    position: absolute; left: 18px; top: 52px; cursor: pointer;
    color: #6a11cb; font-size: 20px;
    transition: all 0.3s ease;
}

.password-toggle:hover {
    color: #2575fc; transform: scale(1.1);
}

.forgot-password {
    text-align: center;
    margin: 15px 0;
}

.forgot-password a {
    color: #1976D2;
    text-decoration: none;
    font-size: 16px;
    transition: color 0.3s;
}

.forgot-password a:hover {
    color: #0d47a1;
    text-decoration: underline;
}

.join-btn {
    display: block; 
    width: 100%;
    background: linear-gradient(135deg, #4CAF50 0%, #2E7D32 100%);
    color: white; 
    padding: 15px; 
    border-radius: 12px; 
    border: none;
    font-size: 18px; 
    font-weight: bold; 
    cursor: pointer;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    margin-top: 15px; 
    position: relative; 
    overflow: hidden;
    text-decoration: none;
    text-align: center;
}

.join-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: all 0.6s ease;
}

.join-btn:hover::before {
    width: 400px;
    height: 400px;
}

.join-btn:hover {
    background: linear-gradient(135deg, #2E7D32 0%, #4CAF50 100%);
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 10px 25px rgba(76, 175, 80, 0.4);
}

/* Ø­Ù‚Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª */
.remember-me {
    display: flex;
    align-items: center;
    margin-bottom: 20px;
    gap: 10px;
    cursor: pointer;
    font-size: 16px;
    color: #555;
}

.remember-me input {
    width: 18px;
    height: 18px;
    cursor: pointer;
}

.login-btn {
    display: block; width: 100%;
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white; padding: 15px; border-radius: 12px; border: none;
    font-size: 22px; font-weight: bold; cursor: pointer;
    transition: all 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    margin-top: 15px; position: relative; overflow: hidden;
}

.login-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.3);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: all 0.6s ease;
}

.login-btn:hover::before {
    width: 400px;
    height: 400px;
}

.login-btn:hover {
    background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
    transform: translateY(-3px) scale(1.02);
    box-shadow: 0 10px 25px rgba(106, 17, 203, 0.4);
}

.login-btn:disabled {
    background: #ccc; cursor: not-allowed; transform: none;
    box-shadow: none;
}

.login-message {
    margin-top: 25px; padding: 15px; border-radius: 10px;
    text-align: center; display: none; animation: fadeIn 0.6s ease;
    font-weight: bold;
    font-size: 18px;
}

.error-message {
    background: linear-gradient(135deg, #ffebee, #ffcdd2);
    color: #d32f2f; border: 2px solid #d32f2f;
}
.success-message {
    background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
    color: #388e3c; border: 2px solid #388e3c;
}

.close-btn {
    position: absolute; top: 15px; right: 15px; background: none;
    border: none; font-size: 2rem; color: #666; cursor: pointer;
    transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    width: 40px; height: 40px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
}

.close-btn:hover {
    color: #000; transform: rotate(90deg) scale(1.1);
    background: rgba(255,0,0,0.1);
}

.loading-spinner {
    display: inline-block; width: 20px; height: 20px;
    border: 3px solid rgba(255,255,255,.3); border-radius: 50%;
    border-top-color: #fff; animation: spin 1s ease-in-out infinite; margin-left: 10px;
}

/* ===== Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ===== */
.password-reset-modal {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.8); display: none; justify-content: center;
    align-items: center; z-index: 2001; backdrop-filter: blur(10px);
    animation: fadeIn 0.6s ease;
}

.password-reset-modal.show { display: flex; }

.password-reset-container {
    background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
    border-radius: 20px; padding: 30px;
    width: 90%; max-width: 450px; box-shadow: 0 20px 50px rgba(0,0,0,0.4);
    position: relative;
    animation: modalSlideIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    border: 2px solid rgba(106, 17, 203, 0.3);
    font-size: 18px;
}

.password-reset-header { text-align: center; margin-bottom: 25px; }

.password-reset-title { 
    font-size: 24px; 
    color: #333; 
    margin-bottom: 8px; 
    font-weight: bold; 
}

.password-reset-subtitle { 
    color: #666; 
    font-size: 16px; 
}

.password-reset-form .form-group {
    margin-bottom: 20px;
}

.password-reset-form input[type="tel"] {
    direction: ltr;
    text-align: left;
}

.password-reset-buttons {
    display: flex;
    gap: 15px;
    margin-top: 20px;
}

.password-reset-buttons button {
    flex: 1;
    padding: 12px;
    border-radius: 10px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    border: none;
}

.send-request-btn {
    background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
    color: white;
}

.send-request-btn:hover {
    background: linear-gradient(135deg, #2575fc 0%, #6a11cb 100%);
    transform: translateY(-2px);
}

.cancel-btn {
    background: #f5f5f5;
    color: #666;
    border: 1px solid #ddd !important;
}

.cancel-btn:hover {
    background: #e0e0e0;
    transform: translateY(-2px);
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ø¬Ø¯ÙŠØ¯Ø© Ù„Ù„Ø¹Ø¶ÙˆÙŠØ© ===== */
.btn-membership {
    background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
    color: white;
}

.btn-membership:hover {
    background: linear-gradient(135deg, #FF5722 0%, #FF9800 100%);
    transform: scale(1.05);
}

.btn-membership-card {
    background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);
}

.btn-membership-card:hover {
    background: linear-gradient(135deg, #FF5722 0%, #FF9800 100%);
}

/* ===== Ø£Ù†Ù…Ø§Ø· SweetAlert2 Ø§Ù„Ù…Ø®ØµØµØ© ===== */
.swal2-popup {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    border-radius: 20px;
}

.swal2-title {
    font-size: 24px;
    color: #333;
}

.swal2-html-container {
    font-size: 16px;
    color: #555;
}

/* ===== Ø£Ù†Ù…Ø§Ø· Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø± ===== */
.merchant-list-container {
    max-height: 300px;
    overflow-y: auto;
    margin-top: 10px;
    border: 1px solid #e0e0e0;
    border-radius: 10px;
    padding: 10px;
}

.merchant-item {
    padding: 12px;
    border-bottom: 1px solid #eee;
    cursor: pointer;
    transition: all 0.3s ease;
    border-radius: 8px;
    margin-bottom: 5px;
}

.merchant-item:hover {
    background-color: #f0f7ff;
    transform: translateX(-5px);
}

.merchant-item.selected {
    background-color: #e3f2fd;
    border-left: 4px solid #1976D2;
}

.merchant-name-display {
    font-weight: bold;
    font-size: 16px;
    color: #333;
}

.merchant-mobile-display {
    font-size: 14px;
    color: #666;
    margin-top: 5px;
}

.search-merchant-input {
    width: 100%;
    padding: 12px;
    border: 2px solid #ddd;
    border-radius: 10px;
    font-size: 16px;
    margin-bottom: 15px;
    transition: all 0.3s;
}

.search-merchant-input:focus {
    border-color: #6a11cb;
    outline: none;
    box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2);
}

@keyframes spin { to { transform: rotate(360deg); } }
@keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
@keyframes modalSlideIn {
    from { opacity: 0; transform: translateY(-100px) scale(0.5) rotate(-10deg); }
    to { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
}

/* ===== Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ù‡ÙˆØ§ØªÙ ===== */
@media (max-width: 768px) {
    .container {
        flex-direction: column;
        align-items: center;
        gap: 15px;
    }
    
    .card {
        width: 90%;
    }
    
    .back-button {
        top: 90px;
        left: 10px;
        padding: 8px 12px;
        font-size: 0.9rem;
    }
    
    .notifications-container {
        left: 10px;
        right: 10px;
        max-width: none;
    }
    
    .merchant-section {
        flex-direction: row;
        align-items: center;
        font-size: 12px;
    }
    
    .app-name {
        font-size: 16px;
    }
    
    .management-title {
        font-size: 16px;
    }
    
    body {
        padding-top: 130px;
    }
    
    .login-container {
        padding: 25px;
    }
    
    .login-title {
        font-size: 24px;
    }
    
    .login-logo i {
        font-size: 40px;
    }
    
    .login-logo span {
        font-size: 26px;
    }
    
    .password-reset-container {
        padding: 20px;
    }
    
    .password-reset-title {
        font-size: 22px;
    }
    
    .password-reset-buttons {
        flex-direction: column;
    }
    
    .welcome-container {
        padding: 20px;
    }
    
    .welcome-title {
        font-size: 24px;
    }
    
    .welcome-logo i {
        font-size: 40px;
    }
    
    .welcome-logo span {
        font-size: 26px;
    }
    
    .welcome-greeting {
        font-size: 18px;
    }
    
    .welcome-offer {
        font-size: 16px;
    }
    
    .welcome-message {
        font-size: 14px;
    }
    
    .welcome-highlight {
        font-size: 16px;
    }
    
    .welcome-conditions-title {
        font-size: 16px;
    }
    
    .welcome-conditions-list li {
        font-size: 14px;
    }
    
    .merchant-bar {
        height: 35px;
    }
    
    .merchant-name {
        font-size: 14px;
    }
    
    .merchant-list-container {
        max-height: 250px;
    }
}
</style>
</head>
<body>

<!-- Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ -->
<div class="welcome-modal" id="welcomeModal">
    <div class="welcome-container">
        <div class="welcome-header">
            <div class="welcome-logo">
                <i class="fas fa-store"></i>
                <span>AZ</span>
            </div>
            <h2 class="welcome-title">Ù…Ø±Ø­Ø¨Ø§Ù‹ Ø¨Ùƒ ÙÙŠ AZ Ø§Ù„Ø³ÙˆÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„</h2>
            <p class="welcome-subtitle">Ù„ØªÙ„Ø¨ÙŠØ© Ø§Ø­ØªÙŠØ§Ø¬Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„</p>
        </div>
        
        <div class="welcome-content">
            <div class="welcome-greeting" id="welcomeGreeting">Ø¹Ø²ÙŠØ²Ù†Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ / Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±</div>
            <div class="welcome-offer" id="welcomeOffer">Ø¹Ø±Ø¶Ù†Ø§ Ø§Ù„Ø­Ø§Ù„ÙŠ</div>
            <div class="welcome-message">Ø¨Ù…Ù†Ø§Ø³Ø¨Ø© Ø§Ù„Ø¥ÙØªØªØ§Ø­</div>
            <div class="welcome-highlight">Ø¶Ø§Ø¹Ù ÙØ±ØµØªÙƒ Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù…ØªÙŠØ§Ø²Ø§Øª ÙˆØ®ØµÙˆÙ…Ø§Øª Ø§Ø³ØªØ«Ù†Ø§Ø¦ÙŠØ©</div>
            <div class="welcome-message">Ø³ÙŠØªÙ… ØªØ±Ø´ÙŠØ­ Ù¡Ù  Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ† ( ØªØ¬Ø§Ø± ) Ù†Ù‡Ø§ÙŠØ© ÙƒÙ„ Ø´Ù‡Ø±</div>
            
            <div class="welcome-conditions">
                <div class="welcome-conditions-title">Ø´Ø±ÙˆØ· Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø§Ù…ØªÙŠØ§Ø²Ø§Øª:</div>
                <ul class="welcome-conditions-list">
                    <li>1 - Ø§Ù„Ù†Ø´Ø± Ø§Ù„Ù…Ø³ØªÙ…Ø± Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¨Ø´ÙƒÙ„ ÙŠÙˆÙ…ÙŠ Ø¯ÙˆÙ† ØªÙƒØ±Ø§Ø± Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø®Ø§Øµ Ø¨Ùƒ</li>
                    <li>2 - Ù…Ø´Ø§Ø±ÙƒØ© Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ù…Ù† Ø¯Ø§Ø®Ù„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨Ø´ÙƒÙ„ ÙŠÙˆÙ…ÙŠ Ù„Ø§Ø­Ø¯ Ù‚Ù†ÙˆØ§Øª Ø§Ù„ØªÙˆØ§ØµÙ„ Ø§Ù„Ø§Ø¬ØªÙ…Ø§Ø¹ÙŠ Ø¨Ø´ÙƒÙ„ ÙŠÙˆÙ…ÙŠ</li>
                    <li>3 - ÙˆØµÙˆÙ„ Ù†Ø³Ø¨Ø© Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ù¤Ù Ù  Ù…Ø´Ø§Ù‡Ø¯Ù‡ Ù„Ù…Ù†ØªØ¬ÙŠÙ† Ø¹Ù„Ø§ Ø§Ù„Ø£Ù‚Ù„</li>
                </ul>
            </div>
        </div>
        
        <button class="welcome-close-btn" id="welcomeCloseBtn">
            Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…
        </button>
    </div>
</div>

<!-- Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ§Ø¬Ø± -->
<div class="login-modal" id="merchantLoginModal">
    <div class="login-container">
        <button class="close-btn" id="closeMerchantLogin">
            <i class="fas fa-times"></i>
        </button>
        <div class="login-header">
            <div class="login-logo">
                <i class="fas fa-store"></i>
                <span>AZ</span>
            </div>
            <h2 class="login-title">Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¬Ø§Ø± Ù‚Ø³Ù… Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</h2>
            <p class="login-subtitle">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ…</p>
        </div>
        
        <form id="merchantLoginForm">
            <div class="form-group">
                <label for="merchantUsername">Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…</label>
                <input type="text" id="merchantUsername" name="username" required>
            </div>
            
            <div class="form-group">
                <label for="merchantPassword">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</label>
                <input type="password" id="merchantPassword" name="password" required>
                <i class="fas fa-eye password-toggle" id="toggleMerchantPassword"></i>
            </div>
            
            <!-- Ø­Ù‚Ù„ Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª -->
            <div class="remember-me">
                <input type="checkbox" id="rememberMerchant">
                <label for="rememberMerchant">Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§ØªÙŠ</label>
            </div>
            
            <button type="submit" class="login-btn" id="merchantLoginBtn">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
                <span class="loading-spinner" id="merchantLoadingSpinner" style="display: none;"></span>
            </button>
            
            <div class="forgot-password">
                <a href="#" id="forgotPasswordLink">Ù†Ø³ÙŠØª ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</a>
            </div>
            
            <a href="as.html" class="join-btn">
                Ø·Ù„Ø¨ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
            </a>
        </form>
        
        <div id="merchantLoginMessage" class="login-message"></div>
    </div>
</div>

<!-- Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± -->
<div class="password-reset-modal" id="passwordResetModal">
    <div class="password-reset-container">
        <button class="close-btn" id="closePasswordReset">
            <i class="fas fa-times"></i>
        </button>
        <div class="password-reset-header">
            <h2 class="password-reset-title">Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</h2>
            <p class="password-reset-subtitle">Ø£Ø¯Ø®Ù„ Ø¨ÙŠØ§Ù†Ø§ØªÙƒ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</p>
        </div>
        
        <form id="passwordResetForm">
            <div class="form-group">
                <label for="commercialName">Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)</label>
                <input type="text" id="commercialName" name="commercialName">
            </div>
            
            <div class="form-group">
                <label for="phoneNumber">Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ (Ø¥Ø¬Ø¨Ø§Ø±ÙŠ)</label>
                <input type="tel" id="phoneNumber" name="phoneNumber" required inputmode="numeric">
            </div>
            
            <div class="password-reset-buttons">
                <button type="submit" class="send-request-btn" id="sendRequestBtn">
                    Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨
                </button>
                <button type="button" class="cancel-btn" id="cancelPasswordReset">
                    Ø¥Ù„ØºØ§Ø¡
                </button>
            </div>
        </form>
        
        <div id="passwordResetMessage" class="login-message" style="margin-top: 15px;"></div>
    </div>
</div>

<!-- Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ø¹Ù„ÙˆÙŠ -->
<header class="top-header">
    <div class="app-info">
        <div class="app-logo" id="appLogo">
            <img src="https://github.com/e772299420-hue/Call/blob/main/icon-512x512.png?raw=true" alt="Ø´Ø¹Ø§Ø± Az Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„">
        </div>
        <div class="app-name">Az Ø§Ù„ØªØ³ÙˆÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„</div>
    </div>
    <div class="management-title">Ù„ÙˆØ­Ø© Ø§Ù„ØªØ­ÙƒÙ… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„ØªØ¬Ø§Ø±ÙŠØ©</div>
</header>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ØªØ¬Ø§Ø± -->
<div class="merchant-bar">
    <div class="merchant-name" id="user-display-name">ØªØ§Ø¬Ø±: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
</div>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„Ø¬Ù„ÙˆØ¨Ù„Ø§Øª - Ù…Ø®ÙÙŠ -->
<div class="globals-bar" id="globals-bar" style="display: none;">
    <!-- Ø³ÙŠØªÙ… Ù…Ù„Ø¡ Ù‡Ø°Ø§ Ø§Ù„Ù‚Ø³Ù… Ø¨Ø§Ù„Ø¬Ù„ÙˆØ¨Ù„Ø§Øª Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
</div>

<!-- Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª -->
<div class="notifications-container" id="notificationsContainer">
    <!-- Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù‡Ù†Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ§Ù‹ -->
</div>

<!-- Ø­Ù‚Ù„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£ØµÙ„ÙŠ (Ù…Ø®ÙÙŠ) -->
<div class="input-container">
    <div class="input-group">
        <label class="input-label" for="nam_usr_original">Ø­Ù‚Ù„ nam_usr:</label>
        <input type="text" id="nam_usr_original" class="input-field" placeholder="Ø£Ø¯Ø®Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù‡Ù†Ø§">
    </div>
    <button class="transfer-btn" onclick="transferData()">
        <i class="fas fa-exchange-alt"></i> Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ globaluser
    </button>
</div>

<!-- Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ù„Ø¨Ø·Ø§Ù‚Ø§Øª -->
<div class="container">
    <!-- Ø¨Ø·Ø§Ù‚Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© (Ø³ØªØ¸Ù‡Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ø§Ø¬Ø©) -->
    <div class="card" id="membershipCard" style="display: none;">
        <div class="card-header" style="background: linear-gradient(135deg, #FF9800 0%, #FF5722 100%);">
            <i class="fas fa-id-card"></i>
            <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©</h2>
        </div>
        <div class="card-body">
            <p>Ø£Ù†Øª ØºÙŠØ± Ù…Ø³Ø¬Ù„ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ§Øª Ø§Ù„Ù‡Ø±Ù…ÙŠØ©. Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„ØªØ³Ø¬ÙŠÙ„ Ø¹Ø¶ÙˆÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©.</p>
            <button class="btn btn-membership" id="membershipActionBtn">
                <i class="fas fa-user-plus"></i> ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
            </button>
        </div>
    </div>

    <!-- ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± -->
    <div class="card" onclick="navigateToEditMerchant()">
        <div class="card-header">
            <i class="fas fa-user-edit"></i>
            <h2>ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±</h2>
        </div>
        <div class="card-body">
            <p>ØªØ¹Ø¯ÙŠÙ„ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ø®ØµÙŠØ© ÙˆØ§Ù„Ù…ØªØ¬Ø±</p>
            <button class="btn">ÙØªØ­ Ø§Ù„ØµÙØ­Ø©</button>
        </div>
    </div>

    <!-- Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù -->
    <div class="card" onclick="navigateToCategories()">
        <div class="card-header">
            <i class="fas fa-boxes"></i>
            <h2>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù</h2>
        </div>
        <div class="card-body">
            <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£ØµÙ†Ø§Ù ÙˆØ§Ù„ØªØµÙ†ÙŠÙØ§Øª Ø§Ù„Ø®Ø§ØµØ© Ø¨Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</p>
            <button class="btn">ÙØªØ­ Ø§Ù„ØµÙØ­Ø©</button>
        </div>
    </div>

    <!-- Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª -->
    <div class="card" onclick="navigateToStatistics()">
        <div class="card-header">
            <i class="fas fa-chart-bar"></i>
            <h2>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</h2>
        </div>
        <div class="card-body">
            <p>Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª ÙˆÙ…Ù‚Ø§ÙŠÙŠØ³ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙˆØ§Ù„Ø£Ø¯Ø§Ø¡</p>
            <button class="btn">ÙØªØ­ Ø§Ù„ØµÙØ­Ø©</button>
        </div>
    </div>

    <!-- Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ§Øª Ø§Ù„Ù‡Ø±Ù…ÙŠØ© -->
    <div class="card" onclick="navigateToMembershipHierarchy()">
        <div class="card-header">
            <i class="fas fa-sitemap"></i>
            <h2>Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ§Øª Ø§Ù„Ù‡Ø±Ù…ÙŠØ©</h2>
        </div>
        <div class="card-body">
            <p>Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø±Ù…ÙŠ Ù„Ù„Ø£Ø¹Ø¶Ø§Ø¡ ÙˆØ§Ù„ØªØ¬Ø§Ø±</p>
            <button class="btn">ÙØªØ­ Ø§Ù„ØµÙØ­Ø©</button>
        </div>
    </div>

    <!-- Ø²Ø± Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯ - Ù…Ø®ÙÙŠ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ -->
    <div class="card" id="testCard" style="display: none;" onclick="navigateToTest()">
        <div class="card-header">
            <i class="fas fa-vial"></i>
            <h2>Ø§Ø®ØªØ¨Ø§Ø±</h2>
        </div>
        <div class="card-body">
            <p>ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ù„Ù„ØªØ¬Ø§Ø±Ø¨ ÙˆØ§Ù„Ù…ÙŠØ²Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©</p>
            <button class="btn">ÙØªØ­ Ø§Ù„ØµÙØ­Ø©</button>
        </div>
    </div>
</div>

<!-- Ø²Ø± Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© -->
<div class="button-container">
    <a href="#" class="home-btn" onclick="closePage()">
        <i class="fas fa-home"></i> Ø§Ù„Ø±Ø¬ÙˆØ¹ Ø¥Ù„Ù‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    </a>
</div>

<!-- Ø§Ù„ØªØ°ÙŠÙŠÙ„ -->
<footer class="footer">
    Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ Ø§Ù„Ù…Ù…ÙŠØ² Ø³ÙˆÙØª Ù„Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø© 
</footer>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

<script>
// ===== ØªÙ‡ÙŠØ¦Ø© Firebase =====
const firebaseConfig = {
    databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/"
};

const app = firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// ===== Ù†Ø¸Ø§Ù… Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª =====
const notificationSystem = {
    show: function(title, message, type = 'info', duration = 5000) {
        const notificationsContainer = document.getElementById('notificationsContainer');
        const notificationId = 'notification-' + Date.now();
        
        const notification = document.createElement('div');
        notification.className = `notification ${type}`;
        notification.id = notificationId;
        
        notification.innerHTML = `
            <div class="notification-header">
                <div class="notification-title">${title}</div>
                <button class="notification-close" onclick="notificationSystem.hide('${notificationId}')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="notification-message">${message}</div>
        `;
        
        notificationsContainer.appendChild(notification);
        
        // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡ Ù…Ø¨Ø§Ø´Ø±Ø©
        setTimeout(() => {
            notification.classList.add('show');
        }, 10);
        
        // Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ù…Ø¯Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        if (duration > 0) {
            setTimeout(() => {
                this.hide(notificationId);
            }, duration);
        }
        
        return notificationId;
    },
    
    hide: function(notificationId) {
        const notification = document.getElementById(notificationId);
        if (notification) {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        }
    },
    
    hideAll: function() {
        const notifications = document.querySelectorAll('.notification');
        notifications.forEach(notification => {
            notification.classList.remove('show');
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 300);
        });
    }
};

// ===== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¹Ø§Ù… Ø§Ù„Ù…Ø­Ø³Ù† =====
const globalUser = {
    data: null,
    
    setUserData: function(userData) {
        this.data = userData;
        // Ø§Ø³ØªØ®Ø¯Ø§Ù… sessionStorage Ù„Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø¤Ù‚Øª
        sessionStorage.setItem('globalUserData', JSON.stringify(userData));
        console.log('âœ… ØªÙ… ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ Ø§Ù„Ø¬Ù„Ø³Ø©:', userData);
        updateUserDisplay();
    },
    
    getUserData: function() {
        if (this.data) return this.data;
        
        // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ sessionStorage Ø£ÙˆÙ„Ø§Ù‹
        const storedData = sessionStorage.getItem('globalUserData');
        if (storedData) {
            this.data = JSON.parse(storedData);
            return this.data;
        }
        
        return null;
    },
    
    getUsername: function() {
        const userData = this.getUserData();
        return userData ? userData.username : 'Ø²Ø§Ø¦Ø±';
    },
    
    getUserId: function() {
        const userData = this.getUserData();
        return userData ? userData.id : null;
    },
    
    isLoggedIn: function() {
        return this.getUserData() !== null;
    },
    
    logout: function() {
        this.data = null;
        sessionStorage.removeItem('globalUserData');
        console.log('ğŸšª ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬');
        updateUserDisplay();
    }
};

// ===== Ù†Ø¸Ø§Ù… ØªØ®Ø²ÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„ =====
const merchantGlobal = {
    setMerchantName: function(name) {
        sessionStorage.setItem('merchantName', name);
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„:', name);
    },
    
    getMerchantName: function() {
        return sessionStorage.getItem('merchantName') || '';
    },
    
    setMerchantPhone: function(phone) {
        sessionStorage.setItem('merchantPhone', phone);
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ø±Ù‚Ù… Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„:', phone);
    },
    
    getMerchantPhone: function() {
        return sessionStorage.getItem('merchantPhone') || '';
    },
    
    setMerchantId: function(merchantId) {
        sessionStorage.setItem('merchantId', merchantId);
        console.log('âœ… ØªÙ… Ø­ÙØ¸ Ù…Ø¹Ø±Ù Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„:', merchantId);
    },
    
    getMerchantId: function() {
        return sessionStorage.getItem('merchantId') || '';
    },
    
    saveForNavigation: function() {
        const userData = globalUser.getUserData();
        if (userData) {
            localStorage.setItem('merchantDataForNavigation', JSON.stringify({
                name: userData.name,
                username: userData.username,
                commercialName: userData.commercialName,
                id: userData.id,
                phone: userData.mobile,
                timestamp: Date.now()
            }));
            console.log('ğŸ’¾ ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¨ÙŠÙ† Ø§Ù„ØµÙØ­Ø§Øª');
        }
    },
    
    clearAllData: function() {
        sessionStorage.removeItem('merchantName');
        sessionStorage.removeItem('merchantPhone');
        sessionStorage.removeItem('merchantId');
        localStorage.removeItem('merchantDataForNavigation');
        console.log('ğŸ—‘ï¸ ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ù…Ù† Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„');
    }
};

// ===== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ø¹Ù†Ø¯ Ø§Ù„Ø®Ø±ÙˆØ¬ =====
const merchantExitManager = {
    saveDataForNavigation: function() {
        if (globalUser.isLoggedIn()) {
            merchantGlobal.saveForNavigation();
            return true;
        }
        return false;
    },
    
    restoreDataOnPageLoad: function() {
        const savedData = localStorage.getItem('merchantDataForNavigation');
        if (savedData) {
            try {
                const merchantData = JSON.parse(savedData);
                const now = Date.now();
                const dataAge = now - merchantData.timestamp;
                
                if (dataAge < 5 * 60 * 1000) {
                    console.log('ğŸ”„ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©:', merchantData);
                    
                    merchantGlobal.setMerchantName(merchantData.commercialName || merchantData.name);
                    merchantGlobal.setMerchantId(merchantData.id);
                    
                    const userData = {
                        id: merchantData.id,
                        username: merchantData.username,
                        name: merchantData.name,
                        commercialName: merchantData.commercialName,
                        type: 'merchant'
                    };
                    globalUser.setUserData(userData);
                    
                    return true;
                } else {
                    console.log('ğŸ—‘ï¸ Ø­Ø°Ù Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø©');
                    localStorage.removeItem('merchantDataForNavigation');
                }
            } catch (error) {
                console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ø³ØªØ¹Ø§Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±:', error);
                localStorage.removeItem('merchantDataForNavigation');
            }
        }
        return false;
    }
};

// ===== Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ§Øª Ø§Ù„Ù‡Ø±Ù…ÙŠØ© Ø§Ù„Ù…Ø­Ø³Ù‘Ù† Ù„Ø¯Ø¹Ù… Ù…Ù„ÙŠÙˆÙ† Ù…Ø³ØªÙˆÙ‰ =====
const membershipManager = {
    currentMerchantData: null,
    currentMerchantId: null,
    
    // ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
    setCurrentMerchant: function(merchantData, merchantId) {
        this.currentMerchantData = merchantData;
        this.currentMerchantId = merchantId;
        console.log('ğŸ‘¤ ØªÙ… ØªØ¹ÙŠÙŠÙ† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ:', merchantData.name || merchantData.username);
    },
    
    // Ø¯Ø§Ù„Ø© ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
    normalizeNumbers: function(text) {
        if (!text) return '';
        const arabicNumbers = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
        const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
        
        let normalized = text.toString();
        for (let i = 0; i < arabicNumbers.length; i++) {
            const regex = new RegExp(arabicNumbers[i], 'g');
            normalized = normalized.replace(regex, englishNumbers[i]);
        }
        
        return normalized.replace(/[^\d+]/g, '');
    },
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„
    validateMobile: function(mobile) {
        if (!mobile) return false;
        
        const cleanMobile = this.normalizeNumbers(mobile);
        
        if (cleanMobile.length < 9 || cleanMobile.length > 15) {
            return false;
        }
        
        return cleanMobile;
    },
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ø¶ÙˆÙŠØ© Ù„Ù„ØªØ§Ø¬Ø±
    async checkMerchantMembership(mobile) {
        try {
            const cleanMobile = this.validateMobile(mobile);
            if (!cleanMobile) {
                return { isMember: false, message: 'Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ§Ù„Ø­' };
            }
            
            const membershipsSnapshot = await database.ref('membership_hierarchy').once('value');
            const memberships = membershipsSnapshot.val();
            
            if (!memberships) {
                return { isMember: false, message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø¶ÙˆÙŠØ© Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…' };
            }
            
            let membershipData = null;
            let membershipId = null;
            
            Object.keys(memberships).forEach(key => {
                const membership = memberships[key];
                if (membership.mobile && this.validateMobile(membership.mobile) === cleanMobile) {
                    membershipData = membership;
                    membershipId = key;
                }
            });
            
            if (!membershipData) {
                return { isMember: false, message: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¹Ø¶ÙˆÙŠØ© Ù…Ø³Ø¬Ù„Ø© Ù„Ù‡Ø°Ø§ Ø§Ù„ØªØ§Ø¬Ø±' };
            }
            
            return {
                isMember: true,
                membership: membershipData,
                id: membershipId,
                mobile: cleanMobile
            };
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:', error);
            return { isMember: false, message: `Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚: ${error.message}` };
        }
    },
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‡Ø±Ù…ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„
    async getFullHierarchyPath(membershipId) {
        try {
            if (!membershipId) return '';
            
            let path = '';
            let currentId = membershipId;
            const maxDepth = 100; // Ø­Ø¯ Ø£Ù‚ØµÙ‰ Ù„Ù„Ø¹Ù…Ù‚ Ù„Ù…Ù†Ø¹ Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠØ©
            
            for (let depth = 0; depth < maxDepth; depth++) {
                const snapshot = await database.ref(`membership_hierarchy/${currentId}`).once('value');
                const data = snapshot.val();
                
                if (!data) break;
                
                // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø±
                path = data.mobile + (path ? '/' + path : '');
                
                // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ø£Ø¨ØŒ ØªÙˆÙ‚Ù
                if (!data.parentId || data.parentId === currentId) break;
                
                currentId = data.parentId;
            }
            
            return path;
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‡Ø±Ù…ÙŠ:', error);
            return '';
        }
    },
    
    // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‡Ø±Ù…ÙŠ
    calculateLevelFromPath(path) {
        if (!path) return 0;
        const segments = path.split('/');
        return segments.length - 1; // Ù„Ø£Ù† Ø§Ù„Ù…Ø³Ø§Ø± ÙŠØ¨Ø¯Ø£ Ø¨Ø§Ù„Ù…Ø¤Ø³Ø³ ÙˆÙŠÙ†ØªÙ‡ÙŠ Ø¨Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø­Ø§Ù„ÙŠ
    },
    
    // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¶ÙˆÙŠØ© Ø¬Ø¯ÙŠØ¯Ø© Ù…Ø¹ Ø¯Ø¹Ù… ØªØ³Ù„Ø³Ù„ Ù‡Ø±Ù…ÙŠ ØºÙŠØ± Ù…Ø­Ø¯ÙˆØ¯
    async createMembership(merchantData, merchantId, parentMobile = null) {
        try {
            const mobile = this.validateMobile(merchantData.mobile);
            if (!mobile) {
                throw new Error('Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„ ØºÙŠØ± ØµØ§Ù„Ø­');
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ø¹Ø¶ÙˆÙŠØ© Ù…Ø³Ø¨Ù‚Ø©
            const existingCheck = await this.checkMerchantMembership(mobile);
            if (existingCheck.isMember) {
                return {
                    success: false,
                    message: 'Ø§Ù„ØªØ§Ø¬Ø± Ù„Ø¯ÙŠÙ‡ Ø¹Ø¶ÙˆÙŠØ© Ù…Ø³Ø¨Ù‚Ø©',
                    membershipId: existingCheck.id
                };
            }
            
            let membershipLevel = 0;
            let parentId = null;
            let hierarchyPath = mobile;
            let parentHierarchyPath = '';
            
            // Ø¥Ø°Ø§ ØªÙ… ØªÙˆÙÙŠØ± Ø£Ø¨ØŒ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù†Ù‡
            if (parentMobile) {
                const cleanParentMobile = this.validateMobile(parentMobile);
                if (cleanParentMobile) {
                    const parentCheck = await this.checkMerchantMembership(cleanParentMobile);
                    if (parentCheck.isMember) {
                        parentId = parentCheck.id;
                        
                        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‡Ø±Ù…ÙŠ Ù„Ù„Ø£Ø¨
                        parentHierarchyPath = await this.getFullHierarchyPath(parentId);
                        
                        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù…Ø³Ø§Ø± Ø§Ù„Ø£Ø¨
                        if (parentHierarchyPath) {
                            membershipLevel = this.calculateLevelFromPath(parentHierarchyPath) + 1;
                            hierarchyPath = `${parentHierarchyPath}/${mobile}`;
                        } else {
                            // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù‡Ù†Ø§Ùƒ Ù…Ø³Ø§Ø±ØŒ Ø§Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ Ù…Ø¨Ø§Ø´Ø±Ø©
                            membershipLevel = parentCheck.membership.membershipLevel + 1;
                        }
                        
                        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø³ØªÙˆÙ‰ (ÙŠÙ…ÙƒÙ† Ø²ÙŠØ§Ø¯Ø© Ø¥Ù„Ù‰ Ù…Ù„ÙŠÙˆÙ† Ø£Ùˆ Ø£ÙƒØ«Ø±)
                        const MAX_LEVEL = 1000000; // Ù…Ù„ÙŠÙˆÙ† Ù…Ø³ØªÙˆÙ‰
                        if (membershipLevel > MAX_LEVEL) {
                            return {
                                success: false,
                                message: `ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø¯ Ø§Ù„Ø£Ù‚ØµÙ‰ Ù„Ù„Ù…Ø³ØªÙˆÙŠØ§Øª (${MAX_LEVEL})`
                            };
                        }
                    } else {
                        return {
                            success: false,
                            message: 'Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø±Ù…ÙŠ'
                        };
                    }
                }
            }
            
            // Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ù…Ø¹ Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‡Ø±Ù…ÙŠ Ø§Ù„ÙƒØ§Ù…Ù„
            const membershipData = {
                mobile: mobile,
                merchantId: merchantId,
                name: merchantData.name || merchantData.username || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                username: merchantData.username || 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ',
                joinDate: new Date().toISOString(),
                membershipLevel: membershipLevel,
                membershipRank: 'Ø¹Ø§Ø¯ÙŠ',
                points: 0,
                directChildren: {},
                parentId: parentId,
                parentMobile: parentMobile,
                commissionRate: 0,
                status: 'active',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                hierarchyPath: hierarchyPath,
                isFounder: membershipLevel === 0,
                // Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ù„Ù„Ø´Ø¨ÙƒØ©
                totalDescendants: 0, // Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­ÙØ§Ø¯
                directDescendants: 0, // Ø§Ù„Ø£Ø­ÙØ§Ø¯ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±ÙŠÙ† ÙÙ‚Ø·
                networkDepth: membershipLevel // Ø¹Ù…Ù‚ Ø§Ù„Ø´Ø¨ÙƒØ© Ù…Ù† Ù‡Ø°Ø§ Ø§Ù„Ø¹Ø¶Ùˆ
            };
            
            const newMembershipRef = database.ref('membership_hierarchy').push();
            await newMembershipRef.set(membershipData);
            
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ù„Ù‡ Ø£Ø¨ØŒ ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¨
            if (parentId) {
                // ØªØ­Ø¯ÙŠØ« Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±ÙŠÙ† Ù„Ù„Ø£Ø¨
                const parentMembershipRef = database.ref(`membership_hierarchy/${parentId}/directChildren`);
                await parentMembershipRef.child(newMembershipRef.key).set({
                    name: membershipData.name,
                    mobile: mobile,
                    joinDate: new Date().toISOString(),
                    level: membershipLevel
                });
                
                // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¨
                await this.updateParentStatistics(parentId);
            }
            
            // ØªØ³Ø¬ÙŠÙ„ Ø³Ø¬Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
            await this.logMembershipCreation(mobile, merchantData.name, membershipLevel, parentMobile);
            
            return {
                success: true,
                message: 'ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø¨Ù†Ø¬Ø§Ø­',
                membershipId: newMembershipRef.key,
                membershipData: membershipData,
                hierarchyPath: hierarchyPath,
                level: membershipLevel
            };
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:', error);
            return {
                success: false,
                message: `Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©: ${error.message}`
            };
        }
    },
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¨ Ø¨Ø¹Ø¯ Ø¥Ø¶Ø§ÙØ© Ø§Ø¨Ù† Ø¬Ø¯ÙŠØ¯
    async updateParentStatistics(parentId) {
        try {
            const parentRef = database.ref(`membership_hierarchy/${parentId}`);
            const snapshot = await parentRef.once('value');
            const parentData = snapshot.val();
            
            if (!parentData) return;
            
            // Ø­Ø³Ø§Ø¨ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ø¨Ù†Ø§Ø¡ Ø§Ù„Ù…Ø¨Ø§Ø´Ø±ÙŠÙ†
            const directChildrenCount = Object.keys(parentData.directChildren || {}).length;
            
            // ØªØ­Ø¯ÙŠØ« Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¨
            await parentRef.update({
                directDescendants: directChildrenCount,
                updatedAt: new Date().toISOString()
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù„Ø§Ù
            await this.updateAncestorsStatistics(parentId);
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø¨:', error);
        }
    },
    
    // ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø³Ù„Ø§Ù
    async updateAncestorsStatistics(memberId) {
        try {
            let currentId = memberId;
            const maxIterations = 100; // Ù„Ù…Ù†Ø¹ Ø§Ù„Ø­Ù„Ù‚Ø§Øª Ø§Ù„Ù„Ø§Ù†Ù‡Ø§Ø¦ÙŠØ©
            
            for (let i = 0; i < maxIterations; i++) {
                const snapshot = await database.ref(`membership_hierarchy/${currentId}`).once('value');
                const data = snapshot.val();
                
                if (!data || !data.parentId) break;
                
                // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ù„Ù„Ø£Ø­ÙØ§Ø¯ Ù„ÙƒÙ„ Ø³Ù„Ù
                const ancestorRef = database.ref(`membership_hierarchy/${data.parentId}`);
                const ancestorSnapshot = await ancestorRef.once('value');
                const ancestorData = ancestorSnapshot.val();
                
                if (ancestorData) {
                    // ÙŠÙ…ÙƒÙ†Ùƒ Ù‡Ù†Ø§ Ø¥Ø¶Ø§ÙØ© Ù…Ù†Ø·Ù‚ Ù„Ø­Ø³Ø§Ø¨ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø­ÙØ§Ø¯
                    await ancestorRef.update({
                        updatedAt: new Date().toISOString()
                    });
                }
                
                currentId = data.parentId;
            }
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø£Ø³Ù„Ø§Ù:', error);
        }
    },
    
    // ØªØ³Ø¬ÙŠÙ„ Ø³Ø¬Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
    async logMembershipCreation(mobile, name, level, parentMobile) {
        try {
            const logData = {
                mobile: mobile,
                name: name,
                level: level,
                parentMobile: parentMobile || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯',
                timestamp: new Date().toISOString(),
                date: new Date().toLocaleDateString('ar-SA'),
                time: new Date().toLocaleTimeString('ar-SA')
            };
            
            await database.ref('membership_logs').push(logData);
            console.log('ğŸ“ ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø³Ø¬Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:', logData);
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:', error);
        }
    },
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø£Ø­ÙØ§Ø¯ (Ù„Ø£ÙŠ Ù…Ø³ØªÙˆÙ‰)
    async getAllDescendants(memberId, maxDepth = 100) {
        try {
            const descendants = [];
            const queue = [{ id: memberId, depth: 0 }];
            
            while (queue.length > 0) {
                const { id, depth } = queue.shift();
                
                if (depth >= maxDepth) continue;
                
                const snapshot = await database.ref(`membership_hierarchy/${id}`).once('value');
                const member = snapshot.val();
                
                if (member && member.directChildren) {
                    const childrenIds = Object.keys(member.directChildren);
                    
                    for (const childId of childrenIds) {
                        const childSnapshot = await database.ref(`membership_hierarchy/${childId}`).once('value');
                        const child = childSnapshot.val();
                        
                        if (child) {
                            descendants.push({
                                id: childId,
                                ...child,
                                relativeDepth: depth + 1
                            });
                            
                            queue.push({ id: childId, depth: depth + 1 });
                        }
                    }
                }
            }
            
            return descendants;
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ø­ÙØ§Ø¯:', error);
            return [];
        }
    },
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø£Ø¨ Ø±Ø¦ÙŠØ³ÙŠ
    async checkParentMembership(membershipId) {
        try {
            if (!membershipId) return null;
            
            const membershipSnapshot = await database.ref(`membership_hierarchy/${membershipId}`).once('value');
            const membership = membershipSnapshot.val();
            
            if (membership && membership.parentId) {
                const parentSnapshot = await database.ref(`membership_hierarchy/${membership.parentId}`).once('value');
                return parentSnapshot.val();
            }
            return null;
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø£Ø¨:', error);
            return null;
        }
    },
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø§Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø±Ù…ÙŠ
    async getHierarchyMembers() {
        try {
            const membershipsSnapshot = await database.ref('membership_hierarchy').once('value');
            const memberships = membershipsSnapshot.val();
            
            if (!memberships) {
                return [];
            }
            
            const memberMobiles = new Set();
            Object.values(memberships).forEach(member => {
                if (member.mobile) {
                    const cleanMobile = this.validateMobile(member.mobile);
                    if (cleanMobile) {
                        memberMobiles.add(cleanMobile);
                    }
                }
            });
            
            return Array.from(memberMobiles);
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡:', error);
            return [];
        }
    },
    
    // Ø¹Ø±Ø¶ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù„Ø¯ÙŠÙ‡ Ø£Ø¨
    async displayMembershipCard() {
        const currentMerchant = this.currentMerchantData;
        const merchantId = this.currentMerchantId;
        
        if (!currentMerchant || !merchantId) return;
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ø¶ÙˆÙŠØ©
        const membershipCheck = await this.checkMerchantMembership(currentMerchant.mobile);
        
        if (membershipCheck.isMember) {
            const parent = await this.checkParentMembership(membershipCheck.id);
            if (!parent) {
                console.log('âœ… Ø§Ù„ØªØ§Ø¬Ø± Ù„Ø¯ÙŠÙ‡ Ø¹Ø¶ÙˆÙŠØ© Ù…Ø¤Ø³Ø³Ø©');
                return;
            }
            console.log('âœ… Ø§Ù„ØªØ§Ø¬Ø± Ù„Ø¯ÙŠÙ‡ Ø¹Ø¶ÙˆÙŠØ© ØªØ§Ø¨Ø¹Ø©');
            return;
        }
        
        // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¹Ø¶ÙˆÙŠØ©ØŒ Ø¹Ø±Ø¶ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©
        const membershipCard = document.getElementById('membershipCard');
        if (membershipCard) {
            membershipCard.style.display = 'block';
            
            const membershipBtn = document.getElementById('membershipActionBtn');
            if (membershipBtn) {
                membershipBtn.onclick = () => this.showMembershipNotification();
            }
        }
    },
    
    // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø§Ø®ØªÙŠØ§Ø± Ù†ÙˆØ¹ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©
    showMembershipNotification() {
        const merchantName = this.currentMerchantData ? 
            (this.currentMerchantData.commercialName || this.currentMerchantData.name || this.currentMerchantData.username) : 
            'Ø§Ù„ØªØ§Ø¬Ø±';
        
        Swal.fire({
            title: `Ø¹Ø²ÙŠØ²Ù†Ø§ Ø§Ù„ØªØ§Ø¬Ø± ${merchantName}`,
            html: `
                <div style="text-align: center; padding: 15px;">
                    <i class="fas fa-id-card" style="font-size: 50px; color: #FF9800; margin-bottom: 15px;"></i>
                    <p style="font-size: 16px; margin-bottom: 20px; line-height: 1.6;">
                        <strong>Ø¨Ù…Ø§ Ø£Ù†Ùƒ Ù„Ù… ØªÙ‚Ù… Ø¨Ø§Ù„ØªØ³Ø¬ÙŠÙ„ ÙÙŠ Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ§Øª Ø§Ù„Ù‡Ø±Ù…ÙŠØ©</strong><br>
                        Ù‡Ù„ ØªØ±ØºØ¨ Ø¨Ø£Ù† ØªÙƒÙˆÙ† Ø¹Ø¶ÙˆÙŠØªÙƒ Ø±Ø¦ÙŠØ³ÙŠØ© Ø£Ù… ØªØ±ØºØ¨ Ø¨Ø£Ù† ØªÙƒÙˆÙ† Ø¹Ø¶ÙˆÙŠØªÙƒ ÙØ±Ø¹ÙŠØ© ØªØ§Ø¨Ø¹Ø© Ù„Ø£Ø­Ø¯ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ØŸ
                    </p>
                </div>
            `,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: '<i class="fas fa-crown"></i> Ø¹Ø¶Ùˆ Ø±Ø¦ÙŠØ³ÙŠ',
            cancelButtonText: '<i class="fas fa-users"></i> Ù…Ù† Ù‚Ø¨Ù„ Ø¹Ø¶Ùˆ Ø³Ø§Ø¨Ù‚',
            showDenyButton: true,
            denyButtonText: '<i class="fas fa-times"></i> ØªØ±Ø§Ø¬Ø¹',
            reverseButtons: true,
            customClass: {
                confirmButton: 'btn-membership-card',
                cancelButton: 'btn-primary',
                denyButton: 'btn-secondary'
            },
            buttonsStyling: true,
            width: 500
        }).then((result) => {
            if (result.isConfirmed) {
                this.confirmFounderMembership();
            } else if (result.dismiss === Swal.DismissReason.cancel) {
                this.showParentSelection();
            } else if (result.isDenied) {
                Swal.fire({
                    title: 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡',
                    text: 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø¨Ù†Ø¬Ø§Ø­',
                    icon: 'info',
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        });
    },
    
    // ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
    async confirmFounderMembership() {
        Swal.fire({
            title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©',
            html: `
                <div style="text-align: center; padding: 15px;">
                    <i class="fas fa-exclamation-triangle" style="font-size: 50px; color: #FF9800; margin-bottom: 15px;"></i>
                    <p style="font-size: 16px; margin-bottom: 20px; line-height: 1.6;">
                        <strong>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø¨Ø£Ù†Ùƒ ØºÙŠØ± Ù…Ø¶Ø§Ù Ù…Ù† Ø£ÙŠ Ø¹Ø¶Ùˆ (ØªØ§Ø¬Ø±)ØŸ</strong><br>
                        Ø¥Ø°Ø§ Ø§Ø®ØªØ±Øª Ù†Ø¹Ù…ØŒ Ø³ÙŠØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ø¶ÙˆÙŠØ© Ø±Ø¦ÙŠØ³ÙŠØ© Ù„Ùƒ
                    </p>
                </div>
            `,
            icon: 'warning',
            showCancelButton: true,
            confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ù…ØªØ£ÙƒØ¯',
            cancelButtonText: 'ØªØ±Ø§Ø¬Ø¹',
            customClass: {
                confirmButton: 'btn-success',
                cancelButton: 'btn-secondary'
            }
        }).then(async (result) => {
            if (result.isConfirmed) {
                try {
                    const membershipResult = await this.createMembership(
                        this.currentMerchantData, 
                        this.currentMerchantId
                    );
                    
                    if (membershipResult.success) {
                        Swal.fire({
                            title: 'Ù†Ø¬Ø§Ø­',
                            html: `
                                <div style="text-align: center;">
                                    <i class="fas fa-check-circle" style="font-size: 60px; color: #4CAF50; margin-bottom: 20px;"></i>
                                    <p style="font-size: 18px; margin-bottom: 10px;">ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</p>
                                    <p style="font-size: 16px; color: #666; margin-bottom: 5px;"><strong>Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</strong> ${membershipResult.level}</p>
                                    <p style="font-size: 16px; color: #666;"><strong>Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‡Ø±Ù…ÙŠ:</strong> ${membershipResult.hierarchyPath}</p>
                                </div>
                            `,
                            icon: 'success',
                            timer: 3000,
                            showConfirmButton: false
                        });
                        
                        const membershipCard = document.getElementById('membershipCard');
                        if (membershipCard) {
                            membershipCard.style.display = 'none';
                        }
                    } else {
                        Swal.fire({
                            title: 'Ø®Ø·Ø£',
                            text: membershipResult.message,
                            icon: 'error',
                            timer: 3000
                        });
                    }
                } catch (error) {
                    Swal.fire({
                        title: 'Ø®Ø·Ø£',
                        text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©',
                        icon: 'error',
                        timer: 3000
                    });
                }
            } else {
                Swal.fire({
                    title: 'ØªÙ… Ø§Ù„Ø¥Ù„ØºØ§Ø¡',
                    text: 'ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø¨Ù†Ø¬Ø§Ø­',
                    icon: 'info',
                    timer: 2000,
                    showConfirmButton: false
                });
            }
        });
    },
    
    // Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø± Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± ÙƒØ¹Ø¶Ùˆ Ø±Ø¦ÙŠØ³ÙŠ
    async showParentSelection() {
        try {
            const merchantsSnapshot = await database.ref('merchants').once('value');
            const merchants = merchantsSnapshot.val();
            
            if (!merchants) {
                Swal.fire({
                    title: 'Ø®Ø·Ø£',
                    text: 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¬Ø§Ø± ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù…',
                    icon: 'error',
                    timer: 3000
                });
                return;
            }
            
            const hierarchyMembers = await this.getHierarchyMembers();
            
            if (hierarchyMembers.length === 0) {
                Swal.fire({
                    title: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ†',
                    text: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø±Ù…ÙŠ Ù„Ù„Ø§Ø®ØªÙŠØ§Ø± Ù…Ù†Ù‡Ù…',
                    icon: 'info',
                    timer: 3000
                });
                return;
            }
            
            // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø¹ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø¥Ø¶Ø§ÙÙŠØ©
            const activeMerchants = await Promise.all(
                Object.entries(merchants)
                    .filter(([key, merchant]) => {
                        if (key === this.currentMerchantId) return false;
                        if (merchant.status !== 'active') return false;
                        if (!merchant.mobile) return false;
                        
                        const cleanMobile = this.validateMobile(merchant.mobile);
                        if (!cleanMobile) return false;
                        
                        return hierarchyMembers.includes(cleanMobile);
                    })
                    .map(async ([key, merchant]) => {
                        const cleanMobile = this.validateMobile(merchant.mobile);
                        const membershipCheck = await this.checkMerchantMembership(cleanMobile);
                        
                        return {
                            id: key,
                            name: merchant.commercialName || merchant.name || merchant.username,
                            mobile: merchant.mobile,
                            username: merchant.username,
                            cleanMobile: cleanMobile,
                            membershipLevel: membershipCheck.isMember ? membershipCheck.membership.membershipLevel : 0,
                            totalDescendants: membershipCheck.isMember ? (membershipCheck.membership.totalDescendants || 0) : 0,
                            joinDate: membershipCheck.isMember ? membershipCheck.membership.joinDate : null
                        };
                    })
            );
            
            if (activeMerchants.length === 0) {
                Swal.fire({
                    title: 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø¹Ø¶Ø§Ø¡ Ù…Ø³Ø¬Ù„ÙŠÙ†',
                    text: 'Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¬Ø§Ø± Ù†Ø´Ø·ÙŠÙ† Ù…Ø³Ø¬Ù„ÙŠÙ† ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø±Ù…ÙŠ',
                    icon: 'info',
                    timer: 3000
                });
                return;
            }
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡ Ø­Ø³Ø¨ Ø§Ù„Ù…Ø³ØªÙˆÙ‰ ÙˆØ¹Ø¯Ø¯ Ø§Ù„Ø£Ø­ÙØ§Ø¯
            activeMerchants.sort((a, b) => {
                if (b.membershipLevel !== a.membershipLevel) {
                    return a.membershipLevel - b.membershipLevel; // Ø§Ù„Ø£Ù‚Ù„ Ù…Ø³ØªÙˆÙ‰ Ø£ÙˆÙ„Ø§Ù‹
                }
                return b.totalDescendants - a.totalDescendants; // Ø§Ù„Ø£ÙƒØ«Ø± Ø£Ø­ÙØ§Ø¯Ø§Ù‹ Ø£ÙˆÙ„Ø§Ù‹
            });
            
            let merchantsList = '';
            activeMerchants.forEach((merchant, index) => {
                const joinDate = merchant.joinDate ? new Date(merchant.joinDate).toLocaleDateString('ar-SA') : 'ØºÙŠØ± Ù…Ø¹Ø±ÙˆÙ';
                merchantsList += `
                    <div class="merchant-item" data-id="${merchant.id}" data-mobile="${merchant.mobile}" 
                         onclick="selectMerchantItem(this)">
                        <div class="merchant-name-display">${index + 1}. ${merchant.name}</div>
                        <div class="merchant-mobile-display">
                            <span>ğŸ“± ${merchant.mobile}</span> | 
                            <span>ğŸ“Š Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${merchant.membershipLevel}</span> | 
                            <span>ğŸ‘¥ Ø§Ù„Ø£Ø­ÙØ§Ø¯: ${merchant.totalDescendants}</span> | 
                            <span>ğŸ“… ${joinDate}</span>
                        </div>
                    </div>
                `;
            });
            
            Swal.fire({
                title: 'Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ',
                html: `
                    <div style="text-align: right; margin-bottom: 15px;">
                        <p style="font-size: 14px; color: #666; margin-bottom: 10px;">
                            Ø£Ø¯Ø®Ù„ Ø§Ø³Ù… Ø§Ù„Ø¹Ø¶Ùˆ (Ø§Ù„ØªØ§Ø¬Ø±) Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù‡Ø±Ù…ÙŠ Ø§Ù„Ø°ÙŠ ØªØ±ØºØ¨ Ø¨Ø§Ù„Ø§Ù†ØªØ³Ø§Ø¨ Ø¥Ù„ÙŠÙ‡
                        </p>
                        <input type="text" id="searchMerchant" class="search-merchant-input" 
                               placeholder="Ø§Ø¨Ø­Ø« Ø¨Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± Ø£Ùˆ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„...">
                    </div>
                    <div class="merchant-list-container" id="merchantsList">
                        ${merchantsList}
                    </div>
                    <input type="hidden" id="selectedMerchantId">
                    <input type="hidden" id="selectedMerchantMobile">
                `,
                showCancelButton: true,
                confirmButtonText: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±',
                cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡',
                width: 700,
                didOpen: () => {
                    const searchInput = document.getElementById('searchMerchant');
                    const merchantItems = document.querySelectorAll('.merchant-item');
                    
                    searchInput.addEventListener('input', function() {
                        const searchTerm = this.normalizeSearchText(this.value);
                        merchantItems.forEach(item => {
                            const merchantName = item.querySelector('.merchant-name-display').textContent;
                            const merchantMobile = item.querySelector('.merchant-mobile-display').textContent;
                            const normalizedName = this.normalizeSearchText(merchantName);
                            const normalizedMobile = this.normalizeSearchText(merchantMobile);
                            item.style.display = normalizedName.includes(searchTerm) || normalizedMobile.includes(searchTerm) ? 'block' : 'none';
                        });
                    });
                    
                    searchInput.normalizeSearchText = function(text) {
                        if (!text) return '';
                        const arabicNumbers = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
                        const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
                        
                        let normalized = text.toString().toLowerCase();
                        for (let i = 0; i < arabicNumbers.length; i++) {
                            const regex = new RegExp(arabicNumbers[i], 'g');
                            normalized = normalized.replace(regex, englishNumbers[i]);
                        }
                        return normalized;
                    };
                },
                preConfirm: () => {
                    const selectedId = document.getElementById('selectedMerchantId').value;
                    const selectedMobile = document.getElementById('selectedMerchantMobile').value;
                    
                    if (!selectedId) {
                        Swal.showValidationMessage('ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ØªØ§Ø¬Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©');
                        return false;
                    }
                    
                    return { id: selectedId, mobile: selectedMobile };
                }
            }).then(async (result) => {
                if (result.isConfirmed && result.value) {
                    const { id: parentId, mobile: parentMobile } = result.value;
                    
                    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø¹Ø¶Ùˆ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ Ø§Ù„Ù…Ø®ØªØ§Ø±
                    const parentCheck = await this.checkMerchantMembership(parentMobile);
                    
                    Swal.fire({
                        title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…',
                        html: `
                            <div style="text-align: center; padding: 15px;">
                                <i class="fas fa-link" style="font-size: 50px; color: #2196F3; margin-bottom: 15px;"></i>
                                <p style="font-size: 16px; margin-bottom: 20px; line-height: 1.6;">
                                    <strong>Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù… ØªØ­Øª:</strong><br>
                                    ${parentCheck.membership.name} (Ø§Ù„Ù…Ø³ØªÙˆÙ‰: ${parentCheck.membership.membershipLevel})<br>
                                    <span style="color: #666; font-size: 14px;">Ø³ÙŠØªÙ… Ø¥Ø¶Ø§ÙØªÙƒ ÙƒÙ…Ø³ØªÙˆÙ‰ ${parentCheck.membership.membershipLevel + 1}</span>
                                </p>
                            </div>
                        `,
                        icon: 'question',
                        showCancelButton: true,
                        confirmButtonText: 'Ù†Ø¹Ù…ØŒ ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…',
                        cancelButtonText: 'ØªØ±Ø§Ø¬Ø¹'
                    }).then(async (confirmResult) => {
                        if (confirmResult.isConfirmed) {
                            try {
                                const membershipResult = await this.createMembership(
                                    this.currentMerchantData, 
                                    this.currentMerchantId, 
                                    parentMobile
                                );
                                
                                if (membershipResult.success) {
                                    Swal.fire({
                                        title: 'Ù†Ø¬Ø§Ø­',
                                        html: `
                                            <div style="text-align: center;">
                                                <i class="fas fa-network-wired" style="font-size: 60px; color: #4CAF50; margin-bottom: 20px;"></i>
                                                <p style="font-size: 18px; margin-bottom: 10px;">ØªÙ… Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„ÙØ±Ø¹ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­</p>
                                                <p style="font-size: 16px; color: #666; margin-bottom: 5px;"><strong>Ø§Ù„Ù…Ø³ØªÙˆÙ‰:</strong> ${membershipResult.level}</p>
                                                <p style="font-size: 16px; color: #666; margin-bottom: 5px;"><strong>Ø§Ù„Ø£Ø¨:</strong> ${parentCheck.membership.name}</p>
                                                <p style="font-size: 16px; color: #666;"><strong>Ø§Ù„Ù…Ø³Ø§Ø± Ø§Ù„Ù‡Ø±Ù…ÙŠ:</strong> ${membershipResult.hierarchyPath}</p>
                                            </div>
                                        `,
                                        icon: 'success',
                                        timer: 4000,
                                        showConfirmButton: false
                                    });
                                    
                                    const membershipCard = document.getElementById('membershipCard');
                                    if (membershipCard) {
                                        membershipCard.style.display = 'none';
                                    }
                                    
                                    // ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø§Ù„Ø§Ù†Ø¶Ù…Ø§Ù…
                                    await this.logActivity(
                                        this.currentMerchantData.mobile,
                                        'Ø§Ù†Ø¶Ù…Ø§Ù…_ØªØ­Øª_Ø¹Ø¶Ùˆ',
                                        `Ø§Ù†Ø¶Ù… ØªØ­Øª ${parentCheck.membership.name} (${parentMobile})`
                                    );
                                } else {
                                    Swal.fire({
                                        title: 'Ø®Ø·Ø£',
                                        text: membershipResult.message,
                                        icon: 'error',
                                        timer: 3000
                                    });
                                }
                            } catch (error) {
                                Swal.fire({
                                    title: 'Ø®Ø·Ø£',
                                    text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø§Ù„ÙØ±Ø¹ÙŠØ©',
                                    icon: 'error',
                                    timer: 3000
                                });
                            }
                        }
                    });
                }
            });
            
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±:', error);
            Swal.fire({
                title: 'Ø®Ø·Ø£',
                text: 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„ØªØ¬Ø§Ø±',
                icon: 'error',
                timer: 3000
            });
        }
    },
    
    // ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·
    async logActivity(mobile, action, details) {
        try {
            const activityData = {
                mobile: mobile,
                action: action,
                details: details,
                timestamp: new Date().toISOString(),
                ip: 'N/A' // ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© IP Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ØªØ§Ø­Ø§Ù‹
            };
            
            await database.ref('membership_activities').push(activityData);
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù†Ø´Ø§Ø·:', error);
        }
    },
    
    // Ø¯Ø§Ù„Ø© Ù„Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø¨ÙƒØ© Ø§Ù„Ù‡Ø±Ù…ÙŠØ©
    async getNetworkStatistics() {
        try {
            const snapshot = await database.ref('membership_hierarchy').once('value');
            const members = snapshot.val();
            
            if (!members) {
                return {
                    totalMembers: 0,
                    maxLevel: 0,
                    averageLevel: 0,
                    foundersCount: 0,
                    totalDescendants: 0
                };
            }
            
            const membersArray = Object.values(members);
            const totalMembers = membersArray.length;
            const maxLevel = Math.max(...membersArray.map(m => m.membershipLevel || 0));
            const averageLevel = totalMembers > 0 ? 
                membersArray.reduce((sum, m) => sum + (m.membershipLevel || 0), 0) / totalMembers : 0;
            const foundersCount = membersArray.filter(m => m.membershipLevel === 0).length;
            const totalDescendants = membersArray.reduce((sum, m) => sum + (m.totalDescendants || 0), 0);
            
            return {
                totalMembers,
                maxLevel,
                averageLevel: averageLevel.toFixed(2),
                foundersCount,
                totalDescendants,
                levelsDistribution: this.calculateLevelsDistribution(membersArray)
            };
        } catch (error) {
            console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø¨ÙƒØ©:', error);
            return null;
        }
    },
    
    // Ø­Ø³Ø§Ø¨ ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙˆÙŠØ§Øª
    calculateLevelsDistribution(membersArray) {
        const distribution = {};
        membersArray.forEach(member => {
            const level = member.membershipLevel || 0;
            distribution[level] = (distribution[level] || 0) + 1;
        });
        return distribution;
    }
};

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªØ§Ø¬Ø± Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
window.selectMerchantItem = function(element) {
    const allItems = document.querySelectorAll('.merchant-item');
    allItems.forEach(item => item.classList.remove('selected'));
    
    element.classList.add('selected');
    
    document.getElementById('selectedMerchantId').value = element.getAttribute('data-id');
    document.getElementById('selectedMerchantMobile').value = element.getAttribute('data-mobile');
};

// ===== Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© =====

// Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯
function generateId(text) {
    const arabicToEnglish = {
        'Ø£': 'a', 'Ø¨': 'b', 'Øª': 't', 'Ø«': 'th', 'Ø¬': 'j', 'Ø­': 'h', 'Ø®': 'kh',
        'Ø¯': 'd', 'Ø°': 'th', 'Ø±': 'r', 'Ø²': 'z', 'Ø³': 's', 'Ø´': 'sh', 'Øµ': 's',
        'Ø¶': 'd', 'Ø·': 't', 'Ø¸': 'th', 'Ø¹': 'a', 'Øº': 'gh', 'Ù': 'f', 'Ù‚': 'q',
        'Ùƒ': 'k', 'Ù„': 'l', 'Ù…': 'm', 'Ù†': 'n', 'Ù‡': 'h', 'Ùˆ': 'w', 'ÙŠ': 'y',
        'Ø¡': '', 'Ø¢': 'a', 'Ø©': 'h', 'Ù‰': 'a', 'Ø¦': 'i', 'Ø¤': 'u', ' ': '_'
    };
    
    return text.toLowerCase()
        .replace(/[\u0621-\u064A\u0660-\u0669\s]/g, (match) => arabicToEnglish[match] || match)
        .replace(/[^a-z0-9_]/g, '');
}

// Ø¯Ø§Ù„Ø© Ù„ØªØ­Ø¯ÙŠØ« Ø¹Ø±Ø¶ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ÙÙŠ ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
function updateUserDisplay() {
    const userDisplayElement = document.getElementById('user-display-name');
    const userData = globalUser.getUserData();
    
    if (userData) {
        const displayName = userData.name || userData.username || userData.commercialName || 'ØªØ§Ø¬Ø±';
        userDisplayElement.textContent = `ØªØ§Ø¬Ø±: ${displayName}`;
    } else {
        const merchantName = merchantGlobal.getMerchantName();
        if (merchantName) {
            userDisplayElement.textContent = `ØªØ§Ø¬Ø±: ${merchantName}`;
        } else {
            userDisplayElement.textContent = 'ØªØ§Ø¬Ø±: Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...';
        }
    }
}

// ===== Ø¯Ø§Ù„Ø© ÙØ­Øµ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù„ØµÙØ­Ø§Øª =====
function checkLoginBeforeNavigation(targetPage) {
    if (!globalUser.isLoggedIn()) {
        showMerchantLogin();
        notificationSystem.show(
            'ÙŠØ¬Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„', 
            'ÙŠØ¬Ø¨ Ø¹Ù„ÙŠÙƒ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø£ÙˆÙ„Ø§Ù‹ Ù„Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©', 
            'warning', 
            4000
        );
        return false;
    }
    return true;
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© ØªØ¹Ø¯ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±
function navigateToEditMerchant() {
    if (merchantExitManager.saveDataForNavigation()) {
        window.location.href = 'ub_tager.html';
    } else {
        if (!checkLoginBeforeNavigation('ub_tager.html')) {
            return;
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£ØµÙ†Ø§Ù
function navigateToCategories() {
    if (merchantExitManager.saveDataForNavigation()) {
        window.location.href = 'snf.html';
    } else {
        if (!checkLoginBeforeNavigation('snf.html')) {
            return;
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function navigateToStatistics() {
    if (merchantExitManager.saveDataForNavigation()) {
        window.location.href = 'statistics.html';
    } else {
        if (!checkLoginBeforeNavigation('statistics.html')) {
            return;
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ù†Ø¸Ø§Ù… Ø§Ù„Ø¹Ø¶ÙˆÙŠØ§Øª Ø§Ù„Ù‡Ø±Ù…ÙŠØ©
function navigateToMembershipHierarchy() {
    if (merchantExitManager.saveDataForNavigation()) {
        window.location.href = 'talek.html';
    } else {
        if (!checkLoginBeforeNavigation('talek.html')) {
            return;
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ø¥Ù„Ù‰ ØµÙØ­Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
function navigateToTest() {
    if (merchantExitManager.saveDataForNavigation()) {
        window.location.href = '01.html';
    } else {
        if (!checkLoginBeforeNavigation('01.html')) {
            return;
        }
    }
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© ÙˆØ§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
function closePage() {
    merchantGlobal.clearAllData();
    globalUser.logout();
    window.location.href = '1_1.html';
}

// Ø¯Ø§Ù„Ø© Ù„Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø­Ù‚Ù„ nam_usr Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„
function transferData() {
    const namUsrField = document.getElementById('nam_usr');
    const namUsrValue = namUsrField.value.trim();
    
    if (!namUsrValue) {
        alert('Ø­Ù‚Ù„ nam_usr ÙØ§Ø±Øº. ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹.');
        return;
    }
    
    const currentUserData = globalUser.getUserData() || {};
    const updatedUserData = {
        ...currentUserData,
        username: namUsrValue,
        name: namUsrValue,
        commercialName: namUsrValue
    };
    globalUser.setUserData(updatedUserData);
    
    merchantGlobal.setMerchantName(namUsrValue);
    
    alert('âœ… ØªÙ… Ù†Ù‚Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­ Ø¥Ù„Ù‰ Ø§Ù„Ø¬Ù„ÙˆØ¨Ø§Ù„');
}

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±
function toggleTestCard() {
    const testCard = document.getElementById('testCard');
    if (testCard.style.display === 'none') {
        testCard.style.display = 'block';
        notificationSystem.show('ØªÙ… ØªÙØ¹ÙŠÙ„ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'ØªÙ… Ø¥Ø¸Ù‡Ø§Ø± Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', 'success', 3000);
    } else {
        testCard.style.display = 'none';
        notificationSystem.show('ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø±', 'ØªÙ… Ø¥Ø®ÙØ§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ø§Ø®ØªØ¨Ø§Ø± Ø¨Ù†Ø¬Ø§Ø­', 'info', 3000);
    }
}

// ===== Ø¯ÙˆØ§Ù„ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª =====

// Ø¯Ø§Ù„Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© Ø¥Ù„Ù‰ Ø¥Ù†Ø¬Ù„ÙŠØ²ÙŠØ©
function normalizeNumbers(text) {
    const arabicNumbers = ['Ù ', 'Ù¡', 'Ù¢', 'Ù£', 'Ù¤', 'Ù¥', 'Ù¦', 'Ù§', 'Ù¨', 'Ù©'];
    const englishNumbers = ['0', '1', '2', '3', '4', '5', '6', '7', '8', '9'];
    
    let normalized = text;
    for (let i = 0; i < arabicNumbers.length; i++) {
        const regex = new RegExp(arabicNumbers[i], 'g');
        normalized = normalized.replace(regex, englishNumbers[i]);
    }
    
    return normalized;
}

// ===== Ù†Ø¸Ø§Ù… Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨ =====

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
function showWelcomeScreen(merchantName) {
    const welcomeModal = document.getElementById('welcomeModal');
    const welcomeGreeting = document.getElementById('welcomeGreeting');
    
    welcomeGreeting.textContent = `Ø¹Ø²ÙŠØ²Ù†Ø§ Ø§Ù„Ø¹Ù…ÙŠÙ„ / ${merchantName}`;
    welcomeModal.classList.add('show');
}

// Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© Ø§Ù„ØªØ±Ø­ÙŠØ¨
function hideWelcomeScreen() {
    const welcomeModal = document.getElementById('welcomeModal');
    welcomeModal.classList.remove('show');
}

// ===== Ù†Ø¸Ø§Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ§Ø¬Ø± =====

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function showMerchantLogin() {
    document.getElementById('merchantLoginModal').classList.add('show');
}

// Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
function hideMerchantLogin() {
    document.getElementById('merchantLoginModal').classList.remove('show');
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
function showPasswordReset() {
    document.getElementById('passwordResetModal').classList.add('show');
}

// Ø¯Ø§Ù„Ø© Ø¥Ø®ÙØ§Ø¡ Ù†Ø§ÙØ°Ø© Ø·Ù„Ø¨ ØªØ¹Ø¯ÙŠÙ„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
function hidePasswordReset() {
    document.getElementById('passwordResetModal').classList.remove('show');
    document.getElementById('passwordResetForm').reset();
    document.getElementById('passwordResetMessage').style.display = 'none';
}

// ===== Ù†Ø¸Ø§Ù… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø­Ø³Ù† =====
async function validateMerchantCredentials(username, password) {
    try {
        console.log('ğŸ” Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', username);
        
        const merchantsRef = database.ref('merchants');
        const snapshot = await merchantsRef.orderByChild('username').equalTo(username).once('value');
        
        if (!snapshot.exists()) {
            console.log('âŒ Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', username);
            throw new Error('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­');
        }
        
        let merchantData = null;
        let merchantId = null;
        
        snapshot.forEach((childSnapshot) => {
            merchantData = childSnapshot.val();
            merchantId = childSnapshot.key;
        });
        
        if (!merchantData) {
            throw new Error('Ø§Ø³Ù… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØºÙŠØ± ØµØ­ÙŠØ­');
        }
        
        console.log('âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„ØªØ§Ø¬Ø±:', merchantData.name);
        
        if (merchantData.password !== password) {
            console.log('âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
            throw new Error('ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©');
        }
        
        if (!['active', 'Ù†Ø´Ø·', 'ÙØ¹Ø§Ù„'].includes(merchantData.status)) {
            throw new Error('Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… ØªÙ… ØªÙˆÙ‚ÙŠÙÙ‡ Ù…Ù† Ù‚Ø¨Ù„ Ù…Ø³Ø¤ÙˆÙ„ Ø§Ù„Ù†Ø¸Ø§Ù…');
        }
        
        if (merchantData.job === 'Ù…Ø·Ø¹Ù…' || merchantData.job === 'restaurant' || 
            merchantData.job === 'Ù…Ø·Ø§Ø¹Ù…' || merchantData.job === 'restaurants') {
            throw new Error('âŒ Ù‡Ø°Ø§ Ø§Ù„Ø­Ø³Ø§Ø¨ Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…Ø·Ø§Ø¹Ù… ÙˆÙ„ÙŠØ³ Ø¨Ø§Ù„ØªØ¬Ø§Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ù…Ø®ØµØµØ© Ù„Ù„Ù…Ø·Ø§Ø¹Ù… Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø°Ù„Ùƒ.');
        }
        
        if (!merchantData.job || 
            (merchantData.job !== 'ØªØ§Ø¬Ø±' && merchantData.job !== 'merchant' && 
             merchantData.job !== 'ØªØ¬Ø§Ø±' && merchantData.job !== 'merchants')) {
            throw new Error('âŒ Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ… Ù„Ù‡Ø°Ù‡ Ø§Ù„ØµÙØ­Ø©. ÙŠØ±Ø¬Ù‰ Ø§Ù„ØªÙˆØ§ØµÙ„ Ù…Ø¹ Ø§Ù„Ø¯Ø¹Ù… Ø§Ù„ÙÙ†ÙŠ.');
        }
        
        console.log('âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†Ø¬Ø§Ø­');
        return { merchantData, merchantId };
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…:', error);
        throw error;
    }
}

// ===== Ø¯Ø§Ù„Ø© Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¶ÙˆÙŠØ© Ø¨Ø¹Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ =====
async function checkAndHandleMembershipAfterLogin(merchantData, merchantId) {
    try {
        membershipManager.setCurrentMerchant(merchantData, merchantId);
        await membershipManager.displayMembershipCard();
        
        // Ø¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø¨ÙƒØ© Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const stats = await membershipManager.getNetworkStatistics();
        if (stats) {
            console.log('ğŸ“Š Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø¨ÙƒØ©:', stats);
            
            // Ø¹Ø±Ø¶ Ø¥Ø´Ø¹Ø§Ø± Ø¨Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø´Ø¨ÙƒØ©
            setTimeout(() => {
                notificationSystem.show(
                    'Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ø´Ø¨ÙƒØ©',
                    `Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ø¹Ø¶Ø§Ø¡: ${stats.totalMembers} | Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙ‰: ${stats.maxLevel}`,
                    'info',
                    5000
                );
            }, 2000);
        }
        
    } catch (error) {
        console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø¹Ø¶ÙˆÙŠØ©:', error);
    }
}

// Ø¥Ø¹Ø¯Ø§Ø¯ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ§Ø¬Ø±
function setupMerchantLogin() {
    const modal = document.getElementById('merchantLoginModal');
    const closeBtn = document.getElementById('closeMerchantLogin');
    const form = document.getElementById('merchantLoginForm');
    const usernameInput = document.getElementById('merchantUsername');
    const passwordInput = document.getElementById('merchantPassword');
    const togglePassword = document.getElementById('toggleMerchantPassword');
    const loginBtn = document.getElementById('merchantLoginBtn');
    const spinner = document.getElementById('merchantLoadingSpinner');
    const messageDiv = document.getElementById('merchantLoginMessage');
    const rememberCheckbox = document.getElementById('rememberMerchant');
    const forgotPasswordLink = document.getElementById('forgotPasswordLink');
    
    const passwordResetModal = document.getElementById('passwordResetModal');
    const closePasswordReset = document.getElementById('closePasswordReset');
    const passwordResetForm = document.getElementById('passwordResetForm');
    const cancelPasswordReset = document.getElementById('cancelPasswordReset');
    const sendRequestBtn = document.getElementById('sendRequestBtn');
    const passwordResetMessage = document.getElementById('passwordResetMessage');
    const phoneNumberInput = document.getElementById('phoneNumber');
    
    const welcomeModal = document.getElementById('welcomeModal');
    const welcomeCloseBtn = document.getElementById('welcomeCloseBtn');
    
    const appLogo = document.getElementById('appLogo');
    
    closeBtn.addEventListener('click', () => {
        hideMerchantLogin();
        form.reset();
        messageDiv.style.display = 'none';
    });
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideMerchantLogin();
            form.reset();
            messageDiv.style.display = 'none';
        }
    });
    
    togglePassword.addEventListener('click', () => {
        const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
        passwordInput.setAttribute('type', type);
        togglePassword.classList.toggle('fa-eye');
        togglePassword.classList.toggle('fa-eye-slash');
    });
    
    forgotPasswordLink.addEventListener('click', (e) => {
        e.preventDefault();
        hideMerchantLogin();
        showPasswordReset();
    });
    
    closePasswordReset.addEventListener('click', () => {
        hidePasswordReset();
        showMerchantLogin();
    });
    
    cancelPasswordReset.addEventListener('click', () => {
        hidePasswordReset();
        showMerchantLogin();
    });
    
    passwordResetModal.addEventListener('click', (e) => {
        if (e.target === passwordResetModal) {
            hidePasswordReset();
            showMerchantLogin();
        }
    });
    
    welcomeCloseBtn.addEventListener('click', () => {
        hideWelcomeScreen();
    });
    
    welcomeModal.addEventListener('click', (e) => {
        if (e.target === welcomeModal) {
            hideWelcomeScreen();
        }
    });
    
    appLogo.addEventListener('click', () => {
        toggleTestCard();
    });
    
    passwordResetForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const phoneNumber = membershipManager.normalizeNumbers(phoneNumberInput.value.trim());
        const commercialName = document.getElementById('commercialName').value.trim();
        
        if (!phoneNumber) {
            passwordResetMessage.textContent = 'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„';
            passwordResetMessage.className = 'login-message error-message';
            passwordResetMessage.style.display = 'block';
            return;
        }
        
        sendRequestBtn.disabled = true;
        sendRequestBtn.textContent = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù‚Ù‚...';
        
        try {
            const merchantsRef = database.ref('merchants');
            const snapshot = await merchantsRef.orderByChild('mobile').equalTo(phoneNumber).once('value');
            
            if (snapshot.exists()) {
                const whatsappMessage = `Ø§Ù„Ø§Ø³Ù… Ø§Ù„ØªØ¬Ø§Ø±ÙŠ: ${commercialName}\nØ±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„: ${phoneNumber}\n\nØ£ØªÙ‚Ø¯Ù… Ø¨Ø·Ù„Ø¨ Ø¥Ø¹Ø§Ø¯Ø© ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø§Ù„Ø®Ø§ØµØ© Ø¨ÙŠ\nÙˆÙ„ÙƒÙ… Ù…Ù†ÙŠ Ø®Ø§Ù„Øµ Ø§Ù„Ø´ÙƒØ±`;
                const whatsappUrl = `https://wa.me/967772299420?text=${encodeURIComponent(whatsappMessage)}`;
                
                window.open(whatsappUrl, '_blank');
                
                passwordResetMessage.textContent = 'ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­ Ø¹Ø¨Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨';
                passwordResetMessage.className = 'login-message success-message';
                passwordResetMessage.style.display = 'block';
                
                setTimeout(() => {
                    hidePasswordReset();
                    showMerchantLogin();
                }, 3000);
            } else {
                passwordResetMessage.textContent = 'Ø¹ÙÙˆØ§Ù‹ Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù… ØºÙŠØ± Ù…Ø®Ø²Ù† ÙÙŠ Ø®ÙˆØ§Ø¯Ù… Ø§Ù„Ù…ØªØ¬Ø±. ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… ÙˆØ£Ø¹Ø¯ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„';
                passwordResetMessage.className = 'login-message error-message';
                passwordResetMessage.style.display = 'block';
            }
        } catch (error) {
            passwordResetMessage.textContent = 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø®Ø§Ø¯Ù…. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰';
            passwordResetMessage.className = 'login-message error-message';
            passwordResetMessage.style.display = 'block';
        } finally {
            sendRequestBtn.disabled = false;
            sendRequestBtn.textContent = 'Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø·Ù„Ø¨';
        }
    });
    
    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const username = usernameInput.value.trim();
        const password = passwordInput.value;
        const remember = rememberCheckbox.checked;
        
        loginBtn.disabled = true;
        spinner.style.display = 'inline-block';
        messageDiv.style.display = 'none';
        
        try {
            if (!username || !password) {
                throw new Error('ÙŠØ±Ø¬Ù‰ Ù…Ù„Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ„');
            }
            
            const { merchantData, merchantId } = await validateMerchantCredentials(username, password);
            
            merchantGlobal.setMerchantName(merchantData.commercialName || merchantData.name || username);
            merchantGlobal.setMerchantPhone(merchantData.mobile || merchantData.whatsapp || '');
            merchantGlobal.setMerchantId(merchantId);
            
            const userDataToStore = {
                id: merchantId,
                username: username,
                name: merchantData.name || username,
                commercialName: merchantData.commercialName || '',
                email: merchantData.email || '',
                mobile: merchantData.mobile || '',
                job: merchantData.job || 'ØªØ§Ø¬Ø±',
                type: 'merchant',
                loginTime: new Date().toISOString()
            };
            
            globalUser.setUserData(userDataToStore);
            
            if (remember) {
                localStorage.setItem('savedMerchantUsername', username);
                localStorage.setItem('savedMerchantPassword', password);
                localStorage.setItem('rememberMerchant', 'true');
            } else {
                localStorage.removeItem('savedMerchantUsername');
                localStorage.removeItem('savedMerchantPassword');
                localStorage.removeItem('rememberMerchant');
            }
            
            await checkAndHandleMembershipAfterLogin(merchantData, merchantId);
            
            messageDiv.textContent = 'âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­! Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...';
            messageDiv.className = 'login-message success-message';
            messageDiv.style.display = 'block';
            
            form.reset();
            
            setTimeout(() => {
                hideMerchantLogin();
                const merchantName = merchantData.commercialName || merchantData.name || username;
                showWelcomeScreen(merchantName);
            }, 1500);
            
        } catch (error) {
            messageDiv.textContent = error.message;
            messageDiv.className = 'login-message error-message';
            messageDiv.style.display = 'block';
            
            if (error.message.includes('Ù…Ø±ØªØ¨Ø· Ø¨Ø§Ù„Ù…Ø·Ø§Ø¹Ù…') || error.message.includes('Ù†ÙˆØ¹ Ø§Ù„ÙˆØ¸ÙŠÙØ© ØºÙŠØ± Ù…Ø¯Ø¹ÙˆÙ…')) {
                setTimeout(() => {
                    hideMerchantLogin();
                }, 4000);
            }
        } finally {
            loginBtn.disabled = false;
            spinner.style.display = 'none';
        }
    });
}

// ØªØ­Ù…ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ù„ØªØ§Ø¬Ø±
function loadSavedMerchantCredentials() {
    const savedUsername = localStorage.getItem('savedMerchantUsername');
    const savedPassword = localStorage.getItem('savedMerchantPassword');
    const rememberMe = localStorage.getItem('rememberMerchant') === 'true';
    
    if (rememberMe && savedUsername && savedPassword) {
        document.getElementById('merchantUsername').value = savedUsername;
        document.getElementById('merchantPassword').value = savedPassword;
        document.getElementById('rememberMerchant').checked = true;
        console.log('âœ… ØªÙ… ØªØ¹Ø¨Ø¦Ø© Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹');
    }
}

// ===== ØªÙ‡ÙŠØ¦Ø© Ø§Ù„ØµÙØ­Ø© =====
document.addEventListener('DOMContentLoaded', async function() {
    console.log('ğŸš€ Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©...');
    
    setupMerchantLogin();
    
    console.log('ğŸ” Ø¹Ø±Ø¶ Ø´Ø§Ø´Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù…Ø¨Ø§Ø´Ø±Ø©...');
    showMerchantLogin();
    
    loadSavedMerchantCredentials();
    
    updateUserDisplay();
    
    console.log('âœ… ØªÙ… ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø© Ø¨Ù†Ø¬Ø§Ø­');
});

// ===== Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø£Ø®Ø·Ø§Ø¡ =====
window.addEventListener('error', (event) => {
    console.error('âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØµÙØ­Ø©:', event.error);
    notificationSystem.show('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ØºÙŠØ± Ù…ØªÙˆÙ‚Ø¹ ÙÙŠ Ø§Ù„ØµÙØ­Ø©', 'error', 5000);
});

window.addEventListener('unhandledrejection', (event) => {
    console.error('âŒ ÙˆØ¹Ø¯ Ù…Ø±ÙÙˆØ¶:', event.reason);
    notificationSystem.show('Ø®Ø·Ø£', 'Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª', 'error', 5000);
});
</script>

</body>
</html>
