
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام العضويات الهرمي - السوق الشامل</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Cairo', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        :root {
            --primary: #4a90e2;
            --secondary: #87ceeb;
            --success: #4CAF50;
            --danger: #f44336;
            --warning: #ff9800;
            --info: #2196F3;
            --dark: #2c3e50;
            --light: #f8f9fa;
            --gray: #78909c;
            --purple: #9c27b0;
            --orange: #ff5722;
        }
        
        body {
            background: linear-gradient(135deg, #e0f7fa 0%, #b3e5fc 50%, #ffffff 100%);
            color: #333;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 80px 20px 70px 20px;
            position: relative;
        }
        
        /* ===== الشريط العلوي ===== */
        .top-header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 70px;
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 2px 15px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
            z-index: 1000;
            flex-direction: row-reverse;
            backdrop-filter: blur(10px);
        }

        .app-info {
            display: flex;
            align-items: center;
        }

        .app-logo {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            margin-right: 12px;
            overflow: hidden;
            background: white;
            padding: 5px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .app-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .app-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
        }

        .merchant-section {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
        }

        .management-name {
            font-size: 14px;
            color: var(--gray);
        }

        .merchant-name {
            font-size: 16px;
            color: var(--dark);
            font-weight: 600;
        }

        /* ===== شريط الجلوبلات ===== */
        .globals-bar {
            position: fixed;
            top: 70px; /* أسفل الشريط العلوي مباشرة */
            left: 0;
            width: 100%;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid #e0e0e0;
            padding: 10px 20px;
            z-index: 999;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: center;
            justify-content: flex-start;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .global-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 5px 10px;
            background: rgba(74, 144, 226, 0.1);
            border-radius: 5px;
            font-size: 13px;
            color: var(--primary);
            border: 1px solid rgba(74, 144, 226, 0.2);
        }

        .global-item i {
            font-size: 12px;
        }

        .global-label {
            font-weight: 500;
        }

        .global-value {
            font-weight: 600;
        }

        /* ===== أزرار التحكم في شريط الجلوبلات ===== */
        .globals-controls {
            display: flex;
            gap: 10px;
            margin-right: auto;
        }

        .globals-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
        }

        .globals-btn-primary {
            background: var(--primary);
            color: white;
        }

        .globals-btn-primary:hover {
            background: #357abd;
            transform: translateY(-1px);
        }

        .globals-btn-success {
            background: var(--success);
            color: white;
        }

        .globals-btn-success:hover {
            background: #3d8b40;
            transform: translateY(-1px);
        }

        .globals-btn-secondary {
            background: var(--gray);
            color: white;
        }

        .globals-btn-secondary:hover {
            background: #546e7a;
            transform: translateY(-1px);
        }

        .globals-btn-purple {
            background: var(--purple);
            color: white;
        }

        .globals-btn-purple:hover {
            background: #7b1fa2;
            transform: translateY(-1px);
        }

        /* ===== زر الرجوع ===== */
        .back-button {
            position: fixed;
            top: 130px; /* أسفل شريط الجلوبلات */
            left: 20px;
            display: inline-flex;
            align-items: center;
            background: var(--primary);
            color: white;
            padding: 10px 16px;
            border-radius: 8px;
            text-decoration: none;
            font-size: 14px;
            z-index: 998;
            box-shadow: 0 4px 12px rgba(74, 144, 226, 0.3);
            transition: all 0.3s ease;
        }

        .back-button:hover {
            background: var(--secondary);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(135, 206, 235, 0.4);
        }

        .back-button i {
            margin-right: 5px;
        }

        /* ===== التذييل ===== */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 50px;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            justify-content: center;
            align-items: center;
            color: var(--primary);
            font-weight: 500;
            z-index: 1000;
            backdrop-filter: blur(5px);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            font-size: 14px;
        }

        /* ===== المحتوى الرئيسي ===== */
        .container {
            background: rgba(255, 255, 255, 0.7);
            border-radius: 20px;
            padding: 25px;
            width: 100%;
            max-width: 1400px;
            margin-bottom: 30px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }
        
        .merchant-card {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .merchant-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 2px solid rgba(74, 144, 226, 0.1);
            padding-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .merchant-name-card {
            font-size: 26px;
            font-weight: bold;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            padding: 5px 0;
        }
        
        .merchant-status {
            padding: 8px 20px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 600;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        .status-active {
            background: linear-gradient(135deg, var(--success) 0%, #2E7D32 100%);
            color: white;
        }
        
        .status-inactive {
            background: linear-gradient(135deg, var(--danger) 0%, #c62828 100%);
            color: white;
        }
        
        .status-premium {
            background: linear-gradient(135deg, var(--purple) 0%, #6a1b9a 100%);
            color: white;
        }
        
        .status-gold {
            background: linear-gradient(135deg, var(--warning) 0%, #ff8f00 100%);
            color: white;
        }
        
        /* ===== هيكل الشجرة الهرمية ===== */
        .hierarchy-section {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
        }
        
        .section-title {
            font-size: 24px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 25px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(74, 144, 226, 0.1);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .section-title i {
            color: var(--secondary);
        }
        
        .hierarchy-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.5);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        }
        
        .stat-icon {
            font-size: 32px;
            margin-bottom: 15px;
            color: var(--primary);
        }
        
        .stat-number {
            font-size: 28px;
            font-weight: bold;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .stat-label {
            font-size: 14px;
            color: var(--gray);
        }
        
        .tree-container {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
            overflow-x: auto;
        }
        
        .tree {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 800px;
        }
        
        .tree-level {
            display: flex;
            justify-content: center;
            width: 100%;
            margin-bottom: 40px;
            position: relative;
        }
        
        .tree-level::before {
            content: '';
            position: absolute;
            top: -20px;
            left: 50%;
            width: 2px;
            height: 20px;
            background: var(--primary);
            transform: translateX(-50%);
        }
        
        .tree-node {
            background: white;
            border-radius: 12px;
            padding: 15px 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            border: 2px solid var(--primary);
            text-align: center;
            min-width: 200px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .tree-node:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(74, 144, 226, 0.2);
            border-color: var(--secondary);
        }
        
        .node-main {
            border-color: var(--purple);
            background: linear-gradient(135deg, #f3e5f5 0%, #e1bee7 100%);
        }
        
        .node-child {
            border-color: var(--info);
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        
        .node-grandchild {
            border-color: var(--success);
            background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%);
        }
        
        .node-connector {
            position: absolute;
            top: -20px;
            left: 50%;
            width: 2px;
            height: 20px;
            background: var(--primary);
            transform: translateX(-50%);
        }
        
        .node-name {
            font-weight: bold;
            font-size: 16px;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .node-mobile {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 8px;
        }
        
        .node-status {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
        }
        
        /* ===== قائمة التجار الأبناء ===== */
        .children-list {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
            margin-bottom: 30px;
        }
        
        .children-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .children-title {
            font-size: 20px;
            font-weight: bold;
            color: var(--dark);
        }
        
        .add-child-form {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 2px dashed #bdc3c7;
        }
        
        .form-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary);
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-label {
            display: block;
            font-weight: 600;
            color: var(--dark);
            margin-bottom: 8px;
            font-size: 14px;
        }
        
        .form-input {
            width: 100%;
            padding: 12px 15px;
            border-radius: 8px;
            border: 1px solid #ced4da;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        .form-note {
            font-size: 13px;
            color: var(--gray);
            margin-top: 10px;
            padding: 10px;
            background: rgba(33, 150, 243, 0.1);
            border-radius: 8px;
            border-right: 3px solid var(--info);
        }
        
        .children-table-container {
            overflow-x: auto;
        }
        
        .children-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.05);
        }
        
        .children-table th {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            font-weight: 600;
            padding: 15px;
            text-align: right;
            font-size: 15px;
        }
        
        .children-table td {
            padding: 15px;
            border-bottom: 1px solid #eee;
            color: var(--dark);
            font-size: 14px;
        }
        
        .children-table tr:hover {
            background: #f8f9fa;
        }
        
        .children-table tr:last-child td {
            border-bottom: none;
        }
        
        .table-actions {
            display: flex;
            gap: 8px;
        }
        
        /* ===== إحصائيات العضويات ===== */
        .membership-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        
        .stat-detail-card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.08);
        }
        
        .stat-detail-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-detail-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }
        
        .icon-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
        }
        
        .icon-success {
            background: linear-gradient(135deg, var(--success) 0%, #2E7D32 100%);
        }
        
        .icon-purple {
            background: linear-gradient(135deg, var(--purple) 0%, #6a1b9a 100%);
        }
        
        .icon-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #ff8f00 100%);
        }
        
        .stat-detail-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--dark);
        }
        
        .stat-detail-list {
            list-style: none;
        }
        
        .stat-detail-list li {
            padding: 10px 0;
            border-bottom: 1px solid #eee;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .stat-detail-list li:last-child {
            border-bottom: none;
        }
        
        .stat-detail-label {
            color: var(--gray);
            font-size: 14px;
        }
        
        .stat-detail-value {
            font-weight: bold;
            color: var(--dark);
            font-size: 15px;
        }
        
        /* ===== تفاصيل التاجر ===== */
        .merchant-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 20px;
        }
        
        .detail-item {
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.8);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.5);
        }

        .detail-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            background: rgba(255, 255, 255, 0.9);
        }
        
        .detail-label {
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 15px;
            display: flex;
            align-items: center;
        }

        .detail-label i {
            margin-left: 8px;
            font-size: 16px;
            color: var(--secondary);
        }
        
        .detail-value {
            font-size: 16px;
            color: var(--dark);
            padding: 12px 15px;
            background: rgba(248, 249, 250, 0.8);
            border-radius: 12px;
            min-height: 45px;
            word-break: break-all;
            border: 1px solid rgba(74, 144, 226, 0.1);
        }
        
        .detail-value a {
            color: var(--secondary);
            text-decoration: none;
            transition: color 0.3s;
        }
        
        .detail-value a:hover {
            color: var(--primary);
            text-decoration: underline;
        }
        
        .editable {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--primary);
            box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.2);
        }
        
        .action-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 15px;
            margin-top: 30px;
        }
        
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 14px 28px;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 16px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(74, 144, 226, 0.4);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success) 0%, #2E7D32 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, var(--gray) 0%, #546e7a 100%);
            color: white;
        }
        
        .btn-secondary:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(120, 144, 156, 0.4);
        }
        
        .btn-purple {
            background: linear-gradient(135deg, var(--purple) 0%, #6a1b9a 100%);
            color: white;
        }
        
        .btn-purple:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(156, 39, 176, 0.4);
        }
        
        .btn i {
            margin-left: 8px;
        }
        
        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #c62828 100%);
            color: white;
        }
        
        .btn-danger:hover {
            background: #d32f2f;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(244, 67, 54, 0.4);
        }
        
        .no-data {
            text-align: center;
            padding: 50px 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 18px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }
        
        .no-data i {
            font-size: 60px;
            color: #b0bec5;
            margin-bottom: 20px;
        }
        
        .no-data h2 {
            color: var(--dark);
            margin-bottom: 15px;
            font-size: 24px;
        }
        
        .no-data p {
            color: var(--gray);
            margin-bottom: 25px;
            font-size: 16px;
        }
        
        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(243, 243, 243, 0.6);
            border-top: 5px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* ===== تنسيق الإشعارات ===== */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .toast {
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 300px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease;
            transition: opacity 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .toast.success {
            background: rgba(76, 175, 80, 0.9);
        }
        
        .toast.error {
            background: rgba(244, 67, 54, 0.9);
        }
        
        .toast.info {
            background: rgba(33, 150, 243, 0.9);
        }
        
        .toast.warning {
            background: rgba(255, 152, 0, 0.9);
        }
        
        .toast-content {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .toast-icon {
            font-size: 20px;
        }
        
        .toast-close {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            font-size: 18px;
            opacity: 0.8;
            transition: opacity 0.3s;
        }
        
        .toast-close:hover {
            opacity: 1;
        }
        
        .toast-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 4px;
            background: rgba(255, 255, 255, 0.5);
            width: 100%;
            border-radius: 0 0 12px 12px;
            overflow: hidden;
        }
        
        .toast-progress-bar {
            height: 100%;
            background: white;
            animation: progressBar 5s linear forwards;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes progressBar {
            from { width: 100%; }
            to { width: 0%; }
        }
        
        .loading-spinner-btn {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: #fff;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        /* ===== شعار ترحيبي ===== */
        .welcome-banner {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 25px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(74, 144, 226, 0.3);
            animation: slideDown 0.5s ease-out;
            position: relative;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .welcome-title {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .welcome-subtitle {
            font-size: 18px;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .merchant-name-welcome {
            font-size: 22px;
            font-weight: bold;
            margin-bottom: 15px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }

        .welcome-instruction {
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 15px;
            border-radius: 10px;
            font-size: 14px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 10px;
        }

        .welcome-status {
            position: absolute;
            top: 20px;
            left: 20px;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
        }
        
        /* ===== استجابة الهواتف ===== */
        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .merchant-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
            
            .action-buttons {
                flex-direction: column;
                align-self: stretch;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .toast {
                min-width: unset;
                width: calc(100% - 40px);
                margin: 0 20px;
            }
            
            .back-button {
                top: 140px;
                left: 10px;
                padding: 8px 12px;
                font-size: 0.9rem;
            }
            
            .merchant-section {
                flex-direction: row;
                align-items: center;
                font-size: 12px;
            }
            
            .app-name {
                font-size: 16px;
            }

            .merchant-details {
                grid-template-columns: 1fr;
            }
            
            .globals-bar {
                padding: 8px 10px;
                gap: 10px;
            }
            
            .global-item {
                font-size: 12px;
                padding: 4px 8px;
            }

            .globals-controls {
                flex-direction: column;
                gap: 5px;
            }
            
            .globals-btn {
                padding: 4px 8px;
                font-size: 11px;
            }
            
            .welcome-banner {
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .welcome-title {
                font-size: 20px;
            }
            
            .welcome-subtitle {
                font-size: 16px;
            }

            .merchant-name-welcome {
                font-size: 18px;
            }
            
            .welcome-instruction {
                font-size: 12px;
                padding: 8px 12px;
            }

            .welcome-status {
                position: static;
                margin-bottom: 10px;
                align-self: center;
            }
            
            .tree-container {
                padding: 15px;
            }
            
            .tree {
                min-width: 600px;
            }
            
            .tree-node {
                min-width: 150px;
                padding: 10px 15px;
            }
            
            .hierarchy-stats {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            
            .membership-stats {
                grid-template-columns: 1fr;
            }
            
            .children-header {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .children-table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
            
            .children-table {
                min-width: 800px;
            }
            
            body {
                padding-top: 140px;
            }
        }
        
        @media (max-width: 480px) {
            .tree {
                min-width: 400px;
            }
            
            .tree-node {
                min-width: 120px;
                padding: 8px 12px;
            }
            
            .node-name {
                font-size: 14px;
            }
            
            .node-mobile {
                font-size: 12px;
            }
            
            .node-status {
                font-size: 10px;
                padding: 2px 8px;
            }
        }
    </style>
</head>
<body>

<!-- الشريط العلوي -->
<header class="top-header">
    <div class="app-info">
        <div class="app-logo">
            <img src="https://github.com/T772299420/Call/raw/main/BackgroundEraser_%D9%A2%D9%A0%D9%A2%D9%A5%D9%A0%D9%A9%D9%A0%D9%A5_%D9%A0%D9%A0%D9%A3%D9%A5%D9%A0%D9%A1%D9%A0%D9%A0%D9%A7.png" alt="شعار السوق الشامل">
        </div>
        <div class="app-name">AZ السوق الشامل</div>
    </div>
    <div class="merchant-section">
        <div class="management-name">نظام العضويات الهرمي</div>
        <div class="merchant-name" id="user-display-name">تاجر: جاري التحميل...</div>
    </div>
</header>

<!-- شريط الجلوبلات -->
<div class="globals-bar" id="globals-bar">
    <div class="globals-controls">
        <button id="globalsRefreshBtn" class="globals-btn globals-btn-primary">
            <i class="fas fa-sync-alt"></i> تحديث البيانات
        </button>
        <button id="globalsAddChildBtn" class="globals-btn globals-btn-success">
            <i class="fas fa-user-plus"></i> إضافة تاجر ابن
        </button>
        <button id="globalsTreeViewBtn" class="globals-btn globals-btn-purple">
            <i class="fas fa-sitemap"></i> عرض الشجرة
        </button>
    </div>
    
    <div class="global-item">
        <i class="fas fa-users"></i>
        <span class="global-label">الأبناء:</span>
        <span class="global-value" id="global-children-count">0</span>
    </div>
    
    <div class="global-item">
        <i class="fas fa-sitemap"></i>
        <span class="global-label">المستوى:</span>
        <span class="global-value" id="global-membership-level">0</span>
    </div>
    
    <div class="global-item">
        <i class="fas fa-crown"></i>
        <span class="global-label">الحالة:</span>
        <span class="global-value" id="global-membership-status">عادي</span>
    </div>
</div>

<!-- زر الرجوع -->
<a href="manjr_tagr_snf.html" class="back-button">
    <i class="fas fa-arrow-left"></i> رجوع
</a>

<div class="container">
    <!-- شعار ترحيبي -->
    <div class="welcome-banner" id="welcomeBanner">
        <div class="welcome-status status-active" id="welcomeStatus">نشط</div>
        <div class="welcome-title">مرحباً بك في نظام العضويات الهرمي</div>
        <div class="welcome-subtitle">بناء شبكة تجارية متكاملة</div>
        <div class="merchant-name-welcome" id="merchantNameWelcome">اسم التاجر</div>
        <div class="welcome-instruction">
            <i class="fas fa-info-circle"></i>
            يمكنك إضافة تجار أبناء تحت عضويتك وبناء شبكتك التجارية
        </div>
    </div>

    <div id="loadingIndicator" style="text-align: center; padding: 40px;">
        <div class="loading-spinner"></div>
        <p>جاري تحميل بيانات نظام العضويات...</p>
    </div>

    <!-- قسم الشجرة الهرمية -->
    <div id="hierarchySection" class="hierarchy-section" style="display: none;">
        <div class="section-title">
            <i class="fas fa-sitemap"></i>
            الشجرة الهرمية للعضويات
        </div>
        
        <div class="hierarchy-stats">
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-user"></i>
                </div>
                <div class="stat-number" id="stat-total-children">0</div>
                <div class="stat-label">إجمالي الأبناء</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-layer-group"></i>
                </div>
                <div class="stat-number" id="stat-hierarchy-level">0</div>
                <div class="stat-label">مستوى التسلسل</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-chart-line"></i>
                </div>
                <div class="stat-number" id="stat-network-size">0</div>
                <div class="stat-label">حجم الشبكة</div>
            </div>
            
            <div class="stat-card">
                <div class="stat-icon">
                    <i class="fas fa-crown"></i>
                </div>
                <div class="stat-number" id="stat-membership-rank">عادي</div>
                <div class="stat-label">رتبة العضوية</div>
            </div>
        </div>
        
        <div class="tree-container">
            <div class="tree" id="hierarchyTree">
                <!-- سيتم بناء الشجرة هنا ديناميكياً -->
                <div class="no-data" id="treeNoData">
                    <i class="fas fa-sitemap"></i>
                    <h2>لا توجد شجرة هرمية</h2>
                    <p>لم تقم بإضافة أي تاجر ابن بعد. ابدأ بإضافة أول تاجر ابن لبناء شبكتك.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- قسم التجار الأبناء -->
    <div id="childrenSection" class="children-list" style="display: none;">
        <div class="children-header">
            <div class="children-title">
                <i class="fas fa-user-friends"></i>
                التجار الأبناء
            </div>
            <button id="addChildBtn" class="btn btn-success btn-small">
                <i class="fas fa-user-plus"></i> إضافة تاجر ابن جديد
            </button>
        </div>
        
        <!-- نموذج إضافة تاجر ابن -->
        <div class="add-child-form" id="addChildForm" style="display: none;">
            <div class="form-title">
                <i class="fas fa-plus-circle"></i>
                إضافة تاجر ابن جديد
            </div>
            
            <div class="form-group">
                <label class="form-label">رقم الجوال/الواتساب للتاجر المراد إضافته</label>
                <input type="text" class="form-input" id="childMobile" placeholder="أدخل رقم الجوال (مثال: 0512345678)" maxlength="15">
                <div class="form-note">
                    <i class="fas fa-info-circle"></i>
                    يجب أن يكون التاجر مسجلاً مسبقاً في النظام. سيتم البحث عنه برقم الجوال.
                </div>
            </div>
            
            <div class="form-group" id="childSearchResult" style="display: none;">
                <div class="detail-item" style="margin-bottom: 0;">
                    <div class="detail-label">نتيجة البحث:</div>
                    <div class="detail-value" id="foundMerchantInfo">
                        جاري البحث...
                    </div>
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label">نسبة العمولة (%)</label>
                <input type="number" class="form-input" id="childCommission" placeholder="أدخل نسبة العمولة (0-100)" min="0" max="100" value="10">
            </div>
            
            <div class="form-actions">
                <button id="cancelAddChildBtn" class="btn btn-secondary btn-small">
                    <i class="fas fa-times"></i> إلغاء
                </button>
                <button id="confirmAddChildBtn" class="btn btn-success btn-small">
                    <i class="fas fa-check"></i> تأكيد الإضافة
                </button>
            </div>
        </div>
        
        <!-- قائمة التجار الأبناء -->
        <div class="children-table-container">
            <table class="children-table" id="childrenTable">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>اسم التاجر</th>
                        <th>رقم الجوال</th>
                        <th>تاريخ الإضافة</th>
                        <th>نسبة العمولة</th>
                        <th>الحالة</th>
                        <th>الإجراءات</th>
                    </tr>
                </thead>
                <tbody id="childrenTableBody">
                    <!-- سيتم ملء البيانات هنا ديناميكياً -->
                </tbody>
            </table>
        </div>
        
        <div class="no-data" id="childrenNoData" style="display: none;">
            <i class="fas fa-user-friends"></i>
            <h2>لا توجد تجار أبناء</h2>
            <p>لم تقم بإضافة أي تاجر ابن بعد. ابدأ بإضافة أول تاجر ابن لبناء شبكتك.</p>
        </div>
    </div>

    <!-- إحصائيات العضويات -->
    <div id="membershipStats" class="hierarchy-section" style="display: none;">
        <div class="section-title">
            <i class="fas fa-chart-bar"></i>
            إحصائيات العضوية
        </div>
        
        <div class="membership-stats">
            <div class="stat-detail-card">
                <div class="stat-detail-header">
                    <div class="stat-detail-icon icon-primary">
                        <i class="fas fa-user-tie"></i>
                    </div>
                    <div class="stat-detail-title">معلومات العضوية</div>
                </div>
                
                <ul class="stat-detail-list">
                    <li>
                        <span class="stat-detail-label">رقم العضوية:</span>
                        <span class="stat-detail-value" id="membership-id">-</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">تاريخ التسجيل:</span>
                        <span class="stat-detail-value" id="membership-join-date">-</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">مستوى التسلسل:</span>
                        <span class="stat-detail-value" id="membership-level">-</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">رتبة العضوية:</span>
                        <span class="stat-detail-value" id="membership-rank">-</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">نقاط الولاء:</span>
                        <span class="stat-detail-value" id="membership-points">0</span>
                    </li>
                </ul>
            </div>
            
            <div class="stat-detail-card">
                <div class="stat-detail-header">
                    <div class="stat-detail-icon icon-success">
                        <i class="fas fa-network-wired"></i>
                    </div>
                    <div class="stat-detail-title">إحصائيات الشبكة</div>
                </div>
                
                <ul class="stat-detail-list">
                    <li>
                        <span class="stat-detail-label">الأبناء المباشرين:</span>
                        <span class="stat-detail-value" id="direct-children-count">0</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">إجمالي الشبكة:</span>
                        <span class="stat-detail-value" id="total-network-count">0</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">أقصى عمق:</span>
                        <span class="stat-detail-value" id="max-depth">0</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">متوسط العمولة:</span>
                        <span class="stat-detail-value" id="avg-commission">0%</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">إجمالي العمولات:</span>
                        <span class="stat-detail-value" id="total-commissions">0 ر.س</span>
                    </li>
                </ul>
            </div>
            
            <div class="stat-detail-card">
                <div class="stat-detail-header">
                    <div class="stat-detail-icon icon-purple">
                        <i class="fas fa-award"></i>
                    </div>
                    <div class="stat-detail-title">المكافآت والمزايا</div>
                </div>
                
                <ul class="stat-detail-list">
                    <li>
                        <span class="stat-detail-label">مكافآت مستحقة:</span>
                        <span class="stat-detail-value" id="pending-rewards">0 ر.س</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">المكافآت المدفوعة:</span>
                        <span class="stat-detail-value" id="paid-rewards">0 ر.س</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">الهدف القادم:</span>
                        <span class="stat-detail-value" id="next-target">-</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">المكافأة التالية:</span>
                        <span class="stat-detail-value" id="next-reward">-</span>
                    </li>
                    <li>
                        <span class="stat-detail-label">تاريخ الترقية:</span>
                        <span class="stat-detail-value" id="last-promotion">-</span>
                    </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- بيانات التاجر الرئيسية -->
    <div id="merchantData" class="merchant-card" style="display: none;">
        <div class="merchant-header">
            <div class="merchant-name-card" id="merchantNameCard">قيد التحميل...</div>
            <div class="merchant-status" id="merchantStatus">نشط</div>
        </div>
        
        <div class="merchant-details">
            <div class="detail-item">
                <div class="detail-label"><i class="fas fa-store"></i> اسم المتجر</div>
                <div class="detail-value" id="merchantNameValue">قيد التحميل...</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label"><i class="fas fa-mobile-alt"></i> رقم الجوال/واتساب</div>
                <div class="detail-value" id="merchantMobile">قيد التحميل...</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label"><i class="fas fa-phone"></i> رقم الهاتف الثابت</div>
                <div class="detail-value" id="merchantPhone">قيد التحميل...</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label"><i class="fas fa-map-marker-alt"></i> المحافظة</div>
                <div class="detail-value" id="merchantGovernorate">قيد التحميل...</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label"><i class="fas fa-map-pin"></i> المنطقة</div>
                <div class="detail-value" id="merchantArea">قيد التحميل...</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label"><i class="fas fa-calendar-alt"></i> تاريخ التسجيل</div>
                <div class="detail-value" id="merchantCreatedAt">قيد التحميل...</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label"><i class="fas fa-user-tag"></i> حالة العضوية</div>
                <div class="detail-value" id="merchantMembershipStatus">قيد التحميل...</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label"><i class="fas fa-sitemap"></i> المستوى الهرمي</div>
                <div class="detail-value" id="merchantHierarchyLevel">قيد التحميل...</div>
            </div>
            
            <div class="detail-item">
                <div class="detail-label"><i class="fas fa-user-friends"></i> عدد الأبناء</div>
                <div class="detail-value" id="merchantChildrenCount">قيد التحميل...</div>
            </div>
        </div>
    </div>
    
    <div id="noMembership" class="no-data" style="display: none;">
        <i class="fas fa-users-slash"></i>
        <h2 id="noMembershipTitle">لا توجد عضوية</h2>
        <p id="noMembershipDesc">لم يتم العثور على بيانات عضوية في النظام.</p>
        <button id="createMembershipBtn" class="btn btn-primary">
            <i class="fas fa-user-plus"></i> إنشاء عضوية جديدة
        </button>
    </div>
</div>

<!-- التذييل -->
<footer class="footer">
    جميع الحقوق محفوظة لدى المميز سوفت للأنظمة المحاسبية المتكاملة - نظام العضويات الهرمي
</footer>

<!-- حاوية الإشعارات -->
<div class="toast-container" id="toastContainer"></div>

<script>
    // إعدادات Firebase
    const firebaseConfig = {
        databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/"
    };
    
    // تهيئة Firebase
    firebase.initializeApp(firebaseConfig);
    const database = firebase.database();
    
    // عناصر DOM
    const loadingIndicator = document.getElementById('loadingIndicator');
    const merchantData = document.getElementById('merchantData');
    const hierarchySection = document.getElementById('hierarchySection');
    const childrenSection = document.getElementById('childrenSection');
    const membershipStats = document.getElementById('membershipStats');
    const noMembership = document.getElementById('noMembership');
    const noMembershipTitle = document.getElementById('noMembershipTitle');
    const noMembershipDesc = document.getElementById('noMembershipDesc');
    const createMembershipBtn = document.getElementById('createMembershipBtn');
    const userDisplayElement = document.getElementById('user-display-name');
    const toastContainer = document.getElementById('toastContainer');
    
    // عناصر بيانات التاجر
    const merchantNameCard = document.getElementById('merchantNameCard');
    const merchantNameValue = document.getElementById('merchantNameValue');
    const merchantMobile = document.getElementById('merchantMobile');
    const merchantPhone = document.getElementById('merchantPhone');
    const merchantGovernorate = document.getElementById('merchantGovernorate');
    const merchantArea = document.getElementById('merchantArea');
    const merchantCreatedAt = document.getElementById('merchantCreatedAt');
    const merchantStatus = document.getElementById('merchantStatus');
    const merchantMembershipStatus = document.getElementById('merchantMembershipStatus');
    const merchantHierarchyLevel = document.getElementById('merchantHierarchyLevel');
    const merchantChildrenCount = document.getElementById('merchantChildrenCount');
    
    // عناصر الشجرة الهرمية
    const hierarchyTree = document.getElementById('hierarchyTree');
    const treeNoData = document.getElementById('treeNoData');
    const statTotalChildren = document.getElementById('stat-total-children');
    const statHierarchyLevel = document.getElementById('stat-hierarchy-level');
    const statNetworkSize = document.getElementById('stat-network-size');
    const statMembershipRank = document.getElementById('stat-membership-rank');
    
    // عناصر قائمة الأبناء
    const addChildBtn = document.getElementById('addChildBtn');
    const addChildForm = document.getElementById('addChildForm');
    const childMobileInput = document.getElementById('childMobile');
    const childCommissionInput = document.getElementById('childCommission');
    const childSearchResult = document.getElementById('childSearchResult');
    const foundMerchantInfo = document.getElementById('foundMerchantInfo');
    const cancelAddChildBtn = document.getElementById('cancelAddChildBtn');
    const confirmAddChildBtn = document.getElementById('confirmAddChildBtn');
    const childrenTableBody = document.getElementById('childrenTableBody');
    const childrenNoData = document.getElementById('childrenNoData');
    
    // عناصر إحصائيات العضوية
    const membershipId = document.getElementById('membership-id');
    const membershipJoinDate = document.getElementById('membership-join-date');
    const membershipLevel = document.getElementById('membership-level');
    const membershipRank = document.getElementById('membership-rank');
    const membershipPoints = document.getElementById('membership-points');
    const directChildrenCount = document.getElementById('direct-children-count');
    const totalNetworkCount = document.getElementById('total-network-count');
    const maxDepth = document.getElementById('max-depth');
    const avgCommission = document.getElementById('avg-commission');
    const totalCommissions = document.getElementById('total-commissions');
    const pendingRewards = document.getElementById('pending-rewards');
    const paidRewards = document.getElementById('paid-rewards');
    const nextTarget = document.getElementById('next-target');
    const nextReward = document.getElementById('next-reward');
    const lastPromotion = document.getElementById('last-promotion');
    
    // عناصر الجلوبالات
    const globalChildrenCount = document.getElementById('global-children-count');
    const globalMembershipLevel = document.getElementById('global-membership-level');
    const globalMembershipStatus = document.getElementById('global-membership-status');
    const globalsRefreshBtn = document.getElementById('globalsRefreshBtn');
    const globalsAddChildBtn = document.getElementById('globalsAddChildBtn');
    const globalsTreeViewBtn = document.getElementById('globalsTreeViewBtn');
    
    // عناصر الترحيب
    const welcomeBanner = document.getElementById('welcomeBanner');
    const welcomeStatus = document.getElementById('welcomeStatus');
    const merchantNameWelcome = document.getElementById('merchantNameWelcome');
    
    // متغيرات النظام
    let currentMerchant = null;
    let currentMembership = null;
    let merchantChildren = [];
    let foundMerchant = null;
    
    // ===== نظام الجلوبالات المحسن =====
    const globalUser = {
        data: null,
        
        setUserData: function(userData) {
            this.data = userData;
            sessionStorage.setItem('globalUserData', JSON.stringify(userData));
            console.log('✅ تم تخزين بيانات المستخدم في الجلسة:', userData);
            updateUserDisplay();
        },
        
        getUserData: function() {
            if (this.data) return this.data;
            
            const storedData = sessionStorage.getItem('globalUserData');
            if (storedData) {
                this.data = JSON.parse(storedData);
                return this.data;
            }
            
            return null;
        },
        
        getUsername: function() {
            const userData = this.getUserData();
            return userData ? userData.username : 'زائر';
        },
        
        getUserId: function() {
            const userData = this.getUserData();
            return userData ? userData.id : null;
        },
        
        getUserMobile: function() {
            const userData = this.getUserData();
            return userData ? userData.mobile : null;
        },
        
        isLoggedIn: function() {
            return this.getUserData() !== null;
        }
    };

    // ===== دوال مساعدة =====

    // دالة لعرض الإشعارات
    function showToast(message, type = 'info') {
        if (!toastContainer) return;
        
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        
        const icon = type === 'success' ? 'fa-check-circle' : 
                    type === 'error' ? 'fa-exclamation-circle' : 
                    type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle';
        
        toast.innerHTML = `
            <div class="toast-content">
                <i class="fas ${icon} toast-icon"></i>
                <span>${message}</span>
            </div>
            <button class="toast-close">
                <i class="fas fa-times"></i>
            </button>
            <div class="toast-progress">
                <div class="toast-progress-bar"></div>
            </div>
        `;
        
        toastContainer.appendChild(toast);
        
        // إضافة حدث إغلاق عند النقر على زر الإغلاق
        const closeBtn = toast.querySelector('.toast-close');
        closeBtn.addEventListener('click', () => {
            toast.style.opacity = '0';
            setTimeout(() => {
                if (toast.parentNode === toastContainer) {
                    toastContainer.removeChild(toast);
                }
            }, 300);
        });
        
        // إزالة الإشعار تلقائياً بعد 5 ثوان
        setTimeout(() => {
            if (toast.parentNode === toastContainer) {
                toast.style.opacity = '0';
                setTimeout(() => {
                    if (toast.parentNode === toastContainer) {
                        toastContainer.removeChild(toast);
                    }
                }, 300);
            }
        }, 5000);
    }
    
    // دالة لتحديث عرض اسم المستخدم في واجهة المستخدم
    function updateUserDisplay() {
        if (!userDisplayElement) return;
        
        const userData = globalUser.getUserData();
        
        if (userData) {
            const displayName = userData.name || userData.username || userData.commercialName || 'تاجر';
            userDisplayElement.textContent = `تاجر: ${displayName}`;
            
            if (merchantNameWelcome) {
                merchantNameWelcome.textContent = displayName;
            }
        } else {
            userDisplayElement.textContent = 'تاجر: جاري التحميل...';
            if (merchantNameWelcome) {
                merchantNameWelcome.textContent = 'جاري التحميل...';
            }
        }
    }
    
    // دالة للتحقق من رقم الجوال
    function validateMobile(mobile) {
        if (!mobile) return false;
        
        // تنظيف الرقم من الفراغات والشارات
        const cleanMobile = mobile.toString().replace(/\s+/g, '').replace(/[^\d]/g, '');
        
        // التحقق من الطول (عادة بين 9 و 15 رقماً)
        if (cleanMobile.length < 9 || cleanMobile.length > 15) {
            return false;
        }
        
        return cleanMobile;
    }
    
    // دالة للبحث عن تاجر برقم الجوال
    async function findMerchantByMobile(mobile) {
        try {
            const cleanMobile = validateMobile(mobile);
            if (!cleanMobile) {
                return { found: false, message: 'رقم الجوال غير صالح' };
            }
            
            // البحث في قاعدة بيانات التجار
            const merchantsSnapshot = await database.ref('merchants').once('value');
            const merchants = merchantsSnapshot.val();
            
            if (!merchants) {
                return { found: false, message: 'لا توجد تجار في قاعدة البيانات' };
            }
            
            // البحث عن التاجر الذي يطابق رقم الجوال
            let foundMerchant = null;
            let merchantId = null;
            
            Object.keys(merchants).forEach(key => {
                const merchant = merchants[key];
                if (merchant.mobile) {
                    const merchantMobile = validateMobile(merchant.mobile);
                    if (merchantMobile && merchantMobile === cleanMobile) {
                        foundMerchant = merchant;
                        merchantId = key;
                    }
                }
            });
            
            if (!foundMerchant) {
                return { found: false, message: 'لم يتم العثور على تاجر بهذا الرقم' };
            }
            
            return {
                found: true,
                merchant: foundMerchant,
                id: merchantId,
                mobile: cleanMobile
            };
            
        } catch (error) {
            console.error('خطأ في البحث عن التاجر:', error);
            return { found: false, message: `خطأ في البحث: ${error.message}` };
        }
    }
    
    // دالة للتحقق من عضوية التاجر
    async function checkMerchantMembership(mobile) {
        try {
            const cleanMobile = validateMobile(mobile);
            if (!cleanMobile) {
                return { isMember: false, message: 'رقم الجوال غير صالح' };
            }
            
            // البحث في نظام العضويات
            const membershipsSnapshot = await database.ref('membership_hierarchy').once('value');
            const memberships = membershipsSnapshot.val();
            
            if (!memberships) {
                return { isMember: false, message: 'لا توجد عضوية بهذا الرقم' };
            }
            
            // البحث عن العضوية التي تطابق رقم الجوال
            let membershipData = null;
            let membershipId = null;
            
            Object.keys(memberships).forEach(key => {
                const membership = memberships[key];
                if (membership.mobile && validateMobile(membership.mobile) === cleanMobile) {
                    membershipData = membership;
                    membershipId = key;
                }
            });
            
            if (!membershipData) {
                return { isMember: false, message: 'لا توجد عضوية مسجلة لهذا التاجر' };
            }
            
            return {
                isMember: true,
                membership: membershipData,
                id: membershipId,
                mobile: cleanMobile
            };
            
        } catch (error) {
            console.error('خطأ في التحقق من العضوية:', error);
            return { isMember: false, message: `خطأ في التحقق: ${error.message}` };
        }
    }
    
    // دالة لإنشاء عضوية جديدة
    async function createMembership(merchantData, merchantId) {
        try {
            const mobile = validateMobile(merchantData.mobile);
            if (!mobile) {
                throw new Error('رقم الجوال غير صالح');
            }
            
            // التحقق أولاً من عدم وجود عضوية مسبقة
            const existingCheck = await checkMerchantMembership(mobile);
            if (existingCheck.isMember) {
                return {
                    success: false,
                    message: 'التاجر لديه عضوية مسبقة',
                    membershipId: existingCheck.id
                };
            }
            
            // بيانات العضوية الجديدة
            const membershipData = {
                mobile: mobile,
                merchantId: merchantId,
                name: merchantData.name || merchantData.username || 'غير معروف',
                username: merchantData.username || 'غير معروف',
                joinDate: new Date().toISOString(),
                membershipLevel: 0,
                membershipRank: 'عادي',
                points: 0,
                directChildren: {},
                parentId: null,
                commissionRate: 0,
                status: 'active',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };
            
            // إضافة العضوية إلى قاعدة البيانات
            const newMembershipRef = database.ref('membership_hierarchy').push();
            await newMembershipRef.set(membershipData);
            
            return {
                success: true,
                message: 'تم إنشاء العضوية بنجاح',
                membershipId: newMembershipRef.key,
                membershipData: membershipData
            };
            
        } catch (error) {
            console.error('خطأ في إنشاء العضوية:', error);
            return {
                success: false,
                message: `خطأ في إنشاء العضوية: ${error.message}`
            };
        }
    }
    
    // دالة لإضافة تاجر ابن
    async function addChildMerchant(parentMobile, childMobile, commissionRate = 10) {
        try {
            // التحقق من رقم الجوال للوالد
            const parentCleanMobile = validateMobile(parentMobile);
            if (!parentCleanMobile) {
                throw new Error('رقم جوال الوالد غير صالح');
            }
            
            // التحقق من رقم الجوال للابن
            const childCleanMobile = validateMobile(childMobile);
            if (!childCleanMobile) {
                throw new Error('رقم جوال الابن غير صالح');
            }
            
            // منع إضافة التاجر لنفسه
            if (parentCleanMobile === childCleanMobile) {
                throw new Error('لا يمكن إضافة التاجر لنفسه');
            }
            
            // البحث عن عضوية الوالد
            const parentCheck = await checkMerchantMembership(parentCleanMobile);
            if (!parentCheck.isMember) {
                throw new Error('الوالد ليس لديه عضوية في النظام');
            }
            
            // البحث عن عضوية الابن
            const childCheck = await checkMerchantMembership(childCleanMobile);
            
            let childMembershipId;
            let childMembershipData;
            
            if (childCheck.isMember) {
                // إذا كان الابن لديه عضوية مسبقة، التحقق من أنه ليس لديه والد آخر
                if (childCheck.membership.parentId) {
                    throw new Error('التاجر الابن لديه والد مسبقاً');
                }
                
                childMembershipId = childCheck.id;
                childMembershipData = childCheck.membership;
            } else {
                // إذا لم يكن الابن لديه عضوية، البحث عنه في قاعدة بيانات التجار
                const merchantCheck = await findMerchantByMobile(childCleanMobile);
                if (!merchantCheck.found) {
                    throw new Error('التاجر الابن غير موجود في قاعدة البيانات');
                }
                
                // إنشاء عضوية جديدة للابن
                const createResult = await createMembership(merchantCheck.merchant, merchantCheck.id);
                if (!createResult.success) {
                    throw new Error(`فشل إنشاء عضوية للابن: ${createResult.message}`);
                }
                
                childMembershipId = createResult.membershipId;
                childMembershipData = createResult.membershipData;
            }
            
            // تحديث بيانات الابن لإضافة الوالد
            const updates = {};
            updates[`membership_hierarchy/${childMembershipId}/parentId`] = parentCheck.id;
            updates[`membership_hierarchy/${childMembershipId}/parentMobile`] = parentCleanMobile;
            updates[`membership_hierarchy/${childMembershipId}/commissionRate`] = parseInt(commissionRate) || 10;
            updates[`membership_hierarchy/${childMembershipId}/updatedAt`] = new Date().toISOString();
            
            // تحديث بيانات الوالد لإضافة الابن
            updates[`membership_hierarchy/${parentCheck.id}/directChildren/${childMembershipId}`] = {
                mobile: childCleanMobile,
                name: childMembershipData.name,
                commissionRate: parseInt(commissionRate) || 10,
                joinDate: new Date().toISOString()
            };
            
            updates[`membership_hierarchy/${parentCheck.id}/updatedAt`] = new Date().toISOString();
            
            // تنفيذ جميع التحديثات
            await database.ref().update(updates);
            
            return {
                success: true,
                message: 'تم إضافة التاجر الابن بنجاح',
                parentId: parentCheck.id,
                childId: childMembershipId
            };
            
        } catch (error) {
            console.error('خطأ في إضافة تاجر ابن:', error);
            return {
                success: false,
                message: `خطأ في الإضافة: ${error.message}`
            };
        }
    }
    
    // دالة لجلب جميع الأبناء
    async function getChildren(membershipId) {
        try {
            if (!membershipId) return [];
            
            // جلب بيانات العضوية
            const membershipSnapshot = await database.ref(`membership_hierarchy/${membershipId}`).once('value');
            const membership = membershipSnapshot.val();
            
            if (!membership || !membership.directChildren) {
                return [];
            }
            
            const children = [];
            const childrenIds = Object.keys(membership.directChildren);
            
            // جلب بيانات كل ابن
            for (const childId of childrenIds) {
                const childSnapshot = await database.ref(`membership_hierarchy/${childId}`).once('value');
                const childData = childSnapshot.val();
                
                if (childData) {
                    children.push({
                        id: childId,
                        ...childData,
                        ...membership.directChildren[childId]
                    });
                }
            }
            
            return children;
            
        } catch (error) {
            console.error('خطأ في جلب الأبناء:', error);
            return [];
        }
    }
    
    // دالة لحساب إحصائيات الشبكة
    async function calculateNetworkStats(membershipId) {
        try {
            if (!membershipId) return { total: 0, depth: 0 };
            
            let total = 0;
            let maxDepth = 0;
            
            // دالة متكررة لحساب الشبكة
            async function countNetwork(id, depth) {
                const snapshot = await database.ref(`membership_hierarchy/${id}`).once('value');
                const data = snapshot.val();
                
                if (!data || !data.directChildren) {
                    return 0;
                }
                
                // تحديث أقصى عمق
                maxDepth = Math.max(maxDepth, depth);
                
                const childrenIds = Object.keys(data.directChildren);
                let childrenCount = childrenIds.length;
                total += childrenCount;
                
                // عد أبناء كل ابن
                for (const childId of childrenIds) {
                    childrenCount += await countNetwork(childId, depth + 1);
                }
                
                return childrenCount;
            }
            
            const directChildrenCount = await countNetwork(membershipId, 1);
            
            return {
                direct: Object.keys(currentMembership.directChildren || {}).length,
                total: total,
                depth: maxDepth
            };
            
        } catch (error) {
            console.error('خطأ في حساب إحصائيات الشبكة:', error);
            return { total: 0, depth: 0, direct: 0 };
        }
    }
    
    // دالة لعرض الشجرة الهرمية
    function renderHierarchyTree(membership, children) {
        if (!hierarchyTree) return;
        
        // إخفاء رسالة عدم وجود بيانات
        if (treeNoData) {
            treeNoData.style.display = 'none';
        }
        
        // مسح الشجرة الحالية
        hierarchyTree.innerHTML = '';
        
        // مستوى التاجر الرئيسي
        const mainLevel = document.createElement('div');
        mainLevel.className = 'tree-level';
        
        const mainNode = document.createElement('div');
        mainNode.className = 'tree-node node-main';
        mainNode.innerHTML = `
            <div class="node-name">${membership.name || 'غير معروف'}</div>
            <div class="node-mobile">${membership.mobile || 'غير معروف'}</div>
            <div class="node-status status-active">أنت</div>
        `;
        
        mainLevel.appendChild(mainNode);
        hierarchyTree.appendChild(mainLevel);
        
        // إذا كان هناك أبناء، نعرضهم
        if (children && children.length > 0) {
            const childrenLevel = document.createElement('div');
            childrenLevel.className = 'tree-level';
            
            // إضافة خطوط الاتصال
            const connector = document.createElement('div');
            connector.className = 'node-connector';
            mainNode.appendChild(connector);
            
            children.forEach((child, index) => {
                const childNode = document.createElement('div');
                childNode.className = 'tree-node node-child';
                childNode.innerHTML = `
                    <div class="node-name">${child.name || 'غير معروف'}</div>
                    <div class="node-mobile">${child.mobile || 'غير معروف'}</div>
                    <div class="node-status">ابن ${index + 1}</div>
                `;
                
                childrenLevel.appendChild(childNode);
            });
            
            hierarchyTree.appendChild(childrenLevel);
        }
    }
    
    // دالة لعرض قائمة الأبناء
    function renderChildrenList(children) {
        if (!childrenTableBody) return;
        
        // مسح الجدول الحالي
        childrenTableBody.innerHTML = '';
        
        if (!children || children.length === 0) {
            // عرض رسالة عدم وجود بيانات
            if (childrenNoData) {
                childrenNoData.style.display = 'block';
            }
            if (childrenTableBody.parentNode.parentNode) {
                childrenTableBody.parentNode.parentNode.style.display = 'none';
            }
            return;
        }
        
        // إخفاء رسالة عدم وجود بيانات
        if (childrenNoData) {
            childrenNoData.style.display = 'none';
        }
        if (childrenTableBody.parentNode.parentNode) {
            childrenTableBody.parentNode.parentNode.style.display = 'block';
        }
        
        // عرض كل ابن في الصف
        children.forEach((child, index) => {
            const row = document.createElement('tr');
            
            // تنسيق تاريخ الإضافة
            const joinDate = child.joinDate ? new Date(child.joinDate).toLocaleDateString('ar-EG') : 'غير معروف';
            
            row.innerHTML = `
                <td>${index + 1}</td>
                <td>${child.name || 'غير معروف'}</td>
                <td>${child.mobile || 'غير معروف'}</td>
                <td>${joinDate}</td>
                <td>${child.commissionRate || 10}%</td>
                <td>
                    <span class="node-status status-active">نشط</span>
                </td>
                <td>
                    <div class="table-actions">
                        <button class="btn btn-primary btn-small view-child-btn" data-id="${child.id}">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-danger btn-small remove-child-btn" data-id="${child.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </td>
            `;
            
            childrenTableBody.appendChild(row);
        });
        
        // إضافة مستمعات الأحداث للأزرار
        document.querySelectorAll('.view-child-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const childId = this.getAttribute('data-id');
                viewChildDetails(childId);
            });
        });
        
        document.querySelectorAll('.remove-child-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const childId = this.getAttribute('data-id');
                removeChild(childId);
            });
        });
    }
    
    // دالة لعرض تفاصيل الابن
    async function viewChildDetails(childId) {
        try {
            const childSnapshot = await database.ref(`membership_hierarchy/${childId}`).once('value');
            const childData = childSnapshot.val();
            
            if (!childData) {
                showToast('لم يتم العثور على بيانات الابن', 'error');
                return;
            }
            
            const message = `
                اسم التاجر: ${childData.name || 'غير معروف'}
                رقم الجوال: ${childData.mobile || 'غير معروف'}
                تاريخ الانضمام: ${new Date(childData.joinDate || '').toLocaleDateString('ar-EG')}
                مستوى العضوية: ${childData.membershipLevel || 0}
                نسبة العمولة: ${childData.commissionRate || 10}%
            `;
            
            showToast(message, 'info');
            
        } catch (error) {
            console.error('خطأ في عرض تفاصيل الابن:', error);
            showToast('خطأ في عرض التفاصيل', 'error');
        }
    }
    
    // دالة لإزالة ابن
    async function removeChild(childId) {
        if (!confirm('هل أنت متأكد من إزالة هذا التاجر الابن؟')) {
            return;
        }
        
        try {
            if (!currentMembership || !currentMembership.id) {
                showToast('لا توجد بيانات عضوية حالية', 'error');
                return;
            }
            
            // جلب بيانات الابن
            const childSnapshot = await database.ref(`membership_hierarchy/${childId}`).once('value');
            const childData = childSnapshot.val();
            
            if (!childData) {
                showToast('لم يتم العثور على التاجر الابن', 'error');
                return;
            }
            
            // التحقق من أن الابن مرتبط بالوالد الحالي
            if (childData.parentId !== currentMembership.id) {
                showToast('هذا التاجر ليس ابناً لك', 'error');
                return;
            }
            
            // تحديثات قاعدة البيانات
            const updates = {};
            
            // إزالة الابن من قائمة أبناء الوالد
            updates[`membership_hierarchy/${currentMembership.id}/directChildren/${childId}`] = null;
            updates[`membership_hierarchy/${currentMembership.id}/updatedAt`] = new Date().toISOString();
            
            // إزالة الوالد من بيانات الابن
            updates[`membership_hierarchy/${childId}/parentId`] = null;
            updates[`membership_hierarchy/${childId}/parentMobile`] = null;
            updates[`membership_hierarchy/${childId}/updatedAt`] = new Date().toISOString();
            
            // تنفيذ التحديثات
            await database.ref().update(updates);
            
            showToast('تم إزالة التاجر الابن بنجاح', 'success');
            
            // إعادة تحميل البيانات
            loadMerchantMembership();
            
        } catch (error) {
            console.error('خطأ في إزالة الابن:', error);
            showToast(`خطأ في الإزالة: ${error.message}`, 'error');
        }
    }
    
    // دالة لعرض إحصائيات العضوية
    function renderMembershipStats(membership, children, networkStats) {
        if (!membership) return;
        
        // معلومات العضوية الأساسية
        if (membershipId) membershipId.textContent = membership.id || '-';
        if (membershipJoinDate) {
            membershipJoinDate.textContent = membership.joinDate ? 
                new Date(membership.joinDate).toLocaleDateString('ar-EG') : '-';
        }
        if (membershipLevel) membershipLevel.textContent = membership.membershipLevel || 0;
        if (membershipRank) membershipRank.textContent = membership.membershipRank || 'عادي';
        if (membershipPoints) membershipPoints.textContent = membership.points || 0;
        
        // إحصائيات الشبكة
        if (directChildrenCount) {
            directChildrenCount.textContent = children ? children.length : 0;
        }
        if (totalNetworkCount) {
            totalNetworkCount.textContent = networkStats.total || 0;
        }
        if (maxDepth) {
            maxDepth.textContent = networkStats.depth || 0;
        }
        
        // حساب متوسط العمولة
        if (avgCommission) {
            if (children && children.length > 0) {
                const totalCommission = children.reduce((sum, child) => sum + (parseInt(child.commissionRate) || 0), 0);
                const average = Math.round(totalCommission / children.length);
                avgCommission.textContent = `${average}%`;
            } else {
                avgCommission.textContent = '0%';
            }
        }
        
        // إجمالي العمولات (محاكاة)
        if (totalCommissions) {
            const totalCommissionsValue = children ? children.length * 100 : 0; // قيمة افتراضية
            totalCommissions.textContent = `${totalCommissionsValue} ر.س`;
        }
        
        // المكافآت (محاكاة)
        if (pendingRewards) {
            pendingRewards.textContent = '0 ر.س';
        }
        if (paidRewards) {
            paidRewards.textContent = '0 ر.س';
        }
        
        // الأهداف (محاكاة)
        if (nextTarget) {
            const nextTargetValue = children ? Math.max(0, 10 - children.length) : 10;
            nextTarget.textContent = `${nextTargetValue} أبناء للترقية`;
        }
        
        if (nextReward) {
            nextReward.textContent = 'مكافأة ترقية مستوى';
        }
        
        if (lastPromotion) {
            lastPromotion.textContent = membership.joinDate ? 
                new Date(membership.joinDate).toLocaleDateString('ar-EG') : '-';
        }
    }
    
    // دالة لعرض بيانات التاجر
    function renderMerchantData(merchant, membership) {
        if (!merchant) return;
        
        if (merchantNameCard) merchantNameCard.textContent = merchant.name || merchant.username || 'غير معروف';
        if (merchantNameValue) merchantNameValue.textContent = merchant.name || merchant.username || 'غير معروف';
        if (merchantMobile) merchantMobile.textContent = merchant.mobile || 'غير معروف';
        if (merchantPhone) merchantPhone.textContent = merchant.phone || 'غير معروف';
        if (merchantGovernorate) merchantGovernorate.textContent = merchant.governorate || 'غير معروف';
        if (merchantArea) merchantArea.textContent = merchant.area || 'غير معروف';
        if (merchantCreatedAt) {
            merchantCreatedAt.textContent = merchant.createdAt ? 
                new Date(merchant.createdAt).toLocaleDateString('ar-EG') : 'غير معروف';
        }
        
        // حالة العضوية
        if (merchantStatus) {
            merchantStatus.textContent = merchant.status === 'active' ? 'نشط' : 'موقف';
            merchantStatus.className = `merchant-status status-${merchant.status || 'active'}`;
        }
        
        if (welcomeStatus) {
            welcomeStatus.textContent = merchant.status === 'active' ? 'نشط' : 'موقف';
            welcomeStatus.className = `welcome-status status-${merchant.status || 'active'}`;
        }
        
        // بيانات العضوية
        if (merchantMembershipStatus) {
            merchantMembershipStatus.textContent = membership ? membership.membershipRank || 'عادي' : 'غير مسجل';
        }
        
        if (merchantHierarchyLevel) {
            merchantHierarchyLevel.textContent = membership ? membership.membershipLevel || 0 : 0;
        }
        
        if (merchantChildrenCount) {
            merchantChildrenCount.textContent = merchantChildren.length;
        }
        
        // تحديث الجلوبالات
        if (globalChildrenCount) {
            globalChildrenCount.textContent = merchantChildren.length;
        }
        
        if (globalMembershipLevel) {
            globalMembershipLevel.textContent = membership ? membership.membershipLevel || 0 : 0;
        }
        
        if (globalMembershipStatus) {
            globalMembershipStatus.textContent = membership ? membership.membershipRank || 'عادي' : 'غير مسجل';
        }
        
        // تحديث إحصائيات الشجرة
        if (statTotalChildren) statTotalChildren.textContent = merchantChildren.length;
        if (statHierarchyLevel) statHierarchyLevel.textContent = membership ? membership.membershipLevel || 0 : 0;
        if (statNetworkSize) statNetworkSize.textContent = merchantChildren.length;
        if (statMembershipRank) statMembershipRank.textContent = membership ? membership.membershipRank || 'عادي' : 'غير مسجل';
    }
    
    // دالة لتحميل بيانات العضوية
    async function loadMerchantMembership() {
        try {
            if (loadingIndicator) loadingIndicator.style.display = 'block';
            
            // إخفاء جميع الأقسام
            if (merchantData) merchantData.style.display = 'none';
            if (hierarchySection) hierarchySection.style.display = 'none';
            if (childrenSection) childrenSection.style.display = 'none';
            if (membershipStats) membershipStats.style.display = 'none';
            if (noMembership) noMembership.style.display = 'none';
            
            // الحصول على بيانات المستخدم من الجلوبالات
            const userData = globalUser.getUserData();
            if (!userData || !userData.mobile) {
                throw new Error('لا توجد بيانات مستخدم في الجلوبالات');
            }
            
            const userMobile = validateMobile(userData.mobile);
            if (!userMobile) {
                throw new Error('رقم الجوال في الجلوبالات غير صالح');
            }
            
            // البحث عن التاجر في قاعدة البيانات
            const merchantCheck = await findMerchantByMobile(userMobile);
            if (!merchantCheck.found) {
                throw new Error('التاجر غير موجود في قاعدة البيانات');
            }
            
            currentMerchant = {
                id: merchantCheck.id,
                ...merchantCheck.merchant
            };
            
            // التحقق من العضوية
            const membershipCheck = await checkMerchantMembership(userMobile);
            
            if (!membershipCheck.isMember) {
                // إنشاء عضوية جديدة تلقائياً
                showToast('جاري إنشاء عضوية جديدة لك...', 'info');
                
                const createResult = await createMembership(currentMerchant, merchantCheck.id);
                if (!createResult.success) {
                    throw new Error(`فشل إنشاء العضوية: ${createResult.message}`);
                }
                
                currentMembership = createResult.membershipData;
                currentMembership.id = createResult.membershipId;
                
                showToast('تم إنشاء عضوية جديدة لك بنجاح', 'success');
            } else {
                currentMembership = membershipCheck.membership;
                currentMembership.id = membershipCheck.id;
            }
            
            // جلب الأبناء
            merchantChildren = await getChildren(currentMembership.id);
            
            // حساب إحصائيات الشبكة
            const networkStats = await calculateNetworkStats(currentMembership.id);
            
            // تحديث واجهة المستخدم
            updateUserDisplay();
            renderMerchantData(currentMerchant, currentMembership);
            renderHierarchyTree(currentMembership, merchantChildren);
            renderChildrenList(merchantChildren);
            renderMembershipStats(currentMembership, merchantChildren, networkStats);
            
            // إظهار الأقسام
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            if (merchantData) merchantData.style.display = 'block';
            if (hierarchySection) hierarchySection.style.display = 'block';
            if (childrenSection) childrenSection.style.display = 'block';
            if (membershipStats) membershipStats.style.display = 'block';
            
            showToast('تم تحميل بيانات العضوية بنجاح', 'success');
            
        } catch (error) {
            console.error('خطأ في تحميل بيانات العضوية:', error);
            
            if (loadingIndicator) loadingIndicator.style.display = 'none';
            
            // عرض رسالة الخطأ
            if (noMembershipTitle) noMembershipTitle.textContent = "خطأ في تحميل البيانات";
            if (noMembershipDesc) noMembershipDesc.textContent = error.message;
            if (noMembership) noMembership.style.display = 'block';
            
            showToast(`خطأ في تحميل البيانات: ${error.message}`, 'error');
        }
    }
    
    // ===== إعداد مستمعات الأحداث =====
    
    // البحث عن تاجر عند إدخال رقم الجوال
    childMobileInput.addEventListener('input', async function() {
        const mobile = this.value.trim();
        
        if (!mobile || mobile.length < 9) {
            childSearchResult.style.display = 'none';
            foundMerchant = null;
            return;
        }
        
        // إظهار حالة التحميل
        childSearchResult.style.display = 'block';
        foundMerchantInfo.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري البحث...';
        
        // البحث عن التاجر
        const result = await findMerchantByMobile(mobile);
        
        if (result.found) {
            foundMerchant = result;
            foundMerchantInfo.innerHTML = `
                <div style="display: flex; flex-direction: column; gap: 5px;">
                    <div><strong>اسم التاجر:</strong> ${result.merchant.name || result.merchant.username || 'غير معروف'}</div>
                    <div><strong>رقم الجوال:</strong> ${result.mobile}</div>
                    <div><strong>الحالة:</strong> <span style="color: var(--success);">✓ متاح للإضافة</span></div>
                </div>
            `;
        } else {
            foundMerchant = null;
            foundMerchantInfo.innerHTML = `
                <div style="color: var(--danger);">
                    <i class="fas fa-exclamation-circle"></i> ${result.message}
                </div>
            `;
        }
    });
    
    // إضافة تاجر ابن
    confirmAddChildBtn.addEventListener('click', async function() {
        if (!currentMerchant || !currentMerchant.mobile) {
            showToast('لا توجد بيانات تاجر حالية', 'error');
            return;
        }
        
        if (!foundMerchant) {
            showToast('يرجى البحث عن تاجر صالح أولاً', 'error');
            return;
        }
        
        const commissionRate = childCommissionInput.value.trim();
        if (!commissionRate || isNaN(commissionRate) || commissionRate < 0 || commissionRate > 100) {
            showToast('يرجى إدخال نسبة عمولة صالحة بين 0 و 100', 'error');
            return;
        }
        
        // إظهار حالة التحميل
        confirmAddChildBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإضافة...';
        confirmAddChildBtn.disabled = true;
        
        // إضافة التاجر الابن
        const result = await addChildMerchant(
            currentMerchant.mobile,
            foundMerchant.mobile,
            commissionRate
        );
        
        // إعادة تعيين الزر
        confirmAddChildBtn.innerHTML = '<i class="fas fa-check"></i> تأكيد الإضافة';
        confirmAddChildBtn.disabled = false;
        
        if (result.success) {
            showToast(result.message, 'success');
            
            // إعادة تعيين النموذج
            childMobileInput.value = '';
            childCommissionInput.value = '10';
            childSearchResult.style.display = 'none';
            addChildForm.style.display = 'none';
            foundMerchant = null;
            
            // إعادة تحميل البيانات
            loadMerchantMembership();
        } else {
            showToast(result.message, 'error');
        }
    });
    
    // إلغاء إضافة تاجر ابن
    cancelAddChildBtn.addEventListener('click', function() {
        childMobileInput.value = '';
        childCommissionInput.value = '10';
        childSearchResult.style.display = 'none';
        addChildForm.style.display = 'none';
        foundMerchant = null;
    });
    
    // إظهار/إخفاء نموذج إضافة تاجر ابن
    addChildBtn.addEventListener('click', function() {
        addChildForm.style.display = addChildForm.style.display === 'none' ? 'block' : 'none';
    });
    
    // زر إضافة تاجر ابن في الجلوبالات
    globalsAddChildBtn.addEventListener('click', function() {
        addChildForm.style.display = addChildForm.style.display === 'none' ? 'block' : 'none';
        
        // تمرير إلى نموذج الإضافة
        if (addChildForm.style.display === 'block') {
            addChildForm.scrollIntoView({ behavior: 'smooth' });
        }
    });
    
    // زر تحديث البيانات
    globalsRefreshBtn.addEventListener('click', function() {
        loadMerchantMembership();
        showToast('جاري تحديث البيانات...', 'info');
    });
    
    // زر عرض الشجرة
    globalsTreeViewBtn.addEventListener('click', function() {
        if (hierarchySection) {
            hierarchySection.scrollIntoView({ behavior: 'smooth' });
        }
    });
    
    // زر إنشاء عضوية جديدة
    if (createMembershipBtn) {
        createMembershipBtn.addEventListener('click', async function() {
            // الحصول على بيانات المستخدم من الجلوبالات
            const userData = globalUser.getUserData();
            if (!userData || !userData.mobile) {
                showToast('لا توجد بيانات مستخدم في الجلوبالات', 'error');
                return;
            }
            
            // البحث عن التاجر أولاً
            const merchantCheck = await findMerchantByMobile(userData.mobile);
            if (!merchantCheck.found) {
                showToast('التاجر غير موجود في قاعدة البيانات', 'error');
                return;
            }
            
            // إنشاء العضوية
            createMembershipBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> جاري الإنشاء...';
            createMembershipBtn.disabled = true;
            
            const result = await createMembership(merchantCheck.merchant, merchantCheck.id);
            
            createMembershipBtn.innerHTML = '<i class="fas fa-user-plus"></i> إنشاء عضوية جديدة';
            createMembershipBtn.disabled = false;
            
            if (result.success) {
                showToast(result.message, 'success');
                loadMerchantMembership();
            } else {
                showToast(result.message, 'error');
            }
        });
    }
    
    // ===== تهيئة الصفحة =====
    document.addEventListener('DOMContentLoaded', function() {
        // تحديث عرض اسم المستخدم
        updateUserDisplay();
        
        // تحميل بيانات العضوية
        loadMerchantMembership();
        
        // عرض رسالة ترحيبية
        showToast('مرحباً بك في نظام العضويات الهرمي', 'info');
    });
</script>

</body>
</html>
