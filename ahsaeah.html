<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
<style>
  body { font-family: Arial; direction: rtl; padding: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f0f0f0; }
  button { padding: 4px 8px; cursor: pointer; }
  input { padding: 5px; margin-right: 10px; }
  .tabs { margin-bottom: 20px; }
  .tab { padding: 10px 20px; cursor: pointer; background: #f0f0f0; border: 1px solid #ccc; margin-left: 5px; }
  .tab.active { background: #ddd; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .banned-text { color: red; font-weight: bold; }
  .user-info { 
    background: #f8f8f8; 
    padding: 10px; 
    border: 1px solid #ddd; 
    margin-bottom: 15px; 
    border-radius: 5px;
  }
  .user-info span {
    font-weight: bold;
    color: #2c3e50;
  }
</style>
</head>
<body>

<h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h1>

<!-- Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ -->
<div class="user-info">
  <strong>Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong><br>
  Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…: <span id="currentUserId">-</span> | 
  Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø©: <span id="currentPageUrl">-</span>
</div>

<div class="tabs">
  <button class="tab active" onclick="openTab('visitors')">Ø§Ù„Ø²ÙˆØ§Ø±</button>
  <button class="tab" onclick="openTab('pages')">Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµÙØ­Ø§Øª</button>
  <button class="tab" onclick="openTab('banned')">Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</button>
</div>

<div id="visitors" class="tab-content active">
  <div>
    <label>Ø¨Ø­Ø« Ø­Ø³Ø¨ IP: <input type="text" id="searchIP" placeholder="Ø§Ø¯Ø®Ù„ IP"></label>
    <label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©: <input type="text" id="filterPage" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙØ­Ø©"></label>
    <button onclick="updateVisitorsTable()">ØªØ·Ø¨ÙŠÙ‚</button>
    <button onclick="exportCSV()">ØªØµØ¯ÙŠØ± CSV</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ø²Ø§Ø¦Ø±</th>
        <th>IP</th>
        <th>Ø§Ù„ØµÙØ­Ø©</th>
        <th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
        <th>ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</th>
        <th>Ù…ØªÙˆØ§Ø¬Ø¯ Ø­Ø§Ù„ÙŠÙ‹Ø§</th>
        <th>Ø­Ø¸Ø±</th>
        <th>ÙˆÙ‚Øª Ø§Ù„Ø¬Ù„ÙˆØ³ (Ø«ÙˆØ§Ù†ÙŠ)</th>
      </tr>
    </thead>
    <tbody id="visitorsTable"></tbody>
  </table>
</div>

<div id="pages" class="tab-content">
  <h2>Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµÙØ­Ø§Øª</h2>
  <table>
    <thead>
      <tr>
        <th>Ø§Ø³Ù… Ø§Ù„ØµÙØ­Ø©</th>
        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ø¯Ø§Ø®Ù„ÙŠÙ†</th>
        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…ØªÙˆØ§Ø¬Ø¯ÙŠÙ†</th>
        <th>Ø¹Ø¯Ø¯ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…ØºØ§Ø¯Ø±ÙŠÙ†</th>
      </tr>
    </thead>
    <tbody id="pagesTable"></tbody>
  </table>
</div>

<div id="banned" class="tab-content">
  <h2>Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†</h2>
  <table>
    <thead>
      <tr>
        <th>Ø§Ù„Ø²Ø§Ø¦Ø±</th>
        <th>IP</th>
        <th>Ø§Ù„ØµÙØ­Ø©</th>
        <th>ÙˆÙ‚Øª Ø§Ù„Ø­Ø¸Ø±</th>
        <th>Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</th>
      </tr>
    </thead>
    <tbody id="bannedTable"></tbody>
  </table>
</div>

<canvas id="chart" width="800" height="300"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ğŸ”¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø³Ø§Ø± Ø§Ù„Ø²ÙˆØ§Ø± Ø¨Ø¯Ù„ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬
const usersRef = db.ref("visitors");
const bannedRef = db.ref("bannedVisitors");

// ğŸ”¹ ØªÙˆÙ„ÙŠØ¯ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
function generateUserId() {
  // Ù…Ø­Ø§ÙˆÙ„Ø© Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø¹Ø±Ù Ù…Ù† localStorage Ø¥Ø°Ø§ ÙƒØ§Ù† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
  let userId = localStorage.getItem('currentUserId');
  if (!userId) {
    // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ù†Ù†Ø´Ø¦ Ù…Ø¹Ø±Ù Ø¬Ø¯ÙŠØ¯
    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('currentUserId', userId);
  }
  return userId;
}

// ğŸ”¹ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø¹Ù†ÙˆØ§Ù† Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠ
function getCurrentPageUrl() {
  return window.location.href;
}

// ğŸ”¹ ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
function updateCurrentUserInfo() {
  const userId = generateUserId();
  const pageUrl = getCurrentPageUrl();
  
  document.getElementById('currentUserId').textContent = userId;
  document.getElementById('currentPageUrl').textContent = pageUrl;
  
  // ÙŠÙ…ÙƒÙ†Ùƒ Ø£ÙŠØ¶Ø§Ù‹ Ø­ÙØ¸ Ù‡Ø°Ù‡ Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙÙŠ Firebase Ø¥Ø°Ø§ Ø£Ø±Ø¯Øª
  // saveCurrentUserInfo(userId, pageUrl);
}

// ğŸ”¹ Ø­ÙØ¸ Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ ÙÙŠ Firebase (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)
function saveCurrentUserInfo(userId, pageUrl) {
  const currentUserRef = db.ref("currentAdmin");
  currentUserRef.set({
    userId: userId,
    pageUrl: pageUrl,
    lastActive: new Date().toISOString()
  });
}

// ğŸ”¹ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
function openTab(tabName) {
  // Ø¥Ø®ÙØ§Ø¡ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­ØªÙˆÙŠØ§Øª
  const tabContents = document.getElementsByClassName("tab-content");
  for (let i = 0; i < tabContents.length; i++) {
    tabContents[i].classList.remove("active");
  }
  
  // Ø¥Ù„ØºØ§Ø¡ ØªÙ†Ø´ÙŠØ· Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¨ÙˆÙŠØ¨Ø§Øª
  const tabs = document.getElementsByClassName("tab");
  for (let i = 0; i < tabs.length; i++) {
    tabs[i].classList.remove("active");
  }
  
  // Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ ÙˆØªÙ†Ø´ÙŠØ· Ø§Ù„ØªØ¨ÙˆÙŠØ¨
  document.getElementById(tabName).classList.add("active");
  event.currentTarget.classList.add("active");
  
  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ ÙØªØ­ Ø§Ù„ØªØ¨ÙˆÙŠØ¨
  if (tabName === 'pages') {
    updatePagesTable();
  } else if (tabName === 'banned') {
    updateBannedTable();
  }
}

// ğŸ”¹ ØªØ­Ø¯ÙŠØ« ÙˆØ¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø±
function updateVisitorsTable(){
  const searchIP = document.getElementById("searchIP").value.trim();
  const filterPage = document.getElementById("filterPage").value.trim().toLowerCase();

  // Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ† Ø£ÙˆÙ„Ø§Ù‹
  bannedRef.once("value").then(bannedSnapshot => {
    const bannedVisitors = bannedSnapshot.val() || {};
    const bannedIds = Object.keys(bannedVisitors);
    
    // Ø«Ù… Ø¬Ù„Ø¨ Ø¨ÙŠØ§Ù†Ø§Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø²ÙˆØ§Ø±
    usersRef.once("value").then(snapshot => {
      const visitors = snapshot.val();
      const tbody = document.getElementById("visitorsTable");
      tbody.innerHTML = "";
      if(!visitors) return;

      const chartData = {};
      Object.keys(visitors).forEach(id => {
        const v = visitors[id];
        const enterTime = v.enterTime ? new Date(v.enterTime) : null;
        const exitTime = v.exitTime ? new Date(v.exitTime) : null;
        const online = v.online ? "Ù†Ø¹Ù…" : "Ù„Ø§";
        let duration = "";
        if(enterTime){
          const end = exitTime || new Date();
          duration = Math.floor((end - enterTime)/1000); // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
        }

        // ÙÙ„ØªØ±Ø© IP ÙˆØ§Ù„ØµÙØ­Ø©
        if(searchIP && (!v.ip || !v.ip.includes(searchIP))) return;
        if(filterPage && (!v.page || !v.page.toLowerCase().includes(filterPage))) return;

        // ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
        if(!chartData[v.page]) chartData[v.page] = {online:0, offline:0};
        v.online ? chartData[v.page].online++ : chartData[v.page].offline++;

        const tr = document.createElement("tr");
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ø²Ø§Ø¦Ø± Ù…Ø­Ø¸ÙˆØ±Ø§Ù‹
        const isBanned = bannedIds.includes(id);
        
        tr.innerHTML = `
          <td>${v.visitorId || id}</td>
          <td>${v.ip || "-"}</td>
          <td>${v.page || "-"}</td>
          <td>${enterTime ? enterTime.toLocaleString() : "-"}</td>
          <td>${exitTime ? exitTime.toLocaleString() : "-"}</td>
          <td>${online}</td>
          <td>
            ${isBanned ? 
              '<span class="banned-text">Ù…Ø­Ø¸ÙˆØ±</span>' : 
              `<button onclick="banVisitor('${id}', '${v.ip || ''}', '${v.page || ''}')">Ø­Ø¸Ø±</button>`
            }
          </td>
          <td>${duration}</td>
        `;
        tbody.appendChild(tr);
      });

      updateChart(chartData);
    });
  });
}

// ğŸ”¹ ØªØ­Ø¯ÙŠØ« ÙˆØ¹Ø±Ø¶ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„ØµÙØ­Ø§Øª
function updatePagesTable() {
  usersRef.once("value").then(snapshot => {
    const visitors = snapshot.val();
    const tbody = document.getElementById("pagesTable");
    tbody.innerHTML = "";
    if(!visitors) return;

    const pageStats = {};
    
    Object.keys(visitors).forEach(id => {
      const v = visitors[id];
      const page = v.page || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
      
      if (!pageStats[page]) {
        pageStats[page] = {
          total: 0,
          online: 0,
          offline: 0
        };
      }
      
      pageStats[page].total++;
      if (v.online) {
        pageStats[page].online++;
      } else {
        pageStats[page].offline++;
      }
    });

    Object.keys(pageStats).forEach(page => {
      const stats = pageStats[page];
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${page}</td>
        <td>${stats.total}</td>
        <td>${stats.online}</td>
        <td>${stats.offline}</td>
      `;
      tbody.appendChild(tr);
    });
  });
}

// ğŸ”¹ ØªØ­Ø¯ÙŠØ« ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…Ø­Ø¸ÙˆØ±ÙŠÙ†
function updateBannedTable() {
  bannedRef.once("value").then(snapshot => {
    const bannedVisitors = snapshot.val();
    const tbody = document.getElementById("bannedTable");
    tbody.innerHTML = "";
    if(!bannedVisitors) return;

    Object.keys(bannedVisitors).forEach(id => {
      const v = bannedVisitors[id];
      const banTime = v.banTime ? new Date(v.banTime) : null;
      
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${v.visitorId || id}</td>
        <td>${v.ip || "-"}</td>
        <td>${v.page || "-"}</td>
        <td>${banTime ? banTime.toLocaleString() : "-"}</td>
        <td><button onclick="unbanVisitor('${id}')">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¸Ø±</button></td>
      `;
      tbody.appendChild(tr);
    });
  });
}

// ğŸ”¹ Ø­Ø¸Ø± Ø§Ù„Ø²Ø§Ø¦Ø±
function banVisitor(visitorId, ip, page) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø²Ø§Ø¦Ø±ØŸ")) return;
  
  const banData = {
    visitorId: visitorId,
    ip: ip,
    page: page,
    banTime: new Date().toISOString(),
    bannedBy: generateUserId() // Ø¥Ø¶Ø§ÙØ© Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø°ÙŠ Ù‚Ø§Ù… Ø¨Ø§Ù„Ø­Ø¸Ø±
  };
  
  bannedRef.child(visitorId).set(banData).then(() => {
    alert("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø²Ø§Ø¦Ø±!");
    updateVisitorsTable();
    updateBannedTable();
  });
}

// ğŸ”¹ Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ø²Ø§Ø¦Ø±
function unbanVisitor(visitorId) {
  if (!confirm("Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ù‡Ø°Ø§ Ø§Ù„Ø²Ø§Ø¦Ø±ØŸ")) return;
  
  bannedRef.child(visitorId).remove().then(() => {
    alert("ØªÙ… Ø¥Ù„ØºØ§Ø¡ Ø­Ø¸Ø± Ø§Ù„Ø²Ø§Ø¦Ø±!");
    updateVisitorsTable();
    updateBannedTable();
  });
}

// ğŸ”¹ ØªØµØ¯ÙŠØ± CSV
function exportCSV(){
  const rows = [["visitorId","IP","Ø§Ù„ØµÙØ­Ø©","ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„","ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬","Ù…ØªÙˆØ§Ø¬Ø¯","Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„ÙˆØ³"]];
  const table = document.getElementById("visitorsTable");
  for(let tr of table.rows){
    const row = [];
    for(let td of tr.cells){
      row.push(td.innerText);
    }
    rows.push(row);
  }
  const csvContent = "data:text/csv;charset=utf-8," + rows.map(e=>e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "visitors.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ğŸ”¹ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Chart.js
let chart;
function updateChart(chartData){
  const ctx = document.getElementById("chart").getContext("2d");
  const labels = Object.keys(chartData);
  const onlineData = labels.map(l=>chartData[l].online);
  const offlineData = labels.map(l=>chartData[l].offline);

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'Ù…ØªÙˆØ§Ø¬Ø¯', data: onlineData, backgroundColor: 'green' },
        { label: 'Ù…ØºØ§Ø¯Ø±', data: offlineData, backgroundColor: 'red' }
      ]
    },
    options: { responsive:true, plugins:{legend:{position:'top'}} }
  });
}

// ğŸ”¹ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
updateCurrentUserInfo(); // ØªØ­Ø¯ÙŠØ« Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø­Ø§Ù„ÙŠ
updateVisitorsTable();
setInterval(updateVisitorsTable,5000);
</script>
</body>
</html>
