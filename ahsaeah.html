<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</title>
<style>
  body { font-family: Arial; direction: rtl; padding: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f0f0f0; }
  button { padding: 4px 8px; cursor: pointer; }
  input { padding: 5px; margin-right: 10px; }
</style>
</head>
<body>

<h1>Ù„ÙˆØ­Ø© ØªØ­ÙƒÙ… Ø§Ù„Ø²ÙˆØ§Ø± Ø§Ù„Ù…ØªÙ‚Ø¯Ù…Ø©</h1>

<div>
  <label>Ø¨Ø­Ø« Ø­Ø³Ø¨ IP: <input type="text" id="searchIP" placeholder="Ø§Ø¯Ø®Ù„ IP"></label>
  <label>ÙÙ„ØªØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ØµÙØ­Ø©: <input type="text" id="filterPage" placeholder="Ø§Ø³Ù… Ø§Ù„ØµÙØ­Ø©"></label>
  <button onclick="updateVisitorsTable()">ØªØ·Ø¨ÙŠÙ‚</button>
  <button onclick="exportCSV()">ØªØµØ¯ÙŠØ± CSV</button>
</div>

<table>
  <thead>
    <tr>
      <th>Ø§Ù„Ø²Ø§Ø¦Ø±</th>
      <th>IP</th>
      <th>Ø§Ù„ØµÙØ­Ø©</th>
      <th>ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„</th>
      <th>ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</th>
      <th>Ù…ØªÙˆØ§Ø¬Ø¯ Ø­Ø§Ù„ÙŠÙ‹Ø§</th>
      <th>Ø­Ø¸Ø±</th>
      <th>ÙˆÙ‚Øª Ø§Ù„Ø¬Ù„ÙˆØ³ (Ø«ÙˆØ§Ù†ÙŠ)</th>
    </tr>
  </thead>
  <tbody id="visitorsTable"></tbody>
</table>

<canvas id="chart" width="800" height="300"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// ğŸ”¹ Ø¥Ø¹Ø¯Ø§Ø¯ Firebase
const firebaseConfig = {
  databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// ğŸ”¹ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ù…Ø³Ø§Ø± Ø§Ù„Ø²ÙˆØ§Ø± Ø¨Ø¯Ù„ Ù…Ø³Ø§Ø± Ø§Ù„Ù…Ù†ØªØ¬
const usersRef = db.ref("visitors");

// ğŸ”¹ ØªØ­Ø¯ÙŠØ« ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
function updateVisitorsTable(){
  const searchIP = document.getElementById("searchIP").value.trim();
  const filterPage = document.getElementById("filterPage").value.trim().toLowerCase();

  usersRef.once("value").then(snapshot => {
    const visitors = snapshot.val();
    const tbody = document.getElementById("visitorsTable");
    tbody.innerHTML = "";
    if(!visitors) return;

    const chartData = {};
    Object.keys(visitors).forEach(id => {
      const v = visitors[id];
      const enterTime = v.enterTime ? new Date(v.enterTime) : null;
      const exitTime = v.exitTime ? new Date(v.exitTime) : null;
      const online = v.online ? "Ù†Ø¹Ù…" : "Ù„Ø§";
      let duration = "";
      if(enterTime){
        const end = exitTime || new Date();
        duration = Math.floor((end - enterTime)/1000); // Ø¨Ø§Ù„Ø«ÙˆØ§Ù†ÙŠ
      }

      // ÙÙ„ØªØ±Ø© IP ÙˆØ§Ù„ØµÙØ­Ø©
      if(searchIP && (!v.ip || !v.ip.includes(searchIP))) return;
      if(filterPage && (!v.page || !v.page.toLowerCase().includes(filterPage))) return;

      // ØªØ­Ø¶ÙŠØ± Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠ
      if(!chartData[v.page]) chartData[v.page] = {online:0, offline:0};
      v.online ? chartData[v.page].online++ : chartData[v.page].offline++;

      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${v.visitorId || id}</td>
        <td>${v.ip || "-"}</td>
        <td>${v.page || "-"}</td>
        <td>${enterTime ? enterTime.toLocaleString() : "-"}</td>
        <td>${exitTime ? exitTime.toLocaleString() : "-"}</td>
        <td>${online}</td>
        <td><button onclick="banVisitor('${id}')">Ø­Ø¸Ø±</button></td>
        <td>${duration}</td>
      `;
      tbody.appendChild(tr);
    });

    updateChart(chartData);
  });
}

// ğŸ”¹ Ø­Ø¸Ø± Ø§Ù„Ø²Ø§Ø¦Ø±
function banVisitor(visitorId){
  usersRef.child(visitorId).update({ banned: true }).then(() => {
    alert("ØªÙ… Ø­Ø¸Ø± Ø§Ù„Ø²Ø§Ø¦Ø±!");
    updateVisitorsTable();
  });
}

// ğŸ”¹ ØªØµØ¯ÙŠØ± CSV
function exportCSV(){
  const rows = [["visitorId","IP","Ø§Ù„ØµÙØ­Ø©","ÙˆÙ‚Øª Ø§Ù„Ø¯Ø®ÙˆÙ„","ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬","Ù…ØªÙˆØ§Ø¬Ø¯","Ù…Ø¯Ø© Ø§Ù„Ø¬Ù„ÙˆØ³"]];
  const table = document.getElementById("visitorsTable");
  for(let tr of table.rows){
    const row = [];
    for(let td of tr.cells){
      row.push(td.innerText);
    }
    rows.push(row);
  }
  const csvContent = "data:text/csv;charset=utf-8," + rows.map(e=>e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "visitors.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// ğŸ”¹ Ø±Ø³Ù… Ø¨ÙŠØ§Ù†ÙŠ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Chart.js
let chart;
function updateChart(chartData){
  const ctx = document.getElementById("chart").getContext("2d");
  const labels = Object.keys(chartData);
  const onlineData = labels.map(l=>chartData[l].online);
  const offlineData = labels.map(l=>chartData[l].offline);

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'Ù…ØªÙˆØ§Ø¬Ø¯', data: onlineData, backgroundColor: 'green' },
        { label: 'Ù…ØºØ§Ø¯Ø±', data: offlineData, backgroundColor: 'red' }
      ]
    },
    options: { responsive:true, plugins:{legend:{position:'top'}} }
  });
}

// ğŸ”¹ ØªØ­Ø¯ÙŠØ« ØªÙ„Ù‚Ø§Ø¦ÙŠ ÙƒÙ„ 5 Ø«ÙˆØ§Ù†ÙŠ
updateVisitorsTable();
setInterval(updateVisitorsTable,5000);
</script>
</body>
</html>
