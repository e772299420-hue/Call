<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>لوحة تحكم الزوار المتقدمة</title>
<style>
  body { font-family: Arial; direction: rtl; padding: 20px; }
  table { width: 100%; border-collapse: collapse; margin-top: 20px; }
  th, td { border: 1px solid #ccc; padding: 8px; text-align: center; }
  th { background: #f0f0f0; }
  button { padding: 4px 8px; cursor: pointer; }
  input { padding: 5px; margin-right: 10px; }
  .tabs { margin-bottom: 20px; }
  .tab { padding: 10px 20px; cursor: pointer; background: #f0f0f0; border: 1px solid #ccc; margin-left: 5px; }
  .tab.active { background: #ddd; }
  .tab-content { display: none; }
  .tab-content.active { display: block; }
  .banned-text { color: red; font-weight: bold; }
  .user-info { 
    background: #f8f8f8; 
    padding: 10px; 
    border: 1px solid #ddd; 
    margin-bottom: 15px; 
    border-radius: 5px;
  }
  .user-info span {
    font-weight: bold;
    color: #2c3e50;
  }
</style>
</head>
<body>

<h1>لوحة تحكم الزوار المتقدمة</h1>

<!-- معلومات المستخدم الحالي -->
<div class="user-info">
  <strong>المعلومات الحالية:</strong><br>
  معرف المستخدم: <span id="currentUserId">-</span> | 
  عنوان الصفحة: <span id="currentPageUrl">-</span>
</div>

<div class="tabs">
  <button class="tab active" onclick="openTab('visitors')">الزوار</button>
  <button class="tab" onclick="openTab('pages')">إحصائيات الصفحات</button>
  <button class="tab" onclick="openTab('banned')">المحظورين</button>
</div>

<div id="visitors" class="tab-content active">
  <div>
    <label>بحث حسب IP: <input type="text" id="searchIP" placeholder="ادخل IP"></label>
    <label>فلترة حسب الصفحة: <input type="text" id="filterPage" placeholder="اسم الصفحة"></label>
    <button onclick="updateVisitorsTable()">تطبيق</button>
    <button onclick="exportCSV()">تصدير CSV</button>
  </div>

  <table>
    <thead>
      <tr>
        <th>الزائر</th>
        <th>IP</th>
        <th>الصفحة</th>
        <th>وقت الدخول</th>
        <th>وقت الخروج</th>
        <th>متواجد حاليًا</th>
        <th>حظر</th>
        <th>وقت الجلوس (ثواني)</th>
      </tr>
    </thead>
    <tbody id="visitorsTable"></tbody>
  </table>
</div>

<div id="pages" class="tab-content">
  <h2>إحصائيات الصفحات</h2>
  <table>
    <thead>
      <tr>
        <th>اسم الصفحة</th>
        <th>عدد الزوار الداخلين</th>
        <th>عدد الزوار المتواجدين</th>
        <th>عدد الزوار المغادرين</th>
      </tr>
    </thead>
    <tbody id="pagesTable"></tbody>
  </table>
</div>

<div id="banned" class="tab-content">
  <h2>الزوار المحظورين</h2>
  <table>
    <thead>
      <tr>
        <th>الزائر</th>
        <th>IP</th>
        <th>الصفحة</th>
        <th>وقت الحظر</th>
        <th>إلغاء الحظر</th>
      </tr>
    </thead>
    <tbody id="bannedTable"></tbody>
  </table>
</div>

<canvas id="chart" width="800" height="300"></canvas>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
// 🔹 إعداد Firebase
const firebaseConfig = {
  databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// 🔹 استخدام مسار الزوار بدل مسار المنتج
const usersRef = db.ref("visitors");
const bannedRef = db.ref("bannedVisitors");

// 🔹 توليد معرف فريد للمستخدم الحالي
function generateUserId() {
  // محاولة جلب المعرف من localStorage إذا كان موجوداً
  let userId = localStorage.getItem('currentUserId');
  if (!userId) {
    // إذا لم يوجد، ننشئ معرف جديد
    userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('currentUserId', userId);
  }
  return userId;
}

// 🔹 الحصول على عنوان الصفحة الحالي
function getCurrentPageUrl() {
  return window.location.href;
}

// 🔹 تحديث معلومات المستخدم الحالي
function updateCurrentUserInfo() {
  const userId = generateUserId();
  const pageUrl = getCurrentPageUrl();
  
  document.getElementById('currentUserId').textContent = userId;
  document.getElementById('currentPageUrl').textContent = pageUrl;
  
  // يمكنك أيضاً حفظ هذه المعلومات في Firebase إذا أردت
  // saveCurrentUserInfo(userId, pageUrl);
}

// 🔹 حفظ معلومات المستخدم الحالي في Firebase (اختياري)
function saveCurrentUserInfo(userId, pageUrl) {
  const currentUserRef = db.ref("currentAdmin");
  currentUserRef.set({
    userId: userId,
    pageUrl: pageUrl,
    lastActive: new Date().toISOString()
  });
}

// 🔹 إدارة التبويبات
function openTab(tabName) {
  // إخفاء جميع المحتويات
  const tabContents = document.getElementsByClassName("tab-content");
  for (let i = 0; i < tabContents.length; i++) {
    tabContents[i].classList.remove("active");
  }
  
  // إلغاء تنشيط جميع التبويبات
  const tabs = document.getElementsByClassName("tab");
  for (let i = 0; i < tabs.length; i++) {
    tabs[i].classList.remove("active");
  }
  
  // إظهار المحتوى المطلوب وتنشيط التبويب
  document.getElementById(tabName).classList.add("active");
  event.currentTarget.classList.add("active");
  
  // تحديث البيانات عند فتح التبويب
  if (tabName === 'pages') {
    updatePagesTable();
  } else if (tabName === 'banned') {
    updateBannedTable();
  }
}

// 🔹 تحديث وعرض بيانات الزوار
function updateVisitorsTable(){
  const searchIP = document.getElementById("searchIP").value.trim();
  const filterPage = document.getElementById("filterPage").value.trim().toLowerCase();

  // جلب بيانات الزوار المحظورين أولاً
  bannedRef.once("value").then(bannedSnapshot => {
    const bannedVisitors = bannedSnapshot.val() || {};
    const bannedIds = Object.keys(bannedVisitors);
    
    // ثم جلب بيانات جميع الزوار
    usersRef.once("value").then(snapshot => {
      const visitors = snapshot.val();
      const tbody = document.getElementById("visitorsTable");
      tbody.innerHTML = "";
      if(!visitors) return;

      const chartData = {};
      Object.keys(visitors).forEach(id => {
        const v = visitors[id];
        const enterTime = v.enterTime ? new Date(v.enterTime) : null;
        const exitTime = v.exitTime ? new Date(v.exitTime) : null;
        const online = v.online ? "نعم" : "لا";
        let duration = "";
        if(enterTime){
          const end = exitTime || new Date();
          duration = Math.floor((end - enterTime)/1000); // بالثواني
        }

        // فلترة IP والصفحة
        if(searchIP && (!v.ip || !v.ip.includes(searchIP))) return;
        if(filterPage && (!v.page || !v.page.toLowerCase().includes(filterPage))) return;

        // تحضير بيانات الرسم البياني
        if(!chartData[v.page]) chartData[v.page] = {online:0, offline:0};
        v.online ? chartData[v.page].online++ : chartData[v.page].offline++;

        const tr = document.createElement("tr");
        
        // التحقق إذا كان الزائر محظوراً
        const isBanned = bannedIds.includes(id);
        
        tr.innerHTML = `
          <td>${v.visitorId || id}</td>
          <td>${v.ip || "-"}</td>
          <td>${v.page || "-"}</td>
          <td>${enterTime ? enterTime.toLocaleString() : "-"}</td>
          <td>${exitTime ? exitTime.toLocaleString() : "-"}</td>
          <td>${online}</td>
          <td>
            ${isBanned ? 
              '<span class="banned-text">محظور</span>' : 
              `<button onclick="banVisitor('${id}', '${v.ip || ''}', '${v.page || ''}')">حظر</button>`
            }
          </td>
          <td>${duration}</td>
        `;
        tbody.appendChild(tr);
      });

      updateChart(chartData);
    });
  });
}

// 🔹 تحديث وعرض إحصائيات الصفحات
function updatePagesTable() {
  usersRef.once("value").then(snapshot => {
    const visitors = snapshot.val();
    const tbody = document.getElementById("pagesTable");
    tbody.innerHTML = "";
    if(!visitors) return;

    const pageStats = {};
    
    Object.keys(visitors).forEach(id => {
      const v = visitors[id];
      const page = v.page || "غير محدد";
      
      if (!pageStats[page]) {
        pageStats[page] = {
          total: 0,
          online: 0,
          offline: 0
        };
      }
      
      pageStats[page].total++;
      if (v.online) {
        pageStats[page].online++;
      } else {
        pageStats[page].offline++;
      }
    });

    Object.keys(pageStats).forEach(page => {
      const stats = pageStats[page];
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${page}</td>
        <td>${stats.total}</td>
        <td>${stats.online}</td>
        <td>${stats.offline}</td>
      `;
      tbody.appendChild(tr);
    });
  });
}

// 🔹 تحديث وعرض الزوار المحظورين
function updateBannedTable() {
  bannedRef.once("value").then(snapshot => {
    const bannedVisitors = snapshot.val();
    const tbody = document.getElementById("bannedTable");
    tbody.innerHTML = "";
    if(!bannedVisitors) return;

    Object.keys(bannedVisitors).forEach(id => {
      const v = bannedVisitors[id];
      const banTime = v.banTime ? new Date(v.banTime) : null;
      
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${v.visitorId || id}</td>
        <td>${v.ip || "-"}</td>
        <td>${v.page || "-"}</td>
        <td>${banTime ? banTime.toLocaleString() : "-"}</td>
        <td><button onclick="unbanVisitor('${id}')">إلغاء الحظر</button></td>
      `;
      tbody.appendChild(tr);
    });
  });
}

// 🔹 حظر الزائر
function banVisitor(visitorId, ip, page) {
  if (!confirm("هل أنت متأكد من حظر هذا الزائر؟")) return;
  
  const banData = {
    visitorId: visitorId,
    ip: ip,
    page: page,
    banTime: new Date().toISOString(),
    bannedBy: generateUserId() // إضافة معرف المستخدم الذي قام بالحظر
  };
  
  bannedRef.child(visitorId).set(banData).then(() => {
    alert("تم حظر الزائر!");
    updateVisitorsTable();
    updateBannedTable();
  });
}

// 🔹 إلغاء حظر الزائر
function unbanVisitor(visitorId) {
  if (!confirm("هل أنت متأكد من إلغاء حظر هذا الزائر؟")) return;
  
  bannedRef.child(visitorId).remove().then(() => {
    alert("تم إلغاء حظر الزائر!");
    updateVisitorsTable();
    updateBannedTable();
  });
}

// 🔹 تصدير CSV
function exportCSV(){
  const rows = [["visitorId","IP","الصفحة","وقت الدخول","وقت الخروج","متواجد","مدة الجلوس"]];
  const table = document.getElementById("visitorsTable");
  for(let tr of table.rows){
    const row = [];
    for(let td of tr.cells){
      row.push(td.innerText);
    }
    rows.push(row);
  }
  const csvContent = "data:text/csv;charset=utf-8," + rows.map(e=>e.join(",")).join("\n");
  const encodedUri = encodeURI(csvContent);
  const link = document.createElement("a");
  link.setAttribute("href", encodedUri);
  link.setAttribute("download", "visitors.csv");
  document.body.appendChild(link);
  link.click();
  document.body.removeChild(link);
}

// 🔹 رسم بياني باستخدام Chart.js
let chart;
function updateChart(chartData){
  const ctx = document.getElementById("chart").getContext("2d");
  const labels = Object.keys(chartData);
  const onlineData = labels.map(l=>chartData[l].online);
  const offlineData = labels.map(l=>chartData[l].offline);

  if(chart) chart.destroy();
  chart = new Chart(ctx, {
    type: 'bar',
    data: {
      labels: labels,
      datasets: [
        { label: 'متواجد', data: onlineData, backgroundColor: 'green' },
        { label: 'مغادر', data: offlineData, backgroundColor: 'red' }
      ]
    },
    options: { responsive:true, plugins:{legend:{position:'top'}} }
  });
}

// 🔹 تحديث تلقائي كل 5 ثواني
updateCurrentUserInfo(); // تحديث معلومات المستخدم الحالي
updateVisitorsTable();
setInterval(updateVisitorsTable,5000);
</script>
</body>
</html>
