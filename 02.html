<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة تحكم - بيانات الزوار</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        :root {
            --primary: #4361ee;
            --secondary: #3f37c9;
            --success: #4cc9f0;
            --warning: #f72585;
            --light: #f8f9fa;
            --dark: #212529;
            --gray: #6c757d;
            --border: #dee2e6;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: #f5f7fb;
            color: var(--dark);
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            min-height: 100vh;
        }
        
        /* الشريط الجانبي */
        .sidebar {
            width: 250px;
            background: linear-gradient(to bottom, var(--primary), var(--secondary));
            color: white;
            padding: 20px 0;
            transition: all 0.3s;
        }
        
        .logo {
            padding: 0 20px 20px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 20px;
        }
        
        .logo h2 {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .logo i {
            font-size: 24px;
        }
        
        .nav-links {
            list-style: none;
        }
        
        .nav-links li {
            padding: 12px 20px;
            transition: all 0.3s;
        }
        
        .nav-links li:hover, .nav-links li.active {
            background-color: rgba(255, 255, 255, 0.1);
            border-right: 4px solid var(--success);
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        /* المحتوى الرئيسي */
        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border);
        }
        
        .header h1 {
            color: var(--primary);
            font-size: 24px;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
        }
        
        /* بطاقات الإحصائيات */
        .stats-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }
        
        .visitors-icon {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .pages-icon {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }
        
        .duration-icon {
            background-color: rgba(63, 55, 201, 0.1);
            color: var(--secondary);
        }
        
        .bounce-icon {
            background-color: rgba(108, 117, 125, 0.1);
            color: var(--gray);
        }
        
        .stat-info h3 {
            font-size: 14px;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .stat-info p {
            font-size: 24px;
            font-weight: bold;
            color: var(--dark);
        }
        
        /* الجداول */
        .tables-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        @media (max-width: 992px) {
            .tables-container {
                grid-template-columns: 1fr;
            }
        }
        
        .table-card {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
        }
        
        .table-header {
            padding: 15px 20px;
            background-color: var(--light);
            border-bottom: 1px solid var(--border);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .table-header h3 {
            color: var(--primary);
        }
        
        .table-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 15px;
            border-radius: 5px;
            border: none;
            cursor: pointer;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-success {
            background-color: var(--success);
            color: white;
        }
        
        .btn-outline {
            background-color: transparent;
            border: 1px solid var(--border);
            color: var(--dark);
        }
        
        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px 15px;
            text-align: right;
            border-bottom: 1px solid var(--border);
        }
        
        th {
            background-color: var(--light);
            color: var(--gray);
            font-weight: 600;
        }
        
        tr:last-child td {
            border-bottom: none;
        }
        
        tr:hover {
            background-color: rgba(67, 97, 238, 0.03);
        }
        
        .badge {
            padding: 4px 8px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .badge-success {
            background-color: rgba(76, 201, 240, 0.1);
            color: var(--success);
        }
        
        .badge-primary {
            background-color: rgba(67, 97, 238, 0.1);
            color: var(--primary);
        }
        
        .badge-warning {
            background-color: rgba(247, 37, 133, 0.1);
            color: var(--warning);
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            padding: 15px;
            gap: 5px;
        }
        
        .page-item {
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .page-item:hover, .page-item.active {
            background-color: var(--primary);
            color: white;
        }
        
        /* الرسم البياني */
        .chart-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.05);
            margin-bottom: 30px;
        }
        
        .chart-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .chart-header h3 {
            color: var(--primary);
        }
        
        .chart-actions select {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid var(--border);
            background-color: white;
        }
        
        .chart {
            height: 300px;
            background-color: #f8f9fa;
            border-radius: 5px;
            display: flex;
            align-items: flex-end;
            padding: 10px;
            gap: 10px;
            position: relative;
        }
        
        .bar {
            flex: 1;
            background: linear-gradient(to top, var(--primary), var(--success));
            border-radius: 5px 5px 0 0;
            position: relative;
            min-height: 20px;
            transition: all 0.3s;
        }
        
        .bar:hover {
            opacity: 0.8;
        }
        
        .bar-label {
            position: absolute;
            bottom: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            color: var(--gray);
        }
        
        .bar-value {
            position: absolute;
            top: -25px;
            left: 0;
            right: 0;
            text-align: center;
            font-size: 12px;
            font-weight: bold;
            color: var(--dark);
        }

        .loading {
            text-align: center;
            padding: 40px 20px;
            color: var(--gray);
        }

        .loading i {
            font-size: 32px;
            margin-bottom: 15px;
            color: var(--primary);
        }

        .error-message {
            background-color: rgba(247, 37, 133, 0.1);
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            text-align: center;
        }

        .last-updated {
            text-align: left;
            font-size: 12px;
            color: var(--gray);
            margin-top: 10px;
        }

        .refresh-btn {
            background: none;
            border: none;
            color: var(--primary);
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }

        .data-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- الشريط الجانبي -->
        <aside class="sidebar">
            <div class="logo">
                <h2><i class="fas fa-chart-line"></i> إحصائيات الزوار</h2>
            </div>
            <ul class="nav-links">
                <li class="active"><a href="#"><i class="fas fa-home"></i> الرئيسية</a></li>
                <li><a href="#"><i class="fas fa-users"></i> الزوار</a></li>
                <li><a href="#"><i class="fas fa-file-alt"></i> الصفحات</a></li>
                <li><a href="#"><i class="fas fa-map-marker-alt"></i> الجغرافيا</a></li>
                <li><a href="#"><i class="fas fa-cog"></i> الإعدادات</a></li>
            </ul>
        </aside>
        
        <!-- المحتوى الرئيسي -->
        <main class="main-content">
            <div class="header">
                <h1><i class="fas fa-users"></i> لوحة تحكم بيانات الزوار</h1>
                <div class="user-info">
                    <div class="user-avatar">م</div>
                    <span>مدير النظام</span>
                </div>
            </div>
            
            <!-- بطاقات الإحصائيات -->
            <div class="stats-cards">
                <div class="stat-card">
                    <div class="stat-icon visitors-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="stat-info">
                        <h3>إجمالي الزيارات</h3>
                        <p id="totalVisits">0</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon pages-icon">
                        <i class="fas fa-file"></i>
                    </div>
                    <div class="stat-info">
                        <h3>إجمالي الصفحات</h3>
                        <p id="totalPages">0</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon duration-icon">
                        <i class="fas fa-clock"></i>
                    </div>
                    <div class="stat-info">
                        <h3>مدة الزيارة</h3>
                        <p id="avgDuration">0:00</p>
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-icon bounce-icon">
                        <i class="fas fa-sign-out-alt"></i>
                    </div>
                    <div class="stat-info">
                        <h3>معدل الارتداد</h3>
                        <p id="bounceRate">0%</p>
                    </div>
                </div>
            </div>
            
            <!-- الرسم البياني -->
            <div class="chart-container">
                <div class="chart-header">
                    <h3><i class="fas fa-chart-bar"></i> زيارات اليومية - آخر 7 أيام</h3>
                    <div class="chart-actions">
                        <select id="timeRange">
                            <option value="7">آخر 7 أيام</option>
                            <option value="30">آخر 30 يوم</option>
                        </select>
                    </div>
                </div>
                <div class="chart" id="visitorsChart">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>جاري تحميل بيانات الزيارات...</p>
                    </div>
                </div>
                <div class="data-info">
                    <button class="refresh-btn" onclick="loadData()" title="تحديث البيانات">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <div class="last-updated" id="lastUpdated">
                        آخر تحديث: --
                    </div>
                </div>
            </div>
            
            <!-- الجداول -->
            <div class="tables-container">
                <!-- جدول زيارات اليومية -->
                <div class="table-card">
                    <div class="table-header">
                        <h3><i class="fas fa-calendar-day"></i> زيارات اليومية (dat_visitors)</h3>
                        <div class="table-actions">
                            <button class="btn btn-success" onclick="exportToCSV('daily')">
                                <i class="fas fa-download"></i> تصدير
                            </button>
                            <button class="btn btn-outline" onclick="showDateFilter()">
                                <i class="fas fa-filter"></i> تصفية
                            </button>
                        </div>
                    </div>
                    <div class="table-content">
                        <div class="loading" id="dailyLoading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>جاري تحميل بيانات الزيارات اليومية...</p>
                        </div>
                        <table id="dailyVisitsTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>الزيارات</th>
                                    <th>الصفحات</th>
                                    <th>صفحة/زيارة</th>
                                    <th>المدة</th>
                                    <th>الارتداد</th>
                                </tr>
                            </thead>
                            <tbody id="dailyVisitsBody">
                                <!-- سيتم ملؤها بالبيانات من Firebase -->
                            </tbody>
                        </table>
                        <div class="pagination" id="dailyPagination" style="display: none;">
                            <!-- سيتم إضافة أزرار التصفح -->
                        </div>
                    </div>
                </div>
                
                <!-- جدول تفاصيل زيارات الصفحات -->
                <div class="table-card">
                    <div class="table-header">
                        <h3><i class="fas fa-file-alt"></i> تفاصيل الصفحات (bag_visitors)</h3>
                        <div class="table-actions">
                            <button class="btn btn-success" onclick="exportToCSV('pages')">
                                <i class="fas fa-download"></i> تصدير
                            </button>
                            <button class="btn btn-outline" onclick="showPageFilter()">
                                <i class="fas fa-filter"></i> تصفية
                            </button>
                        </div>
                    </div>
                    <div class="table-content">
                        <div class="loading" id="pagesLoading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>جاري تحميل بيانات صفحات الزوار...</p>
                        </div>
                        <table id="pageVisitsTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>الصفحة</th>
                                    <th>الزيارات</th>
                                    <th>المدة</th>
                                    <th>معدل الخروج</th>
                                    <th>القيمة</th>
                                </tr>
                            </thead>
                            <tbody id="pageVisitsBody">
                                <!-- سيتم ملؤها بالبيانات من Firebase -->
                            </tbody>
                        </table>
                        <div class="pagination" id="pagesPagination" style="display: none;">
                            <!-- سيتم إضافة أزرار التصفح -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // تهيئة Firebase
        const firebaseConfig = {
            databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // متغيرات التطبيق
        let currentDailyPage = 1;
        let currentPagesPage = 1;
        const itemsPerPage = 8;

        // عناصر DOM
        const totalVisitsElement = document.getElementById('totalVisits');
        const totalPagesElement = document.getElementById('totalPages');
        const avgDurationElement = document.getElementById('avgDuration');
        const bounceRateElement = document.getElementById('bounceRate');
        const visitorsChart = document.getElementById('visitorsChart');
        const dailyVisitsBody = document.getElementById('dailyVisitsBody');
        const pageVisitsBody = document.getElementById('pageVisitsBody');
        const timeRangeSelect = document.getElementById('timeRange');
        const lastUpdatedElement = document.getElementById('lastUpdated');

        // دالة رئيسية لجلب البيانات
        async function loadData() {
            try {
                showLoadingState();
                
                // جلب بيانات الزوار اليومية
                const dailySnapshot = await database.ref('visitors/dat_visitors').once('value');
                const dailyData = dailySnapshot.val();
                
                // جلب بيانات صفحات الزوار
                const pagesSnapshot = await database.ref('visitors/bag_visitors').once('value');
                const pagesData = pagesSnapshot.val();
                
                // معالجة وعرض البيانات
                processAndDisplayData(dailyData, pagesData);
                
                // تحديث وقت آخر تحديث
                lastUpdatedElement.textContent = `آخر تحديث: ${new Date().toLocaleString('ar-EG')}`;
                
            } catch (error) {
                console.error('Error fetching data:', error);
                showError('فشل في تحميل البيانات من قاعدة البيانات');
            }
        }

        // دالة لعرض حالة التحميل
        function showLoadingState() {
            document.querySelectorAll('.loading').forEach(el => el.style.display = 'block');
            document.querySelectorAll('table').forEach(el => el.style.display = 'none');
            document.querySelectorAll('.pagination').forEach(el => el.style.display = 'none');
        }

        // دالة لعرض الخطأ
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            
            document.querySelector('.main-content').insertBefore(errorDiv, document.querySelector('.stats-cards'));
            
            setTimeout(() => {
                errorDiv.remove();
            }, 5000);
        }

        // دالة لمعالجة وعرض البيانات
        function processAndDisplayData(dailyData, pagesData) {
            // إخفاء رسائل التحميل
            document.querySelectorAll('.loading').forEach(el => el.style.display = 'none');
            
            let totalVisits = 0;
            let totalPageViews = 0;
            let totalDuration = 0;
            let totalBounce = 0;
            let dailyEntriesCount = 0;
            
            const chartData = [];
            const chartLabels = [];
            
            // معالجة بيانات الزوار اليومية
            if (dailyData) {
                const dailyEntries = Object.entries(dailyData);
                dailyEntriesCount = dailyEntries.length;
                
                // ترتيب البيانات حسب التاريخ (الأحدث أولاً)
                dailyEntries.sort((a, b) => new Date(b[0]) - new Date(a[0]));
                
                // أخذ آخر 7 أيام للرسم البياني
                const last7Days = dailyEntries.slice(0, 7).reverse();
                
                last7Days.forEach(([date, data]) => {
                    const visits = data.visits || 0;
                    const pageViews = data.page_views || 0;
                    const duration = data.avg_duration || 0;
                    const bounce = data.bounce_rate || 0;
                    
                    totalVisits += visits;
                    totalPageViews += pageViews;
                    totalDuration += duration;
                    totalBounce += bounce;
                    
                    chartData.push(visits);
                    chartLabels.push(formatDate(date));
                });
                
                // عرض بيانات الجدول مع التصفح
                displayDailyVisitsTable(dailyEntries);
            } else {
                document.getElementById('dailyVisitsBody').innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; color: var(--gray);">
                            لا توجد بيانات متاحة
                        </td>
                    </tr>
                `;
                document.getElementById('dailyVisitsTable').style.display = 'table';
            }
            
            // معالجة بيانات صفحات الزوار
            if (pagesData) {
                const pagesEntries = Object.entries(pagesData);
                
                // عرض بيانات الجدول مع التصفح
                displayPagesVisitsTable(pagesEntries);
            } else {
                document.getElementById('pageVisitsBody').innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: var(--gray);">
                            لا توجد بيانات متاحة
                        </td>
                    </tr>
                `;
                document.getElementById('pageVisitsTable').style.display = 'table';
            }
            
            // تحديث الإحصائيات
            totalVisitsElement.textContent = totalVisits.toLocaleString();
            totalPagesElement.textContent = totalPageViews.toLocaleString();
            avgDurationElement.textContent = formatDuration(dailyEntriesCount > 0 ? totalDuration / dailyEntriesCount : 0);
            bounceRateElement.textContent = dailyEntriesCount > 0 ? (totalBounce / dailyEntriesCount).toFixed(1) + '%' : '0%';
            
            // إنشاء الرسم البياني
            createChart(chartData, chartLabels);
        }

        // دالة لعرض جدول الزيارات اليومية
        function displayDailyVisitsTable(entries) {
            const startIndex = (currentDailyPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageEntries = entries.slice(startIndex, endIndex);
            
            dailyVisitsBody.innerHTML = '';
            
            pageEntries.forEach(([date, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatDate(date)}</td>
                    <td>${(data.visits || 0).toLocaleString()}</td>
                    <td>${(data.page_views || 0).toLocaleString()}</td>
                    <td>${(data.pages_per_visit || 0).toFixed(1)}</td>
                    <td>${formatDuration(data.avg_duration || 0)}</td>
                    <td><span class="badge ${(data.bounce_rate || 0) < 40 ? 'badge-primary' : (data.bounce_rate || 0) < 60 ? 'badge-success' : 'badge-warning'}">${(data.bounce_rate || 0).toFixed(1)}%</span></td>
                `;
                dailyVisitsBody.appendChild(row);
            });
            
            document.getElementById('dailyVisitsTable').style.display = 'table';
            createPagination('dailyPagination', entries.length, currentDailyPage, 'daily');
        }

        // دالة لعرض جدول صفحات الزوار
        function displayPagesVisitsTable(entries) {
            const startIndex = (currentPagesPage - 1) * itemsPerPage;
            const endIndex = startIndex + itemsPerPage;
            const pageEntries = entries.slice(startIndex, endIndex);
            
            pageVisitsBody.innerHTML = '';
            
            pageEntries.forEach(([page, data]) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td title="${page}">${truncateText(page, 30)}</td>
                    <td>${(data.visits || 0).toLocaleString()}</td>
                    <td>${formatDuration(data.avg_duration || 0)}</td>
                    <td><span class="badge ${(data.exit_rate || 0) < 30 ? 'badge-primary' : (data.exit_rate || 0) < 50 ? 'badge-success' : 'badge-warning'}">${(data.exit_rate || 0).toFixed(1)}%</span></td>
                    <td>$${(data.value || 0).toFixed(2)}</td>
                `;
                pageVisitsBody.appendChild(row);
            });
            
            document.getElementById('pageVisitsTable').style.display = 'table';
            createPagination('pagesPagination', entries.length, currentPagesPage, 'pages');
        }

        // دالة لإنشاء التصفح
        function createPagination(elementId, totalItems, currentPage, type) {
            const totalPages = Math.ceil(totalItems / itemsPerPage);
            const paginationElement = document.getElementById(elementId);
            
            if (totalPages <= 1) {
                paginationElement.style.display = 'none';
                return;
            }
            
            let paginationHTML = '';
            
            // زر السابق
            if (currentPage > 1) {
                paginationHTML += `<div class="page-item" onclick="changePage('${type}', ${currentPage - 1})"><i class="fas fa-chevron-right"></i></div>`;
            }
            
            // أرقام الصفحات
            for (let i = 1; i <= totalPages; i++) {
                if (i === currentPage) {
                    paginationHTML += `<div class="page-item active">${i}</div>`;
                } else {
                    paginationHTML += `<div class="page-item" onclick="changePage('${type}', ${i})">${i}</div>`;
                }
            }
            
            // زر التالي
            if (currentPage < totalPages) {
                paginationHTML += `<div class="page-item" onclick="changePage('${type}', ${currentPage + 1})"><i class="fas fa-chevron-left"></i></div>`;
            }
            
            paginationElement.innerHTML = paginationHTML;
            paginationElement.style.display = 'flex';
        }

        // دالة لتغيير الصفحة
        function changePage(type, newPage) {
            if (type === 'daily') {
                currentDailyPage = newPage;
            } else {
                currentPagesPage = newPage;
            }
            loadData();
        }

        // دالة لإنشاء الرسم البياني
        function createChart(data, labels) {
            visitorsChart.innerHTML = '';
            
            if (data.length === 0) {
                visitorsChart.innerHTML = `
                    <div class="loading">
                        <i class="fas fa-chart-bar"></i>
                        <p>لا توجد بيانات للعرض</p>
                    </div>
                `;
                return;
            }
            
            const maxValue = Math.max(...data, 1);
            
            data.forEach((value, index) => {
                const barHeight = (value / maxValue) * 100;
                
                const bar = document.createElement('div');
                bar.className = 'bar';
                bar.style.height = `${barHeight}%`;
                bar.title = `${labels[index]}: ${value} زيارة`;
                
                const barValue = document.createElement('div');
                barValue.className = 'bar-value';
                barValue.textContent = value.toLocaleString();
                
                const barLabel = document.createElement('div');
                barLabel.className = 'bar-label';
                barLabel.textContent = labels[index];
                
                bar.appendChild(barValue);
                bar.appendChild(barLabel);
                visitorsChart.appendChild(bar);
            });
        }

        // دوال مساعدة
        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString('ar-EG', {
                year: 'numeric',
                month: 'short',
                day: 'numeric'
            });
        }

        function formatDuration(minutes) {
            if (!minutes) return '0:00';
            const mins = Math.floor(minutes);
            const secs = Math.round((minutes - mins) * 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        function truncateText(text, maxLength) {
            return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
        }

        function exportToCSV(type) {
            alert(`سيتم تصدير بيانات ${type === 'daily' ? 'الزيارات اليومية' : 'صفحات الزوار'} إلى ملف CSV`);
            // هنا يمكن إضافة منطق التصدير الفعلي إلى CSV
        }

        function showDateFilter() {
            alert('سيتم فتح نافذة تصفية حسب التاريخ');
        }

        function showPageFilter() {
            alert('سيتم فتح نافذة تصفية حسب الصفحة');
        }

        // تحميل البيانات عند فتح الصفحة
        document.addEventListener('DOMContentLoaded', loadData);

        // تحديث البيانات عند تغيير نطاق الوقت
        timeRangeSelect.addEventListener('change', loadData);

        // تحديث تلقائي كل 5 دقائق
        setInterval(loadData, 5 * 60 * 1000);
    </script>
</body>
</html>
