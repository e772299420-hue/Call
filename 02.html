
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ¥ÿßŸÖŸÑ - ÿ≥ŸàŸÇ ÿ™ÿ¨ÿßÿ±Ÿä ŸÖÿ™ŸÉÿßŸÖŸÑ ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸàÿßŸÑŸÖÿ≥ÿ™ÿπŸÖŸÑÿ© ŸàÿßŸÑÿπŸÇÿßÿ±ÿßÿ™ ŸàÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ</title>
    
    <!-- ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÉŸÑŸÖÿßÿ™ ÿßŸÑŸÖŸÅÿ™ÿßÿ≠Ÿäÿ© ŸÑÿ™ÿ≠ÿ≥ŸäŸÜ ŸÖÿ≠ÿ±ŸÉÿßÿ™ ÿßŸÑÿ®ÿ≠ÿ´ -->
    <meta name="description" content="AZ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ¥ÿßŸÖŸÑ - ŸÖŸÜÿµÿ© ÿ™ÿ¨ÿßÿ±Ÿäÿ© ŸÖÿ™ŸÉÿßŸÖŸÑÿ© ÿ™ÿ≠ÿ™ŸàŸä ÿπŸÑŸâ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸàÿßŸÑŸÖÿ≥ÿ™ÿπŸÖŸÑÿ©ÿå ÿßŸÑÿπŸÇÿßÿ±ÿßÿ™ÿå ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅÿå ÿ™ŸàÿµŸäŸÑ ÿßŸÑŸÖÿ∑ÿßÿπŸÖ ŸàÿßŸÑÿ®ŸàŸÅŸäŸáÿßÿ™ÿå Ÿàÿ£ÿ±ŸÇÿßŸÖ ŸÖŸáŸÖÿ© ŸÑÿ™ŸÑÿ®Ÿäÿ© ÿ¨ŸÖŸäÿπ ÿßÿ≠ÿ™Ÿäÿßÿ¨ÿßÿ™ŸÉ">
    <meta name="keywords" content="AZ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ¥ÿßŸÖŸÑ, ÿ≥ŸàŸÇ ÿ™ÿ¨ÿßÿ±Ÿä, ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ©, ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿ≥ÿ™ÿπŸÖŸÑÿ©, ÿ≠ÿ±ÿßÿ¨, ÿπŸÇÿßÿ±ÿßÿ™, ÿ¥ŸÇŸÇ ŸÑŸÑÿ•Ÿäÿ¨ÿßÿ±, Ÿàÿ∏ÿßÿ¶ŸÅ ÿ¥ÿßÿ∫ÿ±ÿ©, ÿ™ŸàÿµŸäŸÑ ÿ∑ÿπÿßŸÖ, ŸÖÿ∑ÿßÿπŸÖ, ÿ®ŸàŸÅŸäŸáÿßÿ™, ŸÑÿ≠ŸàŸÖ, ÿ™ÿ≥ŸàŸÇ, ÿ™ÿ≥ŸàŸÇ ÿßŸÑŸÉÿ™ÿ±ŸàŸÜŸä, ŸÖŸÜÿµÿ© ÿ™ÿ¨ÿßÿ±Ÿäÿ©, ÿ≥ŸàŸÇ ÿßŸÑŸÉÿ™ÿ±ŸàŸÜŸä, ÿ¥ÿ±ÿßÿ°, ÿ®Ÿäÿπ, ÿπÿ±Ÿàÿ∂, ŸÖÿ™ÿ¨ÿ± ÿßŸÑŸÉÿ™ÿ±ŸàŸÜŸä, ÿ™ÿ¨ÿßÿ±ÿ©, ÿ™ÿ≥ŸàŸÇ ÿπÿ®ÿ± ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™, ÿ≥ŸàŸÇ ÿπÿ±ÿ®Ÿä, ÿ≥ŸàŸÇ ÿßŸÑÿ≥ÿπŸàÿØŸäÿ©, ÿ≥ŸàŸÇ ÿßŸÑÿÆŸÑŸäÿ¨, ÿ≥ŸàŸÇ ÿßŸÑÿ¥ÿ±ŸÇ ÿßŸÑÿ£Ÿàÿ≥ÿ∑">
    <meta name="author" content="AZ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ¥ÿßŸÖŸÑ">
    
    <!-- ŸÉŸÑŸÖÿßÿ™ ŸÖŸÅÿ™ÿßÿ≠Ÿäÿ© ÿ®ŸÑÿ∫ÿßÿ™ ŸÖÿÆÿ™ŸÑŸÅÿ© -->
    <meta name="keywords" content="AZ marketplace, online shopping, e-commerce, Saudi market, Gulf market, Middle East market, used products, real estate, jobs, food delivery">
    <meta name="keywords" content="AZ march√© complet, shopping en ligne, commerce √©lectronique, march√© saoudien, produits d'occasion, immobilier, emplois, livraison de nourriture">
    <meta name="keywords" content="AZ mercado completo, compras en l√≠nea, comercio electr√≥nico, mercado saud√≠, productos usados, bienes ra√≠ces, empleos, entrega de comida">
    <meta name="keywords" content="AZ vollst√§ndiger Markt, Online-Shopping, E-Commerce, saudischer Markt, gebrauchte Produkte, Immobilien, Jobs, Essenslieferung">
    <meta name="keywords" content="AZ ÂÆåÂÖ®Â∏ÇÂ†¥, „Ç™„É≥„É©„Ç§„É≥„Ç∑„Éß„ÉÉ„Éî„É≥„Ç∞, ÈõªÂ≠êÂïÜÂèñÂºï, „Çµ„Ç¶„Ç∏Â∏ÇÂ†¥, ‰∏≠Âè§ÂìÅ, ‰∏çÂãïÁî£, Ê±Ç‰∫∫, „Éï„Éº„Éâ„Éá„É™„Éê„É™„Éº">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --background-color: #ffffff;
            --text-color: #333;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transition: all 0.25s ease;
        }

        [data-theme="dark"] {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --background-color: #121212;
            --text-color: #ecf0f1;
            --light-color: #2c3e50;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding-top: 128px;
            padding-bottom: 40px;
            transition: var(--transition);
            width: 100%;
            overflow-x: hidden;
        }

        /* ==========================================
           üîî ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿπŸÑŸàŸä
           ========================================== */
        .notification-bar {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, #3b82f6, #1d4ed8);
            color: white;
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            font-size: 14px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            animation: slideDown 0.3s ease;
            direction: rtl;
        }

        .notification-bar.hidden {
            display: none;
        }

        .notification-content {
            display: flex;
            align-items: center;
            gap: 10px;
            max-width: 1200px;
            width: 100%;
            justify-content: center;
        }

        .notification-icon {
            font-size: 16px;
            animation: pulse 1.5s infinite;
        }

        .notification-text {
            font-weight: 500;
            text-align: center;
            flex: 1;
        }

        .notification-actions {
            display: flex;
            gap: 8px;
        }

        .notification-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 4px 12px;
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
        }

        .notification-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            cursor: pointer;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: var(--transition);
        }

        .notification-close:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        @keyframes slideDown {
            from {
                transform: translateY(-100%);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        /* ==========================================
           üîî ÿ≤ÿ± ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
           ========================================== */
        .notification-permission-btn {
            position: fixed;
            bottom: 80px;
            left: 20px;
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            border: none;
            border-radius: 25px;
            padding: 12px 20px;
            cursor: pointer;
            z-index: 999;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: bold;
            transition: var(--transition);
            opacity: 0.9;
            animation: bounce 2s infinite;
        }

        .notification-permission-btn:hover {
            opacity: 1;
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(16, 185, 129, 0.4);
        }

        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
        }

        /* ==========================================
           üéØ ÿ£ŸÜŸÖÿßÿ∑ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ©
           ========================================== */
        
        /* ÿ≠ÿßŸàŸäÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿ© - ÿßŸÑÿ¨ÿØŸäÿØÿ© */
        .matching-products-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            padding: 15px 0;
            margin: 20px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            direction: ltr;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
            cursor: grab;
            position: relative;
            background-color: #ffffff;
            border-radius: 10px;
        }

        .matching-products-container::-webkit-scrollbar {
            display: none;
        }

        .matching-products-scroll {
            display: inline-flex;
            gap: 20px;
            direction: rtl;
            padding: 0 15px;
        }

        .matching-product-item {
            display: inline-block;
            width: 140px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: var(--transition);
            position: relative;
            background: var(--background-color);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #e74c3c;
        }

        .matching-product-item:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }

        .matching-product-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--primary-color);
            transition: var(--transition);
        }

        .matching-product-item:hover .matching-product-image {
            border-color: #667eea;
            transform: scale(1.05);
        }

        .matching-product-name {
            font-size: 12px;
            margin-top: 8px;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            white-space: normal;
            color: var(--text-color);
            font-weight: bold;
            height: 32px;
            line-height: 1.2;
        }

        .matching-product-price {
            font-size: 11px;
            color: var(--primary-color);
            font-weight: bold;
            margin-top: 5px;
            background: rgba(52, 152, 219, 0.1);
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
        }

        /* ==========================================
           üõí ÿ≤ÿ± "ÿßÿ∑ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑÿßŸÜ" - ÿßŸÑÿ™ÿπÿØŸäŸÑÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
           ========================================== */
        .merchant-btn {
            background: rgba(52, 152, 219, 0.15);
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
            position: relative;
            overflow: hidden;
            gap: 5px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        .merchant-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3);
            background: rgba(52, 152, 219, 0.25);
        }

        /* ==========================================
           üìù ÿ™ÿπÿØŸäŸÑÿßÿ™ ÿßŸÑÿ£ŸÑŸàÿßŸÜ ÿßŸÑŸÖÿ∑ŸÑŸàÿ®ÿ©
           ========================================== */
        .merchant-name-center {
            display: block;
            font-size: 14px;
            font-weight: bold;
            color: #000000 !important;
            text-align: center;
            width: 100%;
            margin-top: 5px;
        }

        .underline-border {
            display: block;
            font-size: 16px;
            font-weight: bold;
            color: #e74c3c !important;
            text-align: center;
            width: 100%;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(231, 76, 60, 0.3);
        }

        /* ==========================================
           üéØ ŸÜÿßŸÅÿ∞ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ™ÿßÿ¨ÿ± ÿßŸÑÿ¨ÿØŸäÿØÿ©
           ========================================== */
        .merchant-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .merchant-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .merchant-modal {
            background-color: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(30px);
            transition: transform 0.3s ease;
        }
        
        .merchant-modal-overlay.active .merchant-modal {
            transform: translateY(0);
        }
        
        .merchant-modal-header {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .merchant-modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .merchant-modal-body {
            padding: 25px;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .merchant-modal-search {
            margin-bottom: 20px;
        }
        
        .merchant-modal-search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: inherit;
            font-size: 16px;
            text-align: right;
        }
        
        .merchant-modal-search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }
        
        .merchants-modal-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .merchant-modal-item {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .merchant-modal-item:hover {
            background-color: #f0f9ff;
            border-color: #3b82f6;
            transform: translateY(-2px);
        }
        
        .merchant-modal-item.selected {
            background-color: #dbeafe;
            border-color: #3b82f6;
        }
        
        .merchant-modal-item-name {
            font-size: 18px;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 5px;
        }
        
        .merchant-modal-footer {
            padding: 20px 25px;
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        
        .merchant-modal-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            flex: 1;
        }
        
        .merchant-modal-btn-cancel {
            background-color: #e2e8f0;
            color: #475569;
        }
        
        .merchant-modal-btn-confirm {
            background-color: #3b82f6;
            color: white;
        }
        
        .merchant-modal-btn-confirm:hover {
            background-color: #1d4ed8;
        }

        /* ==========================================
           üõí ÿ≠ŸÇŸÑ ŸÜÿµŸä ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ™ÿßÿ¨ÿ± ÿßŸÑÿ¨ÿØŸäÿØ
           ========================================== */
        .merchant-text-field {
            position: relative;
            width: 100%;
        }
        
        .merchant-text-input {
            width: 100%;
            padding: 8px 40px 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            text-align: right;
            transition: all 0.3s;
            color: #333;
        }
        
        .merchant-text-field-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }

        /* ==========================================
           üìÇ ÿ≠ŸÇŸÑ ŸÜÿµŸä ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸäÿØ
           ========================================== */
        .category-text-field {
            position: relative;
            width: 100%;
        }
        
        .category-text-input {
            width: 100%;
            padding: 8px 40px 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            text-align: right;
            transition: all 0.3s;
            color: #333;
        }
        
        .category-text-field-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }

        /* ==========================================
           üìÇ ŸÜÿßŸÅÿ∞ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ ÿßŸÑÿ¨ÿØŸäÿØÿ©
           ========================================== */
        .category-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        
        .category-modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }
        
        .category-modal {
            background-color: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(30px);
            transition: transform 0.3s ease;
        }
        
        .category-modal-overlay.active .category-modal {
            transform: translateY(0);
        }
        
        .category-modal-header {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 25px;
            text-align: center;
        }
        
        .category-modal-title {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 10px;
        }
        
        .category-modal-body {
            padding: 25px;
            max-height: 50vh;
            overflow-y: auto;
        }
        
        .category-modal-search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: inherit;
            font-size: 16px;
            text-align: right;
        }
        
        .categories-modal-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .category-modal-item {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .category-modal-item:hover {
            background-color: #f0fdf4;
            border-color: #10b981;
            transform: translateY(-2px);
        }
        
        .category-modal-footer {
            padding: 20px 25px;
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        
        .category-modal-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            flex: 1;
        }
        
        /* ÿ®ŸÇŸäÿ© ÿßŸÑÿ£ŸÜŸÖÿßÿ∑ ÿßŸÑÿ£ÿµŸÑŸäÿ© */
        /* ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ */
        .loading-overlay {
            display: none !important;
        }

        /* ÿßŸÑŸáŸäÿØÿ± */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: var(--box-shadow);
        }

        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand-logo {
            width: 50px;
            height: 50px;
            object-fit: contain;
            border-radius: 10px;
            background: white;
            padding: 4px;
            border: 2px solid white;
        }

        .brand-text {
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .brand-title {
            font-size: 20px;
            font-weight: bold;
            margin: 0;
        }

        .brand-subtitle {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.9);
        }

        .header-right {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
        }

        .header-login {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            cursor: pointer;
            text-decoration: none;
            order: 1;
        }

        .header-online-users {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            cursor: pointer;
            order: 2;
        }

        /* ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿØŸäÿØ ÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä */
        .secondary-bar {
            position: fixed;
            top: 84px;
            left: 0;
            width: 100%;
            background: var(--dark-color);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: white;
        }

        .secondary-bar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .secondary-bar-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .secondary-bar-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .secondary-category {
            display: flex;
            align-items: center;
            gap: 6px;
            color: white;
        }

        .secondary-category-text-field {
            position: relative;
        }
        
        .secondary-category-text-input {
            padding: 6px 10px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: var(--transition);
            min-width: 150px;
            width: 100%;
            text-align: right;
            cursor: pointer;
        }
        
        .secondary-category-text-field-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            pointer-events: none;
        }

        .products-count {
            font-size: 14px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 15px;
        }

        .online-users-real {
            font-size: 14px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 15px;
        }

        .show-more-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .secondary-favorites {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        /* ==========================================
           üéØ ÿ¥ÿßÿ±ÿ© ÿßŸÑÿπÿ±ÿ∂ ÿßŸÑÿÆÿßÿµ ÿßŸÑŸÖÿ≠ÿ≥ŸÜÿ© - ÿßŸÑÿ™ÿµŸÖŸäŸÖ ÿßŸÑÿ¨ÿØŸäÿØ
           ========================================== */
        .offer-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #2ecc71, #27ae60, #1e8449);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.5);
            animation: pulseOffer 2s infinite, floatOffer 3s ease-in-out infinite;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: var(--transition);
        }

        .offer-dates {
            position: absolute;
            top: 50px;
            left: 10px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-width: 180px;
            display: none;
        }

        /* ==========================================
           üîî ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
           ========================================== */
        .new-products-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .new-products-modal.active {
            display: flex;
        }

        .new-products-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease-out;
            border: 2px solid var(--primary-color);
            color: white;
            max-height: 80vh;
            overflow-y: auto;
        }

        .new-products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }

        .new-products-title {
            font-size: 22px;
            font-weight: bold;
            color: var(--success-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .new-products-close {
            background: var(--danger-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .new-products-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .new-product-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition);
            cursor: pointer;
        }

        .merchant-name {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .products-count-badge {
            background: var(--success-color);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
        }

        /* ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÅŸÑÿ™ÿ±ÿ© */
        .filter-bar {
            position: fixed;
            top: 128px;
            left: 0;
            width: 100%;
            background: var(--light-color);
            padding: 10px 20px;
            display: none;
            flex-wrap: wrap;
            gap: 10px;
            z-index: 998;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            align-items: center;
            transition: var(--transition);
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .search-container {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .voice-search-btn {
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }

        .reset-btn {
            padding: 8px 12px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--primary-color);
            color: white;
            position: relative;
        }

        /* ÿßŸÑŸÅŸàÿ™ÿ± */
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #3498db;
            color: white;
            text-align: center;
            padding: 8px 15px;
            z-index: 1000;
            font-size: 14px;
            overflow: hidden;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            cursor: default;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            height: 30px;
            width: 100%;
        }

        .footer-text {
            white-space: nowrap;
            position: relative;
            font-size: 16px;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 20px;
            background: transparent;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
            overflow: visible;
            width: auto;
            max-width: 90%;
            margin: 0 auto;
            text-overflow: unset;
            line-height: 1.2;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: slideText 15s linear infinite;
        }

        /* ÿ≠ÿ±ŸÉÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸàŸÖŸÖŸäÿ≤ÿ© ŸÑŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ */
        @keyframes slideText {
            0% {
                transform: translateX(-100%);
                opacity: 0;
            }
            10% {
                opacity: 1;
            }
            90% {
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }

        .scroll-to-top {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
        }

        .scroll-to-top.visible {
            opacity: 1;
            visibility: visible;
        }

        .filter-control {
            position: fixed;
            bottom: 120px;
            right: 20px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            opacity: 1;
            visibility: visible;
        }

        /* ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿµŸÅÿ≠ÿ© */
        .page-content {
            width: 100%;
            max-width: 100%;
            margin: 0;
            padding: 10px;
            box-sizing: border-box;
        }

        /* ÿ¥ÿ®ŸÉÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ */
        .products {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            padding: 10px;
            justify-content: center;
            width: 100%;
            box-sizing: border-box;
        }

        /* ÿßŸÑÿ®ÿ∑ÿßŸÇÿ© */
        .card {
            background: linear-gradient(145deg, var(--background-color), #f0f0f1);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            padding: 15px;
            transition: var(--transition);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: fit-content;
            width: 100%;
            box-sizing: border-box;
            border: 3px solid #3498db;
        }

        @media (min-width: 768px) {
            .card {
                width: calc(50% - 10px);
            }
        }

        @media (min-width: 1024px) {
            .card {
                width: calc(33.333% - 14px);
            }
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.15);
            border-color: #2980b9;
        }

        .card.has-offer {
            border: 3px solid #2ecc71;
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.2);
        }

        .card.highlighted {
            border: 3px solid var(--warning-color);
            box-shadow: 0 0 20px rgba(243, 156, 18, 0.5);
            animation: pulse 2s ease-in-out 3;
        }

        /* ÿ≠ÿßŸàŸäÿ© ÿßŸÑÿµŸÜŸÅ */
        .category-container {
            display: block !important;
            width: 100%;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--light-color);
            border-radius: 10px;
            border: 1px solid var(--primary-color);
        }

        .category-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .category-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .category-count {
            background: var(--primary-color);
            color: white;
            padding: 4px 10px;
            border-radius: 15px;
            font-size: 14px;
            font-weight: bold;
        }

        /* ÿµŸàÿ± ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ */
        .images-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            justify-content: center;
            width: 100%;
            position: relative;
            box-sizing: border-box;
        }

        .images-preview img {
            width: 100%;
            height: 300px;
            object-fit: contain;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            border: 3px solid var(--primary-color);
            position: relative;
            background-color: #f5f5f5;
        }

        /* ÿ¥ÿ±Ÿäÿ∑ ÿ™ŸÖÿ±Ÿäÿ± ÿßŸÑÿµŸàÿ± */
        .image-slider {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 10px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }

        .slider-container {
            display: flex;
            height: 100%;
            scroll-behavior: smooth;
            width: 100%;
        }

        .slider-image {
            min-width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
            border: 3px solid var(--primary-color);
            border-radius: 10px;
            background-color: #f5f5f5;
        }

        /* ŸÖÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ± */
        .image-gallery {
            display: none;
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.25s ease;
        }

        .image-gallery.active {
            display: flex;
        }

        .gallery-container {
            position: relative;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border-radius: 0;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            animation: slideUp 0.3s ease-out;
            min-width: 100%;
            min-height: 100%;
            box-sizing: border-box;
        }

        @keyframes slideUp {
            from {
                opacity: 0;
                transform: translateY(40px) scale(0.96);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-color);
            flex-shrink: 0;
        }

        .gallery-title {
            color: white;
            font-size: 22px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .gallery-close {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
            z-index: 2001;
        }

        .gallery-main-content {
            display: flex;
            gap: 16px;
            flex: 1;
            min-height: 0;
            width: 100%;
            height: calc(100% - 120px);
        }

        .gallery-main-image-container {
            flex: 4;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #0f0f23, #1a1a2e);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--primary-color);
            min-height: 60vh;
            width: 100%;
            height: 100%;
        }

        .gallery-main-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 10px;
            transition: transform 0.25s ease;
            cursor: zoom-in;
        }

        .gallery-thumbnails {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
            max-height: 100%;
            overflow-y: auto;
            padding: 10px;
            background: linear-gradient(145deg, #0f0f23, #16213e);
            border-radius: 15px;
            border: 1px solid var(--primary-color);
        }

        .gallery-thumbnail {
            width: 100%;
            height: 90px;
            object-fit: contain;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            opacity: 0.85;
            background: #0f0f23;
        }

        .gallery-thumbnail.active {
            opacity: 1;
            border-color: var(--warning-color);
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.6);
        }

        .gallery-bottom-navigation {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 16px;
            padding: 16px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }

        .gallery-nav-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }

        .gallery-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 12px;
            flex-shrink: 0;
        }

        .gallery-counter {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 8px 14px;
            border-radius: 18px;
            font-weight: bold;
            font-size: 14px;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
        }

        /* ÿ®ÿßŸÇŸä ÿßŸÑÿπŸÜÿßÿµÿ± */
        .info {
            width: 100%;
            text-align: center;
        }

        .info h3 {
            margin: 5px 0;
            font-size: 20px;
            color: #e74c3c !important;
            font-weight: bold;
        }

        .product-price {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
            padding: 8px;
            background-color: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            width: 100%;
        }

        .product-details {
            margin: 10px 0;
            font-size: 14px;
            color: #000;
            text-align: center;
            width: 100%;
            direction: center;
            position: relative;
            max-height: none;
            overflow: visible;
        }

        .product-detail-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
            direction: ltr;
        }

        .product-detail-item .label {
            font-weight: bold;
            color: var(--primary-color);
            margin-right: 10px;
        }

        .read-more-toggle {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-weight: bold;
            margin-right: 5px;
            padding: 0;
            text-decoration: none;
        }

        .merchant-info {
            display: flex;
            flex-direction: column;
            gap: 8px;
            margin: 10px 0;
            padding: 12px;
            background: linear-gradient(135deg, var(--light-color), #d5dbdb);
            border-radius: 10px;
            width: 100%;
            transition: var(--transition);
            border: 1px solid rgba(52, 152, 219, 0.2);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .merchant-name-old {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            cursor: pointer;
            color: var(--primary-color);
            font-weight: bold;
            transition: var(--transition);
            text-align: center;
            font-size: 16px;
            padding: 5px;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.5);
        }

        /* ŸÇÿ≥ŸÖ ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™ */
        .comments-section {
            width: 100%;
            margin-top: 15px;
            display: none;
            background: var(--light-color);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid var(--primary-color);
            animation: slideDown 0.25s ease-out;
        }

        .comments-section.active {
            display: block;
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--primary-color);
        }

        .comments-title {
            font-size: 16px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .close-comments {
            background: none;
            border: none;
            color: var(--danger-color);
            font-size: 20px;
            cursor: pointer;
            transition: var(--transition);
        }

        .comments-list {
            max-height: 250px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--background-color);
            border-radius: 8px;
        }

        .comment-item {
            padding: 10px;
            margin-bottom: 10px;
            background: var(--light-color);
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: var(--transition);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .comment-text {
            line-height: 1.6;
            font-size: 14px;
            color: var(--text-color);
            text-align: right;
            direction: rtl;
        }

        .add-comment {
            border-top: 1px solid #eee;
            padding-top: 15px;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        /* ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ */
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 3000;
            animation: slideInDown 0.3s ease;
        }

        /* ==========================================
           üéØ ÿ£ÿ≤ÿ±ÿßÿ± ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ - ÿßŸÑÿ™ŸÜÿ≥ŸäŸÇÿßÿ™ ÿßŸÑŸÖÿπÿØŸÑÿ©
           ========================================== */
        .action-buttons {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin: 15px 0;
            padding: 12px;
            background: var(--light-color);
            border-radius: 12px;
            gap: 10px;
        }

        .stats-buttons {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
            justify-content: center;
            flex: 1;
        }

        .stat-with-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
            min-width: 60px;
        }

        .stat-number {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            background: rgba(255, 255, 255, 0.9);
            padding: 3px 8px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            min-width: 35px;
            text-align: center;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .like-stat {
            color: var(--danger-color);
        }

        .view-stat {
            color: var(--primary-color);
        }

        .comment-stat {
            color: var(--success-color);
        }

        .action-button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }

        .favorite-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: var(--transition);
            color: #f39c12;
            font-size: 18px;
            position: relative;
            box-shadow: 0 3px 10px rgba(243, 156, 18, 0.3);
        }

        .favorite-btn.active {
            color: var(--danger-color);
            background: rgba(255, 255, 255, 1);
        }

        .share-button {
            background: rgba(255, 255, 255, 0.9);
            color: var(--warning-color);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }

        /* ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© */
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .share-modal.active {
            display: flex;
        }

        .share-modal-content {
            background: var(--background-color);
            border-radius: 15px;
            padding: 20px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
            animation: slideUp 0.3s ease;
        }

        .share-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--light-color);
        }

        .share-modal-title {
            font-size: 18px;
            font-weight: bold;
            color: var(--primary-color);
        }

        .share-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
        }

        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px 10px;
            border-radius: 10px;
            background: var(--light-color);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }

        /* ÿ™ÿ≠ÿ≥ŸäŸÜÿßÿ™ ŸÑŸÑÿ£ÿ¨Ÿáÿ≤ÿ© ÿßŸÑŸÖÿ≠ŸÖŸàŸÑÿ© */
        @media (max-width: 768px) {
            body { padding-top: 128px; padding-bottom: 40px; }
            .filter-bar { top: 128px; padding: 8px 10px; }
            .products { grid-template-columns: 1fr; }
            .images-preview img, .slider-image { height: 250px; }
            .image-slider { height: 250px; }
            
            .brand-title {
                font-size: 16px;
            }
            
            .brand-subtitle {
                font-size: 11px;
            }

            .scroll-to-top, .filter-control {
                bottom: auto;
                right: 20px;
                left: auto;
                transform: none;
                width: 45px;
                height: 45px;
            }

            .scroll-to-top {
                bottom: 60px;
            }

            .filter-control {
                bottom: 120px;
            }

            .action-buttons {
                flex-direction: column;
                gap: 12px;
            }

            .stats-buttons {
                justify-content: space-around;
                width: 100%;
                gap: 10px;
            }
            
            .stat-with-button {
                min-width: 55px;
            }
            
            .action-button, .share-button, .favorite-btn {
                width: 40px;
                height: 40px;
                font-size: 16px;
            }

            .stat-number {
                font-size: 12px;
                min-width: 30px;
                height: 20px;
            }

            .header-online-users {
                font-size: 12px;
                padding: 4px 8px;
            }

            .header-login {
                font-size: 12px;
                padding: 4px 8px;
            }

            .secondary-bar {
                padding: 6px 10px;
            }

            .secondary-bar-left, .secondary-bar-right {
                gap: 8px;
            }

            .secondary-category-text-input {
                min-width: 120px;
                font-size: 12px;
            }

            .products-count {
                font-size: 12px;
            }

            .online-users-real {
                font-size: 12px;
                padding: 4px 8px;
            }

            .show-more-btn {
                font-size: 12px;
                padding: 4px 8px;
            }

            .secondary-favorites {
                width: 30px;
                height: 30px;
                font-size: 12px;
            }

            /* ÿ™ÿπÿØŸäŸÑÿßÿ™ ÿßŸÑŸÅŸàÿ™ÿ± ÿπŸÑŸâ ÿßŸÑÿ¨ŸàÿßŸÑ */
            .footer {
                height: 40px;
            }
            
            .footer-text {
                font-size: 14px;
                padding: 6px 12px;
                min-height: 30px;
            }

            /* ÿ≤ÿ± ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿπŸÑŸâ ÿßŸÑÿ¨ŸàÿßŸÑ */
            .notification-permission-btn {
                bottom: 60px;
                left: 50%;
                transform: translateX(-50%);
                width: 90%;
                max-width: 300px;
                justify-content: center;
            }
        }

        @media (max-width: 480px) {
            .images-preview img, .slider-image { 
                width: 100%;
                height: 250px; 
            }
            .image-slider { 
                width: 100%;
                height: 250px; 
            }

            .brand-logo {
                width: 40px;
                height: 40px;
            }
            
            .action-buttons {
                padding: 8px;
                gap: 10px;
            }
            
            .stats-buttons {
                gap: 8px;
            }
            
            .stat-with-button {
                min-width: 50px;
            }
            
            .action-button, .share-button, .favorite-btn {
                width: 38px;
                height: 38px;
                font-size: 15px;
            }

            .stat-number {
                font-size: 11px;
                min-width: 28px;
                height: 18px;
            }

            .header-online-users {
                font-size: 11px;
                padding: 3px 6px;
            }

            .header-login {
                font-size: 11px;
                padding: 3px 6px;
            }

            .secondary-bar {
                padding: 4px 8px;
            }

            .secondary-bar-left, .secondary-bar-right {
                gap: 6px;
            }

            .secondary-category {
                flex-direction: column;
                gap: 3px;
            }

            .secondary-category label {
                font-size: 11px;
            }

            .secondary-category-text-input {
                min-width: 100px;
                font-size: 11px;
                padding: 4px 6px;
            }

            .products-count {
                font-size: 11px;
            }

            .online-users-real {
                font-size: 11px;
                padding: 3px 6px;
            }

            .show-more-btn {
                font-size: 11px;
                padding: 3px 6px;
            }

            .secondary-favorites {
                width: 28px;
                height: 28px;
                font-size: 11px;
            }

            /* ÿ™ÿπÿØŸäŸÑÿßÿ™ ÿßŸÑŸÅŸàÿ™ÿ± ÿπŸÑŸâ ÿßŸÑÿ¨ŸàÿßŸÑ ÿßŸÑÿµÿ∫Ÿäÿ± */
            .footer {
                height: 35px;
                padding: 5px 10px;
            }
            
            .footer-text {
                font-size: 12px;
                padding: 5px 10px;
                min-height: 25px;
            }
        }
    </style>
</head>
<body>
    <!-- ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÜÿµÿ± ÿßŸÑÿµŸàÿ™Ÿä -->
    <audio id="new-product-sound" preload="auto">
        <source src="https://github.com/e772299420-hue/Call/raw/main/Sms.mp3" type="audio/mpeg">
    </audio>

    <!-- ==========================================
       üîî ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿπŸÑŸàŸä
       ========================================== -->
    <div class="notification-bar hidden" id="notification-bar">
        <div class="notification-content">
            <div class="notification-icon">
                <i class="fas fa-bell"></i>
            </div>
            <div class="notification-text" id="notification-text">
                ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ©!
            </div>
            <div class="notification-actions">
                <button class="notification-btn" id="notification-show-btn">
                    ÿπÿ±ÿ∂
                </button>
                <button class="notification-close" id="notification-close-btn">
                    √ó
                </button>
            </div>
        </div>
    </div>

    <!-- ÿ¥ÿßÿ¥ÿ© ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ - ŸÖÿÆŸÅŸäÿ© -->
    <div class="loading-overlay" id="loading-overlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>
        <div class="loading-progress">
            <div class="loading-progress-bar" id="loading-progress-bar"></div>
        </div>
    </div>

    <!-- ÿßŸÑŸáŸäÿØÿ± -->
    <header class="header">
        <div class="header-content">
            <!-- ÿßŸÑÿ¥ÿπÿßÿ± ŸàÿßŸÑÿπŸÜŸàÿßŸÜ ŸÅŸä ÿ£ŸÇÿµŸâ ÿßŸÑŸäÿ≥ÿßÿ± -->
            <div class="brand">
                <img src="https://raw.githubusercontent.com/e772299420-hue/Call/main/icon-512x5122.png" alt="ÿ¥ÿπÿßÿ± AZ" class="brand-logo">
                <div class="brand-text">
                    <div class="brand-title">AZ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ¥ÿßŸÖŸÑ</div>
                    <div class="brand-subtitle">ŸÑÿ™ŸÑÿ®Ÿäÿ© ÿßÿ≠ÿ™Ÿäÿßÿ¨ŸÉ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ</div>
                </div>
            </div>

            <!-- ÿ≤ÿ± ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ ŸàÿπÿØÿØ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ ŸÅŸä ÿ£ŸÇÿµŸâ ÿßŸÑŸäŸÖŸäŸÜ -->
            <div class="header-right">
                <a href="manjr_tagr_snf.html" class="header-login" title="ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ">
                    <i class="fas fa-sign-in-alt"></i>
                    ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ
                </a>
                
                <div class="header-online-users" id="header-online-users">
                    <i class="fas fa-users"></i>
                    <span id="header-users-count">0</span> ŸÖÿ™ÿµŸÑ ÿßŸÑÿ¢ŸÜ
                </div>
            </div>
        </div>
    </header>

    <!-- ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿØŸäÿØ ÿ£ÿ≥ŸÅŸÑ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿπŸÑŸàŸä -->
    <div class="secondary-bar">
        <div class="secondary-bar-content">
            <div class="secondary-bar-left">
                <!-- ÿ≠ŸÇŸÑ ÿßŸÑŸÇÿ≥ŸÖ ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿØŸäÿØ -->
                <div class="secondary-category">
                    <div class="secondary-category-text-field">
                        <input type="text" 
                               id="secondary-category-text-input" 
                               class="secondary-category-text-input" 
                               placeholder="ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ"
                               readonly>
                        <div class="secondary-category-text-field-icon">
                            <i class="fas fa-tags"></i>
                        </div>
                    </div>
                </div>

                <!-- ÿπÿØÿØ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ -->
                <div class="products-count">
                    <i class="fas fa-box"></i>
                    <span id="products-count"> : 0</span>
                </div>

                <!-- ÿπÿØÿØ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ ÿßŸÑÿ≠ŸÇŸäŸÇŸä -->
                <div class="online-users-real">
                    <i class="fas fa-users"></i>
                    <span id="real-online-users">0</span>
                </div>
            </div>

            <div class="secondary-bar-right">
                <!-- ÿ≤ÿ± ÿπÿ±ÿ∂ ÿ£ŸÉÿ´ÿ± -->
                <button class="show-more-btn" id="show-more-btn">
                    <i class="fas fa-bars"></i>
                    ÿπÿ±ÿ∂ ÿ£ŸÉÿ´ÿ±
                </button>

                <!-- ÿ≤ÿ± ÿßŸÑŸÖŸÅÿ∂ŸÑÿ© ŸÅŸä ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿØŸäÿØ -->
                <button class="secondary-favorites" id="secondary-favorites" title="ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÅŸÑÿßÿ™ÿ± - ŸÖÿÆŸÅŸä ÿßŸÅÿ™ÿ±ÿßÿ∂ŸäÿßŸã -->
    <div class="filter-bar" id="filter-bar">
        <div class="filter-item">
            <label for="governorate">ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿ©:</label>
            <select id="governorate"><option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿßÿ™</option></select>
        </div>
        <div class="filter-item">
            <label for="region">ÿßŸÑŸÖŸÜÿ∑ŸÇÿ©:</label>
            <select id="region"><option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option></select>
        </div>
        
        <!-- ÿ≠ŸÇŸÑ ŸÜÿµŸä ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ™ÿßÿ¨ÿ± -->
        <div class="filter-item">
            <label for="merchant-text-input">ÿßŸÑÿ™ÿßÿ¨ÿ±:</label>
            <div class="merchant-text-field">
                <input type="text" 
                       id="merchant-text-input" 
                       class="merchant-text-input" 
                       placeholder="ÿßŸÜŸÇÿ± ŸÑÿßÿÆÿ™Ÿäÿßÿ± ÿ™ÿßÿ¨ÿ±"
                       readonly>
                <div class="merchant-text-field-icon">
                    <i class="fas fa-store"></i>
                </div>
            </div>
        </div>
        
        <!-- ÿ≠ŸÇŸÑ ŸÜÿµŸä ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ -->
        <div class="filter-item">
            <label for="category-text-input">ÿßŸÑŸÇÿ≥ŸÖ:</label>
            <div class="category-text-field">
                <input type="text" 
                       id="category-text-input" 
                       class="category-text-input" 
                       placeholder="ÿßŸÜŸÇÿ± ŸÑÿßÿÆÿ™Ÿäÿßÿ± ŸÇÿ≥ŸÖ"
                       readonly>
                <div class="category-text-field-icon">
                    <i class="fas fa-tags"></i>
                </div>
            </div>
            <span class="category-value-display" id="category-value-display"></span>
        </div>
        
        <div class="filter-item">
            <label for="search">ÿ®ÿ≠ÿ´:</label>
            <div class="search-container">
                <input type="text" id="search" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÖŸÜÿ™ÿ¨...">
                <button class="voice-search-btn" id="voice-search-btn" title="ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿµŸàÿ™Ÿä">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
        <div class="filter-item">
            <label for="sort-by">ÿ™ÿ±ÿ™Ÿäÿ®:</label>
            <select id="sort-by">
                <option value="date">ÿßŸÑÿ™ÿßÿ±ŸäÿÆ (ÿßŸÑÿ£ÿ≠ÿØÿ´ ÿ£ŸàŸÑÿßŸã)</option>
                <option value="name">ÿßŸÑÿßÿ≥ŸÖ</option>
                <option value="category">ÿßŸÑŸÇÿ≥ŸÖ</option>
                <option value="price">ÿßŸÑÿ≥ÿπÿ±</option>
                <option value="merchant">ÿßŸÑÿ™ÿßÿ¨ÿ±</option>
                <option value="preference">ÿ±ÿ∫ÿ®ÿ™Ÿä</option>
                <option value="offers">ÿßŸÑÿπÿ±Ÿàÿ∂</option>
            </select>
        </div>
        <button class="reset-btn" id="reset-filters" title="ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸÑÿßÿ™ÿ±">
            <i class="fas fa-redo"></i>
            <span class="tooltip">ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸÑÿßÿ™ÿ±</span>
        </button>
    </div>

    <!-- ==========================================
       üîî ÿ≤ÿ± ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
       ========================================== -->
    <button class="notification-permission-btn hidden" id="notification-permission-btn">
        <i class="fas fa-bell"></i>
        ÿ™ŸÅÿπŸäŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
    </button>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ™ÿßÿ¨ÿ± -->
    <div class="merchant-modal-overlay" id="merchant-modal-overlay">
        <div class="merchant-modal">
            <div class="merchant-modal-header">
                <div class="merchant-modal-title">ÿ£ÿ≥ŸÖÿßÿ° ÿßŸÑÿ™ÿ¨ÿßÿ± ÿßŸÑŸÖÿ±ÿ™ÿ®ÿ∑ŸäŸÜ</div>
                <div class="merchant-modal-subtitle">ÿßÿÆÿ™ÿ± ÿ™ÿßÿ¨ÿ± ŸÑÿπÿ±ÿ∂ ŸÖŸÜÿ™ÿ¨ÿßÿ™Ÿá</div>
            </div>
            <div class="merchant-modal-body">
                <div class="merchant-modal-search">
                    <input type="text" id="merchant-modal-search-input" class="merchant-modal-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ÿ™ÿßÿ¨ÿ±...">
                </div>
                <div class="merchants-modal-list" id="merchants-modal-list">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ© ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ÿ¨ÿßÿ± ŸáŸÜÿß -->
                </div>
            </div>
            <div class="merchant-modal-footer">
                <button id="merchant-modal-cancel" class="merchant-modal-btn merchant-modal-btn-cancel">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button id="merchant-modal-confirm" class="merchant-modal-btn merchant-modal-btn-confirm" disabled>ŸÖŸàÿßŸÅŸÇ</button>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ -->
    <div class="category-modal-overlay" id="category-modal-overlay">
        <div class="category-modal">
            <div class="category-modal-header">
                <div class="category-modal-title">ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ÿßŸÑŸÖÿ™ÿßÿ≠ÿ©</div>
                <div class="category-modal-subtitle">ÿßÿÆÿ™ÿ± ŸÇÿ≥ŸÖ ŸÑÿπÿ±ÿ∂ ŸÖŸÜÿ™ÿ¨ÿßÿ™Ÿá</div>
            </div>
            <div class="category-modal-body">
                <div class="category-modal-search">
                    <input type="text" id="category-modal-search-input" class="category-modal-search-input" placeholder="ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÇÿ≥ŸÖ...">
                </div>
                <div class="categories-modal-list" id="categories-modal-list">
                    <!-- ÿ≥Ÿäÿ™ŸÖ ÿ™ÿπÿ®ÿ¶ÿ© ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ ŸáŸÜÿß -->
                </div>
            </div>
            <div class="category-modal-footer">
                <button id="category-modal-cancel" class="category-modal-btn merchant-modal-btn-cancel">ÿ•ŸÑÿ∫ÿßÿ°</button>
                <button id="category-modal-confirm" class="category-modal-btn merchant-modal-btn-confirm" disabled>ŸÖŸàÿßŸÅŸÇ</button>
            </div>
        </div>
    </div>

    <!-- ÿ≤ÿ± ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ£ÿπŸÑŸâ -->
    <button class="scroll-to-top" id="scroll-to-top" title="ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿ£ÿπŸÑŸâ">
        <i class="fas fa-chevron-up"></i>
    </button>

    <!-- ÿ≤ÿ± ÿ™ÿ≠ŸÉŸÖ ÿßŸÑÿ¥ÿ±Ÿäÿ∑ -->
    <button class="filter-control" id="filter-control" title="ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÅŸÑÿßÿ™ÿ±">
        <i class="fas fa-sliders-h"></i>
    </button>

    <!-- ÿßŸÑŸÖÿ≠ÿ™ŸàŸâ -->
    <div class="page-content">
        <div id="products-container">
            <div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™...</div>
        </div>
    </div>

    <!-- ŸÖÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ± ÿßŸÑŸÖÿ≠ÿ≥ŸÜ -->
    <div class="image-gallery" id="image-gallery">
        <div class="gallery-container">
            <div class="gallery-header">
                <div class="gallery-title">
                    <i class="fas fa-images"></i>
                    <span id="gallery-product-name">ŸÖÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±</span>
                </div>
                <button class="gallery-close" id="gallery-close">√ó</button>
            </div>

            <div class="gallery-main-content">
                <div class="gallery-main-image-container">
                    <img id="gallery-main-image" class="gallery-main-image" alt="ÿµŸàÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨" decoding="async" fetchpriority="high">
                </div>

                <div class="gallery-thumbnails" id="gallery-thumbnails">
                    <!-- ÿßŸÑÿµŸàÿ± ÿßŸÑŸÖÿµÿ∫ÿ±ÿ© ÿ≥ÿ™ŸèÿØÿ±ÿ¨ ŸáŸÜÿß -->
                </div>
            </div>

            <div class="gallery-bottom-navigation">
                <button class="gallery-nav-btn" id="gallery-prev" title="ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="gallery-counter" id="gallery-counter">1 ŸÖŸÜ 1</div>
                <button class="gallery-nav-btn" id="gallery-next" title="ÿßŸÑÿµŸàÿ±ÿ© ÿßŸÑÿ™ÿßŸÑŸäÿ©">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>

            <div class="gallery-info">
                <button class="gallery-zoom-btn" id="gallery-zoom">
                    <i class="fas fa-search-plus"></i>
                    ÿ™ŸÉÿ®Ÿäÿ±/ÿ™ÿµÿ∫Ÿäÿ±
                </button>
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© -->
    <div class="new-products-modal" id="new-products-modal">
        <div class="new-products-content">
            <div class="new-products-header">
                <div class="new-products-title">
                    <i class="fas fa-gift"></i>
                    ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ÿ™ÿ¨ÿßÿ±ŸÉ ÿßŸÑŸÖŸÅÿ∂ŸÑŸäŸÜ
                </div>
                <button class="new-products-close" id="new-products-close">√ó</button>
            </div>
            <div class="new-products-list" id="new-products-list">
                <!-- ÿ≥Ÿäÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ™ÿ¨ÿßÿ± ŸáŸÜÿß -->
            </div>
            <div class="new-products-footer">
                ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ÿ™ÿ¨ÿßÿ±ŸÉ ÿßŸÑŸÖŸÅÿ∂ŸÑŸäŸÜ
            </div>
        </div>
    </div>

    <!-- ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© -->
    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-header">
                <div class="share-modal-title">ŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨</div>
                <button class="share-modal-close" id="share-modal-close">√ó</button>
            </div>
            <div class="share-options">
                <div class="share-option share-whatsapp" data-platform="whatsapp">
                    <i class="fab fa-whatsapp"></i>
                    <span>Ÿàÿßÿ™ÿ≥ÿßÿ®</span>
                </div>
                <div class="share-option share-facebook" data-platform="facebook">
                    <i class="fab fa-facebook"></i>
                    <span>ŸÅŸäÿ≥ÿ®ŸàŸÉ</span>
                </div>
                <div class="share-option share-twitter" data-platform="twitter">
                    <i class="fab fa-twitter"></i>
                    <span>ÿ™ŸàŸäÿ™ÿ±</span>
                </div>
                <div class="share-option share-telegram" data-platform="telegram">
                    <i class="fab fa-telegram"></i>
                    <span>ÿ™ŸäŸÑŸäÿ¨ÿ±ÿßŸÖ</span>
                </div>
                <div class="share-option share-link" data-platform="copy">
                    <i class="fas fa-link"></i>
                    <span>ŸÜÿ≥ÿÆ ÿßŸÑÿ±ÿßÿ®ÿ∑</span>
                </div>
                <div class="share-option share-other" data-platform="other">
                    <i class="fas fa-share-alt"></i>
                    <span>ÿ™ÿ∑ÿ®ŸäŸÇÿßÿ™ ÿ£ÿÆÿ±Ÿâ</span>
                </div>
            </div>
        </div>
    </div>

    <!-- ÿßŸÑŸÅŸàÿ™ÿ± -->
    <footer class="footer">
        <div class="footer-content">
            <div class="footer-text" id="footer-text">
                ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑÿØŸâ ÿßŸÑŸÖŸÖŸäÿ≤ ÿ≥ŸàŸÅÿ™ ŸÑŸÑÿ£ŸÜÿ∏ŸÖÿ© ÿßŸÑŸÖÿ≠ÿßÿ≥ÿ®Ÿäÿ© ÿßŸÑŸÖÿ™ŸÉÿßŸÖŸÑÿ©
            </div>
            <div class="online-users" id="online-users" style="display: none;">
                <i class="fas fa-users"></i>
                <span id="users-count">0</span> ŸÖŸàÿ¨ÿØ ÿßŸÑÿ¢ŸÜ
            </div>
        </div>
    </footer>

    <script>
        // ==========================================
        // üîî ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ ŸàÿßŸÑŸÖÿ®ÿ≥ÿ∑
        // ==========================================
        
        let notificationPermission = Notification.permission;
        let notificationInterval = null;
        let lastProductCheckTime = localStorage.getItem('lastProductCheckTime') || new Date().toISOString();
        let newProductsNotificationCount = 0;

        // ==========================================
        // üîß ÿ™ŸáŸäÿ¶ÿ© ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ - ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑŸÖÿ®ÿ≥ÿ∑ÿ©
        // ==========================================
        function initializeBrowserNotifications() {
            console.log('üîî ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™...');
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿØÿπŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
            if (!('Notification' in window)) {
                console.log('‚ö†Ô∏è Ÿáÿ∞ÿß ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸàŸäÿ®');
                showNotification('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™', 'error');
                return;
            }
            
            // ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ∞ŸÜ
            updateNotificationPermission();
            
            // ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
            setupNotificationListeners();
            
            // ÿ®ÿØÿ° ŸÅÿ≠ÿµ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
            startNewProductsNotificationCheck();
            
            console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
        }

        // ==========================================
        // üîß ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ∞ŸÜ
        // ==========================================
        function updateNotificationPermission() {
            notificationPermission = Notification.permission;
            const permissionBtn = document.getElementById('notification-permission-btn');
            
            if (notificationPermission === 'granted') {
                permissionBtn.classList.add('hidden');
                console.log('‚úÖ ÿßŸÑÿ•ÿ∞ŸÜ ŸÖŸèŸÖŸÜÿ≠ ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
                showNotification('ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖŸÅÿπŸÑÿ©! ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿπŸÜÿØ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ©.', 'success');
            } else if (notificationPermission === 'denied') {
                permissionBtn.classList.add('hidden');
                console.log('‚ùå ÿßŸÑÿ•ÿ∞ŸÜ ŸÖÿ±ŸÅŸàÿ∂ ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
                showNotification('ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ•ÿ∞ŸÜ. ŸäŸÖŸÉŸÜŸÉ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸäÿØŸàŸäÿßŸã ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.', 'info');
            } else {
                permissionBtn.classList.remove('hidden');
                console.log('‚è≥ ŸÅŸä ÿßŸÜÿ™ÿ∏ÿßÿ± ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™');
            }
        }

        // ==========================================
        // üîß ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿ£ÿ≠ÿØÿßÿ´ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
        // ==========================================
        function setupNotificationListeners() {
            // ÿ≤ÿ± ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿ∞ŸÜ - ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑŸÖÿ®ÿ≥ÿ∑ÿ©
            document.getElementById('notification-permission-btn').addEventListener('click', requestNotificationPermission);
            
            // ÿ≤ÿ± ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿßŸÑÿπŸÑŸàŸä
            document.getElementById('notification-close-btn').addEventListener('click', () => {
                document.getElementById('notification-bar').classList.add('hidden');
            });
            
            // ÿ≤ÿ± ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
            document.getElementById('notification-show-btn').addEventListener('click', () => {
                document.getElementById('notification-bar').classList.add('hidden');
                showNewProducts();
            });
            
            // ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
            document.getElementById('notification-bar').addEventListener('click', (e) => {
                if (e.target.closest('#notification-show-btn')) return;
                showNewProducts();
                document.getElementById('notification-bar').classList.add('hidden');
            });
        }

        // ==========================================
        // üîß ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ - ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑŸÖÿ®ÿ≥ÿ∑ÿ©
        // ==========================================
        function requestNotificationPermission() {
            if (!('Notification' in window)) {
                showNotification('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™', 'error');
                return;
            }
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ÿßŸÑŸÖŸàŸÇÿπ ŸäÿπŸÖŸÑ ÿπŸÑŸâ HTTP ÿ®ÿØŸÑÿßŸã ŸÖŸÜ HTTPSÿå ŸÇÿØ ŸÑÿß ÿ™ÿπŸÖŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
            if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                showNotification('ŸÑÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ÿå Ÿäÿ¨ÿ® ÿ£ŸÜ ŸäŸÉŸàŸÜ ÿßŸÑŸÖŸàŸÇÿπ ÿπŸÑŸâ HTTPS', 'info');
                console.warn('‚ö†Ô∏è ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿ™ÿ™ÿ∑ŸÑÿ® HTTPS ŸÑŸÑÿπŸÖŸÑ ÿ®ÿ¥ŸÉŸÑ ÿµÿ≠Ÿäÿ≠');
            }
            
            // ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑŸÖÿ®ÿ≥ÿ∑ÿ© ŸÖŸÜ ÿ∑ŸÑÿ® ÿßŸÑÿ•ÿ∞ŸÜ
            Notification.requestPermission()
                .then(permission => {
                    updateNotificationPermission();
                    
                    if (permission === 'granted') {
                        showNotification('ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ®ŸÜÿ¨ÿßÿ≠!', 'success');
                        
                        // ÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ± ÿ™ÿ±ÿ≠Ÿäÿ®Ÿä
                        showBrowserNotification(
                            'AZ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ¥ÿßŸÖŸÑ',
                            'ÿ™ŸÖ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™! ÿ≥ÿ™ÿ™ŸÑŸÇŸâ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿπŸÜÿØ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ©.',
                            'welcome'
                        );
                        
                        // ÿ≠ŸÅÿ∏ ÿ≠ÿßŸÑÿ© ÿßŸÑÿ•ÿ∞ŸÜ
                        localStorage.setItem('notificationPermission', 'granted');
                    } else if (permission === 'denied') {
                        showNotification('ÿ™ŸÖ ÿ±ŸÅÿ∂ ÿßŸÑÿ•ÿ∞ŸÜ. ŸäŸÖŸÉŸÜŸÉ ÿ™ŸÅÿπŸäŸÑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸäÿØŸàŸäÿßŸã ŸÖŸÜ ÿ•ÿπÿØÿßÿØÿßÿ™ ÿßŸÑŸÖÿ™ÿµŸÅÿ≠.', 'info');
                        localStorage.setItem('notificationPermission', 'denied');
                    }
                })
                .catch(error => {
                    console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™:', error);
                    showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ∑ŸÑÿ® ÿ•ÿ∞ŸÜ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™. Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ.', 'error');
                });
        }

        // ==========================================
        // üîî ÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ - ÿßŸÑŸÜÿ≥ÿÆÿ© ÿßŸÑŸÖÿ®ÿ≥ÿ∑ÿ©
        // ==========================================
        function showBrowserNotification(title, body, tag = 'new-product', data = {}) {
            if (!('Notification' in window) || notificationPermission !== 'granted') {
                console.log('‚ùå ŸÑÿß ŸäŸÖŸÉŸÜ ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±: ÿßŸÑÿ•ÿ∞ŸÜ ÿ∫Ÿäÿ± ŸÖŸèŸÖŸÜÿ≠');
                return;
            }
            
            const options = {
                body: body,
                icon: 'https://raw.githubusercontent.com/e772299420-hue/Call/main/icon-512x5122.png',
                badge: 'https://raw.githubusercontent.com/e772299420-hue/Call/main/icon-512x5122.png',
                tag: tag,
                renotify: true,
                requireInteraction: true,
                vibrate: [200, 100, 200],
                data: data
            };
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿµŸàÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
            playNotificationSound();
            
            try {
                // ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                const notification = new Notification(title, options);
                
                // ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                notification.onclick = function(event) {
                    event.preventDefault();
                    window.focus();
                    this.close();
                    
                    // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ÿ±ÿßÿ®ÿ∑ÿå ŸÜŸÅÿ™ÿ≠Ÿá
                    if (data.url) {
                        window.open(data.url, '_blank');
                    } else if (data.productId) {
                        // ŸÅÿ™ÿ≠ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑŸÖÿ≠ÿØÿØ
                        highlightProduct(data.productId);
                    }
                };
                
                // ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿ•ÿ¥ÿπÿßÿ± ÿ®ÿπÿØ 10 ÿ´ŸàÿßŸÜŸä
                setTimeout(() => {
                    notification.close();
                }, 10000);
                
                console.log('üîî ÿ™ŸÖ ÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ÿµŸÅÿ≠:', title);
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±:', error);
            }
        }

        // ==========================================
        // üîî ÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿ™ÿπÿØÿØÿ© ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        // ==========================================
        function showMultipleProductsNotification(products) {
            if (products.length === 0) return;
            
            const productCount = products.length;
            const merchantNames = [...new Set(products.map(p => p.merchantName))];
            
            let title = '';
            let body = '';
            
            if (productCount === 1) {
                title = 'ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ ŸÖŸÜ ' + products[0].merchantName;
                body = products[0].productName;
            } else if (merchantNames.length === 1) {
                title = `${productCount} ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ${merchantNames[0]}`;
                body = `ÿ™ŸÖÿ™ ÿ•ÿ∂ÿßŸÅÿ© ${productCount} ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ©`;
            } else {
                title = `${productCount} ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ${merchantNames.length} ÿ™ÿ¨ÿßÿ±`;
                body = `ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ ŸÖŸÜ: ${merchantNames.slice(0, 2).join('ÿå ')}${merchantNames.length > 2 ? '...' : ''}`;
            }
            
            // ÿ•ÿ∂ÿßŸÅÿ© ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑŸÑÿ•ÿ¥ÿπÿßÿ±
            const notificationData = {
                type: 'new-products',
                products: products.map(p => ({ id: p.id, name: p.productName })),
                timestamp: new Date().toISOString()
            };
            
            // ÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ± ÿßŸÑŸÖÿ™ÿµŸÅÿ≠
            showBrowserNotification(title, body, 'new-products-' + Date.now(), notificationData);
            
            // ÿπÿ±ÿ∂ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©
            showNotificationBar(productCount, merchantNames);
        }

        // ==========================================
        // üîî ÿπÿ±ÿ∂ ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÅŸä ÿßŸÑÿµŸÅÿ≠ÿ©
        // ==========================================
        function showNotificationBar(productCount, merchantNames) {
            const notificationBar = document.getElementById('notification-bar');
            const notificationText = document.getElementById('notification-text');
            
            let text = '';
            if (productCount === 1) {
                text = 'ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ!';
            } else if (merchantNames.length === 1) {
                text = `ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ${productCount} ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ${merchantNames[0]}`;
            } else {
                text = `ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ${productCount} ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ© ŸÖŸÜ ${merchantNames.length} ÿ™ÿ¨ÿßÿ±`;
            }
            
            notificationText.textContent = text;
            notificationBar.classList.remove('hidden');
            
            // ÿ•ÿÆŸÅÿßÿ° ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã ÿ®ÿπÿØ 10 ÿ´ŸàÿßŸÜŸä
            setTimeout(() => {
                notificationBar.classList.add('hidden');
            }, 10000);
        }

        // ==========================================
        // üîî ÿ®ÿØÿ° ŸÅÿ≠ÿµ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        // ==========================================
        function startNewProductsNotificationCheck() {
            // ŸÅÿ≠ÿµ ŸÉŸÑ 30 ÿ´ÿßŸÜŸäÿ©
            notificationInterval = setInterval(() => {
                checkForNewProducts();
            }, 30000);
            
            // ŸÅÿ≠ÿµ ÿ£ŸàŸÑŸä
            setTimeout(() => {
                checkForNewProducts();
            }, 5000);
        }

        // ==========================================
        // üîî ŸÅÿ≠ÿµ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        // ==========================================
        function checkForNewProducts() {
            if (allProducts.length === 0) return;
            
            const lastCheck = new Date(lastProductCheckTime);
            const now = new Date();
            
            // ÿßŸÑÿ®ÿ≠ÿ´ ÿπŸÜ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ© ÿ®ÿπÿØ ÿ¢ÿÆÿ± ŸÅÿ≠ÿµ
            const newProducts = allProducts.filter(product => {
                const productDate = new Date(product.publishDate || product.createdAt || product.date || 0);
                return productDate > lastCheck && productDate <= now;
            });
            
            // ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸáŸÜÿßŸÉ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ©
            if (newProducts.length > 0) {
                console.log(`üîî ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ${newProducts.length} ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ¨ÿØŸäÿØÿ©`);
                
                // ÿ™ÿ≠ÿ∂Ÿäÿ± ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
                const notificationProducts = newProducts.map(product => {
                    const merchant = allMerchants.find(m => m.id === product.userId);
                    return {
                        id: product.id,
                        productName: product.name || 'ŸÖŸÜÿ™ÿ¨ ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ',
                        merchantName: merchant ? (merchant.name || merchant.username) : 'ÿ™ÿßÿ¨ÿ±',
                        date: product.publishDate || product.createdAt || product.date,
                        price: product.price,
                        categoryId: product.categoryId
                    };
                });
                
                // ÿπÿ±ÿ∂ ÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
                showMultipleProductsNotification(notificationProducts);
                
                // ÿ™ÿ≠ÿØŸäÿ´ ŸàŸÇÿ™ ÿ¢ÿÆÿ± ŸÅÿ≠ÿµ
                lastProductCheckTime = now.toISOString();
                localStorage.setItem('lastProductCheckTime', lastProductCheckTime);
                
                // ÿ≤ŸäÿßÿØÿ© ÿπÿØÿßÿØ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
                newProductsNotificationCount += newProducts.length;
                updateNotificationBadge();
            }
        }

        // ==========================================
        // üîî ÿ™ÿ≠ÿØŸäÿ´ ÿ¥ÿßÿ±ÿ© ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
        // ==========================================
        function updateNotificationBadge() {
            if (newProductsNotificationCount > 0) {
                document.title = `(${newProductsNotificationCount}) AZ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ¥ÿßŸÖŸÑ`;
            } else {
                document.title = 'AZ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ¥ÿßŸÖŸÑ';
            }
        }

        // ==========================================
        // üîî ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        // ==========================================
        function showNewProducts() {
            // ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑÿπÿØÿßÿØ
            newProductsNotificationCount = 0;
            updateNotificationBadge();
            
            // ÿπÿ±ÿ∂ ÿ£ÿ≠ÿØÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™
            const recentProducts = [...allProducts]
                .sort((a, b) => {
                    const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                    const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                    return bDate - aDate;
                })
                .slice(0, 20);
            
            displayProducts(recentProducts);
            window.scrollTo({ top: 0, behavior: 'smooth' });
            
            showNotification('ÿπÿ±ÿ∂ ÿ£ÿ≠ÿØÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™', 'success');
        }

        // ==========================================
        // üîä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿµŸàÿ™ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±
        // ==========================================
        function playNotificationSound() {
            try {
                const sound = document.getElementById('new-product-sound');
                sound.currentTime = 0;
                sound.play().catch(e => {
                    console.log('ÿ™ÿπÿ∞ÿ± ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™:', e);
                });
            } catch (error) {
                console.log('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ¥ÿ∫ŸäŸÑ ÿßŸÑÿµŸàÿ™:', error);
            }
        }

        // ==========================================
        // üîß ÿ™ŸáŸäÿ¶ÿ© Firebase
        // ==========================================
        const firebaseConfig = { 
            databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/" 
        };
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
                console.log('‚úÖ Firebase initialized successfully');
            }
        } catch (error) {
            console.error("‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ŸáŸäÿ¶ÿ© Firebase:", error);
        }
        
        const db = firebase.database();

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
        let allProducts = [];
        let allMerchants = [];
        let allGovernorates = [];
        let allRegions = [];
        let allCategories = [];
        let favoriteProducts = JSON.parse(localStorage.getItem('favoriteProducts')) || {};
        let userInterests = JSON.parse(localStorage.getItem('userInterests')) || {};
        let showFavoritesOnly = false;
        let isCommentsOpen = false;
        
        // ŸÜÿ∏ÿßŸÖ ÿ™ÿ™ÿ®ÿπ ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ
        let userViewHistory = JSON.parse(localStorage.getItem('userViewHistory')) || {};
        
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÜÿ∏ÿßŸÖ ŸÜÿßŸÅÿ∞ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ™ÿßÿ¨ÿ±
        let selectedMerchantId = null;
        let selectedMerchantName = null;
        let filteredModalMerchants = [];
        
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÜÿ∏ÿßŸÖ ŸÜÿßŸÅÿ∞ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ
        let selectedCategoryId = null;
        let selectedCategoryName = null;
        let filteredModalCategories = [];
        
        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÜÿ∏ÿßŸÖ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ
        let currentUserId = null;
        let onlineUsersRef = null;
        let userPresenceRef = null;
        let connectedRef = null;

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÖÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ±
        let galleryImages = [];
        let currentGalleryIndex = 0;
        let isImageZoomed = false;

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿä
        let recognition = null;
        let isListening = false;

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑŸÜÿµŸäÿ©
        let advertisementTexts = [];
        let currentAdIndex = 0;
        let adInterval = null;
        let currentAnimation = null;

        // ŸÜÿ∏ÿßŸÖ ÿßŸÑÿπÿØÿßÿØ ÿßŸÑÿπÿ¥Ÿàÿßÿ¶Ÿä ŸÑŸÑŸÖÿ™ÿµŸÑŸäŸÜ ŸàÿßŸÑŸÖÿ¥ÿßŸáÿØÿßÿ™
        let onlineUsersCount = 0;
        let onlineUsersInterval = null;
        let onlineUsersDirection = 1;
        let consecutiveChanges = 0;
        
        let autoViewInterval = null;
        
        // ŸÜÿ∏ÿßŸÖ ÿ™ÿ™ÿ®ÿπ ÿßŸÑÿ•ÿ¨ÿ±ÿßÿ°ÿßÿ™ ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜ
        let userActions = JSON.parse(localStorage.getItem('userActions')) || {
            likes: {},
            views: {},
            comments: {}
        };

        // ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿπÿ¨ÿßÿ®ÿßÿ™ ŸàÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ©
        let autoLikeInterval = null;
        let autoCommentInterval = null;
        let commentTexts = [
            "ŸÖŸÜÿ™ÿ¨ ÿ±ÿßÿ¶ÿπ! ÿ£ŸÜÿµÿ≠ ÿ®Ÿá ÿ®ÿ¥ÿØÿ©",
            "ÿ¨ŸàÿØÿ© ŸÖŸÖÿ™ÿßÿ≤ÿ© Ÿàÿ≥ÿπÿ± ŸÖŸÜÿßÿ≥ÿ®",
            "ÿßÿ¥ÿ™ÿ±Ÿäÿ™ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸàŸÉÿßŸÜ ÿ™ÿ¨ÿ±ÿ®ÿ© ÿ±ÿßÿ¶ÿπÿ©",
            "ÿ£ŸÜÿµÿ≠ ÿßŸÑÿ¨ŸÖŸäÿπ ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨",
            "ÿ≥ÿπÿ± ŸÖÿπŸÇŸàŸÑ Ÿàÿ¨ŸàÿØÿ© ŸÖŸÖÿ™ÿßÿ≤ÿ©",
            "ŸÖŸÜÿ™ÿ¨ Ÿäÿ≥ÿ™ÿ≠ŸÇ ÿßŸÑÿ™ÿ¨ÿ±ÿ®ÿ©",
            " ÿ¥ÿ®ÿßÿ® ŸÖŸÜ ÿµŸÑŸâ ÿπŸÑŸâ ÿßŸÑŸÜÿ®Ÿä ÿßŸÑŸäŸàŸÖ",
            "ÿ™ÿ¨ÿ±ÿ®ÿ© ÿ¥ÿ±ÿßÿ° ŸÜÿßÿ¨ÿ≠ÿ© ŸàŸÖŸÖÿ™ÿßÿ≤ÿ©",
            "ÿ£ŸÜÿµÿ≠ ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÑŸÉŸÑ ÿßŸÑÿ£ÿµÿØŸÇÿßÿ°",
            "ÿ¨ŸàÿØÿ© ÿ™ŸÅŸàŸÇ ÿßŸÑÿ™ŸàŸÇÿπÿßÿ™",
            "ÿ≥ÿπÿ± ŸÖŸÜÿßÿ≥ÿ® Ÿàÿ¨ŸàÿØÿ© ÿπÿßŸÑŸäÿ©",
            "ŸÖŸÜÿ™ÿ¨ ŸÖŸÖŸäÿ≤ Ÿàÿ£ŸÜÿµÿ≠ ÿ®Ÿá",
            "  ÿ¨ŸÖŸäŸÑ ŸÑŸÇÿØ ÿßÿπÿ¨ÿ®ŸÜŸä",
            "ÿ™ÿ¨ÿ±ÿ®ÿ© ÿ¥ÿ±ÿßÿ° ÿ±ÿßÿ¶ÿπÿ©",
            "ŸÖŸÜÿ™ÿ¨ Ÿäÿ≥ÿ™ÿ≠ŸÇ ŸÉŸÑ ÿ±ŸäÿßŸÑ",
            "ÿ¨ŸàÿØÿ© Ÿàÿ≥ÿπÿ± ŸÑÿß ŸäÿµÿØŸÇ",
            "ÿ£ŸÜÿµÿ≠ ÿ®Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ®ÿ¥ÿØÿ©",
            "ÿ™ÿ¨ÿßŸàÿ≤ ÿ™ŸàŸÇÿπÿßÿ™Ÿä ÿ®ŸÉÿ´Ÿäÿ±",
            "ŸÖŸÜÿ™ÿ¨ ÿ±ÿßÿ¶ÿπ ŸàŸÖŸÖŸäÿ≤"
        ];

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        let lastCheckTime = new Date();
        let openedProducts = [];
        let favoriteMerchantsCheckInterval = null;
        let newProductsModal = null;

        // ŸÖÿ™ÿ∫Ÿäÿ±ÿßÿ™ ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿßÿ™ ÿßŸÑŸÖÿ∂ÿßŸÅÿ©
        let productCards = {};
        let currentCategoryFilter = '';

        // ÿπŸÜÿßÿµÿ± ÿßŸÑŸàÿßÿ¨Ÿáÿ©
        const productsContainer = document.getElementById('products-container');
        const governorateSelect = document.getElementById('governorate');
        const regionSelect = document.getElementById('region');
        const categoryTextInput = document.getElementById('category-text-input');
        const searchInput = document.getElementById('search');
        const resetButton = document.getElementById('reset-filters');
        const sortSelect = document.getElementById('sort-by');
        const filterBar = document.getElementById('filter-bar');
        const scrollToTopBtn = document.getElementById('scroll-to-top');
        const filterControlBtn = document.getElementById('filter-control');
        const categoryValueDisplay = document.getElementById('category-value-display');
        const usersCountEl = document.getElementById('users-count');
        const headerUsersCountEl = document.getElementById('header-users-count');
        const realOnlineUsersEl = document.getElementById('real-online-users');
        const voiceSearchBtn = document.getElementById('voice-search-btn');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingProgressBar = document.getElementById('loading-progress-bar');
        const footerTextEl = document.getElementById('footer-text');

        // ÿπŸÜÿßÿµÿ± ŸÜÿßŸÅÿ∞ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ™ÿßÿ¨ÿ±
        const merchantModalOverlay = document.getElementById('merchant-modal-overlay');
        const merchantTextInput = document.getElementById('merchant-text-input');
        const merchantModalSearchInput = document.getElementById('merchant-modal-search-input');
        const merchantsModalList = document.getElementById('merchants-modal-list');
        const merchantModalCancel = document.getElementById('merchant-modal-cancel');
        const merchantModalConfirm = document.getElementById('merchant-modal-confirm');

        // ÿπŸÜÿßÿµÿ± ŸÜÿßŸÅÿ∞ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ
        const categoryModalOverlay = document.getElementById('category-modal-overlay');
        const secondaryCategoryTextInput = document.getElementById('secondary-category-text-input');
        const categoryModalSearchInput = document.getElementById('category-modal-search-input');
        const categoriesModalList = document.getElementById('categories-modal-list');
        const categoryModalCancel = document.getElementById('category-modal-cancel');
        const categoryModalConfirm = document.getElementById('category-modal-confirm');

        // ÿπŸÜÿßÿµÿ± ÿßŸÑÿ¥ÿ±Ÿäÿ∑ ÿßŸÑÿ¨ÿØŸäÿØ
        const productsCountEl = document.getElementById('products-count');
        const showMoreBtn = document.getElementById('show-more-btn');
        const secondaryFavoritesBtn = document.getElementById('secondary-favorites');

        // ÿπŸÜÿßÿµÿ± ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©
        const shareModal = document.getElementById('share-modal');
        const shareModalClose = document.getElementById('share-modal-close');
        const shareOptions = document.querySelectorAll('.share-option');

        // ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ŸÜŸÇŸÑ ŸàÿßŸÑÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ≥ÿßÿ®ŸÇÿ©
        let isBackButtonPressed = false;

        // ==========================================
        // üéØ ÿ®ÿØÿ° ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ - ÿßŸÑÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑÿµÿ≠Ÿäÿ≠
        // ==========================================
        document.addEventListener('DOMContentLoaded', () => {
            console.log('üèÅ ÿ®ÿØÿ° ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ...');
            
            // 1. ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ŸÜŸÇŸÑ ÿ£ŸàŸÑÿßŸã
            initializeNavigationManager();
            
            // 2. ÿ™ŸáŸäÿ¶ÿ© ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ±
            initializeStableUserId();
            
            // 3. ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
            initializeBrowserNotifications();
            
            // 4. ÿ®ÿØÿ° ŸÜÿ∏ÿßŸÖ ÿßŸÑÿπÿØÿßÿØ ÿßŸÑÿπÿ¥Ÿàÿßÿ¶Ÿä ŸÑŸÑŸÖÿ™ÿµŸÑŸäŸÜ
            startRandomOnlineUsers();
            
            // 5. ÿ®ÿØÿ° ŸÜÿ∏ÿßŸÖ ÿ≤ŸäÿßÿØÿ© ÿßŸÑŸÖÿ¥ÿßŸáÿØÿßÿ™ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
            startAutoViewIncrement();
            
            // 6. ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ
            initializeUserPresence();
            
            // 7. ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿä
            initializeSpeechRecognition();
            
            // 8. ÿ™ŸáŸäÿ¶ÿ© ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ
            initializeApp();
            
            // 9. ÿ•ÿπÿØÿßÿØ ŸÖÿ≥ÿ™ŸÖÿπŸä ÿßŸÑÿ£ÿ≠ÿØÿßÿ´
            setupEventListeners();
            
            // 10. ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™
            loadAllData().then(() => {
                checkUrlForProduct();
                displayPersonalizedProducts();
                console.log('üéâ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿ∑ÿ®ŸäŸÇ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
            }).catch(error => {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:', error);
            });
            
            // 11. ÿ®ÿØÿ° ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ÿ™ŸÑŸÇÿßÿ¶ŸäÿßŸã
            startAutoUpdate();
            
            // 12. ÿ™ÿ≠ŸÖŸäŸÑ Ÿàÿπÿ±ÿ∂ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑŸÜÿµŸäÿ©
            loadAdvertisementTexts();
            
            // 13. ÿ®ÿØÿ° ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿπÿ¨ÿßÿ®ÿßÿ™ ŸàÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ©
            startAutoInteractions();
            
            // 14. ÿ®ÿØÿ° ŸÜÿ∏ÿßŸÖ ŸÅÿ≠ÿµ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿ™ÿ¨ÿßÿ± ÿßŸÑŸÖŸÅÿ∂ŸÑŸäŸÜ
            startFavoriteMerchantsCheck();
            
            // 15. ÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÖŸàŸÇÿπ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ± ÿ•ÿ∞ÿß ŸÉÿßŸÜ ŸÖÿ≠ŸÅŸàÿ∏ÿßŸã
            restoreScrollPosition();
            
            // 16. ÿ•ÿ∂ÿßŸÅÿ© ŸÖÿ≥ÿ™ŸÖÿπ ÿ≠ÿØÿ´ ŸÑÿ•ÿÆŸÅÿßÿ° ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÅŸÑÿßÿ™ÿ± ÿπŸÜÿØ ÿßŸÑŸÜŸÇÿ± ÿÆÿßÿ±ÿ¨Ÿáÿß
            setupFilterBarAutoHide();
        });

        // ==========================================
        // üîÑ ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ŸÜŸÇŸÑ ŸàÿßŸÑÿ±ÿ¨Ÿàÿπ ŸÑŸÑÿµŸÅÿ≠ÿ© ÿßŸÑÿ±ÿ¶Ÿäÿ≥Ÿäÿ©
        // ==========================================
        function initializeNavigationManager() {
            console.log('üöÄ ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ŸÜŸÇŸÑ...');
            
            window.addEventListener('popstate', function(event) {
                console.log('üîô ÿ™ŸÖ ÿßŸÑÿ∂ÿ∫ÿ∑ ÿπŸÑŸâ ÿ≤ÿ± ÿßŸÑÿ±ÿ¨Ÿàÿπ - ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿµŸÅÿ≠ÿ© ŸàŸÅÿ™ÿ≠ index.html');
                
                if (!isBackButtonPressed) {
                    isBackButtonPressed = true;
                    
                    cleanupAllIntervals();
                    closeAllModals();
                    
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 300);
                }
            });

            history.pushState({ page: 'az-marketplace' }, '', window.location.href);
            
            console.log('‚úÖ ÿ™ŸÖ ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿ™ŸÜŸÇŸÑ ÿ®ŸÜÿ¨ÿßÿ≠');
        }

        // ==========================================
        // üßπ ÿ™ŸÜÿ∏ŸäŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿµŸÑ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©
        // ==========================================
        function cleanupAllIntervals() {
            console.log('üßπ ÿ¨ÿßÿ±Ÿä ÿ™ŸÜÿ∏ŸäŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿµŸÑ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©...');
            
            if (onlineUsersInterval) {
                clearInterval(onlineUsersInterval);
                onlineUsersInterval = null;
            }
            
            if (autoViewInterval) {
                clearInterval(autoViewInterval);
                autoViewInterval = null;
            }
            
            if (autoLikeInterval) {
                clearInterval(autoLikeInterval);
                autoLikeInterval = null;
            }
            
            if (autoCommentInterval) {
                clearInterval(autoCommentInterval);
                autoCommentInterval = null;
            }
            
            if (favoriteMerchantsCheckInterval) {
                clearInterval(favoriteMerchantsCheckInterval);
                favoriteMerchantsCheckInterval = null;
            }
            
            if (adInterval) {
                clearInterval(adInterval);
                adInterval = null;
            }
            
            if (notificationInterval) {
                clearInterval(notificationInterval);
                notificationInterval = null;
            }
            
            console.log('‚úÖ ÿ™ŸÖ ÿ™ŸÜÿ∏ŸäŸÅ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸàÿßÿµŸÑ ÿßŸÑÿ≤ŸÖŸÜŸäÿ©');
        }

        // ==========================================
        // ü™ü ÿ•ÿ∫ŸÑÿßŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©
        // ==========================================
        function closeAllModals() {
            console.log('ü™ü ÿ¨ÿßÿ±Ÿä ÿ•ÿ∫ŸÑÿßŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©...');
            
            const gallery = document.getElementById('image-gallery');
            if (gallery.classList.contains('active')) {
                closeImageGallery();
            }
            
            const shareModal = document.getElementById('share-modal');
            if (shareModal.classList.contains('active')) {
                closeShareModal();
            }
            
            const newProductsModal = document.getElementById('new-products-modal');
            if (newProductsModal.classList.contains('active')) {
                closeNewProductsModal();
            }
            
            const merchantModal = document.getElementById('merchant-modal-overlay');
            if (merchantModal.classList.contains('active')) {
                closeMerchantModal();
            }
            
            const categoryModal = document.getElementById('category-modal-overlay');
            if (categoryModal.classList.contains('active')) {
                closeCategoryModal();
            }
            
            closeAllComments();
            
            if (filterBar.style.display === 'flex') {
                hideFilterBar();
            }
            
            console.log('‚úÖ ÿ™ŸÖ ÿ•ÿ∫ŸÑÿßŸÇ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÜŸàÿßŸÅÿ∞ ÿßŸÑŸÖŸÅÿ™Ÿàÿ≠ÿ©');
        }

        // ==========================================
        // üîî ŸÜÿ∏ÿßŸÖ ŸÅÿ≠ÿµ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ© ŸÑŸÑÿ™ÿ¨ÿßÿ± ÿßŸÑŸÖŸÅÿ∂ŸÑŸäŸÜ
        // ==========================================
        function startFavoriteMerchantsCheck() {
            favoriteMerchantsCheckInterval = setInterval(() => {
                checkNewProductsFromFavoriteMerchants();
            }, 7000);
        }

        function checkNewProductsFromFavoriteMerchants() {
            if (Object.keys(favoriteProducts).length === 0) return;
            
            const favoriteMerchantIds = [...new Set(
                Object.keys(favoriteProducts)
                    .map(productId => allProducts.find(p => p.id === productId)?.userId)
                    .filter(Boolean)
            )];
            
            if (favoriteMerchantIds.length === 0) return;
            
            const newProducts = allProducts.filter(product => {
                const productDate = new Date(product.publishDate || product.createdAt || product.date || 0);
                if (productDate <= lastCheckTime) return false;
                
                if (!favoriteMerchantIds.includes(product.userId)) return false;
                
                if (openedProducts.includes(product.id)) return false;
                
                return true;
            });
            
            const productsByMerchant = {};
            newProducts.forEach(product => {
                if (!productsByMerchant[product.userId]) {
                    productsByMerchant[product.userId] = [];
                }
                productsByMerchant[product.userId].push(product);
            });
            
            if (Object.keys(productsByMerchant).length > 0) {
                showNewProductsModal(productsByMerchant);
            }
            
            lastCheckTime = new Date();
        }

        // ==========================================
        // üîî ÿπÿ±ÿ∂ ŸÜÿßŸÅÿ∞ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        // ==========================================
        function showNewProductsModal(productsByMerchant) {
            const modal = document.getElementById('new-products-modal');
            const list = document.getElementById('new-products-list');
            
            list.innerHTML = '';
            
            Object.keys(productsByMerchant).forEach(merchantId => {
                const merchant = allMerchants.find(m => m.id === merchantId);
                const merchantName = merchant ? (merchant.name || merchant.username) : 'ÿ™ÿßÿ¨ÿ±';
                const count = productsByMerchant[merchantId].length;
                
                const item = document.createElement('div');
                item.className = 'new-product-item';
                item.innerHTML = `
                    <div class="merchant-name">
                        <i class="fas fa-store"></i>
                        ${merchantName}
                        <span class="products-count-badge">${count} ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ</span>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    localStorage.setItem('selectedMerchantName', merchantName);
                    localStorage.setItem('selectedMerchantId', merchantId);
                    closeNewProductsModal();
                    saveScrollPosition();
                    window.location.href = 'ard_tagr.html';
                });
                
                list.appendChild(item);
            });
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeNewProductsModal() {
            const modal = document.getElementById('new-products-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // ==========================================
        // üìç ÿ≠ŸÅÿ∏ Ÿàÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÖŸàŸÇÿπ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ±
        // ==========================================
        function saveScrollPosition() {
            localStorage.setItem('scrollPosition', window.pageYOffset);
            console.log('üìç ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖŸàŸÇÿπ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ±:', window.pageYOffset);
        }

        function restoreScrollPosition() {
            const savedPosition = localStorage.getItem('scrollPosition');
            if (savedPosition) {
                setTimeout(() => {
                    window.scrollTo(0, parseInt(savedPosition));
                    console.log('üìç ÿ™ŸÖ ÿßÿ≥ÿ™ÿπÿßÿØÿ© ŸÖŸàŸÇÿπ ÿßŸÑÿ™ŸÖÿ±Ÿäÿ±:', savedPosition);
                    localStorage.removeItem('scrollPosition');
                }, 500);
            }
        }

        // ==========================================
        // üéØ Ÿàÿ∏ŸäŸÅÿ© ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿµÿ≠ÿ© ÿßŸÑÿπÿ±ÿ∂
        // ==========================================
        function isOfferValid(product) {
            if (!product.productType || product.productType !== 'ÿπÿ±ÿ∂') {
                return false;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (product.endDate) {
                const endDate = new Date(product.endDate);
                endDate.setHours(0, 0, 0, 0);
                if (today > endDate) {
                    return false;
                }
            }
            
            if (product.startDate) {
                const startDate = new Date(product.startDate);
                startDate.setHours(0, 0, 0, 0);
                if (today < startDate) {
                    return false;
                }
            }
            
            return true;
        }

        // ==========================================
        // ‚ù§Ô∏è ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿπÿ¨ÿßÿ®ÿßÿ™ ŸàÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿäÿ©
        // ==========================================
        function startAutoInteractions() {
            autoLikeInterval = setInterval(() => {
                autoLikeRandomProduct();
            }, 8000);
            
            autoCommentInterval = setInterval(() => {
                autoCommentRandomProduct();
            }, 1200000);
        }

        function autoLikeRandomProduct() {
            if (allProducts.length === 0) return;
            
            const sortedProducts = [...allProducts].sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                return bDate - aDate;
            });
            
            let product;
            if (Math.random() < 0.7 && sortedProducts.length > 0) {
                const recentCount = Math.min(10, sortedProducts.length);
                const randomIndex = getRandomInt(0, recentCount - 1);
                product = sortedProducts[randomIndex];
            } else if (sortedProducts.length > 10) {
                const oldProducts = sortedProducts.slice(10);
                const randomIndex = getRandomInt(0, oldProducts.length - 1);
                product = oldProducts[randomIndex];
            } else {
                return;
            }
            
            if (!product || !product.id) return;
            
            addAutoLike(product.id);
        }

        async function addAutoLike(productId) {
            try {
                const likesRef = db.ref(`products_stats/${productId}/likes`);
                const snapshot = await likesRef.once('value');
                let likes = snapshot.val() || [];
                if (!Array.isArray(likes)) likes = [];
                
                const randomUserId = 'auto_user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 6);
                
                if (!likes.includes(randomUserId)) {
                    likes.push(randomUserId);
                    await likesRef.set(likes);
                    
                    const likeStatEl = document.getElementById(`like-stat-${productId}`);
                    if (likeStatEl) {
                        likeStatEl.textContent = likes.length;
                    }
                    
                    console.log(`‚ù§Ô∏è ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ•ÿπÿ¨ÿßÿ® ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑŸÖŸÜÿ™ÿ¨ ${productId}`);
                }
            } catch (e) { 
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ•ÿπÿ¨ÿßÿ® ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä:', e); 
            }
        }

        function autoCommentRandomProduct() {
            if (allProducts.length === 0) return;
            
            const sortedProducts = [...allProducts].sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                return bDate - aDate;
            });
            
            let product;
            if (Math.random() < 0.8 && sortedProducts.length > 0) {
                const recentCount = Math.min(5, sortedProducts.length);
                const randomIndex = getRandomInt(0, recentCount - 1);
                product = sortedProducts[randomIndex];
            } else if (sortedProducts.length > 5) {
                const oldProducts = sortedProducts.slice(5);
                const randomIndex = getRandomInt(0, oldProducts.length - 1);
                product = oldProducts[randomIndex];
            } else {
                return;
            }
            
            if (!product || !product.id) return;
            
            addAutoComment(product.id, product.name);
        }

        async function addAutoComment(productId, productName) {
            try {
                const randomCommentIndex = getRandomInt(0, commentTexts.length - 1);
                let commentText = commentTexts[randomCommentIndex];
                
                if (productName && productName.trim() !== '') {
                    if (Math.random() < 0.5) {
                        commentText = commentText.replace("ÿßŸÑŸÖŸÜÿ™ÿ¨", `ŸÖŸÜÿ™ÿ¨ ${productName}`);
                    }
                }
                
                const userNames = ["ŸÖÿ≥ÿ™ÿÆÿØŸÖ", "ŸÖÿ≥ÿ™ÿÆÿØ ÿ¨ÿØŸäÿØ"];
                const randomUserName = userNames[getRandomInt(0, userNames.length - 1)];
                
                const commentId = Date.now().toString();
                const comment = { 
                    text: commentText, 
                    author: randomUserName, 
                    date: new Date().toISOString() 
                };
                
                await db.ref(`comments/${productId}/${commentId}`).set(comment);
                
                const commentStatEl = document.getElementById(`comment-stat-${productId}`);
                if (commentStatEl) {
                    commentStatEl.textContent = (parseInt(commentStatEl.textContent) || 0) + 1;
                }
                
                const commentsCountEl = document.querySelector(`#comments-${productId} .comments-count`);
                if (commentsCountEl) {
                    commentsCountEl.textContent = (parseInt(commentsCountEl.textContent) || 0) + 1;
                }
                
                console.log(`üí¨ ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿ™ÿπŸÑŸäŸÇ ÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑŸÖŸÜÿ™ÿ¨ ${productId}: ${commentText}`);
            } catch (e) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÇ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä:', e);
            }
        }

        // ==========================================
        // üîÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿπÿØÿßÿØ ÿßŸÑÿπÿ¥Ÿàÿßÿ¶Ÿä ŸÑŸÑŸÖÿ™ÿµŸÑŸäŸÜ
        // ==========================================
        function startRandomOnlineUsers() {
            const savedCount = localStorage.getItem('randomOnlineUsersCount');
            onlineUsersCount = savedCount ? parseInt(savedCount) : getOnlineUsersByTime();
            
            updateOnlineUsersCount(onlineUsersCount);
            
            onlineUsersInterval = setInterval(() => {
                updateRandomOnlineUsers();
            }, 10000);
        }

        function getOnlineUsersByTime() {
            const now = new Date();
            const hour = now.getHours();
            
            if (hour >= 5 && hour < 12) {
                return getRandomInt(50, 300);
            } else if (hour >= 12 && hour < 18) {
                return getRandomInt(100, 600);
            } else if (hour >= 18 && hour < 22) {
                return getRandomInt(200, 800);
            } else {
                return getRandomInt(50, 300);
            }
        }

        function updateRandomOnlineUsers() {
            const oldCount = onlineUsersCount;
            
            if (consecutiveChanges >= getRandomInt(5, 7)) {
                onlineUsersDirection = -1;
                consecutiveChanges = 0;
            } else if (consecutiveChanges <= -getRandomInt(3, 5)) {
                onlineUsersDirection = 1;
                consecutiveChanges = 0;
            }
            
            const changeAmount = getRandomInt(1, 8) * onlineUsersDirection;
            
            let newCount = onlineUsersCount + changeAmount;
            const currentTimeRange = getOnlineUsersRangeByTime();
            newCount = Math.max(currentTimeRange.min, Math.min(currentTimeRange.max, newCount));
            
            onlineUsersCount = newCount;
            consecutiveChanges += onlineUsersDirection;
            
            localStorage.setItem('randomOnlineUsersCount', onlineUsersCount.toString());
            
            updateOnlineUsersCount(onlineUsersCount, oldCount);
        }

        function getOnlineUsersRangeByTime() {
            const now = new Date();
            const hour = now.getHours();
            
            if (hour >= 5 && hour < 12) {
                return { min: 50, max: 300 };
            } else if (hour >= 12 && hour < 18) {
                return { min: 100, max: 600 };
            } else if (hour >= 18 && hour < 22) {
                return { min: 200, max: 800 };
            } else {
                return { min: 50, max: 300 };
            }
        }

        function updateOnlineUsersCount(newCount, oldCount = null) {
            const onlineUsersEl = document.getElementById('header-online-users');
            
            if (oldCount !== null) {
                if (newCount > oldCount) {
                    onlineUsersEl.classList.add('increase');
                    setTimeout(() => onlineUsersEl.classList.remove('increase'), 1000);
                } else if (newCount < oldCount) {
                    onlineUsersEl.classList.add('decrease');
                    setTimeout(() => onlineUsersEl.classList.remove('decrease'), 1000);
                }
            }
            
            usersCountEl.textContent = newCount;
            headerUsersCountEl.textContent = newCount;
        }

        // ==========================================
        // üîÑ ŸÜÿ∏ÿßŸÖ ÿ≤ŸäÿßÿØÿ© ÿßŸÑŸÖÿ¥ÿßŸáÿØÿßÿ™ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä
        // ==========================================
        function startAutoViewIncrement() {
            autoViewInterval = setInterval(() => {
                incrementProductViews();
            }, 3000);
        }

        function incrementProductViews() {
            if (allProducts.length === 0) return;
            
            const sortedProducts = [...allProducts].sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                return bDate - aDate;
            });
            
            const recentProducts = sortedProducts.slice(0, Math.min(10, sortedProducts.length));
            const otherProducts = sortedProducts.slice(10);
            
            let product;
            if (Math.random() < 0.7 && recentProducts.length > 0) {
                const randomIndex = getRandomInt(0, recentProducts.length - 1);
                product = recentProducts[randomIndex];
            } else if (otherProducts.length > 0) {
                const randomIndex = getRandomInt(0, otherProducts.length - 1);
                product = otherProducts[randomIndex];
            } else {
                return;
            }
            
            if (!product || !product.id) return;
            
            const productId = product.id;
            const viewStatEl = document.getElementById(`view-stat-${productId}`);
            
            if (viewStatEl) {
                const increment = getRandomInt(1, 3);
                const currentViews = parseInt(viewStatEl.textContent) || 150;
                const newViews = currentViews + increment;
                viewStatEl.textContent = newViews;
                
                db.ref(`products_stats/${productId}/views`).transaction(current => (current || 0) + increment);
                
                console.log(`üîÑ ÿ™ŸÖ ÿ≤ŸäÿßÿØÿ© ŸÖÿ¥ÿßŸáÿØÿßÿ™ ÿßŸÑŸÖŸÜÿ™ÿ¨ ${productId} ÿ•ŸÑŸâ ${newViews}`);
            }
        }

        // ==========================================
        // üîß ŸÜÿ∏ÿßŸÖ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ±
        // ==========================================
        function initializeStableUserId() {
            let userId = localStorage.getItem('stableUserId');
            
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('stableUserId', userId);
                console.log('üÜî ÿ™ŸÖ ÿ•ŸÜÿ¥ÿßÿ° ŸÖÿπÿ±ŸÅ ŸÖÿ≥ÿ™ŸÇÿ± ÿ¨ÿØŸäÿØ ŸÑŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', userId);
            } else {
                console.log('üÜî ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑŸÖÿ≥ÿ™ŸÇÿ±:', userId);
            }
            
            currentUserId = userId;
            return userId;
        }

        // ==========================================
        // üë• ŸÜÿ∏ÿßŸÖ ÿ™ÿ™ÿ®ÿπ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ
        // ==========================================
        function initializeUserPresence() {
            console.log('üÜî ŸÖÿπÿ±ŸÅ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ÿßŸÑÿ≠ÿßŸÑŸä:', currentUserId);
            
            userPresenceRef = db.ref('online_users/' + currentUserId);
            onlineUsersRef = db.ref('online_users');
            connectedRef = db.ref('.info/connected');
            
            const userVisitData = {
                userId: currentUserId,
                entryTime: new Date().toISOString(),
                userAgent: navigator.userAgent,
                screenResolution: `${screen.width}x${screen.height}`
            };
            
            db.ref('user_visits/' + currentUserId).set(userVisitData);
            
            connectedRef.on('value', function(snap) {
                if (snap.val() === true) {
                    userPresenceRef.onDisconnect().remove();
                    userPresenceRef.set({
                        id: currentUserId,
                        name: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ ' + currentUserId.substring(0, 6),
                        lastOnline: firebase.database.ServerValue.TIMESTAMP,
                        joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        visitStart: new Date().toISOString()
                    });
                    
                    console.log('‚úÖ ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ÿØÿÆŸàŸÑ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ:', currentUserId);
                } else {
                    const exitTime = new Date().toISOString();
                    db.ref('user_visits/' + currentUserId).update({
                        exitTime: exitTime,
                        duration: Math.floor((new Date(exitTime) - new Date(userVisitData.entryTime)) / 1000)
                    });
                }
            });

            onlineUsersRef.on('value', (snapshot) => {
                const onlineUsers = snapshot.val();
                const realOnlineCount = onlineUsers ? Object.keys(onlineUsers).length : 0;
                document.getElementById('real-online-users').textContent = realOnlineCount;
                console.log('üë• ÿπÿØÿØ ÿßŸÑŸÖÿ™ÿµŸÑŸäŸÜ ÿßŸÑÿ≠ŸÇŸäŸÇŸä:', realOnlineCount);
            });
        }

        // ==========================================
        // üîç ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑŸÖÿ≠ÿ≥ŸÜ ŸÖÿπ ŸÖÿ±ÿßÿπÿßÿ© ÿßŸÑÿ£ÿ≠ÿ±ŸÅ ÿßŸÑŸÖÿ™ÿ¥ÿßÿ®Ÿáÿ©
        // ==========================================
        function normalizeText(text) {
            if (!text) return '';
            
            return text
                .replace(/[ÿ£ÿ•ÿ¢Ÿ±]/g, 'ÿß')
                .replace(/[ÿ©]/g, 'Ÿá')
                .replace(/[Ÿâ]/g, 'Ÿä')
                .replace(/[ÿ¶ÿ§]/g, 'ÿ°')
                .replace(/[ÔªªÔª∑ÔªµÔªπ]/g, 'ŸÑÿß')
                .replace(/[Ôªô]/g, 'ŸÉ')
                .replace(/[Ôª´]/g, 'Ÿá')
                .replace(/[ÔªØÔª±]/g, 'Ÿä')
                .toLowerCase();
        }

        // ==========================================
        // üìä ÿ≠ŸÅÿ∏ ŸÖÿµÿ∑ŸÑÿ≠ÿßÿ™ ÿßŸÑÿ®ÿ≠ÿ´ ÿ∫Ÿäÿ± ÿßŸÑŸÖŸàÿ¨ŸàÿØÿ©
        // ==========================================
        function saveSearchTermToAsnaf(term) {
            if (!term || term.trim().length === 0) return;
            
            const termExists = allProducts.some(product => {
                const productName = normalizeText(product.name || '');
                const productDesc = normalizeText(product.description || '');
                const searchTerm = normalizeText(term);
                
                return productName.includes(searchTerm) || productDesc.includes(searchTerm);
            });
            
            if (!termExists) {
                const searchData = {
                    term: term,
                    timestamp: new Date().toISOString(),
                    userId: currentUserId
                };
                
                db.ref('asnaf_slect/' + Date.now()).set(searchData)
                    .then(() => {
                        console.log('‚úÖ ÿ™ŸÖ ÿ≠ŸÅÿ∏ ŸÖÿµÿ∑ŸÑÿ≠ ÿßŸÑÿ®ÿ≠ÿ´ ŸÅŸä asnaf_slect:', term);
                    })
                    .catch(error => {
                        console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ≠ŸÅÿ∏ ŸÖÿµÿ∑ŸÑÿ≠ ÿßŸÑÿ®ÿ≠ÿ´:', error);
                    });
            }
        }

        // ==========================================
        // üì¢ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑŸÜÿµŸäÿ©
        // ==========================================
        async function loadAdvertisementTexts() {
            try {
                const adsSnapshot = await db.ref('ÿßÿπŸÑÿßŸÜÿßÿ™ ŸÜÿµŸäŸá').once('value');
                const adsData = adsSnapshot.val();
                
                advertisementTexts = [];
                
                if (adsData) {
                    console.log('üîç ÿ¨ÿßÿ±Ÿä ŸÅÿ≠ÿµ ÿ≠ŸÇŸàŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™:', Object.keys(adsData));
                    
                    const allFields = Object.keys(adsData);
                    
                    allFields.forEach(fieldName => {
                        const adText = adsData[fieldName];
                        
                        if (adText && typeof adText === 'string' && adText.trim().length > 0) {
                            advertisementTexts.push(adText.trim());
                            console.log(`‚úÖ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜ ${fieldName}: ${adText.trim()}`);
                        }
                    });
                    
                    console.log('üì¢ ÿ™ŸÖ ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑŸÜÿµŸäÿ©:', advertisementTexts.length, 'ÿ•ÿπŸÑÿßŸÜ');
                    
                    if (advertisementTexts.length > 0) {
                        startAdvertisementRotation();
                    } else {
                        footerTextEl.textContent = 'ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑÿØŸâ ÿßŸÑŸÖŸÖŸäÿ≤ ÿ≥ŸàŸÅÿ™ ŸÑŸÑÿ£ŸÜÿ∏ŸÖÿ© ÿßŸÑŸÖÿ≠ÿßÿ≥ÿ®Ÿäÿ© ÿßŸÑŸÖÿ™ŸÉÿßŸÖŸÑÿ©';
                        console.log('‚ö†Ô∏è ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸÜÿµŸäÿ© ÿµÿßŸÑÿ≠ÿ©');
                    }
                } else {
                    console.log('‚ö†Ô∏è ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ®ŸäÿßŸÜÿßÿ™ ÿ•ÿπŸÑÿßŸÜÿßÿ™ ŸÅŸä ŸÇÿßÿπÿØÿ© ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™');
                    footerTextEl.textContent = 'ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑÿØŸâ ÿßŸÑŸÖŸÖŸäÿ≤ ÿ≥ŸàŸÅÿ™ ŸÑŸÑÿ£ŸÜÿ∏ŸÖÿ© ÿßŸÑŸÖÿ≠ÿßÿ≥ÿ®Ÿäÿ© ÿßŸÑŸÖÿ™ŸÉÿßŸÖŸÑÿ©';
                }
            } catch (error) {
                console.error('‚ùå ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿßŸÑŸÜÿµŸäÿ©:', error);
                footerTextEl.textContent = 'ÿ¨ŸÖŸäÿπ ÿßŸÑÿ≠ŸÇŸàŸÇ ŸÖÿ≠ŸÅŸàÿ∏ÿ© ŸÑÿØŸâ ÿßŸÑŸÖŸÖŸäÿ≤ ÿ≥ŸàŸÅÿ™ ŸÑŸÑÿ£ŸÜÿ∏ŸÖÿ© ÿßŸÑŸÖÿ≠ÿßÿ≥ÿ®Ÿäÿ© ÿßŸÑŸÖÿ™ŸÉÿßŸÖŸÑÿ©';
            }
        }

        function startAdvertisementRotation() {
            if (advertisementTexts.length === 0) return;
            
            currentAdIndex = 0;
            
            showNextAdvertisement();
        }

        function showNextAdvertisement() {
            if (advertisementTexts.length === 0) return;
            
            currentAdIndex = (currentAdIndex + 1) % advertisementTexts.length;
            const currentAd = advertisementTexts[currentAdIndex];
            
            footerTextEl.textContent = currentAd;
            
            const textLength = currentAd.length;
            const baseDuration = 5000;
            const charDuration = 100;
            const totalDuration = baseDuration + (textLength * charDuration);
            
            footerTextEl.style.animation = 'none';
            void footerTextEl.offsetWidth;
            footerTextEl.style.animation = `slideText ${totalDuration}ms linear`;
            
            setTimeout(() => {
                showNextAdvertisement();
            }, totalDuration);
        }

        // ==========================================
        // üé§ ÿ™ŸáŸäÿ¶ÿ© ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿä
        // ==========================================
        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition) {
                console.warn('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿä');
                voiceSearchBtn.style.display = 'none';
                return;
            }
            
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'ar-SA';
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                if (transcript.trim().length > 0) {
                    searchInput.value = transcript;
                    filterProducts();
                    showNotification('ÿ™ŸÖ ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑŸÉŸÑÿßŸÖ ÿ•ŸÑŸâ ŸÜÿµ: ' + transcript, 'success');
                } else {
                    speakText('ÿπŸÅŸàÿß ÿßŸÑÿµŸàÿ™ ÿ∫Ÿäÿ± ŸÖŸÅŸáŸàŸÖ ÿßÿπÿØ ŸÖÿ±Ÿá ÿßÿÆÿ±Ÿâ');
                    showNotification('ÿπŸÅŸàÿß ÿßŸÑÿµŸàÿ™ ÿ∫Ÿäÿ± ŸÖŸÅŸáŸàŸÖ ÿßÿπÿØ ŸÖÿ±Ÿá ÿßÿÆÿ±Ÿâ', 'error');
                }
            };
            
            recognition.onerror = function(event) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿä:', event.error);
                if (event.error === 'not-allowed') {
                    showNotification('Ÿäÿ±ÿ¨Ÿâ ÿßŸÑÿ≥ŸÖÿßÿ≠ ŸÑŸÑŸÖŸàŸÇÿπ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ', 'error');
                } else if (event.error === 'audio-capture') {
                    showNotification('ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ', 'error');
                } else if (event.error === 'no-speech') {
                    speakText('ÿπŸÅŸàÿß ÿßŸÑÿµŸàÿ™ ÿ∫Ÿäÿ± ŸÖŸÅŸáŸàŸÖ ÿßÿπÿØ ŸÖÿ±Ÿá ÿßÿÆÿ±Ÿâ');
                    showNotification('ÿπŸÅŸàÿß ÿßŸÑÿµŸàÿ™ ÿ∫Ÿäÿ± ŸÖŸÅŸáŸàŸÖ ÿßÿπÿØ ŸÖÿ±Ÿá ÿßÿÆÿ±Ÿâ', 'error');
                } else {
                    showNotification('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿäÿå Ÿäÿ±ÿ¨Ÿâ ÿßŸÑŸÖÿ≠ÿßŸàŸÑÿ© ŸÖÿ±ÿ© ÿ£ÿÆÿ±Ÿâ', 'error');
                }
                stopListening();
            };
            
            recognition.onend = function() {
                stopListening();
            };
        }

        // ==========================================
        // üé§ Ÿàÿ∏ŸäŸÅÿ© ÿßŸÑŸÜÿ∑ŸÇ
        // ==========================================
        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA';
                utterance.rate = 1;
                utterance.pitch = 1;
                window.speechSynthesis.speak(utterance);
            }
        }

        // ==========================================
        // üé§ ÿ®ÿØÿ°/ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿä
        // ==========================================
        function toggleVoiceSearch() {
            if (!recognition) {
                showNotification('ÿßŸÑŸÖÿ™ÿµŸÅÿ≠ ŸÑÿß ŸäÿØÿπŸÖ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿä', 'error');
                return;
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                startListening();
            }
        }

        function startListening() {
            try {
                recognition.start();
                isListening = true;
                voiceSearchBtn.classList.add('listening');
                voiceSearchBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                voiceSearchBtn.title = 'ÿ•ŸäŸÇÿßŸÅ ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿä';
                showNotification('ÿ¨ÿßÿ±Ÿä ÿßŸÑÿßÿ≥ÿ™ŸÖÿßÿπ... ÿ™ÿ≠ÿØÿ´ ÿßŸÑÿ¢ŸÜ', 'info');
            } catch (error) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ®ÿØÿ° ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿä:', error);
                showNotification('ÿÆÿ∑ÿ£ ŸÅŸä ÿ®ÿØÿ° ÿßŸÑÿ™ÿπÿ±ŸÅ ÿßŸÑÿµŸàÿ™Ÿä. ÿ™ÿ£ŸÉÿØ ŸÖŸÜ ÿßŸÑÿ≥ŸÖÿßÿ≠ ÿ®ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑŸÖŸäŸÉÿ±ŸàŸÅŸàŸÜ', 'error');
                stopListening();
            }
        }

        function stopListening() {
            isListening = false;
            voiceSearchBtn.classList.remove('listening');
            voiceSearchBtn.innerHTML = '<i class="fas fa-microphone"></i>';
            voiceSearchBtn.title = 'ÿßŸÑÿ®ÿ≠ÿ´ ÿßŸÑÿµŸàÿ™Ÿä';
        }

        function initializeApp() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            
            hideFilterBar();
            
            newProductsModal = document.getElementById('new-products-modal');
            document.getElementById('new-products-close').addEventListener('click', closeNewProductsModal);
            newProductsModal.addEventListener('click', (e) => {
                if (e.target.id === 'new-products-modal') {
                    closeNewProductsModal();
                }
            });
        }

        function setupEventListeners() {
            searchInput.addEventListener('input', filterProducts);
            governorateSelect.addEventListener('change', handleGovernorateChange);
            regionSelect.addEventListener('change', handleRegionChange);
            sortSelect.addEventListener('change', filterProducts);
            resetButton.addEventListener('click', resetFilters);
            filterControlBtn.addEventListener('click', toggleFilterBar);
            
            merchantTextInput.addEventListener('click', openMerchantModal);
            merchantModalSearchInput.addEventListener('input', filterMerchantModalList);
            merchantModalCancel.addEventListener('click', closeMerchantModal);
            merchantModalConfirm.addEventListener('click', applyMerchantFilter);
            
            merchantModalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeMerchantModal();
                }
            });

            categoryTextInput.addEventListener('click', openCategoryModal);
            secondaryCategoryTextInput.addEventListener('click', openCategoryModal);
            categoryModalSearchInput.addEventListener('input', filterCategoryModalList);
            categoryModalCancel.addEventListener('click', closeCategoryModal);
            categoryModalConfirm.addEventListener('click', applyCategoryFilter);
            
            categoryModalOverlay.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeCategoryModal();
                }
            });

            showMoreBtn.addEventListener('click', toggleFilterBar);
            secondaryFavoritesBtn.addEventListener('click', toggleFavoritesView);

            voiceSearchBtn.addEventListener('click', toggleVoiceSearch);

            document.addEventListener('click', (e) => {
                if (isCommentsOpen && !e.target.closest('.comments-section') && 
                    !e.target.closest('.btn-comment') && !e.target.closest('.btn-comment-toggle')) {
                    closeAllComments();
                }
            });

            document.addEventListener('keydown', (e) => {
                const gallery = document.getElementById('image-gallery');
                if (!gallery.classList.contains('active')) return;
                
                switch(e.key) {
                    case 'Escape':
                        closeImageGallery();
                        break;
                    case 'ArrowLeft':
                        navigateGallery(1);
                        break;
                    case 'ArrowRight':
                        navigateGallery(-1);
                        break;
                    case ' ':
                        e.preventDefault();
                        toggleImageZoom();
                        break;
                }
            });

            document.getElementById('gallery-close').addEventListener('click', closeImageGallery);
            document.getElementById('gallery-prev').addEventListener('click', () => navigateGallery(-1));
            document.getElementById('gallery-next').addEventListener('click', () => navigateGallery(1));
            document.getElementById('gallery-zoom').addEventListener('click', toggleImageZoom);

            document.getElementById('image-gallery').addEventListener('click', (e) => {
                if (e.target.id === 'image-gallery') {
                    closeImageGallery();
                }
            });

            const mainImage = document.getElementById('gallery-main-image');
            mainImage.addEventListener('click', toggleImageZoom);

            window.addEventListener('scroll', handleScroll);
            scrollToTopBtn.addEventListener('click', scrollToTop);

            shareModalClose.addEventListener('click', closeShareModal);
            shareOptions.forEach(option => {
                option.addEventListener('click', handleShareOption);
            });
            shareModal.addEventListener('click', (e) => {
                if (e.target.id === 'share-modal') {
                    closeShareModal();
                }
            });

            window.addEventListener('beforeunload', () => {
                cleanupAllIntervals();
            });
        }

        function handleScroll() {
            if (window.pageYOffset > 300) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function toggleFavoritesView() {
            showFavoritesOnly = !showFavoritesOnly;
            
            if (showFavoritesOnly) {
                displayFavoriteProducts();
                showNotification('ÿπÿ±ÿ∂ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ© ŸÅŸÇÿ∑', 'info');
            } else {
                showFavoritesOnly = false;
                filterProducts();
                showNotification('ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™', 'info');
            }
        }

        function checkUrlForProduct() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('productId');
            if (productId) {
                setTimeout(() => {
                    highlightProduct(productId);
                }, 800);
            }
        }

        function highlightProduct(productId) {
            const productCard = document.getElementById(`product-${productId}`);
            if (!productCard) return;
            productCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            productCard.classList.add('highlighted');
            setTimeout(() => productCard.classList.remove('highlighted'), 6000);
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ Firebase
        async function loadAllData() {
            try {
                const cachedData = loadCachedData();
                if (cachedData) {
                    allProducts = cachedData.products;
                    allMerchants = cachedData.merchants;
                    allGovernorates = cachedData.governorates;
                    allRegions = cachedData.regions;
                    allCategories = cachedData.categories;
                    
                    populateFilterOptions();
                    displayProducts(allProducts);
                }
                
                const [productsSnap, merchantsSnap, governoratesSnap, regionsSnap, categoriesSnap] = await Promise.all([
                    db.ref("products").once("value"),
                    db.ref("merchants").once("value"),
                    db.ref("governorates").once("value"),
                    db.ref("regions").once("value"),
                    db.ref("categories").once("value")
                ]);

                allProducts = convertFirebaseData(productsSnap.val()) || [];
                allMerchants = convertFirebaseData(merchantsSnap.val()) || [];
                allGovernorates = convertFirebaseData(governoratesSnap.val()) || [];
                allRegions = convertFirebaseData(regionsSnap.val()) || [];
                allCategories = convertFirebaseData(categoriesSnap.val()) || [];

                saveDataToCache();
                populateFilterOptions();
                displayProducts(allProducts);
                
            } catch (error) {
                console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:", error);
                productsContainer.innerHTML = `
                    <div class="error">
                        <h3>ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™</h3>
                        <p>${error.message || 'ÿ™ÿπÿ∞ÿ± ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ'}</p>
                        <p>Ÿäÿ±ÿ¨ÿßÿ° ÿßŸÑÿ™ÿ≠ŸÇŸÇ ŸÖŸÜ ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ Ÿàÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿµŸÅÿ≠ÿ©</p>
                        <button onclick="location.reload()">ÿ•ÿπÿßÿØÿ© ÿ™ÿ≠ŸÖŸäŸÑ</button>
                    </div>
                `;
            }
        }

        // ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸÖŸÜ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑŸä
        function loadCachedData() {
            try {
                const cachedProducts = localStorage.getItem('cachedProducts');
                const cachedMerchants = localStorage.getItem('cachedMerchants');
                const cachedGovernorates = localStorage.getItem('cachedGovernorates');
                const cachedRegions = localStorage.getItem('cachedRegions');
                const cachedCategories = localStorage.getItem('cachedCategories');
                
                if (cachedProducts && cachedMerchants && cachedGovernorates && cachedRegions && cachedCategories) {
                    return {
                        products: JSON.parse(cachedProducts),
                        merchants: JSON.parse(cachedMerchants),
                        governorates: JSON.parse(cachedGovernorates),
                        regions: JSON.parse(cachedRegions),
                        categories: JSON.parse(cachedCategories)
                    };
                }
            } catch (e) {
                console.warn('ÿ™ÿπÿ∞ÿ± ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿÆÿ≤ŸÜÿ© ŸÖÿ≠ŸÑŸäÿßŸã', e);
            }
            return null;
        }

        function convertFirebaseData(firebaseData) {
            if (!firebaseData) return [];
            try {
                return Object.entries(firebaseData).map(([id, data]) => 
                    data && data.id ? ({ ...data }) : ({ id, ...data }));
            } catch (e) {
                console.error("ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸàŸäŸÑ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™:", e);
                return [];
            }
        }

        function saveDataToCache() {
            try {
                localStorage.setItem('cachedProducts', JSON.stringify(allProducts));
                localStorage.setItem('cachedMerchants', JSON.stringify(allMerchants));
                localStorage.setItem('cachedGovernorates', JSON.stringify(allGovernorates));
                localStorage.setItem('cachedRegions', JSON.stringify(allRegions));
                localStorage.setItem('cachedCategories', JSON.stringify(allCategories));
                localStorage.setItem('lastCacheUpdate', Date.now().toString());
            } catch (e) { 
                console.warn('ÿ™ÿπÿ∞ÿ± ÿ≠ŸÅÿ∏ ÿßŸÑÿ™ÿÆÿ≤ŸäŸÜ ÿßŸÑŸÖÿ≠ŸÑŸä', e); 
            }
        }

        function populateFilterOptions() {
            governorateSelect.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖÿ≠ÿßŸÅÿ∏ÿßÿ™</option>';
            allGovernorates.forEach(g => {
                const opt = document.createElement('option');
                opt.value = g.id || g.name;
                opt.textContent = g.name || g.id;
                governorateSelect.appendChild(opt);
            });

            updateRegionOptions();
            updateModalCategoryList();
        }

        function updateRegionOptions() {
            const selectedGovernorate = governorateSelect.value;
            regionSelect.innerHTML = '<option value="">ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿßÿ∑ŸÇ</option>';

            if (selectedGovernorate) {
                const gov = allGovernorates.find(g => 
                    (g.id === selectedGovernorate) || (g.name === selectedGovernorate));
                if (gov && gov.areas) {
                    Object.entries(gov.areas).forEach(([areaId, areaName]) => {
                        const opt = document.createElement('option');
                        opt.value = areaId;
                        opt.textContent = areaName;
                        regionSelect.appendChild(opt);
                    });
                }
            } else {
                allRegions.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id || r.name;
                    opt.textContent = r.name || r.id;
                    regionSelect.appendChild(opt);
                });
            }
        }

        function updateModalCategoryList() {
            const categoryCounts = {};
            
            allProducts.forEach(product => {
                if (product.categoryId) {
                    const merchant = allMerchants.find(m => m.id === product.userId);
                    if (merchant) {
                        const isActive = merchant.status === "active" || merchant.status === "ŸÜÿ¥ÿ∑";
                        const isMerchant = merchant.job === "ÿ™ÿßÿ¨ÿ±" || merchant.type === "ÿ™ÿßÿ¨ÿ±";
                        
                        if (isActive && isMerchant) {
                            categoryCounts[product.categoryId] = (categoryCounts[product.categoryId] || 0) + 1;
                        }
                    }
                }
            });
            
            filteredModalCategories = [...allCategories].sort((a, b) => {
                const countA = categoryCounts[a.id] || 0;
                const countB = categoryCounts[b.id] || 0;
                return countB - countA;
            });
            
            filteredModalCategories.forEach(category => {
                category.productCount = categoryCounts[category.id] || 0;
            });
            
            console.log('üìä ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ŸÇÿßÿ¶ŸÖÿ© ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ:', filteredModalCategories.length, 'ŸÇÿ≥ŸÖ');
        }

        function handleGovernorateChange() { 
            updateRegionOptions(); 
            filterProducts(); 
        }

        function handleRegionChange() { 
            filterProducts(); 
        }

        function displayProducts(products) {
            if (showFavoritesOnly) {
                displayFavoriteProducts();
                return;
            }
            
            productsContainer.innerHTML = '';
            
            const filteredProducts = products.filter(product => {
                if (product.productType === 'ÿπÿ±ÿ∂' && !isOfferValid(product)) {
                    return false;
                }
                return true;
            });
            
            if (!filteredProducts || filteredProducts.length === 0) {
                productsContainer.innerHTML = `
                    <div class="no-products">
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿ™ÿßÿ≠ÿ© ÿ≠ÿßŸÑŸäÿßŸã</p>
                        <p>ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ•ÿ¨ŸÖÿßŸÑŸäÿ©: ${allProducts.length}</p>
                        <p>ÿßŸÑÿ™ÿ¨ÿßÿ± ÿßŸÑŸÜÿ¥ÿ∑ŸäŸÜ: ${allMerchants.filter(m => (m.status === "active" || m.status === "ŸÜÿ¥ÿ∑") && (m.job === "ÿ™ÿßÿ¨ÿ±" || m.type === "ÿ™ÿßÿ¨ÿ±")).length}</p>
                        <button onclick="resetFilters()" style="margin-top:10px;padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer">ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿßŸÑŸÅŸÑÿßÿ™ÿ±</button>
                    </div>
                `;
                return;
            }

            productsCountEl.textContent = ` ${filteredProducts.length}`;

            const sorted = sortProductsByPriority(filteredProducts);
            const groupedProducts = groupProductsByCategory(sorted);

            displayGroupedProducts(groupedProducts);
        }

        function groupProductsByCategory(products) {
            const groups = {};
            
            products.forEach(p => {
                const merchant = allMerchants.find(m => m.id === p.userId);
                if (!merchant) return;
                
                const isActive = merchant.status === "active" || merchant.status === "ŸÜÿ¥ÿ∑";
                const isMerchant = merchant.job === "ÿ™ÿßÿ¨ÿ±" || merchant.type === "ÿ™ÿßÿ¨ÿ±";
                
                if (!isActive || !isMerchant) return;
                
                const categoryId = p.categoryId || 'ÿ∫Ÿäÿ± ŸÖÿµŸÜŸÅ';
                const categoryName = p.categoryId ? 
                    (allCategories.find(c => c.id === p.categoryId)?.name || 'ÿ∫Ÿäÿ± ŸÖÿµŸÜŸÅ') : 'ÿ∫Ÿäÿ± ŸÖÿµŸÜŸÅ';
                
                if (!groups[categoryId]) {
                    groups[categoryId] = {
                        name: categoryName,
                        products: []
                    };
                }
                
                groups[categoryId].products.push(p);
            });
            
            return groups;
        }

        function displayGroupedProducts(groupedProducts) {
            const grid = document.createElement('div');
            grid.className = 'products';

            Object.keys(groupedProducts).forEach(categoryId => {
                const group = groupedProducts[categoryId];
                
                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'category-container';
                categoryContainer.id = `category-${categoryId}`;
                
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = group.name;
                
                const categoryCount = document.createElement('div');
                categoryCount.className = 'category-count';
                categoryCount.textContent = `${group.products.length} ŸÖŸÜÿ™ÿ¨`;
                
                categoryHeader.appendChild(categoryTitle);
                categoryHeader.appendChild(categoryCount);
                categoryContainer.appendChild(categoryHeader);
                
                group.products.forEach(p => {
                    const merchant = allMerchants.find(m => m.id === p.userId);
                    if (!merchant) return;
                    
                    const card = createProductCard(p, merchant);
                    categoryContainer.appendChild(card);
                });
                
                grid.appendChild(categoryContainer);
            });

            if (grid.children.length === 0) {
                productsContainer.innerHTML = `
                    <div class="no-products">
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ™ÿ∑ÿßÿ®ŸÇ ŸÖÿπÿßŸäŸäÿ± ÿßŸÑÿ®ÿ≠ÿ´</p>
                        <button onclick="resetFilters()" style="margin-top:10px;padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer">ÿπÿ±ÿ∂ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™</button>
                    </div>
                `;
            } else {
                productsContainer.appendChild(grid);
            }
        }

        // ==========================================
        // üéØ ÿØÿßŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿ®ÿ∑ÿßŸÇÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨
        // ==========================================
        function createProductCard(product, merchant) {
            const merchantName = merchant.name || merchant.username || "ÿ™ÿßÿ¨ÿ±";
            const productName = product.name || 'ŸÖŸÜÿ™ÿ¨ ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ';
            const categoryName = product.categoryId ? 
                (allCategories.find(c => c.id === product.categoryId)?.name || '') : '';

            const card = document.createElement('div');
            card.className = 'card';
            card.id = `product-${product.id}`;

            if (isOfferValid(product)) {
                card.classList.add('has-offer');

                const offerBadge = document.createElement('div');
                offerBadge.className = 'offer-badge';
                offerBadge.innerHTML = '<i class="fas fa-tag"></i> ÿπÿ±ÿ∂ ÿÆÿßÿµ';
                offerBadge.style.cursor = 'pointer';
                offerBadge.addEventListener('click', function(e) {
                    e.stopPropagation();
                    toggleOfferDates(card);
                });
                card.appendChild(offerBadge);

                if (product.startDate || product.endDate) {
                    const offerDates = document.createElement('div');
                    offerDates.className = 'offer-dates';
                    
                    if (product.startDate) {
                        const startDateDiv = document.createElement('div');
                        startDateDiv.innerHTML = `<i class="fas fa-calendar-alt"></i> Ÿäÿ®ÿØÿ£: ${formatDate(product.startDate)}`;
                        offerDates.appendChild(startDateDiv);
                    }
                    
                    if (product.endDate) {
                        const endDateDiv = document.createElement('div');
                        endDateDiv.innerHTML = `<i class="fas fa-calendar-times"></i> ŸäŸÜÿ™ŸáŸä: ${formatDate(product.endDate)}`;
                        offerDates.appendChild(endDateDiv);
                    }
                    
                    card.appendChild(offerDates);
                }
            }

            const imageUrls = extractImageUrls(product);

            if (imageUrls.length > 1) {
                const sliderDiv = document.createElement('div');
                sliderDiv.className = 'image-slider';
                sliderDiv.id = `slider-${product.id}`;

                const sliderContainer = document.createElement('div');
                sliderContainer.className = 'slider-container';

                imageUrls.forEach((url, index) => {
                    const img = document.createElement('img');
                    img.className = 'slider-image';
                    img.loading = 'lazy';
                    img.decoding = 'async';
                    img.src = formatDriveUrl(url, 'thumb');
                    img.alt = `${productName} - ÿµŸàÿ±ÿ© ${index + 1}`;
                    img.addEventListener('click', () => {
                        recordProductView(product.id);
                        incrementViewCount(product.id);
                        openImageGallery(imageUrls, productName, index, product.id);
                    });
                    sliderContainer.appendChild(img);
                });
                sliderDiv.appendChild(sliderContainer);

                if (imageUrls.length > 1) {
                    const prevBtn = document.createElement('button');
                    prevBtn.className = 'slider-arrow prev';
                    prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    prevBtn.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        navigateSlider(product.id, -1); 
                    });

                    const nextBtn = document.createElement('button');
                    nextBtn.className = 'slider-arrow next';
                    nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    nextBtn.addEventListener('click', (e) => { 
                        e.stopPropagation(); 
                        navigateSlider(product.id, 1); 
                    });

                    const navDiv = document.createElement('div');
                    navDiv.className = 'slider-nav';
                    imageUrls.forEach((_, i) => {
                        const dot = document.createElement('div');
                        dot.className = 'slider-dot';
                        if (i === 0) dot.classList.add('active');
                        dot.addEventListener('click', (e) => { 
                            e.stopPropagation(); 
                            goToSlide(product.id, i); 
                        });
                        navDiv.appendChild(dot);
                    });

                    sliderDiv.appendChild(prevBtn);
                    sliderDiv.appendChild(nextBtn);
                    sliderDiv.appendChild(navDiv);
                }
                card.appendChild(sliderDiv);
            } else {
                const imageDiv = document.createElement('div');
                imageDiv.className = 'images-preview';
                const img = document.createElement('img');
                img.loading = 'lazy'; 
                img.decoding = 'async';

                const imageUrl = imageUrls[0] || '';
                if (imageUrl) {
                    img.src = formatDriveUrl(imageUrl, 'thumb');
                    img.alt = productName;
                    img.addEventListener('click', () => {
                        recordProductView(product.id);
                        incrementViewCount(product.id);
                        openImageGallery([imageUrl], productName, 0, product.id);
                    });
                } else {
                    img.src = 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w800';
                    img.alt = 'ÿµŸàÿ±ÿ© ÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ©';
                    img.style.border = '1px dashed #ccc';
                    img.addEventListener('click', () => {
                        recordProductView(product.id);
                        incrementViewCount(product.id);
                        openImageGallery(['https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w1600'], productName, 0, product.id);
                    });
                }
                imageDiv.appendChild(img);
                card.appendChild(imageDiv);
            }

            // ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿ©
            const matchingProducts = getMatchingProducts(
                product.name, 
                product.categoryId, 
                allProducts, 
                product.id
            );
            
            if (matchingProducts.length > 0) {
                const matchingContainer = document.createElement('div');
                matchingContainer.className = 'matching-products-container';
                
                const matchingScroll = document.createElement('div');
                matchingScroll.className = 'matching-products-scroll';
                matchingScroll.id = `matching-products-${product.id}`;
                
                matchingProducts.forEach(match => {
                    if (match.id === product.id) return;
                    
                    const matchImageUrls = extractImageUrls(match);
                    const matchImageUrl = matchImageUrls.length > 0 ? matchImageUrls[0] : '';
                    const formattedImageUrl = formatDriveUrl(matchImageUrl, 'thumb');
                    
                    const matchItem = document.createElement('div');
                    matchItem.className = 'matching-product-item';
                    matchItem.innerHTML = `
                        <img src="${formattedImageUrl}" alt="${match.name || 'ŸÖŸÜÿ™ÿ¨'}" class="matching-product-image">
                        <div class="matching-product-name">${match.name || 'ŸÖŸÜÿ™ÿ¨ ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ'}</div>
                        <div class="matching-product-price">${match.price ? match.price + ' ÿ±ŸäÿßŸÑ' : 'ÿ®ÿØŸàŸÜ ÿ≥ÿπÿ±'}</div>
                    `;
                    
                    matchItem.addEventListener('click', () => {
                        recordProductView(match.id);
                        goToProduct(match.id);
                    });
                    
                    matchingScroll.appendChild(matchItem);
                });
                
                matchingContainer.appendChild(matchingScroll);
                card.appendChild(matchingContainer);
            }

            const infoDiv = document.createElement('div');
            infoDiv.className = 'info';

            const title = document.createElement('h3'); 
            title.textContent = productName; 
            infoDiv.appendChild(title);

            if (product.price) {
                const priceDiv = document.createElement('div'); 
                priceDiv.className = 'product-price';
                const currency = product.currency || 'ÿ±ŸäÿßŸÑ ŸäŸÖŸÜŸä';
                priceDiv.textContent = `${product.price} ${currency}`; 
                infoDiv.appendChild(priceDiv);
            }

            const detailsDiv = document.createElement('div'); 
            detailsDiv.className = 'product-details';
            
            if (product.description) {
                const descItem = document.createElement('div'); 
                descItem.className = 'product-detail-item';
                
                const labelSpan = document.createElement('span');
                labelSpan.className = 'label';
                labelSpan.textContent = '';
                descItem.appendChild(labelSpan);
                
                const descriptionElement = createDescriptionElement(product);
                descItem.appendChild(descriptionElement);
                
                detailsDiv.appendChild(descItem);
            } else if (product.date) {
                const dateItem = document.createElement('div'); 
                dateItem.className = 'product-detail-item';
                dateItem.innerHTML = `<span class="label">ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ•ÿ∂ÿßŸÅÿ©:</span> <span>${formatDate(product.date)}</span>`;
                detailsDiv.appendChild(dateItem);
            }
            
            infoDiv.appendChild(detailsDiv);

            const merchantBtn = document.createElement('button');
            merchantBtn.className = 'merchant-btn';
            merchantBtn.id = 'merchant-btn';
            merchantBtn.innerHTML = `
    <div style="text-align: center;">
        <div class="underline-border">ÿßÿ∑ŸÑÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿßŸÑÿßŸÜ</div>
        <div class="merchant-name-center">${merchantName}</div>
    </div>
`;
            
            merchantBtn.addEventListener('click', () => { 
                const merchantName = merchant.name || merchant.username || "ÿ™ÿßÿ¨ÿ±";
                const merchantId = product.userId;
                const productName = product.name || 'ŸÖŸÜÿ™ÿ¨ ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ';
                
                localStorage.setItem('selectedMerchantName', merchantName);
                localStorage.setItem('selectedMerchantId', merchantId);
                localStorage.setItem('selectedProductName', productName);
                
                console.log('ÿ™ŸÖ ÿ≠ŸÅÿ∏ ÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑÿ™ÿßÿ¨ÿ±:', {
                    merchantName: merchantName,
                    merchantId: merchantId,
                    productName: productName
                });
                
                recordProductView(product.id);
                incrementViewCount(product.id);
                saveScrollPosition();
                openMerchantPage(); 
            });
            infoDiv.appendChild(merchantBtn);

            const commentsSection = document.createElement('div');
            commentsSection.className = 'comments-section'; 
            commentsSection.id = `comments-${product.id}`;
            commentsSection.innerHTML = `
                <div class="comments-header">
                    <div class="comments-title">ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™ (<span class="comments-count">0</span>)</div>
                    <button class="close-comments" onclick="closeComments('${product.id}')">√ó</button>
                </div>
                <div class="comments-list" id="comments-list-${product.id}">
                    <div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™...</div>
                </div>
                <div class="add-comment">
                    <div class="comment-form">
                        <textarea id="comment-text-${product.id}" placeholder="ÿßŸÉÿ™ÿ® ÿ™ÿπŸÑŸäŸÇŸÉ ŸáŸÜÿß..."></textarea>
                        <button onclick="addComment('${product.id}')">ÿ•ÿ±ÿ≥ÿßŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇ</button>
                    </div>
                </div>
            `;
            infoDiv.appendChild(commentsSection);

            card.appendChild(infoDiv);

            const actionButtonsDiv = document.createElement('div');
            actionButtonsDiv.className = 'action-buttons';
            actionButtonsDiv.innerHTML = `
                <div class="stats-buttons">
                    <div class="stat-with-button">
                        <div class="stat-number like-stat" id="like-stat-${product.id}">0</div>
                        <button class="action-button btn-like" onclick="handleLike('${product.id}', '${escapeHtml(productName)}')">
                            <i class="fas fa-thumbs-up"></i>
                        </button>
                    </div>

                    <div class="stat-with-button">
                        <div class="stat-number comment-stat" id="comment-stat-${product.id}">0</div>
                        <button class="action-button btn-comment" onclick="toggleComments('${product.id}')">
                            <i class="fas fa-comments"></i>
                        </button>
                    </div>

                    <div class="stat-with-button">
                        <div class="stat-number view-stat" id="view-stat-${product.id}">150</div>
                        <button class="action-button btn-view">
                            <i class="fas fa-eye"></i>
                        </button>
                    </div>

                    <div class="stat-with-button">
                        <div class="stat-number" style="visibility: hidden;">0</div>
                        <button class="favorite-btn ${favoriteProducts[product.id] ? 'active' : ''}" onclick="toggleFavorite('${product.id}', this, '${escapeHtml(productName)}')" title="${favoriteProducts[product.id] ? 'ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©' : 'ÿ•ÿ∂ÿßŸÅÿ© ÿ•ŸÑŸâ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©'}">
                            <i class="fas fa-heart"></i>
                        </button>
                    </div>

                    <div class="stat-with-button">
                        <div class="stat-number" style="visibility: hidden;">0</div>
                        <button class="share-button" onclick="openShareModal('${product.id}', '${escapeHtml(productName)}')">
                            <i class="fas fa-share"></i>
                        </button>
                    </div>
                </div>
            `;
            card.appendChild(actionButtonsDiv);

            loadProductStats(product.id, card);
            
            productCards[product.id] = card;
            
            return card;
        }

        // ==========================================
        // üìä ÿØÿßŸÑÿ© ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨
        // ==========================================
        function recordProductView(productId) {
            userViewHistory[productId] = new Date().toISOString();
            localStorage.setItem('userViewHistory', JSON.stringify(userViewHistory));
            console.log('üìä ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿ¥ÿßŸáÿØÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨:', productId);
        }

        // ==========================================
        // üéØ Ÿàÿ∏ÿßÿ¶ŸÅ ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ∑ÿßÿ®ŸÇÿßÿ™ ÿßŸÑŸÖÿ≠ÿ≥ŸëŸÜÿ©
        // ==========================================
        function calculateMatches(currentProductName, currentProductCategory, allProducts, currentProductId) {
            const firstWord = getFirstWord(currentProductName);
            if (!firstWord) return 0;
            
            let matchCount = 0;
            
            allProducts.forEach(otherProduct => {
                if (otherProduct.id !== currentProductId) {
                    const otherProductName = otherProduct.name || '';
                    
                    if (otherProductName.includes(firstWord) && otherProduct.categoryId === currentProductCategory) {
                        matchCount++;
                    }
                }
            });
            
            return matchCount;
        }

        function getMatchingProducts(currentProductName, currentProductCategory, allProducts, currentProductId) {
            const firstWord = getFirstWord(currentProductName);
            if (!firstWord) return [];
            
            let matchingProducts = [];
            
            allProducts.forEach(otherProduct => {
                if (otherProduct.id !== currentProductId) {
                    const otherProductName = otherProduct.name || '';
                    
                    const isDuplicate = matchingProducts.some(match => 
                        match.name === otherProduct.name && 
                        extractImageUrls(match)[0] === extractImageUrls(otherProduct)[0]
                    );
                    
                    if (otherProductName.includes(firstWord) && otherProduct.categoryId === currentProductCategory && !isDuplicate) {
                        matchingProducts.push({
                            id: otherProduct.id,
                            ...otherProduct
                        });
                    }
                }
            });
            
            return matchingProducts;
        }

        function getFirstWord(text) {
            if (!text || text.trim() === '') return '';
            
            const words = text
                .replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFFa-zA-Z0-9\s]/g, '')
                .trim()
                .split(/\s+/);
                
            return words.length > 0 ? words[0] : '';
        }

        function goToProduct(productId) {
            const productCard = productCards[productId];
            if (productCard) {
                productCard.classList.add('highlighted');
                
                productCard.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
                
                setTimeout(() => {
                    productCard.classList.remove('highlighted');
                }, 2000);
            }
        }

        // ==========================================
        // üéØ Ÿàÿ∏ŸäŸÅÿ© ÿ™ÿ®ÿØŸäŸÑ ÿ•ÿ∏Ÿáÿßÿ±/ÿ•ÿÆŸÅÿßÿ° ÿ™Ÿàÿßÿ±ŸäÿÆ ÿßŸÑÿπÿ±ÿ∂
        // ==========================================
        function toggleOfferDates(card) {
            const startDateBadge = card.querySelector('.offer-dates');
            const endDateBadge = card.querySelector('.offer-dates-end');
            
            if (startDateBadge) {
                if (startDateBadge.style.display === 'none' || startDateBadge.style.display === '') {
                    startDateBadge.style.display = 'flex';
                } else {
                    startDateBadge.style.display = 'none';
                }
            }
            
            if (endDateBadge) {
                if (endDateBadge.style.display === 'none' || endDateBadge.style.display === '') {
                    endDateBadge.style.display = 'flex';
                } else {
                    endDateBadge.style.display = 'none';
                }
            }
        }

        // ÿßÿ≥ÿ™ÿÆÿ±ÿßÿ¨ ÿßŸÑÿµŸàÿ±
        function extractImageUrls(product) {
            let imageUrls = [];
            if (product.imageUrls) {
                if (Array.isArray(product.imageUrls)) 
                    imageUrls = product.imageUrls.filter(u => u && u.trim() !== '');
                else if (typeof product.imageUrls === 'string') 
                    imageUrls = product.imageUrls.split(',').map(u => u.trim()).filter(Boolean);
            }
            if (imageUrls.length === 0 && product.imageUrl && typeof product.imageUrl === 'string') {
                imageUrls = product.imageUrl.split(/[,\n]/).map(u => u.trim()).filter(Boolean);
            }
            
            if (imageUrls.length === 0) {
                imageUrls = ['https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w800'];
            }
            
            return imageUrls;
        }

        // ==========================================
        // üîç ÿ•ÿµŸÑÿßÿ≠ ŸÖÿ¥ŸÉŸÑÿ© ÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ± ŸÖŸÜ ÿ¨Ÿàÿ¨ŸÑ ÿØÿ±ÿßŸäŸÅ
        // ==========================================
        function formatDriveUrl(url, mode = 'thumb') {
            if (!url) return '';
            
            if (url.includes('1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC')) {
                return url;
            }
            
            let id = '';
            
            if (url.includes('/d/')) {
                id = url.split('/d/')[1].split('/')[0];
            } 
            else if (url.includes('id=')) {
                try { 
                    id = new URLSearchParams(url.split('?')[1]).get('id') || ''; 
                } catch { 
                    return url; 
                }
            }
            else if (url.includes('/file/d/')) {
                id = url.split('/file/d/')[1].split('/')[0];
            }
            else if (url.includes('drive.google.com/uc?id=')) {
                id = url.split('drive.google.com/uc?id=')[1].split('&')[0];
            }
            
            if (!id) return url;

            if (mode === 'thumb') {
                return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
            } else if (mode === 'main') {
                return `https://drive.google.com/thumbnail?id=${id}&sz=w1600`;
            } else if (mode === 'raw') {
                return `https://drive.google.com/uc?export=view&id=${id}`;
            }
            return url;
        }

        // ==========================================
        // üñºÔ∏è Ÿàÿ∏ÿßÿ¶ŸÅ ŸÖÿπÿ±ÿ∂ ÿßŸÑÿµŸàÿ± ÿßŸÑŸÖÿ≠ÿ≥ŸÜ
        // ==========================================
        function openImageGallery(images, productName, startIndex = 0, productId = null) {
            galleryImages = images;
            currentGalleryIndex = startIndex;
            isImageZoomed = false;

            if (productId) {
                const product = allProducts.find(p => p.id === productId);
                if (product && product.categoryId) {
                    userInterests[product.categoryId] = (userInterests[product.categoryId] || 0) + 1;
                    localStorage.setItem('userInterests', JSON.stringify(userInterests));
                }
                
                if (productId && !openedProducts.includes(productId)) {
                    openedProducts.push(productId);
                }
            }

            document.getElementById('gallery-product-name').textContent = productName;
            createGalleryThumbnails();
            showGalleryImage(startIndex);

            const gallery = document.getElementById('image-gallery');
            gallery.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            if ('ontouchstart' in window) {
                document.addEventListener('backbutton', handleBackButton, false);
            }
        }

        function closeImageGallery() {
            document.getElementById('image-gallery').classList.remove('active');
            document.body.style.overflow = '';
            isImageZoomed = false;

            const mainImage = document.getElementById('gallery-main-image');
            mainImage.classList.remove('zoomed');
            
            if ('ontouchstart' in window) {
                document.removeEventListener('backbutton', handleBackButton, false);
            }
        }

        function handleBackButton(e) {
            const gallery = document.getElementById('image-gallery');
            if (gallery.classList.contains('active')) {
                e.preventDefault();
                closeImageGallery();
            }
        }

        function createGalleryThumbnails() {
            const container = document.getElementById('gallery-thumbnails');
            container.innerHTML = '';
            
            galleryImages.forEach((u, i) => {
                const thumb = document.createElement('img');
                thumb.className = 'gallery-thumbnail';
                thumb.loading = 'lazy'; 
                thumb.decoding = 'async';
                thumb.src = formatDriveUrl(u, 'thumb');
                thumb.alt = `ÿµŸàÿ±ÿ© ${i + 1}`;
                thumb.addEventListener('click', () => showGalleryImage(i));
                if (i === currentGalleryIndex) thumb.classList.add('active');
                container.appendChild(thumb);
            });
        }

        function showGalleryImage(index) {
            if (galleryImages.length === 0) {
                const mainImage = document.getElementById('gallery-main-image');
                mainImage.src = 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w1600';
                mainImage.alt = 'ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿµŸàÿ±ÿ©';
                document.getElementById('gallery-counter').textContent = '0 ŸÖŸÜ 0';
                return;
            }

            if (index < 0) currentGalleryIndex = galleryImages.length - 1;
            else if (index >= galleryImages.length) currentGalleryIndex = 0;
            else currentGalleryIndex = index;

            const mainImage = document.getElementById('gallery-main-image');
            mainImage.src = formatDriveUrl(galleryImages[currentGalleryIndex], 'main');
            mainImage.alt = `ÿµŸàÿ±ÿ© ${currentGalleryIndex + 1}`;
            mainImage.classList.remove('zoomed');
            isImageZoomed = false;

            document.getElementById('gallery-counter').textContent = 
                `${currentGalleryIndex + 1} ŸÖŸÜ ${galleryImages.length}`;

            const thumbs = document.querySelectorAll('.gallery-thumbnail');
            thumbs.forEach((t, i) => t.classList.toggle('active', i === currentGalleryIndex));

            preloadAdjacentImages();
        }

        function navigateGallery(direction) {
            showGalleryImage(currentGalleryIndex + direction);
        }

        // ==========================================
        // üîç Ÿàÿ∏ŸäŸÅÿ© ÿßŸÑÿ™ÿ≠ŸÉŸÖ ŸÅŸä ÿ™ŸÉÿ®Ÿäÿ± ÿßŸÑÿµŸàÿ±ÿ©
        // ==========================================
        function toggleImageZoom() {
            const mainImage = document.getElementById('gallery-main-image');
            isImageZoomed = !isImageZoomed;
            mainImage.classList.toggle('zoomed', isImageZoomed);

            const zoomBtn = document.querySelector('.gallery-zoom-btn i');
            if (isImageZoomed) {
                zoomBtn.className = 'fas fa-search-minus';
            } else {
                zoomBtn.className = 'fas fa-search-plus';
            }
        }

        function preloadAdjacentImages() {
            const prevIndex = (currentGalleryIndex - 1 + galleryImages.length) % galleryImages.length;
            const nextIndex = (currentGalleryIndex + 1) % galleryImages.length;

            [prevIndex, nextIndex].forEach(i => {
                const img = new Image();
                img.decoding = 'async';
                img.referrerPolicy = 'no-referrer';
                img.src = formatDriveUrl(galleryImages[i], 'main');
            });
        }

        // ÿ≥ŸÑÿßŸäÿØÿ± ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™
        function navigateSlider(productId, direction) {
            const slider = document.getElementById(`slider-${productId}`);
            const container = slider.querySelector('.slider-container');
            const slides = container.querySelectorAll('.slider-image');

            const currentIndex = Math.round(container.scrollLeft / container.clientWidth);
            let newIndex = currentIndex + direction;
            if (newIndex < 0) newIndex = slides.length - 1;
            if (newIndex >= slides.length) newIndex = 0;
            goToSlide(productId, newIndex);
        }

        function goToSlide(productId, index) {
            const slider = document.getElementById(`slider-${productId}`);
            const container = slider.querySelector('.slider-container');
            const dots = slider.querySelectorAll('.slider-dot');

            container.scrollTo({ left: index * container.clientWidth, behavior: 'smooth' });
            dots.forEach((d, i) => d.classList.toggle('active', i === index));
        }

        // ==========================================
        // üîç ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© ŸÅŸÑÿ™ÿ±ÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÑÿØÿπŸÖ ÿßŸÑÿ£ÿ≠ÿ±ŸÅ ÿßŸÑŸÖÿ™ÿ¥ÿßÿ®Ÿáÿ©
        // ==========================================
        function filterProducts() {
            const filters = {
                governorate: governorateSelect.value,
                region: regionSelect.value,
                category: selectedCategoryId,
                search: (searchInput.value || '').trim(),
                sortBy: sortSelect.value
            };

            if (filters.search) {
                saveSearchTerm(filters.search);
                saveSearchTermToAsnaf(filters.search);
            }

            const result = allProducts.filter(product => {
                if (!product) return false;
                const merchant = allMerchants.find(m => m.id === product.userId);
                if (!merchant) return false;

                const isActive = merchant.status === "active" || merchant.status === "ŸÜÿ¥ÿ∑";
                const isMerchant = merchant.job === "ÿ™ÿßÿ¨ÿ±" || merchant.type === "ÿ™ÿßÿ¨ÿ±";
                
                if (!isActive || !isMerchant) return false;

                if (product.productType === 'ÿπÿ±ÿ∂' && !isOfferValid(product)) {
                    return false;
                }

                if (filters.search) {
                    const normalizedSearch = normalizeText(filters.search);
                    const productName = normalizeText(product.name || '');
                    const productDesc = normalizeText(product.description || '');
                    
                    if (!productName.includes(normalizedSearch) && !productDesc.includes(normalizedSearch)) {
                        return false;
                    }
                }

                if (filters.category) {
                    if (product.categoryId !== filters.category && product.category !== filters.category) return false;
                }

                if (selectedMerchantId && product.userId !== selectedMerchantId) return false;

                if (filters.governorate) {
                    const merchantGovernorate = merchant.governorate || merchant.region;
                    if (merchantGovernorate !== filters.governorate) return false;
                }
                if (filters.region) {
                    const merchantArea = merchant.area || merchant.city;
                    if (merchantArea !== filters.region) return false;
                }

                return true;
            });

            displayProducts(result);
        }

        function saveSearchTerm(term) {
            let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            
            searchHistory = searchHistory.filter(t => t !== term);
            searchHistory.unshift(term);
            
            searchHistory = searchHistory.slice(0, 10);
            
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }

        function resetFilters() {
            governorateSelect.value = '';
            regionSelect.value = '';
            searchInput.value = '';
            sortSelect.value = 'date';
            categoryValueDisplay.textContent = '';
            
            selectedMerchantId = null;
            selectedMerchantName = null;
            merchantTextInput.value = '';
            
            selectedCategoryId = null;
            selectedCategoryName = null;
            categoryTextInput.value = '';
            secondaryCategoryTextInput.value = '';
            
            updateRegionOptions();
            displayProducts(allProducts);
            showNotification('ÿ™ŸÖ ÿ•ÿπÿßÿØÿ© ÿ™ÿπŸäŸäŸÜ ÿ¨ŸÖŸäÿπ ÿßŸÑŸÅŸÑÿßÿ™ÿ±', 'success');
        }

        // ==========================================
        // ‚ù§Ô∏è ÿ™ÿπÿØŸäŸÑ Ÿàÿ∏ŸäŸÅÿ© ÿßŸÑŸÖŸÅÿ∂ŸÑÿ© ŸÖÿπ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™
        // ==========================================
        function toggleFavorite(productId, button, productName = '') {
            if (favoriteProducts[productId]) { 
                delete favoriteProducts[productId]; 
                button.classList.remove('active'); 
                showNotification('ÿ™ŸÖ ÿ•ÿ≤ÿßŸÑÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©', 'info');
            } else { 
                favoriteProducts[productId] = true; 
                button.classList.add('active'); 
                showNotification('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ•ŸÑŸâ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©', 'success');
                
                const product = allProducts.find(p => p.id === productId);
                if (product && product.categoryId) {
                    userInterests[product.categoryId] = (userInterests[product.categoryId] || 0) + 1;
                    localStorage.setItem('userInterests', JSON.stringify(userInterests));
                }
            }
            localStorage.setItem('favoriteProducts', JSON.stringify(favoriteProducts));
            
            if (showFavoritesOnly) {
                displayFavoriteProducts();
            }
        }

        // ==========================================
        // üîî Ÿàÿ∏ŸäŸÅÿ© ÿπÿ±ÿ∂ ÿßŸÑÿ•ÿ¥ÿπÿßÿ±ÿßÿ™ ŸÖÿπ ÿßŸÑÿµŸàÿ™
        // ==========================================
        function showNotification(message, type = 'success') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            notification.textContent = message;
            
            if (type === 'success') {
                notification.style.background = 'var(--success-color)';
                if (message.includes('ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ')) {
                    playNotificationSound();
                }
            } else if (type === 'info') {
                notification.style.background = 'var(--primary-color)';
            } else if (type === 'error') {
                notification.style.background = 'var(--danger-color)';
            }
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // ==========================================
        // üëÅÔ∏è ÿ™ÿπÿØŸäŸÑ Ÿàÿ∏ŸäŸÅÿ© ÿ≤ŸäÿßÿØÿ© ÿßŸÑŸÖÿ¥ÿßŸáÿØÿßÿ™
        // ==========================================
        function incrementViewCount(productId) {
            const viewKey = `view_${productId}`;
            
            if (!userActions.views[viewKey]) {
                userActions.views[viewKey] = Date.now();
                localStorage.setItem('userActions', JSON.stringify(userActions));
                
                db.ref(`products_stats/${productId}/views`).transaction(current => (current || 0) + 1);

                const viewEl = document.getElementById(`view-stat-${productId}`);
                if (viewEl) { 
                    const currentViews = parseInt(viewEl.textContent) || 150;
                    viewEl.textContent = currentViews + 1; 
                }

                const product = allProducts.find(p => p.id === productId);
                if (product && product.categoryId) {
                    userInterests[product.categoryId] = (userInterests[product.categoryId] || 0) + 1;
                    localStorage.setItem('userInterests', JSON.stringify(userInterests));
                }
                
                console.log('üëÅÔ∏è ÿ™ŸÖ ÿ™ÿ≥ÿ¨ŸäŸÑ ŸÖÿ¥ÿßŸáÿØÿ© ÿ¨ÿØŸäÿØÿ© ŸÑŸÑŸÖŸÜÿ™ÿ¨:', productId);
            } else {
                console.log('üëÅÔ∏è ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖ ŸÇÿØ ÿ¥ÿßŸáÿØ Ÿáÿ∞ÿß ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖŸÜ ŸÇÿ®ŸÑ:', productId);
            }
        }

        // ==========================================
        // üìä ÿØÿßŸÑÿ© ÿ≠ÿ≥ÿßÿ® ÿßŸÑŸÖÿ¥ÿßŸáÿØÿßÿ™ ÿßŸÑÿßŸÅÿ™ÿ±ÿßÿ∂Ÿäÿ© ÿ®ŸÜÿßÿ°Ÿã ÿπŸÑŸâ ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑŸÜÿ¥ÿ±
        // ==========================================
        function getDefaultViews(product) {
            if (!product) return 150;
            
            const today = new Date();
            const publishDate = new Date(product.publishDate || product.createdAt || product.date || 0);
            
            const diffTime = Math.abs(today - publishDate);
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            if (diffDays <= 7) {
                return 2500;
            } else if (diffDays <= 14) {
                return 6500;
            } else if (diffDays <= 21) {
                return 80000;
            } else if (diffDays <= 35) {
                return 900000;
            } else {
                return 150;
            }
        }

        async function loadProductStats(productId, card) {
            try {
                const [statsSnap, commentsSnap] = await Promise.all([
                    db.ref(`products_stats/${productId}`).once('value'),
                    db.ref(`comments/${productId}`).once('value')
                ]);

                const stats = statsSnap.val() || {};
                const comments = commentsSnap.val() || {};

                const likeCount = Array.isArray(stats.likes) ? stats.likes.length : 0;
                const realViews = stats.views || 0;
                const commentCount = Object.keys(comments).length;
                
                const product = allProducts.find(p => p.id === productId);
                const defaultViews = getDefaultViews(product);
                const totalViews = defaultViews + realViews;

                const likeStatEl = document.getElementById(`like-stat-${productId}`);
                const viewStatEl = document.getElementById(`view-stat-${productId}`);
                const commentStatEl = document.getElementById(`comment-stat-${productId}`);
                const commentsCountEl = card.querySelector('.comments-count');

                if (likeStatEl) likeStatEl.textContent = likeCount;
                if (viewStatEl) viewStatEl.textContent = totalViews;
                if (commentStatEl) commentStatEl.textContent = commentCount;
                if (commentsCountEl) commentsCountEl.textContent = commentCount;

                updateLikeButtonState(productId, stats.likes || []);
                
            } catch (e) { 
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ•ÿ≠ÿµÿßÿ¶Ÿäÿßÿ™:', e); 
            }
        }

        // ==========================================
        // ‚ù§Ô∏è ÿ™ÿ≠ÿØŸäÿ´ ÿ≠ÿßŸÑÿ© ÿ≤ÿ± ÿßŸÑÿ•ÿπÿ¨ÿßÿ®
        // ==========================================
        function updateLikeButtonState(productId, likesArray) {
            const likeButton = document.querySelector(`#product-${productId} .btn-like`);
            if (!likeButton) return;
            
            const userLiked = likesArray.includes(currentUserId);
            
            if (userLiked) {
                likeButton.style.color = 'var(--danger-color)';
                likeButton.title = 'ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ•ÿπÿ¨ÿßÿ®';
            } else {
                likeButton.style.color = '';
                likeButton.title = 'ÿßŸÑÿ•ÿπÿ¨ÿßÿ®';
            }
        }

        // ==========================================
        // ‚ù§Ô∏è ÿ™ÿπÿØŸäŸÑ Ÿàÿ∏ŸäŸÅÿ© ÿßŸÑÿ•ÿπÿ¨ÿßÿ®
        // ==========================================
        async function handleLike(productId, productName = '') {
            try {
                const likesRef = db.ref(`products_stats/${productId}/likes`);
                const snapshot = await likesRef.once('value');
                let likes = snapshot.val() || [];
                if (!Array.isArray(likes)) likes = [];
                
                const idx = likes.indexOf(currentUserId);
                if (idx === -1) {
                    likes.push(currentUserId);
                    showNotification('ÿ™ŸÖ ÿßŸÑÿ•ÿπÿ¨ÿßÿ® ÿ®ÿßŸÑŸÖŸÜÿ™ÿ¨', 'success');
                    
                    userActions.likes[productId] = Date.now();
                    localStorage.setItem('userActions', JSON.stringify(userActions));
                } else {
                    likes.splice(idx, 1);
                    showNotification('ÿ™ŸÖ ÿ•ŸÑÿ∫ÿßÿ° ÿßŸÑÿ•ÿπÿ¨ÿßÿ® ÿ®ÿßŸÑŸÖŸÜÿ™ÿ¨', 'info');
                    
                    delete userActions.likes[productId];
                    localStorage.setItem('userActions', JSON.stringify(userActions));
                }
                
                await likesRef.set(likes);
                
                const likeStatEl = document.getElementById(`like-stat-${productId}`);
                if (likeStatEl) likeStatEl.textContent = likes.length;
                
                updateLikeButtonState(productId, likes);
                
            } catch (e) { 
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ŸÖÿπÿßŸÑÿ¨ÿ© ÿßŸÑÿ•ÿπÿ¨ÿßÿ®:', e); 
            }
        }

        function toggleComments(productId) {
            const el = document.getElementById(`comments-${productId}`);
            if (el.classList.contains('active')) {
                closeComments(productId);
            } else {
                openComments(productId);
            }
        }

        function openComments(productId) { 
            closeAllComments();
            
            const el = document.getElementById(`comments-${productId}`); 
            el.classList.add('active'); 
            loadComments(productId);
            isCommentsOpen = true;
        }

        function closeComments(productId) { 
            const el = document.getElementById(`comments-${productId}`); 
            el.classList.remove('active'); 
            const t = document.getElementById(`comment-text-${productId}`); 
            if (t) t.value=''; 
            isCommentsOpen = false;
        }

        function closeAllComments() {
            document.querySelectorAll('.comments-section.active').forEach(section => {
                section.classList.remove('active');
            });
            isCommentsOpen = false;
        }

        async function loadComments(productId) {
            const list = document.getElementById(`comments-list-${productId}`);
            list.innerHTML = '<div class="loading">ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™...</div>';
            try {
                const snapshot = await db.ref(`comments/${productId}`).once('value');
                const data = snapshot.val() || {};
                const comments = Object.entries(data).map(([id, c]) => ({ id, ...c }));
                displayComments(comments, productId);
            } catch (e) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™:', e);
                list.innerHTML = '<div class="error">ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿ™ÿπŸÑŸäŸÇÿßÿ™</div>';
            }
        }

        function displayComments(comments, productId) {
            const list = document.getElementById(`comments-list-${productId}`);
            const countEl = document.querySelector(`#comments-${productId} .comments-count`);
            list.innerHTML = '';
            countEl.textContent = comments.length;

            if (comments.length === 0) { 
                list.innerHTML = '<div class="no-comments">ŸÑÿß ÿ™Ÿàÿ¨ÿØ ÿ™ÿπŸÑŸäŸÇÿßÿ™ ÿ®ÿπÿØ</div>'; 
                return; 
            }

            comments.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            comments.forEach(c => {
                const div = document.createElement('div'); 
                div.className = 'comment-item';
                div.innerHTML = `
                    <div class="comment-header">
                        <span>${escapeHtml(c.author || 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ')}</span>
                        <span class="comment-date">${formatDate(c.date)}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(c.text || '')}</div>
                `;
                list.appendChild(div);
            });
        }

        async function addComment(productId) {
            const textarea = document.getElementById(`comment-text-${productId}`);
            const text = (textarea.value || '').trim();
            if (!text) { 
                alert('Ÿäÿ±ÿ¨Ÿâ ŸÉÿ™ÿßÿ®ÿ© ÿ™ÿπŸÑŸäŸÇ ŸÇÿ®ŸÑ ÿßŸÑÿ•ÿ±ÿ≥ÿßŸÑ'); 
                return; 
            }

            try {
                const commentId = Date.now().toString();
                const comment = { text, author: 'ŸÖÿ≥ÿ™ÿÆÿØŸÖ', date: new Date().toISOString() };
                await db.ref(`comments/${productId}/${commentId}`).set(comment);
                textarea.value = '';
                loadComments(productId);
                showNotification('ÿ™ŸÖ ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÇ ÿ®ŸÜÿ¨ÿßÿ≠', 'success');

                const commentStatEl = document.getElementById(`comment-stat-${productId}`);
                if (commentStatEl) commentStatEl.textContent = (parseInt(commentStatEl.textContent) || 0) + 1;
            } catch (e) {
                console.error('ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÇ:', e);
                alert('ÿ≠ÿØÿ´ ÿÆÿ∑ÿ£ ŸÅŸä ÿ•ÿ∂ÿßŸÅÿ© ÿßŸÑÿ™ÿπŸÑŸäŸÇ');
            }
        }

        // ==========================================
        // üõí Ÿàÿ∏ÿßÿ¶ŸÅ ŸÜÿßŸÅÿ∞ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑÿ™ÿßÿ¨ÿ±
        // ==========================================
        function openMerchantModal() {
            updateModalMerchantList();
            
            merchantModalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            setTimeout(() => {
                merchantModalSearchInput.focus();
            }, 300);
        }

        function closeMerchantModal() {
            merchantModalOverlay.classList.remove('active');
            document.body.style.overflow = '';
            
            merchantModalSearchInput.value = '';
        }

        function updateModalMerchantList() {
            const selectedGovernorate = governorateSelect.value;
            const selectedRegion = regionSelect.value;
            
            filteredModalMerchants = allMerchants.filter(m => {
                const isActive = m.status === "active" || m.status === "ŸÜÿ¥ÿ∑";
                const isMerchant = m.job === "ÿ™ÿßÿ¨ÿ±" || m.type === "ÿ™ÿßÿ¨ÿ±";
                
                if (selectedGovernorate) {
                    const merchantGovernorate = m.governorate || m.region;
                    if (merchantGovernorate !== selectedGovernorate) {
                        return false;
                    }
                }
                
                if (selectedRegion) {
                    const merchantArea = m.area || m.city;
                    if (merchantArea !== selectedRegion) {
                        return false;
                    }
                }
                
                return isActive && isMerchant;
            });
            
            if (filteredModalMerchants.length === 0 && (selectedGovernorate || selectedRegion)) {
                const govName = selectedGovernorate ? governorateSelect.options[governorateSelect.selectedIndex].text : '';
                const regionName = selectedRegion ? regionSelect.options[regionSelect.selectedIndex].text : '';
                
                filteredModalMerchants = allMerchants.filter(m => {
                    const isActive = m.status === "active" || m.status === "ŸÜÿ¥ÿ∑";
                    const isMerchant = m.job === "ÿ™ÿßÿ¨ÿ±" || m.type === "ÿ™ÿßÿ¨ÿ±";
                    return isActive && isMerchant;
                });
            }
            
            displayMerchantModalList(filteredModalMerchants);
        }

        function displayMerchantModalList(merchants) {
            merchantsModalList.innerHTML = '';
            
            if (merchants.length === 0) {
                merchantsModalList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #64748b;">
                        <i class="fas fa-store" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                        <p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ™ÿ¨ÿßÿ± ŸÑÿπÿ±ÿ∂ŸáŸÖ</p>
                    </div>
                `;
                return;
            }
            
            merchants.sort((a, b) => {
                const nameA = (a.name || a.username || '').toLowerCase();
                const nameB = (b.name || b.username || '').toLowerCase();
                return nameA.localeCompare(nameB, 'ar');
            });
            
            merchants.forEach(merchant => {
                const merchantItem = document.createElement('div');
                merchantItem.className = 'merchant-modal-item';
                merchantItem.dataset.merchantId = merchant.id;
                
                const isSelected = merchant.id === selectedMerchantId;
                
                if (isSelected) {
                    merchantItem.classList.add('selected');
                }
                
                const showNumber = merchant.showNumber || "0";
                const showPhone = showNumber === "1" && merchant.phone;
                
                merchantItem.innerHTML = `
                    <div class="merchant-modal-item-name">
                        ${merchant.name || merchant.username || 'ÿ™ÿßÿ¨ÿ± ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ'}
                    </div>
                    ${showPhone ? `
                        <div class="merchant-modal-item-phone">
                            <i class="fas fa-phone"></i>
                            ${merchant.phone}
                        </div>
                    ` : ''}
                `;
                
                merchantItem.addEventListener('click', function() {
                    document.querySelectorAll('.merchant-modal-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    this.classList.add('selected');
                    
                    selectedMerchantId = this.dataset.merchantId;
                    
                    merchantModalConfirm.disabled = false;
                });
                
                merchantsModalList.appendChild(merchantItem);
            });
        }

        function filterMerchantModalList() {
            const searchTerm = merchantModalSearchInput.value.toLowerCase();
            
            if (!searchTerm) {
                displayMerchantModalList(filteredModalMerchants);
                return;
            }
            
            const filteredMerchants = filteredModalMerchants.filter(merchant => {
                return searchTerm === '' || 
                    (merchant.name && merchant.name.toLowerCase().includes(searchTerm)) ||
                    (merchant.username && merchant.username.toLowerCase().includes(searchTerm)) ||
                    merchant.id.toLowerCase().includes(searchTerm) ||
                    (merchant.phone && merchant.phone.toLowerCase().includes(searchTerm)) ||
                    (merchant.email && merchant.email.toLowerCase().includes(searchTerm));
            });
            
            displayMerchantModalList(filteredMerchants);
        }

        function applyMerchantFilter() {
            if (!selectedMerchantId) {
                showNotification('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ÿ™ÿßÿ¨ÿ±', 'error');
                return;
            }
            
            const merchant = allMerchants.find(m => m.id === selectedMerchantId);
            selectedMerchantName = merchant ? (merchant.name || merchant.username) : '';
            
            merchantTextInput.value = selectedMerchantName;
            
            closeMerchantModal();
            
            filterProducts();
            
            showNotification(`ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑÿ™ÿßÿ¨ÿ±: ${selectedMerchantName}`, 'success');
        }

        // ==========================================
        // üìÇ Ÿàÿ∏ÿßÿ¶ŸÅ ŸÜÿßŸÅÿ∞ÿ© ÿßÿÆÿ™Ÿäÿßÿ± ÿßŸÑŸÇÿ≥ŸÖ
        // ==========================================
        function openCategoryModal() {
            updateModalCategoryList();
            
            categoryModalOverlay.classList.add('active');
            document.body.style.overflow = 'hidden';
            
            setTimeout(() => {
                categoryModalSearchInput.focus();
            }, 300);
        }

        function closeCategoryModal() {
            categoryModalOverlay.classList.remove('active');
            document.body.style.overflow = '';
            
            categoryModalSearchInput.value = '';
        }

        function displayCategoryModalList(categories) {
            categoriesModalList.innerHTML = '';
            
            if (categories.length === 0) {
                categoriesModalList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: #64748b;">
                        <i class="fas fa-tags" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                        <p>ŸÑÿß ŸäŸàÿ¨ÿØ ÿ£ŸÇÿ≥ÿßŸÖ ŸÑÿπÿ±ÿ∂Ÿáÿß</p>
                    </div>
                `;
                return;
            }
            
            categories.sort((a, b) => {
                const countA = a.productCount || 0;
                const countB = b.productCount || 0;
                return countB - countA;
            });
            
            categories.forEach(category => {
                const categoryItem = document.createElement('div');
                categoryItem.className = 'category-modal-item';
                categoryItem.dataset.categoryId = category.id;
                
                const isSelected = category.id === selectedCategoryId;
                
                if (isSelected) {
                    categoryItem.classList.add('selected');
                }
                
                categoryItem.innerHTML = `
                    <div class="category-modal-item-name">
                        ${category.name || 'ŸÇÿ≥ŸÖ ÿ®ÿØŸàŸÜ ÿßÿ≥ŸÖ'}
                    </div>
                    <div class="category-modal-item-count">
                        <i class="fas fa-box"></i>
                        ${category.productCount || 0} ŸÖŸÜÿ™ÿ¨
                    </div>
                `;
                
                categoryItem.addEventListener('click', function() {
                    document.querySelectorAll('.category-modal-item').forEach(item => {
                        item.classList.remove('selected');
                    });
                    
                    this.classList.add('selected');
                    
                    selectedCategoryId = this.dataset.categoryId;
                    
                    categoryModalConfirm.disabled = false;
                });
                
                categoriesModalList.appendChild(categoryItem);
            });
        }

        function filterCategoryModalList() {
            const searchTerm = categoryModalSearchInput.value.toLowerCase();
            
            if (!searchTerm) {
                displayCategoryModalList(filteredModalCategories);
                return;
            }
            
            const filteredCategories = filteredModalCategories.filter(category => {
                return searchTerm === '' || 
                    (category.name && category.name.toLowerCase().includes(searchTerm)) ||
                    category.id.toLowerCase().includes(searchTerm);
            });
            
            displayCategoryModalList(filteredCategories);
        }

        function applyCategoryFilter() {
            if (!selectedCategoryId) {
                showNotification('ŸÑŸÖ Ÿäÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿØ ŸÇÿ≥ŸÖ', 'error');
                return;
            }
            
            const category = allCategories.find(c => c.id === selectedCategoryId);
            selectedCategoryName = category ? category.name : '';
            
            categoryTextInput.value = selectedCategoryName || 'ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ';
            secondaryCategoryTextInput.value = selectedCategoryName || 'ÿ¨ŸÖŸäÿπ ÿßŸÑÿ£ŸÇÿ≥ÿßŸÖ';
            
            closeCategoryModal();
            
            filterProducts();
            
            showNotification(`ÿ™ŸÖ ÿ™ÿµŸÅŸäÿ© ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ≠ÿ≥ÿ® ÿßŸÑŸÇÿ≥ŸÖ: ${selectedCategoryName}`, 'success');
        }

        // ==========================================
        // üìù ÿØÿßŸÑÿ© ÿ•ŸÜÿ¥ÿßÿ° ÿπŸÜÿµÿ± ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ŸÖÿπ ÿ•ŸÖŸÉÿßŸÜŸäÿ© ÿßŸÑÿ™Ÿàÿ≥Ÿäÿπ
        // ==========================================
        function createDescriptionElement(product) {
            const description = product.description || 'ŸàÿµŸÅ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ∫Ÿäÿ± ŸÖÿ™ŸàŸÅÿ±';
            
            const descriptionContainer = document.createElement('div');
            descriptionContainer.className = 'product-description collapsed';
            
            const descriptionText = document.createElement('span');
            descriptionText.className = 'description-text';
            
            const readMoreToggle = document.createElement('button');
            readMoreToggle.className = 'read-more-toggle';
            
            const calculateOptimalChars = () => {
                const screenWidth = window.innerWidth;
                let charsPerLine;
                
                if (screenWidth < 768) {
                    charsPerLine = 35;
                } else if (screenWidth < 1024) {
                    charsPerLine = 50;
                } else {
                    charsPerLine = 70;
                }
                
                return charsPerLine;
            };
            
            const updateDescriptionDisplay = () => {
                const isExpanded = descriptionContainer.classList.contains('expanded');
                const optimalChars = calculateOptimalChars();
                
                if (isExpanded) {
                    descriptionText.textContent = description;
                    readMoreToggle.textContent = '... ÿπÿ±ÿ∂ ÿßŸÇŸÑ';
                } else {
                    if (description.length > optimalChars) {
                        descriptionText.textContent = description.substring(0, optimalChars);
                        readMoreToggle.textContent = '... ÿπÿ±ÿ∂ ÿßŸÉÿ´ÿ±';
                        readMoreToggle.style.display = 'inline';
                    } else {
                        descriptionText.textContent = description;
                        readMoreToggle.style.display = 'none';
                    }
                }
            };
            
            readMoreToggle.addEventListener('click', (e) => {
                e.stopPropagation();
                
                if (descriptionContainer.classList.contains('collapsed')) {
                    descriptionContainer.classList.remove('collapsed');
                    descriptionContainer.classList.add('expanded');
                } else {
                    descriptionContainer.classList.remove('expanded');
                    descriptionContainer.classList.add('collapsed');
                }
                
                updateDescriptionDisplay();
            });
            
            descriptionContainer.appendChild(descriptionText);
            descriptionContainer.appendChild(readMoreToggle);
            
            updateDescriptionDisplay();
            
            return descriptionContainer;
        }

        // ==========================================
        // üöÄ ŸÜÿ∏ÿßŸÖ ÿ™ÿ±ÿ™Ÿäÿ® ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØ
        // ==========================================
        function sortProductsByPriority(products) {
            const sortBy = sortSelect.value;
            
            if (sortBy && sortBy !== 'date' && sortBy !== 'preference' && sortBy !== 'offers') {
                return sortProductsByOption(products, sortBy);
            }
            
            if (sortBy === 'preference') {
                return sortProductsByPreference(products);
            }
            
            if (sortBy === 'offers') {
                return sortProductsByOffers(products);
            }
            
            return [...products].sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                
                return bDate - aDate;
            });
        }

        function sortProductsByOption(products, sortBy) {
            return [...products].sort((a, b) => {
                let result = 0;
                
                switch(sortBy) {
                    case 'name':
                        const nameA = (a.name || '').toLowerCase();
                        const nameB = (b.name || '').toLowerCase();
                        result = nameA.localeCompare(nameB, 'ar');
                        
                        if (result === 0) {
                            const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                            const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                            result = bDate - aDate;
                        }
                        break;
                    
                    case 'category':
                        const categoryA = getCategoryName(a.categoryId) || '';
                        const categoryB = getCategoryName(b.categoryId) || '';
                        result = categoryA.localeCompare(categoryB, 'ar');
                        
                        if (result === 0) {
                            const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                            const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                            result = bDate - aDate;
                            
                            if (result === 0) {
                                const nameA = (a.name || '').toLowerCase();
                                const nameB = (b.name || '').toLowerCase();
                                result = nameA.localeCompare(nameB, 'ar');
                            }
                        }
                        break;
                    
                    case 'price':
                        const priceA = parseFloat(a.price) || 0;
                        const priceB = parseFloat(b.price) || 0;
                        result = priceA - priceB;
                        
                        if (result === 0) {
                            const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                            const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                            result = bDate - aDate;
                        }
                        break;
                    
                    case 'merchant':
                        const merchantA = getMerchantName(a.userId) || '';
                        const merchantB = getMerchantName(b.userId) || '';
                        result = merchantA.localeCompare(merchantB, 'ar');
                        
                        if (result === 0) {
                            const nameA = (a.name || '').toLowerCase();
                            const nameB = (b.name || '').toLowerCase();
                            result = nameA.localeCompare(nameB, 'ar');
                            
                            if (result === 0) {
                                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                                result = bDate - aDate;
                            }
                        }
                        break;
                    
                    case 'date':
                    default:
                        const dateA = new Date(a.publishDate || a.createdAt || a.date || 0);
                        const dateB = new Date(b.publishDate || b.createdAt || b.date || 0);
                        result = dateB - dateA;
                        break;
                }
                
                return result;
            });
        }

        function sortProductsByPreference(products) {
            return [...products].sort((a, b) => {
                const aPreferenceScore = calculatePreferenceScoreWithViews(a);
                const bPreferenceScore = calculatePreferenceScoreWithViews(b);
                
                if (aPreferenceScore !== bPreferenceScore) {
                    return bPreferenceScore - aPreferenceScore;
                }
                
                const nameA = (a.name || '').toLowerCase();
                const nameB = (b.name || '').toLowerCase();
                return nameA.localeCompare(nameB, 'ar');
            });
        }

        function sortProductsByOffers(products) {
            return [...products].sort((a, b) => {
                const aIsOffer = isOfferValid(a);
                const bIsOffer = isOfferValid(b);
                
                if (aIsOffer && !bIsOffer) return -1;
                if (!aIsOffer && bIsOffer) return 1;
                
                const nameA = (a.name || '').toLowerCase();
                const nameB = (b.name || '').toLowerCase();
                return nameA.localeCompare(nameB, 'ar');
            });
        }

        function calculatePreferenceScoreWithViews(product) {
            let score = 0;
            
            if (product.categoryId && userInterests[product.categoryId]) {
                score += userInterests[product.categoryId] * 10;
            }
            
            if (favoriteProducts[product.id]) {
                score += 20;
            }
            
            const searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
            const productName = (product.name || '').toLowerCase();
            const productDesc = (product.description || '').toLowerCase();
            
            searchHistory.forEach(term => {
                if (productName.includes(term.toLowerCase()) || productDesc.includes(term.toLowerCase())) {
                    score += 5;
                }
            });
            
            if (userViewHistory[product.id]) {
                const viewTime = new Date(userViewHistory[product.id]);
                const now = new Date();
                const hoursSinceView = (now - viewTime) / (1000 * 60 * 60);
                
                if (hoursSinceView < 1) {
                    score += 30;
                } else if (hoursSinceView < 24) {
                    score += 20;
                } else if (hoursSinceView < 72) {
                    score += 10;
                }
            }
            
            return score;
        }

        function calculatePreferenceScore(product) {
            return calculatePreferenceScoreWithViews(product);
        }

        function getCategoryName(categoryId) {
            const category = allCategories.find(c => c.id === categoryId);
            return category ? category.name : '';
        }

        function getMerchantName(merchantId) {
            const merchant = allMerchants.find(m => m.id === merchantId);
            return merchant ? (merchant.name || merchant.username) : '';
        }

        function displayFavoriteProducts() {
            productsContainer.innerHTML = '';
            
            const favoriteProductIds = Object.keys(favoriteProducts);
            const favoriteProductsList = allProducts.filter(p => favoriteProductIds.includes(p.id));
            
            if (favoriteProductsList.length === 0) {
                productsContainer.innerHTML = `
                    <div class="no-products">
                        <p>ŸÑÿß ÿ™Ÿàÿ¨ÿØ ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÅŸä ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©</p>
                        <p>ŸäŸÖŸÉŸÜŸÉ ÿ•ÿ∂ÿßŸÅÿ© ŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿ•ŸÑŸâ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ© ÿ®ÿßŸÑŸÜŸÇÿ± ÿπŸÑŸâ ÿ£ŸäŸÇŸàŸÜÿ© ÿßŸÑŸÇŸÑÿ® ŸÅŸä ÿßŸÑÿ®ÿ∑ÿßŸÇÿßÿ™</p>
                        <button onclick="closeFavoritesView()" style="margin-top:10px;padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer">ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑÿπÿßÿØŸä</button>
                    </div>
                `;
                return;
            }

            const favoritesTitle = document.createElement('h2');
            favoritesTitle.style.textAlign = 'center';
            favoritesTitle.style.margin = '20px 0';
            favoritesTitle.style.color = 'var(--primary-color)';
            favoritesTitle.textContent = 'ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©';
            productsContainer.appendChild(favoritesTitle);

            const favoritesGrid = document.createElement('div');
            favoritesGrid.className = 'products';
            
            const groupedFavorites = groupProductsByCategory(favoriteProductsList);
            displayGroupedProducts(groupedFavorites);

            const backButton = document.createElement('div');
            backButton.style.textAlign = 'center';
            backButton.style.margin = '20px 0';
            backButton.innerHTML = `
                <button onclick="closeFavoritesView()" style="padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:16px;">
                    ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑÿπÿßÿØŸä
                </button>
            `;
            productsContainer.appendChild(backButton);
        }

        function closeFavoritesView() {
            showFavoritesOnly = false;
            filterProducts();
            showNotification('ÿ™ŸÖ ÿßŸÑÿπŸàÿØÿ© ŸÑŸÑÿπÿ±ÿ∂ ÿßŸÑÿπÿßÿØŸä', 'info');
        }

        function displayPersonalizedProducts() {
            if (Object.keys(userInterests).length > 0) {
                const personalizedProducts = getPersonalizedProducts();
                if (personalizedProducts.length > 0 && !showFavoritesOnly) {
                    console.log('ŸÖŸÜÿ™ÿ¨ÿßÿ™ ŸÖÿÆÿµÿµÿ© ŸÖÿ™ÿßÿ≠ÿ©:', personalizedProducts.length);
                }
            }
        }

        function getPersonalizedProducts() {
            const favoriteCategories = Object.keys(userInterests)
                .sort((a, b) => userInterests[b] - userInterests[a])
                .slice(0, 3);

            return allProducts.filter(p => {
                const merchant = allMerchants.find(m => m.id === p.userId);
                if (!merchant) return false;
                const isActive = merchant.status === "active" || merchant.status === "ŸÜÿ¥ÿ∑";
                const isMerchant = merchant.job === "ÿ™ÿßÿ¨ÿ±" || merchant.type === "ÿ™ÿßÿ¨ÿ±";
                if (!isActive || !isMerchant) return false;

                return favoriteCategories.includes(p.categoryId);
            });
        }

        // ==========================================
        // üîß ÿ•ÿµŸÑÿßÿ≠ ŸÖÿ¥ŸÉŸÑÿ© ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÅŸÑÿßÿ™ÿ±
        // ==========================================
        function setupFilterBarAutoHide() {
            document.addEventListener('click', function(event) {
                const filterBar = document.getElementById('filter-bar');
                const secondaryBar = document.querySelector('.secondary-bar');
                const filterControlBtn = document.getElementById('filter-control');
                const showMoreBtn = document.getElementById('show-more-btn');
                
                if (filterBar.style.display === 'flex') {
                    const isClickInsideFilterBar = filterBar.contains(event.target);
                    const isClickInsideSecondaryBar = secondaryBar.contains(event.target);
                    const isClickOnFilterControl = filterControlBtn.contains(event.target);
                    const isClickOnShowMoreBtn = showMoreBtn.contains(event.target);
                    
                    if (!isClickInsideFilterBar && !isClickInsideSecondaryBar && 
                        !isClickOnFilterControl && !isClickOnShowMoreBtn) {
                        hideFilterBar();
                    }
                }
            });
        }

        function toggleFilterBar() {
            if (filterBar.style.display === 'flex' || filterBar.style.display === '') {
                hideFilterBar();
            } else {
                showFilterBar();
            }
        }

        function hideFilterBar() {
            filterBar.style.display = 'none';
            document.body.style.paddingTop = '128px';
            localStorage.setItem('filterBarHidden', 'true');
            filterControlBtn.innerHTML = '<i class="fas fa-sliders-h"></i>';
            filterControlBtn.title = 'ÿ•ÿ∏Ÿáÿßÿ± ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÅŸÑÿßÿ™ÿ±';
            showMoreBtn.innerHTML = '<i class="fas fa-bars"></i> ÿπÿ±ÿ∂ ÿ£ŸÉÿ´ÿ±';
            showNotification('ÿ™ŸÖ ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÅŸÑÿßÿ™ÿ±', 'info');
        }

        function showFilterBar() {
            filterBar.style.display = 'flex';
            document.body.style.paddingTop = '180px';
            localStorage.setItem('filterBarHidden', 'false');
            filterControlBtn.innerHTML = '<i class="fas fa-times"></i>';
            filterControlBtn.title = 'ÿ•ÿÆŸÅÿßÿ° ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÅŸÑÿßÿ™ÿ±';
            showMoreBtn.innerHTML = '<i class="fas fa-times"></i> ÿ•ÿÆŸÅÿßÿ°';
            showNotification('ÿ™ŸÖ ÿ•ÿ∏Ÿáÿßÿ± ÿ¥ÿ±Ÿäÿ∑ ÿßŸÑŸÅŸÑÿßÿ™ÿ±', 'success');
        }

        // ==========================================
        // üîó ŸÜÿ∏ÿßŸÖ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© ÿßŸÑŸÖÿ≠ÿ≥ŸÜ
        // ==========================================
        let currentShareProductId = null;
        let currentShareProductName = '';

        function openShareModal(productId, productName) {
            currentShareProductId = productId;
            currentShareProductName = productName;
            shareModal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeShareModal() {
            shareModal.classList.remove('active');
            document.body.style.overflow = '';
            currentShareProductId = null;
            currentShareProductName = '';
        }

        function handleShareOption(e) {
            const platform = e.currentTarget.dataset.platform;
            shareProduct(currentShareProductId, currentShareProductName, platform);
            closeShareModal();
        }

        function shareProduct(productId, productName = '', platform = 'other') {
            const product = allProducts.find(p => p.id === productId);
            const merchant = product ? allMerchants.find(m => m.id === product.userId) : null;
            const merchantName = merchant ? (merchant.name || merchant.username || "ÿ™ÿßÿ¨ÿ±") : "ÿ™ÿßÿ¨ÿ±";
            const productPrice = product ? (product.price ? `${product.price} ÿ±ŸäÿßŸÑ ŸäŸÖŸÜŸä` : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ') : 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            const productUrl = `${window.location.origin}${window.location.pathname}?productId=${productId}`;
            const productImage = product ? extractImageUrls(product)[0] : '';

            const shareText = `ŸÖÿ±ÿ≠ÿ®ÿ¢ 
ÿßŸÑÿßŸÜ Ÿàÿ≠ÿµÿ±Ÿä ÿπŸÑŸâ ŸÖŸÜÿµÿ© AZ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ¥ÿßŸÖŸÑ ŸÑÿ™ŸÑÿ®Ÿäÿ© ÿßÿ≠ÿ™Ÿäÿßÿ¨ŸÉ ÿ®ÿßŸÑŸÉÿßŸÖŸÑ
ÿßŸàŸÑ ÿ≥ŸàŸÇ ÿ™ÿ¨ÿßÿ±Ÿä Ÿäÿ≠ÿ™ŸàŸä ÿπŸÑŸâ 
ŸÇÿ≥ŸÖ ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ™ÿ¨ÿßÿ±Ÿäÿ© ÿßŸÑÿ¨ÿØŸäÿØÿ© 
ŸÇÿ≥ŸÖ ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖÿ© - ÿßŸÑÿ≠ÿ±ÿßÿ¨
ŸÇÿ≥ŸÖ ŸÑŸÑŸÖÿ®ÿßŸÜŸä ŸàÿßŸÑÿπŸÇÿßÿ±ÿßÿ™ Ÿàÿ™ÿ£ÿ¨Ÿäÿ± ÿßŸÑÿ¥ŸÇŸÇ
ŸÇÿ≥ŸÖ ÿßŸÑŸàÿ∏ÿßÿ¶ŸÅ ÿßŸÑÿ¥ÿßÿ∫ÿ±ÿ©
ŸÇÿ≥ŸÖ ÿßŸÑÿ∑ŸÑÿ® ŸàÿßŸÑÿ™ŸàÿµŸäŸÑ ÿßŸÑÿ≥ÿ±Ÿäÿπ ŸÑŸÑŸÖÿ∑ÿßÿπŸÖ ŸàÿßŸÑÿ®ŸàÿßŸÅŸä ŸàÿßŸÑŸÑÿ≠ŸàŸÖ
ŸÇÿ≥ŸÖ ŸÖŸàŸÇÿπ Ÿàÿ£ÿ±ŸÇÿßŸÖ ÿ£ÿ¥ÿÆÿßÿµ ÿ™ŸáŸÖŸÉ 
ŸÖÿπ AZ ŸÖÿ™ÿπÿ© ÿßŸÑÿ™ÿ≥ŸàŸÇ

ÿ£ÿπÿ¨ÿ®ŸÜŸä ŸÖŸÜÿ™ÿ¨ / ${productName} - ${productPrice}
ÿßŸÑÿπÿ±ÿ∂ ŸÖŸÇÿØŸÖ ŸÖŸÜ ÿßŸÑÿ™ÿßÿ¨ÿ± / ${merchantName}
ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖŸÜÿ™ÿ¨: ${productUrl}`;

            const shareUrls = {
                whatsapp: `https://wa.me/?text=${encodeURIComponent(shareText)}`,
                facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(productUrl)}&quote=${encodeURIComponent(shareText)}`,
                twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(productUrl)}`,
                telegram: `https://t.me/share/url?url=${encodeURIComponent(productUrl)}&text=${encodeURIComponent(shareText)}`,
                copy: null,
                other: null
            };

            switch(platform) {
                case 'whatsapp':
                case 'facebook':
                case 'twitter':
                case 'telegram':
                    window.open(shareUrls[platform], '_blank', 'width=600,height=400');
                    showNotification(`ÿ™ŸÖ ŸÅÿ™ÿ≠ ${platform} ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©', 'success`);
                    break;
                
                case 'copy':
                    copyToClipboard(shareText);
                    showNotification('ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©', 'success');
                    break;
                
                case 'other':
                default:
                    if (navigator.share) {
                        navigator.share({ 
                            title: `AZ ÿßŸÑÿ≥ŸàŸÇ ÿßŸÑÿ¥ÿßŸÖŸÑ - ${productName}`, 
                            text: shareText, 
                            url: productUrl 
                        })
                        .then(() => showNotification('ÿ™ŸÖÿ™ ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ© ÿ®ŸÜÿ¨ÿßÿ≠', 'success'))
                        .catch(err => {
                            console.log('ÿÆÿ∑ÿ£ ŸÅŸä ÿßŸÑŸÖÿ¥ÿßÿ±ŸÉÿ©:', err);
                            copyToClipboard(shareText);
                        });
                    } else {
                        copyToClipboard(shareText);
                    }
                    break;
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .then(() => {
                    showNotification('ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©', 'success');
                })
                .catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    showNotification('ÿ™ŸÖ ŸÜÿ≥ÿÆ ÿ±ÿßÿ®ÿ∑ ÿßŸÑŸÖŸÜÿ™ÿ¨ ÿ•ŸÑŸâ ÿßŸÑÿ≠ÿßŸÅÿ∏ÿ©', 'success');
                });
        }

        // ==========================================
        // üéØ ÿ™ÿπÿØŸäŸÑ ÿØÿßŸÑÿ© ŸÅÿ™ÿ≠ ÿµŸÅÿ≠ÿ© ÿßŸÑÿ™ÿßÿ¨ÿ±
        // ==========================================
        function openMerchantPage() {
            window.location.href = 'ard_tagr.html';
        }

        function formatDate(dateString) {
            if (!dateString) return 'ÿ∫Ÿäÿ± ŸÖÿ≠ÿØÿØ';
            try { 
                return new Date(dateString).toLocaleDateString('ar-EG'); 
            } catch { 
                return dateString; 
            }
        }

        function escapeHtml(text) { 
            const div = document.createElement('div'); 
            div.textContent = text; 
            return div.innerHTML; 
        }

        // ==========================================
        // üîÑ ŸÜÿ∏ÿßŸÖ ÿßŸÑÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ™ŸÑŸÇÿßÿ¶Ÿä ŸÑŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™ ÿßŸÑÿ¨ÿØŸäÿØÿ©
        // ==========================================
        function startAutoUpdate() {
            db.ref("products").on("value", (snapshot) => {
                const newProducts = convertFirebaseData(snapshot.val()) || [];
                
                if (newProducts.length !== allProducts.length) {
                    console.log('üîÑ ÿ™ŸÖ ÿßŸÉÿ™ÿ¥ÿßŸÅ ÿ™ÿ∫ŸäŸäÿ± ŸÅŸä ÿßŸÑŸÖŸÜÿ™ÿ¨ÿßÿ™!');
                    
                    const previousCount = allProducts.length;
                    
                    allProducts = newProducts;
                    
                    saveDataToCache();
                    
                    if (!showFavoritesOnly) {
                        displayProducts(allProducts);
                        
                        if (newProducts.length > previousCount) {
                            const newProductsCount = newProducts.length - previousCount;
                            const notificationMessage = `ÿ™ŸÖ ÿ™ÿ≠ÿØŸäÿ´ ${newProductsCount} ŸÖŸÜÿ™ÿ¨ ÿ¨ÿØŸäÿØ`;
                            showNotification(notificationMessage, 'success');
                            
                            playNotificationSound();
                        }
                    }
                }
            });
        }

        // ==========================================
        // üé≤ ÿØŸàÿßŸÑ ŸÖÿ≥ÿßÿπÿØÿ© ŸÑŸÑÿ£ÿ±ŸÇÿßŸÖ ÿßŸÑÿπÿ¥Ÿàÿßÿ¶Ÿäÿ©
        // ==========================================
        function getRandomInt(min, max) {
            return Math.floor(Math.random() * (max - min + 1)) + min;
        }

        // ÿßÿ™ÿµÿßŸÑ ÿßŸÑÿ¥ÿ®ŸÉÿ©
        window.addEventListener('online', () => { 
            console.log('ÿßŸÑÿßÿ™ÿµÿßŸÑ ŸÖÿ™ŸàŸÅÿ± - ÿ™ÿ≠ÿØŸäÿ´ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™'); 
            loadAllData(); 
        });
        
        window.addEventListener('offline', () => { 
            console.log('ŸÑÿß ŸäŸàÿ¨ÿØ ÿßÿ™ÿµÿßŸÑ - ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ÿßŸÑŸÖÿ≠ŸÑŸäÿ©'); 
        });

        // ÿ™ŸÜÿ∏ŸäŸÅ ÿßŸÑŸÅÿßÿµŸÑ ÿßŸÑÿ≤ŸÖŸÜŸä ŸÑŸÑÿ•ÿπŸÑÿßŸÜÿßÿ™ ÿπŸÜÿØ ÿ•ÿ∫ŸÑÿßŸÇ ÿßŸÑÿµŸÅÿ≠ÿ©
        window.addEventListener('beforeunload', () => {
            cleanupAllIntervals();
        });
    </script>
</body>
</html>
