
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZ السوق الشامل - سوق تجاري متكامل</title>
    <meta name="description" content="AZ السوق الشامل - منصة تجارية متكاملة تحتوي على المنتجات الجديدة والمستعملة، العقارات، الوظائف، توصيل المطاعم والبوفيهات، وأرقام مهمة">
    <meta name="keywords" content="AZ السوق الشامل, سوق تجاري, منتجات جديدة, منتجات مستعملة, حراج, عقارات, شقق للإيجار, وظائف شاغرة, توصيل طعام, مطاعم, بوفيهات, لحوم, تسوق">
    <meta name="author" content="AZ السوق الشامل">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --danger-color: #e74c3c;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --background-color: #ffffff;
            --text-color: #333;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transition: all 0.25s ease;
        }
        [data-theme="dark"] {
            --primary-color: #3498db;
            --secondary-color: #2980b9;
            --background-color: #121212;
            --text-color: #ecf0f1;
            --light-color: #2c3e50;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding-top: 128px;
            padding-bottom: 40px;
            transition: var(--transition);
            width: 100%;
            overflow-x: hidden;
        }
        /* إضافة شارة عرض خاص للصور المصغرة المطابقة */
        .matching-product-offer {
            position: absolute;
            top: 8px;
            left: 8px;
            background: linear-gradient(135deg, #2ecc71, #27ae60, #1e8449);
            color: white;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 10px;
            font-weight: bold;
            z-index: 3;
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.5);
            animation: pulseOffer 2s infinite;
            display: flex;
            align-items: center;
            gap: 5px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            white-space: nowrap;
        }
        .matching-product-offer i {
            font-size: 9px;
            animation: spinStar 3s linear infinite;
        }
        
        .matching-products-container {
            width: 100%;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            padding: 15px 0;
            margin: 20px 0;
            border-top: 1px solid #eee;
            border-bottom: 1px solid #eee;
            direction: ltr;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
            cursor: grab;
            position: relative;
            background-color: #ffffff;
            border-radius: 10px;
        }
        .matching-products-container::-webkit-scrollbar { display: none; }
        .matching-products-scroll {
            display: inline-flex;
            gap: 20px;
            direction: rtl;
            padding: 0 15px;
        }
        .matching-product-item {
            display: inline-block;
            width: 140px;
            text-align: center;
            cursor: pointer;
            flex-shrink: 0;
            transition: var(--transition);
            position: relative;
            background: var(--background-color);
            border-radius: 12px;
            padding: 10px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border: 2px solid #e74c3c;
        }
        .matching-product-item.has-offer {
            border: 2px solid #2ecc71;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.2);
        }
        .matching-product-item:hover {
            transform: translateY(-5px) scale(1.03);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            border-color: var(--primary-color);
        }
        .matching-product-item.has-offer:hover {
            border-color: #2ecc71;
            box-shadow: 0 8px 25px rgba(46, 204, 113, 0.3);
        }
        .matching-product-image {
            width: 100%;
            height: 100px;
            object-fit: cover;
            border-radius: 8px;
            border: 2px solid var(--primary-color);
            transition: var(--transition);
        }
        .matching-product-item.has-offer .matching-product-image {
            border: 2px solid #2ecc71;
        }
        .matching-product-item:hover .matching-product-image { border-color: #667eea; transform: scale(1.05); }
        .matching-product-name {
            font-size: 12px;
            margin-top: 8px;
            white-space: normal;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            white-space: normal;
            color: var(--text-color);
            font-weight: bold;
            height: 32px;
            line-height: 1.2;
        }
        .matching-product-price {
            font-size: 11px;
            color: var(--primary-color);
            font-weight: bold;
            margin-top: 5px;
            background: rgba(52, 152, 219, 0.1);
            padding: 3px 8px;
            border-radius: 12px;
            display: inline-block;
        }
        .matching-product-item.has-offer .matching-product-price {
            color: #2ecc71;
            background: rgba(46, 204, 113, 0.1);
        }
        .no-matches {
            color: #7f8c8d;
            font-style: italic;
            padding: 10px;
            text-align: center;
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            direction: rtl;
        }
        
        .merchant-btn {
            background: rgba(52, 152, 219, 0.15);
            color: white;
            border: none;
            padding: 12px 15px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
            font-size: 16px;
            text-align: center;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            margin: 10px 0;
            box-shadow: 0 4px 15px rgba(52, 152, 219, 0.2);
            position: relative;
            overflow: hidden;
            gap: 15px;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }
        .merchant-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: 0.5s;
        }
        .merchant-btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(52, 152, 219, 0.3); background: rgba(52, 152, 219, 0.25); }
        .merchant-btn:hover::before { left: 100%; }
        .merchant-name-center {
            display: block;
            font-size: 14px;
            font-weight: bold;
            color: #000000 !important;
            text-align: center;
            width: 100%;
            margin-top: 5px;
        }
        .underline-border {
            display: block;
            font-size: 16px;
            font-weight: bold;
            color: #e74c3c !important;
            text-align: center;
            width: 100%;
            padding-bottom: 5px;
            border-bottom: 2px solid rgba(231, 76, 60, 0.3);
        }
        
        /* تحديث شكل صورة الشعار - أكبر وأكثر دائرية مع إطار شفاف */
        .merchant-logo-rectangle {
            width: 85px; /* أكبر من السابق */
            height: 85px; /* مربع الشكل */
            object-fit: cover;
            border-radius: 18px; /* حواف دائرية أكثر */
            border: 2px solid rgba(231, 76, 60, 0.3); /* إطار شفاف بنفس لون الخط */
            box-shadow: 0 3px 15px rgba(231, 76, 60, 0.15);
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.95);
            padding: 5px;
            flex-shrink: 0;
        }
        
        .merchant-logo-rectangle:hover {
            transform: scale(1.05);
            border-color: rgba(231, 76, 60, 0.5);
            box-shadow: 0 5px 20px rgba(231, 76, 60, 0.25);
        }
        
        .merchant-with-logo {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 15px;
            width: 100%;
        }
        
        .merchant-btn-content {
            text-align: right;
            flex: 1;
            min-width: 0;
        }
        
        /* تعديل موقع نص عرض أكثر/عرض أقل */
        .read-more-toggle {
            background: none;
            border: none;
            color: #3498db;
            cursor: pointer;
            font-weight: bold;
            margin-left: 5px; /* تغيير من margin-right إلى margin-left */
            padding: 0;
            text-decoration: none;
            float: left; /* جعله على اليسار */
            direction: ltr; /* تغيير الاتجاه */
            order: -1; /* جعله يظهر أولاً في ترتيب العرض */
        }
        
        .read-more-toggle:hover { color: #2980b9; }
        
        .product-detail-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
            direction: ltr; /* تغيير الاتجاه */
            flex-direction: row-reverse; /* عكس الترتيب */
        }
        
        .product-detail-item .label {
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 10px; /* تغيير من margin-right إلى margin-left */
            text-align: left; /* محاذاة لليسار */
            flex-shrink: 0;
        }
        
        .description-text {
            flex: 1;
            text-align: right; /* النص الأصلي يبقى على اليمين */
            direction: rtl;
        }
        
        .merchant-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3001;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .merchant-modal-overlay.active { opacity: 1; visibility: visible; }
        .merchant-modal {
            background-color: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(30px);
            transition: transform 0.3s ease;
        }
        .merchant-modal-overlay.active .merchant-modal { transform: translateY(0); }
        .merchant-modal-header {
            background: linear-gradient(135deg, #3b82f6, #1e40af);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .merchant-modal-title { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .merchant-modal-subtitle { opacity: 0.9; font-size: 16px; }
        .merchant-modal-body { padding: 25px; max-height: 50vh; overflow-y: auto; }
        .merchant-modal-controls { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        .merchant-modal-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            flex: 1;
        }
        .merchant-modal-btn-all { background-color: #10b981; color: white; }
        .merchant-modal-btn-all:hover { background-color: #059669; }
        .merchant-modal-btn-cancel { background-color: #e2e8f0; color: #475569; }
        .merchant-modal-btn-cancel:hover { background-color: #cbd5e1; }
        .merchant-modal-btn-confirm { background-color: #3b82f6; color: white; }
        .merchant-modal-btn-confirm:hover { background-color: #1d4ed8; }
        .merchant-modal-btn-confirm:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .merchant-modal-search { margin-bottom: 20px; }
        .merchant-modal-search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: inherit;
            font-size: 16px;
            text-align: right;
        }
        .merchant-modal-search-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .merchants-modal-list { display: flex; flex-direction: column; gap: 10px; }
        .merchant-modal-item {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .merchant-modal-item:hover { background-color: #f0f9ff; border-color: #3b82f6; transform: translateY(-2px); }
        .merchant-modal-item.selected { background-color: #dbeafe; border-color: #3b82f6; }
        .merchant-modal-item-name { font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 5px; }
        .merchant-modal-item-phone { font-size: 14px; color: #64748b; display: flex; align-items: center; gap: 8px; margin-top: 8px; }
        .merchant-modal-footer {
            padding: 20px 25px;
            background-color: #f8fafc;
            border-top: 1px solid #e2e8f0;
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }
        .merchant-modal-footer-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            flex: 1;
        }
        .merchant-modal-footer-cancel { background-color: #e2e8f0; color: #475569; }
        .merchant-modal-footer-cancel:hover { background-color: #cbd5e1; }
        .merchant-modal-footer-confirm { background-color: #3b82f6; color: white; }
        .merchant-modal-footer-confirm:hover { background-color: #1d4ed8; }
        .merchant-modal-footer-confirm:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .merchant-text-field { position: relative; width: 100%; }
        .merchant-text-input {
            width: 100%;
            padding: 8px 40px 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            text-align: right;
            transition: all 0.3s;
            color: #333;
        }
        .merchant-text-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .merchant-text-input::placeholder { color: #999; }
        .merchant-text-field-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }
        .category-text-field { position: relative; width: 100%; }
        .category-text-input {
            width: 100%;
            padding: 8px 40px 8px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
            background-color: white;
            cursor: pointer;
            text-align: right;
            transition: all 0.3s;
            color: #333;
        }
        .category-text-input:focus { outline: none; border-color: #3b82f6; box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1); }
        .category-text-input::placeholder { color: #999; }
        .category-text-field-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
            pointer-events: none;
        }
        .category-modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3002;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            backdrop-filter: blur(5px);
        }
        .category-modal-overlay.active { opacity: 1; visibility: visible; }
        .category-modal {
            background-color: white;
            border-radius: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            transform: translateY(30px);
            transition: transform 0.3s ease;
        }
        .category-modal-overlay.active .category-modal { transform: translateY(0); }
        .category-modal-header {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
            padding: 25px;
            text-align: center;
        }
        .category-modal-title { font-size: 24px; font-weight: 700; margin-bottom: 10px; }
        .category-modal-subtitle { opacity: 0.9; font-size: 16px; }
        .category-modal-body { padding: 25px; max-height: 50vh; overflow-y: auto; }
        .category-modal-controls { display: flex; justify-content: space-between; gap: 10px; margin-bottom: 20px; }
        .category-modal-btn {
            padding: 12px 24px;
            border-radius: 12px;
            font-family: inherit;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            flex: 1;
        }
        .category-modal-btn-all { background-color: #3b82f6; color: white; }
        .category-modal-btn-all:hover { background-color: #1d4ed8; }
        .category-modal-btn-cancel { background-color: #e2e8f0; color: #475569; }
        .category-modal-btn-cancel:hover { background-color: #cbd5e1; }
        .category-modal-btn-confirm { background-color: #10b981; color: white; }
        .category-modal-btn-confirm:hover { background-color: #059669; }
        .category-modal-btn-confirm:disabled { background-color: #94a3b8; cursor: not-allowed; }
        .category-modal-search { margin-bottom: 20px; }
        .category-modal-search-input {
            width: 100%;
            padding: 12px 20px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-family: inherit;
            font-size: 16px;
            text-align: right;
        }
        .category-modal-search-input:focus { outline: none; border-color: #10b981; box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1); }
        .categories-modal-list { display: flex; flex-direction: column; gap: 10px; }
        .category-modal-item {
            background-color: #f8fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }
        .category-modal-item:hover { background-color: #f0fdf4; border-color: #10b981; transform: translateY(-2px); }
        .category-modal-item.selected { background-color: #d1fae5; border-color: #10b981; }
        .category-modal-item-name { font-size: 18px; font-weight: 600; color: #1e293b; margin-bottom: 5px; }
        .category-modal-item-count { font-size: 14px; color: #64748b; display: flex; align-items: center; gap: 8px; margin-top: 8px; }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: var(--box-shadow);
        }
        .header-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        .brand { display: flex; align-items: center; gap: 12px; }
        .brand-logo { width: 50px; height: 50px; object-fit: contain; border-radius: 10px; background: white; padding: 4px; border: 2px solid white; }
        .brand-text { display: flex; flex-direction: column; gap: 4px; }
        .brand-title { font-size: 20px; font-weight: bold; margin: 0; }
        .brand-subtitle { font-size: 14px; color: rgba(255, 255, 255, 0.9); }
        .header-right { display: flex; flex-direction: column; align-items: flex-end; gap: 8px; }
        .header-category { display: none; }
        .header-login {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            cursor: pointer;
            text-decoration: none;
            order: 1;
        }
        .header-login:hover { background: rgba(255, 255, 255, 0.3); transform: translateY(-1px); }
        .header-online-users {
            background: rgba(255, 255, 255, 0.2);
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: var(--transition);
            cursor: pointer;
            order: 2;
        }
        .header-online-users.active { background: var(--success-color); animation: pulse 2s infinite; }
        .header-online-users.increase { animation: flashGreen 1s ease-in-out; }
        .header-online-users.decrease { animation: flashRed 1s ease-in-out; }
        @keyframes flashGreen {
            0% { background: rgba(255, 255, 255, 0.2); }
            25% { background: var(--success-color); transform: scale(1.05); }
            50% { background: rgba(255, 255, 255, 0.2); }
            75% { background: var(--success-color); transform: scale(1.05); }
            100% { background: rgba(255, 255, 255, 0.2); transform: scale(1); }
        }
        @keyframes flashRed {
            0% { background: rgba(255, 255, 255, 0.2); }
            25% { background: var(--danger-color); transform: scale(1.05); }
            50% { background: rgba(255, 255, 255, 0.2); }
            75% { background: var(--danger-color); transform: scale(1.05); }
            100% { background: rgba(255, 255, 255, 0.2); transform: scale(1); }
        }
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }
        .secondary-bar {
            position: fixed;
            top: 84px;
            left: 0;
            width: 100%;
            background: var(--dark-color);
            padding: 8px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            color: white;
        }
        .secondary-bar-content {
            display: flex;
            align-items: center;
            justify-content: space-between;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }
        .secondary-bar-left { display: flex; align-items: center; gap: 15px; }
        .secondary-bar-right { display: flex; align-items: center; gap: 10px; }
        .secondary-category { display: flex; align-items: center; gap: 6px; color: white; }
        .secondary-category label { font-size: 14px; white-space: nowrap; color: white; }
        .secondary-category-text-field { position: relative; }
        .secondary-category-text-input {
            padding: 6px 10px;
            border-radius: var(--border-radius);
            border: 1px solid rgba(255, 255, 255, 0.3);
            font-size: 14px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            transition: var(--transition);
            min-width: 150px;
            width: 100%;
            text-align: right;
            cursor: pointer;
        }
        .secondary-category-text-input::placeholder { color: rgba(255, 255, 255, 0.7); }
        .secondary-category-text-field-icon {
            position: absolute;
            left: 8px;
            top: 50%;
            transform: translateY(-50%);
            color: rgba(255, 255, 255, 0.7);
            pointer-events: none;
        }
        .products-count {
            font-size: 14px;
            font-weight: bold;
            color: white;
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 15px;
        }
        .online-users-real {
            font-size: 14px;
            font-weight: bold;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255, 255, 255, 0.1);
            padding: 6px 12px;
            border-radius: 15px;
            text-shadow: 0 0 8px rgba(255, 255, 255, 0.5);
            transition: var(--transition);
        }
        .online-users-real:hover { color: rgba(255, 255, 255, 0.9); text-shadow: 0 0 12px rgba(255, 255, 255, 0.7); }
        .show-more-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
        }
        .show-more-btn:hover { background: rgba(255, 255, 255, 0.3); }
        .secondary-favorites {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            border-radius: 50%;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }
        .secondary-favorites:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .offer-badge {
            position: absolute;
            top: 10px;
            left: 10px;
            background: linear-gradient(135deg, #2ecc71, #27ae60, #1e8449);
            color: white;
            padding: 10px 18px;
            border-radius: 25px;
            font-size: 14px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(46, 204, 113, 0.5);
            animation: pulseOffer 2s infinite, floatOffer 3s ease-in-out infinite;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            border: 2px solid rgba(255, 255, 255, 0.3);
            transition: var(--transition);
            transform-style: preserve-3d;
            perspective: 1000px;
        }
        .offer-badge:hover { transform: translateY(-3px) scale(1.05); box-shadow: 0 6px 20px rgba(46, 204, 113, 0.7); }
        .offer-badge::before {
            content: '';
            position: absolute;
            top: -5px;
            left: -5px;
            right: -5px;
            bottom: -5px;
            background: linear-gradient(135deg, #2ecc71, #27ae60, #1e8449);
            border-radius: 30px;
            z-index: -1;
            opacity: 0.3;
            animation: pulseRing 2s ease-out infinite;
        }
        .offer-badge i { font-size: 14px; animation: spinStar 3s linear infinite; }
        @keyframes pulseOffer { 0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); } }
        @keyframes floatOffer { 0% { transform: translateY(0px); } 50% { transform: translateY(-5px); } 100% { transform: translateY(0px); } }
        @keyframes pulseRing { 0% { transform: scale(0.8); opacity: 0.5; } 80% { transform: scale(1.2); opacity: 0; } 100% { transform: scale(1.2); opacity: 0; } }
        @keyframes spinStar { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .offer-dates {
            position: absolute;
            top: 50px;
            left: 10px;
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            color: white;
            padding: 6px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: bold;
            z-index: 10;
            box-shadow: 0 2px 8px rgba(46, 204, 113, 0.4);
            display: flex;
            flex-direction: column;
            gap: 2px;
            max-width: 180px;
            display: none;
        }
        .offer-dates div { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
        .offer-dates i { font-size: 10px; }
        .new-products-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .new-products-modal.active { display: flex; }
        .new-products-content {
            background: linear-gradient(135deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 25px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
            animation: slideUp 0.4s ease-out;
            border: 2px solid var(--primary-color);
            color: white;
            max-height: 80vh;
            overflow-y: auto;
        }
        .new-products-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary-color);
        }
        .new-products-title { font-size: 22px; font-weight: bold; color: var(--success-color); display: flex; align-items: center; gap: 10px; }
        .new-products-close {
            background: var(--danger-color);
            color: white;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }
        .new-products-close:hover { transform: scale(1.1); background: #c0392b; }
        .new-products-list { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .new-product-item {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: var(--transition);
            cursor: pointer;
        }
        .new-product-item:hover { background: rgba(255, 255, 255, 0.15); transform: translateY(-2px); }
        .merchant-name { font-size: 18px; font-weight: bold; color: var(--primary-color); margin-bottom: 8px; display: flex; align-items: center; gap: 8px; }
        .products-count-badge { background: var(--success-color); color: white; padding: 4px 10px; border-radius: 15px; font-size: 12px; font-weight: bold; }
        .new-products-footer {
            text-align: center;
            padding-top: 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }
        .filter-bar {
            position: fixed;
            top: 128px;
            left: 0;
            width: 100%;
            background: var(--light-color);
            padding: 10px 20px;
            display: none;
            flex-wrap: wrap;
            gap: 10px;
            z-index: 998;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            align-items: center;
            transition: var(--transition);
        }
        .filter-item { display: flex; align-items: center; gap: 5px; }
        .filter-item label { font-weight: bold; font-size: 14px; white-space: nowrap; }
        .filter-item select, .filter-item input {
            padding: 6px 10px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            font-size: 14px;
            background: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
        }
        .filter-item input { width: 200px; }
        .search-container { display: flex; align-items: center; gap: 5px; }
        .search-container input { flex: 1; }
        .voice-search-btn {
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
        }
        .voice-search-btn:hover { background: #27ae60; }
        .voice-search-btn.listening { background: var(--danger-color); animation: pulse 1.5s infinite; }
        .reset-btn {
            padding: 8px 12px;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 5px;
            background: var(--primary-color);
            color: white;
            position: relative;
        }
        .reset-btn .tooltip {
            visibility: hidden;
            width: 120px;
            background-color: var(--dark-color);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 12px;
        }
        .reset-btn:hover .tooltip { visibility: visible; opacity: 1; }
        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: #3498db;
            color: white;
            text-align: center;
            padding: 8px 15px;
            z-index: 1000;
            font-size: 14px;
            overflow: hidden;
            user-select: none;
            cursor: default;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .footer-content {
            display: flex;
            justify-content: center;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            height: 30px;
            width: 100%;
        }
        .footer-text {
            white-space: nowrap;
            position: relative;
            font-size: 16px;
            font-weight: bold;
            padding: 8px 15px;
            border-radius: 20px;
            background: transparent;
            color: white;
            text-shadow: 0 0 10px rgba(255, 255, 255, 0.7);
            overflow: visible;
            width: auto;
            max-width: 90%;
            margin: 0 auto;
            text-overflow: unset;
            line-height: 1.2;
            min-height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            animation: slideText 15s linear infinite;
        }
        @keyframes slideText {
            0% { transform: translateX(-100%); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateX(100%); opacity: 0; }
        }
        .fixed-footer { display: none; }
        .online-users { display: none; }
        .scroll-to-top {
            position: fixed;
            bottom: 60px;
            right: 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            opacity: 0;
            visibility: hidden;
        }
        .scroll-to-top.visible { opacity: 1; visibility: visible; }
        .scroll-to-top:hover { background: var(--secondary-color); transform: translateY(-3px); }
        /* زر فتح الصفحة الكلاسيكية */
        .classic-page-btn {
            position: fixed;
            bottom: 180px;
            right: 20px;
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            opacity: 1;
            visibility: visible;
        }
        .classic-page-btn:hover { 
            background: linear-gradient(135deg, #8e44ad, #7d3c98); 
            transform: translateY(-3px) scale(1.1);
            box-shadow: 0 5px 15px rgba(155, 89, 182, 0.4);
        }
        .filter-control {
            position: fixed;
            bottom: 120px;
            right: 20px;
            background: var(--success-color);
            color: white;
            border: none;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 999;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0,0,0,0.2);
            opacity: 1;
            visibility: visible;
        }
        .filter-control:hover { background: #27ae60; transform: translateY(-3px); }
        .page-content { width: 100%; max-width: 100%; margin: 0; padding: 10px; box-sizing: border-box; }
        .products { display: flex; flex-wrap: wrap; gap: 20px; padding: 10px; justify-content: center; width: 100%; box-sizing: border-box; }
        .card {
            background: linear-gradient(145deg, var(--background-color), #f0f0f1);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            padding: 15px;
            transition: var(--transition);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            height: fit-content;
            width: 100%;
            box-sizing: border-box;
            border: 3px solid #3498db;
        }
        @media (min-width: 768px) { .card { width: calc(50% - 10px); } }
        @media (min-width: 1024px) { .card { width: calc(33.333% - 14px); } }
        .card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.15); border-color: #2980b9; }
        .card.has-offer { border: 3px solid #2ecc71; box-shadow: 0 5px 15px rgba(46, 204, 113, 0.2); }
        .card.highlighted { border: 3px solid var(--warning-color); box-shadow: 0 0 20px rgba(243, 156, 18, 0.5); animation: pulse 2s ease-in-out 3; }
        .category-container {
            display: block !important;
            width: 100%;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--light-color);
            border-radius: 10px;
            border: 1px solid var(--primary-color);
        }
        .category-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .category-title { font-size: 18px; font-weight: bold; color: var(--primary-color); }
        .category-count { background: var(--primary-color); color: white; padding: 4px 10px; border-radius: 15px; font-size: 14px; font-weight: bold; }
        .images-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            justify-content: center;
            width: 100%;
            position: relative;
            box-sizing: border-box;
        }
        .images-preview img {
            width: 100%;
            height: 300px;
            object-fit: contain;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            border: 3px solid var(--primary-color);
            position: relative;
            background-color: #f5f5f5;
        }
        .card.has-offer .images-preview img,
        .card.has-offer .slider-image { border: 3px solid #2ecc71; }
        .images-preview img:hover { transform: scale(1.03); border-color: var(--secondary-color); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }
        .image-slider {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            border-radius: 10px;
            margin-bottom: 15px;
            box-sizing: border-box;
        }
        .slider-container { display: flex; height: 100%; scroll-behavior: smooth; width: 100%; }
        .slider-image {
            min-width: 100%;
            height: 100%;
            object-fit: contain;
            cursor: pointer;
            border: 3px solid var(--primary-color);
            border-radius: 10px;
            background-color: #f5f5f5;
        }
        .slider-nav { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 5; }
        .slider-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(255, 255, 255, 0.5); cursor: pointer; transition: var(--transition); }
        .slider-dot.active { background: var(--primary-color); transform: scale(1.2); }
        .slider-arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.5);
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 5;
            transition: var(--transition);
        }
        .slider-arrow:hover { background: rgba(0, 0, 0, 0.7); }
        .slider-arrow.prev { left: 10px; }
        .slider-arrow.next { right: 10px; }
        
        /* تحديث معرض الصور الجديد */
        .image-gallery {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.3s ease;
        }
        .image-gallery.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .gallery-container {
            position: relative;
            width: 95%;
            height: 95%;
            max-width: 1200px;
            background: linear-gradient(145deg, #1a1a2e, #16213e);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
            animation: slideUp 0.3s ease-out;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        @keyframes slideUp {
            from { opacity: 0; transform: translateY(40px) scale(0.96); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }
        
        .gallery-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 2px solid var(--primary-color);
            flex-shrink: 0;
        }
        .gallery-title {
            color: white;
            font-size: 22px;
            font-weight: bold;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .gallery-close {
            background: linear-gradient(135deg, var(--danger-color), #c0392b);
            color: white;
            border: none;
            width: 44px;
            height: 44px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.4);
            z-index: 2001;
        }
        .gallery-close:hover { transform: scale(1.05); box-shadow: 0 8px 25px rgba(231, 76, 60, 0.6); }
        
        .gallery-main-content {
            display: flex;
            flex-direction: column;
            flex: 1;
            min-height: 0;
            width: 100%;
            height: calc(100% - 120px);
        }
        
        .gallery-viewport {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(45deg, #0f0f23, #1a1a2e);
            border-radius: 15px;
            overflow: hidden;
            border: 2px solid var(--primary-color);
            min-height: 60vh;
            width: 100%;
            height: 100%;
            touch-action: pan-y pinch-zoom;
            cursor: grab;
        }
        
        .gallery-viewport:active {
            cursor: grabbing;
        }
        
        .gallery-slider {
            display: flex;
            height: 100%;
            width: 100%;
            transition: transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94);
            will-change: transform;
        }
        
        .gallery-slide {
            min-width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .gallery-slide-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px;
            user-select: none;
            -webkit-user-drag: none;
            transition: transform 0.3s ease;
        }
        
        .gallery-slide-image.zoomed {
            cursor: grab;
            transform: scale(1.5);
        }
        
        .gallery-slide-image.zoomed:active {
            cursor: grabbing;
        }
        
        /* العلامة المائية المركزية للتاجر */
        .gallery-merchant-watermark {
            display: none !important; /* إخفاء العلامة المائية الكبيرة في الوسط */
        }
        
        /* العلامة المائية في الزاوية اليمنى العليا */
        .gallery-corner-watermark {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 100;
            opacity: 0.5;
            transition: opacity 0.3s;
            pointer-events: none;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px 8px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 200px;
        }
        
        .gallery-corner-watermark:hover { opacity: 0.8; }
        
        .corner-watermark-name {
            font-size: 12px !important;
            color: rgba(255, 255, 255, 0.8) !important;
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            backdrop-filter: none !important;
            border: none !important;
            font-weight: 500 !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8) !important;
            max-width: 150px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }
        
        .corner-watermark-logo {
            width: 25px !important;
            height: 20px !important;
            object-fit: cover !important;
            border-radius: 4px !important;
            border: 1px solid rgba(231, 76, 60, 0.3) !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
            background: rgba(255, 255, 255, 0.05) !important;
            padding: 1px !important;
        }
        
        .gallery-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin-top: 16px;
            padding: 16px 0;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            flex-shrink: 0;
        }
        
        .gallery-nav-btn {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            border: none;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            box-shadow: 0 5px 15px rgba(52, 152, 219, 0.4);
        }
        
        .gallery-nav-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 8px 25px rgba(52, 152, 219, 0.6);
        }
        
        .gallery-nav-btn:active {
            transform: scale(0.95);
        }
        
        .gallery-counter {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            font-weight: bold;
            font-size: 16px;
            box-shadow: 0 3px 10px rgba(52, 152, 219, 0.3);
            min-width: 120px;
            text-align: center;
        }
        
        .gallery-thumbnails {
            display: flex;
            overflow-x: auto;
            gap: 10px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            margin-top: 15px;
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        
        .gallery-thumbnails::-webkit-scrollbar {
            display: none;
        }
        
        .gallery-thumbnail {
            width: 80px;
            height: 60px;
            object-fit: cover;
            border-radius: 8px;
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
            opacity: 0.6;
            flex-shrink: 0;
        }
        
        .gallery-thumbnail:hover {
            opacity: 0.9;
            transform: scale(1.05);
        }
        
        .gallery-thumbnail.active {
            opacity: 1;
            border-color: var(--warning-color);
            box-shadow: 0 0 15px rgba(243, 156, 18, 0.6);
            transform: scale(1.05);
        }
        
        .gallery-tools {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            margin-top: 12px;
            flex-shrink: 0;
        }
        
        .gallery-tool-btn {
            background: linear-gradient(135deg, var(--success-color), #27ae60);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
            box-shadow: 0 3px 10px rgba(46, 204, 113, 0.3);
        }
        
        .gallery-tool-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(46, 204, 113, 0.5);
        }
        
        .image-gallery.single-image .gallery-nav-btn,
        .image-gallery.single-image .gallery-counter,
        .image-gallery.single-image .gallery-thumbnails {
            display: none;
        }
        
        .info { width: 100%; text-align: center; }
        .info h3 { margin: 5px 0; font-size: 20px; color: #e74c3c !important; font-weight: bold; }
        .product-price {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
            padding: 8px;
            background-color: rgba(52, 152, 219, 0.1);
            border-radius: 8px;
            width: 100%;
        }
        .product-details {
            margin: 10px 0;
            font-size: 14px;
            color: #000;
            text-align: center;
            width: 100%;
            direction: center;
            position: relative;
            max-height: none;
            overflow: visible;
        }
        .comments-section {
            width: 100%;
            margin-top: 15px;
            display: none;
            background: var(--light-color);
            border-radius: 10px;
            padding: 15px;
            border: 2px solid var(--primary-color);
            animation: slideDown 0.25s ease-out;
        }
        .comments-section.active { display: block; }
        @keyframes slideDown {
            from { opacity: 0; max-height: 0; padding: 0 15px; }
            to { opacity: 1; max-height: 500px; padding: 15px; }
        }
        .comments-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 2px solid var(--primary-color); }
        .comments-title { font-size: 16px; font-weight: bold; color: var(--primary-color); }
        .close-comments { background: none; border: none; color: var(--danger-color); font-size: 20px; cursor: pointer; transition: var(--transition); }
        .close-comments:hover { color: #c0392b; transform: scale(1.1); }
        .comments-list { max-height: 250px; overflow-y: auto; margin-bottom: 15px; padding: 10px; background: var(--background-color); border-radius: 8px; }
        .comment-item {
            padding: 10px;
            margin-bottom: 10px;
            background: var(--light-color);
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: var(--transition);
        }
        .comment-item:hover { transform: translateY(-1px); box-shadow: 0 3px 8px rgba(0,0,0,0.15); }
        .comment-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; }
        .comment-date { color: #666; font-size: 12px; }
        .comment-text { line-height: 1.6; font-size: 14px; color: var(--text-color); text-align: right; direction: rtl; }
        .add-comment { border-top: 1px solid #eee; padding-top: 15px; }
        .comment-form { display: flex; flex-direction: column; gap: 10px; }
        .comment-form textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 14px;
            background: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
            text-align: right;
            direction: rtl;
        }
        .comment-form textarea:focus { border-color: var(--primary-color); outline: none; box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.1); }
        .comment-form button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            align-self: flex-end;
            transition: var(--transition);
            font-size: 14px;
            font-weight: bold;
        }
        .comment-form button:hover { background: var(--secondary-color); transform: translateY(-1px); }
        .loading { text-align: center; padding: 20px; color: var(--primary-color); }
        .error { text-align: center; padding: 20px; color: var(--danger-color); background-color: #f8d7da; border-radius: 5px; margin: 20px; }
        .no-products { text-align: center; padding: 20px; color: #666; font-size: 16px; width: 100%; }
        .no-comments { text-align: center; padding: 15px; color: #666; font-style: italic; }
        .category-value-display { display: none; }
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success-color);
            color: white;
            padding: 12px 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            z-index: 3000;
            animation: slideInDown 0.3s ease;
        }
        @keyframes slideInDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        .action-buttons { display: flex; justify-content: space-between; align-items: center; width: 100%; margin: 15px 0; padding: 12px; background: var(--light-color); border-radius: 12px; gap: 10px; }
        .stats-buttons { display: flex; gap: 10px; align-items: center; flex-wrap: wrap; justify-content: center; flex: 1; }
        .stat-with-button { display: flex; flex-direction: column; align-items: center; gap: 5px; min-width: 60px; }
        .stat-number {
            font-size: 14px;
            font-weight: bold;
            color: var(--primary-color);
            background: rgba(255, 255, 255, 0.9);
            padding: 3px 8px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            min-width: 35px;
            text-align: center;
            height: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .like-stat { color: var(--danger-color); }
        .view-stat { color: var(--primary-color); }
        .comment-stat { color: var(--success-color); }
        .action-button {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        .action-button:hover { transform: scale(1.1); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .btn-like { color: var(--danger-color); }
        .btn-comment { color: var(--success-color); }
        .btn-view { color: var(--primary-color); }
        .favorite-btn {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: var(--transition);
            color: #f39c12;
            font-size: 18px;
            position: relative;
            box-shadow: 0 3px 10px rgba(243, 156, 18, 0.3);
        }
        .favorite-btn.active { color: var(--danger-color); background: rgba(255, 255, 255, 1); }
        .favorite-btn:hover { background: rgba(255, 255, 255, 1); transform: scale(1.1); }
        .share-button {
            background: rgba(255, 255, 255, 0.9);
            color: var(--warning-color);
            border: none;
            border-radius: 50%;
            width: 45px;
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
            transition: var(--transition);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.1);
        }
        .share-button:hover { background: rgba(255, 255, 255, 1); transform: scale(1.1); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
        .share-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 3000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }
        .share-modal.active { display: flex; }
        .share-modal-content { background: var(--background-color); border-radius: 15px; padding: 20px; max-width: 400px; width: 90%; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3); animation: slideUp 0.3s ease; }
        .share-modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--light-color); }
        .share-modal-title { font-size: 18px; font-weight: bold; color: var(--primary-color); }
        .share-modal-close { background: none; border: none; font-size: 24px; color: var(--danger-color); cursor: pointer; transition: var(--transition); }
        .share-modal-close:hover { transform: scale(1.1); }
        .share-options { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .share-option {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
            padding: 15px 10px;
            border-radius: 10px;
            background: var(--light-color);
            cursor: pointer;
            transition: var(--transition);
            border: 2px solid transparent;
        }
        .share-option:hover { transform: translateY(-3px); box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1); border-color: var(--primary-color); }
        .share-option i { font-size: 24px; color: var(--primary-color); }
        .share-option span { font-size: 14px; font-weight: bold; color: var(--text-color); }
        .share-whatsapp { background: linear-gradient(135deg, #25D366, #128C7E); color: white; }
        .share-whatsapp i { color: white; }
        .share-whatsapp span { color: white; }
        .share-facebook { background: linear-gradient(135deg, #4267B2, #365899); color: white; }
        .share-facebook i { color: white; }
        .share-facebook span { color: white; }
        .share-twitter { background: linear-gradient(135deg, #1DA1F2, #1A91DA); color: white; }
        .share-twitter i { color: white; }
        .share-twitter span { color: white; }
        .share-telegram { background: linear-gradient(135deg, #0088cc, #0077b5); color: white; }
        .share-telegram i { color: white; }
        .share-telegram span { color: white; }
        .share-link { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: white; }
        .share-link i { color: white; }
        .share-link span { color: white; }
        .share-other { background: linear-gradient(135deg, var(--warning-color), #e67e22); color: white; }
        .share-other i { color: white; }
        .share-other span { color: white; }
        
        .image-watermark {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 10;
            opacity: 0.5;
            transition: var(--transition);
            pointer-events: none;
            flex-direction: row-reverse;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px 8px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 180px;
        }
        
        .image-watermark:hover { opacity: 0.8; }
        
        .watermark-logo {
            width: 25px !important;
            height: 20px !important;
            object-fit: cover !important;
            border-radius: 4px !important;
            border: 1px solid rgba(231, 76, 60, 0.3) !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
            background: rgba(255, 255, 255, 0.05) !important;
            padding: 1px !important;
        }
        
        .watermark-merchant-name {
            font-size: 12px !important;
            color: rgba(255, 255, 255, 0.8) !important;
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            backdrop-filter: none !important;
            border: none !important;
            font-weight: 500 !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8) !important;
            max-width: 150px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }
        
        .slider-watermark {
            position: absolute;
            top: 10px;
            right: 10px;
            display: flex;
            align-items: center;
            gap: 6px;
            z-index: 10;
            opacity: 0.5;
            transition: var(--transition);
            pointer-events: none;
            flex-direction: row-reverse;
            background: rgba(0, 0, 0, 0.4);
            padding: 4px 8px;
            border-radius: 20px;
            backdrop-filter: blur(5px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            max-width: 180px;
        }
        
        .slider-watermark:hover { opacity: 0.8; }
        
        .slider-merchant-logo {
            width: 25px !important;
            height: 20px !important;
            object-fit: cover !important;
            border-radius: 4px !important;
            border: 1px solid rgba(231, 76, 60, 0.3) !important;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3) !important;
            background: rgba(255, 255, 255, 0.05) !important;
            padding: 1px !important;
        }
        
        .slider-merchant-name {
            font-size: 12px !important;
            color: rgba(255, 255, 255, 0.8) !important;
            background: transparent !important;
            padding: 0 !important;
            border-radius: 0 !important;
            backdrop-filter: none !important;
            border: none !important;
            font-weight: 500 !important;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.8) !important;
            max-width: 150px !important;
            white-space: nowrap !important;
            overflow: hidden !important;
            text-overflow: ellipsis !important;
        }
        
        .merchant-logo-container { display: flex; align-items: center; justify-content: center; width: 100%; gap: 10px; margin-top: 5px; }
        .merchant-logo { 
            width: 50px; 
            height: 50px; 
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid rgba(52, 152, 219, 0.5);
            box-shadow: 0 3px 10px rgba(0, 0, 0, 0.2);
            transition: var(--transition); 
        }
        .merchant-logo:hover { transform: scale(1.05); border-color: var(--primary-color); }
        .merchant-logo-wrapper { display: inline-block; }
        .merchant-logo-small {
            width: 60px;
            height: 45px;
            object-fit: cover;
            border-radius: 12px;
            border: 2px solid #e74c3c;
            box-shadow: 0 3px 10px rgba(231, 76, 60, 0.2);
            transition: var(--transition);
            background: rgba(255, 255, 255, 0.9);
            padding: 3px;
        }
        
        @media (max-width: 1024px) {
            .gallery-container { width: 98%; height: 98%; }
            .gallery-watermark-logo { width: 80px; height: 64px; }
            .gallery-watermark-name { font-size: 18px; padding: 10px 20px; }
            .corner-watermark-logo,
            .watermark-logo,
            .slider-merchant-logo { width: 22px !important; height: 18px !important; }
            .corner-watermark-name,
            .watermark-merchant-name,
            .slider-merchant-name { font-size: 11px !important; }
            .image-watermark,
            .slider-watermark,
            .gallery-corner-watermark {
                max-width: 160px;
                padding: 3px 6px;
            }
            .matching-product-offer {
                font-size: 9px;
                padding: 5px 10px;
            }
            .merchant-logo-rectangle {
                width: 75px;
                height: 75px;
            }
            .classic-page-btn,
            .filter-control,
            .scroll-to-top {
                bottom: auto;
                right: 20px;
                left: auto;
                transform: none;
                width: 45px;
                height: 45px;
            }
            .scroll-to-top { bottom: 60px; }
            .filter-control { bottom: 120px; }
            .classic-page-btn { bottom: 180px; }
        }
        @media (max-width: 768px) {
            body { padding-top: 128px; padding-bottom: 40px; }
            .filter-bar { top: 128px; padding: 8px 10px; }
            .filter-item { flex: 1 0 100%; }
            .filter-item input { width: 100%; }
            .products { grid-template-columns: 1fr; }
            .images-preview img, .slider-image { height: 250px; }
            .image-slider { height: 250px; }
            .product-price { font-size: 18px; }
            .comments-list { max-height: 200px; }
            .gallery-container { width: 100%; height: 100%; padding: 15px; border-radius: 0; }
            .gallery-main-content { flex-direction: column; gap: 12px; }
            .gallery-thumbnails { flex-direction: row; overflow-x: auto; overflow-y: hidden; max-height: 80px; }
            .gallery-thumbnail { width: 70px; height: 50px; }
            .gallery-title { font-size: 18px; }
            .gallery-nav-btn { width: 50px; height: 50px; font-size: 20px; }
            .gallery-viewport { min-height: 50vh; }
            .gallery-merchant-watermark { width: 200px; height: 200px; }
            .gallery-watermark-logo { width: 70px; height: 56px; margin-bottom: 10px; }
            .gallery-watermark-name { font-size: 16px; padding: 8px 16px; }
            .brand { align-items: center; }
            .brand-title { font-size: 16px; }
            .brand-subtitle { font-size: 11px; }
            .action-buttons { flex-direction: column; gap: 12px; }
            .stats-buttons { justify-content: space-around; width: 100%; gap: 10px; }
            .stat-with-button { min-width: 55px; }
            .action-button, .share-button, .favorite-btn { width: 40px; height: 40px; font-size: 16px; }
            .stat-number { font-size: 12px; min-width: 30px; height: 20px; }
            .header-online-users { font-size: 12px; padding: 4px 8px; }
            .header-login { font-size: 12px; padding: 4px 8px; }
            .secondary-bar { padding: 6px 10px; }
            .secondary-bar-left, .secondary-bar-right { gap: 8px; }
            .secondary-category-text-input { min-width: 120px; font-size: 12px; }
            .products-count { font-size: 12px; }
            .online-users-real { font-size: 12px; padding: 4px 8px; }
            .show-more-btn { font-size: 12px; padding: 4px 8px; }
            .secondary-favorites { width: 30px; height: 30px; font-size: 12px; }
            .footer { height: 40px; }
            .footer-text { font-size: 14px; padding: 6px 12px; min-height: 30px; }
            .share-options { grid-template-columns: repeat(2, 1fr); }
            .category-modal-controls,
            .merchant-modal-controls { flex-wrap: wrap; }
            .category-modal-btn,
            .merchant-modal-btn { padding: 10px 15px; font-size: 14px; }
            .merchant-logo-small { width: 50px; height: 38px; }
            .corner-watermark-logo,
            .watermark-logo,
            .slider-merchant-logo { width: 20px !important; height: 16px !important; }
            .corner-watermark-name,
            .watermark-merchant-name,
            .slider-merchant-name { font-size: 10px !important; }
            .image-watermark,
            .slider-watermark,
            .gallery-corner-watermark {
                max-width: 140px;
                padding: 3px 6px;
            }
            .matching-product-offer {
                font-size: 8px;
                padding: 4px 8px;
            }
            .merchant-logo-rectangle {
                width: 65px;
                height: 65px;
                border-radius: 15px;
            }
        }
        @media (max-width: 480px) {
            .images-preview img, .slider-image { width: 100%; height: 250px; }
            .image-slider { width: 100%; height: 250px; }
            .gallery-nav-btn { width: 45px; height: 45px; font-size: 18px; }
            .gallery-slide-image { max-width: 100%; max-height: 100%; }
            .gallery-merchant-watermark { width: 150px; height: 150px; }
            .gallery-watermark-logo { width: 60px; height: 48px; margin-bottom: 8px; }
            .gallery-watermark-name { font-size: 14px; padding: 6px 12px; }
            .brand-logo { width: 40px; height: 40px; }
            .action-buttons { padding: 8px; gap: 10px; }
            .stats-buttons { gap: 8px; }
            .stat-with-button { min-width: 50px; }
            .action-button, .share-button, .favorite-btn { width: 38px; height: 38px; font-size: 15px; }
            .stat-number { font-size: 11px; min-width: 28px; height: 18px; }
            .header-online-users { font-size: 11px; padding: 3px 6px; }
            .header-login { font-size: 11px; padding: 3px 6px; }
            .secondary-bar { padding: 4px 8px; }
            .secondary-bar-left, .secondary-bar-right { gap: 6px; }
            .secondary-category { flex-direction: column; gap: 3px; }
            .secondary-category label { font-size: 11px; }
            .secondary-category-text-input { min-width: 100px; font-size: 11px; padding: 4px 6px; }
            .products-count { font-size: 11px; }
            .online-users-real { font-size: 11px; padding: 3px 6px; }
            .show-more-btn { font-size: 11px; padding: 3px 6px; }
            .secondary-favorites { width: 28px; height: 28px; font-size: 11px; }
            .footer { height: 35px; padding: 5px 10px; }
            .footer-text { font-size: 12px; padding: 5px 10px; min-height: 25px; }
            .offer-dates { font-size: 10px; max-width: 150px; padding: 4px 8px; }
            .merchant-logo-small { width: 45px; height: 34px; }
            .corner-watermark-logo,
            .watermark-logo,
            .slider-merchant-logo { width: 18px !important; height: 14px !important; }
            .corner-watermark-name,
            .watermark-merchant-name,
            .slider-merchant-name { font-size: 9px !important; }
            .image-watermark,
            .slider-watermark,
            .gallery-corner-watermark {
                max-width: 120px;
                padding: 2px 5px;
                gap: 4px;
            }
            .matching-product-offer {
                font-size: 7px;
                padding: 3px 6px;
            }
            .merchant-logo-rectangle {
                width: 60px;
                height: 60px;
                border-radius: 12px;
            }
        }
        
        /* تحسينات إضافية للعلامة المائية */
        .image-watermark, .slider-watermark, .gallery-corner-watermark {
            font-size: 0; /* لإزالة المسافات بين العناصر inline-block */
        }
        
        .watermark-merchant-name, .slider-merchant-name, .corner-watermark-name {
            display: inline-block;
            vertical-align: middle;
        }
        
        .watermark-logo, .slider-merchant-logo, .corner-watermark-logo {
            display: inline-block;
            vertical-align: middle;
        }
    </style>
</head>
<body>
    <audio id="new-product-sound" preload="auto">
        <source src="https://github.com/e772299420-hue/Call/raw/main/Sms.mp3" type="audio/mpeg">
    </audio>

    <header class="header">
        <div class="header-content">
            <div class="brand">
                <img src="https://raw.githubusercontent.com/e772299420-hue/Call/main/icon-512x5122.png" alt="شعار AZ" class="brand-logo">
                <div class="brand-text">
                    <div class="brand-title">AZ السوق الشامل</div>
                    <div class="brand-subtitle">لتلبية احتياجك بالكامل</div>
                </div>
            </div>

            <div class="header-right">
                <a href="manjr_tagr_snf.html" class="header-login" title="تسجيل الدخول">
                    <i class="fas fa-sign-in-alt"></i>
                    تسجيل الدخول
                </a>
                
                <div class="header-online-users" id="header-online-users">
                    <i class="fas fa-users"></i>
                    <span id="header-users-count">0</span> متصل الآن
                </div>
            </div>
        </div>
    </header>

    <div class="secondary-bar">
        <div class="secondary-bar-content">
            <div class="secondary-bar-left">
                <div class="secondary-category">
                    <div class="secondary-category-text-field">
                        <input type="text" 
                               id="secondary-category-text-input" 
                               class="secondary-category-text-input" 
                               placeholder="جميع الأقسام"
                               readonly>
                        <div class="secondary-category-text-field-icon">
                            <i class="fas fa-tags"></i>
                        </div>
                    </div>
                </div>

                <div class="products-count">
                    <i class="fas fa-box"></i>
                    <span id="products-count"> : 0</span>
                </div>

                <div class="online-users-real">
                    <i class="fas fa-users"></i>
                    <span id="real-online-users">0</span>
                </div>
            </div>

            <div class="secondary-bar-right">
                <button class="show-more-btn" id="show-more-btn">
                    <i class="fas fa-bars"></i>
                    عرض أكثر
                </button>

                <button class="secondary-favorites" id="secondary-favorites" title="عرض المفضلة">
                    <i class="fas fa-heart"></i>
                </button>
            </div>
        </div>
    </div>

    <div class="filter-bar" id="filter-bar">
        <div class="filter-item">
            <label for="governorate">المحافظة:</label>
            <select id="governorate"><option value="">جميع المحافظات</option></select>
        </div>
        <div class="filter-item">
            <label for="region">المنطقة:</label>
            <select id="region"><option value="">جميع المناطق</option></select>
        </div>
        
        <div class="filter-item">
            <label for="merchant-text-input">التاجر:</label>
            <div class="merchant-text-field">
                <input type="text" 
                       id="merchant-text-input" 
                       class="merchant-text-input" 
                       placeholder="انقر لاختيار تاجر"
                       readonly>
                <div class="merchant-text-field-icon">
                    <i class="fas fa-store"></i>
                </div>
            </div>
        </div>
        
        <div class="filter-item">
            <label for="category-text-input">القسم:</label>
            <div class="category-text-field">
                <input type="text" 
                       id="category-text-input" 
                       class="category-text-input" 
                       placeholder="انقر لاختيار قسم"
                       readonly>
                <div class="category-text-field-icon">
                    <i class="fas fa-tags"></i>
                </div>
            </div>
            <span class="category-value-display" id="category-value-display"></span>
        </div>
        
        <div class="filter-item">
            <label for="search">بحث:</label>
            <div class="search-container">
                <input type="text" id="search" placeholder="ابحث عن منتج...">
                <button class="voice-search-btn" id="voice-search-btn" title="البحث الصوتي">
                    <i class="fas fa-microphone"></i>
                </button>
            </div>
        </div>
        <div class="filter-item">
            <label for="sort-by">ترتيب:</label>
            <select id="sort-by">
                <option value="date">التاريخ (الأحدث أولاً)</option>
                <option value="name">الاسم</option>
                <option value="category">القسم</option>
                <option value="price">السعر</option>
                <option value="merchant">التاجر</option>
                <option value="preference">رغبتي</option>
                <option value="offers">العروض</option>
            </select>
        </div>
        <button class="reset-btn" id="reset-filters" title="إعادة تعيين جميع الفلاتر">
            <i class="fas fa-redo"></i>
            <span class="tooltip">إعادة تعيين جميع الفلاتر</span>
        </button>
    </div>

    <div class="merchant-modal-overlay" id="merchant-modal-overlay">
        <div class="merchant-modal">
            <div class="merchant-modal-header">
                <div class="merchant-modal-title">أسماء التجار المرتبطين</div>
                <div class="merchant-modal-subtitle">اختر تاجر لعرض منتجاته</div>
            </div>
            <div class="merchant-modal-body">
                <div class="merchant-modal-controls">
                    <button id="merchant-modal-all" class="merchant-modal-btn merchant-modal-btn-all">الجميع</button>
                    <button id="merchant-modal-cancel" class="merchant-modal-btn merchant-modal-btn-cancel">إلغاء</button>
                    <button id="merchant-modal-confirm" class="merchant-modal-btn merchant-modal-btn-confirm" disabled>موافق</button>
                </div>
                <div class="merchant-modal-search">
                    <input type="text" id="merchant-modal-search-input" class="merchant-modal-search-input" placeholder="ابحث عن تاجر...">
                </div>
                <div class="merchants-modal-list" id="merchants-modal-list">
                </div>
            </div>
        </div>
    </div>

    <div class="category-modal-overlay" id="category-modal-overlay">
        <div class="category-modal">
            <div class="category-modal-header">
                <div class="category-modal-title">الأقسام المتاحة</div>
                <div class="category-modal-subtitle">اختر قسم لعرض منتجاته</div>
            </div>
            <div class="category-modal-body">
                <div class="category-modal-controls">
                    <button id="category-modal-all" class="category-modal-btn category-modal-btn-all">الجميع</button>
                    <button id="category-modal-cancel" class="category-modal-btn category-modal-btn-cancel">إلغاء</button>
                    <button id="category-modal-confirm" class="category-modal-btn category-modal-btn-confirm" disabled>موافق</button>
                </div>
                <div class="category-modal-search">
                    <input type="text" id="category-modal-search-input" class="category-modal-search-input" placeholder="ابحث عن قسم...">
                </div>
                <div class="categories-modal-list" id="categories-modal-list">
                </div>
            </div>
        </div>
    </div>

    <!-- زر العودة للأعلى -->
    <button class="scroll-to-top" id="scroll-to-top" title="العودة للأعلى">
        <i class="fas fa-chevron-up"></i>
    </button>

    <!-- زر فتح الصفحة الكلاسيكية -->
    <button class="classic-page-btn" id="classic-page-btn" title="فتح العرض الكلاسيكي">
        <i class="fas fa-star"></i>
    </button>

    <!-- زر التحكم بالفلاتر -->
    <button class="filter-control" id="filter-control" title="إظهار/إخفاء شريط الفلاتر">
        <i class="fas fa-sliders-h"></i>
    </button>

    <div class="page-content">
        <div id="products-container">
            <div class="loading">جاري تحميل البيانات...</div>
        </div>
    </div>

    <!-- معرض الصور الجديد -->
    <div class="image-gallery" id="image-gallery">
        <div class="gallery-container">
            <div class="gallery-header">
                <div class="gallery-title">
                    <i class="fas fa-images"></i>
                    <span id="gallery-product-name">معرض الصور</span>
                </div>
                <button class="gallery-close" id="gallery-close">×</button>
            </div>

            <div class="gallery-main-content">
                <div class="gallery-viewport" id="gallery-viewport">
                    <div class="gallery-slider" id="gallery-slider">
                        <!-- سيتم إضافة الشرائح هنا ديناميكياً -->
                    </div>
                    
                    <!-- العلامة المائية المركزية للتاجر -->
                    <div class="gallery-merchant-watermark" id="gallery-merchant-watermark">
                        <!-- سيتم إضافة العلامة المائية هنا ديناميكياً -->
                    </div>
                    
                    <!-- العلامة المائية في الزاوية اليمنى العليا -->
                    <div class="gallery-corner-watermark" id="gallery-corner-watermark">
                        <!-- سيتم إضافة العلامة المائية هنا ديناميكياً -->
                    </div>
                </div>
                
                <div class="gallery-thumbnails" id="gallery-thumbnails">
                    <!-- سيتم إضافة الصور المصغرة هنا ديناميكياً -->
                </div>
            </div>

            <div class="gallery-controls">
                <button class="gallery-nav-btn" id="gallery-prev" title="الصورة السابقة">
                    <i class="fas fa-chevron-right"></i>
                </button>
                <div class="gallery-counter" id="gallery-counter">1 من 1</div>
                <button class="gallery-nav-btn" id="gallery-next" title="الصورة التالية">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>

            <div class="gallery-tools">
                <button class="gallery-tool-btn" id="gallery-zoom">
                    <i class="fas fa-search-plus"></i>
                    تكبير/تصغير
                </button>
                <button class="gallery-tool-btn" id="gallery-rotate">
                    <i class="fas fa-redo"></i>
                    تدوير
                </button>
            </div>
        </div>
    </div>

    <div class="new-products-modal" id="new-products-modal">
        <div class="new-products-content">
            <div class="new-products-header">
                <div class="new-products-title">
                    <i class="fas fa-gift"></i>
                    منتجات جديدة من تجارك المفضلين
                </div>
                <button class="new-products-close" id="new-products-close">×</button>
            </div>
            <div class="new-products-list" id="new-products-list">
            </div>
            <div class="new-products-footer">
                تم اكتشاف منتجات جديدة من تجارك المفضلين
            </div>
        </div>
    </div>

    <div class="share-modal" id="share-modal">
        <div class="share-modal-content">
            <div class="share-modal-header">
                <div class="share-modal-title">مشاركة المنتج</div>
                <button class="share-modal-close" id="share-modal-close">×</button>
            </div>
            <div class="share-options">
                <div class="share-option share-whatsapp" data-platform="whatsapp">
                    <i class="fab fa-whatsapp"></i>
                    <span>واتساب</span>
                </div>
                <div class="share-option share-facebook" data-platform="facebook">
                    <i class="fab fa-facebook"></i>
                    <span>فيسبوك</span>
                </div>
                <div class="share-option share-twitter" data-platform="twitter">
                    <i class="fab fa-twitter"></i>
                    <span>تويتر</span>
                </div>
                <div class="share-option share-telegram" data-platform="telegram">
                    <i class="fab fa-telegram"></i>
                    <span>تيليجرام</span>
                </div>
                <div class="share-option share-link" data-platform="copy">
                    <i class="fas fa-link"></i>
                    <span>نسخ الرابط</span>
                </div>
                <div class="share-option share-other" data-platform="other">
                    <i class="fas fa-share-alt"></i>
                    <span>تطبيقات أخرى</span>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <div class="footer-content">
            <div class="footer-text" id="footer-text">
                جميع الحقوق محفوظة لدى المميز سوفت للأنظمة المحاسبية المتكاملة
            </div>
            <div class="online-users" id="online-users" style="display: none;">
                <i class="fas fa-users"></i>
                <span id="users-count">0</span> موجد الآن
            </div>
        </div>
    </footer>

    <script>
        const firebaseConfig = { 
            databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/" 
        };
        
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            } else {
                firebase.app();
            }
        } catch (error) {
            console.error("❌ خطأ في تهيئة Firebase:", error);
        }
        
        const db = firebase.database();

        let allProducts = [];
        let allMerchants = [];
        let allGovernorates = [];
        let allRegions = [];
        let allCategories = [];
        let favoriteProducts = JSON.parse(localStorage.getItem('favoriteProducts')) || {};
        let userInterests = JSON.parse(localStorage.getItem('userInterests')) || {};
        let showFavoritesOnly = false;
        let isCommentsOpen = false;
        let userViewHistory = JSON.parse(localStorage.getItem('userViewHistory')) || {};
        let selectedMerchantId = null;
        let selectedMerchantName = null;
        let filteredModalMerchants = [];
        let selectedCategoryId = null;
        let selectedCategoryName = null;
        let filteredModalCategories = [];
        let currentUserId = null;
        let onlineUsersRef = null;
        let userPresenceRef = null;
        let connectedRef = null;
        let galleryImages = [];
        let currentGalleryIndex = 0;
        let isImageZoomed = false;
        let currentGalleryMerchant = null;
        let touchStartX = 0;
        let touchStartY = 0;
        let touchStartDistance = 0;
        let currentScale = 1;
        let currentRotation = 0;
        let currentTranslateX = 0;
        let currentTranslateY = 0;
        let isDragging = false;
        let isGalleryDragging = false;
        let dragStartX = 0;
        let dragStartY = 0;
        let sliderTranslateX = 0;
        let recognition = null;
        let isListening = false;
        let advertisementTexts = [];
        let currentAdIndex = 0;
        let adInterval = null;
        let onlineUsersCount = 0;
        let onlineUsersInterval = null;
        let onlineUsersDirection = 1;
        let consecutiveChanges = 0;
        let autoViewInterval = null;
        let userActions = JSON.parse(localStorage.getItem('userActions')) || {
            likes: {},
            views: {},
            comments: {}
        };
        let autoLikeInterval = null;
        let autoCommentInterval = null;
        const commentTexts = {
            ملابس: [
                "اللبس حلو وثمنه معقول!",
                "القماش ناعم وبلس مريح",
                "الموديل جديد وعاجبني",
                "مقاساته مضبوطة وتناسب",
                "الألوان زاهية وثابتة",
                "التفصيل متقن ودقيق",
                "جودة عالية وسعر مناسب",
                "أنصح فيه لكل اللي يدور على لبس مرتب"
            ],
            إلكترونيات: [
                "الجهاز شغال زي الفل",
                "البطارية تدوم وقت طويل",
                "السعر رخيص بالنسبة لمواصفاته",
                "الصوت واضح ونقى",
                "الشاشة واضحة وألوانها زاهية",
                "السرعة عالية ومافي تقطيع",
                "منتج أصلي وضمانته موجودة",
                "اشتريته وما ندمت عليه"
            ],
            أثاث: [
                "الأثاث قوي ومتين",
                "التصميم عصري وعاجبني",
                "الخشب أصلي ومقاساته مضبوطة",
                "اللون جميل ويناسب البيت",
                "سهل التركيب والتجميع",
                "مريح للجلوس والنوم",
                "السعر معقول بالنسبة لجودته",
                "أنصح فيه لكل بيت"
            ],
            سيارات: [
                "السيارة نظيفة ومشيتها قليلة",
                "المكينه شغاله بدون أي مشاكل",
                "القطعة نضيفة ومفحوصة",
                "الوقود اقتصادي في المشي",
                "الفرامل والدنابر شغالة تمام",
                "اللون جديد وكأنه خارجة من المعرض",
                "السعر مناسب وأقل من السوق",
                "فرصة ما تتكرر"
            ],
            أطعمة: [
                "الطعم لذيذ وزكي",
                "المنتج طازج ونظيف",
                "التعبئة محكمة ومضمونة",
                "السعر رخيص بالنسبة لجودته",
                "الكمية مناسبة وكافية",
                "أنصح فيه لكل عائلة",
                "جربته وعجبني جدا",
                "منتج يمني أصلي"
            ],
            عام: [
                "المنتج كويس ويسوى الثمن",
                "جودة عالية وسعر معقول",
                "أنصح فيه لكل الناس",
                "مافي زيه في السوق",
                "فرصة لا تعوض",
                "اشتريته وفرحت فيه",
                "تسليم سريع وتغليف مرتب",
                "التاجر متعاون وبيصلح"
            ]
        };
        let lastCheckTime = new Date();
        let openedProducts = [];
        let favoriteMerchantsCheckInterval = null;
        let newProductsModal = null;
        let productCards = {};
        let currentCategoryFilter = '';

        const productsContainer = document.getElementById('products-container');
        const governorateSelect = document.getElementById('governorate');
        const regionSelect = document.getElementById('region');
        const categoryTextInput = document.getElementById('category-text-input');
        const searchInput = document.getElementById('search');
        const resetButton = document.getElementById('reset-filters');
        const sortSelect = document.getElementById('sort-by');
        const filterBar = document.getElementById('filter-bar');
        const scrollToTopBtn = document.getElementById('scroll-to-top');
        const classicPageBtn = document.getElementById('classic-page-btn');
        const filterControlBtn = document.getElementById('filter-control');
        const categoryValueDisplay = document.getElementById('category-value-display');
        const usersCountEl = document.getElementById('users-count');
        const headerUsersCountEl = document.getElementById('header-users-count');
        const realOnlineUsersEl = document.getElementById('real-online-users');
        const voiceSearchBtn = document.getElementById('voice-search-btn');
        const footerTextEl = document.getElementById('footer-text');
        const merchantModalOverlay = document.getElementById('merchant-modal-overlay');
        const merchantTextInput = document.getElementById('merchant-text-input');
        const merchantModalSearchInput = document.getElementById('merchant-modal-search-input');
        const merchantsModalList = document.getElementById('merchants-modal-list');
        const merchantModalCancel = document.getElementById('merchant-modal-cancel');
        const merchantModalConfirm = document.getElementById('merchant-modal-confirm');
        const merchantModalAll = document.getElementById('merchant-modal-all');
        const categoryModalOverlay = document.getElementById('category-modal-overlay');
        const secondaryCategoryTextInput = document.getElementById('secondary-category-text-input');
        const categoryModalSearchInput = document.getElementById('category-modal-search-input');
        const categoriesModalList = document.getElementById('categories-modal-list');
        const categoryModalCancel = document.getElementById('category-modal-cancel');
        const categoryModalConfirm = document.getElementById('category-modal-confirm');
        const categoryModalAll = document.getElementById('category-modal-all');
        const productsCountEl = document.getElementById('products-count');
        const showMoreBtn = document.getElementById('show-more-btn');
        const secondaryFavoritesBtn = document.getElementById('secondary-favorites');
        const shareModal = document.getElementById('share-modal');
        const shareModalClose = document.getElementById('share-modal-close');
        const shareOptions = document.querySelectorAll('.share-option');
        const galleryViewport = document.getElementById('gallery-viewport');
        const gallerySlider = document.getElementById('gallery-slider');
        const galleryThumbnails = document.getElementById('gallery-thumbnails');
        const galleryCounter = document.getElementById('gallery-counter');
        const galleryPrevBtn = document.getElementById('gallery-prev');
        const galleryNextBtn = document.getElementById('gallery-next');
        const galleryZoomBtn = document.getElementById('gallery-zoom');
        const galleryRotateBtn = document.getElementById('gallery-rotate');
        const galleryCloseBtn = document.getElementById('gallery-close');
        const galleryMerchantWatermark = document.getElementById('gallery-merchant-watermark');
        const galleryCornerWatermark = document.getElementById('gallery-corner-watermark');
        let isBackButtonPressed = false;

        // دالة لتفريغ حقول الفلاتر
        function resetFiltersFields() {
            if (governorateSelect) governorateSelect.value = '';
            if (regionSelect) regionSelect.value = '';
            if (searchInput) searchInput.value = '';
            if (sortSelect) sortSelect.value = 'date';
            if (categoryValueDisplay) categoryValueDisplay.textContent = '';
            
            selectedMerchantId = null;
            selectedMerchantName = null;
            if (merchantTextInput) merchantTextInput.value = '';
            
            selectedCategoryId = null;
            selectedCategoryName = null;
            if (categoryTextInput) categoryTextInput.value = '';
            if (secondaryCategoryTextInput) secondaryCategoryTextInput.value = 'جميع الأقسام';
            
            updateRegionOptions();
        }

        // دالة جديدة لتفريغ جميع الفلاتر عند فتح الصفحة
        function clearAllFiltersOnLoad() {
            // تفريغ حقول الفلاتر
            resetFiltersFields();
            
            // إخفاء شريط الفلاتر
            hideFilterBar();
            
            // إعادة تعيين عدد المنتجات المعروضة
            if (productsCountEl) {
                productsCountEl.textContent = ` ${allProducts.length}`;
            }
            
            // عرض جميع المنتجات
            displayProducts(allProducts);
        }

        // دالة محسنة للتحقق من أن التاجر نشط وتاجر (مرنة جداً)
        function isActiveMerchant(merchant) {
            if (!merchant) return true;
            
            let isActive = true;
            
            if (merchant.status !== undefined && merchant.status !== null && merchant.status !== "") {
                const status = merchant.status.toString().toLowerCase().trim();
                const inactiveStatuses = ["غير نشط", "inactive", "0", "false", "معطل", "محظور", "موقوف", "غير مفعل", "suspended", "banned", "deactivated"];
                
                if (inactiveStatuses.includes(status)) {
                    isActive = false;
                }
            }
            
            let isMerchantType = true;
            
            const merchantTypeFields = ['job', 'type', 'role', 'userType'];
            let foundNonMerchant = false;
            
            merchantTypeFields.forEach(field => {
                if (merchant[field] !== undefined && merchant[field] !== null && merchant[field] !== "") {
                    const value = merchant[field].toString().toLowerCase().trim();
                    const nonMerchantValues = ["موظف", "عميل", "زبون", "مستخدم", "admin", "employee", "user", "client", "customer", "زائر", "visitor"];
                    
                    if (nonMerchantValues.includes(value)) {
                        foundNonMerchant = true;
                    }
                }
            });
            
            if (foundNonMerchant) {
                isMerchantType = false;
            }
            
            const merchantProducts = allProducts.filter(p => p.userId === merchant.id);
            if (merchantProducts.length > 0) {
                isMerchantType = true;
            }
            
            return isActive && isMerchantType;
        }

        // حساب عدد التجار النشطين
        function countActiveMerchants() {
            return allMerchants.filter(merchant => {
                return isActiveMerchant(merchant);
            }).length;
        }

        // دالة لفحص وتحسين بيانات التاجر
        function validateMerchantData(merchant) {
            if (!merchant) return false;
            
            if (!merchant.id || merchant.id.trim() === '') {
                return false;
            }
            
            if (!merchant.name && !merchant.username) {
                merchant.name = 'تاجر ' + merchant.id.substring(0, 5);
            }
            
            return true;
        }

        // دالة للحصول على التجار الذين لديهم منتجات فقط
        function getMerchantsWithProducts() {
            const merchantsWithProducts = {};
            
            allProducts.forEach(product => {
                if (product.userId) {
                    merchantsWithProducts[product.userId] = true;
                }
            });
            
            return allMerchants.filter(merchant => {
                return merchantsWithProducts[merchant.id] && isActiveMerchant(merchant);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initializeNavigationManager();
            initializeStableUserId();
            startRandomOnlineUsers();
            startAutoViewIncrement();
            initializeUserPresence();
            initializeSpeechRecognition();
            initializeApp();
            setupEventListeners();
            
            // تحميل البيانات المخزنة محلياً أولاً
            if (loadCachedData()) {
                checkUrlForProduct();
                displayPersonalizedProducts();
                
                // ثم نبدأ التحميل من Firebase في الخلفية للتحديث
                setTimeout(() => {
                    loadAllData().then(() => {
                        saveDataToCache();
                        if (!showFavoritesOnly) {
                            filterProducts();
                        }
                        // تفريغ جميع حقول الفلاتر بعد تحميل البيانات
                        clearAllFiltersOnLoad();
                    }).catch(error => {
                        console.error('❌ خطأ في تحديث البيانات:', error);
                        // حتى إذا فشل التحميل من Firebase، قم بتفريغ الفلاتر
                        clearAllFiltersOnLoad();
                    });
                }, 100);
            } else {
                // إذا لم توجد بيانات مخزنة، نحمل من Firebase
                loadAllData().then(() => {
                    saveDataToCache();
                    checkUrlForProduct();
                    displayPersonalizedProducts();
                    // تفريغ جميع حقول الفلاتر بعد تحميل البيانات
                    clearAllFiltersOnLoad();
                }).catch(error => {
                    console.error('❌ خطأ في تحميل البيانات:', error);
                    productsContainer.innerHTML = `
                        <div class="error">
                            <h3>حدث خطأ في تحميل البيانات</h3>
                            <p>${error.message || 'تعذر التحميل'}</p>
                            <p>يرجاء التحقق من اتصال الإنترنت وإعادة تحميل الصفحة</p>
                            <button onclick="location.reload()" style="margin-top:10px;padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer;">إعادة تحميل</button>
                        </div>
                    `;
                    // حتى إذا فشل التحميل، قم بتفريغ الفلاتر
                    clearAllFiltersOnLoad();
                });
            }
            
            startAutoUpdate();
            loadAdvertisementTexts();
            startAutoInteractions();
            startFavoriteMerchantsCheck();
            restoreScrollPosition();
            setupFilterBarAutoHide();
            initializeGallery();
            
            // إضافة كود Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js').then(() => {
                    // إخطار Service Worker بالصفحات الفرعية المحتملة
                    if (navigator.serviceWorker.controller) {
                        const childPages = ['manjr_tagr_snf.html', 'ard_tagr.html', '1_1k.html'];
                        const fullUrls = childPages.map(page => new URL(page, window.location.origin).href);
                        
                        navigator.serviceWorker.controller.postMessage({
                            type: 'PREFETCH_PAGES',
                            pages: fullUrls
                        });
                    }
                }).catch(error => {
                    console.log('Service Worker registration failed:', error);
                });
            }
            
            // إخفاء رسالة التحميل فوراً
            const loadingElement = productsContainer.querySelector('.loading');
            if (loadingElement) {
                loadingElement.style.display = 'none';
            }
        });

        function playNotificationSound() {
            try {
                const notificationSound = document.getElementById('new-product-sound');
                if (notificationSound) {
                    notificationSound.currentTime = 0;
                    notificationSound.play().catch(e => {
                        console.log('تعذر تشغيل الصوت:', e);
                    });
                }
            } catch (error) {
                console.log('خطأ في تشغيل الصوت:', error);
            }
        }

        function initializeNavigationManager() {
            window.addEventListener('popstate', function(event) {
                if (!isBackButtonPressed) {
                    isBackButtonPressed = true;
                    cleanupAllIntervals();
                    closeAllModals();
                    setTimeout(() => {
                        window.location.href = 'index.html';
                    }, 300);
                }
            });

            history.pushState({ page: 'az-marketplace' }, '', window.location.href);
        }

        function cleanupAllIntervals() {
            if (onlineUsersInterval) {
                clearInterval(onlineUsersInterval);
                onlineUsersInterval = null;
            }
            
            if (autoViewInterval) {
                clearInterval(autoViewInterval);
                autoViewInterval = null;
            }
            
            if (autoLikeInterval) {
                clearInterval(autoLikeInterval);
                autoLikeInterval = null;
            }
            
            if (autoCommentInterval) {
                clearInterval(autoCommentInterval);
                autoCommentInterval = null;
            }
            
            if (favoriteMerchantsCheckInterval) {
                clearInterval(favoriteMerchantsCheckInterval);
                favoriteMerchantsCheckInterval = null;
            }
            
            if (adInterval) {
                clearInterval(adInterval);
                adInterval = null;
            }
        }

        function closeAllModals() {
            const gallery = document.getElementById('image-gallery');
            if (gallery && gallery.classList.contains('active')) {
                closeImageGallery();
            }
            
            const shareModal = document.getElementById('share-modal');
            if (shareModal && shareModal.classList.contains('active')) {
                closeShareModal();
            }
            
            const newProductsModal = document.getElementById('new-products-modal');
            if (newProductsModal && newProductsModal.classList.contains('active')) {
                closeNewProductsModal();
            }
            
            const merchantModal = document.getElementById('merchant-modal-overlay');
            if (merchantModal && merchantModal.classList.contains('active')) {
                closeMerchantModal();
            }
            
            const categoryModal = document.getElementById('category-modal-overlay');
            if (categoryModal && categoryModal.classList.contains('active')) {
                closeCategoryModal();
            }
            
            closeAllComments();
            
            if (filterBar && filterBar.style.display === 'flex') {
                hideFilterBar();
            }
        }

        function startFavoriteMerchantsCheck() {
            favoriteMerchantsCheckInterval = setInterval(() => {
                checkNewProductsFromFavoriteMerchants();
            }, 7000);
        }

        function checkNewProductsFromFavoriteMerchants() {
            if (Object.keys(favoriteProducts).length === 0) return;
            
            const favoriteMerchantIds = [...new Set(
                Object.keys(favoriteProducts)
                    .map(productId => allProducts.find(p => p.id === productId)?.userId)
                    .filter(Boolean)
            )];
            
            if (favoriteMerchantIds.length === 0) return;
            
            const newProducts = allProducts.filter(product => {
                const productDate = new Date(product.publishDate || product.createdAt || product.date || 0);
                if (productDate <= lastCheckTime) return false;
                
                if (!favoriteMerchantIds.includes(product.userId)) return false;
                
                if (openedProducts.includes(product.id)) return false;
                
                return true;
            });
            
            const productsByMerchant = {};
            newProducts.forEach(product => {
                if (!productsByMerchant[product.userId]) {
                    productsByMerchant[product.userId] = [];
                }
                productsByMerchant[product.userId].push(product);
            });
            
            if (Object.keys(productsByMerchant).length > 0) {
                showNewProductsModal(productsByMerchant);
            }
            
            lastCheckTime = new Date();
        }

        function showNewProductsModal(productsByMerchant) {
            const modal = document.getElementById('new-products-modal');
            const list = document.getElementById('new-products-list');
            
            if (!modal || !list) return;
            
            list.innerHTML = '';
            
            Object.keys(productsByMerchant).forEach(merchantId => {
                const merchant = allMerchants.find(m => m.id === merchantId);
                const merchantName = merchant ? (merchant.name || merchant.username) : 'تاجر';
                const count = productsByMerchant[merchantId].length;
                
                const item = document.createElement('div');
                item.className = 'new-product-item';
                item.innerHTML = `
                    <div class="merchant-name">
                        <i class="fas fa-store"></i>
                        ${merchantName}
                        <span class="products-count-badge">${count} منتج جديد</span>
                    </div>
                `;
                
                item.addEventListener('click', () => {
                    localStorage.setItem('selectedMerchantName', merchantName);
                    localStorage.setItem('selectedMerchantId', merchantId);
                    closeNewProductsModal();
                    saveScrollPosition();
                    window.location.href = 'ard_tagr.html';
                });
                
                list.appendChild(item);
            });
            
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeNewProductsModal() {
            const modal = document.getElementById('new-products-modal');
            if (modal) {
                modal.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function saveScrollPosition() {
            localStorage.setItem('scrollPosition', window.pageYOffset);
        }

        function restoreScrollPosition() {
            const savedPosition = localStorage.getItem('scrollPosition');
            if (savedPosition) {
                setTimeout(() => {
                    window.scrollTo(0, parseInt(savedPosition));
                    localStorage.removeItem('scrollPosition');
                }, 500);
            }
        }

        function isOfferValid(product) {
            if (!product.productType || product.productType !== 'عرض') {
                return false;
            }
            
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            if (product.endDate) {
                const endDate = new Date(product.endDate);
                endDate.setHours(0, 0, 0, 0);
                if (today > endDate) {
                    return false;
                }
            }
            
            if (product.startDate) {
                const startDate = new Date(product.startDate);
                startDate.setHours(0, 0, 0, 0);
                if (today < startDate) {
                    return false;
                }
            }
            
            return true;
        }

        function startAutoInteractions() {
            autoLikeInterval = setInterval(() => {
                autoLikeRandomProducts();
            }, 8000);
            
            autoCommentInterval = setInterval(() => {
                autoCommentRandomProduct();
            }, 1200000);
        }

        function autoLikeRandomProducts() {
            if (allProducts.length === 0) return;
            
            const likesToAdd = 7;
            
            const sortedProducts = [...allProducts].sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                return bDate - aDate;
            });
            
            for (let i = 0; i < likesToAdd; i++) {
                let product;
                if (Math.random() < 0.7 && sortedProducts.length > 0) {
                    const recentCount = Math.min(15, sortedProducts.length);
                    const randomIndex = getRandomInt(0, recentCount - 1);
                    product = sortedProducts[randomIndex];
                } else if (sortedProducts.length > 15) {
                    const oldProducts = sortedProducts.slice(15);
                    const randomIndex = getRandomInt(0, oldProducts.length - 1);
                    product = oldProducts[randomIndex];
                } else {
                    continue;
                }
                
                if (!product || !product.id) continue;
                
                addAutoLike(product.id);
            }
        }

        async function addAutoLike(productId) {
            try {
                const likesRef = db.ref(`products_stats/${productId}/likes`);
                const snapshot = await likesRef.once('value');
                let likes = snapshot.val() || [];
                if (!Array.isArray(likes)) likes = [];
                
                const randomUserId = 'auto_user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                
                if (!likes.includes(randomUserId)) {
                    likes.push(randomUserId);
                    await likesRef.set(likes);
                    
                    const likeStatEl = document.getElementById(`like-stat-${productId}`);
                    if (likeStatEl) {
                        likeStatEl.textContent = likes.length;
                    }
                }
            } catch (e) { 
                console.error('خطأ في إضافة الإعجاب التلقائي:', e); 
            }
        }

        function autoCommentRandomProduct() {
            if (allProducts.length === 0) return;
            
            const sortedProducts = [...allProducts].sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                return bDate - aDate;
            });
            
            let product;
            if (Math.random() < 0.8 && sortedProducts.length > 0) {
                const recentCount = Math.min(5, sortedProducts.length);
                const randomIndex = getRandomInt(0, recentCount - 1);
                product = sortedProducts[randomIndex];
            } else if (sortedProducts.length > 5) {
                const oldProducts = sortedProducts.slice(5);
                const randomIndex = getRandomInt(0, oldProducts.length - 1);
                product = oldProducts[randomIndex];
            } else {
                return;
            }
            
            if (!product || !product.id) return;
            
            addAutoComment(product.id, product.categoryId);
        }

        async function addAutoComment(productId, categoryId) {
            try {
                let categoryType = 'عام';
                if (categoryId) {
                    const category = allCategories.find(c => c.id === categoryId);
                    if (category && category.name) {
                        if (category.name.includes('ملابس') || category.name.includes('لباس')) categoryType = 'ملابس';
                        else if (category.name.includes('إلكترون') || category.name.includes('كهربائي')) categoryType = 'إلكترونيات';
                        else if (category.name.includes('أثاث') || category.name.includes('فرش')) categoryType = 'أثاث';
                        else if (category.name.includes('سيارة') || category.name.includes('مركبة')) categoryType = 'سيارات';
                        else if (category.name.includes('طعام') || category.name.includes('شراب')) categoryType = 'أطعمة';
                    }
                }
                
                const comments = commentTexts[categoryType] || commentTexts['عام'];
                const randomCommentIndex = getRandomInt(0, comments.length - 1);
                let commentText = comments[randomCommentIndex];
                
                const userNames = ["مستخدم", "زبون", "شاري"];
                const randomUserName = userNames[getRandomInt(0, userNames.length - 1)];
                
                const commentId = Date.now().toString();
                const comment = { 
                    text: commentText, 
                    author: randomUserName, 
                    date: new Date().toISOString() 
                };
                
                await db.ref(`comments/${productId}/${commentId}`).set(comment);
                
                const commentStatEl = document.getElementById(`comment-stat-${productId}`);
                if (commentStatEl) {
                    commentStatEl.textContent = (parseInt(commentStatEl.textContent) || 0) + 1;
                }
                
                const commentsCountEl = document.querySelector(`#comments-${productId} .comments-count`);
                if (commentsCountEl) {
                    commentsCountEl.textContent = (parseInt(commentsCountEl.textContent) || 0) + 1;
                }
            } catch (e) {
                console.error('خطأ في إضافة التعليق التلقائي:', e);
            }
        }

        function getOnlineUsersByTime() {
            const now = new Date();
            const hour = now.getHours();
            
            if (hour >= 6 && hour < 10) {
                return getRandomInt(100, 400);
            } else if (hour >= 10 && hour < 15) {
                return getRandomInt(400, 3000);
            } else if (hour >= 15 && hour < 18) {
                return getRandomInt(3000, 5000);
            } else if (hour >= 18 && hour < 23) {
                return getRandomInt(5000, 13000);
            } else if (hour >= 23 || hour < 1) {
                return getRandomInt(200, 350);
            } else {
                return getRandomInt(100, 200);
            }
        }

        function updateRandomOnlineUsers() {
            const oldCount = onlineUsersCount;
            
            if (consecutiveChanges >= getRandomInt(5, 7)) {
                onlineUsersDirection = -1;
                consecutiveChanges = 0;
            } else if (consecutiveChanges <= -getRandomInt(3, 5)) {
                onlineUsersDirection = 1;
                consecutiveChanges = 0;
            }
            
            const changeAmount = getRandomInt(2, 16) * onlineUsersDirection;
            
            let newCount = onlineUsersCount + changeAmount;
            const currentTimeRange = getOnlineUsersRangeByTime();
            newCount = Math.max(currentTimeRange.min, Math.min(currentTimeRange.max, newCount));
            
            onlineUsersCount = newCount;
            consecutiveChanges += onlineUsersDirection;
            
            localStorage.setItem('randomOnlineUsersCount', onlineUsersCount.toString());
            
            updateOnlineUsersCount(onlineUsersCount, oldCount);
        }

        function getOnlineUsersRangeByTime() {
            const now = new Date();
            const hour = now.getHours();
            
            if (hour >= 6 && hour < 10) {
                return { min: 100, max: 400 };
            } else if (hour >= 10 && hour < 15) {
                return { min: 400, max: 3000 };
            } else if (hour >= 15 && hour < 18) {
                return { min: 3000, max: 5000 };
            } else if (hour >= 18 && hour < 23) {
                return { min: 5000, max: 13000 };
            } else if (hour >= 23 || hour < 1) {
                return { min: 200, max: 350 };
            } else {
                return { min: 100, max: 200 };
            }
        }

        function updateOnlineUsersCount(newCount, oldCount = null) {
            const onlineUsersEl = document.getElementById('header-online-users');
            
            if (oldCount !== null && onlineUsersEl) {
                if (newCount > oldCount) {
                    onlineUsersEl.classList.add('increase');
                    setTimeout(() => onlineUsersEl.classList.remove('increase'), 1000);
                } else if (newCount < oldCount) {
                    onlineUsersEl.classList.add('decrease');
                    setTimeout(() => onlineUsersEl.classList.remove('decrease'), 1000);
                }
            }
            
            if (usersCountEl) usersCountEl.textContent = newCount;
            if (headerUsersCountEl) headerUsersCountEl.textContent = newCount;
        }

        function startRandomOnlineUsers() {
            const savedCount = localStorage.getItem('randomOnlineUsersCount');
            onlineUsersCount = savedCount ? parseInt(savedCount) : getOnlineUsersByTime();
            
            updateOnlineUsersCount(onlineUsersCount);
            
            onlineUsersInterval = setInterval(() => {
                updateRandomOnlineUsers();
            }, 10000);
        }

        function startAutoViewIncrement() {
            autoViewInterval = setInterval(() => {
                incrementProductViews();
            }, 3000);
        }

        function incrementProductViews() {
            if (allProducts.length === 0) return;
            
            const sortedProducts = [...allProducts].sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                return bDate - aDate;
            });
            
            const recentProducts = sortedProducts.slice(0, Math.min(10, sortedProducts.length));
            const otherProducts = sortedProducts.slice(10);
            
            let product;
            if (Math.random() < 0.7 && recentProducts.length > 0) {
                const randomIndex = getRandomInt(0, recentProducts.length - 1);
                product = recentProducts[randomIndex];
            } else if (otherProducts.length > 0) {
                const randomIndex = getRandomInt(0, otherProducts.length - 1);
                product = otherProducts[randomIndex];
            } else {
                return;
            }
            
            if (!product || !product.id) return;
            
            const productId = product.id;
            const viewStatEl = document.getElementById(`view-stat-${productId}`);
            
            if (viewStatEl) {
                const increment = getRandomInt(1, 3);
                const currentViews = parseInt(viewStatEl.textContent) || 150;
                const newViews = currentViews + increment;
                viewStatEl.textContent = newViews;
                
                db.ref(`products_stats/${productId}/views`).transaction(current => (current || 0) + increment);
            }
        }

        function initializeStableUserId() {
            let userId = localStorage.getItem('stableUserId');
            
            if (!userId) {
                userId = 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('stableUserId', userId);
            }
            
            currentUserId = userId;
            return userId;
        }

        function initializeUserPresence() {
            userPresenceRef = db.ref('online_users/' + currentUserId);
            onlineUsersRef = db.ref('online_users');
            connectedRef = db.ref('.info/connected');
            
            const userVisitData = {
                userId: currentUserId,
                entryTime: new Date().toISOString(),
                userAgent: navigator.userAgent,
                screenResolution: `${screen.width}x${screen.height}`
            };
            
            db.ref('user_visits/' + currentUserId).set(userVisitData);
            
            connectedRef.on('value', function(snap) {
                if (snap.val() === true) {
                    userPresenceRef.onDisconnect().remove();
                    userPresenceRef.set({
                        id: currentUserId,
                        name: 'مستخدم ' + currentUserId.substring(0, 6),
                        lastOnline: firebase.database.ServerValue.TIMESTAMP,
                        joinedAt: firebase.database.ServerValue.TIMESTAMP,
                        visitStart: new Date().toISOString()
                    });
                } else {
                    const exitTime = new Date().toISOString();
                    db.ref('user_visits/' + currentUserId).update({
                        exitTime: exitTime,
                        duration: Math.floor((new Date(exitTime) - new Date(userVisitData.entryTime)) / 1000)
                    });
                }
            });

            onlineUsersRef.on('value', (snapshot) => {
                const onlineUsers = snapshot.val();
                const realOnlineCount = onlineUsers ? Object.keys(onlineUsers).length : 0;
                if (realOnlineUsersEl) {
                    realOnlineUsersEl.textContent = realOnlineCount;
                }
            });
        }

        function normalizeText(text) {
            if (!text) return '';
            
            return text
                .replace(/[أإآٱ]/g, 'ا')
                .replace(/[ة]/g, 'ه')
                .replace(/[ى]/g, 'ي')
                .replace(/[ئؤ]/g, 'ء')
                .replace(/[ﻻﻷﻵﻹ]/g, 'لا')
                .replace(/[ﻙ]/g, 'ك')
                .replace(/[ﻫ]/g, 'ه')
                .replace(/[ﻯﻱ]/g, 'ي')
                .toLowerCase();
        }

        function saveSearchTermToAsnaf(term) {
            if (!term || term.trim().length === 0) return;
            
            const termExists = allProducts.some(product => {
                const productName = normalizeText(product.name || '');
                const productDesc = normalizeText(product.description || '');
                const searchTerm = normalizeText(term);
                
                return productName.includes(searchTerm) || productDesc.includes(searchTerm);
            });
            
            if (!termExists) {
                const searchData = {
                    term: term,
                    timestamp: new Date().toISOString(),
                    userId: currentUserId
                };
                
                db.ref('asnaf_slect/' + Date.now()).set(searchData)
                    .then(() => {
                    })
                    .catch(error => {
                        console.error('❌ خطأ في حفظ مصطلح البحث:', error);
                    });
            }
        }

        async function loadAdvertisementTexts() {
            try {
                const adsSnapshot = await db.ref('اعلانات نصيه').once('value');
                const adsData = adsSnapshot.val();
                
                advertisementTexts = [];
                
                if (adsData) {
                    const allFields = Object.keys(adsData);
                    
                    allFields.forEach(fieldName => {
                        const adText = adsData[fieldName];
                        
                        if (adText && typeof adText === 'string' && adText.trim().length > 0) {
                            advertisementTexts.push(adText.trim());
                        }
                    });
                    
                    if (advertisementTexts.length > 0) {
                        startAdvertisementRotation();
                    } else {
                        if (footerTextEl) {
                            footerTextEl.textContent = 'جميع الحقوق محفوظة لدى المميز سوفت للأنظمة المحاسبية المتكاملة';
                        }
                    }
                } else {
                    if (footerTextEl) {
                        footerTextEl.textContent = 'جميع الحقوق محفوظة لدى المميز سوفت للأنظمة المحاسبية المتكاملة';
                    }
                }
            } catch (error) {
                console.error('❌ خطأ في تحميل الإعلانات النصية:', error);
                if (footerTextEl) {
                    footerTextEl.textContent = 'جميع الحقوق محفوظة لدى المميز سوفت للأنظمة المحاسبية المتكاملة';
                }
            }
        }

        function startAdvertisementRotation() {
            if (advertisementTexts.length === 0) return;
            
            currentAdIndex = 0;
            showNextAdvertisement();
        }

        function showNextAdvertisement() {
            if (advertisementTexts.length === 0) return;
            
            currentAdIndex = (currentAdIndex + 1) % advertisementTexts.length;
            const currentAd = advertisementTexts[currentAdIndex];
            
            if (footerTextEl) {
                footerTextEl.textContent = currentAd;
                
                const textLength = currentAd.length;
                const baseDuration = 5000;
                const charDuration = 100;
                const totalDuration = baseDuration + (textLength * charDuration);
                
                footerTextEl.style.animation = 'none';
                void footerTextEl.offsetWidth;
                footerTextEl.style.animation = `slideText ${totalDuration}ms linear`;
                
                setTimeout(() => {
                    showNextAdvertisement();
                }, totalDuration);
            }
        }

        function initializeSpeechRecognition() {
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (!SpeechRecognition || !voiceSearchBtn) {
                if (voiceSearchBtn) {
                    voiceSearchBtn.style.display = 'none';
                }
                return;
            }
            
            recognition = new SpeechRecognition();
            
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = 'ar-SA';
            
            recognition.onresult = function(event) {
                const transcript = event.results[0][0].transcript;
                if (transcript.trim().length > 0) {
                    searchInput.value = transcript;
                    filterProducts();
                    showNotification('تم تحويل الكلام إلى نص: ' + transcript, 'success');
                } else {
                    speakText('عفوا الصوت غير مفهوم اعد مره اخرى');
                    showNotification('عفوا الصوت غير مفهوم اعد مره اخرى', 'error');
                }
            };
            
            recognition.onerror = function(event) {
                console.error('خطأ في التعرف الصوتي:', event.error);
                if (event.error === 'not-allowed') {
                    showNotification('يرجى السماح للموقع باستخدام الميكروفون', 'error');
                } else if (event.error === 'audio-capture') {
                    showNotification('لم يتم العثور على ميكروفون', 'error');
                } else if (event.error === 'no-speech') {
                    speakText('عفوا الصوت غير مفهوم اعد مره اخرى');
                    showNotification('عفوا الصوت غير مفهوم اعد مره اخرى', 'error');
                } else {
                    showNotification('حدث خطأ في التعرف الصوتي، يرجى المحاولة مرة أخرى', 'error');
                }
                stopListening();
            };
            
            recognition.onend = function() {
                stopListening();
            };
        }

        function speakText(text) {
            if ('speechSynthesis' in window) {
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = 'ar-SA';
                utterance.rate = 1;
                utterance.pitch = 1;
                window.speechSynthesis.speak(utterance);
            }
        }

        function toggleVoiceSearch() {
            if (!recognition) {
                showNotification('المتصفح لا يدعم التعرف الصوتي', 'error');
                return;
            }
            
            if (isListening) {
                recognition.stop();
            } else {
                startListening();
            }
        }

        function startListening() {
            try {
                recognition.start();
                isListening = true;
                if (voiceSearchBtn) {
                    voiceSearchBtn.classList.add('listening');
                    voiceSearchBtn.innerHTML = '<i class="fas fa-microphone-slash"></i>';
                    voiceSearchBtn.title = 'إيقاف التعرف الصوتي';
                }
                showNotification('جاري الاستماع... تحدث الآن', 'info');
            } catch (error) {
                console.error('خطأ في بدء التعرف الصوتي:', error);
                showNotification('خطأ في بدء التعرف الصوتي. تأكد من السماح باستخدام الميكروفون', 'error');
                stopListening();
            }
        }

        function stopListening() {
            isListening = false;
            if (voiceSearchBtn) {
                voiceSearchBtn.classList.remove('listening');
                voiceSearchBtn.innerHTML = '<i class="fas fa-microphone"></i>';
                voiceSearchBtn.title = 'البحث الصوتي';
            }
        }

        function initializeApp() {
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
            }
            
            hideFilterBar();
            
            newProductsModal = document.getElementById('new-products-modal');
            if (newProductsModal) {
                document.getElementById('new-products-close').addEventListener('click', closeNewProductsModal);
                newProductsModal.addEventListener('click', (e) => {
                    if (e.target.id === 'new-products-modal') {
                        closeNewProductsModal();
                    }
                });
            }
        }

        function initializeGallery() {
            if (!galleryViewport) return;
            
            galleryViewport.addEventListener('mousedown', startGalleryDrag);
            galleryViewport.addEventListener('touchstart', startGalleryDragTouch);
            
            galleryViewport.addEventListener('wheel', handleGalleryWheel);
            
            if (galleryPrevBtn) galleryPrevBtn.addEventListener('click', () => navigateGallery(-1));
            if (galleryNextBtn) galleryNextBtn.addEventListener('click', () => navigateGallery(1));
            if (galleryZoomBtn) galleryZoomBtn.addEventListener('click', toggleImageZoom);
            if (galleryRotateBtn) galleryRotateBtn.addEventListener('click', rotateImage);
            if (galleryCloseBtn) galleryCloseBtn.addEventListener('click', closeImageGallery);
            
            document.addEventListener('keydown', handleGalleryKeydown);
            
            const gallery = document.getElementById('image-gallery');
            if (gallery) {
                gallery.addEventListener('click', (e) => {
                    if (e.target.id === 'image-gallery') {
                        closeImageGallery();
                    }
                });
            }
        }

        function setupEventListeners() {
            if (searchInput) searchInput.addEventListener('input', filterProducts);
            if (governorateSelect) governorateSelect.addEventListener('change', handleGovernorateChange);
            if (regionSelect) regionSelect.addEventListener('change', handleRegionChange);
            if (sortSelect) sortSelect.addEventListener('change', filterProducts);
            if (resetButton) resetButton.addEventListener('click', resetFilters);
            if (filterControlBtn) filterControlBtn.addEventListener('click', toggleFilterBar);
            
            // زر فتح الصفحة الكلاسيكية
            if (classicPageBtn) {
                classicPageBtn.addEventListener('click', function() {
                    window.open('1_1k.html', '_blank');
                });
            }
            
            if (merchantTextInput) merchantTextInput.addEventListener('click', openMerchantModal);
            if (merchantModalSearchInput) merchantModalSearchInput.addEventListener('input', filterMerchantModalList);
            if (merchantModalCancel) merchantModalCancel.addEventListener('click', closeMerchantModal);
            if (merchantModalConfirm) merchantModalConfirm.addEventListener('click', applyMerchantFilter);
            if (merchantModalAll) merchantModalAll.addEventListener('click', applyAllMerchants);
            
            if (merchantModalOverlay) {
                merchantModalOverlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeMerchantModal();
                    }
                });
            }

            if (categoryTextInput) categoryTextInput.addEventListener('click', openCategoryModal);
            if (secondaryCategoryTextInput) secondaryCategoryTextInput.addEventListener('click', openCategoryModal);
            if (categoryModalSearchInput) categoryModalSearchInput.addEventListener('input', filterCategoryModalList);
            if (categoryModalCancel) categoryModalCancel.addEventListener('click', closeCategoryModal);
            if (categoryModalConfirm) categoryModalConfirm.addEventListener('click', applyCategoryFilter);
            if (categoryModalAll) categoryModalAll.addEventListener('click', applyAllCategories);
            
            if (categoryModalOverlay) {
                categoryModalOverlay.addEventListener('click', function(e) {
                    if (e.target === this) {
                        closeCategoryModal();
                    }
                });
            }

            if (showMoreBtn) showMoreBtn.addEventListener('click', toggleFilterBar);
            if (secondaryFavoritesBtn) secondaryFavoritesBtn.addEventListener('click', toggleFavoritesView);

            if (voiceSearchBtn) voiceSearchBtn.addEventListener('click', toggleVoiceSearch);

            document.addEventListener('click', (e) => {
                if (isCommentsOpen && !e.target.closest('.comments-section') && 
                    !e.target.closest('.btn-comment') && !e.target.closest('.btn-comment-toggle')) {
                    closeAllComments();
                }
            });

            window.addEventListener('scroll', handleScroll);
            if (scrollToTopBtn) scrollToTopBtn.addEventListener('click', scrollToTop);

            if (shareModalClose) shareModalClose.addEventListener('click', closeShareModal);
            if (shareOptions) {
                shareOptions.forEach(option => {
                    option.addEventListener('click', handleShareOption);
                });
            }
            if (shareModal) {
                shareModal.addEventListener('click', (e) => {
                    if (e.target.id === 'share-modal') {
                        closeShareModal();
                    }
                });
            }

            window.addEventListener('beforeunload', () => {
                cleanupAllIntervals();
                saveDataToCache();
            });
        }

        function handleGalleryKeydown(e) {
            const gallery = document.getElementById('image-gallery');
            if (!gallery || !gallery.classList.contains('active')) return;
            
            switch(e.key) {
                case 'Escape':
                    closeImageGallery();
                    break;
                case 'ArrowLeft':
                    navigateGallery(-1);
                    break;
                case 'ArrowRight':
                    navigateGallery(1);
                    break;
                case ' ':
                    e.preventDefault();
                    toggleImageZoom();
                    break;
                case 'r':
                case 'R':
                    rotateImage();
                    break;
            }
        }

        function startGalleryDrag(e) {
            if (!galleryViewport || galleryImages.length <= 1) return;
            
            isGalleryDragging = true;
            dragStartX = e.clientX - sliderTranslateX;
            galleryViewport.style.cursor = 'grabbing';
            
            document.addEventListener('mousemove', dragGallery);
            document.addEventListener('mouseup', stopGalleryDrag);
        }

        function startGalleryDragTouch(e) {
            if (!galleryViewport || galleryImages.length <= 1) return;
            
            isGalleryDragging = true;
            dragStartX = e.touches[0].clientX - sliderTranslateX;
            galleryViewport.style.cursor = 'grabbing';
            
            document.addEventListener('touchmove', dragGalleryTouch);
            document.addEventListener('touchend', stopGalleryDrag);
        }

        function dragGallery(e) {
            if (!isGalleryDragging || !gallerySlider) return;
            
            e.preventDefault();
            const x = e.clientX - dragStartX;
            sliderTranslateX = x;
            gallerySlider.style.transform = `translateX(${x}px)`;
        }

        function dragGalleryTouch(e) {
            if (!isGalleryDragging || !gallerySlider) return;
            
            e.preventDefault();
            const x = e.touches[0].clientX - dragStartX;
            sliderTranslateX = x;
            gallerySlider.style.transform = `translateX(${x}px)`;
        }

        function stopGalleryDrag() {
            if (!isGalleryDragging) return;
            
            isGalleryDragging = false;
            if (galleryViewport) {
                galleryViewport.style.cursor = 'grab';
            }
            
            document.removeEventListener('mousemove', dragGallery);
            document.removeEventListener('mouseup', stopGalleryDrag);
            document.removeEventListener('touchmove', dragGalleryTouch);
            document.removeEventListener('touchend', stopGalleryDrag);
            
            if (!galleryViewport || !gallerySlider) return;
            
            const viewportWidth = galleryViewport.offsetWidth;
            const threshold = viewportWidth / 4;
            
            if (Math.abs(sliderTranslateX) > threshold) {
                if (sliderTranslateX > 0) {
                    navigateGallery(-1);
                } else {
                    navigateGallery(1);
                }
            }
            
            sliderTranslateX = -currentGalleryIndex * viewportWidth;
            gallerySlider.style.transform = `translateX(${sliderTranslateX}px)`;
            gallerySlider.style.transition = 'transform 0.3s ease';
            
            setTimeout(() => {
                if (gallerySlider) {
                    gallerySlider.style.transition = 'transform 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94)';
                }
            }, 300);
        }

        function handleGalleryWheel(e) {
            if (isImageZoomed) {
                e.preventDefault();
                const delta = e.deltaY > 0 ? -0.1 : 0.1;
                currentScale = Math.max(0.5, Math.min(3, currentScale + delta));
                updateImageTransform();
            } else if (Math.abs(e.deltaX) > Math.abs(e.deltaY)) {
                e.preventDefault();
                if (e.deltaX > 0) {
                    navigateGallery(-1);
                } else {
                    navigateGallery(1);
                }
            }
        }

        function handleScroll() {
            if (!scrollToTopBtn) return;
            
            if (window.pageYOffset > 300) {
                scrollToTopBtn.classList.add('visible');
            } else {
                scrollToTopBtn.classList.remove('visible');
            }
        }

        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }

        function toggleFavoritesView() {
            showFavoritesOnly = !showFavoritesOnly;
            
            if (showFavoritesOnly) {
                displayFavoriteProducts();
                showNotification('عرض المنتجات المفضلة فقط', 'info');
            } else {
                showFavoritesOnly = false;
                filterProducts();
                showNotification('عرض جميع المنتجات', 'info');
            }
        }

        function checkUrlForProduct() {
            const urlParams = new URLSearchParams(window.location.search);
            const productId = urlParams.get('productId');
            if (productId) {
                setTimeout(() => {
                    highlightProduct(productId);
                }, 800);
            }
        }

        function highlightProduct(productId) {
            const productCard = document.getElementById(`product-${productId}`);
            if (!productCard) return;
            productCard.scrollIntoView({ behavior: 'smooth', block: 'center' });
            productCard.classList.add('highlighted');
            setTimeout(() => productCard.classList.remove('highlighted'), 6000);
        }

        async function loadAllData() {
            try {
                const [productsSnap, merchantsSnap, governoratesSnap, regionsSnap, categoriesSnap] = await Promise.all([
                    db.ref("products").once("value"),
                    db.ref("merchants").once("value"),
                    db.ref("governorates").once("value"),
                    db.ref("regions").once("value"),
                    db.ref("categories").once("value")
                ]);
                
                allProducts = convertFirebaseData(productsSnap.val(), "products") || [];
                allMerchants = convertFirebaseData(merchantsSnap.val(), "merchants") || [];
                allGovernorates = convertFirebaseData(governoratesSnap.val(), "governorates") || [];
                allRegions = convertFirebaseData(regionsSnap.val(), "regions") || [];
                allCategories = convertFirebaseData(categoriesSnap.val(), "categories") || [];

                // تحسين: تنظيف وتحسين بيانات التجار
                allMerchants = allMerchants.map(merchant => {
                    if (!validateMerchantData(merchant)) {
                        return null;
                    }
                    return merchant;
                }).filter(Boolean);

                saveDataToCache();
                populateFilterOptions();
                
                const loadingElement = productsContainer.querySelector('.loading');
                if (loadingElement) {
                    loadingElement.style.display = 'none';
                }
                
            } catch (error) {
                console.error("خطأ في تحميل البيانات:", error);
                throw error;
            }
        }

        function convertFirebaseData(firebaseData, dataType = "") {
            if (!firebaseData) return [];
            try {
                // إذا كان firebaseData مصفوفة بالفعل، ارجعها كما هي
                if (Array.isArray(firebaseData)) {
                    return firebaseData.filter(item => item && (item.id || item.name));
                }
                
                // إذا كان كائنًا، حوله إلى مصفوفة
                if (typeof firebaseData === 'object') {
                    const result = [];
                    Object.entries(firebaseData).forEach(([id, data]) => {
                        if (data && typeof data === 'object') {
                            // تأكد من وجود معرف
                            if (!data.id) {
                                data.id = id;
                            }
                            result.push(data);
                        }
                    });
                    return result;
                }
                
                return [];
            } catch (e) {
                console.error("خطأ في تحويل البيانات:", e, "DataType:", dataType);
                return [];
            }
        }

        function populateFilterOptions() {
            if (!governorateSelect) return;
            
            governorateSelect.innerHTML = '<option value="">جميع المحافظات</option>';
            if (allGovernorates && allGovernorates.length > 0) {
                allGovernorates.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g.id || g.name;
                    opt.textContent = g.name || g.id;
                    governorateSelect.appendChild(opt);
                });
            }

            updateRegionOptions();
            updateModalCategoryList();
        }

        function updateRegionOptions() {
            if (!regionSelect) return;
            
            const selectedGovernorate = governorateSelect.value;
            regionSelect.innerHTML = '<option value="">جميع المناطق</option>';

            if (selectedGovernorate && allGovernorates) {
                const gov = allGovernorates.find(g => 
                    (g.id === selectedGovernorate) || (g.name === selectedGovernorate));
                if (gov && gov.areas) {
                    Object.entries(gov.areas).forEach(([areaId, areaName]) => {
                        const opt = document.createElement('option');
                        opt.value = areaId;
                        opt.textContent = areaName;
                        regionSelect.appendChild(opt);
                    });
                }
            } else if (allRegions && allRegions.length > 0) {
                allRegions.forEach(r => {
                    const opt = document.createElement('option');
                    opt.value = r.id || r.name;
                    opt.textContent = r.name || r.id;
                    regionSelect.appendChild(opt);
                });
            }
        }

        function updateModalCategoryList() {
            const categoryCounts = {};
            
            allProducts.forEach(product => {
                if (product.categoryId) {
                    const merchant = allMerchants.find(m => m.id === product.userId);
                    if (merchant) {
                        const isActive = isActiveMerchant(merchant);
                        
                        if (isActive) {
                            categoryCounts[product.categoryId] = (categoryCounts[product.categoryId] || 0) + 1;
                        }
                    }
                }
            });
            
            filteredModalCategories = [...allCategories].sort((a, b) => {
                const countA = categoryCounts[a.id] || 0;
                const countB = categoryCounts[b.id] || 0;
                return countB - countA;
            });
            
            filteredModalCategories.forEach(category => {
                category.productCount = categoryCounts[category.id] || 0;
            });
        }

        function handleGovernorateChange() { 
            updateRegionOptions(); 
            filterProducts(); 
        }

        function handleRegionChange() { 
            filterProducts(); 
        }

        function displayProducts(products) {
            if (showFavoritesOnly) {
                displayFavoriteProducts();
                return;
            }
            
            if (!productsContainer) return;
            
            productsContainer.innerHTML = '';
            
            const filteredProducts = products.filter(product => {
                if (product.productType === 'عرض' && !isOfferValid(product)) {
                    return false;
                }
                
                // تحسين: إظهار المنتج حتى لو لم يتم العثور على تاجره
                const merchant = allMerchants.find(m => m.id === product.userId);
                if (!merchant) {
                    return true; // إظهار المنتج حتى بدون تاجر
                }
                
                return isActiveMerchant(merchant);
            });
            
            if (!filteredProducts || filteredProducts.length === 0) {
                const activeMerchantsCount = countActiveMerchants();
                productsContainer.innerHTML = `
                    <div class="no-products">
                        <p>لا توجد منتجات متاحة حالياً</p>
                        <p>المنتجات الإجمالية: ${allProducts.length}</p>
                        <p>التجار النشطين: ${activeMerchantsCount}</p>
                        <button onclick="resetFilters()" style="margin-top:10px;padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer">عرض جميع المنتجات</button>
                    </div>
                `;
                return;
            }

            if (productsCountEl) {
                productsCountEl.textContent = ` ${filteredProducts.length}`;
            }

            const sorted = sortProductsByPriority(filteredProducts);
            const groupedProducts = groupProductsByCategory(sorted);

            displayGroupedProducts(groupedProducts);
        }

        function groupProductsByCategory(products) {
            const groups = {};
            
            products.forEach(p => {
                const merchant = allMerchants.find(m => m.id === p.userId);
                
                // تحسين: إذا لم يكن هناك تاجر، نعرض المنتج تحت قسم "غير مصنف"
                let isActive = true;
                if (merchant) {
                    isActive = isActiveMerchant(merchant);
                }
                
                if (!isActive) return;
                
                const categoryId = p.categoryId || 'غير مصنف';
                const categoryName = p.categoryId ? 
                    (allCategories.find(c => c.id === p.categoryId)?.name || 'غير مصنف') : 'غير مصنف';
                
                if (!groups[categoryId]) {
                    groups[categoryId] = {
                        name: categoryName,
                        products: []
                    };
                }
                
                groups[categoryId].products.push(p);
            });
            
            return groups;
        }

        function displayGroupedProducts(groupedProducts) {
            if (!productsContainer) return;
            
            const grid = document.createElement('div');
            grid.className = 'products';

            Object.keys(groupedProducts).forEach(categoryId => {
                const group = groupedProducts[categoryId];
                
                const categoryContainer = document.createElement('div');
                categoryContainer.className = 'category-container';
                categoryContainer.id = `category-${categoryId}`;
                
                const categoryHeader = document.createElement('div');
                categoryHeader.className = 'category-header';
                
                const categoryTitle = document.createElement('div');
                categoryTitle.className = 'category-title';
                categoryTitle.textContent = group.name;
                
                const categoryCount = document.createElement('div');
                categoryCount.className = 'category-count';
                categoryCount.textContent = `${group.products.length} منتج`;
                
                categoryHeader.appendChild(categoryTitle);
                categoryHeader.appendChild(categoryCount);
                categoryContainer.appendChild(categoryHeader);
                
                group.products.forEach(p => {
                    const merchant = allMerchants.find(m => m.id === p.userId);
                    
                    // تحسين: إذا لم يكن هناك تاجر، نعرض المنتج بدون بيانات التاجر
                    const card = createProductCard(p, merchant);
                    categoryContainer.appendChild(card);
                });
                
                grid.appendChild(categoryContainer);
            });

            if (grid.children.length === 0) {
                const activeMerchantsCount = countActiveMerchants();
                productsContainer.innerHTML = `
                    <div class="no-products">
                        <p>لا توجد منتجات تطابق معايير البحث</p>
                        <p>المنتجات الإجمالية: ${allProducts.length}</p>
                        <p>التجار النشطين: ${activeMerchantsCount}</p>
                        <button onclick="resetFilters()" style="margin-top:10px;padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer">عرض جميع المنتجات</button>
                    </div>
                `;
            } else {
                productsContainer.appendChild(grid);
            }
        }

        function sortProductsByPriority(products) {
            const sortBy = sortSelect ? sortSelect.value : 'date';
            
            if (sortBy && sortBy !== 'date' && sortBy !== 'preference' && sortBy !== 'offers') {
                return sortProductsByOption(products, sortBy);
            }
            
            if (sortBy === 'preference') {
                return sortProductsByPreference(products);
            }
            
            if (sortBy === 'offers') {
                return sortProductsByOffers(products);
            }
            
            return [...products].sort((a, b) => {
                const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                
                return bDate - aDate;
            });
        }

        function sortProductsByOption(products, sortBy) {
            return [...products].sort((a, b) => {
                let result = 0;
                
                switch(sortBy) {
                    case 'name':
                        const nameA = (a.name || '').toLowerCase();
                        const nameB = (b.name || '').toLowerCase();
                        result = nameA.localeCompare(nameB, 'ar');
                        
                        if (result === 0) {
                            const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                            const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                            result = bDate - aDate;
                        }
                        break;
                    
                    case 'category':
                        const categoryA = getCategoryName(a.categoryId) || '';
                        const categoryB = getCategoryName(b.categoryId) || '';
                        result = categoryA.localeCompare(categoryB, 'ar');
                        
                        if (result === 0) {
                            const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                            const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                            result = bDate - aDate;
                            
                            if (result === 0) {
                                const nameA = (a.name || '').toLowerCase();
                                const nameB = (b.name || '').toLowerCase();
                                result = nameA.localeCompare(nameB, 'ar');
                            }
                        }
                        break;
                    
                    case 'price':
                        const priceA = parseFloat(a.price) || 0;
                        const priceB = parseFloat(b.price) || 0;
                        result = priceA - priceB;
                        
                        if (result === 0) {
                            const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                            const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                            result = bDate - aDate;
                        }
                        break;
                    
                    case 'merchant':
                        const merchantA = getMerchantName(a.userId) || '';
                        const merchantB = getMerchantName(b.userId) || '';
                        result = merchantA.localeCompare(merchantB, 'ar');
                        
                        if (result === 0) {
                                const nameA = (a.name || '').toLowerCase();
                                const nameB = (b.name || '').toLowerCase();
                                result = nameA.localeCompare(nameB, 'ar');
                                
                                if (result === 0) {
                                    const aDate = new Date(a.publishDate || a.createdAt || a.date || 0);
                                    const bDate = new Date(b.publishDate || b.createdAt || b.date || 0);
                                    result = bDate - aDate;
                                }
                            }
                            break;
                        
                        case 'date':
                        default:
                            const dateA = new Date(a.publishDate || a.createdAt || a.date || 0);
                            const dateB = new Date(b.publishDate || b.createdAt || b.date || 0);
                            result = dateB - aDate;
                            break;
                    }
                    
                    return result;
                });
            }

            function sortProductsByPreference(products) {
                return [...products].sort((a, b) => {
                    const aPreferenceScore = calculatePreferenceScoreWithViews(a);
                    const bPreferenceScore = calculatePreferenceScoreWithViews(b);
                    
                    if (aPreferenceScore !== bPreferenceScore) {
                        return bPreferenceScore - aPreferenceScore;
                    }
                    
                    const nameA = (a.name || '').toLowerCase();
                    const nameB = (b.name || '').toLowerCase();
                    return nameA.localeCompare(nameB, 'ar');
                });
            }

            function sortProductsByOffers(products) {
                return [...products].sort((a, b) => {
                    const aIsOffer = isOfferValid(a);
                    const bIsOffer = isOfferValid(b);
                    
                    if (aIsOffer && !bIsOffer) return -1;
                    if (!aIsOffer && bIsOffer) return 1;
                    
                    const nameA = (a.name || '').toLowerCase();
                    const nameB = (b.name || '').toLowerCase();
                    return nameA.localeCompare(nameB, 'ar');
                });
            }

            function calculatePreferenceScoreWithViews(product) {
                let score = 0;
                
                if (product.categoryId && userInterests[product.categoryId]) {
                    score += userInterests[product.categoryId] * 10;
                }
                
                if (favoriteProducts[product.id]) {
                    score += 20;
                }
                
                const searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                const productName = (product.name || '').toLowerCase();
                const productDesc = (product.description || '').toLowerCase();
                
                searchHistory.forEach(term => {
                    if (productName.includes(term.toLowerCase()) || productDesc.includes(term.toLowerCase())) {
                        score += 5;
                    }
                });
                
                if (userViewHistory[product.id]) {
                    const viewTime = new Date(userViewHistory[product.id]);
                    const now = new Date();
                    const hoursSinceView = (now - viewTime) / (1000 * 60 * 60);
                    
                    if (hoursSinceView < 1) {
                        score += 30;
                    } else if (hoursSinceView < 24) {
                        score += 20;
                    } else if (hoursSinceView < 72) {
                        score += 10;
                    }
                }
                
                return score;
            }

            function getCategoryName(categoryId) {
                const category = allCategories.find(c => c.id === categoryId);
                return category ? category.name : '';
            }

            function getMerchantName(merchantId) {
                const merchant = allMerchants.find(m => m.id === merchantId);
                return merchant ? (merchant.name || merchant.username) : '';
            }

            function displayFavoriteProducts() {
                if (!productsContainer) return;
                
                productsContainer.innerHTML = '';
                
                const favoriteProductIds = Object.keys(favoriteProducts);
                const favoriteProductsList = allProducts.filter(p => favoriteProductIds.includes(p.id));
                
                if (favoriteProductsList.length === 0) {
                    productsContainer.innerHTML = `
                        <div class="no-products">
                            <p>لا توجد منتجات في المفضلة</p>
                            <p>يمكنك إضافة منتجات إلى المفضلة بالنقر على أيقونة القلب في البطاقات</p>
                            <button onclick="closeFavoritesView()" style="margin-top:10px;padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer">العودة للعرض العادي</button>
                        </div>
                    `;
                    return;
                }

                const favoritesTitle = document.createElement('h2');
                favoritesTitle.style.textAlign = 'center';
                favoritesTitle.style.margin = '20px 0';
                favoritesTitle.style.color = 'var(--primary-color)';
                favoritesTitle.textContent = 'المنتجات المفضلة';
                productsContainer.appendChild(favoritesTitle);

                const groupedFavorites = groupProductsByCategory(favoriteProductsList);
                displayGroupedProducts(groupedFavorites);

                const backButton = document.createElement('div');
                backButton.style.textAlign = 'center';
                backButton.style.margin = '20px 0';
                backButton.innerHTML = `
                    <button onclick="closeFavoritesView()" style="padding:10px 20px;background:var(--primary-color);color:#fff;border:none;border-radius:5px;cursor:pointer;font-size:16px;">
                        العودة للعرض العادي
                    </button>
                `;
                productsContainer.appendChild(backButton);
            }

            function closeFavoritesView() {
                showFavoritesOnly = false;
                filterProducts();
                showNotification('تم العودة للعرض العادي', 'info');
            }

            function displayPersonalizedProducts() {
                if (Object.keys(userInterests).length > 0) {
                    const personalizedProducts = getPersonalizedProducts();
                    if (personalizedProducts.length > 0 && !showFavoritesOnly) {
                    }
                }
            }

            function getPersonalizedProducts() {
                const favoriteCategories = Object.keys(userInterests)
                    .sort((a, b) => userInterests[b] - userInterests[a])
                    .slice(0, 3);

                return allProducts.filter(p => {
                    const merchant = allMerchants.find(m => m.id === p.userId);
                    if (!merchant) return false;
                    const isActive = isActiveMerchant(merchant);
                    if (!isActive) return false;

                    return favoriteCategories.includes(p.categoryId);
                });
            }

            function createDescriptionElement(product) {
                const description = product.description || 'وصف المنتج غير متوفر';
                
                const descriptionContainer = document.createElement('div');
                descriptionContainer.className = 'product-description collapsed';
                
                const descriptionText = document.createElement('span');
                descriptionText.className = 'description-text';
                
                const readMoreToggle = document.createElement('button');
                readMoreToggle.className = 'read-more-toggle';
                
                const calculateOptimalChars = () => {
                    const screenWidth = window.innerWidth;
                    let charsPerLine;
                    
                    if (screenWidth < 768) {
                        charsPerLine = 35;
                    } else if (screenWidth < 1024) {
                        charsPerLine = 50;
                    } else {
                        charsPerLine = 70;
                    }
                    
                    return charsPerLine;
                };
                
                const updateDescriptionDisplay = () => {
                    const isExpanded = descriptionContainer.classList.contains('expanded');
                    const optimalChars = calculateOptimalChars();
                    
                    if (isExpanded) {
                        descriptionText.textContent = description;
                        readMoreToggle.textContent = '... عرض اقل';
                    } else {
                        if (description.length > optimalChars) {
                            descriptionText.textContent = description.substring(0, optimalChars);
                            readMoreToggle.textContent = '... عرض اكثر';
                            readMoreToggle.style.display = 'inline';
                        } else {
                            descriptionText.textContent = description;
                            readMoreToggle.style.display = 'none';
                        }
                    }
                };
                
                readMoreToggle.addEventListener('click', (e) => {
                    e.stopPropagation();
                    
                    if (descriptionContainer.classList.contains('collapsed')) {
                        descriptionContainer.classList.remove('collapsed');
                        descriptionContainer.classList.add('expanded');
                    } else {
                        descriptionContainer.classList.remove('expanded');
                        descriptionContainer.classList.add('collapsed');
                    }
                    
                    updateDescriptionDisplay();
                });
                
                descriptionContainer.appendChild(descriptionText);
                descriptionContainer.appendChild(readMoreToggle);
                
                updateDescriptionDisplay();
                
                return descriptionContainer;
            }

            function createProductCard(product, merchant) {
                const merchantName = merchant ? (merchant.name || merchant.username || "تاجر") : "تاجر";
                const productName = product.name || 'منتج بدون اسم';
                const categoryName = product.categoryId ? 
                    (allCategories.find(c => c.id === product.categoryId)?.name || '') : '';

                const card = document.createElement('div');
                card.className = 'card';
                card.id = `product-${product.id}`;

                if (isOfferValid(product)) {
                    card.classList.add('has-offer');

                    const offerBadge = document.createElement('div');
                    offerBadge.className = 'offer-badge';
                    offerBadge.innerHTML = '<i class="fas fa-tag"></i> عرض خاص';
                    offerBadge.style.cursor = 'pointer';
                    offerBadge.addEventListener('click', function(e) {
                        e.stopPropagation();
                        toggleOfferDates(card);
                    });
                    card.appendChild(offerBadge);

                    if (product.startDate || product.endDate) {
                        const offerDates = document.createElement('div');
                        offerDates.className = 'offer-dates';
                        
                        if (product.startDate) {
                            const startDateDiv = document.createElement('div');
                            startDateDiv.innerHTML = `<i class="fas fa-calendar-alt"></i> يبدأ: ${formatDate(product.startDate)}`;
                            offerDates.appendChild(startDateDiv);
                        }
                        
                        if (product.endDate) {
                            const endDateDiv = document.createElement('div');
                            endDateDiv.innerHTML = `<i class="fas fa-calendar-times"></i> ينتهي: ${formatDate(product.endDate)}`;
                            offerDates.appendChild(endDateDiv);
                        }
                        
                        card.appendChild(offerDates);
                    }
                }

                const imageUrls = extractImageUrls(product);

                if (imageUrls.length > 1) {
                    const sliderDiv = document.createElement('div');
                    sliderDiv.className = 'image-slider';
                    sliderDiv.id = `slider-${product.id}`;

                    const sliderContainer = document.createElement('div');
                    sliderContainer.className = 'slider-container';

                    imageUrls.forEach((url, index) => {
                        const img = document.createElement('img');
                        img.className = 'slider-image';
                        img.loading = 'lazy';
                        img.decoding = 'async';
                        img.src = formatDriveUrl(url, 'thumb');
                        img.alt = `${productName} - صورة ${index + 1}`;
                        
                        // تحسين: فقط إذا كان هناك تاجر وشعار
                        if (merchant) {
                            const merchantLogoUrl = merchant.logo || merchant.logoUrl || merchant.image;
                            const hasLogo = merchantLogoUrl && merchantLogoUrl.trim() !== '' && 
                                          merchantLogoUrl !== 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w200';
                            
                            if (hasLogo) {
                                const watermark = document.createElement('div');
                                watermark.className = 'slider-watermark';
                                const formattedLogoUrl = formatDriveUrl(merchantLogoUrl, 'thumb');
                                watermark.innerHTML = `
                                    <div class="slider-merchant-name">${merchantName}</div>
                                    <img src="${formattedLogoUrl}" alt="${merchantName}" class="slider-merchant-logo">
                                `;
                                sliderDiv.appendChild(watermark);
                            } else {
                                const watermark = document.createElement('div');
                                watermark.className = 'slider-watermark';
                                watermark.innerHTML = `
                                    <div class="slider-merchant-name">${merchantName}</div>
                                `;
                                sliderDiv.appendChild(watermark);
                            }
                        }
                        
                        img.addEventListener('click', () => {
                            recordProductView(product.id);
                            incrementViewCount(product.id);
                            openImageGallery(imageUrls, productName, index, product.id, merchant);
                        });
                        sliderContainer.appendChild(img);
                    });
                    sliderDiv.appendChild(sliderContainer);

                    if (imageUrls.length > 1) {
                        const prevBtn = document.createElement('button');
                        prevBtn.className = 'slider-arrow prev';
                        prevBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                        prevBtn.addEventListener('click', (e) => { 
                            e.stopPropagation(); 
                            navigateSlider(product.id, -1); 
                        });

                        const nextBtn = document.createElement('button');
                        nextBtn.className = 'slider-arrow next';
                        nextBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                        nextBtn.addEventListener('click', (e) => { 
                            e.stopPropagation(); 
                            navigateSlider(product.id, 1); 
                        });

                        const navDiv = document.createElement('div');
                        navDiv.className = 'slider-nav';
                        imageUrls.forEach((_, i) => {
                            const dot = document.createElement('div');
                            dot.className = 'slider-dot';
                            if (i === 0) dot.classList.add('active');
                            dot.addEventListener('click', (e) => { 
                                e.stopPropagation(); 
                                goToSlide(product.id, i); 
                            });
                            navDiv.appendChild(dot);
                        });

                        sliderDiv.appendChild(prevBtn);
                        sliderDiv.appendChild(nextBtn);
                        sliderDiv.appendChild(navDiv);
                    }
                    card.appendChild(sliderDiv);
                } else {
                    const imageDiv = document.createElement('div');
                    imageDiv.className = 'images-preview';
                    const img = document.createElement('img');
                    img.loading = 'lazy'; 
                    img.decoding = 'async';

                    const imageUrl = imageUrls[0] || '';
                    if (imageUrl) {
                        img.src = formatDriveUrl(imageUrl, 'thumb');
                        img.alt = productName;
                        
                        // تحسين: فقط إذا كان هناك تاجر وشعار
                        if (merchant) {
                            const merchantLogoUrl = merchant.logo || merchant.logoUrl || merchant.image;
                            const hasLogo = merchantLogoUrl && merchantLogoUrl.trim() !== '' && 
                                          merchantLogoUrl !== 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w200';
                            
                            if (hasLogo) {
                                const watermark = document.createElement('div');
                                watermark.className = 'image-watermark';
                                const formattedLogoUrl = formatDriveUrl(merchantLogoUrl, 'thumb');
                                watermark.innerHTML = `
                                    <div class="watermark-merchant-name">${merchantName}</div>
                                    <img src="${formattedLogoUrl}" alt="${merchantName}" class="watermark-logo">
                                `;
                                imageDiv.appendChild(watermark);
                            } else {
                                const watermark = document.createElement('div');
                                watermark.className = 'image-watermark';
                                watermark.innerHTML = `
                                    <div class="watermark-merchant-name">${merchantName}</div>
                                `;
                                imageDiv.appendChild(watermark);
                            }
                        }
                        
                        img.addEventListener('click', () => {
                            recordProductView(product.id);
                            incrementViewCount(product.id);
                            openImageGallery([imageUrl], productName, 0, product.id, merchant);
                        });
                    } else {
                        img.src = 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w800';
                        img.alt = 'صورة افتراضية';
                        img.style.border = '1px dashed #ccc';
                        img.addEventListener('click', () => {
                            recordProductView(product.id);
                            incrementViewCount(product.id);
                            openImageGallery(['https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w1600'], productName, 0, product.id, merchant);
                        });
                    }
                    imageDiv.appendChild(img);
                    card.appendChild(imageDiv);
                }

                const matchingProducts = getMatchingProducts(
                    product.name, 
                    product.categoryId, 
                    allProducts, 
                    product.id
                );
                
                if (matchingProducts.length > 0) {
                    const matchingContainer = document.createElement('div');
                    matchingContainer.className = 'matching-products-container';
                    
                    const matchingScroll = document.createElement('div');
                    matchingScroll.className = 'matching-products-scroll';
                    matchingScroll.id = `matching-products-${product.id}`;
                    
                    matchingProducts.forEach(match => {
                        if (match.id === product.id) return;
                        
                        const matchImageUrls = extractImageUrls(match);
                        const matchImageUrl = matchImageUrls.length > 0 ? matchImageUrls[0] : '';
                        const formattedImageUrl = formatDriveUrl(matchImageUrl, 'thumb');
                        
                        const matchItem = document.createElement('div');
                        matchItem.className = 'matching-product-item';
                        
                        // التحقق مما إذا كان المنتج المطابق عرضاً خاصاً
                        const isMatchOffer = isOfferValid(match);
                        if (isMatchOffer) {
                            matchItem.classList.add('has-offer');
                        }
                        
                        let offerBadgeHTML = '';
                        if (isMatchOffer) {
                            offerBadgeHTML = `
                                <div class="matching-product-offer">
                                    <i class="fas fa-tag"></i>
                                    عرض خاص
                                </div>
                            `;
                        }
                        
                        matchItem.innerHTML = `
                            ${offerBadgeHTML}
                            <img src="${formattedImageUrl}" alt="${match.name || 'منتج'}" class="matching-product-image">
                            <div class="matching-product-name">${match.name || 'منتج بدون اسم'}</div>
                            <div class="matching-product-price">${match.price ? match.price + ' ريال' : 'بدون سعر'}</div>
                        `;
                        
                        matchItem.addEventListener('click', () => {
                            recordProductView(match.id);
                            goToProduct(match.id);
                        });
                        
                        matchingScroll.appendChild(matchItem);
                    });
                    
                    matchingContainer.appendChild(matchingScroll);
                    card.appendChild(matchingContainer);
                }

                const infoDiv = document.createElement('div');
                infoDiv.className = 'info';

                const title = document.createElement('h3'); 
                title.textContent = productName; 
                infoDiv.appendChild(title);

                if (product.price) {
                    const priceDiv = document.createElement('div'); 
                    priceDiv.className = 'product-price';
                    const currency = product.currency || 'ريال يمني';
                    priceDiv.textContent = `${product.price} ${currency}`; 
                    infoDiv.appendChild(priceDiv);
                }

                const detailsDiv = document.createElement('div'); 
                detailsDiv.className = 'product-details';
                
                if (product.description) {
                    const descItem = document.createElement('div'); 
                    descItem.className = 'product-detail-item';
                    
                    const labelSpan = document.createElement('span');
                    labelSpan.className = 'label';
                    labelSpan.textContent = '';
                    descItem.appendChild(labelSpan);
                    
                    const descriptionElement = createDescriptionElement(product);
                    descItem.appendChild(descriptionElement);
                    
                    detailsDiv.appendChild(descItem);
                } else if (product.date) {
                    const dateItem = document.createElement('div'); 
                    dateItem.className = 'product-detail-item';
                    dateItem.innerHTML = `<span class="label">تاريخ الإضافة:</span> <span>${formatDate(product.date)}</span>`;
                    detailsDiv.appendChild(dateItem);
                }
                
                infoDiv.appendChild(detailsDiv);

                const merchantBtn = document.createElement('button');
                merchantBtn.className = 'merchant-btn';
                merchantBtn.id = 'merchant-btn';
                
                // تحسين: عرض زر التاجر فقط إذا كان هناك تاجر
                if (merchant) {
                    const merchantLogoUrl = merchant.logo || merchant.logoUrl || merchant.image;
                    const hasLogo = merchantLogoUrl && merchantLogoUrl.trim() !== '' && 
                                  merchantLogoUrl !== 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w200';
                    
                    if (hasLogo) {
                        const formattedLogoUrl = formatDriveUrl(merchantLogoUrl, 'thumb');
                        merchantBtn.innerHTML = `
                            <div class="merchant-with-logo">
                                <img src="${formattedLogoUrl}" alt="شعار التاجر" class="merchant-logo-rectangle">
                                <div class="merchant-btn-content">
                                    <div class="underline-border">اطلب المنتج الان</div>
                                    <div class="merchant-name-center">${merchantName}</div>
                                </div>
                            </div>
                        `;
                    } else {
                        merchantBtn.innerHTML = `
                            <div style="text-align: center; width: 100%;">
                                <div class="underline-border">اطلب المنتج الان</div>
                                <div class="merchant-name-center">${merchantName}</div>
                            </div>
                        `;
                    }
                    
                    merchantBtn.addEventListener('click', () => { 
                        const merchantName = merchant.name || merchant.username || "تاجر";
                        const merchantId = product.userId;
                        const productName = product.name || 'منتج بدون اسم';
                        
                        localStorage.setItem('selectedMerchantName', merchantName);
                        localStorage.setItem('selectedMerchantId', merchantId);
                        localStorage.setItem('selectedProductName', productName);
                        
                        recordProductView(product.id);
                        incrementViewCount(product.id);
                        saveScrollPosition();
                        openMerchantPage(); 
                    });
                } else {
                    // إذا لم يكن هناك تاجر، نعرض زر بديل
                    merchantBtn.innerHTML = `
                        <div style="text-align: center; width: 100%;">
                            <div class="underline-border">عرض المنتج</div>
                            <div class="merchant-name-center">منتج بدون تاجر</div>
                        </div>
                    `;
                    merchantBtn.style.opacity = '0.7';
                    merchantBtn.style.cursor = 'not-allowed';
                }
                infoDiv.appendChild(merchantBtn);

                const commentsSection = document.createElement('div');
                commentsSection.className = 'comments-section'; 
                commentsSection.id = `comments-${product.id}`;
                commentsSection.innerHTML = `
                    <div class="comments-header">
                        <div class="comments-title">التعليقات (<span class="comments-count">0</span>)</div>
                        <button class="close-comments" onclick="closeComments('${product.id}')">×</button>
                    </div>
                    <div class="comments-list" id="comments-list-${product.id}">
                        <div class="loading">جاري تحميل التعليقات...</div>
                    </div>
                    <div class="add-comment">
                        <div class="comment-form">
                            <textarea id="comment-text-${product.id}" placeholder="اكتب تعليقك هنا..."></textarea>
                            <button onclick="addComment('${product.id}')">إرسال التعليق</button>
                        </div>
                    </div>
                `;
                infoDiv.appendChild(commentsSection);

                card.appendChild(infoDiv);

                const actionButtonsDiv = document.createElement('div');
                actionButtonsDiv.className = 'action-buttons';
                actionButtonsDiv.innerHTML = `
                    <div class="stats-buttons">
                        <div class="stat-with-button">
                            <div class="stat-number like-stat" id="like-stat-${product.id}">0</div>
                            <button class="action-button btn-like" onclick="handleLike('${product.id}', '${escapeHtml(productName)}')">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                        </div>

                        <div class="stat-with-button">
                            <div class="stat-number comment-stat" id="comment-stat-${product.id}">0</div>
                            <button class="action-button btn-comment" onclick="toggleComments('${product.id}')">
                                <i class="fas fa-comments"></i>
                            </button>
                        </div>

                        <div class="stat-with-button">
                            <div class="stat-number view-stat" id="view-stat-${product.id}">150</div>
                            <button class="action-button btn-view">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>

                        <div class="stat-with-button">
                            <div class="stat-number" style="visibility: hidden;">0</div>
                            <button class="favorite-btn ${favoriteProducts[product.id] ? 'active' : ''}" onclick="toggleFavorite('${product.id}', this, '${escapeHtml(productName)}')" title="${favoriteProducts[product.id] ? 'إزالة من المفضلة' : 'إضافة إلى المفضلة'}">
                                <i class="fas fa-heart"></i>
                            </button>
                        </div>

                        <div class="stat-with-button">
                            <div class="stat-number" style="visibility: hidden;">0</div>
                            <button class="share-button" onclick="openShareModal('${product.id}', '${escapeHtml(productName)}')">
                                <i class="fas fa-share"></i>
                            </button>
                        </div>
                    </div>
                `;
                card.appendChild(actionButtonsDiv);

                loadProductStats(product.id, card);
                
                productCards[product.id] = card;
                
                return card;
            }

            function recordProductView(productId) {
                userViewHistory[productId] = new Date().toISOString();
                localStorage.setItem('userViewHistory', JSON.stringify(userViewHistory));
            }

            function calculateMatches(currentProductName, currentProductCategory, allProducts, currentProductId) {
                const firstWord = getFirstWord(currentProductName);
                if (!firstWord) return 0;
                
                let matchCount = 0;
                
                allProducts.forEach(otherProduct => {
                    if (otherProduct.id !== currentProductId) {
                        const otherProductName = otherProduct.name || '';
                        
                        if (otherProductName.includes(firstWord) && otherProduct.categoryId === currentProductCategory) {
                            matchCount++;
                        }
                    }
                });
                
                return matchCount;
            }

            function getMatchingProducts(currentProductName, currentProductCategory, allProducts, currentProductId) {
                const firstWord = getFirstWord(currentProductName);
                if (!firstWord) return [];
                
                let matchingProducts = [];
                
                allProducts.forEach(otherProduct => {
                    if (otherProduct.id !== currentProductId) {
                        const otherProductName = otherProduct.name || '';
                        
                        const isDuplicate = matchingProducts.some(match => 
                            match.name === otherProduct.name && 
                            extractImageUrls(match)[0] === extractImageUrls(otherProduct)[0]
                        );
                        
                        if (otherProductName.includes(firstWord) && otherProduct.categoryId === currentProductCategory && !isDuplicate) {
                            matchingProducts.push({
                                id: otherProduct.id,
                                ...otherProduct
                            });
                        }
                    }
                });
                
                return matchingProducts;
            }

            function getFirstWord(text) {
                if (!text || text.trim() === '') return '';
                
                const words = text
                    .replace(/[^\u0600-\u06FF\u0750-\u077F\u08A0-\u08FF\uFB50-\uFDFF\uFE70-\uFEFFa-zA-Z0-9\s]/g, '')
                    .trim()
                    .split(/\s+/);
                    
                return words.length > 0 ? words[0] : '';
            }

            function goToProduct(productId) {
                const productCard = productCards[productId];
                if (productCard) {
                    productCard.classList.add('highlighted');
                    
                    productCard.scrollIntoView({ 
                        behavior: 'smooth', 
                        block: 'center' 
                    });
                    
                    setTimeout(() => {
                        productCard.classList.remove('highlighted');
                    }, 2000);
                }
            }

            function toggleOfferDates(card) {
                const startDateBadge = card.querySelector('.offer-dates');
                const endDateBadge = card.querySelector('.offer-dates-end');
                
                if (startDateBadge) {
                    if (startDateBadge.style.display === 'none' || startDateBadge.style.display === '') {
                        startDateBadge.style.display = 'flex';
                    } else {
                        startDateBadge.style.display = 'none';
                    }
                }
                
                if (endDateBadge) {
                    if (endDateBadge.style.display === 'none' || endDateBadge.style.display === '') {
                        endDateBadge.style.display = 'flex';
                    } else {
                        endDateBadge.style.display = 'none';
                    }
                }
            }

            function extractImageUrls(product) {
                let imageUrls = [];
                if (product.imageUrls) {
                    if (Array.isArray(product.imageUrls)) 
                        imageUrls = product.imageUrls.filter(u => u && u.trim() !== '');
                    else if (typeof product.imageUrls === 'string') 
                        imageUrls = product.imageUrls.split(',').map(u => u.trim()).filter(Boolean);
                }
                if (imageUrls.length === 0 && product.imageUrl && typeof product.imageUrl === 'string') {
                    imageUrls = product.imageUrl.split(/[,\n]/).map(u => u.trim()).filter(Boolean);
                }
                
                if (imageUrls.length === 0) {
                    imageUrls = ['https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w800'];
                }
                
                return imageUrls;
            }

            function formatDriveUrl(url, mode = 'thumb') {
                if (!url) return '';
                
                if (url.includes('1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC')) {
                    return url;
                }
                
                let id = '';
                
                if (url.includes('/d/')) {
                    id = url.split('/d/')[1].split('/')[0];
                } 
                else if (url.includes('id=')) {
                    try { 
                        id = new URLSearchParams(url.split('?')[1]).get('id') || ''; 
                    } catch { 
                        return url; 
                    }
                }
                else if (url.includes('/file/d/')) {
                    id = url.split('/file/d/')[1].split('/')[0];
                }
                else if (url.includes('drive.google.com/uc?id=')) {
                    id = url.split('drive.google.com/uc?id=')[1].split('&')[0];
                }
                
                if (!id) return url;

                if (mode === 'thumb') {
                    return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
                } else if (mode === 'main') {
                    return `https://drive.google.com/thumbnail?id=${id}&sz=w1600`;
                } else if (mode === 'raw') {
                    return `https://drive.google.com/uc?export=view&id=${id}`;
                }
                return url;
            }

            function openImageGallery(images, productName, startIndex = 0, productId = null, merchant = null) {
                galleryImages = images;
                currentGalleryIndex = startIndex;
                currentGalleryMerchant = merchant;
                currentScale = 1;
                currentRotation = 0;
                currentTranslateX = 0;
                currentTranslateY = 0;
                isImageZoomed = false;

                if (productId) {
                    const product = allProducts.find(p => p.id === productId);
                    if (product && product.categoryId) {
                        userInterests[product.categoryId] = (userInterests[product.categoryId] || 0) + 1;
                        localStorage.setItem('userInterests', JSON.stringify(userInterests));
                    }
                    
                    if (productId && !openedProducts.includes(productId)) {
                        openedProducts.push(productId);
                    }
                }

                if (document.getElementById('gallery-product-name')) {
                    document.getElementById('gallery-product-name').textContent = productName;
                }
                createGallerySlides();
                createGalleryThumbnails();
                updateGalleryCounter();
                updateGalleryControls();
                addMerchantWatermarks(merchant);

                const gallery = document.getElementById('image-gallery');
                if (gallery) {
                    if (images.length === 1) {
                        gallery.classList.add('single-image');
                        if (galleryViewport) galleryViewport.style.cursor = 'default';
                    } else {
                        gallery.classList.remove('single-image');
                        if (galleryViewport) galleryViewport.style.cursor = 'grab';
                    }

                    gallery.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }

            function createGallerySlides() {
                if (!gallerySlider || !galleryViewport) return;
                
                gallerySlider.innerHTML = '';
                sliderTranslateX = -currentGalleryIndex * galleryViewport.offsetWidth;
                
                galleryImages.forEach((imageUrl, index) => {
                    const slide = document.createElement('div');
                    slide.className = 'gallery-slide';
                    
                    const img = document.createElement('img');
                    img.className = 'gallery-slide-image';
                    img.src = formatDriveUrl(imageUrl, 'main');
                    img.alt = `صورة ${index + 1}`;
                    img.loading = 'lazy';
                    img.decoding = 'async';
                    img.dataset.index = index;
                    
                    slide.appendChild(img);
                    gallerySlider.appendChild(slide);
                });
                
                gallerySlider.style.transform = `translateX(${sliderTranslateX}px)`;
            }

            function createGalleryThumbnails() {
                if (!galleryThumbnails) return;
                
                galleryThumbnails.innerHTML = '';
                
                galleryImages.forEach((imageUrl, index) => {
                    const thumb = document.createElement('img');
                    thumb.className = 'gallery-thumbnail';
                    thumb.src = formatDriveUrl(imageUrl, 'thumb');
                    thumb.alt = `صورة مصغرة ${index + 1}`;
                    thumb.dataset.index = index;
                    
                    if (index === currentGalleryIndex) {
                        thumb.classList.add('active');
                    }
                    
                    thumb.addEventListener('click', () => {
                        goToGalleryImage(index);
                    });
                    
                    galleryThumbnails.appendChild(thumb);
                });
            }

            function addMerchantWatermarks(merchant) {
                if (!merchant || !galleryMerchantWatermark || !galleryCornerWatermark) {
                    return;
                }
                
                const merchantName = merchant.name || merchant.username || 'تاجر';
                const merchantLogoUrl = merchant.logo || merchant.logoUrl || merchant.image;
                const hasLogo = merchantLogoUrl && merchantLogoUrl.trim() !== '' && 
                              merchantLogoUrl !== 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w200';
                
                galleryMerchantWatermark.innerHTML = '';
                
                let cornerWatermarkHTML = '';
                if (hasLogo) {
                    const formattedLogoUrl = formatDriveUrl(merchantLogoUrl, 'thumb');
                    cornerWatermarkHTML = `
                        <div class="corner-watermark-name">${merchantName}</div>
                        <img src="${formattedLogoUrl}" alt="${merchantName}" class="corner-watermark-logo">
                    `;
                } else {
                    cornerWatermarkHTML = `
                        <div class="corner-watermark-name">${merchantName}</div>
                    `;
                }
                galleryCornerWatermark.innerHTML = cornerWatermarkHTML;
            }

            function closeImageGallery() {
                const gallery = document.getElementById('image-gallery');
                if (gallery) {
                    gallery.classList.remove('active');
                    document.body.style.overflow = '';
                    isImageZoomed = false;
                    currentScale = 1;
                    currentRotation = 0;
                    
                    gallery.classList.remove('single-image');
                }
            }

            function goToGalleryImage(index) {
                if (index < 0 || index >= galleryImages.length || !galleryViewport || !gallerySlider) return;
                
                currentGalleryIndex = index;
                sliderTranslateX = -index * galleryViewport.offsetWidth;
                gallerySlider.style.transform = `translateX(${sliderTranslateX}px)`;
                
                updateGalleryCounter();
                updateGalleryThumbnails();
                resetImageTransform();
            }

            function navigateGallery(direction) {
                const newIndex = (currentGalleryIndex + direction + galleryImages.length) % galleryImages.length;
                goToGalleryImage(newIndex);
            }

            function updateGalleryCounter() {
                if (!galleryCounter) return;
                
                galleryCounter.textContent = `${currentGalleryIndex + 1} من ${galleryImages.length}`;
            }

            function updateGalleryThumbnails() {
                if (!galleryThumbnails) return;
                
                const thumbs = galleryThumbnails.querySelectorAll('.gallery-thumbnail');
                thumbs.forEach((thumb, index) => {
                    thumb.classList.toggle('active', index === currentGalleryIndex);
                });
            }

            function updateGalleryControls() {
                const gallery = document.getElementById('image-gallery');
                if (!gallery) return;
                
                if (galleryImages.length <= 1) {
                    gallery.classList.add('single-image');
                } else {
                    gallery.classList.remove('single-image');
                }
            }

            function toggleImageZoom() {
                const currentImage = gallerySlider.querySelector(`.gallery-slide-image[data-index="${currentGalleryIndex}"]`);
                if (!currentImage) return;
                
                isImageZoomed = !isImageZoomed;
                
                if (isImageZoomed) {
                    currentScale = 2;
                    currentImage.classList.add('zoomed');
                    if (galleryViewport) galleryViewport.style.cursor = 'grab';
                    updateImageTransform();
                } else {
                    currentScale = 1;
                    currentRotation = 0;
                    currentTranslateX = 0;
                    currentTranslateY = 0;
                    currentImage.classList.remove('zoomed');
                    currentImage.style.transform = '';
                    if (galleryViewport) {
                        galleryViewport.style.cursor = galleryImages.length > 1 ? 'grab' : 'default';
                    }
                }
                
                if (galleryZoomBtn) {
                    const zoomIcon = galleryZoomBtn.querySelector('i');
                    if (zoomIcon) {
                        if (isImageZoomed) {
                            zoomIcon.className = 'fas fa-search-minus';
                        } else {
                            zoomIcon.className = 'fas fa-search-plus';
                        }
                    }
                }
            }

            function rotateImage() {
                if (!isImageZoomed) return;
                
                const currentImage = gallerySlider.querySelector(`.gallery-slide-image[data-index="${currentGalleryIndex}"]`);
                if (!currentImage) return;
                
                currentRotation = (currentRotation + 90) % 360;
                updateImageTransform();
            }

            function updateImageTransform() {
                const currentImage = gallerySlider.querySelector(`.gallery-slide-image[data-index="${currentGalleryIndex}"]`);
                if (!currentImage) return;
                
                currentImage.style.transform = `translate(${currentTranslateX}px, ${currentTranslateY}px) scale(${currentScale}) rotate(${currentRotation}deg)`;
            }

            function resetImageTransform() {
                currentScale = 1;
                currentRotation = 0;
                currentTranslateX = 0;
                currentTranslateY = 0;
                
                const currentImage = gallerySlider.querySelector(`.gallery-slide-image[data-index="${currentGalleryIndex}"]`);
                if (currentImage) {
                    currentImage.classList.remove('zoomed');
                    currentImage.style.transform = '';
                }
                
                if (galleryZoomBtn) {
                    const zoomIcon = galleryZoomBtn.querySelector('i');
                    if (zoomIcon) {
                        zoomIcon.className = 'fas fa-search-plus';
                    }
                }
                isImageZoomed = false;
                if (galleryViewport) {
                    galleryViewport.style.cursor = galleryImages.length > 1 ? 'grab' : 'default';
                }
            }

            function navigateSlider(productId, direction) {
                const slider = document.getElementById(`slider-${productId}`);
                if (!slider) return;
                
                const container = slider.querySelector('.slider-container');
                const slides = container.querySelectorAll('.slider-image');

                const currentIndex = Math.round(container.scrollLeft / container.clientWidth);
                let newIndex = currentIndex + direction;
                if (newIndex < 0) newIndex = slides.length - 1;
                if (newIndex >= slides.length) newIndex = 0;
                goToSlide(productId, newIndex);
            }

            function goToSlide(productId, index) {
                const slider = document.getElementById(`slider-${productId}`);
                if (!slider) return;
                
                const container = slider.querySelector('.slider-container');
                const dots = slider.querySelectorAll('.slider-dot');

                container.scrollTo({ left: index * container.clientWidth, behavior: 'smooth' });
                dots.forEach((d, i) => d.classList.toggle('active', i === index));
            }

            function filterProducts() {
                const filters = {
                    governorate: governorateSelect ? governorateSelect.value : '',
                    region: regionSelect ? regionSelect.value : '',
                    category: selectedCategoryId,
                    search: (searchInput ? searchInput.value : '').trim(),
                    sortBy: sortSelect ? sortSelect.value : 'date'
                };

                if (filters.search) {
                    saveSearchTerm(filters.search);
                    saveSearchTermToAsnaf(filters.search);
                }

                const result = allProducts.filter(product => {
                    if (!product) return false;

                    if (product.productType === 'عرض' && !isOfferValid(product)) {
                        return false;
                    }

                    if (filters.search) {
                        const normalizedSearch = normalizeText(filters.search);
                        const productName = normalizeText(product.name || '');
                        const productDesc = normalizeText(product.description || '');
                        
                        if (!productName.includes(normalizedSearch) && !productDesc.includes(normalizedSearch)) {
                            return false;
                        }
                    }

                    if (filters.category) {
                        if (product.categoryId !== filters.category && product.category !== filters.category) return false;
                    }

                    if (selectedMerchantId && product.userId !== selectedMerchantId) return false;

                    if (filters.governorate) {
                        const merchant = allMerchants.find(m => m.id === product.userId);
                        if (merchant) {
                            const merchantGovernorate = merchant.governorate || merchant.region;
                            if (merchantGovernorate !== filters.governorate) return false;
                        }
                    }
                    if (filters.region) {
                        const merchant = allMerchants.find(m => m.id === product.userId);
                        if (merchant) {
                            const merchantArea = merchant.area || merchant.city;
                            if (merchantArea !== filters.region) return false;
                        }
                    }

                    return true;
                });
                
                displayProducts(result);
            }

            function saveSearchTerm(term) {
                let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');
                
                searchHistory = searchHistory.filter(t => t !== term);
                searchHistory.unshift(term);
                
                searchHistory = searchHistory.slice(0, 10);
                
                localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
            }

            function resetFilters() {
                resetFiltersFields();
                displayProducts(allProducts);
                showNotification('تم إعادة تعيين جميع الفلاتر', 'success');
            }

            function applyAllMerchants() {
                selectedMerchantId = null;
                selectedMerchantName = null;
                if (merchantTextInput) merchantTextInput.value = '';
                
                closeMerchantModal();
                
                filterProducts();
                
                showNotification('تم عرض جميع التجار', 'success');
            }

            function applyAllCategories() {
                selectedCategoryId = null;
                selectedCategoryName = null;
                if (categoryTextInput) categoryTextInput.value = '';
                if (secondaryCategoryTextInput) secondaryCategoryTextInput.value = 'جميع الأقسام';
                
                closeCategoryModal();
                
                filterProducts();
                
                showNotification('تم عرض جميع الأقسام', 'success');
            }

            function toggleFavorite(productId, button, productName = '') {
                if (favoriteProducts[productId]) { 
                    delete favoriteProducts[productId]; 
                    if (button) button.classList.remove('active'); 
                    showNotification('تم إزالة المنتج من المفضلة', 'info');
                } else { 
                    favoriteProducts[productId] = true; 
                    if (button) button.classList.add('active'); 
                    showNotification('تم إضافة المنتج إلى المفضلة', 'success');
                    
                    const product = allProducts.find(p => p.id === productId);
                    if (product && product.categoryId) {
                        userInterests[product.categoryId] = (userInterests[product.categoryId] || 0) + 1;
                        localStorage.setItem('userInterests', JSON.stringify(userInterests));
                    }
                }
                localStorage.setItem('favoriteProducts', JSON.stringify(favoriteProducts));
                
                if (showFavoritesOnly) {
                    displayFavoriteProducts();
                }
            }

            function showNotification(message, type = 'success') {
                const notification = document.createElement('div');
                notification.className = 'notification';
                notification.textContent = message;
                
                if (type === 'success') {
                    notification.style.background = 'var(--success-color)';
                    if (message.includes('منتج جديد')) {
                        playNotificationSound();
                    }
                } else if (type === 'info') {
                    notification.style.background = 'var(--primary-color)';
                } else if (type === 'error') {
                    notification.style.background = 'var(--danger-color)';
                }
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    notification.remove();
                }, 3000);
            }

            function incrementViewCount(productId) {
                const viewKey = `view_${productId}`;
                
                if (!userActions.views[viewKey]) {
                    userActions.views[viewKey] = Date.now();
                    localStorage.setItem('userActions', JSON.stringify(userActions));
                    
                    db.ref(`products_stats/${productId}/views`).transaction(current => (current || 0) + 1);

                    const viewEl = document.getElementById(`view-stat-${productId}`);
                    if (viewEl) { 
                        const currentViews = parseInt(viewEl.textContent) || 150;
                        viewEl.textContent = currentViews + 1; 
                    }

                    const product = allProducts.find(p => p.id === productId);
                    if (product && product.categoryId) {
                        userInterests[product.categoryId] = (userInterests[product.categoryId] || 0) + 1;
                        localStorage.setItem('userInterests', JSON.stringify(userInterests));
                    }
                }
            }

            function getDefaultViews(product) {
                if (!product) return 150;
                
                const today = new Date();
                const publishDate = new Date(product.publishDate || product.createdAt || product.date || 0);
                
                const diffTime = Math.abs(today - publishDate);
                const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays <= 7) {
                    return 2500;
                } else if (diffDays <= 14) {
                    return 6500;
                } else if (diffDays <= 21) {
                    return 80000;
                } else if (diffDays <= 35) {
                    return 900000;
                } else {
                    return 150;
                }
            }

            async function loadProductStats(productId, card) {
                try {
                    const [statsSnap, commentsSnap] = await Promise.all([
                        db.ref(`products_stats/${productId}`).once('value'),
                        db.ref(`comments/${productId}`).once('value')
                    ]);

                    const stats = statsSnap.val() || {};
                    const comments = commentsSnap.val() || {};

                    const likeCount = Array.isArray(stats.likes) ? stats.likes.length : 0;
                    const realViews = stats.views || 0;
                    const commentCount = Object.keys(comments).length;
                    
                    const product = allProducts.find(p => p.id === productId);
                    const defaultViews = getDefaultViews(product);
                    const totalViews = defaultViews + realViews;

                    const likeStatEl = document.getElementById(`like-stat-${productId}`);
                    const viewStatEl = document.getElementById(`view-stat-${productId}`);
                    const commentStatEl = document.getElementById(`comment-stat-${productId}`);
                    const commentsCountEl = card.querySelector('.comments-count');

                    if (likeStatEl) likeStatEl.textContent = likeCount;
                    if (viewStatEl) viewStatEl.textContent = totalViews;
                    if (commentStatEl) commentStatEl.textContent = commentCount;
                    if (commentsCountEl) commentsCountEl.textContent = commentCount;

                    updateLikeButtonState(productId, stats.likes || []);
                    
                } catch (e) { 
                    console.error('خطأ في تحميل الإحصائيات:', e); 
                }
            }

            function updateLikeButtonState(productId, likesArray) {
                const likeButton = document.querySelector(`#product-${productId} .btn-like`);
                if (!likeButton) return;
                
                const userLiked = likesArray.includes(currentUserId);
                
                if (userLiked) {
                    likeButton.style.color = 'var(--danger-color)';
                    likeButton.title = 'إلغاء الإعجاب';
                } else {
                    likeButton.style.color = '';
                    likeButton.title = 'الإعجاب';
                }
            }

            async function handleLike(productId, productName = '') {
                try {
                    const likesRef = db.ref(`products_stats/${productId}/likes`);
                    const snapshot = await likesRef.once('value');
                    let likes = snapshot.val() || [];
                    if (!Array.isArray(likes)) likes = [];
                    
                    const idx = likes.indexOf(currentUserId);
                    if (idx === -1) {
                        likes.push(currentUserId);
                        showNotification('تم الإعجاب بالمنتج', 'success');
                        
                        userActions.likes[productId] = Date.now();
                        localStorage.setItem('userActions', JSON.stringify(userActions));
                    } else {
                        likes.splice(idx, 1);
                        showNotification('تم إلغاء الإعجاب بالمنتج', 'info');
                        
                        delete userActions.likes[productId];
                        localStorage.setItem('userActions', JSON.stringify(userActions));
                    }
                    
                    await likesRef.set(likes);
                    
                    const likeStatEl = document.getElementById(`like-stat-${productId}`);
                    if (likeStatEl) likeStatEl.textContent = likes.length;
                    
                    updateLikeButtonState(productId, likes);
                    
                } catch (e) { 
                    console.error('خطأ في معالجة الإعجاب:', e); 
                }
            }

            function toggleComments(productId) {
                const el = document.getElementById(`comments-${productId}`);
                if (el && el.classList.contains('active')) {
                    closeComments(productId);
                } else {
                    openComments(productId);
                }
            }

            function openComments(productId) { 
                closeAllComments();
                
                const el = document.getElementById(`comments-${productId}`); 
                if (el) {
                    el.classList.add('active'); 
                    loadComments(productId);
                    isCommentsOpen = true;
                }
            }

            function closeComments(productId) { 
                const el = document.getElementById(`comments-${productId}`); 
                if (el) {
                    el.classList.remove('active'); 
                    const t = document.getElementById(`comment-text-${productId}`); 
                    if (t) t.value=''; 
                    isCommentsOpen = false;
                }
            }

            function closeAllComments() {
                document.querySelectorAll('.comments-section.active').forEach(section => {
                    section.classList.remove('active');
                });
                isCommentsOpen = false;
            }

            async function loadComments(productId) {
                const list = document.getElementById(`comments-list-${productId}`);
                if (!list) return;
                
                list.innerHTML = '<div class="loading">جاري تحميل التعليقات...</div>';
                try {
                    const snapshot = await db.ref(`comments/${productId}`).once('value');
                    const data = snapshot.val() || {};
                    const comments = Object.entries(data).map(([id, c]) => ({ id, ...c }));
                    displayComments(comments, productId);
                } catch (e) {
                    console.error('خطأ في تحميل التعليقات:', e);
                    list.innerHTML = '<div class="error">حدث خطأ في تحميل التعليقات</div>';
                }
            }

            function displayComments(comments, productId) {
                const list = document.getElementById(`comments-list-${productId}`);
                if (!list) return;
                
                const countEl = document.querySelector(`#comments-${productId} .comments-count`);
                list.innerHTML = '';
                if (countEl) {
                    countEl.textContent = comments.length;
                }

                if (comments.length === 0) { 
                    list.innerHTML = '<div class="no-comments">لا توجد تعليقات بعد</div>'; 
                    return; 
                }

                comments.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
                comments.forEach(c => {
                    const div = document.createElement('div'); 
                    div.className = 'comment-item';
                    div.innerHTML = `
                        <div class="comment-header">
                            <span>${escapeHtml(c.author || 'مستخدم')}</span>
                            <span class="comment-date">${formatDate(c.date)}</span>
                        </div>
                        <div class="comment-text">${escapeHtml(c.text || '')}</div>
                    `;
                    list.appendChild(div);
                });
            }

            async function addComment(productId) {
                const textarea = document.getElementById(`comment-text-${productId}`);
                const text = (textarea && textarea.value || '').trim();
                if (!text) { 
                    alert('يرجى كتابة تعليق قبل الإرسال'); 
                    return; 
                }

                try {
                    const commentId = Date.now().toString();
                    const comment = { text, author: 'مستخدم', date: new Date().toISOString() };
                    await db.ref(`comments/${productId}/${commentId}`).set(comment);
                    if (textarea) textarea.value = '';
                    loadComments(productId);
                    showNotification('تم إضافة التعليق بنجاح', 'success');

                    const commentStatEl = document.getElementById(`comment-stat-${productId}`);
                    if (commentStatEl) commentStatEl.textContent = (parseInt(commentStatEl.textContent) || 0) + 1;
                } catch (e) {
                    console.error('خطأ في إضافة التعليق:', e);
                    alert('حدث خطأ في إضافة التعليق');
                }
            }

            function openMerchantModal() {
                updateModalMerchantList();
                
                if (merchantModalOverlay) {
                    merchantModalOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                    setTimeout(() => {
                        if (merchantModalSearchInput) {
                            merchantModalSearchInput.focus();
                        }
                    }, 300);
                }
            }

            function closeMerchantModal() {
                if (merchantModalOverlay) {
                    merchantModalOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                    
                    if (merchantModalSearchInput) {
                        merchantModalSearchInput.value = '';
                    }
                }
            }

            function updateModalMerchantList() {
                const selectedGovernorate = governorateSelect ? governorateSelect.value : '';
                const selectedRegion = regionSelect ? regionSelect.value : '';
                
                // الحصول على التجار الذين لديهم منتجات فقط
                const merchantsWithProducts = getMerchantsWithProducts();
                
                filteredModalMerchants = merchantsWithProducts.filter(m => {
                    const isActive = isActiveMerchant(m);
                    
                    if (selectedGovernorate) {
                        const merchantGovernorate = m.governorate || m.region;
                        if (merchantGovernorate !== selectedGovernorate) {
                            return false;
                        }
                    }
                    
                    if (selectedRegion) {
                        const merchantArea = m.area || m.city;
                        if (merchantArea !== selectedRegion) {
                            return false;
                        }
                    }
                    
                    return isActive;
                });
                
                if (filteredModalMerchants.length === 0 && (selectedGovernorate || selectedRegion)) {
                    filteredModalMerchants = merchantsWithProducts.filter(m => {
                        const isActive = isActiveMerchant(m);
                        return isActive;
                    });
                }
                
                displayMerchantModalList(filteredModalMerchants);
            }

            function displayMerchantModalList(merchants) {
                if (!merchantsModalList) return;
                
                merchantsModalList.innerHTML = '';
                
                if (merchants.length === 0) {
                    merchantsModalList.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #64748b;">
                            <i class="fas fa-store" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                            <p>لا يوجد تجار لديهم منتجات لعرضها</p>
                        </div>
                    `;
                    return;
                }
                
                merchants.sort((a, b) => {
                    const nameA = (a.name || a.username || '').toLowerCase();
                    const nameB = (b.name || b.username || '').toLowerCase();
                    return nameA.localeCompare(nameB, 'ar');
                });
                
                merchants.forEach(merchant => {
                    const merchantItem = document.createElement('div');
                    merchantItem.className = 'merchant-modal-item';
                    merchantItem.dataset.merchantId = merchant.id;
                    
                    const isSelected = merchant.id === selectedMerchantId;
                    
                    if (isSelected) {
                        merchantItem.classList.add('selected');
                    }
                    
                    const showNumber = merchant.showNumber || "0";
                    const showPhone = showNumber === "1" && merchant.phone;
                    
                    merchantItem.innerHTML = `
                        <div class="merchant-modal-item-name">
                            ${merchant.name || merchant.username || 'تاجر بدون اسم'}
                        </div>
                        ${showPhone ? `
                            <div class="merchant-modal-item-phone">
                                <i class="fas fa-phone"></i>
                                ${merchant.phone}
                            </div>
                        ` : ''}
                    `;
                    
                    merchantItem.addEventListener('click', function() {
                        document.querySelectorAll('.merchant-modal-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        this.classList.add('selected');
                        
                        selectedMerchantId = this.dataset.merchantId;
                        
                        if (merchantModalConfirm) {
                            merchantModalConfirm.disabled = false;
                        }
                    });
                    
                    merchantsModalList.appendChild(merchantItem);
                });
            }

            function filterMerchantModalList() {
                if (!merchantModalSearchInput) return;
                
                const searchTerm = merchantModalSearchInput.value.toLowerCase();
                
                if (!searchTerm) {
                    displayMerchantModalList(filteredModalMerchants);
                    return;
                }
                
                const filteredMerchants = filteredModalMerchants.filter(merchant => {
                    const merchantName = normalizeText(merchant.name || merchant.username || '');
                    const normalizedSearch = normalizeText(searchTerm);
                    
                    return searchTerm === '' || 
                        merchantName.includes(normalizedSearch) ||
                        merchant.id.toLowerCase().includes(searchTerm) ||
                        (merchant.phone && merchant.phone.toLowerCase().includes(searchTerm)) ||
                        (merchant.email && merchant.email.toLowerCase().includes(searchTerm));
                });
                
                displayMerchantModalList(filteredMerchants);
            }

            function applyMerchantFilter() {
                if (!selectedMerchantId) {
                    showNotification('لم يتم تحديد تاجر', 'error');
                    return;
                }
                
                const merchant = allMerchants.find(m => m.id === selectedMerchantId);
                selectedMerchantName = merchant ? (merchant.name || merchant.username) : '';
                
                if (merchantTextInput) {
                    merchantTextInput.value = selectedMerchantName;
                }
                
                closeMerchantModal();
                
                filterProducts();
                
                showNotification(`تم تصفية المنتجات حسب التاجر: ${selectedMerchantName}`, 'success');
            }

            function openCategoryModal() {
                updateModalCategoryList();
                
                if (categoryModalOverlay) {
                    categoryModalOverlay.classList.add('active');
                    document.body.style.overflow = 'hidden';
                    
                    setTimeout(() => {
                        if (categoryModalSearchInput) {
                            categoryModalSearchInput.focus();
                        }
                    }, 300);
                }
            }

            function closeCategoryModal() {
                if (categoryModalOverlay) {
                    categoryModalOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                    
                    if (categoryModalSearchInput) {
                        categoryModalSearchInput.value = '';
                    }
                }
            }

            function displayCategoryModalList(categories) {
                if (!categoriesModalList) return;
                
                categoriesModalList.innerHTML = '';
                
                if (categories.length === 0) {
                    categoriesModalList.innerHTML = `
                        <div style="text-align: center; padding: 30px; color: #64748b;">
                            <i class="fas fa-tags" style="font-size: 40px; margin-bottom: 10px; display: block;"></i>
                            <p>لا يوجد أقسام لعرضها</p>
                        </div>
                    `;
                    return;
                }
                
                categories.sort((a, b) => {
                    const countA = a.productCount || 0;
                    const countB = b.productCount || 0;
                    return countB - countA;
                });
                
                categories.forEach(category => {
                    const categoryItem = document.createElement('div');
                    categoryItem.className = 'category-modal-item';
                    categoryItem.dataset.categoryId = category.id;
                    
                    const isSelected = category.id === selectedCategoryId;
                    
                    if (isSelected) {
                        categoryItem.classList.add('selected');
                    }
                    
                    categoryItem.innerHTML = `
                        <div class="category-modal-item-name">
                            ${category.name || 'قسم بدون اسم'}
                        </div>
                        <div class="category-modal-item-count">
                            <i class="fas fa-box"></i>
                            ${category.productCount || 0} منتج
                        </div>
                    `;
                    
                    categoryItem.addEventListener('click', function() {
                        document.querySelectorAll('.category-modal-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                        
                        this.classList.add('selected');
                        
                        selectedCategoryId = this.dataset.categoryId;
                        
                        if (categoryModalConfirm) {
                            categoryModalConfirm.disabled = false;
                        }
                    });
                    
                    categoriesModalList.appendChild(categoryItem);
                });
            }

            function filterCategoryModalList() {
                if (!categoryModalSearchInput) return;
                
                const searchTerm = categoryModalSearchInput.value.toLowerCase();
                
                if (!searchTerm) {
                    displayCategoryModalList(filteredModalCategories);
                    return;
                }
                
                const filteredCategories = filteredModalCategories.filter(category => {
                    const categoryName = normalizeText(category.name || '');
                    const normalizedSearch = normalizeText(searchTerm);
                    
                    return searchTerm === '' || 
                        categoryName.includes(normalizedSearch) ||
                        category.id.toLowerCase().includes(searchTerm);
                });
                
                displayCategoryModalList(filteredCategories);
            }

            function applyCategoryFilter() {
                if (!selectedCategoryId) {
                    showNotification('لم يتم تحديد قسم', 'error');
                    return;
                }
                
                const category = allCategories.find(c => c.id === selectedCategoryId);
                selectedCategoryName = category ? category.name : '';
                
                if (categoryTextInput) {
                    categoryTextInput.value = selectedCategoryName || 'جميع الأقسام';
                }
                if (secondaryCategoryTextInput) {
                    secondaryCategoryTextInput.value = selectedCategoryName || 'جميع الأقسام';
                }
                
                closeCategoryModal();
                
                filterProducts();
                
                showNotification(`تم تصفية المنتجات حسب القسم: ${selectedCategoryName}`, 'success');
            }

            let currentShareProductId = null;
            let currentShareProductName = '';

            function openShareModal(productId, productName) {
                currentShareProductId = productId;
                currentShareProductName = productName;
                if (shareModal) {
                    shareModal.classList.add('active');
                    document.body.style.overflow = 'hidden';
                }
            }

            function closeShareModal() {
                if (shareModal) {
                    shareModal.classList.remove('active');
                    document.body.style.overflow = '';
                }
                currentShareProductId = null;
                currentShareProductName = '';
            }

            function handleShareOption(e) {
                const platform = e.currentTarget.dataset.platform;
                shareProduct(currentShareProductId, currentShareProductName, platform);
                closeShareModal();
            }

            function shareProduct(productId, productName = '', platform = 'other') {
                const product = allProducts.find(p => p.id === productId);
                const merchant = product ? allMerchants.find(m => m.id === product.userId) : null;
                const merchantName = merchant ? (merchant.name || merchant.username || "تاجر") : "تاجر";
                const productPrice = product ? (product.price ? `${product.price} ريال يمني` : 'غير محدد') : 'غير محدد';
                const productUrl = `${window.location.origin}${window.location.pathname}?productId=${productId}`;
                const productImage = product ? extractImageUrls(product)[0] : '';

                const shareText = `مرحبآ 
الان وحصري على منصة AZ السوق الشامل لتلبية احتياجك بالكامل
اول سوق تجاري يحتوي على 
قسم للمنتجات التجارية الجديدة 
قسم للمنتجات المستخدمة - الحراج
قسم للمباني والعقارات وتأجير الشقق
قسم الوظائف الشاغرة
قسم الطلب والتوصيل السريع للمطاعم والبوافي واللحوم
قسم موقع وأرقام أشخاص تهمك 
مع AZ متعة التسوق

أعجبني منتج / ${productName} - ${productPrice}
العرض مقدم من التاجر / ${merchantName}
رابط المنتج: ${productUrl}`;

                const shareUrls = {
                    whatsapp: `https://wa.me/?text=${encodeURIComponent(shareText)}`,
                    facebook: `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(productUrl)}&quote=${encodeURIComponent(shareText)}`,
                    twitter: `https://twitter.com/intent/tweet?text=${encodeURIComponent(shareText)}&url=${encodeURIComponent(productUrl)}`,
                    telegram: `https://t.me/share/url?url=${encodeURIComponent(productUrl)}&text=${encodeURIComponent(shareText)}`,
                    copy: null,
                    other: null
                };

                switch(platform) {
                    case 'whatsapp':
                    case 'facebook':
                    case 'twitter':
                    case 'telegram':
                        window.open(shareUrls[platform], '_blank', 'width=600,height=400');
                        showNotification(`تم فتح ${platform} للمشاركة', 'success`);
                        break;
                    
                    case 'copy':
                        copyToClipboard(shareText);
                        showNotification('تم نسخ رابط المنتج إلى الحافظة', 'success');
                        break;
                    
                    case 'other':
                    default:
                        if (navigator.share) {
                            navigator.share({ 
                                title: `AZ السوق الشامل - ${productName}`, 
                                text: shareText, 
                                url: productUrl 
                            })
                            .then(() => showNotification('تمت المشاركة بنجاح', 'success'))
                            .catch(err => {
                                console.log('خطأ في المشاركة:', err);
                                copyToClipboard(shareText);
                            });
                        } else {
                            copyToClipboard(shareText);
                        }
                        break;
                }
            }

            function copyToClipboard(text) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showNotification('تم نسخ رابط المنتج إلى الحافظة', 'success');
                    })
                    .catch(() => {
                        const textArea = document.createElement('textarea');
                        textArea.value = text;
                        document.body.appendChild(textArea);
                        textArea.select();
                        document.execCommand('copy');
                        document.body.removeChild(textArea);
                        showNotification('تم نسخ رابط المنتج إلى الحافظة', 'success');
                    });
            }

            function openMerchantPage() {
                window.location.href = 'ard_tagr.html';
            }

            function formatDate(dateString) {
                if (!dateString) return 'غير محدد';
                try { 
                    return new Date(dateString).toLocaleDateString('ar-EG'); 
                } catch { 
                    return dateString; 
                }
            }

            function escapeHtml(text) { 
                const div = document.createElement('div'); 
                div.textContent = text; 
                return div.innerHTML; 
            }

            function loadCachedData() {
                try {
                    const cached = localStorage.getItem('marketplaceCache');
                    if (cached) {
                        const cacheData = JSON.parse(cached);
                        const cacheAge = Date.now() - (cacheData.timestamp || 0);
                        const maxAge = 30 * 60 * 1000; // نصف ساعة
                        
                        if (cacheAge < maxAge) {
                            allProducts = cacheData.products || [];
                            allMerchants = cacheData.merchants || [];
                            allGovernorates = cacheData.governorates || [];
                            allRegions = cacheData.regions || [];
                            allCategories = cacheData.categories || [];
                            
                            if (allProducts.length > 0) {
                                populateFilterOptions();
                                displayProducts(allProducts);
                                return true;
                            }
                        } else {
                            localStorage.removeItem('marketplaceCache');
                        }
                    }
                } catch (e) {
                    console.warn('⚠️ تعذر تحميل البيانات المخزنة:', e);
                }
                return false;
            }

            function saveDataToCache() {
                try {
                    const cacheData = {
                        products: allProducts,
                        merchants: allMerchants,
                        governorates: allGovernorates,
                        regions: allRegions,
                        categories: allCategories,
                        timestamp: Date.now()
                    };
                    localStorage.setItem('marketplaceCache', JSON.stringify(cacheData));
                } catch (e) { 
                    console.warn('⚠️ تعذر حفظ التخزين المحلي', e); 
                }
            }

            function setupFilterBarAutoHide() {
                document.addEventListener('click', function(event) {
                    const filterBar = document.getElementById('filter-bar');
                    const secondaryBar = document.querySelector('.secondary-bar');
                    const filterControlBtn = document.getElementById('filter-control');
                    const showMoreBtn = document.getElementById('show-more-btn');
                    const classicPageBtn = document.getElementById('classic-page-btn');
                    
                    if (filterBar && filterBar.style.display === 'flex') {
                        const isClickInsideFilterBar = filterBar.contains(event.target);
                        const isClickInsideSecondaryBar = secondaryBar.contains(event.target);
                        const isClickOnFilterControl = filterControlBtn.contains(event.target);
                        const isClickOnShowMoreBtn = showMoreBtn.contains(event.target);
                        const isClickOnClassicPageBtn = classicPageBtn.contains(event.target);
                        
                        if (!isClickInsideFilterBar && !isClickInsideSecondaryBar && 
                            !isClickOnFilterControl && !isClickOnShowMoreBtn && !isClickOnClassicPageBtn) {
                            hideFilterBar();
                        }
                    }
                });
            }

            function toggleFilterBar() {
                if (!filterBar) return;
                
                if (filterBar.style.display === 'flex' || filterBar.style.display === '') {
                    hideFilterBar();
                } else {
                    showFilterBar();
                }
            }

            function hideFilterBar() {
                if (!filterBar) return;
                
                filterBar.style.display = 'none';
                document.body.style.paddingTop = '128px';
                localStorage.setItem('filterBarHidden', 'true');
                if (filterControlBtn) {
                    filterControlBtn.innerHTML = '<i class="fas fa-sliders-h"></i>';
                    filterControlBtn.title = 'إظهار شريط الفلاتر';
                }
                if (showMoreBtn) {
                    showMoreBtn.innerHTML = '<i class="fas fa-bars"></i> عرض أكثر';
                }
                // تم إزالة الإشعار هنا
            }

            function showFilterBar() {
                if (!filterBar) return;
                
                filterBar.style.display = 'flex';
                document.body.style.paddingTop = '180px';
                localStorage.setItem('filterBarHidden', 'false');
                if (filterControlBtn) {
                    filterControlBtn.innerHTML = '<i class="fas fa-times"></i>';
                    filterControlBtn.title = 'إخفاء شريط الفلاتر';
                }
                if (showMoreBtn) {
                    showMoreBtn.innerHTML = '<i class="fas fa-times"></i> إخفاء';
                }
                showNotification('تم إظهار شريط الفلاتر', 'success');
            }

            function startAutoUpdate() {
                db.ref("products").on("value", (snapshot) => {
                    const newProducts = convertFirebaseData(snapshot.val(), "products") || [];
                    
                    if (newProducts.length !== allProducts.length) {
                        const previousCount = allProducts.length;
                        
                        allProducts = newProducts;
                        
                        saveDataToCache();
                        
                        if (!showFavoritesOnly) {
                            filterProducts();
                            
                            if (newProducts.length > previousCount) {
                                const newProductsCount = newProducts.length - previousCount;
                                const notificationMessage = `تم تحديث ${newProductsCount} منتج جديد`;
                                showNotification(notificationMessage, 'success');
                                
                                playNotificationSound();
                            }
                        }
                    }
                });
            }

            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }

            window.addEventListener('online', () => { 
                loadAllData(); 
            });
            
            window.addEventListener('offline', () => { 
                showNotification('تم الانتقال إلى وضع عدم الاتصال. يتم عرض البيانات المخزنة محلياً.', 'info');
            });

            window.addEventListener('beforeunload', () => {
                cleanupAllIntervals();
                saveDataToCache();
            });
    </script>
    
    <script>
        // إخطار Service Worker بالصفحات الفرعية المحتملة
        if ('serviceWorker' in navigator && navigator.serviceWorker.controller) {
            const childPages = ['manjr_tagr_snf.html', 'ard_tagr.html', '1_1k.html'];
            const fullUrls = childPages.map(page => new URL(page, window.location.origin).href);
            
            navigator.serviceWorker.controller.postMessage({
                type: 'PREFETCH_PAGES',
                pages: fullUrls
            });
        }
    </script>
</body>
</html>
