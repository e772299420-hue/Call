<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
/* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ù… */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

:root { --primary-color: #007bff; --secondary-color: #0056b3; --danger-color: #dc3545; --success-color: #28a745; --warning-color: #ffc107; --dark-color: #343a40; --light-color: #f8f9fa; --background-color: #ffffff; --text-color: #333; --border-radius: 8px; --box-shadow: 0 2px 10px rgba(0,0,0,0.1); --transition: all 0.3s ease; }

[data-theme="dark"] { --primary-color: #0d6efd; --secondary-color: #0a58ca; --background-color: #121212; --text-color: #e0e0e0; --light-color: #2d2d2d; --box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

body {  font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;  background: var(--background-color);  color: var(--text-color); margin: 0;  padding-top: 140px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª / padding-bottom: 60px; / Ù…Ø³Ø§Ø­Ø© Ù„Ù„ÙÙˆØªØ± Ø§Ù„Ø«Ø§Ø¨Øª */ transition: var(--transition); }

/* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */ .header{ position: fixed; top: 0; left: 0; width: 100%; background: var(--primary-color); color: white; padding: 15px 20px; display: flex; align-items: center; justify-content: space-between; z-index: 1000; box-shadow: var(--box-shadow); }

.header-content { display: flex; align-items: center; gap: 15px; width: 100%; max-width: 1200px; margin: 0 auto; }

.logo { font-size: 24px; font-weight: bold; }

.app-name { flex-grow: 1; text-align: center; font-size: 18px; }

.screen-name { font-size: 16px; opacity: 0.9; }

.theme-toggle { background: rgba(255, 255, 255, 0.2); border: none; color: white; padding: 8px 12px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px; transition: var(--transition); }

.theme-toggle:hover { background: rgba(255, 255, 255, 0.3); }

/* Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø«Ø§Ø¨Øª */ .filter-bar{ position: fixed; top: 70px; left: 0; width: 100%; background: var(--light-color); padding: 10px 20px; display: flex; flex-wrap: wrap; gap: 10px; z-index: 999; box-shadow: 0 2px 5px rgba(0,0,0,0.1); align-items: center; transition: var(--transition); }

.filter-item { display: flex; align-items: center; gap: 5px; }

.filter-item label { font-weight: bold; font-size: 14px; white-space: nowrap; }

.filter-item select, .filter-item input { padding: 6px 10px; border-radius: var(--border-radius); border: 1px solid #ccc; font-size: 14px; background: var(--background-color); color: var(--text-color); transition: var(--transition); }

.filter-item input { width: 200px; }

.price-range { display: flex; align-items: center; gap: 10px; }

.price-range input { width: 80px; }

.reset-btn { padding: 6px 12px; background: var(--danger-color); color: white; border: none; border-radius: var(--border-radius); cursor: pointer; font-size: 14px; transition: var(--transition); }

.reset-btn:hover { background: #c82333; }

/* Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø«Ø§Ø¨Øª */ .footer{ position: fixed; bottom: 0; left: 0; width: 100%; background: var(--primary-color); color: white; text-align: center; padding: 15px; z-index: 1000; font-size: 14px; }

/* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */ .page-content{ max-width: 1200px; margin: 0 auto; padding: 20px; }

h2 {  text-align:center;  margin:20px 0;  color: var(--text-color); }

.products {  display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 20px; padding: 20px; justify-content: center; }

.card { background: linear-gradient(145deg, var(--background-color), #f0f0f0); border-radius: 15px;  box-shadow: 0 5px 15px rgba(0,0,0,0.08);  overflow: hidden;  padding: 15px;  transition: var(--transition); position: relative; display: flex; flex-direction: column; align-items: center; } .card:hover{  transform: translateY(-5px);  box-shadow:0 10px 20px rgba(0,0,0,0.15);  }

.card.viewed { border: 2px solid var(--primary-color); background: linear-gradient(145deg, #f0f8ff, #e0f0ff); }

.favorite-btn { position: absolute; top: 10px; left: 10px; background: rgba(255, 255, 255, 0.8); border: none; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 10; transition: var(--transition); }

.favorite-btn.active { color: #ff4d4d; }

.favorite-btn:hover { background: rgba(255, 255, 255, 1); transform: scale(1.1); }

.images-preview {  display: flex;  gap: 10px;  flex-wrap: wrap;  margin-bottom: 15px;  justify-content: center;  width: 100%; position: relative; }

.images-preview img{ width: 100%; height: 250px; object-fit: cover; border-radius: 10px;  cursor: pointer; transition: var(--transition);  border: 3px solid var(--primary-color); position: relative; }

.images-preview img:hover{ transform: scale(1.05); border-color: var(--secondary-color); box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); }

.icons {  display: flex;  justify-content: space-around;  margin: 15px 0;  width: 100%; } .icon{  cursor: pointer;  font-size: 18px;  display: flex;  align-items: center;  gap: 5px;  color: var(--primary-color);  transition: var(--transition);  } .icon:hover{  color: var(--secondary-color);  }

.info { width: 100%; text-align: center; }

.info h3 {  margin: 5px 0;  font-size: 20px;  color: var(--text-color);  font-weight: bold; }

.product-details-single-line {
  margin: 10px 0;
  font-size: 14px;
  color: #666;
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  position: relative;
  padding-right: 80px;
}

.view-more-btn {
  position: absolute;
  right: 0;
  top: 0;
  background: var(--background-color);
  color: #007bff;
  border: none;
  border-radius: 4px;
  padding: 2px 8px;
  font-size: 12px;
  cursor: pointer;
  transition: var(--transition);
}

.info .label { font-weight: bold; color: var(--primary-color); font-size: 14px; }

.merchant-info {  display: flex;  flex-direction: column; gap: 5px;  margin: 10px 0;  padding: 10px; background-color: var(--light-color); border-radius: 8px; width: 100%; transition: var(--transition); } .merchant-name{  display: flex;  align-items: center;  justify-content: center; gap: 5px;  cursor: pointer;  color: var(--primary-color);  font-weight: bold;  transition: var(--transition);  text-align: center; font-size: 16px; } .merchant-name:hover{  color: var(--secondary-color);  text-decoration: underline; }

.merchant-location { margin-top: 5px; font-size: 14px; color: #666; }

.category-info { margin: 8px 0; padding: 8px; background: var(--light-color); border-radius: 6px; font-size: 14px; color: var(--text-color); }

.category-info .label { font-weight: bold; color: var(--primary-color); margin-left: 5px; }

.notes-container { margin: 10px 0; position: relative; width: 100%; }

.notes-preview { white-space: nowrap; overflow: hidden; text-overflow: ellipsis; padding: 5px; background: var(--light-color); border-radius: 5px; border: 1px solid #ddd; font-size: 14px; cursor: pointer; transition: var(--transition); }

.notes-preview.expanded { white-space: normal; overflow: visible; text-overflow: clip; }

.view-notes-btn { background: var(--primary-color); color: white; border: none; border-radius: 4px; padding: 5px 10px; margin-top: 5px; cursor: pointer; display: block; width: 100%; text-align: center; transition: var(--transition); }

.view-notes-btn:hover { background: var(--secondary-color); }

/* Modal Ù„Ù„ÙˆØµÙ Ø§Ù„ÙƒØ§Ù…Ù„ */ .description-modal{ display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.7); z-index: 2000; justify-content: center; align-items: center; }

.description-modal-content { background: var(--background-color); padding: 20px; border-radius: 10px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; border: 2px solid var(--primary-color); position: relative; }

.description-modal-content h4 { color: var(--primary-color); margin-bottom: 15px; text-align: center; }

.description-full-text { line-height: 1.6; color: var(--text-color); font-size: 14px; white-space: pre-line; }

.close-description { position: absolute; top: 10px; left: 10px; color: #aaa; font-size: 24px; cursor: pointer; }

/* Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ØªØ­Øª Ø§Ù„ØµÙˆØ±Ø© */ .comments-section{ width: 100%; margin-top: 15px; border-top: 2px solid var(--light-color); padding-top: 15px; display: none; position: relative; }

.comments-section.expanded { display: block; animation: slideDown 0.3s ease; }

.comments-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #eee; }

.comments-list { max-height: 200px; overflow-y: auto; margin-bottom: 15px; padding: 10px; background: var(--light-color); border-radius: 8px; }

.comment-item { padding: 12px; margin-bottom: 12px; background: var(--background-color); border-radius: 8px; border-left: 4px solid var(--primary-color); box-shadow: 0 2px 5px rgba(0,0,0,0.1); }

.comment-header { display: flex; justify-content: space-between; margin-bottom: 8px; font-weight: bold; }

.comment-date { color: #666; font-size: 12px; }

.comment-text { margin-bottom: 8px; line-height: 1.5; font-size: 14px; color: var(--text-color); }

.add-comment { margin-top: 15px; }

.comment-form { display: flex; flex-direction: column; gap: 10px; }

.comment-form textarea { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; resize: vertical; min-height: 80px; font-family: inherit; font-size: 14px; background: var(--background-color); color: var(--text-color); }

.comment-form button { padding: 10px 20px; background: var(--primary-color); color: white; border: none; border-radius: 8px; cursor: pointer; align-self: flex-end; transition: var(--transition); font-size: 14px; }

.comment-form button:hover { background: var(--secondary-color); }

@keyframes slideDown { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }

.loading { text-align: center; padding: 20px; color: var(--primary-color); }

.error { text-align: center; padding: 20px; color: var(--danger-color); background-color: #f8d7da; border-radius: 5px; margin: 20px; }

.sort-options { text-align: center; margin: 15px 0; }

.sort-options select { padding: 8px 15px; border-radius: var(--border-radius); border: 1px solid #ccc; font-size: 14px; background: var(--background-color); color: var(--text-color); }

.no-products { text-align: center; padding: 20px; color: #666; font-size: 16px; grid-column: 1 / -1; }

.no-comments { text-align: center; padding: 20px; color: #666; font-style: italic; }

/* ØªØ­Ø³ÙŠÙ†Ø§Øª Ù„Ù„ØªØ¬Ø§ÙˆØ¨ */ @media(max-width: 768px) { body { padding-top: 180px; }

.filter-bar { top: 100px; padding: 8px 10px; }

.filter-item { flex: 1 0 100%; }

.filter-item input { width: 100%; }

.price-range { flex-wrap: wrap; }

.products { grid-template-columns: 1fr; }

.images-preview img { height: 200px; }

.comments-list { max-height: 150px; }

.product-details-single-line {
  padding-right: 70px;
}

.view-more-btn {
  font-size: 11px;
  padding: 2px 6px;
} }

/* Skeleton Loading */ .skeleton{ background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%); background-size: 200% 100%; animation: loading 1.5s infinite; border-radius: var(--border-radius); }

.skeleton-text { height: 12px; margin-bottom: 8px; border-radius: 4px; }

.skeleton-image { height: 200px; margin-bottom: 15px; border-radius: 10px; }

@keyframes loading { 0% { background-position: 200% 0; } 100% { background-position: -200% 0; } }

/* Social Sharing */ .social-sharing{ display: flex; justify-content: center; gap: 10px; margin-top: 15px; }

.share-btn {  padding: 8px; background: var(--light-color); border: 1px solid #ddd; border-radius: var(--border-radius); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: var(--transition); font-size: 16px; }

.share-btn:hover { background: #e9ecef; }

/* Pagination */ .pagination{ display: flex; justify-content: center; margin: 20px 0; gap: 5px; }

.pagination-btn { padding: 8px 12px; background: var(--light-color); border: 1px solid #ddd; border-radius: var(--border-radius); cursor: pointer; transition: var(--transition); }

.pagination-btn.active { background: var(--primary-color); color: white; border-color: var(--primary-color); }

.pagination-btn:hover:not(.active) { background: #e9ecef; } </style>

</head>
<body>

<!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª -->

<header class="header">
  <div class="header-content">
    <div class="logo">AZ</div>
  <div class="app-name">AZ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„</div>
    <div class="screen-name">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
    <button class="theme-toggle" id="theme-toggle">ğŸŒ™</button>
  </div>
</header>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø© -->

<div class="filter-bar">
  <div class="filter-item">
    <label for="governorate">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</label>
    <select id="governorate">
      <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>
    </select>
  </div>

  <div class="filter-item">
    <label for="region">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
    <select id="region">
      <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
    </select>
  </div>

  <div class="filter-item">
    <label for="category">Ø§Ù„ÙØ¦Ø©:</label>
    <select id="category">
      <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>
    </select>
  </div>

  <div class="filter-item">
    <label for="search">Ø¨Ø­Ø«:</label>
    <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...">
  </div>

  <div class="filter-item price-range">
    <label for="min-price">Ø§Ù„Ø³Ø¹Ø± Ù…Ù†:</label>
    <input type="number" id="min-price" placeholder="Ø£Ù‚Ù„ Ø³Ø¹Ø±" min="0">
    <label for="max-price">Ø¥Ù„Ù‰:</label>
    <input type="number" id="max-price" placeholder="Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±" min="0">
  </div>

<button class="reset-btn" id="reset-filters">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>

</div>

<!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->

<div class="page-content">
  <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©</h2>

  <div class="sort-options">
    <label for="sort-by">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:</label>
    <select id="sort-by">
      <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
      <option value="category">Ø§Ù„ÙØ¦Ø©</option>
      <option value="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
      <option value="price">Ø§Ù„Ø³Ø¹Ø±</option>
      <option value="merchant">Ø§Ù„ØªØ§Ø¬Ø±</option>
    </select>
  </div>

  <div class="products" id="products">
    <!-- Skeleton Loading -->
    <div class="card">
      <div class="skeleton skeleton-image"></div>
      <div class="skeleton skeleton-text" style="width: 80%;"></div>
      <div class="skeleton skeleton-text" style="width: 60%;"></div>
      <div class="skeleton skeleton-text" style="width: 40%;"></div>
    </div>
    <div class="card">
      <div class="skeleton skeleton-image"></div>
      <div class="skeleton skeleton-text" style="width: 80%;"></div>
      <div class="skeleton skeleton-text" style="width: 60%;"></div>
      <div class="skeleton skeleton-text" style="width: 40%;"></div>
    </div>
    <div class="card">
      <div class="skeleton skeleton-image"></div>
      <div class="skeleton skeleton-text" style="width: 80%;"></div>
      <div class="skeleton skeleton-text" style="width: 60%;"></div>
      <div class="skeleton skeleton-text" style="width: 40%;"></div>
    </div>
  </div>

  <!-- Pagination -->

  <div class="pagination" id="pagination"></div>
</div>

<!-- Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø«Ø§Ø¨Øª -->

<footer class="footer">
  Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ Ø§Ù„Ù…Ù…ÙŠØ² Ø³ÙˆÙØª Ù„Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©
</footer>

<!-- Modal Ù„Ù„ÙˆØµÙ Ø§Ù„ÙƒØ§Ù…Ù„ -->

<div class="description-modal" id="descriptionModal">
  <div class="description-modal-content">
    <span class="close-description" onclick="closeDescriptionModal()">&times;</span>
    <h4>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h4>
    <div class="description-full-text" id="fullDescription"></div>
  </div>
</div>

<!-- Modal Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->

<div id="notesModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="modal-product-name"></h3>
    <div id="modal-notes-content"></div>
  </div>
</div>

<script>
const firebaseConfig = { 
  databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/" 
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†
let allProducts = [];
let allMerchants = [];
let allGovernorates = [];
let allRegions = [];
let allCategories = [];
let selectedCategoryId = '';
let currentPage = 1;
const productsPerPage = 9;
let favoriteProducts = JSON.parse(localStorage.getItem('favoriteProducts')) || {};
let currentCommentsProductId = '';
let userLikes = JSON.parse(localStorage.getItem('userLikes')) || {};

// Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
const productsContainer = document.getElementById('products');
const governorateSelect = document.getElementById('governorate');
const regionSelect = document.getElementById('region');
const categorySelect = document.getElementById('category');
const searchInput = document.getElementById('search');
const minPriceInput = document.getElementById('min-price');
const maxPriceInput = document.getElementById('max-price');
const resetButton = document.getElementById('reset-filters');
const sortSelect = document.getElementById('sort-by');
const paginationContainer = document.getElementById('pagination');
const themeToggle = document.getElementById('theme-toggle');
const descriptionModal = document.getElementById('descriptionModal');
const fullDescription = document.getElementById('fullDescription');

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
window.addEventListener('load', () => {
  const savedTheme = localStorage.getItem('theme');
  if (savedTheme === 'dark') {
    document.documentElement.setAttribute('data-theme', 'dark');
    themeToggle.textContent = 'â˜€ï¸';
  }
  
  loadAllData();
});

// Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
searchInput.addEventListener('input', filterProducts);
governorateSelect.addEventListener('change', handleGovernorateChange);
regionSelect.addEventListener('change', filterProducts);
categorySelect.addEventListener('change', handleCategoryChange);
minPriceInput.addEventListener('input', filterProducts);
maxPriceInput.addEventListener('input', filterProducts);
sortSelect.addEventListener('change', filterProducts);
resetButton.addEventListener('click', resetFilters);
themeToggle.addEventListener('click', toggleTheme);

// Ø¥ØºÙ„Ø§Ù‚ Modal Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ X
document.querySelectorAll(".close").forEach(closeBtn => {
  closeBtn.addEventListener("click", function() {
    this.closest('.modal').style.display = "none";
  });
});

// Ø¥ØºÙ„Ø§Ù‚ Modal Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
window.addEventListener("click", function(event) {
  if (event.target.classList.contains('modal')) {
    event.target.style.display = "none";
  }
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  if (currentCommentsProductId && !event.target.closest('.comments-section') && 
      !event.target.closest('.icon.comment')) {
    const commentsSection = document.getElementById(`comments-${currentCommentsProductId}`);
    if (commentsSection) {
      commentsSection.classList.remove('expanded');
      currentCommentsProductId = '';
    }
  }
  
  // Ø¥ØºÙ„Ø§Ù‚ modal Ø§Ù„ÙˆØµÙ Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬Ù‡Ø§
  if (event.target === descriptionModal) {
    closeDescriptionModal();
  }
});

// ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù…Ø©
function toggleTheme() {
  const currentTheme = document.documentElement.getAttribute('data-theme');
  if (currentTheme === 'dark') {
    document.documentElement.removeAttribute('data-theme');
    localStorage.setItem('theme', 'light');
    themeToggle.textContent = 'ğŸŒ™';
  } else {
    document.documentElement.setAttribute('data-theme', 'dark');
    localStorage.setItem('theme', 'dark');
    themeToggle.textContent = 'â˜€ï¸';
  }
}

// Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function loadAllData() {
  try {
    productsContainer.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>';
    
    const [productsSnap, merchantsSnap, governoratesSnap, regionsSnap, categoriesSnap] = await Promise.all([
      db.ref("products").once("value"),
      db.ref("merchants").once("value"),
      db.ref("governorates").once("value"),
      db.ref("regions").once("value"),
      db.ref("categories").once("value")
    ]);
    
    // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ§Øª
    allProducts = convertFirebaseData(productsSnap.val());
    allMerchants = convertFirebaseData(merchantsSnap.val());
    allGovernorates = convertFirebaseData(governoratesSnap.val());
    allRegions = convertFirebaseData(regionsSnap.val());
    allCategories = convertFirebaseData(categoriesSnap.val());
    
    // ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©
    populateFilterOptions();
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    displayProducts(allProducts);
    
  } catch (error) {
    console.error("Error loading data:", error);
    productsContainer.innerHTML = '<div class="error">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</div>';
  }
}

// ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
function convertFirebaseData(firebaseData) {
  if (!firebaseData) return [];
  
  return Object.entries(firebaseData).map(([id, data]) => {
    return { id, ...data };
  });
}

// ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©
function populateFilterOptions() {
  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
  governorateSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>';
  allGovernorates.forEach(governorate => {
    const option = document.createElement('option');
    option.value = governorate.id;
    option.textContent = governorate.name || governorate.id;
    governorateSelect.appendChild(option);
  });
  
  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙØ¦Ø§Øª
  categorySelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>';
  allCategories.forEach(category => {
    const option = document.createElement('option');
    option.value = category.id;
    option.textContent = category.name || category.id;
    categorySelect.appendChild(option);
  });
  
  // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
  updateRegionOptions();
}

// ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
function updateRegionOptions() {
  const selectedGovernorate = governorateSelect.value;
  regionSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>';
  
  if (selectedGovernorate) {
    const governorate = allGovernorates.find(g => g.id === selectedGovernorate);
    if (governorate && governorate.areas) {
      Object.entries(governorate.areas).forEach(([areaId, areaName]) => {
        const option = document.createElement('option');
        option.value = areaId;
        option.textContent = areaName;
        regionSelect.appendChild(option);
      });
    }
  } else {
    allRegions.forEach(region => {
      const option = document.createElement('option');
      option.value = region.id;
      option.textContent = region.name || region.id;
      regionSelect.appendChild(option);
    });
  }
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©
function handleGovernorateChange() {
  updateRegionOptions();
  filterProducts();
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„ÙØ¦Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
function handleCategoryChange() {
  selectedCategoryId = categorySelect.value;
  filterProducts();
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function displayProducts(products) {
  productsContainer.innerHTML = '';
  
  if (!products || products.length === 0) {
    productsContainer.innerHTML = '<div class="no-products">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
    paginationContainer.innerHTML = '';
    return;
  }
  
  // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
  const sortBy = sortSelect.value;
  
  products.sort((a, b) => {
    let comparison = 0;
    
    switch(sortBy) {
      case 'name':
        comparison = (a.name || '').localeCompare(b.name || '');
        break;
      case 'category':
        const categoryA = a.categoryId ? (allCategories.find(c => c.id === a.categoryId)?.name || '') : '';
        const categoryB = b.categoryId ? (allCategories.find(c => c.id === b.categoryId)?.name || '') : '';
        comparison = categoryA.localeCompare(categoryB);
        break;
      case 'date':
        comparison = new Date(b.publishDate || 0) - new Date(a.publishDate || 0);
        break;
      case 'price':
        const priceA = parseFloat(a.price) || 0;
        const priceB = parseFloat(b.price) || 0;
        comparison = priceA - priceB;
        break;
      case 'merchant':
        const merchantA = a.userId ? (allMerchants.find(m => m.id === a.userId)?.name || '') : '';
        const merchantB = b.userId ? (allMerchants.find(m => m.id === b.userId)?.name || '') : '';
        comparison = merchantA.localeCompare(merchantB);
        break;
      default:
        comparison = 0;
    }
    
  });
  
  // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¬Ø²Ø¦Ø© (Pagination)
  const totalPages = Math.ceil(products.length / productsPerPage);
  displayPagination(totalPages);
  
  // ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù„Ù„ØµÙØ­Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©
  const startIndex = (currentPage - 1) * productsPerPage;
  const endIndex = startIndex + productsPerPage;
  const currentProducts = products.slice(startIndex, endIndex);
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø©
  currentProducts.forEach(product => {
    if (!product || !product.userId) return;
    
    const merchant = allMerchants.find(m => m.id === product.userId);
    if (!merchant || merchant.status !== "active" || product.availability !== "available") return;
    
    const merchantName = merchant.name || merchant.username || "ØªØ§Ø¬Ø±";
    const categoryName = product.categoryId ? 
      (allCategories.find(c => c.id === product.categoryId)?.name || '') : '';
    
    const card = createProductCard(product, merchant, merchantName, categoryName);
    productsContainer.appendChild(card);
  });
}

// Ø¹Ø±Ø¶ Pagination
function displayPagination(totalPages) {
  paginationContainer.innerHTML = '';
  
  if (totalPages <= 1) return;
  
  // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©
  if (currentPage > 1) {
    const prevBtn = document.createElement('button');
    prevBtn.className = 'pagination-btn';
    prevBtn.innerHTML = '&laquo;';
    prevBtn.addEventListener('click', () => {
      currentPage--;
      filterProducts();
      window.scrollTo(0, 0);
    });
    paginationContainer.appendChild(prevBtn);
  }
  
  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØµÙØ­Ø§Øª
  for (let i = 1; i <= totalPages; i++) {
    const pageBtn = document.createElement('button');
    pageBtn.className = 'pagination-btn';
    if (i === currentPage) pageBtn.classList.add('active');
    pageBtn.textContent = i;
    pageBtn.addEventListener('click', () => {
      currentPage = i;
      filterProducts();
      window.scrollTo(0, 0);
    });
    paginationContainer.appendChild(pageBtn);
  }
  
  // Ø²Ø± Ø§Ù„ØµÙØ­Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©
  if (currentPage < totalPages) {
    const nextBtn = document.createElement('button');
    nextBtn.className = 'pagination-btn';
    nextBtn.innerHTML = '&raquo;';
    nextBtn.addEventListener('click', () => {
      currentPage++;
      filterProducts();
      window.scrollTo(0, 0);
    });
    paginationContainer.appendChild(nextBtn);
  }
}

// Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬
function createProductCard(product, merchant, merchantName, categoryName) {
  const card = document.createElement("div");
  card.className = "card";
  card.id = "card-" + product.id;
  
  // Ø²Ø± Ø§Ù„Ù…ÙØ¶Ù„Ø©
  const favoriteBtn = document.createElement("button");
  favoriteBtn.className = "favorite-btn";
  if (favoriteProducts[product.id]) {
    favoriteBtn.classList.add("active");
  }
  favoriteBtn.innerHTML = "â¤ï¸";
  favoriteBtn.title = "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©";
  favoriteBtn.onclick = (e) => {
    e.stopPropagation();
    toggleFavorite(product.id, favoriteBtn);
  };
  card.appendChild(favoriteBtn);
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±
  const displayDiv = document.createElement("div");
  displayDiv.className = "images-preview";
  
  let urlsArray = [];
  if (Array.isArray(product.imageUrls)) {
    urlsArray = product.imageUrls;
  } else if (typeof product.imageUrls === "string") {
    urlsArray = product.imageUrls.split(",");
  }
  
  if (urlsArray.length > 0 && urlsArray[0]) {
    const imgContainer = document.createElement("div");
    imgContainer.style.position = "relative";
    
    const img = document.createElement("img");
    img.loading = "lazy";
    img.src = formatDriveUrl(urlsArray[0], true); // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØºØ±Ø© Ù„Ù„Ø¹Ø±Ø¶
    img.alt = product.name || "ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬";
    img.onclick = () => window.open(formatDriveUrl(urlsArray[0], false), '_blank'); // ÙØªØ­ Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
    
    imgContainer.appendChild(img);
    displayDiv.appendChild(imgContainer);
  }
  
  card.appendChild(displayDiv);
  
  // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
  const infoDiv = document.createElement("div");
  infoDiv.className = "info";
  
  // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ø³Ù… Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø©
  const governorate = allGovernorates.find(g => g.id === merchant.governorate);
  const governorateName = governorate?.name || merchant.governorate;
  const areaName = governorate?.areas?.[merchant.area] || merchant.area;
  
  infoDiv.innerHTML = `
    <h3>${product.name || "Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</h3>
  `;
  
  // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø³Ø·Ø± ÙˆØ§Ø­Ø¯ Ù…Ø¹ Ø²Ø± Ø§Ù„Ù…Ø²ÙŠØ¯
  const detailsContainer = document.createElement("div");
  detailsContainer.className = "product-details-single-line";
  
  const productDetails = [
    product.price ? `Ø§Ù„Ø³Ø¹Ø±: ${product.price} Ø±ÙŠØ§Ù„` : '',
    categoryName ? `Ø§Ù„ÙØ¦Ø©: ${categoryName}` : '',
    governorateName ? `Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©: ${governorateName}` : '',
    areaName ? `Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${areaName}` : ''
  ].filter(Boolean).join(' | ');
  
  detailsContainer.textContent = productDetails;
  
  // Ø²Ø± Ø§Ù„Ù…Ø²ÙŠØ¯
  const viewMoreBtn = document.createElement("button");
  viewMoreBtn.className = "view-more-btn";
  viewMoreBtn.textContent = "Ø§Ù„Ù…Ø²ÙŠØ¯";
  viewMoreBtn.onclick = (e) => {
    e.stopPropagation();
    showFullProductDetails(product, merchantName, categoryName, governorateName, areaName);
  };
  detailsContainer.appendChild(viewMoreBtn);
  
  infoDiv.appendChild(detailsContainer);
  
  infoDiv.innerHTML += `
    <div class="merchant-info">
      <div class="merchant-name" onclick="openMerchantPage('${merchantName}')">
        ${merchantName} ğŸ‘ˆ
      </div>
      ${governorateName || areaName ? `
        <div class="merchant-location">
          ${governorateName ? `${governorateName}` : ''}
          ${governorateName && areaName ? ' - ' : ''}
          ${areaName ? `${areaName}` : ''}
        </div>
      ` : ''}
    </div>
  `;
  
  card.appendChild(infoDiv);
  
  // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„
  const iconsDiv = document.createElement("div");
  iconsDiv.className = "icons";
  iconsDiv.innerHTML = `
    <div class="icon like" onclick="handleLike('${product.id}')">ğŸ‘ <span class="like-count">0</span></div>
    <div class="icon views">ğŸ‘ï¸ <span class="view-count">0</span></div>
    <div class="icon comment" onclick="toggleComments('${product.id}')">ğŸ’¬ <span class="comment-count">0</span></div>
    <div class="icon share-btn" onclick="shareProduct('${product.name}', '${formatDriveUrl(urlsArray[0], false)}')">ğŸ“¤</div>
  `;
  
  card.appendChild(iconsDiv);
  
  // Ø¥Ø¶Ø§ÙØ© Ù‚Ø³Ù… Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
  const commentsSection = document.createElement("div");
  commentsSection.className = "comments-section";
  commentsSection.id = `comments-${product.id}`;
  commentsSection.innerHTML = `
    <div class="comments-header">
      <h4>ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬</h4>
      <span class="comments-count">0 ØªØ¹Ù„ÙŠÙ‚</span>
    </div>
    <div class="comments-list"></div>
    <div class="add-comment">
      <div class="comment-form">
        <textarea placeholder="Ø§ÙƒØªØ¨ ØªØ¹Ù„ÙŠÙ‚Ùƒ Ù‡Ù†Ø§..."></textarea>
        <button onclick="addComment('${product.id}', this)">Ù†Ø´Ø± Ø§Ù„ØªØ¹Ù„ÙŠÙ‚</button>
      </div>
    </div>
  `;
  
  card.appendChild(commentsSection);
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  loadProductStats(product.id, card);
  
  return card;
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø±Ø§Ø¨Ø· Google Drive
function formatDriveUrl(url, isThumbnail = true) {
  if (!url) return '';
  
  let id = "";
  if (url.includes("/d/")) id = url.split("/d/")[1].split("/")[0];
  else if (url.includes("id=")) id = new URLSearchParams(url.split("?")[1]).get("id");
  else if (url.includes("drive.usercontent.google.com")) id = new URLSearchParams(url.split("?")[1]).get("id");
  
  if (!id) return url;
  
  if (isThumbnail) {
    // Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ù…ØµØºØ±Ø© Ù„Ù„Ø¹Ø±Ø¶ ÙÙŠ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©
    return `https://drive.google.com/thumbnail?id=${id}&sz=w400`;
  } else {
    // Ø±Ø§Ø¨Ø· Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø£ØµÙ„ÙŠØ© Ø¹Ø§Ù„ÙŠØ© Ø§Ù„Ø¬ÙˆØ¯Ø© Ù„Ù„ÙØªØ­ ÙÙŠ Ù†Ø§ÙØ°Ø© Ø¬Ø¯ÙŠØ¯Ø©
    return `https://drive.google.com/uc?export=view&id=${id}`;
  }
}

// Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙƒØ§Ù…Ù„Ø©
function showFullProductDetails(product, merchantName, categoryName, governorateName, areaName) {
  let fullDetails = '';
  
  if (product.name) fullDetails += `Ø§Ù„Ø§Ø³Ù…: ${product.name}\n\n`;
  if (product.description) fullDetails += `Ø§Ù„ÙˆØµÙ: ${product.description}\n\n`;
  if (product.price) fullDetails += `Ø§Ù„Ø³Ø¹Ø±: ${product.price} Ø±ÙŠØ§Ù„\n\n`;
  if (categoryName) fullDetails += `Ø§Ù„ÙØ¦Ø©: ${categoryName}\n\n`;
  if (merchantName) fullDetails += `Ø§Ù„ØªØ§Ø¬Ø±: ${merchantName}\n\n`;
  if (governorateName) fullDetails += `Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©: ${governorateName}\n\n`;
  if (areaName) fullDetails += `Ø§Ù„Ù…Ù†Ø·Ù‚Ø©: ${areaName}\n\n`;
  if (product.notes) fullDetails += `Ù…Ù„Ø§Ø­Ø¸Ø§Øª: ${product.notes}\n\n`;
  
  fullDescription.textContent = fullDetails || 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙƒØ§ÙÙŠØ© Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬';
  descriptionModal.style.display = 'flex';
}

// Ø¥ØºÙ„Ø§Ù‚ modal Ø§Ù„ÙˆØµÙ
function closeDescriptionModal() {
  descriptionModal.style.display = 'none';
}

// Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
async function handleLike(productId) {
  try {
    const userId = getUserId();
    const likesRef = db.ref(`products_stats/${productId}/likes`);
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const likesSnap = await likesRef.once("value");
    let likesData = likesSnap.val() || [];
    
    if (!Array.isArray(likesData)) {
      likesData = [];
    }
    
    // Ø§Ù„ØªØ­Ù‚Ù‚ Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ Ø£Ø¹Ø¬Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„
    const userIndex = likesData.indexOf(userId);
    
    if (userIndex === -1) {
      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
      likesData.push(userId);
    } else {
      // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
      likesData.splice(userIndex, 1);
    }
    
    // Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    await likesRef.set(likesData);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
    const likeCountEl = document.querySelector(`#card-${productId} .like-count`);
    if (likeCountEl) {
      likeCountEl.textContent = likesData.length;
    }
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø§Ù„Ø²Ø±
    updateLikeButtonState(productId, likesData.includes(userId));
    
  } catch (error) {
    console.error("Error handling like:", error);
  }
}

// Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
function getUserId() {
  let userId = localStorage.getItem('userId');
  if (!userId) {
    userId = 'user_' + Math.random().toString(36).substr(2, 9);
    localStorage.setItem('userId', userId);
  }
  return userId;
}

// ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
function updateLikeButtonState(productId, isLiked) {
  const likeBtn = document.querySelector(`#card-${productId} .like`);
  if (likeBtn) {
    if (isLiked) {
      likeBtn.style.color = '#ff4d4d';
    } else {
      likeBtn.style.color = 'var(--primary-color)';
    }
  }
}

// ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
function toggleComments(productId) {
  const commentsSection = document.getElementById(`comments-${productId}`);
  const isExpanded = commentsSection.classList.contains('expanded');
  
  // Ø¥ØºÙ„Ø§Ù‚ Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
  document.querySelectorAll('.comments-section.expanded').forEach(section => {
    if (section.id !== `comments-${productId}`) {
      section.classList.remove('expanded');
    }
  });
  
  if (isExpanded) {
    commentsSection.classList.remove('expanded');
    currentCommentsProductId = '';
  } else {
    commentsSection.classList.add('expanded');
    currentCommentsProductId = productId;
    loadComments(productId);
  }
}

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
async function loadComments(productId) {
  try {
    const commentsSection = document.getElementById(`comments-${productId}`);
    const commentsList = commentsSection.querySelector('.comments-list');
    const commentsCount = commentsSection.querySelector('.comments-count');
    
    commentsList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª...</div>';
    
    const commentsSnap = await db.ref(`comments/${productId}`).once("value");
    const comments = convertFirebaseData(commentsSnap.val());
    
    displayComments(comments, commentsList, commentsCount, productId);
  } catch (error) {
    console.error("Error loading comments:", error);
    const commentsList = document.querySelector(`#comments-${productId} .comments-list`);
    commentsList.innerHTML = '<div class="error">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</div>';
  }
}

// Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
function displayComments(comments, commentsList, commentsCount, productId) {
  commentsList.innerHTML = '';
  
  if (!comments || comments.length === 0) {
    commentsList.innerHTML = '<div class="no-comments">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯</div>';
    commentsCount.textContent = '0 ØªØ¹Ù„ÙŠÙ‚';
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
    const commentCountEl = document.querySelector(`#card-${productId} .comment-count`);
    if (commentCountEl) {
      commentCountEl.textContent = '0';
    }
    return;
  }
  
  // ØªØ±ØªÙŠØ¨ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ®
  comments.sort((a, b) => {
    return new Date(b.date || 0) - new Date(a.date || 0);
  });
  
  // Ø¹Ø±Ø¶ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
  const commentsLength = comments.length;
  commentsCount.textContent = `${commentsLength} ØªØ¹Ù„ÙŠÙ‚`;
  
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø§Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª ÙÙŠ Ø§Ù„Ø£ÙŠÙ‚ÙˆÙ†Ø©
  const commentCountEl = document.querySelector(`#card-${productId} .comment-count`);
  if (commentCountEl) {
    commentCountEl.textContent = commentsLength;
  }
  
  // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
  comments.forEach(comment => {
    const commentItem = document.createElement("div");
    commentItem.className = "comment-item";
    
    commentItem.innerHTML = `
      <div class="comment-header">
        <span class="comment-author">${comment.author || "Ù…Ø³ØªØ®Ø¯Ù…"}</span>
        <span class="comment-date">${formatDate(comment.date)}</span>
      </div>
      <div class="comment-text">${comment.text}</div>
    `;
    
    commentsList.appendChild(commentItem);
  });
}

// Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯
async function addComment(productId, button) {
  const commentForm = button.parentElement;
  const textarea = commentForm.querySelector('textarea');
  const commentTextValue = textarea.value.trim();
  
  if (!commentTextValue) {
    alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚ Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø±");
    return;
  }
  
  try {
    const commentId = Date.now().toString();
    
    const comment = {
      text: commentTextValue,
      author: "Ù…Ø³ØªØ®Ø¯Ù…",
      date: new Date().toISOString()
    };
  
    await db.ref(`comments/${productId}/${commentId}`).set(comment);
    
    // Ø¥Ø¹Ø§Ø¯Ø© ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    loadComments(productId);
    
    // Ù…Ø³Ø­ Ø­Ù‚Ù„ Ø§Ù„Ù†Øµ
    textarea.value = "";
    
  } catch (error) {
    console.error("Error adding comment:", error);
    alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚");
  }
}

// Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬
function shareProduct(productName, imageUrl) {
  const shareText = `Ù…ØªØ¬Ø± AZ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„ØªÙ„Ø¨ÙŠØ© Ø§Ø­ØªÙŠØ§Ø¬Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙŠØ±Ø­Ø¨ Ø¨Ùƒ\n\nØªÙØ¶Ù„ Ø¨ØªØµÙØ­ ${productName}\n\nØ¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ\n\n${window.location.href}`;
  
  if (navigator.share) {
    navigator.share({
      title: productName,
      text: shareText,
      url: window.location.href
    })
    .then(() => console.log('ØªÙ… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­'))
    .catch((error) => console.log('Error sharing:', error));
  } else {
    navigator.clipboard.writeText(shareText)
      .then(() => alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©: \n' + shareText))
      .catch(err => {
        console.error('Failed to copy: ', err);
        prompt('ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ:', shareText);
      });
  }
}

// Ø¥Ø¶Ø§ÙØ©/Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©
function toggleFavorite(pid, button) {
  if (favoriteProducts[pid]) {
    delete favoriteProducts[pid];
    button.classList.remove("active");
  } else {
    favoriteProducts[pid] = true;
    button.classList.add("active");
  }
  
  localStorage.setItem('favoriteProducts', JSON.stringify(favoriteProducts));
}

// Ø¯Ø§Ù„Ø© ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±
function openMerchantPage(merchantName) {
  localStorage.setItem('selectedMerchant', merchantName);
  window.open("ard_tagr.html", "_blank");
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Modal
function showNotesModal(productName, notes) {
  const modal = document.getElementById('notesModal');
  const productNameElement = document.getElementById('modal-product-name');
  const notesContentElement = document.getElementById('modal-notes-content');
  
  productNameElement.textContent = productName || "Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
  notesContentElement.textContent = notes;
  
  modal.style.display = "block";
}

// Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬
async function loadProductStats(pid, card) {
  try {
    const statsSnap = await db.ref(`products_stats/${pid}`).once("value");
    const stats = statsSnap.val() || {};
    
    const viewCountEl = card.querySelector(".view-count");
    viewCountEl.textContent = stats.views || 0;
    
    // ØªØ­Ù…ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ
    const likesRef = db.ref(`products_stats/${pid}/likes`);
    const likesSnap = await likesRef.once("value");
    const likesData = likesSnap.val() || [];
    const likeCount = Array.isArray(likesData) ? likesData.length : 0;
    
    const likeCountEl = card.querySelector(".like-count");
    likeCountEl.textContent = likeCount;
    
    // ØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„Ø© Ø²Ø± Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø­Ø§Ù„Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
    const userId = getUserId();
    const isLiked = Array.isArray(likesData) && likesData.includes(userId);
    updateLikeButtonState(pid, isLiked);
    
    // ØªØ­Ù…ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    const commentsSnap = await db.ref(`comments/${pid}`).once("value");
    const comments = commentsSnap.val() || {};
    const commentCount = Object.keys(comments).length;
    
    const commentCountEl = card.querySelector(".comment-count");
    commentCountEl.textContent = commentCount;
    
  } catch (error) {
    console.error("Error loading product stats:", error);
  }
}

// Ø¯Ø§Ù„Ø© ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function filterProducts() {
  const governorateValue = governorateSelect.value;
  const regionValue = regionSelect.value;
  const searchValue = searchInput.value.toLowerCase();
  const minPrice = parseFloat(minPriceInput.value) || 0;
  const maxPrice = parseFloat(maxPriceInput.value) || Infinity;
  
  let filteredProducts = [...allProducts];
  
  // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø«
  if (searchValue) {
    filteredProducts = filteredProducts.filter(product => {
      const productName = product.name || '';
      const productDescription = product.description || '';
      
      return productName.toLowerCase().includes(searchValue) || 
             productDescription.toLowerCase().includes(searchValue);
    });
  }
  
  // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
  if (selectedCategoryId) {
    filteredProducts = filteredProducts.filter(product => 
      product.categoryId === selectedCategoryId
    );
  }
  
  // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±
  filteredProducts = filteredProducts.filter(product => {
    const productPrice = parseFloat(product.price) || 0;
    return productPrice >= minPrice && productPrice <= maxPrice;
  });
  
  // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø©
  if (governorateValue || regionValue) {
    filteredProducts = filteredProducts.filter(product => {
      const merchant = allMerchants.find(m => m.id === product.userId);
      if (!merchant) return false;
      
      if (governorateValue && merchant.governorate !== governorateValue) return false;
      if (regionValue && merchant.area !== regionValue) return false;
      
      return true;
    });
  }
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØµÙØ§Ø©
  displayProducts(filteredProducts);
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
function resetFilters() {
  governorateSelect.value = "";
  regionSelect.value = "";
  categorySelect.value = "";
  searchInput.value = "";
  minPriceInput.value = "";
  maxPriceInput.value = "";
  sortSelect.value = "name";
  selectedCategoryId = '';
  currentPage = 1;
  
  updateRegionOptions();
  displayProducts(allProducts);
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Firebase Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ù…Ù‚Ø±ÙˆØ¡
function formatDate(dateString) {
  if (!dateString) return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-EG');
  } catch (e) {
    return dateString;
  }
}
</script>

</body>
</html>
