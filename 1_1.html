<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #007bff;
            --secondary-color: #0056b3;
            --danger-color: #dc3545;
            --success-color: #28a745;
            --warning-color: #ffc107;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --background-color: #ffffff;
            --text-color: #333;
            --border-radius: 8px;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            --transition: all 0.3s ease;
        }

        [data-theme="dark"] {
            --primary-color: #0d6efd;
            --secondary-color: #0a58ca;
            --background-color: #121212;
            --text-color: #e0e0e0;
            --light-color: #2d2d2d;
            --box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--background-color);
            color: var(--text-color);
            margin: 0;
            padding-top: 140px;
            padding-bottom: 60px;
            transition: var(--transition);
        }

        .header {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: var(--primary-color);
            color: white;
            padding: 15px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: var(--box-shadow);
        }

        .header-content {
            display: flex;
            align-items: center;
            gap: 15px;
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
        }

        .app-name {
            flex-grow: 1;
            text-align: center;
            font-size: 18px;
        }

        .screen-name {
            font-size: 16px;
            opacity: 0.9;
        }

        .theme-toggle {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
        }

        .theme-toggle:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .filter-bar {
            position: fixed;
            top: 70px;
            left: 0;
            width: 100%;
            background: var(--light-color);
            padding: 10px 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            z-index: 999;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            align-items: center;
            transition: var(--transition);
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .filter-item label {
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }

        .filter-item select, .filter-item input {
            padding: 6px 10px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            font-size: 14px;
            background: var(--background-color);
            color: var(--text-color);
            transition: var(--transition);
        }

        .filter-item input {
            width: 200px;
        }

        .price-range {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .price-range input {
            width: 80px;
        }

        .reset-btn {
            padding: 6px 12px;
            background: var(--danger-color);
            color: white;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .reset-btn:hover {
            background: #c82333;
        }

        .hide-btn {
            padding: 6px 12px;
            background: var(--warning-color);
            color: #000;
            border: none;
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: 14px;
            transition: var(--transition);
        }

        .hide-btn:hover {
            background: #e0a800;
        }

        .show-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: 20px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: var(--transition);
            margin-left: 10px;
        }

        .show-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .footer {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background: var(--primary-color);
            color: white;
            text-align: center;
            padding: 15px;
            z-index: 1000;
            font-size: 14px;
        }

        .page-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        h2 {
            text-align:center;
            margin:20px 0;
            color: var(--text-color);
        }

        .products {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            padding: 20px;
            justify-content: center;
        }

        .card {
            background: linear-gradient(145deg, var(--background-color), #f0f0f0);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.08);
            overflow: hidden;
            padding: 15px;
            transition: var(--transition);
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow:0 10px 20px rgba(0,0,0,0.15);
        }

        .card.viewed {
            border: 2px solid var(--primary-color);
            background: linear-gradient(145deg, #f0f8ff, #e0f0ff);
        }

        .favorite-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.8);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            z-index: 10;
            transition: var(--transition);
        }

        .favorite-btn.active {
            color: #ff4d4d;
        }

        .favorite-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: scale(1.1);
        }

        .images-preview {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-bottom: 15px;
            justify-content: center;
            width: 100%;
            position: relative;
        }

        .images-preview img {
            width: 100%;
            height: 250px;
            object-fit: cover;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            border: 3px solid var(--primary-color);
            position: relative;
        }

        .images-preview img:hover {
            transform: scale(1.05);
            border-color: var(--secondary-color);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .icons {
            display: flex;
            justify-content: space-around;
            margin: 15px 0;
            width: 100%;
        }

        .icon {
            cursor: pointer;
            font-size: 18px;
            display: flex;
            align-items: center;
            gap: 5px;
            color: var(--primary-color);
            transition: var(--transition);
        }

        .icon:hover {
            color: var(--secondary-color);
        }

        .info {
            width: 100%;
            text-align: center;
        }

        .info h3 {
            margin: 5px 0;
            font-size: 20px;
            color: var(--text-color);
            font-weight: bold;
        }

        .product-price {
            text-align: center;
            font-size: 22px;
            font-weight: bold;
            color: var(--primary-color);
            margin: 10px 0;
            padding: 5px;
            background-color: rgba(0, 123, 255, 0.1);
            border-radius: 8px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .product-details {
            margin: 10px 0;
            font-size: 14px;
            color: #666;
            text-align: right;
            width: 100%;
            direction: rtl;
        }

        .product-detail-item {
            margin-bottom: 8px;
            display: flex;
            justify-content: space-between;
            border-bottom: 1px dashed #eee;
            padding-bottom: 5px;
        }

        .product-detail-item .label {
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 10px;
        }

        .publish-date {
            text-align: right;
            direction: rtl;
            font-weight: normal;
        }

        .merchant-info {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 10px 0;
            padding: 10px;
            background-color: var(--light-color);
            border-radius: 8px;
            width: 100%;
            transition: var(--transition);
        }

        .merchant-name {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
            cursor: pointer;
            color: var(--primary-color);
            font-weight: bold;
            transition: var(--transition);
            text-align: center;
            font-size: 16px;
        }

        .merchant-name:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }

        .product-date {
            text-align: center;
            font-size: 14px;
            color: #666;
            margin-top: 5px;
            padding: 5px;
            background-color: rgba(0, 0, 0, 0.05);
            border-radius: 4px;
            width: 100%;
        }

        .category-info {
            margin: 8px 0;
            padding: 8px;
            background: var(--light-color);
            border-radius: 6px;
            font-size: 14px;
            color: var(--text-color);
            text-align: right;
        }

        .category-info .label {
            font-weight: bold;
            color: var(--primary-color);
            margin-left: 5px;
        }

        .notes-container {
            margin: 10px 0;
            position: relative;
            width: 100%;
            text-align: right;
        }

        .notes-preview {
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding: 5px;
            background: var(--light-color);
            border-radius: 5px;
            border: 1px solid #ddd;
            font-size: 14px;
            cursor: pointer;
            transition: var(--transition);
            text-align: right;
            direction: rtl;
        }

        .notes-preview.expanded {
            white-space: normal;
            overflow: visible;
            text-overflow: clip;
        }

        .view-notes-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 5px 10px;
            margin-top: 5px;
            cursor: pointer;
            display: block;
            width: 100%;
            text-align: center;
            transition: var(--transition);
        }

        .view-notes-btn:hover {
            background: var(--secondary-color);
        }

        .description-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 2000;
            justify-content: center;
            align-items: center;
        }

        .description-modal-content {
            background: var(--background-color);
            padding: 20px;
            border-radius: 10px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid var(--primary-color);
            position: relative;
        }

        .description-modal-content h4 {
            color: var(--primary-color);
            margin-bottom: 15px;
            text-align: center;
        }

        .description-full-text {
            line-height: 1.6;
            color: var(--text-color);
            font-size: 14px;
            white-space: pre-line;
            text-align: right;
            direction: rtl;
        }

        .close-description {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #aaa;
            font-size: 24px;
            cursor: pointer;
        }

        .comments-section {
            width: 100%;
            margin-top: 15px;
            border-top: 2px solid var(--light-color);
            padding-top: 15px;
            display: none;
            position: relative;
        }

        .comments-section.expanded {
            display: block;
            animation: slideDown 0.3s ease;
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .comments-list {
            max-height: 200px;
            overflow-y: auto;
            margin-bottom: 15px;
            padding: 10px;
            background: var(--light-color);
            border-radius: 8px;
        }

        .comment-item {
            padding: 12px;
            margin-bottom: 12px;
            background: var(--background-color);
            border-radius: 8px;
            border-left: 4px solid var(--primary-color);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-weight: bold;
        }

        .comment-date {
            color: #666;
            font-size: 12px;
        }

        .comment-text {
            margin-bottom: 8px;
            line-height: 1.5;
            font-size: 14px;
            color: var(--text-color);
        }

        .add-comment {
            margin-top: 15px;
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .comment-form textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            resize: vertical;
            min-height: 80px;
            font-family: inherit;
            font-size: 14px;
            background: var(--background-color);
            color: var(--text-color);
        }

        .comment-form button {
            padding: 10px 20px;
            background: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            align-self: flex-end;
            transition: var(--transition);
            font-size: 14px;
        }

        .comment-form button:hover {
            background: var(--secondary-color);
        }

        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: var(--primary-color);
        }

        .error {
            text-align: center;
            padding: 20px;
            color: var(--danger-color);
            background-color: #f8d7da;
            border-radius: 5px;
            margin: 20px;
        }

        .sort-options {
            display: flex;
            align-items: center;
            gap: 5px;
            margin: 0;
        }

        .sort-options label {
            font-weight: bold;
            font-size: 14px;
            white-space: nowrap;
        }

        .sort-options select {
            padding: 6px 10px;
            border-radius: var(--border-radius);
            border: 1px solid #ccc;
            font-size: 14px;
            background: var(--background-color);
            color: var(--text-color);
        }

        .no-products {
            text-align: center;
            padding: 20px;
            color: #666;
            font-size: 16px;
            grid-column: 1 / -1;
        }

        .no-comments {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }

        @media(max-width: 768px) {
            body { padding-top: 180px; }

            .filter-bar { top: 100px; padding: 8px 10px; }

            .filter-item { flex: 1 0 100%; }

            .filter-item input { width: 100%; }

            .price-range { flex-wrap: wrap; }

            .products { grid-template-columns: 1fr; }

            .images-preview img { height: 200px; }

            .comments-list { max-height: 150px; }

            .product-price {
                font-size: 18px;
            }
        }

        .skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: loading 1.5s infinite;
            border-radius: var(--border-radius);
        }

        .skeleton-text {
            height: 12px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .skeleton-image {
            height: 200px;
            margin-bottom: 15px;
            border-radius: 10px;
        }

        @keyframes loading {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .social-sharing {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 15px;
        }

        .share-btn {
            padding: 8px;
            background: var(--light-color);
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
            font-size: 16px;
        }

        .share-btn:hover {
            background: #e9ecef;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin: 20px 0;
            gap: 5px;
        }

        .pagination-btn {
            padding: 8px 12px;
            background: var(--light-color);
            border: 1px solid #ddd;
            border-radius: var(--border-radius);
            cursor: pointer;
            transition: var(--transition);
        }

        .pagination-btn.active {
            background: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
        }

        .pagination-btn:hover:not(.active) {
            background: #e9ecef;
        }
        
        /* ÙØ¦Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„ØªØµÙ†ÙŠÙ */
        .category-header {
            text-align: center;
            margin: 20px 0;
            padding: 15px;
            background: var(--primary-color);
            color: white;
            border-radius: var(--border-radius);
        }
        
        .category-products {
            margin-bottom: 30px;
        }
        
        .category-title {
            font-size: 24px;
            margin-bottom: 15px;
            color: var(--primary-color);
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }
        
        .debug-info {
            display: none;
        }
        
        .category-value-display {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            margin-left: 10px;
            font-weight: normal;
        }
        
        .category-id-display {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            margin-left: 10px;
            font-weight: normal;
        }
    </style>
</head>
<body>
    <!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª -->
    <header class="header">
        <div class="header-content">
            <div class="logo">AZ</div>
            <div class="app-name">AZ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„</div>
            <div class="screen-name">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</div>
            <button class="theme-toggle" id="theme-toggle">ğŸŒ™</button>
            <button class="show-btn" id="show-btn" style="display: none;">Ø¹Ø±Ø¶ Ø§Ù„Ø´Ø±ÙŠØ·</button>
        </div>
    </header>

    <!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø© -->
    <div class="filter-bar" id="filter-bar">
        <div class="filter-item">
            <label for="governorate">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</label>
            <select id="governorate">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>
            </select>
        </div>

        <div class="filter-item">
            <label for="region">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
            <select id="region">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
            </select>
        </div>

        <div class="filter-item">
            <label for="category">Ø§Ù„ÙØ¦Ø©:</label>
            <select id="category">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>
            </select>
            <span class="category-value-display" id="category-value-display"></span>
        </div>

        <div class="filter-item">
            <label for="merchant">Ø§Ù„ØªØ§Ø¬Ø±:</label>
            <select id="merchant">
                <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¬Ø§Ø±</option>
            </select>
        </div>

        <div class="filter-item">
            <label for="search">Ø¨Ø­Ø«:</label>
            <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...">
        </div>

        <div class="filter-item price-range">
            <label for="min-price">Ø§Ù„Ø³Ø¹Ø± Ù…Ù†:</label>
            <input type="number" id="min-price" placeholder="Ø£Ù‚Ù„ Ø³Ø¹Ø±" min="0">
            <label for="max-price">Ø¥Ù„Ù‰:</label>
            <input type="number" id="max-price" placeholder="Ø£Ø¹Ù„Ù‰ Ø³Ø¹Ø±" min="0">
        </div>

        <div class="filter-item sort-options">
            <label for="sort-by">ØªØ±ØªÙŠØ¨:</label>
            <select id="sort-by">
                <option value="date">Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)</option>
                <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
                <option value="category">Ø§Ù„ÙØ¦Ø©</option>
                <option value="price">Ø§Ù„Ø³Ø¹Ø±</option>
                <option value="merchant">Ø§Ù„ØªØ§Ø¬Ø±</option>
            </select>
        </div>

        <button class="reset-btn" id="reset-filters">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
        <button class="hide-btn" id="hide-btn">Ø¥Ø®ÙØ§Ø¡ Ø§Ù„Ø´Ø±ÙŠØ·</button>
    </div>

    <!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
    <div class="page-content">
        <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©</h2>
        
        <div id="products-container">
            <!-- Ø³ÙŠØªÙ… Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù‡Ù†Ø§ -->
            <div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>
        </div>
    </div>

    <!-- Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø«Ø§Ø¨Øª -->
    <footer class="footer">
        Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ Ø§Ù„Ù…Ù…ÙŠØ² Ø³ÙˆÙØª Ù„Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©
    </footer>

    <!-- Modal Ù„Ù„ÙˆØµÙ Ø§Ù„ÙƒØ§Ù…Ù„Ø© -->
    <div class="description-modal" id="descriptionModal">
        <div class="description-modal-content">
            <span class="close-description" onclick="closeDescriptionModal()">&times;</span>
            <h4>Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙƒØ§Ù…Ù„Ø©</h4>
            <div class="description-full-text" id="fullDescription"></div>
        </div>
    </div>

    <script>
        // ØªÙ‡ÙŠØ¦Ø© Firebase
        const firebaseConfig = { 
            databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/" 
        };
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ØªÙ‡ÙŠØ¦Ø© Firebase
        try {
            if (!firebase.apps.length) {
                firebase.initializeApp(firebaseConfig);
            }
        } catch (error) {
            console.error("Ø®Ø·Ø£ ÙÙŠ ØªÙ‡ÙŠØ¦Ø© Firebase:", error);
        }
        
        const db = firebase.database();

        // Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†
        let allProducts = [];
        let allMerchants = [];
        let allGovernorates = [];
        let allRegions = [];
        let allCategories = [];
        let selectedCategoryId = '';
        let currentPage = 1;
        const productsPerPage = 9;
        let favoriteProducts = JSON.parse(localStorage.getItem('favoriteProducts')) || {};
        let currentCommentsProductId = '';
        let userLikes = JSON.parse(localStorage.getItem('userLikes')) || {};

        // Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
        const productsContainer = document.getElementById('products-container');
        const governorateSelect = document.getElementById('governorate');
        const regionSelect = document.getElementById('region');
        const categorySelect = document.getElementById('category');
        const merchantSelect = document.getElementById('merchant');
        const searchInput = document.getElementById('search');
        const minPriceInput = document.getElementById('min-price');
        const maxPriceInput = document.getElementById('max-price');
        const resetButton = document.getElementById('reset-filters');
        const sortSelect = document.getElementById('sort-by');
        const themeToggle = document.getElementById('theme-toggle');
        const descriptionModal = document.getElementById('descriptionModal');
        const fullDescription = document.getElementById('fullDescription');
        const filterBar = document.getElementById('filter-bar');
        const hideBtn = document.getElementById('hide-btn');
        const showBtn = document.getElementById('show-btn');
        const categoryValueDisplay = document.getElementById('category-value-display');

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
        document.addEventListener('DOMContentLoaded', function() {
            console.log("Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ·Ø¨ÙŠÙ‚...");
            
            const savedTheme = localStorage.getItem('theme');
            if (savedTheme === 'dark') {
                document.documentElement.setAttribute('data-theme', 'dark');
                themeToggle.textContent = 'â˜€ï¸';
            }
            
            // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© Ø§Ù„Ø´Ø±ÙŠØ· Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©
            const isFilterBarHidden = localStorage.getItem('filterBarHidden');
            if (isFilterBarHidden === 'true') {
                hideFilterBar();
            }
            
            loadAllData();
            
            // Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
            searchInput.addEventListener('input', filterProducts);
            governorateSelect.addEventListener('change', handleGovernorateChange);
            regionSelect.addEventListener('change', filterProducts);
            categorySelect.addEventListener('change', handleCategoryChange);
            merchantSelect.addEventListener('change', filterProducts);
            minPriceInput.addEventListener('input', filterProducts);
            maxPriceInput.addEventListener('input', filterProducts);
            sortSelect.addEventListener('change', filterProducts);
            resetButton.addEventListener('click', resetFilters);
            themeToggle.addEventListener('click', toggleTheme);
            hideBtn.addEventListener('click', hideFilterBar);
            showBtn.addEventListener('click', showFilterBar);
        });

        // ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø³Ù…Ø©
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            if (currentTheme === 'dark') {
                document.documentElement.removeAttribute('data-theme');
                localStorage.setItem('theme', 'light');
                themeToggle.textContent = 'ğŸŒ™';
            } else {
                document.documentElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                themeToggle.textContent = 'â˜€ï¸';
            }
        }

        // Ø¥Ø®ÙØ§Ø¡ Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø©
        function hideFilterBar() {
            filterBar.style.display = 'none';
            showBtn.style.display = 'flex';
            document.body.style.paddingTop = '70px';
            localStorage.setItem('filterBarHidden', 'true');
        }

        // Ø¥Ø¸Ù‡Ø§Ø± Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø©
        function showFilterBar() {
            filterBar.style.display = 'flex';
            showBtn.style.display = 'none';
            document.body.style.paddingTop = '140px';
            localStorage.setItem('filterBarHidden', 'false');
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        async function loadAllData() {
            try {
                productsContainer.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>';
                
                console.log("Ø¨Ø¯Ø¡ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...");
                
                // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase
                const productsSnap = await db.ref("products").once("value");
                const merchantsSnap = await db.ref("merchants").once("value");
                const governoratesSnap = await db.ref("governorates").once("value");
                const regionsSnap = await db.ref("regions").once("value");
                const categoriesSnap = await db.ref("categories").once("value");
                
                // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ§Øª
                allProducts = convertFirebaseData(productsSnap.val());
                allMerchants = convertFirebaseData(merchantsSnap.val());
                allGovernorates = convertFirebaseData(governoratesSnap.val());
                allRegions = convertFirebaseData(regionsSnap.val());
                allCategories = convertFirebaseData(categoriesSnap.val());
                
                console.log('Ø¹Ø¯Ø¯ Ø§Ù„ÙØ¦Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', allCategories.length);
                console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', allProducts.length);
                console.log('Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ù…Ø­Ù…Ù„Ø©:', allMerchants.length);
                
                // ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©
                populateFilterOptions();
                
                // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
                displayProducts(allProducts);
                
            } catch (error) {
                console.error("Error loading data:", error);
                productsContainer.innerHTML = '<div class="error">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</div>';
            }
        }

        // ØªØ­ÙˆÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª Firebase Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ©
        function convertFirebaseData(firebaseData) {
            if (!firebaseData) {
                console.log("Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Firebase");
                return [];
            }
            
            return Object.entries(firebaseData).map(([id, data]) => {
                return { id, ...data };
            });
        }

        // ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©
        function populateFilterOptions() {
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
            governorateSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>';
            allGovernorates.forEach(governorate => {
                const option = document.createElement('option');
                option.value = governorate.id;
                option.textContent = governorate.name || governorate.id;
                governorateSelect.appendChild(option);
            });
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙØ¦Ø§Øª
            categorySelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>';
            allCategories.forEach(category => {
                const option = document.createElement('option');
                option.value = category.id;
                option.textContent = category.name || category.id;
                categorySelect.appendChild(option);
            });
            
            // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ØªØ¬Ø§Ø± (Ø§Ù„ØªØ¬Ø§Ø± Ø§Ù„Ù†Ø´Ø·ÙŠÙ† ÙÙ‚Ø·)
            merchantSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªØ¬Ø§Ø±</option>';
            allMerchants.forEach(merchant => {
                if (merchant.status === "active") {
                    const option = document.createElement('option');
                    option.value = merchant.id;
                    option.textContent = merchant.name || merchant.username || merchant.id;
                    merchantSelect.appendChild(option);
                }
            });
            
            // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
            updateRegionOptions();
        }

        // ØªØ­Ø¯ÙŠØ« Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ù…Ù†Ø§Ø·Ù‚ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©
        function updateRegionOptions() {
            const selectedGovernorate = governorateSelect.value;
            regionSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>';
            
            if (selectedGovernorate) {
                const governorate = allGovernorates.find(g => g.id === selectedGovernorate);
                if (governorate && governorate.areas) {
                    Object.entries(governorate.areas).forEach(([areaId, areaName]) => {
                        const option = document.createElement('option');
                        option.value = areaId;
                        option.textContent = areaName;
                        regionSelect.appendChild(option);
                    });
                }
            } else {
                allRegions.forEach(region => {
                    const option = document.createElement('option');
                    option.value = region.id;
                    option.textContent = region.name || region.id;
                    regionSelect.appendChild(option);
                });
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©
        function handleGovernorateChange() {
            updateRegionOptions();
            filterProducts();
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© ØªØºÙŠÙŠØ± Ø§Ù„ÙØ¦Ø© Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø©
        function handleCategoryChange() {
            selectedCategoryId = categorySelect.value;
            categoryValueDisplay.textContent = selectedCategoryId ? `ID: ${selectedCategoryId}` : '';
            console.log('Ø§Ù„ÙØ¦Ø© Ø§Ù„Ù…Ø­Ø¯Ø¯Ø©:', selectedCategoryId);
            filterProducts();
        }

        // Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        function displayProducts(products) {
            productsContainer.innerHTML = '';
            
            if (!products || products.length === 0) {
                productsContainer.innerHTML = '<div class="no-products">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
                return;
            }
            
            // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            products.sort((a, b) => {
                const dateA = new Date(a.publishDate || a.createdAt || 0);
                const dateB = new Date(b.publishDate || b.createdAt || 0);
                return dateB - dateA; // ØªØ±ØªÙŠØ¨ ØªÙ†Ø§Ø²Ù„ÙŠ (Ø§Ù„Ø£Ø­Ø¯Ø« Ø£ÙˆÙ„Ø§Ù‹)
            });
            
            // Ø¥Ù†Ø´Ø§Ø¡ Ø¹Ù†ØµØ± grid Ù„Ù„Ù…Ù†ØªØ¬Ø§Øª
            const productsGrid = document.createElement('div');
            productsGrid.className = 'products';
            
            // Ø¹Ø±Ø¶ ÙƒÙ„ Ù…Ù†ØªØ¬
            products.forEach(product => {
                if (!product || !product.userId) return;
                
                const merchant = allMerchants.find(m => m.id === product.userId);
                if (!merchant || merchant.status !== "active") {
                    console.log('ØªØ§Ø¬Ø± ØºÙŠØ± Ù†Ø´Ø· Ø£Ùˆ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:', product.userId);
                    return;
                }
                
                if (product.availability !== "available") {
                    console.log('Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ØªØ§Ø­:', product.id);
                    return;
                }
                
                const merchantName = merchant.name || merchant.username || "ØªØ§Ø¬Ø±";
                const categoryName = product.categoryId ? 
                    (allCategories.find(c => c.id === product.categoryId)?.name || '') : '';
                
                const card = createProductCard(product, merchant, merchantName, categoryName);
                productsGrid.appendChild(card);
            });
            
            productsContainer.appendChild(productsGrid);
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬
        function createProductCard(product, merchant, merchantName, categoryName) {
            const card = document.createElement("div");
            card.className = "card";
            card.id = "card-" + product.id;
            
            // Ø²Ø± Ø§Ù„Ù…ÙØ¶Ù„Ø©
            const favoriteBtn = document.createElement("button");
            favoriteBtn.className = "favorite-btn";
            if (favoriteProducts[product.id]) {
                favoriteBtn.classList.add("active");
            }
            favoriteBtn.innerHTML = "â¤ï¸";
            favoriteBtn.title = "Ø¥Ø¶Ø§ÙØ© Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©";
            favoriteBtn.onclick = (e) => {
                e.stopPropagation();
                toggleFavorite(product.id, favoriteBtn);
            };
            card.appendChild(favoriteBtn);
            
            // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±
            const displayDiv = document.createElement("div");
            displayDiv.className = "images-preview";
            
            let urlsArray = [];
            if (Array.isArray(product.imageUrls)) {
                urlsArray = product.imageUrls;
            } else if (typeof product.imageUrls === "string") {
                urlsArray = product.imageUrls.split(",");
            }
            
            if (urlsArray.length > 0 && urlsArray[0]) {
                const imgContainer = document.createElement("div");
                imgContainer.style.position = "relative";
                
                const img = document.createElement("img");
                img.loading = "lazy";
                img.src = formatDriveUrl(urlsArray[0], true);
                img.alt = product.name || "ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬";
                img.onclick = () => window.open(formatDriveUrl(urlsArray[0], false), '_blank');
                
                imgContainer.appendChild(img);
                displayDiv.appendChild(imgContainer);
            } else {
                // ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ø¥Ø°Ø§ Ù„Ù… ØªÙˆØ¬Ø¯ ØµÙˆØ±Ø©
                const imgContainer = document.createElement("div");
                imgContainer.style.position = "relative";
                
                const img = document.createElement("img");
                img.loading = "lazy";
                img.src = "https://via.placeholder.com/300x200?text=Ù„Ø§+ØªÙˆØ¬Ø¯+ØµÙˆØ±Ø©";
                img.alt = "ØµÙˆØ±Ø© Ø§ÙØªØ±Ø§Ø¶ÙŠØ©";
                img.style.border = "1px dashed #ccc";
                
                imgContainer.appendChild(img);
                displayDiv.appendChild(imgContainer);
            }
            
            card.appendChild(displayDiv);
            
            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
            const infoDiv = document.createElement("div");
            infoDiv.className = "info";
            
            infoDiv.innerHTML = `
                <h3>${product.name || "Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</h3>
            `;
            
            // Ø¥Ø¶Ø§ÙØ© Ø³Ø¹Ø± Ø§Ù„Ù…Ù†ØªØ¬
            if (product.price) {
                const priceDiv = document.createElement("div");
                priceDiv.className = "product-price";
                priceDiv.innerHTML = `
                    <span>${product.price} Ø±ÙŠØ§Ù„</span>
                `;
                infoDiv.appendChild(priceDiv);
            }
            
            // Ø¥Ø¶Ø§ÙØ© Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
            const detailsContainer = document.createElement("div");
            detailsContainer.className = "product-details";
            
            if (product.description) {
                const descItem = document.createElement("div");
                descItem.className = "product-detail-item";
                descItem.innerHTML = `<span class="label">Ø§Ù„ÙˆØµÙ:</span> <span style="text-align: right; direction: rtl; display: block; width: 100%;">${product.description}</span>`;
                detailsContainer.appendChild(descItem);
            }
            
            if (categoryName) {
                const categoryItem = document.createElement("div");
                categoryItem.className = "product-detail-item";
                categoryItem.innerHTML = `<span class="label">Ø§Ù„ÙØ¦Ø©:</span> <span>${categoryName}</span>`;
                detailsContainer.appendChild(categoryItem);
            }
            
            infoDiv.appendChild(detailsContainer);
            
            // Ø¥Ø¶Ø§ÙØ© ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…Ù†ØªØ¬ Ù‚Ø¨Ù„ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø±
            if (product.publishDate) {
                const productDateDiv = document.createElement("div");
                productDateDiv.className = "product-date";
                productDateDiv.innerHTML = `ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±: ${formatDate(product.publishDate)}`;
                infoDiv.appendChild(productDateDiv);
            }
            
            // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±
            const merchantInfoDiv = document.createElement("div");
            merchantInfoDiv.className = "merchant-info";
            merchantInfoDiv.innerHTML = `
                <div class="merchant-name" onclick="openMerchantPage('${merchantName}')">
                    ğŸª ${merchantName}
                </div>
            `;
            infoDiv.appendChild(merchantInfoDiv);
            
            card.appendChild(infoDiv);
            
            // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„
            const iconsDiv = document.createElement("div");
            iconsDiv.className = "icons";
            iconsDiv.innerHTML = `
                <div class="icon like" onclick="handleLike('${product.id}')">ğŸ‘ <span class="like-count">0</span></div>
                <div class="icon views">ğŸ‘ï¸ <span class="view-count">0</span></div>
                <div class="icon comment" onclick="toggleComments('${product.id}')">ğŸ’¬ <span class="comment-count">0</span></div>
                <div class="icon share-btn" onclick="shareProduct('${product.name}', '${formatDriveUrl(urlsArray[0] || '', false)}')">ğŸ“¤</div>
            `;
            
            card.appendChild(iconsDiv);
            
            // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
            loadProductStats(product.id, card);
            
            return card;
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø±Ø§Ø¨Ø· Google Drive
        function formatDriveUrl(url, isThumbnail = true) {
            if (!url) return '';
            
            let id = "";
            if (url.includes("/d/")) id = url.split("/d/")[1].split("/")[0];
            else if (url.includes("id=")) id = new URLSearchParams(url.split("?")[1]).get("id");
            else if (url.includes("drive.usercontent.google.com")) id = new URLSearchParams(url.split("?")[1]).get("id");
            
            if (!id) return url;
            
            if (isThumbnail) {
                return `https://drive.google.com/thumbnail?id=${id}&sz=w400`;
            } else {
                return `https://drive.google.com/uc?export=view&id=${id}`;
            }
        }

        // Ø¯Ø§Ù„Ø© ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
        function filterProducts() {
            const governorateValue = governorateSelect.value;
            const regionValue = regionSelect.value;
            const categoryValue = categorySelect.value;
            const merchantValue = merchantSelect.value;
            const searchValue = searchInput.value.toLowerCase();
            const minPrice = parseFloat(minPriceInput.value) || 0;
            const maxPrice = parseFloat(maxPriceInput.value) || Infinity;
            
            let filteredProducts = allProducts.filter(product => {
                if (!product || !product.userId) return false;
                
                const merchant = allMerchants.find(m => m.id === product.userId);
                if (!merchant || merchant.status !== "active" || product.availability !== "available") {
                    return false;
                }
                
                // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø«
                if (searchValue) {
                    const productName = (product.name || '').toLowerCase();
                    const productDescription = (product.description || '').toLowerCase();
                    if (!productName.includes(searchValue) && !productDescription.includes(searchValue)) {
                        return false;
                    }
                }
                
                // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
                if (categoryValue) {
                    // Ø§Ù„Ø¨Ø­Ø« ÙÙŠ categoryId Ø£ÙˆÙ„Ø§Ù‹
                    if (product.categoryId === categoryValue) {
                        // ØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ categoryId
                    } 
                    // Ø¥Ø°Ø§ Ù„Ù… ÙŠØªØ·Ø§Ø¨Ù‚ Ù…Ø¹ categoryIdØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ category
                    else if (product.category !== categoryValue) {
                        return false;
                    }
                }
                
                // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ØªØ§Ø¬Ø±
                if (merchantValue && product.userId !== merchantValue) {
                    return false;
                }
                
                // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø³Ø¹Ø±
                const productPrice = parseFloat(product.price) || 0;
                if (productPrice < minPrice || productPrice > maxPrice) {
                    return false;
                }
                
                // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø©
                if (governorateValue || regionValue) {
                    if (governorateValue && merchant.governorate !== governorateValue) {
                        return false;
                    }
                    if (regionValue && merchant.area !== regionValue) {
                        return false;
                    }
                }
                
                return true;
            });
            
            console.log('Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØµÙØ§Ø©:', filteredProducts.length);
            
            // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØµÙØ§Ø©
            displayProducts(filteredProducts);
        }

        // Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
        function resetFilters() {
            governorateSelect.value = "";
            regionSelect.value = "";
            categorySelect.value = "";
            merchantSelect.value = "";
            searchInput.value = "";
            minPriceInput.value = "";
            maxPriceInput.value = "";
            sortSelect.value = "date";
            selectedCategoryId = '';
            categoryValueDisplay.textContent = '';
            
            updateRegionOptions();
            displayProducts(allProducts);
        }

        // Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Firebase Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ù…Ù‚Ø±ÙˆØ¡
        function formatDate(dateString) {
            if (!dateString) return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
            
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('ar-EG');
            } catch (e) {
                return dateString;
            }
        }

        // Ø¯Ø§Ù„Ø© ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±
        function openMerchantPage(merchantName) {
            localStorage.setItem('selectedMerchant', merchantName);
            window.open("ard_tagr.html", "_blank");
        }

        // Ø¥Ø¶Ø§ÙØ©/Ø¥Ø²Ø§Ù„Ø© Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©
        function toggleFavorite(pid, button) {
            if (favoriteProducts[pid]) {
                delete favoriteProducts[pid];
                button.classList.remove("active");
            } else {
                favoriteProducts[pid] = true;
                button.classList.add("active");
            }
            
            localStorage.setItem('favoriteProducts', JSON.stringify(favoriteProducts));
        }

        // Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬
        async function loadProductStats(pid, card) {
            try {
                const statsSnap = await db.ref(`products_stats/${pid}`).once("value");
                const stats = statsSnap.val() || {};
                
                const viewCountEl = card.querySelector(".view-count");
                if (viewCountEl) {
                    viewCountEl.textContent = stats.views || 0;
                }
                
                // ØªØ­Ù…ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª
                const likesRef = db.ref(`products_stats/${pid}/likes`);
                const likesSnap = await likesRef.once("value");
                const likesData = likesSnap.val() || [];
                const likeCount = Array.isArray(likesData) ? likesData.length : 0;
                
                const likeCountEl = card.querySelector(".like-count");
                if (likeCountEl) {
                    likeCountEl.textContent = likeCount;
                }
                
            } catch (error) {
                console.error("Error loading product stats:", error);
            }
        }

        // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
        async function handleLike(productId) {
            try {
                const userId = getUserId();
                const likesRef = db.ref(`products_stats/${productId}/likes`);
                
                const likesSnap = await likesRef.once("value");
                let likesData = likesSnap.val() || [];
                
                if (!Array.isArray(likesData)) {
                    likesData = [];
                }
                
                const userIndex = likesData.indexOf(userId);
                
                if (userIndex === -1) {
                    likesData.push(userId);
                } else {
                    likesData.splice(userIndex, 1);
                }
                
                await likesRef.set(likesData);
                
                const likeCountEl = document.querySelector(`#card-${productId} .like-count`);
                if (likeCountEl) {
                    likeCountEl.textContent = likesData.length;
                }
                
            } catch (error) {
                console.error("Error handling like:", error);
            }
        }

        // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù…Ø¹Ø±Ù ÙØ±ÙŠØ¯ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…
        function getUserId() {
            let userId = localStorage.getItem('userId');
            if (!userId) {
                userId = 'user_' + Math.random().toString(36).substr(2, 9);
                localStorage.setItem('userId', userId);
            }
            return userId;
        }

        // Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù†ØªØ¬
        function shareProduct(productName, imageUrl) {
            const shareText = `Ù…ØªØ¬Ø± AZ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„ Ù„ØªÙ„Ø¨ÙŠØ© Ø§Ø­ØªÙŠØ§Ø¬Ùƒ Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ ÙŠØ±Ø­Ø¨ Ø¨Ùƒ\n\nØªÙØ¶Ù„ Ø¨ØªØµÙØ­ ${productName}\n\nØ¹Ø¨Ø± Ø§Ù„Ø±Ø§Ø¨Ø· Ø§Ù„ØªØ§Ù„ÙŠ\n\n${window.location.href}`;
            
            if (navigator.share) {
                navigator.share({
                    title: productName,
                    text: shareText,
                    url: window.location.href
                })
                .then(() => console.log('ØªÙ… Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø¨Ù†Ø¬Ø§Ø­'))
                .catch((error) => console.log('Error sharing:', error));
            } else {
                navigator.clipboard.writeText(shareText)
                    .then(() => alert('ØªÙ… Ù†Ø³Ø® Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©: \n' + shareText))
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        prompt('ÙŠØ±Ø¬Ù‰ Ù†Ø³Ø® Ø§Ù„Ù†Øµ Ø§Ù„ØªØ§Ù„ÙŠ:', shareText);
                    });
            }
        }

        // Ø¥ØºÙ„Ø§Ù‚ modal Ø§Ù„ÙˆØµÙ
        function closeDescriptionModal() {
            descriptionModal.style.display = 'none';
        }

        // ØªØ¨Ø¯ÙŠÙ„ Ø¹Ø±Ø¶/Ø¥Ø®ÙØ§Ø¡ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        function toggleComments(productId) {
            const commentsSection = document.getElementById(`comments-${productId}`);
            if (!commentsSection) return;
            
            const isExpanded = commentsSection.classList.contains('expanded');
            
            document.querySelectorAll('.comments-section.expanded').forEach(section => {
                if (section.id !== `comments-${productId}`) {
                    section.classList.remove('expanded');
                }
            });
            
            if (isExpanded) {
                commentsSection.classList.remove('expanded');
                currentCommentsProductId = '';
            } else {
                commentsSection.classList.add('expanded');
                currentCommentsProductId = productId;
                loadComments(productId);
            }
        }

        // ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        async function loadComments(productId) {
            try {
                const commentsSection = document.getElementById(`comments-${productId}`);
                const commentsList = commentsSection.querySelector('.comments-list');
                const commentsCount = commentsSection.querySelector('.comments-count');
                
                commentsList.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª...</div>';
                
                const commentsSnap = await db.ref(`comments/${productId}`).once("value");
                const comments = convertFirebaseData(commentsSnap.val());
                
                displayComments(comments, commentsList, commentsCount, productId);
            } catch (error) {
                console.error("Error loading comments:", error);
                const commentsList = document.querySelector(`#comments-${productId} .comments-list`);
                if (commentsList) {
                    commentsList.innerHTML = '<div class="error">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª</div>';
                }
            }
        }

        // Ø¹Ø±Ø¶ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
        function displayComments(comments, commentsList, commentsCount, productId) {
            if (!commentsList) return;
            
            commentsList.innerHTML = '';
            
            if (!comments || comments.length === 0) {
                commentsList.innerHTML = '<div class="no-comments">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªØ¹Ù„ÙŠÙ‚Ø§Øª Ø¨Ø¹Ø¯</div>';
                if (commentsCount) {
                    commentsCount.textContent = '0 ØªØ¹Ù„ÙŠÙ‚';
                }
                
                const commentCountEl = document.querySelector(`#card-${productId} .comment-count`);
                if (commentCountEl) {
                    commentCountEl.textContent = '0';
                }
                return;
            }
            
            comments.sort((a, b) => {
                return new Date(b.date || 0) - new Date(a.date || 0);
            });
            
            const commentsLength = comments.length;
            if (commentsCount) {
                commentsCount.textContent = `${commentsLength} ØªØ¹Ù„ÙŠÙ‚`;
            }
            
            const commentCountEl = document.querySelector(`#card-${productId} .comment-count`);
            if (commentCountEl) {
                commentCountEl.textContent = commentsLength;
            }
            
            comments.forEach(comment => {
                const commentItem = document.createElement("div");
                commentItem.className = "comment-item";
                
                commentItem.innerHTML = `
                    <div class="comment-header">
                        <span class="comment-author">${comment.author || "Ù…Ø³ØªØ®Ø¯Ù…"}</span>
                        <span class="comment-date">${formatDate(comment.date)}</span>
                    </div>
                    <div class="comment-text">${comment.text}</div>
                `;
                
                commentsList.appendChild(commentItem);
            });
        }

        // Ø¥Ø¶Ø§ÙØ© ØªØ¹Ù„ÙŠÙ‚ Ø¬Ø¯ÙŠØ¯
        async function addComment(productId, button) {
            const commentForm = button.parentElement;
            const textarea = commentForm.querySelector('textarea');
            const commentTextValue = textarea.value.trim();
            
            if (!commentTextValue) {
                alert("ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© ØªØ¹Ù„ÙŠÙ‚ Ù‚Ø¨Ù„ Ø§Ù„Ù†Ø´Ø±");
                return;
            }
            
            try {
                const commentId = Date.now().toString();
                
                const comment = {
                    text: commentTextValue,
                    author: "Ù…Ø³ØªØ®Ø¯Ù…",
                    date: new Date().toISOString()
                };
            
                await db.ref(`comments/${productId}/${commentId}`).set(comment);
                
                loadComments(productId);
                textarea.value = "";
                
            } catch (error) {
                console.error("Error adding comment:", error);
                alert("Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªØ¹Ù„ÙŠÙ‚");
            }
        }
    </script>
</body>
  </html>
