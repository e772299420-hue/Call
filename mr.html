
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AZ السوق الشامل - الصفحة الرئيسية</title>
    <meta name="description" content="موقع AZ السوق الشامل لعرض وطلب المنتجات والخدمات في جميع أنحاء اليمن.">
    <meta name="keywords" content="السوق الشامل, مروان الذماري ,المميز سوفت ,az السوق الشامل, azالسوق الشامل, AZ السوق الشامل, موقع السوق الشامل, az al souq al shamel, azsouk">
    <meta name="author" content="AZ السوق الشامل">
    
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <meta name="theme-color" content="#2980b9">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="AZ السوق الشامل">
    <link rel="apple-touch-icon" href="https://github.com/e772299420-hue/Call/blob/main/icon-512x512.png?raw=true">
    <link rel="icon" type="image/png" href="https://github.com/e772299420-hue/Call/blob/main/icon-512x512.png?raw=true">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Tahoma", sans-serif;
        }

        body {
            background: #ffffff;
            overflow-x: hidden;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding-top: 140px; /* مساحة للعناصر الثابتة في الأعلى */
        }

        /* شاشة البداية */
        #introScreen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 10;
            overflow: hidden;
            transition: opacity 1s ease, transform 1s ease;
            border-radius: 15px 15px 0 0;
        }

        #introScreen::after {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(120deg, rgba(41, 128, 185, 0.1) 0%, rgba(41, 128, 185, 0.3) 50%, rgba(41, 128, 185, 0.1) 100%);
            animation: shine 2s linear infinite;
        }

        @keyframes shine {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }

        .intro-content {
            position: relative;
            z-index: 10;
            text-align: center;
            color: #2980b9;
            animation: fadeInUp 1.5s ease-out;
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(50px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .intro-logo {
            font-size: 60px;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            from { transform: scale(1); }
            50% { transform: scale(1.05); }
            to { transform: scale(1); }
        }

        .intro-logo i { 
            font-size: 60px; 
            color: #2980b9;
            animation: rotate 3s ease-in-out infinite;
        }

        @keyframes rotate {
            0% { transform: rotateY(0deg); }
            50% { transform: rotateY(180deg); }
            100% { transform: rotateY(360deg); }
        }

        .intro-title { 
            font-size: 36px; 
            margin-top: 15px; 
            animation: slideInFromRight 1.5s ease-out;
            color: #2980b9;
        }

        @keyframes slideInFromRight {
            from { opacity: 0; transform: translateX(100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .intro-subtitle { 
            font-size: 18px; 
            margin-top: 8px; 
            animation: slideInFromLeft 1.5s ease-out;
            color: #666;
        }

        @keyframes slideInFromLeft {
            from { opacity: 0; transform: translateX(-100px); }
            to { opacity: 1; transform: translateX(0); }
        }

        /* الشريط العلوي - ثابت ومثبت في الأعلى */
        .top-bar {
            position: fixed; /* تغيير من relative إلى fixed */
            top: 0;
            left: 0;
            width: 100%;
            height: 60px;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 20px;
            box-shadow: 0 6px 20px rgba(0,0,0,0.1);
            z-index: 1000; /* زيادة z-index */
            border-radius: 0 0 15px 15px;
            animation: slideDown 0.5s ease-out;
            border-bottom: 1px solid #eee;
            transition: all 0.3s ease; /* إضافة انتقال سلس */
        }

        /* تأثير التمرير على الشريط العلوي */
        .top-bar.scrolled {
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            height: 55px; /* تصغير قليل عند التمرير */
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); }
            to { transform: translateY(0); }
        }

        .menu-btn {
            font-size: 28px;
            cursor: pointer;
            color: #2980b9;
            background: none;
            border: none;
            padding: 10px;
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            width: 50px;
            height: 50px;
            border-radius: 10px;
        }

        .menu-btn:hover {
            transform: scale(1.1);
            background: rgba(41, 128, 185, 0.1);
        }

        .site-title {
            font-size: 22px;
            font-weight: bold;
            color: #2980b9;
            text-align: center;
            flex: 1;
            padding: 0 15px;
        }

        .top-icons {
            display: flex;
            gap: 15px;
            font-size: 22px;
            color: #2980b9;
        }

        .top-icons i {
            cursor: pointer;
            padding: 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .top-icons i:hover {
            background: rgba(41, 128, 185, 0.1);
            transform: scale(1.1);
        }

        /* الخلفية المعتمة */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 999;
            display: none;
            backdrop-filter: blur(3px);
        }

        .overlay.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        /* القائمة الجانبية */
        .side-menu {
            position: fixed;
            top: 0;
            right: -350px;
            width: 350px;
            height: 100%;
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            box-shadow: -4px 0 20px rgba(0,0,0,0.2);
            z-index: 1000;
            transition: right 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            display: flex;
            flex-direction: column;
            border-radius: 20px 0 0 20px;
            overflow: hidden;
        }

        .side-menu.open {
            right: 0;
        }

        /* رأس القائمة */
        .menu-header {
            background: linear-gradient(135deg, #2980b9 0%, #1c6ea4 100%);
            color: white;
            padding: 25px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .menu-header-content {
            display: flex;
            align-items: center;
            gap: 15px;
            flex: 1;
        }

        .menu-user-avatar {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: #2980b9;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }

        .menu-user-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .menu-user-info p {
            font-size: 14px;
            opacity: 0.9;
        }

        .close-btn {
            font-size: 24px;
            cursor: pointer;
            background: rgba(255,255,255,0.2);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 10px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(255,255,255,0.3);
            transform: rotate(90deg);
        }

        /* محتوى القائمة */
        .menu-content {
            padding: 20px;
            overflow-y: auto;
            flex: 1;
        }

        .menu-section-title {
            font-size: 15px;
            font-weight: bold;
            margin: 25px 0 12px;
            color: #2980b9;
            padding-right: 10px;
            border-right: 3px solid #2980b9;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .menu-section-title:first-child {
            margin-top: 0;
        }

        /* تصميم جديد لعناصر القائمة مع الصور */
        .menu-item {
            padding: 12px 15px;
            border-radius: 12px;
            cursor: pointer;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            background: white;
            border: 1px solid #eee;
            color: #333;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .menu-item:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: translateX(-5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
            border-color: #2980b9;
        }

        .menu-item i {
            font-size: 20px;
            width: 24px;
            text-align: center;
            color: #2980b9;
        }

        /* صورة القائمة الجديدة - تم تحسينها */
        .menu-item-image {
            width: 45px;
            height: 45px;
            border-radius: 10px;
            object-fit: cover; /* تغيير من contain إلى cover */
            object-position: center; /* ضبط موضع الصورة */
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            flex-shrink: 0;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        }

        .menu-item:hover .menu-item-image {
            border-color: #2980b9;
            transform: scale(1.05);
            box-shadow: 0 4px 8px rgba(41, 128, 185, 0.2);
        }

        .menu-item-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .menu-item-title {
            font-size: 15px;
            font-weight: 600;
            color: #2c3e50;
            line-height: 1.3;
        }

        .menu-item-description {
            font-size: 12px;
            color: #7f8c8d;
            line-height: 1.3;
        }

        .menu-item.active {
            background: linear-gradient(135deg, #2980b9 0%, #1c6ea4 100%);
            color: white;
            border-color: #2980b9;
        }

        .menu-item.active i {
            color: white;
        }

        .menu-item.active .menu-item-title {
            color: white;
        }

        .menu-item.active .menu-item-description {
            color: rgba(255, 255, 255, 0.8);
        }

        .menu-item.active .menu-item-image {
            border-color: white;
        }

        .menu-item.logout {
            color: #e74c3c;
            border-color: #ffeaea;
        }

        .menu-item.logout i {
            color: #e74c3c;
        }

        .menu-item.logout:hover {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%);
            border-color: #e74c3c;
        }

        .menu-item.install {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
            border: none;
        }

        .menu-item.install i {
            color: white;
        }

        .menu-item.install:hover {
            background: linear-gradient(135deg, #219653 0%, #27ae60 100%);
            transform: translateX(-5px);
        }

        /* بيانات التاجر */
        .merchant-data {
            background: linear-gradient(135deg, #fff3e0 0%, #ffe0b2 100%);
            border: 2px solid #ff9800;
            border-radius: 15px;
            padding: 20px;
            margin: 20px 0;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        }

        .merchant-data-title {
            font-size: 16px;
            font-weight: bold;
            color: #e65100;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .merchant-info {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .merchant-info-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #ffcc80;
        }

        .merchant-info-item:last-child {
            border-bottom: none;
        }

        .merchant-label {
            font-weight: bold;
            color: #555;
        }

        .merchant-value {
            color: #2980b9;
            font-weight: 500;
        }

        /* شريط تسجيل الدخول */
        .login-bar {
            background: #f8f9fa;
            padding: 8px 15px;
            display: none;
            justify-content: center;
            align-items: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 99;
            width: 100%;
            max-width: 1000px;
            border-radius: 12px;
            margin: 8px auto;
            transition: all 0.5s ease;
            position: relative;
            border: 1px solid #eee;
        }

        .login-bar-btn {
            background: linear-gradient(135deg, #2980b9 0%, #1c6ea4 100%);
            border: none;
            color: white;
            padding: 8px 16px;
            cursor: pointer;
            border-radius: 50px;
            font-size: 14px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: bold;
            box-shadow: 0 3px 8px rgba(41, 128, 185, 0.3);
        }

        .login-bar-btn:hover {
            background: linear-gradient(135deg, #1c6ea4 0%, #2980b9 100%);
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(41, 128, 185, 0.4);
        }

        /* حاوية البانر والأزرار الثابتة */
        .sticky-header-container {
            position: fixed;
            top: 60px; /* أسفل الشريط العلوي مباشرة */
            left: 0;
            width: 100%;
            z-index: 900;
            background: white;
            padding: 0;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        /* شاشة العرض - التعديلات الجديدة */
        #content-area {
            width: 100%;
            height: calc(100vh - 250px); /* تم تعديل الارتفاع */
            display: flex;
            justify-content: center;
            align-items: stretch;
            transition: all 0.5s ease;
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            margin: 10px;
            margin-top: 180px; /* مساحة للعناصر الثابتة */
            margin-bottom: 20px; /* تم تقليل margin-bottom لإفساح مجال أكبر */
            
            background: transparent;
            border: 5px solid #ffffff;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            box-sizing: border-box;
            
            flex-grow: 1;
        }

        .iframe-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            border-radius: 10px;
            background: transparent;
        }

        #content-area iframe {
            width: 100%;
            height: 100%;
            border: none;
            animation: fadeInContent 0.8s ease-out;
            border-radius: 10px;
            display: block;
            background: transparent;
            overflow: auto;
        }

        .welcome-image-container {
            width: 100%;
            height: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 15px;
            overflow: hidden;
            background: transparent;
        }

        .welcome-image {
            max-width: 100%;
            max-height: 100%;
            object-fit: contain;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            animation: imageEntrance 1.5s ease-out forwards;
        }

        @keyframes imageEntrance {
            0% {
                opacity: 0;
                transform: translateY(-100px) scale(0.8);
            }
            60% {
                opacity: 1;
                transform: translateY(20px) scale(1.05);
            }
            80% {
                transform: translateY(-10px) scale(1.02);
            }
            100% {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        @keyframes fadeInContent {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* إعدادات النظام */
        .settings-box {
            padding: 25px;
            text-align: center;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            max-width: 450px;
            width: 90%;
            animation: fadeInUp 0.8s ease-out;
        }
        
        .settings-box h2 {
            margin-bottom: 20px;
            color: #333;
            font-size: 22px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .settings-box label {
            display: block;
            margin: 12px 0 6px;
            font-weight: bold;
            color: #555;
            text-align: right;
        }
        
        .settings-box input {
            padding: 10px 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            width: 80%;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .settings-box input:focus {
            border-color: #6a11cb;
            outline: none;
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2);
        }
        
        .settings-box button {
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
            margin-top: 15px;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        
        .settings-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(106, 17, 203, 0.4);
        }

        /* رسالة الصفحة قيد التجهيز */
        .coming-soon {
            text-align: center;
            padding: 40px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            animation: fadeInUp 0.8s ease-out;
        }
        
        .coming-soon h2 {
            color: #ff9800;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 24px;
        }
        
        .coming-soon p {
            color: #666;
            font-size: 16px;
        }

        /* التذييل - تم تعديله ليكون أقل ارتفاعاً */
        .footer {
            background: linear-gradient(135deg, #2980b9 0%, #1c6ea4 100%);
            color: white;
            text-align: center;
            padding: 10px 12px; /* تم تقليل padding */
            font-weight: bold;
            z-index: 90;
            position: relative;
            bottom: 0;
            left: 0;
            width: 100%;
            border-top: 2px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 -3px 15px rgba(0, 0, 0, 0.2);
            margin-top: auto;
            font-size: 14px; /* تصغير حجم الخط */
            min-height: 50px; /* تحديد ارتفاع ثابت */
        }

        /* تأثيرات التمرير */
        .fade-in {
            opacity: 0;
            transform: translateY(20px);
            transition: opacity 0.8s ease, transform 0.8s ease;
        }
        
        .fade-in.visible {
            opacity: 1;
            transform: translateY(0);
        }

        /* شاشة الحظر */
        .blocked-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(231, 76, 60, 0.95);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(15px);
        }

        .blocked-overlay.show {
            display: flex;
            animation: blockOverlayShow 1s ease-out;
        }

        .blocked-container {
            background: white;
            border-radius: 25px;
            padding: 50px;
            text-align: center;
            max-width: 550px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0,0,0,0.4);
            animation: blockModalSlideIn 1s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 3px solid #e74c3c;
            font-size: 18px;
        }

        .blocked-icon {
            font-size: 100px;
            color: #e74c3c;
            margin-bottom: 25px;
            animation: shake 1.5s infinite;
            text-shadow: 0 4px 8px rgba(231, 76, 60, 0.3);
        }

        .blocked-title {
            font-size: 36px;
            color: #e74c3c;
            margin-bottom: 20px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .blocked-message {
            font-size: 22px;
            color: #666;
            margin-bottom: 25px;
            line-height: 1.8;
        }

        .blocked-reason {
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border: 2px solid #e74c3c;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            color: #d32f2f;
            font-weight: bold;
            font-size: 20px;
        }

        .blocked-contact {
            font-size: 20px;
            color: #333;
            margin-bottom: 25px;
        }

        .blocked-phone {
            font-size: 26px;
            color: #27ae60;
            font-weight: bold;
            margin: 15px 0;
            text-shadow: 0 2px 4px rgba(39, 174, 96, 0.3);
        }

        @keyframes blockOverlayShow {
            from { opacity: 0; transform: scale(0.5); }
            to { opacity: 1; transform: scale(1); }
        }

        @keyframes blockModalSlideIn {
            from { opacity: 0; transform: scale(0.3) rotate(-20deg); }
            to { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-10px); }
            20%, 40%, 60%, 80% { transform: translateX(10px); }
        }

        /* زر تثبيت PWA */
        .pwa-install-btn {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1000;
            background: #2980b9;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            box-shadow: 0 4px 12px rgba(41, 128, 185, 0.4);
            display: none;
            animation: btnEntrance 0.8s ease-out;
        }

        @keyframes btnEntrance {
            0% { opacity: 0; transform: scale(0) rotate(180deg); }
            50% { opacity: 0.7; transform: scale(1.1) rotate(90deg); }
            100% { opacity: 1; transform: scale(1) rotate(0deg); }
        }

        /* نافذة اختيار التثبيت */
        .install-choice-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.6s ease;
        }

        .install-choice-modal.show {
            display: flex;
        }

        .install-choice-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            position: relative;
            animation: modalSlideIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid rgba(52, 152, 219, 0.3);
            text-align: center;
        }

        .install-choice-header {
            margin-bottom: 25px;
        }

        .install-choice-header i {
            font-size: 60px;
            color: #2980b9;
            margin-bottom: 15px;
        }

        .install-choice-title {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .install-choice-subtitle {
            font-size: 18px;
            color: #666;
            margin-bottom: 25px;
        }

        .install-choice-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .install-choice-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            padding: 15px 20px;
            border: none;
            border-radius: 12px;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .install-choice-btn.download {
            background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
            color: white;
        }

        .install-choice-btn.install {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
            color: white;
        }

        .install-choice-btn.share {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
            color: white;
        }

        .install-choice-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.2);
        }

        .install-choice-cancel {
            background: transparent;
            color: #666;
            border: 1px solid #ddd;
            padding: 10px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .install-choice-cancel:hover {
            background: #f5f5f5;
        }

        @keyframes modalSlideIn {
            from { opacity: 0; transform: translateY(-100px) scale(0.5) rotate(-10deg); }
            to { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
        }

        /* نافذة المشاركة */
        .share-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
            backdrop-filter: blur(10px);
            animation: fadeIn 0.6s ease;
        }

        .share-modal.show {
            display: flex;
        }

        .share-container {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border-radius: 20px;
            padding: 30px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.4);
            position: relative;
            animation: modalSlideIn 0.8s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            border: 2px solid rgba(52, 152, 219, 0.3);
            text-align: center;
        }

        .share-header {
            margin-bottom: 25px;
        }

        .share-header i {
            font-size: 60px;
            color: #2980b9;
            margin-bottom: 15px;
        }

        .share-title {
            font-size: 28px;
            color: #2c3e50;
            margin-bottom: 10px;
            font-weight: bold;
        }

        .share-subtitle {
            font-size: 18px;
            color: #666;
            margin-bottom: 25px;
        }

        .share-section {
            text-align: center;
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 15px;
            border: 2px solid #2980b9;
        }

        .qr-code {
            margin: 15px auto;
            padding: 15px;
            background: white;
            border-radius: 10px;
            display: inline-block;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .qr-code img {
            width: 180px;
            height: 180px;
            display: block;
            margin: 0 auto;
            border: 2px solid #ddd;
            border-radius: 8px;
        }

        .share-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-top: 20px;
        }

        .share-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            padding: 12px 15px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s ease;
            color: white;
            font-size: 16px;
        }

        .share-btn.whatsapp {
            background: linear-gradient(135deg, #25D366 0%, #128C7E 100%);
        }

        .share-btn.telegram {
            background: linear-gradient(135deg, #0088cc 0%, #005999 100%);
        }

        .share-btn.link {
            background: linear-gradient(135deg, #2980b9 0%, #3498db 100%);
        }

        .share-btn.email {
            background: linear-gradient(135deg, #EA4335 0%, #D14836 100%);
        }

        .share-btn.sms {
            background: linear-gradient(135deg, #34B7F1 0%, #0099CC 100%);
        }

        .share-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
        }

        .share-note {
            margin-top: 20px;
            padding: 15px;
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            border-radius: 10px;
            border: 2px solid #27ae60;
            font-size: 16px;
            color: #2e7d32;
            font-weight: bold;
        }

        .modal-close-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            background: none;
            border: none;
            font-size: 2rem;
            color: #666;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close-btn:hover {
            color: #000;
            transform: rotate(90deg) scale(1.1);
            background: rgba(255,0,0,0.1);
        }

        /* ========== تنسيقات البانر الرئيسي الجديد ========== */
        .main-banner-container {
            position: relative;
            width: 100%;
            margin: 0;
            overflow: hidden;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
            z-index: 98;
            height: 220px;
            border: 2px solid #ffffff;
            animation: fadeIn 1s ease-out;
        }

        .banner-image {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain; /* تغيير من cover إلى contain لعرض الصورة كاملة */
            object-position: center; /* توسيط الصورة */
            z-index: 1;
            transition: opacity 0.8s ease-in-out;
            animation: zoomIn 8s ease-in-out infinite alternate;
            background-color: white; /* إضافة خلفية بيضاء للصور */
        }

        .banner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(to bottom, rgba(0,0,0,0.1), rgba(0,0,0,0.3));
            z-index: 2;
        }

        .banner-content {
            position: relative;
            z-index: 3;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            text-align: center;
            padding: 20px;
            animation: fadeInUp 1s ease-out;
            max-width: 80%;
            margin: 0 auto;
        }

        .banner-content h2 {
            margin: 0;
            font-size: 28px;
            font-weight: 700;
            color: white;
            margin-bottom: 10px;
        }

        .banner-content p {
            margin: 0;
            font-size: 18px;
            opacity: 0.9;
            line-height: 1.4;
            color: #f0f0f0;
        }

        @keyframes zoomIn {
            0% {
                transform: scale(1);
            }
            100% {
                transform: scale(1.05);
            }
        }

        /* ========== شريط الأزرار للسحب الأفقي أسفل البانر ========== */
        /* شريط الأزرار - معدل للسحب الأفقي */
        .navbar {
            display: flex;
            background: #ffffff;
            padding: 8px 10px; /* زيادة padding قليلاً */
            gap: 0;
            justify-content: flex-start;
            overflow-x: auto;
            overflow-y: hidden;
            white-space: nowrap;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            animation: fadeIn 0.5s ease-out;
            border-radius: 12px;
            margin: 5px auto; /* تصغير الهوامش */
            position: relative;
            z-index: 97;
            height: 65px; /* زيادة الارتفاع قليلاً */
            align-items: center;
            cursor: grab;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            max-width: 98%; /* زيادة العرض الأقصى */
            width: 100%;
            border: 1px solid #eee;
        }

        /* إخفاء شريط التمرير */
        .navbar::-webkit-scrollbar {
            display: none;
        }

        .navbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        /* مؤشر السحب */
        .navbar::after {
            content: '';
            position: absolute;
            bottom: 2px;
            right: 50%;
            transform: translateX(50%);
            width: 40px;
            height: 4px;
            background: rgba(41, 128, 185, 0.3);
            border-radius: 2px;
            transition: all 0.3s ease;
        }

        .navbar.dragging {
            cursor: grabbing;
            scroll-behavior: auto;
        }

        .navbar.dragging::after {
            background: #2980b9;
            width: 60px;
        }

        .navbar-container {
            display: flex;
            gap: 10px; /* زيادة الفجوة بين الأزرار */
            padding: 0 5px;
            height: 100%;
            align-items: center;
        }

        /* ========== تنسيقات جديدة محسنة للأزرار ========== */
        /* تصميم جديد كلياً للأزرار مع الصورة في أقصى اليسار */
        .navbar button {
            background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
            border: 2px solid #e9ecef;
            color: #333;
            padding: 8px 12px; /* زيادة padding */
            cursor: pointer;
            border-radius: 10px;
            font-size: 13px; /* زيادة حجم الخط قليلاً */
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            flex-direction: row;
            align-items: center;
            justify-content: flex-start; /* محاذاة المحتوى لليمين */
            gap: 10px; /* زيادة الفجوة بين العناصر */
            font-weight: bold;
            min-width: 140px; /* تقليل العرض قليلاً */
            height: 52px; /* زيادة الارتفاع قليلاً */
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            text-align: right;
            margin: 0;
        }

        /* الصورة - في أقصى اليسار (بداية الزر) */
        .navbar-button-image {
            width: 32px; /* زيادة حجم الصورة قليلاً */
            height: 32px; /* زيادة حجم الصورة قليلاً */
            object-fit: contain;
            border-radius: 6px;
            border: 2px solid #e9ecef;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            flex-shrink: 0;
            order: 1; /* الصورة في البداية (اليسار) */
        }

        /* حاوية النصوص - تأخذ المساحة المتبقية */
        .navbar-text-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end; /* محاذاة لليمين */
            justify-content: center;
            flex: 1;
            overflow: hidden;
            text-align: right;
            order: 2; /* النصوص بعد الصورة */
            gap: 3px; /* زيادة الفجوة بين العنوان والوصف */
        }

        /* العنوان - بخط عريض أسود */
        .navbar-button-title {
            font-size: 12px; /* زيادة حجم الخط */
            line-height: 1.2;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #000000 !important; /* خط أسود */
            font-weight: 800 !important; /* خط عريض جداً */
            text-align: right;
            width: 100%;
        }

        /* الوصف - بخط أحمر */
        .navbar-button-description {
            font-size: 10px; /* زيادة حجم الخط */
            line-height: 1.2;
            max-width: 100%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            color: #ff0000 !important; /* خط أحمر */
            text-align: right;
            width: 100%;
            font-weight: 500;
        }

        /* تأثيرات التحويم */
        .navbar button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(41, 128, 185, 0.1) 0%, transparent 100%);
            opacity: 0;
            transition: opacity 0.3s;
        }

        .navbar button:hover {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.15);
            border-color: #2980b9;
        }

        .navbar button:hover::before {
            opacity: 1;
        }

        .navbar button:hover .navbar-button-image {
            border-color: #2980b9;
            transform: scale(1.1);
        }

        /* الزر النشط */
        .navbar button.active {
            background: linear-gradient(135deg, #2980b9 0%, #1c6ea4 100%);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 5px 12px rgba(0,0,0,0.15);
            border-color: #1c6ea4;
        }

        .navbar button.active .navbar-button-image {
            border-color: white;
        }

        .navbar button.active .navbar-button-title {
            color: white !important;
        }

        .navbar button.active .navbar-button-description {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* زر الدم الخاص - تصميم مميز */
        .blood-donation-button {
            background: linear-gradient(135deg, #ffebee 0%, #ffcdd2 100%) !important;
            border-color: #ff5252 !important;
        }

        .blood-donation-button .navbar-button-title {
            color: #000000 !important; /* خط أسود حتى في زر الدم */
            font-weight: 800 !important;
        }

        .blood-donation-button .navbar-button-description {
            color: #ff0000 !important; /* خط أحمر */
        }

        .blood-donation-button:hover {
            background: linear-gradient(135deg, #ffcdd2 0%, #ef9a9a 100%) !important;
            border-color: #ff1744 !important;
        }

        .blood-donation-button.active {
            background: linear-gradient(135deg, #d32f2f 0%, #b71c1c 100%) !important;
            border-color: #b71c1c !important;
        }

        .blood-donation-button.active .navbar-button-title {
            color: white !important;
        }

        .blood-donation-button.active .navbar-button-description {
            color: rgba(255, 255, 255, 0.9) !important;
        }

        /* ========== نهاية تنسيقات شريط الأزرار ========== */

        /* تحسينات للشاشات الصغيرة */
        @media (max-width: 768px) {
            body {
                padding-top: 120px; /* تقليل المساحة للشاشات الصغيرة */
            }
            
            .sticky-header-container {
                top: 50px; /* تقليل المسافة للشاشات الصغيرة */
            }
            
            .top-bar {
                height: 50px;
                padding: 0 10px;
            }
            
            .top-bar.scrolled {
                height: 48px; /* تصغير أكثر للشاشات الصغيرة */
            }
            
            .menu-btn {
                font-size: 24px;
                width: 45px;
                height: 45px;
            }
            
            .site-title {
                font-size: 18px;
                padding: 0 10px;
            }
            
            .top-icons {
                gap: 10px;
                font-size: 20px;
            }
            
            .side-menu {
                width: 300px;
                right: -300px;
            }
            
            .menu-header {
                padding: 20px 15px;
            }
            
            .menu-user-avatar {
                width: 50px;
                height: 50px;
                font-size: 24px;
            }
            
            .menu-user-info h3 {
                font-size: 16px;
            }
            
            .menu-content {
                padding: 15px;
            }
            
            .menu-item {
                padding: 10px 12px;
                font-size: 15px;
            }
            
            .menu-item-image {
                width: 40px;
                height: 40px;
            }
            
            .menu-item-title {
                font-size: 14px;
            }
            
            .menu-item-description {
                font-size: 11px;
            }
            
            .main-banner-container {
                height: 180px;
                border-radius: 10px;
                margin: 0;
            }
            
            .banner-content h2 {
                font-size: 22px;
            }
            
            .banner-content p {
                font-size: 16px;
            }
            
            .navbar {
                height: 60px;
                margin: 5px auto;
                padding: 6px 8px;
                max-width: 98%;
            }
            
            .navbar button {
                padding: 6px 10px;
                font-size: 12px;
                height: 50px;
                min-width: 130px;
                gap: 8px;
            }
            
            .navbar-button-image {
                width: 30px;
                height: 30px;
            }
            
            .navbar-button-title {
                font-size: 11px;
                font-weight: 800 !important;
                color: #000000 !important;
            }
            
            .navbar-button-description {
                font-size: 9px;
                color: #ff0000 !important;
            }
            
            #content-area {
                height: calc(100vh - 230px); /* تعديل الارتفاع للشاشات الصغيرة */
                margin: 8px;
                border-width: 4px;
                margin-top: 150px; /* تعديل للمساحة */
                margin-bottom: 20px; /* تقليل margin-bottom */
            }

            .login-bar {
                padding: 6px 12px;
                max-width: 95%;
                margin: 6px auto;
            }
            
            .login-bar-btn {
                padding: 6px 12px;
                font-size: 13px;
            }
            
            .intro-logo {
                font-size: 45px;
            }
            
            .intro-logo i {
                font-size: 45px;
            }
            
            .intro-title {
                font-size: 28px;
            }
            
            .intro-subtitle {
                font-size: 16px;
            }
            
            .settings-box {
                padding: 20px;
            }
            
            .settings-box input {
                width: 95%;
            }

            .share-buttons {
                grid-template-columns: 1fr;
            }

            .qr-code img {
                width: 150px;
                height: 150px;
            }

            .pwa-install-btn {
                top: 10px;
                left: 10px;
                padding: 8px 12px;
                font-size: 14px;
            }
            
            .footer {
                padding: 8px 10px;
                font-size: 13px;
                min-height: 45px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding-top: 100px; /* تقليل أكثر للشاشات الصغيرة جداً */
            }
            
            .sticky-header-container {
                top: 45px;
            }
            
            .top-bar {
                height: 45px;
                padding: 0 8px;
            }
            
            .top-bar.scrolled {
                height: 42px;
            }
            
            .menu-btn {
                font-size: 22px;
                width: 40px;
                height: 40px;
            }
            
            .site-title {
                font-size: 16px;
            }
            
            .top-icons {
                gap: 8px;
                font-size: 18px;
            }
            
            .side-menu {
                width: 280px;
                right: -280px;
            }
            
            .menu-header {
                padding: 15px 12px;
            }
            
            .menu-user-avatar {
                width: 45px;
                height: 45px;
                font-size: 22px;
            }
            
            .menu-content {
                padding: 12px;
            }
            
            .menu-item {
                padding: 8px 10px;
                font-size: 14px;
                gap: 10px;
            }
            
            .menu-item-image {
                width: 35px;
                height: 35px;
            }
            
            .menu-item-title {
                font-size: 13px;
            }
            
            .menu-item-description {
                font-size: 10px;
            }
            
            .merchant-data {
                padding: 15px;
            }
            
            .main-banner-container {
                height: 150px;
                border-radius: 8px;
                margin: 0;
            }
            
            .banner-content h2 {
                font-size: 20px;
            }
            
            .banner-content p {
                font-size: 14px;
            }
            
            .navbar {
                height: 55px;
                margin: 4px auto;
                padding: 5px 6px;
                max-width: 98%;
            }
            
            .navbar button {
                font-size: 11px;
                padding: 5px 8px;
                height: 48px;
                min-width: 120px;
                gap: 6px;
            }
            
            .navbar-button-image {
                width: 28px;
                height: 28px;
            }
            
            .navbar-button-title {
                font-size: 10px;
                font-weight: 800 !important;
                color: #000000 !important;
            }
            
            .navbar-button-description {
                font-size: 8px;
                color: #ff0000 !important;
            }
            
            #content-area {
                height: calc(100vh - 200px); /* تعديل الارتفاع للشاشات الصغيرة جداً */
                margin: 5px;
                border-width: 3px;
                margin-top: 130px;
                margin-bottom: 15px; /* تقليل margin-bottom */
            }

            .login-bar {
                padding: 5px 10px;
                margin: 5px auto;
            }
            
            .login-bar-btn {
                padding: 5px 10px;
                font-size: 12px;
            }

            .share-buttons {
                grid-template-columns: 1fr;
            }

            .qr-code img {
                width: 130px;
                height: 130px;
            }

            .pwa-install-btn {
                top: 5px;
                left: 5px;
                padding: 6px 10px;
                font-size: 12px;
            }
            
            .footer {
                padding: 6px 8px;
                font-size: 12px;
                min-height: 40px;
            }
        }
    </style>
</head>
<body>

    <!-- زر تثبيت PWA -->
    <button class="pwa-install-btn" id="pwaInstallBtn">
        <i class="fas fa-download"></i> تثبيت التطبيق
    </button>

    <!-- نافذة اختيار التثبيت -->
    <div class="install-choice-modal" id="installChoiceModal">
        <div class="install-choice-container">
            <button class="modal-close-btn" id="closeInstallChoice">
                <i class="fas fa-times"></i>
            </button>
            <div class="install-choice-header">
                <i class="fas fa-mobile-alt"></i>
                <h2 class="install-choice-title">تثبيت تطبيق AZ</h2>
                <p class="install-choice-subtitle">اختر الطريقة التي تفضلها لتثبيت التطبيق</p>
            </div>
            
            <div class="install-choice-buttons">
                <button class="install-choice-btn download" id="downloadAppBtn">
                    <i class="fas fa-download"></i>
                    <span>تحميل التطبيق</span>
                </button>
                <button class="install-choice-btn install" id="installAppBtn">
                    <i class="fas fa-mobile-alt"></i>
                    <span>تثبيت التطبيق</span>
                </button>
                <button class="install-choice-btn share" id="shareAppBtn">
                    <i class="fas fa-share-alt"></i>
                    <span>مشاركة التطبيق</span>
                </button>
            </div>
            
            <button class="install-choice-cancel" id="cancelInstallBtn">إلغاء</button>
        </div>
    </div>

    <!-- نافذة المشاركة -->
    <div class="share-modal" id="shareModal">
        <div class="share-container">
            <button class="modal-close-btn" id="closeShareModal">
                <i class="fas fa-times"></i>
            </button>
            <div class="share-header">
                <i class="fas fa-share-alt"></i>
                <h2 class="share-title">مشاركة تطبيق AZ</h2>
                <p class="share-subtitle">شارك التطبيق مع أصدقائك وعائلتك</p>
            </div>
            
            <div class="share-section">
                <div class="qr-code">
                    <img src="https://api.qrserver.com/v1/create-qr-code/?size=180x180&data=https://e772299420-hue.github.io/Call/" 
                         alt="QR Code للتطبيق">
                    <p>📱 مسح الكود لفتح التطبيق</p>
                </div>
                
                <div class="share-buttons">
                    <button class="share-btn whatsapp" onclick="shareOnWhatsApp()">
                        <i class="fab fa-whatsapp"></i>
                        واتساب
                    </button>
                    <button class="share-btn telegram" onclick="shareOnTelegram()">
                        <i class="fab fa-telegram"></i>
                        تليجرام
                    </button>
                    <button class="share-btn link" onclick="copyAppLink()">
                        <i class="fas fa-link"></i>
                        نسخ الرابط
                    </button>
                    <button class="share-btn email" onclick="shareViaEmail()">
                        <i class="fas fa-envelope"></i>
                        إرسال بريد
                    </button>
                    <button class="share-btn sms" onclick="shareViaSMS()">
                        <i class="fas fa-sms"></i>
                        رسالة نصية
                    </button>
                </div>
                
                <div class="share-note">
                    <i class="fas fa-info-circle"></i>
                    رابط التطبيق: https://e772299420-hue.github.io/Call/
                </div>
            </div>
            
            <button class="install-choice-cancel" onclick="closeShareModal()">إغلاق</button>
        </div>
    </div>

    <!-- شاشة الحظر -->
    <div class="blocked-overlay" id="blockedOverlay">
        <div class="blocked-container">
            <div class="blocked-icon">
                <i class="fas fa-ban"></i>
            </div>
            <h2 class="blocked-title">تم حظر الوصول</h2>
            <p class="blocked-message">
                عذراً، تم منعك من الوصول إلى هذا الموقع
            </p>
            <div class="blocked-reason" id="blockedReason">
                سبب الحظر: مخالفة شروط الاستخدام
            </div>
            <div class="blocked-contact">
                للاستفسار أو رفع الحظر، يرجى التواصل معنا:
                <div class="blocked-phone">📞 772299420</div>
            </div>
        </div>
    </div>

    <!-- الشريط العلوي - تم إضافة id topBar -->
    <div class="top-bar" id="topBar">
        <button class="menu-btn" onclick="openSideMenu()">
            <i class="fas fa-bars"></i>
        </button>
        <div class="site-title">AZ السوق الشامل</div>
        <div class="top-icons">
            <i class="fas fa-search" onclick="openSearch()"></i>
            <i class="fas fa-shopping-cart" onclick="openCart()"></i>
            <i class="fas fa-user" onclick="openUserProfile()"></i>
        </div>
    </div>

    <!-- الخلفية المعتمة -->
    <div class="overlay" onclick="closeSideMenu()"></div>

    <!-- القائمة الجانبية -->
    <div class="side-menu" id="sideMenu">
        <div class="menu-header">
            <div class="menu-header-content">
                <div class="menu-user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="menu-user-info">
                    <h3 id="menuUserName">زائر</h3>
                    <p id="menuUserStatus">غير مسجل دخول</p>
                </div>
            </div>
            <div class="close-btn" onclick="closeSideMenu()">
                <i class="fas fa-times"></i>
            </div>
        </div>

        <div class="menu-content">
            <div class="merchant-data" id="merchantDataSection" style="display: none;">
                <div class="merchant-data-title">
                    <i class="fas fa-store"></i>
                    بيانات التاجر
                </div>
                <div class="merchant-info">
                    <div class="merchant-info-item">
                        <span class="merchant-label">اسم التاجر:</span>
                        <span class="merchant-value" id="merchantNameValue">-</span>
                    </div>
                    <div class="merchant-info-item">
                        <span class="merchant-label">رقم الجوال:</span>
                        <span class="merchant-value" id="merchantPhoneValue">-</span>
                    </div>
                    <div class="merchant-info-item">
                        <span class="merchant-label">معرف التاجر:</span>
                        <span class="merchant-value" id="merchantIdValue">-</span>
                    </div>
                </div>
            </div>

            <div class="menu-section-title">
                <i class="fas fa-th-large"></i>
                الأقسام الرئيسية
            </div>
            
            <!-- المنتجات التجارية الجديدة - رابط محسن -->
            <div class="menu-item" onclick="openEcommercePage('1_1.html', 'قسم المنتجات التجارية الجديدة')">
                <img src="https://drive.google.com/thumbnail?id=1wAn2GWZxxv6d0mY-cLSV3oryNt1QZaCR&sz=w200"
                     alt="منتجات تجارية" 
                     class="menu-item-image"
                     onerror="this.src='https://via.placeholder.com/45x45/2980b9/ffffff?text=AZ'">
                <div class="menu-item-content">
                    <div class="menu-item-title">قسم المنتجات التجارية الجديدة</div>
                    <div class="menu-item-description">منتجات جديدة بجودة عالية وأسعار منافسة</div>
                </div>
            </div>
            
            <!-- المنتجات المستعملة - الحراج - رابط محسن -->
            <div class="menu-item" onclick="openEcommercePage('1_2.html', 'قسم المنتجات المستعملة - الحراج')">
                <img src="https://drive.google.com/thumbnail?id=1AUf5d-XQCKqGjw_kXN3cJFuepsKyEEkc&sz=w200"
                     alt="منتجات مستعملة" 
                     class="menu-item-image"
                     onerror="this.src='https://via.placeholder.com/45x45/2ecc71/ffffff?text=AZ'">
                <div class="menu-item-content">
                    <div class="menu-item-title">قسم المنتجات المستعملة - الحراج</div>
                    <div class="menu-item-description">منتجات مستعملة بحالة جيدة وبأسعار مناسبة</div>
                </div>
            </div>
            
            <!-- المباني والعقارات - رابط محسن -->
            <div class="menu-item" onclick="openEcommercePage('1_5.html', 'قسم المباني والعقارات')">
                <img src="https://drive.google.com/thumbnail?id=1Msxt4CiPc-j-eSOawoXfTch08BcMRCV1&sz=w200"
                     alt="عقارات" 
                     class="menu-item-image"
                     onerror="this.src='https://via.placeholder.com/45x45/e67e22/ffffff?text=AZ'">
                <div class="menu-item-content">
                    <div class="menu-item-title">قسم المباني والعقارات</div>
                    <div class="menu-item-description">عروض عقارية متنوعة للبيع والإيجار</div>
                </div>
            </div>
            
            <!-- الوظائف الشاغرة - رابط محسن -->
            <div class="menu-item" onclick="openEcommercePage('1_6.html', 'قسم الوظائف الشاغرة')">
                <img src="https://drive.google.com/thumbnail?id=1f4a7Te4DbN7DqLTHc_-DOstlFiZ7nDoS&sz=w200"
                     alt="وظائف" 
                     class="menu-item-image"
                     onerror="this.src='https://via.placeholder.com/45x45/9b59b6/ffffff?text=AZ'">
                <div class="menu-item-content">
                    <div class="menu-item-title">قسم الوظائف الشاغرة</div>
                    <div class="menu-item-description">فرص عمل متنوعة في مختلف المجالات</div>
                </div>
            </div>
            
            <!-- الطلب والتوصيل السريع - رابط محسن -->
            <div class="menu-item" onclick="openEcommercePage('index_mt.html', 'قسم الطلب والتوصيل السريع')">
                <img src="https://drive.google.com/thumbnail?id=1aLMNf5VLLcRddT7joU7NF8eOjP8e-82H&sz=w200"
                     alt="توصيل" 
                     class="menu-item-image"
                     onerror="this.src='https://via.placeholder.com/45x45/e74c3c/ffffff?text=AZ'">
                <div class="menu-item-content">
                    <div class="menu-item-title">قسم الطلب والتوصيل السريع</div>
                    <div class="menu-item-description">اطلب وجبتك . . . تصلك لباب البيت</div>
                </div>
            </div>
            
            <!-- أرقام ومواقع أشخاص تهمك - رابط محسن -->
            <div class="menu-item" onclick="openEcommercePage('txtx.html', 'أرقام ومواقع أشخاص تهمك')">
                <img src="https://drive.google.com/thumbnail?id=10LHD22zlnPn3SCGn3JHuQDqBFPxkQdUr&sz=w200"
                     alt="أرقام" 
                     class="menu-item-image"
                     onerror="this.src='https://via.placeholder.com/45x45/1abc9c/ffffff?text=AZ'">
                <div class="menu-item-content">
                    <div class="menu-item-title">أرقام ومواقع أشخاص تهمك</div>
                    <div class="menu-item-description">ابحث عن باص او دراجة نارية او فني على خريطة AZ</div>
                </div>
            </div>
            
            <!-- قسم الدم - تم إضافته -->
            <div class="menu-item" onclick="openEcommercePage('dm.html', 'قسم الدم')">
                <img src="https://drive.google.com/thumbnail?id=1YOUR_IMAGE_ID&sz=w200"
                     alt="تبرع بالدم" 
                     class="menu-item-image"
                     onerror="this.src='https://via.placeholder.com/45x45/e74c3c/ffffff?text=دم'">
                <div class="menu-item-content">
                    <div class="menu-item-title">قسم الدم</div>
                    <div class="menu-item-description">لمن أراد التبرع بدم أو طلب دم</div>
                </div>
            </div>

            <div class="menu-section-title">
                <i class="fas fa-mobile-alt"></i>
                أدوات التطبيق
            </div>
            
            <div class="menu-item install" onclick="openInstallChoice()">
                <i class="fas fa-download"></i>
                <div class="menu-item-content">
                    <div class="menu-item-title">تثبيت التطبيق</div>
                    <div class="menu-item-description">قم بتثبيت التطبيق على جهازك</div>
                </div>
            </div>
            
            <div class="menu-item" onclick="openShareModal()">
                <i class="fas fa-share-alt"></i>
                <div class="menu-item-content">
                    <div class="menu-item-title">مشاركة التطبيق</div>
                    <div class="menu-item-description">شارك التطبيق مع أصدقائك وعائلتك</div>
                </div>
            </div>
            
            <div class="menu-item" onclick="downloadAppDirect()">
                <i class="fas fa-file-download"></i>
                <div class="menu-item-content">
                    <div class="menu-item-title">تحميل التطبيق</div>
                    <div class="menu-item-description">تحميل ملف APK للتطبيق</div>
                </div>
            </div>

            <div class="menu-section-title">
                <i class="fas fa-user-circle"></i>
                حساب المستخدم
            </div>
            
            <div class="menu-item" id="loginMenuItem" onclick="openLoginPage()">
                <i class="fas fa-sign-in-alt"></i>
                <div class="menu-item-content">
                    <div class="menu-item-title">تسجيل الدخول</div>
                    <div class="menu-item-description">قم بتسجيل الدخول لحسابك</div>
                </div>
            </div>
            
            <div class="menu-item" onclick="openUserProfile()">
                <i class="fas fa-user-cog"></i>
                <div class="menu-item-content">
                    <div class="menu-item-title">ملفي الشخصي</div>
                    <div class="menu-item-description">عرض وتعديل بيانات الملف الشخصي</div>
                </div>
            </div>
            
            <div class="menu-item" onclick="openOrders()">
                <i class="fas fa-clipboard-list"></i>
                <div class="menu-item-content">
                    <div class="menu-item-title">طلباتي</div>
                    <div class="menu-item-description">عرض جميع طلباتي السابقة</div>
                </div>
            </div>
            
            <div class="menu-item logout" onclick="logoutUser()">
                <i class="fas fa-sign-out-alt"></i>
                <div class="menu-item-content">
                    <div class="menu-item-title">تسجيل الخروج</div>
                    <div class="menu-item-description">الخروج من حسابك</div>
                </div>
            </div>

            <div class="menu-section-title">
                <i class="fas fa-info-circle"></i>
                معلومات إضافية
            </div>
            
            <div class="menu-item" onclick="openAbout()">
                <i class="fas fa-info"></i>
                <div class="menu-item-content">
                    <div class="menu-item-title">حول التطبيق</div>
                    <div class="menu-item-description">معلومات عن تطبيق AZ السوق الشامل</div>
                </div>
            </div>
            
            <div class="menu-item" onclick="openContact()">
                <i class="fas fa-phone"></i>
                <div class="menu-item-content">
                    <div class="menu-item-title">اتصل بنا</div>
                    <div class="menu-item-description">طرق التواصل مع فريق الدعم</div>
                </div>
            </div>
            
            <div class="menu-item" onclick="openPrivacy()">
                <i class="fas fa-shield-alt"></i>
                <div class="menu-item-content">
                    <div class="menu-item-title">سياسة الخصوصية</div>
                    <div class="menu-item-description">كيف نحمي بياناتك الشخصية</div>
                </div>
            </div>
            
            <div class="menu-item" onclick="openTerms()">
                <i class="fas fa-file-contract"></i>
                <div class="menu-item-content">
                    <div class="menu-item-title">شروط الاستخدام</div>
                    <div class="menu-item-description">الشروط والأحكام الخاصة باستخدام التطبيق</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ========== حاوية البانر والأزرار الثابتة ========== -->
    <div class="sticky-header-container" id="stickyHeader">
        <!-- البانر الرئيسي -->
        <div class="main-banner-container" id="mainBanner">
            <img id="bannerImage" src="" 
                 alt="بانر AZ السوق الشامل" 
                 class="banner-image"
                 loading="lazy"
                 onerror="this.src='https://via.placeholder.com/1200x220/2980b9/ffffff?text=AZ+السوق+الشامل'">
            <div class="banner-overlay"></div>
            <div class="banner-content">
                <h2 id="bannerTitle">AZ السوق الشامل</h2>
                <p id="bannerDescription">لتلبية احتياجك بالكامل</p>
            </div>
        </div>

        <!-- شريط الأزرار المعدل (مطابق للقائمة الجانبية) -->
        <div class="navbar" id="navbar">
            <div class="navbar-container">
                <!-- المنتجات التجارية الجديدة -->
                <button onclick="openEcommercePage('1_1k.html', 'قسم المنتجات التجارية الجديدة')">
                    <img src="https://drive.google.com/thumbnail?id=1wAn2GWZxxv6d0mY-cLSV3oryNt1QZaCR&sz=w200"
                         alt="منتجات تجارية" 
                         class="navbar-button-image"
                         onerror="this.src='https://via.placeholder.com/32x32/2980b9/ffffff?text=AZ'">
                    <div class="navbar-text-container">
                        <div class="navbar-button-title">المنتجات التجارية الجديدة</div>
                        <div class="navbar-button-description">منتجات جديدة بجودة عالية وأسعار منافسة</div>
                    </div>
                </button>
                
                <!-- المنتجات المستعملة - الحراج -->
                <button onclick="openEcommercePage('1_2.html', 'قسم المنتجات المستعملة - الحراج')">
                    <img src="https://drive.google.com/thumbnail?id=1AUf5d-XQCKqGjw_kXN3cJFuepsKyEEkc&sz=w200"
                         alt="منتجات مستعملة" 
                         class="navbar-button-image"
                         onerror="this.src='https://via.placeholder.com/32x32/2ecc71/ffffff?text=AZ'">
                    <div class="navbar-text-container">
                        <div class="navbar-button-title">المنتجات المستعملة - الحراج</div>
                        <div class="navbar-button-description">منتجات مستعملة بحالة جيدة وبأسعار مناسبة</div>
                    </div>
                </button>
                
                <!-- المباني والعقارات -->
                <button onclick="openEcommercePage('1_5.html', 'قسم المباني والعقارات')">
                    <img src="https://drive.google.com/thumbnail?id=1Msxt4CiPc-j-eSOawoXfTch08BcMRCV1&sz=w200"
                         alt="عقارات" 
                         class="navbar-button-image"
                         onerror="this.src='https://via.placeholder.com/32x32/e67e22/ffffff?text=AZ'">
                    <div class="navbar-text-container">
                        <div class="navbar-button-title">المباني والعقارات</div>
                        <div class="navbar-button-description">عروض عقارية متنوعة للبيع والإيجار</div>
                    </div>
                </button>
                
                <!-- الوظائف الشاغرة -->
                <button onclick="openEcommercePage('1_6.html', 'قسم الوظائف الشاغرة')">
                    <img src="https://drive.google.com/thumbnail?id=1f4a7Te4DbN7DqLTHc_-DOstlFiZ7nDoS&sz=w200"
                         alt="وظائف" 
                         class="navbar-button-image"
                         onerror="this.src='https://via.placeholder.com/32x32/9b59b6/ffffff?text=AZ'">
                    <div class="navbar-text-container">
                        <div class="navbar-button-title">الوظائف الشاغرة</div>
                        <div class="navbar-button-description">فرص عمل متنوعة في مختلف المجالات</div>
                    </div>
                </button>
                
                <!-- الطلب والتوصيل السريع -->
                <button onclick="openEcommercePage('index_mt.html', 'قسم الطلب والتوصيل السريع')">
                    <img src="https://drive.google.com/thumbnail?id=1aLMNf5VLLcRddT7joU7NF8eOjP8e-82H&sz=w200"
                         alt="توصيل" 
                         class="navbar-button-image"
                         onerror="this.src='https://via.placeholder.com/32x32/e74c3c/ffffff?text=AZ'">
                    <div class="navbar-text-container">
                        <div class="navbar-button-title">الطلب والتوصيل السريع</div>
                        <div class="navbar-button-description">اطلب وجبتك . . . تصلك لباب البيت</div>
                    </div>
                </button>
                
                <!-- أرقام ومواقع أشخاص تهمك -->
                <button onclick="openEcommercePage('txtx.html', 'أرقام ومواقع أشخاص تهمك')">
                    <img src="https://drive.google.com/thumbnail?id=10LHD22zlnPn3SCGn3JHuQDqBFPxkQdUr&sz=w200"
                         alt="أرقام" 
                         class="navbar-button-image"
                         onerror="this.src='https://via.placeholder.com/32x32/1abc9c/ffffff?text=AZ'">
                    <div class="navbar-text-container">
                        <div class="navbar-button-title">أرقام ومواقع أشخاص تهمك</div>
                        <div class="navbar-button-description">ابحث عن باص او دراجة نارية او فني على خريطة AZ</div>
                    </div>
                </button>
                
                <!-- قسم الدم - تم إضافته -->
                <button class="blood-donation-button" onclick="openEcommercePage('dm.html', 'قسم الدم')">
                    <img src="https://drive.google.com/thumbnail?id=1YOUR_IMAGE_ID&sz=w200"
                         alt="تبرع بالدم" 
                         class="navbar-button-image"
                         onerror="this.src='https://via.placeholder.com/32x32/e74c3c/ffffff?text=دم'">
                    <div class="navbar-text-container">
                        <div class="navbar-button-title">قسم الدم</div>
                        <div class="navbar-button-description">لمن أراد التبرع بدم أو طلب دم</div>
                    </div>
                </button>
            </div>
        </div>
    </div>

    <!-- شريط تسجيل الدخول -->
    <div class="login-bar" id="loginBar">
        <button class="login-bar-btn" onclick="openLoginPage()">
            <i class="fas fa-user"></i> تسجيل الدخول
        </button>
    </div>

    <!-- محتوى الصفحة -->
    <div id="content-area">
        <!-- شاشة البداية المتحركة داخل منطقة المحتوى -->
        <div id="introScreen">
            <div class="intro-content">
                <div class="intro-logo">
                    <i class="fas fa-shopping-cart"></i>
                    <span>AZ</span>
                </div>
                <div class="intro-title">السوق الشامل</div>
                <div class="intro-subtitle">لتلبية احتياجك بالكامل</div>
            </div>
        </div>
    </div>

    <!-- التذييل - تم تعديله ليكون أقل ارتفاعاً -->
    <div class="footer">
        <p>إعداد وبرمجة/ المميز سوفت للأنظمة المحاسبية المتكاملة</p>
    </div>

    <script>
        // ===== نظام إدارة صور Google Drive المحسن (محسّن) =====
        const EnhancedDriveImageManager = {
            // الصور المحددة للبانر مع روابط محسّنة - تم تعديلها لتظهر بشكل كامل
            bannerImages: [
                {
                    url: "https://drive.google.com/thumbnail?id=1wAn2GWZxxv6d0mY-cLSV3oryNt1QZaCR&sz=w1200",
                    title: "المنتجات التجارية الجديدة",
                    description: "منتجات جديدة بجودة عالية وأسعار منافسة"
                },
                {
                    url: "https://drive.google.com/thumbnail?id=1AUf5d-XQCKqGjw_kXN3cJFuepsKyEEkc&sz=w1200",
                    title: "المنتجات المستعملة - الحراج",
                    description: "منتجات مستعملة بحالة جيدة وبأسعار مناسبة"
                },
                {
                    url: "https://drive.google.com/thumbnail?id=1aLMNf5VLLcRddT7joU7NF8eOjP8e-82H&sz=w1200",
                    title: "الطلب والتوصيل السريع",
                    description: "اطلب وجبتك . . . تصلك لباب البيت"
                },
                {
                    url: "https://drive.google.com/thumbnail?id=1Msxt4CiPc-j-eSOawoXfTch08BcMRCV1&sz=w1200",
                    title: "المباني والعقارات",
                    description: "عروض عقارية متنوعة للبيع والإيجار"
                },
                {
                    url: "https://drive.google.com/thumbnail?id=1f4a7Te4DbN7DqLTHc_-DOstlFiZ7nDoS&sz=w1200",
                    title: "الوظائف الشاغرة",
                    description: "فرص عمل متنوعة في مختلف المجالات"
                },
                {
                    url: "https://drive.google.com/thumbnail?id=10LHD22zlnPn3SCGn3JHuQDqBFPxkQdUr&sz=w1200",
                    title: "أرقام ومواقع أشخاص تهمك",
                    description: "ابحث عن باص او دراجة نارية او فني على خريطة AZ"
                },
                {
                    url: "https://drive.google.com/thumbnail?id=1Po6xGu1YCD2yZc6AExDxo2t-7TMz03cX&sz=w1200",
                    title: "AZ السوق الشامل",
                    description: "لتلبية احتياجك بالكامل"
                },
                {
                    url: "https://drive.google.com/thumbnail?id=1_I_BdWU8dP_Z5aIx5zpGkdGIApurodYl&sz=w1200",
                    title: "منتجات متنوعة",
                    description: "تشكيلة واسعة من المنتجات والخدمات"
                },
                {
                    url: "https://drive.google.com/thumbnail?id=1R0Z_tatRNz4-6ueXVLnzzss3ZsrmME-v&sz=w1200",
                    title: "تسوق أونلاين",
                    description: "تسوق بسهولة من منزلك"
                },
                {
                    url: "https://drive.google.com/thumbnail?id=156FgUoKmDfeCa1EXqZUXkzi7oqIUCnVW&sz=w1200",
                    title: "عروض خاصة",
                    description: "عروض وتخفيضات حصرية"
                }
            ],
            
            // صور بديلة في حالة فشل التحميل
            fallbackImages: [
                "https://images.unsplash.com/photo-1607082350899-7e105aa886ae?w=1200&h=300&fit=contain&bg=white",
                "https://images.unsplash.com/photo-1556742049-0cfed4f6a45d?w=1200&h=300&fit=contain&bg=white",
                "https://images.unsplash.com/photo-1556742044-3c52d6e88c62?w=1200&h=300&fit=contain&bg=white"
            ],
            
            // كاش لتخزين الصور التي تم تحميلها
            imageCache: new Map(),
            
            // دالة لتحسين رابط Google Drive
            optimizeDriveUrl: function(fileId, width = 1200, height = 300) {
                const cacheKey = `${fileId}_${width}x${height}`;
                
                // التحقق من وجود الصورة في الكاش
                if (this.imageCache.has(cacheKey)) {
                    return this.imageCache.get(cacheKey);
                }
                
                // إنشاء رابط محسن باستخدام thumbnail
                const optimizedUrl = `https://drive.google.com/thumbnail?id=${fileId}&sz=w${width}`;
                
                // تخزين في الكاش
                this.imageCache.set(cacheKey, optimizedUrl);
                
                return optimizedUrl;
            },
            
            // دالة للتحقق من صحة الصور
            validateImageUrl: async function(url) {
                try {
                    const response = await fetch(url, { method: 'HEAD' });
                    return response.ok;
                } catch (error) {
                    console.warn('⚠️ فشل في التحقق من صحة رابط الصورة:', url);
                    return false;
                }
            },
            
            // تهيئة النظام
            init: function() {
                // تحميل الصور مسبقاً
                this.preloadBannerImages();
                
                // تحديث الكاش كل 10 دقائق
                setInterval(() => {
                    this.imageCache.clear();
                    console.log('🧹 تم تنظيف كاش الصور');
                }, 10 * 60 * 1000);
                
                console.log('🚀 نظام إدارة صور Google Drive المحسن جاهز للعمل');
            },
            
            // تحميل الصور مسبقاً
            preloadBannerImages: function() {
                console.log('📥 جاري تحميل صور البانر مسبقاً...');
                
                this.bannerImages.forEach((banner, index) => {
                    const img = new Image();
                    img.src = banner.url;
                    
                    img.onload = () => {
                        console.log(`✅ تم تحميل صورة البانر ${index + 1}: ${banner.title}`);
                    };
                    
                    img.onerror = () => {
                        console.warn(`❌ فشل تحميل صورة البانر ${index + 1}, استخدام رابط بديل`);
                        // استخدام رابط بديل
                        const fallbackIndex = index % this.fallbackImages.length;
                        banner.url = this.fallbackImages[fallbackIndex];
                    };
                });
            },
            
            // الحصول على رابط صورة آمن
            getSafeImageUrl: function(fileId, defaultUrl = null) {
                if (!fileId) {
                    return defaultUrl || 'https://via.placeholder.com/1200x300/2980b9/ffffff?text=AZ+السوق+الشامل';
                }
                
                try {
                    return this.optimizeDriveUrl(fileId);
                } catch (error) {
                    console.error('❌ خطأ في معالجة رابط الصورة:', error);
                    return defaultUrl || 'https://via.placeholder.com/1200x300/2980b9/ffffff?text=AZ+السوق+الشامل';
                }
            }
        };

        // ===== تهيئة Firebase =====
        const firebaseConfig = {
            databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ===== نظام الشريط العلوي الثابت =====
        class StickyTopBar {
            constructor() {
                this.topBar = document.getElementById('topBar');
                this.lastScrollTop = 0;
                this.init();
            }
            
            init() {
                window.addEventListener('scroll', () => this.handleScroll());
                this.handleScroll();
                console.log('✅ تم تهيئة نظام الشريط العلوي الثابت');
            }
            
            handleScroll() {
                const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
                
                if (scrollTop > 10) {
                    this.topBar.classList.add('scrolled');
                } else {
                    this.topBar.classList.remove('scrolled');
                }
                
                this.lastScrollTop = scrollTop;
            }
        }

        // ===== نظام البانر المعدل =====
        class StaticBannerManager {
            constructor() {
                this.bannerImages = EnhancedDriveImageManager.bannerImages;
                this.currentIndex = 0;
                this.bannerInterval = null;
                this.bannerElement = document.getElementById('bannerImage');
                this.bannerTitleElement = document.getElementById('bannerTitle');
                this.bannerDescElement = document.getElementById('bannerDescription');
                this.bannerContainer = document.getElementById('mainBanner');
                
                console.log('🚀 تم تهيئة نظام البانر الثابت');
                console.log(`📊 عدد الصور المتاحة: ${this.bannerImages.length}`);
            }
            
            init() {
                this.showBanner(0);
                this.startBannerRotation();
                this.setupBannerClick();
                
                // إضافة مستمع أخطاء للصورة
                this.bannerElement.addEventListener('error', () => {
                    this.handleBannerImageError();
                });
            }
            
            showBanner(index) {
                if (this.bannerImages.length === 0) return;
                
                this.currentIndex = index % this.bannerImages.length;
                const banner = this.bannerImages[this.currentIndex];
                
                // تحديث الصورة
                this.bannerElement.src = banner.url;
                
                // تحديث النصوص
                if (this.bannerTitleElement && banner.title) {
                    this.bannerTitleElement.textContent = banner.title;
                }
                
                if (this.bannerDescElement && banner.description) {
                    this.bannerDescElement.textContent = banner.description;
                }
                
                // إضافة تأثير تغيير الصورة
                this.bannerElement.style.opacity = '0';
                setTimeout(() => {
                    this.bannerElement.style.opacity = '1';
                }, 50);
                
                console.log(`🖼️ عرض صورة البانر ${this.currentIndex + 1}/${this.bannerImages.length}: ${banner.title}`);
            }
            
            handleBannerImageError() {
                console.warn('❌ فشل تحميل صورة البانر، استخدام صورة بديلة');
                
                // استخدام صورة بديلة
                const fallbackIndex = this.currentIndex % EnhancedDriveImageManager.fallbackImages.length;
                this.bannerElement.src = EnhancedDriveImageManager.fallbackImages[fallbackIndex];
                
                // تحديث النصوص الافتراضية
                if (this.bannerTitleElement) {
                    this.bannerTitleElement.textContent = 'AZ السوق الشامل';
                }
                if (this.bannerDescElement) {
                    this.bannerDescElement.textContent = 'لتلبية احتياجك بالكامل';
                }
            }
            
            startBannerRotation() {
                if (this.bannerImages.length <= 1) {
                    // عرض الصورة الوحيدة
                    this.showBanner(0);
                    return;
                }
                
                // عرض أول صورة
                this.showBanner(0);
                
                // بدء التناوب كل 5 ثواني
                this.bannerInterval = setInterval(() => {
                    this.currentIndex = (this.currentIndex + 1) % this.bannerImages.length;
                    this.showBanner(this.currentIndex);
                }, 5000); // 5 ثواني
                
                console.log('🔄 بدء تناوب البانر كل 5 ثواني');
            }
            
            setupBannerClick() {
                // إمكانية التخطي عند النقر
                this.bannerContainer.addEventListener('click', (e) => {
                    if (e.target.closest('.banner-content')) return;
                    
                    if (this.bannerImages.length > 1) {
                        this.currentIndex = (this.currentIndex + 1) % this.bannerImages.length;
                        this.showBanner(this.currentIndex);
                        
                        // إعادة ضبط المؤقت
                        if (this.bannerInterval) {
                            clearInterval(this.bannerInterval);
                            this.bannerInterval = setInterval(() => {
                                this.currentIndex = (this.currentIndex + 1) % this.bannerImages.length;
                                this.showBanner(this.currentIndex);
                            }, 5000);
                        }
                    }
                });
            }
            
            stopBannerRotation() {
                if (this.bannerInterval) {
                    clearInterval(this.bannerInterval);
                    this.bannerInterval = null;
                }
            }
        }

        // ===== نظام السحب الأفقي لشريط الأزرار =====
        class HorizontalScrollNavbar {
            constructor() {
                this.navbar = document.getElementById('navbar');
                this.container = this.navbar.querySelector('.navbar-container');
                this.isDown = false;
                this.startX = 0;
                this.scrollLeft = 0;
                this.velocity = 0;
                this.animationId = null;
                this.lastTime = 0;
                
                this.init();
                console.log('✅ تم تهيئة شريط الأزرار بالسحب الأفقي');
            }
            
            init() {
                // إضافة مستمعي الأحداث للسحب
                this.navbar.addEventListener('mousedown', (e) => this.handleMouseDown(e));
                this.navbar.addEventListener('mousemove', (e) => this.handleMouseMove(e));
                this.navbar.addEventListener('mouseup', () => this.handleMouseUp());
                this.navbar.addEventListener('mouseleave', () => this.handleMouseUp());
                
                // إضافة مستمعي الأحداث لللمس
                this.navbar.addEventListener('touchstart', (e) => this.handleTouchStart(e));
                this.navbar.addEventListener('touchmove', (e) => this.handleTouchMove(e));
                this.navbar.addEventListener('touchend', () => this.handleTouchEnd());
                
                // إضافة مستمعي الأحداث للعجلة
                this.navbar.addEventListener('wheel', (e) => this.handleWheel(e));
                
                // تهيئة الرسوم المتحركة
                this.animate();
            }
            
            handleMouseDown(e) {
                this.isDown = true;
                this.navbar.classList.add('dragging');
                this.startX = e.pageX - this.navbar.offsetLeft;
                this.scrollLeft = this.navbar.scrollLeft;
                this.velocity = 0;
                this.lastTime = Date.now();
            }
            
            handleMouseMove(e) {
                if (!this.isDown) return;
                e.preventDefault();
                
                const x = e.pageX - this.navbar.offsetLeft;
                const walk = (x - this.startX) * 1.5;
                this.navbar.scrollLeft = this.scrollLeft - walk;
                
                // حساب السرعة للقصور الذاتي
                const currentTime = Date.now();
                const deltaTime = currentTime - this.lastTime;
                if (deltaTime > 0) {
                    this.velocity = walk / deltaTime;
                }
                this.lastTime = currentTime;
            }
            
            handleMouseUp() {
                this.isDown = false;
                this.navbar.classList.remove('dragging');
                
                // تطبيق القصور الذاتي
                this.applyInertia();
            }
            
            handleTouchStart(e) {
                this.isDown = true;
                this.navbar.classList.add('dragging');
                this.startX = e.touches[0].pageX - this.navbar.offsetLeft;
                this.scrollLeft = this.navbar.scrollLeft;
                this.velocity = 0;
                this.lastTime = Date.now();
            }
            
            handleTouchMove(e) {
                if (!this.isDown) return;
                e.preventDefault();
                
                const x = e.touches[0].pageX - this.navbar.offsetLeft;
                const walk = (x - this.startX) * 1.5;
                this.navbar.scrollLeft = this.scrollLeft - walk;
                
                // حساب السرعة للقصور الذاتي
                const currentTime = Date.now();
                const deltaTime = currentTime - this.lastTime;
                if (deltaTime > 0) {
                    this.velocity = walk / deltaTime;
                }
                this.lastTime = currentTime;
            }
            
            handleTouchEnd() {
                this.isDown = false;
                this.navbar.classList.remove('dragging');
                
                // تطبيق القصور الذاتي
                this.applyInertia();
            }
            
            handleWheel(e) {
                e.preventDefault();
                this.navbar.scrollLeft += e.deltaY * 0.5;
                this.velocity = e.deltaY * 0.01;
            }
            
            applyInertia() {
                if (Math.abs(this.velocity) > 0.1) {
                    const inertia = () => {
                        this.navbar.scrollLeft += this.velocity * 10;
                        this.velocity *= 0.95;
                        
                        if (Math.abs(this.velocity) > 0.1) {
                            requestAnimationFrame(inertia);
                        }
                    };
                    requestAnimationFrame(inertia);
                }
            }
            
            animate() {
                this.animationId = requestAnimationFrame(() => this.animate());
            }
            
            destroy() {
                if (this.animationId) {
                    cancelAnimationFrame(this.animationId);
                }
            }
        }

        // ===== نظام إدارة المستخدم العام =====
        const globalUser = {
            data: null,
            
            setUserData: function(userData) {
                this.data = userData;
                sessionStorage.setItem('globalUserData', JSON.stringify(userData));
                this.updateMenuUserInfo();
                console.log('✅ تم تخزين بيانات المستخدم في الجلسة:', userData);
            },
            
            getUserData: function() {
                if (this.data) return this.data;
                
                const storedData = sessionStorage.getItem('globalUserData');
                if (storedData) {
                    this.data = JSON.parse(storedData);
                    return this.data;
                }
                return null;
            },
            
            getUsername: function() {
                const userData = this.getUserData();
                return userData ? userData.username : 'زائر';
            },
            
            getUserId: function() {
                const userData = this.getUserData();
                return userData ? userData.id : null;
            },
            
            isLoggedIn: function() {
                return this.getUserData() !== null;
            },
            
            logout: function() {
                this.data = null;
                sessionStorage.removeItem('globalUserData');
                this.updateMenuUserInfo();
                console.log('🚪 تم تسجيل الخروج');
            },
            
            updateMenuUserInfo: function() {
                const userNameElement = document.getElementById('menuUserName');
                const userStatusElement = document.getElementById('menuUserStatus');
                const loginMenuItem = document.getElementById('loginMenuItem');
                
                if (this.isLoggedIn()) {
                    const userData = this.getUserData();
                    userNameElement.textContent = userData.username || 'مستخدم';
                    userStatusElement.textContent = 'مسجل دخول';
                    if (loginMenuItem) {
                        loginMenuItem.innerHTML = '<i class="fas fa-user-check"></i><div class="menu-item-content"><div class="menu-item-title">مسجل دخول</div><div class="menu-item-description">مرحباً بك في حسابك</div></div>';
                        loginMenuItem.onclick = function() { openUserProfile(); };
                    }
                } else {
                    userNameElement.textContent = 'زائر';
                    userStatusElement.textContent = 'غير مسجل دخول';
                    if (loginMenuItem) {
                        loginMenuItem.innerHTML = '<i class="fas fa-sign-in-alt"></i><div class="menu-item-content"><div class="menu-item-title">تسجيل الدخول</div><div class="menu-item-description">قم بتسجيل الدخول لحسابك</div></div>';
                        loginMenuItem.onclick = function() { openLoginPage(); };
                    }
                }
            }
        };

        // ===== نظام تخزين بيانات التاجر =====
        const merchantGlobal = {
            setMerchantName: function(name) {
                sessionStorage.setItem('merchantName', name);
                this.updateMerchantData();
                console.log('✅ تم حفظ اسم التاجر في الجلوبال:', name);
            },
            
            getMerchantName: function() {
                return sessionStorage.getItem('merchantName') || '';
            },
            
            setMerchantPhone: function(phone) {
                sessionStorage.setItem('merchantPhone', phone);
                this.updateMerchantData();
                console.log('✅ تم حفظ رقم التاجر في الجلوبال:', phone);
            },
            
            getMerchantPhone: function() {
                return sessionStorage.getItem('merchantPhone') || '';
            },
            
            setMerchantId: function(merchantId) {
                sessionStorage.setItem('merchantId', merchantId);
                this.updateMerchantData();
                console.log('✅ تم حفظ معرف التاجر في الجلوبال:', merchantId);
            },
            
            getMerchantId: function() {
                return sessionStorage.getItem('merchantId') || '';
            },
            
            hasMerchantData: function() {
                return this.getMerchantName() && this.getMerchantPhone();
            },
            
            updateMerchantData: function() {
                const merchantSection = document.getElementById('merchantDataSection');
                const merchantNameValue = document.getElementById('merchantNameValue');
                const merchantPhoneValue = document.getElementById('merchantPhoneValue');
                const merchantIdValue = document.getElementById('merchantIdValue');
                
                if (this.hasMerchantData()) {
                    merchantSection.style.display = 'block';
                    merchantNameValue.textContent = this.getMerchantName();
                    merchantPhoneValue.textContent = this.getMerchantPhone();
                    merchantIdValue.textContent = this.getMerchantId() || 'غير محدد';
                } else {
                    merchantSection.style.display = 'none';
                }
            },
            
            clearAll: function() {
                sessionStorage.removeItem('merchantName');
                sessionStorage.removeItem('merchantPhone');
                sessionStorage.removeItem('merchantId');
                this.updateMerchantData();
                console.log('🧹 تم إفراغ جميع بيانات التاجر من الجلوبال');
            }
        };

        // ===== نظام القائمة الجانبية =====
        let isMenuOpen = false;

        function openSideMenu() {
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.querySelector('.overlay');
            
            sideMenu.classList.add('open');
            overlay.classList.add('active');
            isMenuOpen = true;
            
            // تحديث بيانات القائمة
            globalUser.updateMenuUserInfo();
            merchantGlobal.updateMerchantData();
            
            console.log('📱 تم فتح القائمة الجانبية');
        }

        function closeSideMenu() {
            const sideMenu = document.getElementById('sideMenu');
            const overlay = document.querySelector('.overlay');
            
            sideMenu.classList.remove('open');
            overlay.classList.remove('active');
            isMenuOpen = false;
            
            console.log('📱 تم إغلاق القائمة الجانبية');
        }

        // ===== نظام PWA والتثبيت =====
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            showPWAInstallButton();
        });

        function showPWAInstallButton() {
            const installBtn = document.getElementById('pwaInstallBtn');
            if (installBtn) {
                installBtn.style.display = 'block';
            }
        }

        async function installPWA() {
            if (!deferredPrompt) {
                return false;
            }
            
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            
            if (outcome === 'accepted') {
                return true;
            } else {
                return false;
            }
        }

        function installAppEnhanced() {
            const downloadLinks = {
                android: 'https://drive.google.com/uc?export=download&id=1iPwYBIEvs-RvXryeDNOHZVpbZrcm6q-9',
                direct: 'https://drive.google.com/uc?export=download&id=1iPwYBIEvs-RvXryeDNOHZVpbZrcm6q-9'
            };
            
            if (deferredPrompt) {
                installPWA().then(success => {
                    if (!success) {
                        downloadAppDirect();
                    }
                });
            } else {
                downloadAppDirect();
            }
        }

        function downloadAppDirect() {
            const downloadUrl = 'https://drive.google.com/uc?export=download&id=1iPwYBIEvs-RvXryeDNOHZVpbZrcm6q-9';
            
            fetch(downloadUrl)
                .then(response => response.blob())
                .then(blob => {
                    const url = window.URL.createObjectURL(blob);
                    const link = document.createElement('a');
                    link.href = url;
                    link.download = 'AZالسوق الشامل.apk';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    window.URL.revokeObjectURL(url);
                    
                    setTimeout(() => {
                        alert('✅ تم تحميل التطبيق بنجاح! ابحث عن الملف في مجلد التنزيلات وقم بتثبيته.');
                    }, 1000);
                })
                .catch(error => {
                    console.error('❌ خطأ في تحميل الملف:', error);
                    const link = document.createElement('a');
                    link.href = downloadUrl;
                    link.download = 'AZالسوق الشامل.apk';
                    link.target = '_blank';
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    alert('📱 جاري تحميل التطبيق... ابحث عن الملف في مجلد التنزيلات بعد اكتمال التحميل.');
                });
        }

        // ===== نظام المشاركة =====
        function openShareModal() {
            const modal = document.getElementById('shareModal');
            modal.classList.add('show');
            console.log('✅ تم فتح نافذة المشاركة');
        }

        function closeShareModal() {
            const modal = document.getElementById('shareModal');
            modal.classList.remove('show');
        }

        function shareOnWhatsApp() {
            const url = `https://wa.me/?text=${encodeURIComponent('تطبيق AZ السوق الشامل - لتلبية احتياجك بالكامل\n\nقم بتحميل التطبيق الآن:\nhttps://e772299420-hue.github.io/Call/')}`;
            window.open(url, '_blank');
            console.log('📱 مشاركة عبر واتساب');
        }

        function shareOnTelegram() {
            const url = `https://t.me/share/url?url=${encodeURIComponent('https://e772299420-hue.github.io/Call/')}&text=${encodeURIComponent('تطبيق AZ السوق الشامل - لتلبية احتياجك بالكامل')}`;
            window.open(url, '_blank');
            console.log('📢 مشاركة عبر تليجرام');
        }

        function copyAppLink() {
            const appLink = 'https://e772299420-hue.github.io/Call/';
            navigator.clipboard.writeText(appLink).then(() => {
                alert('✅ تم نسخ رابط التطبيق! يمكنك مشاركته الآن.');
                console.log('📋 نسخ الرابط');
            }).catch(() => {
                const tempInput = document.createElement('input');
                tempInput.value = appLink;
                document.body.appendChild(tempInput);
                tempInput.select();
                document.execCommand('copy');
                document.body.removeChild(tempInput);
                alert('✅ تم نسخ رابط التطبيق! يمكنك مشاركته الآن.');
            });
        }

        function shareViaEmail() {
            const subject = 'تطبيق AZ السوق الشامل';
            const body = 'مرحباً،\n\nأود مشاركة تطبيق AZ السوق الشامل معك. التطبيق يوفر خدمات متكاملة للتسوق الإلكتروني والخدمات التجارية.\n\nرابط التطبيق: https://e772299420-hue.github.io/Call/\n\nمع تحياتي';
            const url = `mailto:?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
            window.location.href = url;
            console.log('📧 مشاركة عبر البريد الإلكتروني');
        }

        function shareViaSMS() {
            const body = 'تطبيق AZ السوق الشامل - لتلبية احتياجك بالكامل\nرابط التطبيق: https://e772299420-hue.github.io/Call/';
            const url = `sms:?body=${encodeURIComponent(body)}`;
            window.location.href = url;
            console.log('💬 مشاركة عبر الرسائل النصية');
        }

        // ===== دوال الصفحة الرئيسية =====
        let loginBarTimeout;
        let currentPage = '';
        let visitorTracker;
        let horizontalScrollNavbar;
        let bannerManager;
        let stickyTopBar;

        function hideIntroScreen() {
            const introScreen = document.getElementById('introScreen');
            introScreen.style.opacity = '0';
            introScreen.style.transform = 'scale(1.1)';
            setTimeout(() => {
                introScreen.style.display = 'none';
                // فتح أول قسم تلقائياً بعد إخفاء الشاشة
                openEcommercePage('1_1k.html', 'قسم المنتجات التجارية الجديدة');
            }, 1000);
        }

        function hideLoginBar() {
            const loginBar = document.getElementById('loginBar');
            loginBar.style.display = 'none';
            // ضبط ارتفاع منطقة المحتوى
            adjustContentAreaHeight();
        }

        // دالة ضبط ارتفاع منطقة المحتوى - تم تحسينها
        function adjustContentAreaHeight() {
            const contentArea = document.getElementById('content-area');
            const windowHeight = window.innerHeight;
            const topBarHeight = document.getElementById('topBar').offsetHeight;
            const stickyHeaderHeight = document.getElementById('stickyHeader').offsetHeight;
            const footerHeight = document.querySelector('.footer').offsetHeight;
            
            // حساب الارتفاع المناسب مع إفساح مجال أكبر
            const calculatedHeight = windowHeight - topBarHeight - stickyHeaderHeight - footerHeight - 20;
            
            // تطبيق الارتفاع مع حد أدنى
            contentArea.style.height = Math.max(calculatedHeight, 350) + 'px';
            
            console.log('📏 تم ضبط ارتفاع منطقة المحتوى:', contentArea.style.height);
        }

        // دالة لضبط iframe في صفحة 1_1k.html ليتناسب مع المساحة المتاحة
        function adjustIframeFor1_1k() {
            const iframe = document.querySelector('#content-area iframe');
            if (!iframe) return;
            
            // إرسال رسالة إلى iframe لضبط الـ padding-top
            try {
                iframe.contentWindow.postMessage({
                    type: 'adjustPadding',
                    paddingTop: 150 // ضبط مناسب ليتناسب مع الشريط العلوي
                }, '*');
            } catch (e) {
                console.log('⚠️ لا يمكن ضبط iframe - قد يكون من أصل مختلف');
            }
        }

        // دالة فتح صفحات التجارة الإلكترونية الجديدة
        function openEcommercePage(pageUrl, pageTitle) {
            let content = document.getElementById('content-area');
            
            // إغلاق القائمة الجانبية إذا كانت مفتوحة
            if (isMenuOpen) {
                closeSideMenu();
            }
            
            // إخفاء شريط تسجيل الدخول
            const loginBar = document.getElementById('loginBar');
            loginBar.style.display = 'none';
            
            // ضبط ارتفاع منطقة المحتوى
            adjustContentAreaHeight();
            
            // مسح المحتوى السابق
            content.innerHTML = '';
            
            // إنشاء iframe جديد
            content.innerHTML = `
                <div class="iframe-container">
                    <iframe src="https://e772299420-hue.github.io/Call/${pageUrl}" 
                            loading="lazy"
                            allow="fullscreen">
                    </iframe>
                </div>`;
            
            console.log('🔗 تم فتح صفحة: ' + pageTitle);
            
            // إذا كانت صفحة 1_1k.html، نضبط iframe بعد التحميل
            if (pageUrl === '1_1k.html') {
                const iframe = document.querySelector('#content-area iframe');
                iframe.onload = function() {
                    setTimeout(() => {
                        adjustIframeFor1_1k();
                    }, 500);
                };
            }
            
            // تسجيل النقر في Firebase إذا كان متاحاً
            try {
                if (typeof database !== 'undefined') {
                    const visitorData = JSON.parse(localStorage.getItem('visitorData') || '{}');
                    if (visitorData.visitorNumber) {
                        database.ref('menu_clicks').push({
                            visitorNumber: visitorData.visitorNumber,
                            pageUrl: pageUrl,
                            pageTitle: pageTitle,
                            timestamp: new Date().toISOString(),
                            source: 'navbar'
                        });
                    }
                }
            } catch (error) {
                console.error('❌ خطأ في تسجيل نقر شريط الأزرار:', error);
            }
        }

        function openLoginPage() {
            let loginUrl = '';
            
            // تحديد صفحة الدخول المناسبة بناءً على الصفحة الحالية
            if (currentPage) {
                switch(currentPage) {
                    case 'restaurants':
                        loginUrl = 'https://e772299420-hue.github.io/Call/manjr_mt.html';
                        break;
                    case 'new':
                        loginUrl = 'https://e772299420-hue.github.io/Call/manjr_tagr_snf.html';
                        break;
                    case 'haraj':
                        loginUrl = 'https://e772299420-hue.github.io/Call/1_411.html';
                        break;
                    case 'realestate':
                        loginUrl = 'https://e772299420-hue.github.io/Call/mbna.html';
                        break;
                    default:
                        loginUrl = 'https://e772299420-hue.github.io/Call/manjr_mt.html';
                }
            } else {
                loginUrl = 'https://e772299420-hue.github.io/Call/manjr_mt.html';
            }
            
            window.open(loginUrl, '_blank');
            closeSideMenu();
        }

        function logoutUser() {
            if (confirm('هل أنت متأكد من تسجيل الخروج؟')) {
                globalUser.logout();
                merchantGlobal.clearAll();
                closeSideMenu();
                alert('✅ تم تسجيل الخروج بنجاح');
            }
        }

        function openInstallChoice() {
            document.getElementById('installChoiceModal').classList.add('show');
            closeSideMenu();
        }

        function openUserProfile() {
            if (globalUser.isLoggedIn()) {
                alert('فتح صفحة الملف الشخصي...');
            } else {
                openLoginPage();
            }
            closeSideMenu();
        }

        function openOrders() {
            if (globalUser.isLoggedIn()) {
                alert('فتح صفحة الطلبات...');
            } else {
                openLoginPage();
            }
            closeSideMenu();
        }

        function openSearch() {
            alert('فتح صفحة البحث...');
        }

        function openCart() {
            alert('فتح سلة التسوق...');
        }

        function openAbout() {
            alert('فتح صفحة حول التطبيق...');
            closeSideMenu();
        }

        function openContact() {
            alert('فتح صفحة اتصل بنا...');
            closeSideMenu();
        }

        function openPrivacy() {
            alert('فتح صفحة سياسة الخصوصية...');
            closeSideMenu();
        }

        function openTerms() {
            alert('فتح صفحة شروط الاستخدام...');
            closeSideMenu();
        }

        function saveSettings() {
            alert('تم حفظ الإعدادات بنجاح ✅');
        }

        function checkScroll() {
            const elements = document.querySelectorAll('.fade-in');
            elements.forEach(el => {
                const elementTop = el.getBoundingClientRect().top;
                const elementVisible = 150;
                if (elementTop < window.innerHeight - elementVisible) {
                    el.classList.add('visible');
                }
            });
        }

        // ===== إعداد نافذة التثبيت =====
        function setupInstallChoice() {
            const modal = document.getElementById('installChoiceModal');
            const closeBtn = document.getElementById('closeInstallChoice');
            const downloadBtn = document.getElementById('downloadAppBtn');
            const installBtn = document.getElementById('installAppBtn');
            const shareBtn = document.getElementById('shareAppBtn');
            const cancelBtn = document.getElementById('cancelInstallBtn');
            
            closeBtn.addEventListener('click', () => {
                modal.classList.remove('show');
            });
            
            cancelBtn.addEventListener('click', () => {
                modal.classList.remove('show');
            });
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('show');
                }
            });
            
            downloadBtn.addEventListener('click', () => {
                downloadAppDirect();
                modal.classList.remove('show');
            });
            
            installBtn.addEventListener('click', async () => {
                if (deferredPrompt) {
                    const success = await installPWA();
                    if (success) {
                        modal.classList.remove('show');
                        alert('✅ تم بدء تثبيت التطبيق بنجاح!');
                    } else {
                        alert('❌ تم إلغاء التثبيت. يرجى استخدام خيار التحميل بدلاً من ذلك.');
                    }
                } else {
                    alert('❌ التثبيت التلقائي غير متاح. يرجى استخدام خيار التحميل بدلاً من ذلك.');
                }
            });
            
            shareBtn.addEventListener('click', () => {
                modal.classList.remove('show');
                openShareModal();
            });
        }

        // ===== إعداد نافذة المشاركة =====
        function setupShareModal() {
            const modal = document.getElementById('shareModal');
            const closeBtn = document.getElementById('closeShareModal');
            
            closeBtn.addEventListener('click', closeShareModal);
            
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeShareModal();
                }
            });
        }

        // ===== تهيئة الصفحة =====
        document.addEventListener('DOMContentLoaded', function() {
            // تهيئة نظام إدارة الصور المحسن أولاً
            EnhancedDriveImageManager.init();
            
            setTimeout(hideIntroScreen, 2000);
            
            setupInstallChoice();
            setupShareModal();
            
            const pwaInstallBtn = document.getElementById('pwaInstallBtn');
            if (pwaInstallBtn) {
                pwaInstallBtn.addEventListener('click', () => {
                    document.getElementById('installChoiceModal').classList.add('show');
                });
            }
            
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('/Call/sw.js')
                        .then((registration) => {
                            console.log('✅ Service Worker مسجل بنجاح:', registration);
                        })
                        .catch((error) => {
                            console.log('❌ فشل تسجيل Service Worker:', error);
                        });
                });
            }
            
            // تحديث بيانات القائمة عند التحميل
            globalUser.updateMenuUserInfo();
            merchantGlobal.updateMerchantData();
            
            // تحسين تحميل الصور في القائمة والشريط
            setTimeout(() => {
                // تحميل صور القائمة
                const menuImages = document.querySelectorAll('.menu-item-image');
                menuImages.forEach(img => {
                    if (img.complete) {
                        img.style.opacity = '1';
                    } else {
                        img.onload = function() {
                            this.style.opacity = '1';
                            this.style.transition = 'opacity 0.3s ease';
                        };
                    }
                });
                
                // تحميل صور شريط الأزرار
                const navbarImages = document.querySelectorAll('.navbar-button-image');
                navbarImages.forEach(img => {
                    if (img.complete) {
                        img.style.opacity = '1';
                    } else {
                        img.onload = function() {
                            this.style.opacity = '1';
                            this.style.transition = 'opacity 0.3s ease';
                        };
                    }
                });
            }, 500);
            
            // تهيئة نظام البانر المعدل
            setTimeout(() => {
                bannerManager = new StaticBannerManager();
                bannerManager.init();
            }, 1000);
            
            // تهيئة نظام السحب الأفقي لشريط الأزرار
            setTimeout(() => {
                horizontalScrollNavbar = new HorizontalScrollNavbar();
            }, 1000);
            
            // تهيئة نظام الشريط العلوي الثابت
            setTimeout(() => {
                stickyTopBar = new StickyTopBar();
            }, 500);
            
            // ضبط ارتفاع منطقة المحتوى عند تحميل الصفحة
            setTimeout(() => {
                adjustContentAreaHeight();
            }, 1500);
            
            // إعادة ضبط الارتفاع عند تغيير حجم النافذة
            window.addEventListener('resize', adjustContentAreaHeight);
            
            // استقبال الرسائل من iframe
            window.addEventListener('message', function(event) {
                if (event.data && event.data.type === 'iframeResize') {
                    // ضبط ارتفاع iframe بناءً على المحتوى
                    const iframe = document.querySelector('#content-area iframe');
                    if (iframe && event.data.height) {
                        iframe.style.height = event.data.height + 'px';
                    }
                }
            });
            
            window.addEventListener('load', checkScroll);
            window.addEventListener('scroll', checkScroll);
        });

        // ===== معالجة الأخطاء =====
        window.addEventListener('error', (event) => {
            console.error('خطأ في الصفحة:', event.error);
        });

        window.addEventListener('unhandledrejection', (event) => {
            console.error('وعد مرفوض:', event.reason);
        });

        // اختصار لوحة المفاتيح لفتح القائمة (Ctrl+M)
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.key === 'm') {
                e.preventDefault();
                if (isMenuOpen) {
                    closeSideMenu();
                } else {
                    openSideMenu();
                }
            }
            
            // اختصار لوحة المفاتيح لفتح نافذة المشاركة (Ctrl+Shift+S)
            if (e.ctrlKey && e.shiftKey && e.key === 'S') {
                e.preventDefault();
                openShareModal();
            }
            
            // اختصار لتمرير شريط الأزرار (أسهم اليمين واليسار)
            const navbar = document.getElementById('navbar');
            if (navbar && document.activeElement !== navbar) {
                if (e.key === 'ArrowRight') {
                    e.preventDefault();
                    navbar.scrollLeft += 150;
                } else if (e.key === 'ArrowLeft') {
                    e.preventDefault();
                    navbar.scrollLeft -= 150;
                }
            }
            
            // اختصار لشريط الصور المتحركة
            if (e.key === 'Escape') {
                const modals = document.querySelectorAll('.install-choice-modal.show, .share-modal.show');
                if (modals.length > 0) {
                    e.preventDefault();
                    modals.forEach(modal => modal.classList.remove('show'));
                }
            }
        });

        // ===== منع التحميل الزائد للذاكرة =====
        window.addEventListener('beforeunload', function() {
            if (horizontalScrollNavbar) {
                horizontalScrollNavbar.destroy();
            }
            if (bannerManager) {
                bannerManager.stopBannerRotation();
            }
        });
    </script>

</body>
</html>


<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>عرض الأقسام والمنتجات</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            background: #ffffff;
            margin: 0;
            padding-top: 150px; /* تم تخفيض من 180px إلى 150px */
            overflow-x: hidden;
            min-height: 100vh;
            scroll-behavior: smooth;
        }

        /* شريط الأقسام - تم تعديل المواقع */
        .category-bar {
            display: none; 
            gap: 6px; 
            padding: 12px 15px; /* زيادة padding */
            overflow-x: auto;
            background: #ffffff;
            white-space: nowrap;
            position: fixed;
            top: 0; /* البقاء في الأعلى */
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
            height: 70px; /* زيادة الارتفاع من 65px إلى 70px */
            align-items: center;
            border-bottom: 1px solid #e0e0e0;
        }

        .category-bar.has-categories {
            display: flex;
        }

        .category-bar::-webkit-scrollbar {
            display: none;
        }

        .category {
            padding: 10px 18px; /* زيادة padding */
            background: #f8f9fa;
            color: #2c3e50;
            border-radius: 20px;
            cursor: pointer; 
            transition: all 0.2s ease;
            border: 1px solid #dee2e6;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 14px; /* زيادة حجم الخط */
            flex-shrink: 0;
            min-height: 45px; /* زيادة الارتفاع الداخلي */
            min-width: auto;
            text-align: center;
        }

        .category:hover { 
            background: #007bff; 
            color: white;
            border-color: #007bff;
        }

        .category.active { 
            background: #007bff; 
            color: white;
            border-color: #007bff;
        }

        .category-icon {
            font-size: 16px; /* زيادة حجم الأيقونة */
            flex-shrink: 0;
        }

        .category-name {
            font-size: 14px; /* زيادة حجم الخط */
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 130px; /* زيادة العرض الأقصى */
        }

        /* حاوية شريط البحث - تعديل الموقع */
        .search-container {
            position: fixed;
            top: 70px; /* تعديل الموقع ليكون أسفل شريط الأقسام مباشرة */
            left: 0;
            right: 0;
            z-index: 99;
            background: white;
            padding: 12px 15px; /* زيادة padding */
            display: flex;
            align-items: center;
            gap: 12px; /* زيادة المسافة */
            border-bottom: 1px solid #e0e0e0;
            height: 65px; /* زيادة الارتفاع من 55px إلى 65px */
            margin-bottom: 0;
        }

        /* شريط البحث */
        .search-bar {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 12px; /* زيادة المسافة */
        }

        .search-input {
            flex: 1;
            padding: 12px 18px; /* زيادة padding */
            border: 1px solid #dee2e6;
            border-radius: 20px;
            font-size: 15px; /* زيادة حجم الخط */
            background: #f8f9fa;
            color: #333;
            transition: all 0.2s ease;
            text-align: right;
            height: 45px; /* زيادة الارتفاع من 38px إلى 45px */
        }

        .search-input:focus {
            outline: none;
            border-color: #007bff;
            background: white;
        }

        .search-input::placeholder {
            color: #6c757d;
            font-size: 14px; /* زيادة حجم الخط */
        }

        /* زر الفلاتر - تعديل الحجم */
        .filter-toggle-btn {
            background: #f8f9fa;
            color: #2c3e50;
            border: 1px solid #dee2e6;
            border-radius: 20px;
            padding: 10px 16px; /* زيادة padding */
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px; /* زيادة المسافة */
            font-size: 14px; /* زيادة حجم الخط */
            height: 45px; /* زيادة الارتفاع من 38px إلى 45px */
            flex-shrink: 0;
        }

        .filter-toggle-btn:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .filter-toggle-btn.active {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        /* شريط الفلاتر - تعديل الموقع والحجم */
        .filter-bar {
            position: fixed;
            top: 135px; /* تعديل الموقع ليكون أسفل شريط البحث */
            left: 0;
            right: 0;
            background: white;
            padding: 15px 18px; /* زيادة padding */
            display: none;
            flex-wrap: wrap;
            gap: 12px; /* زيادة المسافة */
            z-index: 98;
            border-bottom: 1px solid #e0e0e0;
            margin-top: 0;
        }

        .filter-bar.active {
            display: flex;
        }

        /* تعديل padding-top للجسم عندما يظهر شريط الفلاتر */
        body.filter-bar-active {
            padding-top: 210px; /* تعديل من 240px إلى 210px */
        }

        .filter-item {
            display: flex;
            align-items: center;
            gap: 10px; /* زيادة المسافة */
            flex: 1;
            min-width: 180px; /* زيادة العرض الأدنى */
        }

        .filter-item label {
            font-weight: 600;
            color: #2c3e50;
            white-space: nowrap;
            font-size: 14px; /* زيادة حجم الخط */
            min-width: 65px; /* زيادة العرض الأدنى */
        }

        .filter-item select, .filter-item input {
            padding: 10px 12px; /* زيادة padding */
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-size: 14px; /* زيادة حجم الخط */
            background: white;
            color: #333;
            transition: all 0.2s ease;
            flex: 1;
            height: 40px; /* زيادة الارتفاع من 34px إلى 40px */
        }

        .filter-item select:focus, .filter-item input:focus {
            border-color: #007bff;
            outline: none;
        }

        /* حاوية الأقسام الرئيسية */
        .category-sections-container {
            padding: 0;
            margin-top: 0;
        }

        /* قسم رئيسي */
        .main-category-section {
            margin: 0;
            padding: 0;
            scroll-margin-top: 150px; /* تعديل ليتناسب مع الـ padding الجديد */
        }

        /* حاوية الأقسام الفرعية */
        .subcategories-main-container {
            max-height: none;
            overflow: visible;
            background: transparent;
            padding: 0;
        }

        /* قسم فرعي */
        .subcategory-section {
            margin: 0;
            padding: 0;
            background: transparent;
            overflow: hidden;
        }

        /* حاوية المنتجات داخل القسم الفرعي */
        .subcategory-products-container {
            padding: 12px; /* زيادة padding */
            background: transparent;
        }

        .products-scroll-container {
            display: flex;
            overflow-x: auto;
            padding: 6px; /* زيادة padding */
            gap: 15px; /* زيادة المسافة */
            scroll-behavior: smooth;
            -ms-overflow-style: none;
            scrollbar-width: none;
            min-height: 200px; /* زيادة الارتفاع الأدنى */
            align-items: stretch;
        }

        .products-scroll-container::-webkit-scrollbar {
            display: none;
        }

        .product-item {
            flex: 0 0 auto;
            width: 180px; /* زيادة العرض من 170px إلى 180px */
            transition: all 0.2s ease;
            position: relative;
            overflow: hidden;
        }

        .product-img {
            width: 100%; 
            height: 180px; /* زيادة الارتفاع من 170px إلى 180px */
            object-fit: cover;
            cursor: pointer; 
            transition: all 0.2s ease;
            display: block;
            border-radius: 8px; /* زيادة نصف قطر الزوايا */
        }

        .product-img:hover { 
            opacity: 0.9;
        }

        .product-price {
            color: #e74c3c;
            font-weight: bold;
            text-align: center;
            font-size: 15px; /* زيادة حجم الخط */
            padding: 10px 5px; /* زيادة padding */
            direction: ltr;
            font-family: 'Segoe UI', sans-serif;
            margin-top: 8px; /* زيادة margin */
        }

        /* رسالة عدم وجود منتجات */
        .no-products-message {
            text-align: center;
            padding: 35px 18px; /* زيادة padding */
            color: #666;
            font-size: 15px; /* زيادة حجم الخط */
            grid-column: 1/-1;
            width: 100%;
        }

        .no-products-message i {
            font-size: 40px; /* زيادة حجم الأيقونة */
            margin-bottom: 12px; /* زيادة margin */
            opacity: 0.5;
        }

        /* قائمة عرض جميع المنتجات - تصغير الحجم */
        .products-modal {
            display: none;
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .products-modal.active {
            display: flex;
        }

        .products-modal-container {
            position: relative;
            width: 88%; /* تصغير من 95% إلى 88% */
            max-width: 1300px; /* تصغير من 1400px إلى 1300px */
            height: 82%; /* تصغير من 90% إلى 82% */
            background: white;
            border-radius: 12px; /* زيادة نصف قطر الزوايا */
            box-sizing: border-box;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .products-modal-header {
            padding: 18px 22px; /* زيادة padding */
            background: #007bff;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .products-modal-title {
            font-size: 20px; /* زيادة حجم الخط */
            font-weight: bold;
        }

        .products-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 28px; /* زيادة حجم الخط */
            cursor: pointer;
            width: 45px; /* زيادة الحجم */
            height: 45px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s ease;
        }

        .products-modal-close:hover {
            background: rgba(255,255,255,0.2);
        }

        .products-modal-content {
            flex: 1;
            overflow-y: auto;
            padding: 22px; /* زيادة padding */
        }

        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); /* زيادة الحجم الأدنى */
            gap: 18px; /* زيادة المسافة */
            padding: 12px; /* زيادة padding */
        }

        .modal-product-item {
            background: white;
            border-radius: 10px; /* زيادة نصف قطر الزوايا */
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid #e0e0e0;
            position: relative;
        }

        .modal-product-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
            border-color: #007bff;
        }

        .modal-product-item.active {
            border: 3px solid #007bff;
            box-shadow: 0 0 0 2px rgba(0,123,255,0.3);
        }

        .modal-product-img {
            width: 100%;
            height: 160px; /* زيادة الارتفاع من 150px إلى 160px */
            object-fit: cover;
            display: block;
            cursor: pointer;
        }

        .modal-product-info {
            padding: 12px; /* زيادة padding */
            text-align: center;
        }

        .modal-product-name {
            font-size: 15px; /* زيادة حجم الخط */
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 8px; /* زيادة margin */
            height: 45px; /* زيادة الارتفاع من 40px إلى 45px */
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }

        .modal-product-price {
            color: #e74c3c;
            font-weight: bold;
            font-size: 15px; /* زيادة حجم الخط */
            direction: ltr;
        }

        /* معرض الصور - تصغير الحجم بشكل عام */
        .image-gallery {
            display: none;
            position: fixed;
            inset: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.95);
            z-index: 3000;
            align-items: center;
            justify-content: center;
        }

        .image-gallery.active {
            display: flex;
        }

        .gallery-container {
            position: relative;
            width: 88%; /* تصغير من 95% إلى 88% */
            max-width: 1300px; /* تصغير من 1400px إلى 1300px */
            height: 82%; /* تصغير من 90% إلى 82% */
            display: flex;
            background: white;
            border-radius: 12px; /* زيادة نصف قطر الزوايا */
            box-sizing: border-box;
            overflow: hidden;
        }

        /* نصف الشاشة للصورة */
        .gallery-image-section {
            flex: 1;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f8f9fa;
            overflow: hidden;
        }

        .gallery-main-image-container {
            position: relative;
            width: 88%; /* تصغير من 90% إلى 88% */
            height: 88%; /* تصغير من 90% إلى 88% */
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .gallery-main-image {
            max-width: 100%;
            max-height: 100%;
            width: auto;
            height: auto;
            object-fit: contain;
            border-radius: 8px; /* زيادة نصف قطر الزوايا */
            cursor: pointer;
            transition: transform 0.2s ease;
        }

        .gallery-main-image.zoomed {
            transform: scale(1.5);
            cursor: zoom-out;
        }

        /* عداد الصور */
        .image-counter {
            position: absolute;
            top: 18px; /* زيادة المسافة */
            left: 18px; /* زيادة المسافة */
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 14px; /* زيادة padding */
            border-radius: 18px; /* زيادة نصف قطر الزوايا */
            font-size: 13px; /* زيادة حجم الخط */
            font-weight: bold;
            z-index: 10;
        }

        /* أزرار التنقل داخل الصورة */
        .gallery-nav-btn {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            width: 45px; /* زيادة الحجم */
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 18px; /* زيادة حجم الخط */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
        }

        .gallery-nav-btn:hover {
            background: rgba(0, 0, 0, 0.9);
        }

        .gallery-prev {
            left: 15px; /* زيادة المسافة */
        }

        .gallery-next {
            right: 15px; /* زيادة المسافة */
        }

        /* زر الإغلاق */
        .gallery-close {
            position: absolute;
            top: 15px; /* زيادة المسافة */
            right: 15px; /* زيادة المسافة */
            background: rgba(231, 76, 60, 0.9);
            color: white;
            border: none;
            width: 45px; /* زيادة الحجم */
            height: 45px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 24px; /* زيادة حجم الخط */
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 3001;
        }

        .gallery-close:hover {
            background: #c0392b;
        }

        /* نصف الشاشة لبيانات المنتج */
        .gallery-info-section {
            flex: 1;
            padding: 22px; /* زيادة padding */
            background: white;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .gallery-product-name {
            color: #2c3e50;
            font-size: 26px; /* زيادة حجم الخط */
            font-weight: bold;
            margin-bottom: 12px; /* زيادة margin */
            text-align: right;
            padding-bottom: 10px; /* زيادة padding */
            border-bottom: 1px solid #e0e0e0;
        }

        .gallery-product-price {
            color: #e74c3c;
            font-size: 22px; /* زيادة حجم الخط */
            font-weight: bold;
            margin-bottom: 18px; /* زيادة margin */
            text-align: right;
        }

        .gallery-product-description {
            color: #555;
            font-size: 15px; /* زيادة حجم الخط */
            line-height: 1.6;
            text-align: right;
            margin-bottom: 22px; /* زيادة margin */
            padding: 15px; /* زيادة padding */
            border-radius: 8px; /* زيادة نصف قطر الزوايا */
            white-space: pre-line;
            background: #f8f9fa;
        }

        .gallery-product-details {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* زيادة الحجم الأدنى */
            gap: 15px; /* زيادة المسافة */
            margin-bottom: 22px; /* زيادة margin */
        }

        .gallery-product-detail {
            background: #f8f9fa;
            padding: 15px; /* زيادة padding */
            border-radius: 8px; /* زيادة نصف قطر الزوايا */
            color: #2c3e50;
            font-size: 15px; /* زيادة حجم الخط */
            text-align: center;
            border: 1px solid #dee2e6;
        }

        .gallery-product-detail .label {
            color: #007bff;
            font-weight: bold;
            display: block;
            margin-bottom: 8px; /* زيادة margin */
            font-size: 13px; /* زيادة حجم الخط */
        }

        /* زر التاجر */
        .merchant-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 14px 22px; /* زيادة padding */
            border-radius: 8px; /* زيادة نصف قطر الزوايا */
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: bold;
            font-size: 18px; /* زيادة حجم الخط */
            text-align: center;
            display: block;
            width: 100%;
            margin: 12px 0; /* زيادة margin */
        }

        .merchant-btn:hover {
            background: #218838;
        }

        .merchant-name {
            display: block;
            font-size: 13px; /* زيادة حجم الخط */
            margin-top: 6px; /* زيادة margin */
            opacity: 0.9;
            font-weight: normal;
        }

        /* أزرار الإجراءات */
        .gallery-action-buttons {
            display: flex;
            justify-content: center;
            gap: 18px; /* زيادة المسافة */
            margin: 22px 0; /* زيادة margin */
        }

        .gallery-action-btn {
            background: #f8f9fa;
            color: #666;
            border: 1px solid #dee2e6;
            width: 55px; /* زيادة الحجم */
            height: 55px;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px; /* زيادة حجم الخط */
            position: relative;
        }

        .gallery-action-btn:hover {
            background: #007bff;
            color: white;
            border-color: #007bff;
        }

        .gallery-action-btn.like.active {
            background: #e74c3c;
            border-color: #e74c3c;
            color: white;
        }

        .gallery-action-btn.comment.active {
            background: #3498db;
            border-color: #3498db;
            color: white;
        }

        .gallery-action-btn.favorite.active {
            background: #f39c12;
            border-color: #f39c12;
            color: white;
        }

        /* العدادات */
        .action-stat {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #e74c3c;
            color: white;
            border-radius: 50%;
            width: 25px; /* زيادة الحجم */
            height: 25px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px; /* زيادة حجم الخط */
            font-weight: bold;
        }

        .comment-stat {
            background: #3498db;
        }

        .view-stat {
            background: #2ecc71;
            position: static;
            margin-left: 12px; /* زيادة margin */
            width: auto;
            height: auto;
            padding: 6px 10px; /* زيادة padding */
            border-radius: 15px; /* زيادة نصف قطر الزوايا */
            font-size: 13px; /* زيادة حجم الخط */
        }

        .stats-row {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px; /* زيادة المسافة */
            margin-top: 12px; /* زيادة margin */
        }

        /* قسم التعليقات */
        .comments-section {
            width: 100%;
            margin-top: 18px; /* زيادة margin */
            display: none;
            background: #f8f9fa;
            border-radius: 8px; /* زيادة نصف قطر الزوايا */
            padding: 18px; /* زيادة padding */
            border: 1px solid #dee2e6;
        }

        .comments-section.active {
            display: block;
        }

        .comments-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 18px; /* زيادة margin */
            padding-bottom: 10px; /* زيادة padding */
            border-bottom: 1px solid #dee2e6;
        }

        .comments-title {
            font-size: 18px; /* زيادة حجم الخط */
            font-weight: bold;
            color: #007bff;
        }

        .close-comments {
            background: none;
            border: none;
            color: #e74c3c;
            font-size: 28px; /* زيادة حجم الخط */
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .close-comments:hover {
            color: #c0392b;
        }

        .comments-list {
            max-height: 320px; /* زيادة الارتفاع الأقصى */
            overflow-y: auto;
            margin-bottom: 18px; /* زيادة margin */
            padding: 10px; /* زيادة padding */
            background: white;
            border-radius: 8px; /* زيادة نصف قطر الزوايا */
        }

        .comment-item {
            padding: 14px; /* زيادة padding */
            margin-bottom: 12px; /* زيادة margin */
            background: white;
            border-radius: 8px; /* زيادة نصف قطر الزوايا */
            border-right: 4px solid #007bff; /* زيادة السماكة */
            transition: all 0.2s ease;
        }

        .comment-item:hover {
            background: #f8f9fa;
        }

        .comment-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px; /* زيادة margin */
            font-weight: bold;
        }

        .comment-date {
            color: #666;
            font-size: 13px; /* زيادة حجم الخط */
        }

        .comment-text {
            line-height: 1.5;
            font-size: 15px; /* زيادة حجم الخط */
            color: #333;
            text-align: right;
            direction: rtl;
        }

        .add-comment {
            border-top: 1px solid #dee2e6;
            padding-top: 18px; /* زيادة padding */
        }

        .comment-form {
            display: flex;
            flex-direction: column;
            gap: 12px; /* زيادة المسافة */
        }

        .comment-form textarea {
            width: 100%;
            padding: 14px; /* زيادة padding */
            border: 1px solid #dee2e6;
            border-radius: 8px; /* زيادة نصف قطر الزوايا */
            resize: vertical;
            min-height: 90px; /* زيادة الارتفاع الأدنى */
            font-family: inherit;
            font-size: 15px; /* زيادة حجم الخط */
            background: white;
            color: #333;
            transition: all 0.2s ease;
            text-align: right;
            direction: rtl;
        }

        .comment-form textarea:focus {
            border-color: #007bff;
            outline: none;
        }

        .comment-form button {
            padding: 12px 22px; /* زيادة padding */
            background: #007bff;
            color: white;
            border: none;
            border-radius: 8px; /* زيادة نصف قطر الزوايا */
            cursor: pointer;
            align-self: flex-end;
            transition: all 0.2s ease;
            font-size: 15px; /* زيادة حجم الخط */
            font-weight: bold;
        }

        .comment-form button:hover {
            background: #0056b3;
        }

        .no-comments {
            text-align: center;
            padding: 22px; /* زيادة padding */
            color: #666;
            font-style: italic;
        }

        /* تحسينات للجوال - تحديث جميع القيم لتتناسب مع التغييرات */
        @media (max-width: 768px) {
            body {
                padding-top: 130px; /* تعديل ليتناسب مع التغييرات */
            }
            
            body.filter-bar-active {
                padding-top: 190px; /* تعديل ليتناسب مع التغييرات */
            }

            .search-container {
                top: 70px; /* تعديل الموقع */
                padding: 10px 12px; /* تعديل padding */
                height: 55px; /* تعديل الارتفاع */
                gap: 10px; /* تعديل المسافة */
            }

            .search-input {
                padding: 10px 14px; /* تعديل padding */
                font-size: 14px; /* تعديل حجم الخط */
                height: 38px; /* تعديل الارتفاع */
                border-radius: 20px;
            }

            .filter-toggle-btn {
                padding: 8px 12px; /* تعديل padding */
                font-size: 13px; /* تعديل حجم الخط */
                height: 38px; /* تعديل الارتفاع */
                gap: 6px; /* تعديل المسافة */
                border-radius: 20px;
            }

            .filter-bar {
                top: 125px; /* تعديل الموقع */
                padding: 12px 15px; /* تعديل padding */
                gap: 10px; /* تعديل المسافة */
            }

            .category-bar {
                padding: 10px 12px; /* تعديل padding */
                height: 60px; /* تعديل الارتفاع */
                gap: 06px; /* تعديل المسافة */
            }

            .category {
                padding: 8px 14px; /* تعديل padding */
                font-size: 13px; /* تعديل حجم الخط */
                min-height: 40px; /* تعديل الارتفاع الداخلي */
                gap: 6px; /* تعديل المسافة */
            }

            .category-name {
                font-size: 12px; /* تعديل حجم الخط */
                max-width: 100px; /* تعديل العرض الأقصى */
            }

            .category-icon {
                font-size: 14px; /* تعديل حجم الأيقونة */
            }

            .subcategory-products-container {
                padding: 10px; /* تعديل padding */
            }

            .products-scroll-container {
                padding: 5px; /* تعديل padding */
                gap: 12px; /* تعديل المسافة */
                min-height: 180px; /* تعديل الارتفاع الأدنى */
            }

            .product-item {
                width: 160px; /* تعديل العرض */
            }

            .product-img {
                height: 160px; /* تعديل الارتفاع */
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); /* تعديل الحجم الأدنى */
                gap: 15px; /* تعديل المسافة */
            }

            .modal-product-img {
                height: 140px; /* تعديل الارتفاع */
            }

            .modal-product-name {
                font-size: 13px; /* تعديل حجم الخط */
                height: 40px; /* تعديل الارتفاع */
            }

            .gallery-container {
                flex-direction: column;
                width: 92%; /* تعديل العرض */
                height: 88%; /* تعديل الارتفاع */
            }

            .gallery-info-section {
                padding: 18px; /* تعديل padding */
            }

            .gallery-nav-btn {
                width: 40px; /* تعديل الحجم */
                height: 40px;
                font-size: 16px; /* تعديل حجم الخط */
            }

            .gallery-product-name {
                font-size: 22px; /* تعديل حجم الخط */
            }

            .gallery-product-price {
                font-size: 20px; /* تعديل حجم الخط */
            }

            .gallery-product-details {
                grid-template-columns: 1fr;
            }

            .gallery-action-buttons {
                gap: 15px; /* تعديل المسافة */
            }

            .gallery-action-btn {
                width: 50px; /* تعديل الحجم */
                height: 50px;
                font-size: 18px; /* تعديل حجم الخط */
            }

            .image-counter {
                top: 12px; /* تعديل المسافة */
                left: 12px; /* تعديل المسافة */
                font-size: 11px; /* تعديل حجم الخط */
                padding: 5px 10px; /* تعديل padding */
            }

            .products-modal-container {
                width: 92%; /* تعديل العرض */
                height: 88%; /* تعديل الارتفاع */
            }
        }

        @media (max-width: 480px) {
            body {
                padding-top: 120px; /* تعديل ليتناسب مع التغييرات */
            }
            
            body.filter-bar-active {
                padding-top: 180px; /* تعديل ليتناسب مع التغييرات */
            }

            .search-container {
                top: 70px; /* تعديل الموقع */
                padding: 8px 10px; /* تعديل padding */
                height: 50px; /* تعديل الارتفاع */
            }

            .search-input {
                padding: 8px 12px; /* تعديل padding */
                font-size: 13px; /* تعديل حجم الخط */
                height: 36px; /* تعديل الارتفاع */
            }

            .filter-toggle-btn {
                padding: 6px 10px; /* تعديل padding */
                font-size: 12px; /* تعديل حجم الخط */
                height: 36px; /* تعديل الارتفاع */
            }

            .filter-bar {
                top: 120px; /* تعديل الموقع */
                padding: 10px 12px; /* تعديل padding */
            }

            .category-bar {
                padding: 8px 10px;/* تعديل padding */
                height: 55px; /* تعديل الارتفاع */
            }

            .category {
                padding: 6px 12px; /* تعديل padding */
                font-size: 11px; /* تعديل حجم الخط */
                min-height: 36px; /* تعديل الارتفاع الداخلي */
                gap: 5px; /* تعديل المسافة */
            }

            .category-name {
                font-size: 10px; /* تعديل حجم الخط */
                max-width: 80px; /* تعديل العرض الأقصى */
                display: inline-block !important;
            }

            .category-icon {
                font-size: 12px; /* تعديل حجم الأيقونة */
            }

            .subcategory-products-container {
                padding: 8px; /* تعديل padding */
            }

            .products-scroll-container {
                padding: 4px; /* تعديل padding */
                gap: 10px; /* تعديل المسافة */
                min-height: 160px; /* تعديل الارتفاع الأدنى */
            }

            .product-item {
                width: 140px; /* تعديل العرض */
            }

            .product-img {
                height: 140px; /* تعديل الارتفاع */
            }

            .products-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); /* تعديل الحجم الأدنى */
                gap: 12px; /* تعديل المسافة */
            }

            .modal-product-img {
                height: 120px; /* تعديل الارتفاع */
            }

            .modal-product-name {
                font-size: 12px; /* تعديل حجم الخط */
                height: 36px; /* تعديل الارتفاع */
            }

            .products-modal-container {
                width: 95%; /* تعديل العرض */
                height: 90%; /* تعديل الارتفاع */
            }

            .gallery-container {
                width: 100%; /* تعديل العرض */
                height: 100%; /* تعديل الارتفاع */
                border-radius: 0; /* إزالة الزوايا المستديرة */
            }

            .gallery-product-name {
                font-size: 20px; /* تعديل حجم الخط */
            }

            .gallery-product-price {
                font-size: 18px; /* تعديل حجم الخط */
            }
        }

        @media (max-width: 360px) {
            .category-bar {
                padding: 6px 8px; /* تعديل padding */
                height: 50px; /* تعديل الارتفاع */
            }
            
            .category {
                padding: 5px 10px; /* تعديل padding */
                font-size: 10px; /* تعديل حجم الخط */
                min-height: 34px; /* تعديل الارتفاع الداخلي */
                min-width: 70px; /* تعديل العرض الأدنى */
                gap: 4px; /* تعديل المسافة */
            }
            
            .category-name {
                font-size: 9px; /* تعديل حجم الخط */
                max-width: 60px; /* تعديل العرض الأقصى */
                display: inline-block !important;
            }
            
            .category-icon {
                font-size: 11px; /* تعديل حجم الأيقونة */
            }
        }
    </style>
</head>
<body>
    <!-- شريط الأقسام الرئيسية -->
    <div id="categories" class="category-bar"></div>

    <!-- حاوية شريط البحث -->
    <div class="search-container" id="search-container">
        <div class="search-bar" id="search-bar">
            <input type="text" id="search-input" class="search-input" placeholder="ابحث عن منتج...">
        </div>
        <button class="filter-toggle-btn" id="filter-toggle">
            <i class="fas fa-filter"></i>
        </button>
    </div>

    <!-- شريط الفلاتر -->
    <div class="filter-bar" id="filter-bar">
        <div class="filter-item">
            <label for="governorate">المحافظة:</label>
            <select id="governorate">
                <option value="">جميع المحافظات</option>
            </select>
        </div>
        <div class="filter-item">
            <label for="region">المنطقة:</label>
            <select id="region">
                <option value="">جميع المناطق</option>
            </select>
        </div>
        <div class="filter-item">
            <label for="merchant">التاجر:</label>
            <select id="merchant">
                <option value="">جميع التجار</option>
            </select>
        </div>
        <div class="filter-item">
            <label for="category-filter">القسم:</label>
            <select id="category-filter">
                <option value="">جميع الأقسام</option>
            </select>
        </div>
        <div class="filter-item">
            <label for="subcategory-filter">القسم الفرعي:</label>
            <select id="subcategory-filter">
                <option value="">جميع الأقسام الفرعية</option>
            </select>
        </div>
        <div class="filter-item">
            <label for="sort-by">ترتيب حسب:</label>
            <select id="sort-by">
                <option value="date">الأحدث</option>
                <option value="name">الاسم</option>
                <option value="price">السعر</option>
            </select>
        </div>
    </div>

    <!-- حاوية الأقسام الرئيسية -->
    <div id="category-sections" class="category-sections-container">
        <!-- سيتم إنشاء الأقسام الرئيسية هنا ديناميكياً -->
    </div>

    <!-- قائمة عرض جميع المنتجات -->
    <div class="products-modal" id="products-modal">
        <div class="products-modal-container">
            <div class="products-modal-header">
                <div class="products-modal-title" id="products-modal-title">جميع المنتجات</div>
                <button class="products-modal-close" id="products-modal-close">×</button>
            </div>
            <div class="products-modal-content">
                <div class="products-grid" id="products-grid">
                    <!-- سيتم إضافة المنتجات هنا ديناميكياً -->
                </div>
            </div>
        </div>
    </div>

    <!-- معرض الصور -->
    <div class="image-gallery" id="image-gallery">
        <div class="gallery-container">
            <!-- زر الإغلاق -->
            <button class="gallery-close" id="gallery-close">×</button>
            
            <!-- نصف الشاشة للصورة -->
            <div class="gallery-image-section">
                <div class="gallery-main-image-container">
                    <!-- عداد الصور -->
                    <div class="image-counter" id="image-counter">1/1</div>
                    
                    <img id="gallery-main-image" class="gallery-main-image" alt="صورة المنتج">
                    
                    <!-- أزرار التنقل -->
                    <button class="gallery-nav-btn gallery-prev" id="gallery-prev">
                        <i class="fas fa-chevron-right"></i>
                    </button>
                    <button class="gallery-nav-btn gallery-next" id="gallery-next">
                        <i class="fas fa-chevron-left"></i>
                    </button>
                </div>
            </div>

            <!-- نصف الشاشة لبيانات المنتج -->
            <div class="gallery-info-section">
                <div class="gallery-product-name" id="gallery-product-name-full"></div>
                <div class="gallery-product-price" id="gallery-product-price"></div>
                <div class="gallery-product-description" id="gallery-product-description"></div>
                
                <!-- زر التاجر -->
                <button class="merchant-btn" id="merchant-btn">
                    <span id="merchant-name-text"></span>
                </button>
                
                <div class="gallery-product-details" id="gallery-product-details">
                    <!-- تفاصيل المنتج ستُدرج هنا -->
                </div>
                
                <!-- أزرار الإجراءات -->
                <div class="gallery-action-buttons">
                    <button class="gallery-action-btn like" id="like-btn">
                        <i class="fas fa-thumbs-up"></i>
                        <div class="action-stat" id="like-count">0</div>
                    </button>
                    <button class="gallery-action-btn comment" id="comment-btn">
                        <i class="fas fa-comments"></i>
                        <div class="action-stat comment-stat" id="comment-count">0</div>
                    </button>
                    <button class="gallery-action-btn share" id="share-btn">
                        <i class="fas fa-share"></i>
                    </button>
                    <button class="gallery-action-btn favorite" id="favorite-btn">
                        <i class="fas fa-heart"></i>
                    </button>
                </div>

                <!-- عداد المشاهدات -->
                <div class="stats-row">
                    <div class="action-stat view-stat" id="view-count">150</div>
                </div>

                <!-- قسم التعليقات -->
                <div class="comments-section" id="comments-section">
                    <div class="comments-header">
                        <div class="comments-title">التعليقات</div>
                        <button class="close-comments" id="close-comments">×</button>
                    </div>
                    <div class="comments-list" id="comments-list">
                        <div class="no-comments">لا توجد تعليقات بعد</div>
                    </div>
                    <div class="add-comment">
                        <div class="comment-form">
                            <textarea id="comment-text" placeholder="اكتب تعليقك هنا..."></textarea>
                            <button id="submit-comment">إرسال التعليق</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase + JavaScript -->
    <script type="module">
        // استقبال رسائل من الصفحة الأم لضبط التنسيقات
        window.addEventListener('message', function(event) {
            if (event.data && event.data.type === 'adjustPadding') {
                // ضبط padding-top للجسم بناءً على الرسالة المستلمة
                document.body.style.paddingTop = event.data.paddingTop + 'px';
                
                // ضبط scroll-margin-top للأقسام الرئيسية
                document.querySelectorAll('.main-category-section').forEach(section => {
                    section.style.scrollMarginTop = event.data.paddingTop + 'px';
                });
                
                console.log('✅ تم ضبط التنسيقات بناءً على رسالة الصفحة الأم');
            }
        });

        // إرسال رسالة للصفحة الأم عند تحميل الصفحة للإبلاغ عن الحجم الحقيقي
        window.addEventListener('load', function() {
            // إرسال حجم iframe الحقيقي للصفحة الأم
            window.parent.postMessage({
                type: 'iframeResize',
                height: document.body.scrollHeight
            }, '*');
            
            console.log('📏 تم إرسال حجم الصفحة الحقيقي للصفحة الأم');
        });

        // 🔥 ربط Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
        import { getDatabase, ref, onValue, set, get, update } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "chat-fat-free.firebaseapp.com",
            databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com",
            projectId: "chat-fat-free",
            storageBucket: "chat-fat-free.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // ✅ تحميل البيانات
        const categoriesRef = ref(db, "categories");
        const subcategoriesRef = ref(db, "subcategories");
        const productsRef = ref(db, "products");
        const merchantsRef = ref(db, "merchants");
        const governoratesRef = ref(db, "governorates");
        const regionsRef = ref(db, "regions");
        
        const categoriesBar = document.getElementById("categories");
        const categorySectionsContainer = document.getElementById("category-sections");
        const searchInput = document.getElementById("search-input");
        const filterToggle = document.getElementById("filter-toggle");
        const filterBar = document.getElementById("filter-bar");

        let allProducts = {};
        let allCategories = {};
        let allSubcategories = {};
        let allMerchants = {};
        let allGovernorates = {};
        let allRegions = {};
        let categoryProductCounts = {};
        let subcategoryProductCounts = {};
        let merchantProductCounts = {};

        // متغيرات معرض الصور
        let galleryImages = [];
        let currentGalleryIndex = 0;
        let currentProduct = null;
        let currentProductId = null;
        let isImageZoomed = false;

        // متغيرات قائمة المنتجات
        let currentModalCategoryId = null;
        let currentModalSubcategoryId = null;
        let modalProducts = [];
        let selectedModalProductIndex = 0;

        // المفضلة والإعجابات
        let favoriteProducts = JSON.parse(localStorage.getItem('favoriteProducts')) || {};
        let userLikes = JSON.parse(localStorage.getItem('userLikes')) || {};

        // متغيرات التتبع
        let activeCategoryId = null;
        let isManualScroll = false;
        let categoryExpandedStates = {};
        let categoryIcons = {};

        // تعيين الأيقونات للأقسام
        const defaultCategoryIcons = {
            'ملابس': 'fas fa-tshirt',
            'أزياء': 'fas fa-tshirt',
            'أجهزة': 'fas fa-laptop',
            'إلكترونيات': 'fas fa-laptop',
            'أثاث': 'fas fa-couch',
            'منزل': 'fas fa-home',
            'سيارات': 'fas fa-car',
            'مركبات': 'fas fa-car',
            'طعام': 'fas fa-utensils',
            'مأكولات': 'fas fa-utensils',
            'رياضة': 'fas fa-futbol',
            'لياقة': 'fas fa-dumbbell',
            'ألعاب': 'fas fa-gamepad',
            'ترفيه': 'fas fa-gamepad',
            'كتب': 'fas fa-book',
            'قرطاسية': 'fas fa-book',
            'تجميل': 'fas fa-paint-brush',
            'جمال': 'fas fa-spa',
            'صحة': 'fas fa-heartbeat',
            'طبية': 'fas fa-heartbeat',
            'أخرى': 'fas fa-box',
            'متنوع': 'fas fa-boxes'
        };

        // تحميل جميع البيانات
        Promise.all([
            new Promise(resolve => onValue(categoriesRef, resolve)),
            new Promise(resolve => onValue(subcategoriesRef, resolve)),
            new Promise(resolve => onValue(productsRef, resolve)),
            new Promise(resolve => onValue(merchantsRef, resolve)),
            new Promise(resolve => onValue(governoratesRef, resolve)),
            new Promise(resolve => onValue(regionsRef, resolve))
        ]).then(([categoriesSnap, subcategoriesSnap, productsSnap, merchantsSnap, governoratesSnap, regionsSnap]) => {
            allCategories = categoriesSnap.val() || {};
            allSubcategories = subcategoriesSnap.val() || {};
            allProducts = productsSnap.val() || {};
            allMerchants = merchantsSnap.val() || {};
            allGovernorates = governoratesSnap.val() || {};
            allRegions = regionsSnap.val() || {};

            // تحضير أيقونات الأقسام
            prepareCategoryIcons();
            
            // حساب عدد المنتجات
            calculateProductCounts();
            
            // عرض الأقسام الرئيسية
            displayCategories();
            
            // تحميل الفلاتر
            populateFilters();
            
            // عرض أقسام المنتجات
            displayCategorySections();

            // إعداد مستمعي الأحداث
            setupEventListeners();

            // تمييز القسم الأول افتراضياً
            setTimeout(() => {
                const firstCategory = Object.keys(allCategories)
                    .filter(catId => (calculateCategoryCountsWithFilters()[catId] || 0) > 0)
                    .sort((a, b) => (calculateCategoryCountsWithFilters()[b] || 0) - (calculateCategoryCountsWithFilters()[a] || 0))[0];
                
                if (firstCategory) {
                    setActiveCategory(firstCategory, true, true);
                }
            }, 500);
        });

        // تحضير أيقونات الأقسام
        function prepareCategoryIcons() {
            for (let catId in allCategories) {
                const category = allCategories[catId];
                let foundIcon = 'fas fa-box';
                
                // البحث عن أيقونة مناسبة بناءً على اسم القسم
                for (let keyword in defaultCategoryIcons) {
                    if (category.name && category.name.includes(keyword)) {
                        foundIcon = defaultCategoryIcons[keyword];
                        break;
                    }
                }
                
                categoryIcons[catId] = foundIcon;
            }
        }

        // حساب عدد المنتجات
        function calculateProductCounts() {
            categoryProductCounts = {};
            subcategoryProductCounts = {};
            merchantProductCounts = {};
            
            for (let productId in allProducts) {
                const product = allProducts[productId];
                
                if (product.category) {
                    categoryProductCounts[product.category] = (categoryProductCounts[product.category] || 0) + 1;
                }
                
                if (product.subcategory) {
                    subcategoryProductCounts[product.subcategory] = (subcategoryProductCounts[product.subcategory] || 0) + 1;
                }
                
                if (product.userId) {
                    merchantProductCounts[product.userId] = (merchantProductCounts[product.userId] || 0) + 1;
                }
            }
        }

        // حساب عدد المنتجات مع مراعاة الفلاتر
        function calculateCategoryCountsWithFilters() {
            const filters = getCurrentFilters();
            const counts = {};
            
            for (let productId in allProducts) {
                const product = allProducts[productId];
                
                if (!passesFilters(product, filters)) {
                    continue;
                }

                if (product.category) {
                    counts[product.category] = (counts[product.category] || 0) + 1;
                }
            }
            
            return counts;
        }

        // التحقق من أن التاجر
        function isMerchant(merchantData) {
            return merchantData && 
                   (merchantData.role === 'تاجر' || 
                    merchantData.job === 'تاجر' || 
                    merchantData.type === 'تاجر' ||
                    merchantData.userType === 'تاجر' ||
                    (merchantData.categories && Object.keys(merchantData.categories).length > 0));
        }

        // عرض الأقسام الرئيسية في الشريط العلوي
        function displayCategories() {
            categoriesBar.innerHTML = '';
            
            const currentCounts = calculateCategoryCountsWithFilters();
            
            const sortedCategories = Object.keys(allCategories)
                .filter(catId => {
                    const productCount = currentCounts[catId] || 0;
                    return productCount > 0;
                })
                .sort((a, b) => {
                    return (currentCounts[b] || 0) - (currentCounts[a] || 0);
                });
            
            if (sortedCategories.length === 0) {
                categoriesBar.classList.remove('has-categories');
                categoriesBar.style.display = 'none';
                return;
            }
            
            categoriesBar.classList.add('has-categories');
            categoriesBar.style.display = 'flex';
            
            sortedCategories.forEach(catId => {
                const icon = categoryIcons[catId] || 'fas fa-box';
                const categoryName = allCategories[catId].name || 'قسم';
                
                const div = document.createElement("div");
                div.className = "category";
                div.dataset.categoryId = catId;
                div.innerHTML = `
                    <i class="${icon} category-icon"></i>
                    <span class="category-name">${categoryName}</span>
                `;
                div.onclick = () => {
                    setActiveCategory(catId, true);
                    scrollToCategorySection(catId);
                };
                categoriesBar.appendChild(div);
            });
        }

        // عرض جميع الأقسام الرئيسية
        function displayCategorySections() {
            categorySectionsContainer.innerHTML = '';
            
            const currentCounts = calculateCategoryCountsWithFilters();
            
            const sortedCategories = Object.keys(allCategories)
                .filter(catId => {
                    const productCount = currentCounts[catId] || 0;
                    return productCount > 0;
                })
                .sort((a, b) => {
                    return (currentCounts[b] || 0) - (currentCounts[a] || 0);
                });
            
            if (sortedCategories.length === 0) {
                categorySectionsContainer.innerHTML = `
                    <div class="no-products-message">
                        <i class="fas fa-box-open"></i>
                        <p>لا توجد أقسام تحتوي على منتجات</p>
                    </div>
                `;
                return;
            }
            
            sortedCategories.forEach(catId => {
                if (!categoryExpandedStates[catId]) {
                    categoryExpandedStates[catId] = true;
                }
                
                const categorySection = document.createElement("div");
                categorySection.className = `main-category-section ${catId === activeCategoryId ? 'active-section' : ''}`;
                categorySection.id = `main-category-${catId}`;
                categorySection.dataset.categoryId = catId;
                
                const subcategoriesContainer = document.createElement("div");
                subcategoriesContainer.className = `subcategories-main-container ${categoryExpandedStates[catId] ? 'active' : ''}`;
                subcategoriesContainer.id = `subcategories-${catId}`;
                
                categorySection.appendChild(subcategoriesContainer);
                categorySectionsContainer.appendChild(categorySection);
                
                displaySubcategoriesForCategory(catId);
            });
        }

        // دالة لحساب عدد المنتجات في الأقسام الفرعية مع مراعاة الفلاتر
        function calculateSubcategoryProductCounts(categoryId, filters) {
            const subcategoryCounts = {};
            let uncategorizedCount = 0;
            
            for (let productId in allProducts) {
                const product = allProducts[productId];
                
                // التحقق من أن المنتج ينتمي للقسم الرئيسي
                if (product.category !== categoryId) {
                    continue;
                }
                
                // تطبيق الفلاتر
                if (!passesFilters(product, filters)) {
                    continue;
                }
                
                // حساب المنتجات غير المرتبطة بقسم فرعي
                if (!product.subcategory || !allSubcategories[product.subcategory]) {
                    uncategorizedCount++;
                } 
                // حساب المنتجات المرتبطة بأقسام فرعية
                else if (product.subcategory) {
                    subcategoryCounts[product.subcategory] = (subcategoryCounts[product.subcategory] || 0) + 1;
                }
            }
            
            return {
                subcategoryCounts,
                uncategorizedCount
            };
        }

        // دالة لجمع وتصنيف جميع الأقسام الفرعية والمنتجات غير المصنفة
        function getAllSectionsToDisplay(categoryId) {
            const filters = getCurrentFilters();
            
            // جمع الأقسام الفرعية للقسم الرئيسي
            const subcategoriesForCategory = {};
            for (let subcatId in allSubcategories) {
                const subcategory = allSubcategories[subcatId];
                if (subcategory.parentId === categoryId) {
                    subcategoriesForCategory[subcatId] = subcategory;
                }
            }
            
            // حساب عدد المنتجات لكل قسم
            const counts = calculateSubcategoryProductCounts(categoryId, filters);
            
            // إنشاء مصفوفة تحتوي على جميع الأقسام (الفرعية + غير المصنفة)
            const allSections = [];
            
            // إضافة قسم المنتجات غير المصنفة إذا كان يحتوي على منتجات
            if (counts.uncategorizedCount > 0) {
                allSections.push({
                    id: 'uncategorized',
                    name: 'منتجات عامة',
                    type: 'uncategorized',
                    count: counts.uncategorizedCount,
                    products: []
                });
            }
            
            // إضافة الأقسام الفرعية التي تحتوي على منتجات
            for (let subcatId in subcategoriesForCategory) {
                const productCount = counts.subcategoryCounts[subcatId] || 0;
                if (productCount > 0) {
                    allSections.push({
                        id: subcatId,
                        name: subcategoriesForCategory[subcatId].name,
                        type: 'subcategory',
                        count: productCount,
                        products: []
                    });
                }
            }
            
            // ترتيب الأقسام تنازلياً حسب عدد المنتجات
            allSections.sort((a, b) => b.count - a.count);
            
            return allSections;
        }

        // عرض الأقسام الفرعية والمنتجات غير المصنفة مع الترتيب الصحيح
        function displaySubcategoriesForCategory(categoryId) {
            const subcategoriesContainer = document.getElementById(`subcategories-${categoryId}`);
            if (!subcategoriesContainer) return;
            
            subcategoriesContainer.innerHTML = '';
            
            const allSections = getAllSectionsToDisplay(categoryId);
            
            if (allSections.length === 0) {
                displayProductsForCategory(categoryId, subcategoriesContainer);
                return;
            }
            
            // عرض كل قسم حسب الترتيب
            allSections.forEach(section => {
                if (section.type === 'uncategorized') {
                    // عرض المنتجات غير المصنفة (بدون عنوان)
                    displayUncategorizedProducts(categoryId, subcategoriesContainer, section);
                } else {
                    // عرض القسم الفرعي
                    const subcategorySection = document.createElement("div");
                    subcategorySection.className = "subcategory-section";
                    subcategorySection.id = `subcategory-section-${section.id}`;
                    subcategorySection.dataset.subcategoryId = section.id;
                    
                    const productsContainer = document.createElement("div");
                    productsContainer.className = "subcategory-products-container";
                    productsContainer.id = `subcategory-products-${section.id}`;
                    
                    const productsScrollContainer = document.createElement("div");
                    productsScrollContainer.className = "products-scroll-container";
                    productsScrollContainer.id = `products-scroll-${section.id}`;
                    
                    productsContainer.appendChild(productsScrollContainer);
                    subcategorySection.appendChild(productsContainer);
                    subcategoriesContainer.appendChild(subcategorySection);
                    
                    displayProductsForSubcategory(section.id);
                }
            });
        }

        // عرض المنتجات غير المصنفة (بدون قسم فرعي وبدون عنوان)
        function displayUncategorizedProducts(categoryId, container, sectionData) {
            const uncategorizedSection = document.createElement("div");
            uncategorizedSection.className = "subcategory-section";
            uncategorizedSection.id = `subcategory-section-uncategorized-${categoryId}`;
            
            const productsContainer = document.createElement("div");
            productsContainer.className = "subcategory-products-container";
            productsContainer.id = `subcategory-products-uncategorized-${categoryId}`;
            
            const productsScrollContainer = document.createElement("div");
            productsScrollContainer.className = "products-scroll-container";
            productsScrollContainer.id = `products-scroll-uncategorized-${categoryId}`;
            
            productsContainer.appendChild(productsScrollContainer);
            uncategorizedSection.appendChild(productsContainer);
            container.appendChild(uncategorizedSection);
            
            // عرض المنتجات غير المصنفة
            const filters = getCurrentFilters();
            const categoryProducts = getProductsByCategory(categoryId, filters);
            const uncategorizedProducts = categoryProducts.filter(product => !product.subcategory || !allSubcategories[product.subcategory]);
            
            displayProductsInContainer(uncategorizedProducts, productsScrollContainer, categoryId);
        }

        // عرض منتجات القسم الفرعي
        function displayProductsForSubcategory(subcategoryId) {
            const productsScrollContainer = document.getElementById(`products-scroll-${subcategoryId}`);
            if (!productsScrollContainer) return;
            
            productsScrollContainer.innerHTML = '';
            
            const filters = getCurrentFilters();
            const subcategoryProducts = getProductsBySubcategory(subcategoryId, filters);
            
            if (subcategoryProducts.length === 0) {
                const noProductsMessage = document.createElement("div");
                noProductsMessage.className = "no-products-message";
                noProductsMessage.innerHTML = `
                    <i class="fas fa-box"></i>
                    <p>لا توجد منتجات في هذا القسم الفرعي</p>
                `;
                productsScrollContainer.appendChild(noProductsMessage);
                return;
            }
            
            displayProductsInContainer(subcategoryProducts, productsScrollContainer, null, subcategoryId);
        }

        // عرض منتجات القسم الرئيسي مباشرة
        function displayProductsForCategory(categoryId, container) {
            const filters = getCurrentFilters();
            const categoryProducts = getProductsByCategory(categoryId, filters);
            
            if (categoryProducts.length === 0) {
                const noProductsMessage = document.createElement("div");
                noProductsMessage.className = "no-products-message";
                noProductsMessage.innerHTML = `
                    <i class="fas fa-box"></i>
                    <p>لا توجد منتجات في هذا القسم</p>
                `;
                container.appendChild(noProductsMessage);
                return;
            }
            
            const productsScrollContainer = document.createElement("div");
            productsScrollContainer.className = "products-scroll-container";
            productsScrollContainer.id = `products-scroll-category-${categoryId}`;
            
            container.appendChild(productsScrollContainer);
            
            displayProductsInContainer(categoryProducts, productsScrollContainer, categoryId);
        }

        // عرض المنتجات في حاوية محددة
        function displayProductsInContainer(products, container, categoryId = null, subcategoryId = null) {
            products.forEach((productData, index) => {
                const product = productData;
                const id = productData.id;
                const imageUrls = extractImageUrls(product);
                
                const productItem = document.createElement("div");
                productItem.className = "product-item";
                productItem.dataset.productIndex = index;
                productItem.dataset.productId = id;
                productItem.dataset.categoryId = categoryId || product.category;
                productItem.dataset.subcategoryId = subcategoryId || product.subcategory;
                
                const img = document.createElement("img");
                const imageUrl = imageUrls[0] || '';
                if (imageUrl) {
                    img.src = formatDriveUrl(imageUrl, 'thumb');
                    img.alt = product.name || 'منتج';
                    img.addEventListener('click', (e) => {
                        // فتح قائمة جميع المنتجات بدلاً من فتح المعرض مباشرة
                        e.stopPropagation();
                        openProductsModal(product, categoryId || product.category, subcategoryId || product.subcategory, index);
                    });
                } else {
                    img.src = 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w800';
                    img.alt = 'صورة افتراضية';
                    img.addEventListener('click', (e) => {
                        e.stopPropagation();
                        openProductsModal(product, categoryId || product.category, subcategoryId || product.subcategory, index);
                    });
                }
                img.className = "product-img";
                
                const priceElement = document.createElement("div");
                priceElement.className = "product-price";
                const price = product.price ? parseFloat(product.price) : 0;
                priceElement.textContent = `${price} ريال`;
                
                productItem.appendChild(img);
                productItem.appendChild(priceElement);
                container.appendChild(productItem);
            });
        }

        // فتح قائمة عرض جميع المنتجات
        function openProductsModal(product, categoryId, subcategoryId, productIndex) {
            currentModalCategoryId = categoryId;
            currentModalSubcategoryId = subcategoryId;
            selectedModalProductIndex = productIndex;
            
            // جمع المنتجات المراد عرضها
            const filters = getCurrentFilters();
            let productsToShow = [];
            
            if (subcategoryId && subcategoryId !== 'uncategorized') {
                // عرض منتجات القسم الفرعي فقط
                productsToShow = getProductsBySubcategory(subcategoryId, filters);
            } else {
                // عرض منتجات القسم الرئيسي فقط
                productsToShow = getProductsByCategory(categoryId, filters);
            }
            
            modalProducts = productsToShow;
            
            // تحديث عنوان القائمة
            const modalTitle = document.getElementById('products-modal-title');
            const categoryName = allCategories[categoryId]?.name || 'قسم';
            
            if (subcategoryId && subcategoryId !== 'uncategorized' && allSubcategories[subcategoryId]) {
                const subcategoryName = allSubcategories[subcategoryId]?.name || 'قسم فرعي';
                modalTitle.textContent = `${categoryName} - ${subcategoryName}`;
            } else {
                modalTitle.textContent = categoryName;
            }
            
            // عرض المنتجات في القائمة
            displayModalProducts(productsToShow, productIndex);
            
            // فتح القائمة
            const modal = document.getElementById('products-modal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        // عرض المنتجات في القائمة المنبثقة
        function displayModalProducts(products, selectedIndex) {
            const productsGrid = document.getElementById('products-grid');
            productsGrid.innerHTML = '';
            
            if (products.length === 0) {
                productsGrid.innerHTML = `
                    <div class="no-products-message" style="grid-column: 1/-1">
                        <i class="fas fa-box-open"></i>
                        <p>لا توجد منتجات للعرض</p>
                    </div>
                `;
                return;
            }
            
            products.forEach((productData, index) => {
                const product = productData;
                const id = productData.id;
                const imageUrls = extractImageUrls(product);
                
                const productItem = document.createElement("div");
                productItem.className = `modal-product-item ${index === selectedIndex ? 'active' : ''}`;
                productItem.dataset.productIndex = index;
                productItem.dataset.productId = id;
                
                productItem.addEventListener('click', () => {
                    selectModalProduct(index);
                });
                
                const img = document.createElement("img");
                const imageUrl = imageUrls[0] || '';
                if (imageUrl) {
                    img.src = formatDriveUrl(imageUrl, 'thumb');
                    img.alt = product.name || 'منتج';
                } else {
                    img.src = 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w400';
                    img.alt = 'صورة افتراضية';
                }
                img.className = "modal-product-img";
                
                // إضافة حدث النقر على الصورة لفتح المعرض مباشرة
                img.addEventListener('click', (e) => {
                    e.stopPropagation(); // منع انتشار الحدث إلى العنصر الأب
                    openGalleryFromModal(index);
                });
                
                const productInfo = document.createElement("div");
                productInfo.className = "modal-product-info";
                
                const productName = document.createElement("div");
                productName.className = "modal-product-name";
                productName.textContent = product.name || 'منتج بدون اسم';
                
                const productPrice = document.createElement("div");
                productPrice.className = "modal-product-price";
                const price = product.price ? parseFloat(product.price) : 0;
                productPrice.textContent = `${price} ريال`;
                
                productInfo.appendChild(productName);
                productInfo.appendChild(productPrice);
                
                productItem.appendChild(img);
                productItem.appendChild(productInfo);
                productsGrid.appendChild(productItem);
            });
            
            // التمرير إلى المنتج المحدد
            const selectedItem = productsGrid.querySelector(`.modal-product-item[data-product-index="${selectedIndex}"]`);
            if (selectedItem) {
                selectedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // تحديد منتج في القائمة المنبثقة
        function selectModalProduct(index) {
            // إزالة التحديد السابق
            document.querySelectorAll('.modal-product-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // تحديد المنتج الجديد
            const selectedItem = document.querySelector(`.modal-product-item[data-product-index="${index}"]`);
            if (selectedItem) {
                selectedItem.classList.add('active');
                selectedModalProductIndex = index;
                
                // التمرير إلى المنتج المحدد
                selectedItem.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }

        // إغلاق قائمة المنتجات
        function closeProductsModal() {
            const modal = document.getElementById('products-modal');
            modal.classList.remove('active');
            document.body.style.overflow = '';
        }

        // فتح معرض الصور من القائمة المنبثقة
        function openGalleryFromModal(productIndex) {
            // إذا لم يتم تمرير الفهرس، نستخدم الفهرس المحدد حاليًا
            const index = productIndex !== undefined ? productIndex : selectedModalProductIndex;
            
            if (modalProducts.length === 0 || index >= modalProducts.length) {
                return;
            }
            
            const selectedProductData = modalProducts[index];
            const product = selectedProductData;
            const productId = selectedProductData.id;
            const imageUrls = extractImageUrls(product);
            
            // إغلاق القائمة المنبثقة
            closeProductsModal();
            
            // فتح معرض الصور مباشرة
            setTimeout(() => {
                openImageGallery(product, imageUrls, 0, productId);
            }, 300);
        }

        // تعيين القسم الرئيسي النشط
        function setActiveCategory(categoryId, scrollToSection = false, highlightFirstProduct = false) {
            activeCategoryId = categoryId;
            
            document.querySelectorAll(".category").forEach(c => c.classList.remove("active"));
            document.querySelectorAll(".main-category-section").forEach(s => s.classList.remove("active-section"));
            
            const categoryTab = document.querySelector(`.category[data-category-id="${categoryId}"]`);
            if (categoryTab) {
                categoryTab.classList.add("active");
                
                const container = categoriesBar;
                const tab = categoryTab;
                const containerWidth = container.offsetWidth;
                const tabOffsetLeft = tab.offsetLeft;
                const tabWidth = tab.offsetWidth;
                
                container.scrollTo({
                    left: tabOffsetLeft - (containerWidth / 2) + (tabWidth / 2),
                    behavior: 'smooth'
                });
            }
            
            const sectionElement = document.getElementById(`main-category-${categoryId}`);
            if (sectionElement) {
                sectionElement.classList.add("active-section");
            }
        }

        // التمرير إلى قسم محدد
        function scrollToCategorySection(categoryId) {
            const section = document.getElementById(`main-category-${categoryId}`);
            if (section) {
                isManualScroll = true;
                section.scrollIntoView({ behavior: 'smooth', block: 'start' });
                
                setTimeout(() => {
                    isManualScroll = false;
                }, 1000);
            }
        }

        // الحصول على منتجات قسم فرعي معين
        function getProductsBySubcategory(subcategoryId, filters = null) {
            if (!filters) filters = getCurrentFilters();

            let filteredProducts = [];

            for (let id in allProducts) {
                const product = allProducts[id];
                
                if (product.subcategory !== subcategoryId) {
                    continue;
                }

                if (!passesFilters(product, filters)) {
                    continue;
                }

                filteredProducts.push({ id, ...product });
            }

            filteredProducts.sort((a, b) => {
                switch (filters.sortBy) {
                    case 'name':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'price':
                        return (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0);
                    case 'date':
                    default:
                        return new Date(b.date || 0) - new Date(a.date || 0);
                }
            });

            return filteredProducts;
        }

        // الحصول على منتجات قسم رئيسي معين
        function getProductsByCategory(categoryId, filters = null) {
            if (!filters) filters = getCurrentFilters();

            let filteredProducts = [];

            for (let id in allProducts) {
                const product = allProducts[id];
                
                if (product.category !== categoryId) {
                    continue;
                }

                if (!passesFilters(product, filters)) {
                    continue;
                }

                filteredProducts.push({ id, ...product });
            }

            filteredProducts.sort((a, b) => {
                switch (filters.sortBy) {
                    case 'name':
                        return (a.name || '').localeCompare(b.name || '');
                    case 'price':
                        return (parseFloat(a.price) || 0) - (parseFloat(b.price) || 0);
                    case 'date':
                    default:
                        return new Date(b.date || 0) - new Date(a.date || 0);
                }
            });

            return filteredProducts;
        }

        // الحصول على الفلاتر الحالية
        function getCurrentFilters() {
            return {
                governorate: document.getElementById('governorate').value,
                region: document.getElementById('region').value,
                merchant: document.getElementById('merchant').value,
                category: document.getElementById('category-filter').value,
                subcategory: document.getElementById('subcategory-filter').value,
                search: searchInput.value.toLowerCase().trim(),
                sortBy: document.getElementById('sort-by').value
            };
        }

        // التحقق من تطبيق الفلاتر على المنتج
        function passesFilters(product, filters) {
            if (filters.merchant && product.userId !== filters.merchant) {
                return false;
            }

            if (product.userId && allMerchants[product.userId] && !isMerchant(allMerchants[product.userId])) {
                return false;
            }

            if (filters.search) {
                const searchText = `${product.name || ''} ${product.description || ''}`.toLowerCase();
                if (!searchText.includes(filters.search)) {
                    return false;
                }
            }

            if (filters.governorate && product.userId && allMerchants[product.userId]) {
                const merchant = allMerchants[product.userId];
                if (merchant.governorate !== filters.governorate) {
                    return false;
                }
            }

            if (filters.region && product.userId && allMerchants[product.userId]) {
                const merchant = allMerchants[product.userId];
                if (merchant.region !== filters.region) {
                    return false;
                }
            }

            if (filters.category && product.category !== filters.category) {
                return false;
            }

            if (filters.subcategory && product.subcategory !== filters.subcategory) {
                return false;
            }

            return true;
        }

        // تحميل الفلاتر
        function populateFilters() {
            const governorateSelect = document.getElementById('governorate');
            governorateSelect.innerHTML = '<option value="">جميع المحافظات</option>';
            Object.keys(allGovernorates).forEach(govId => {
                const option = document.createElement('option');
                option.value = govId;
                option.textContent = allGovernorates[govId].name || govId;
                governorateSelect.appendChild(option);
            });

            const merchantSelect = document.getElementById('merchant');
            merchantSelect.innerHTML = '<option value="">جميع التجار</option>';
            
            Object.keys(allMerchants)
                .filter(merchantId => {
                    const merchant = allMerchants[merchantId];
                    const productCount = merchantProductCounts[merchantId] || 0;
                    
                    return productCount > 0 && isMerchant(merchant);
                })
                .sort((a, b) => {
                    return (merchantProductCounts[b] || 0) - (merchantProductCounts[a] || 0);
                })
                .forEach(merchantId => {
                    const merchant = allMerchants[merchantId];
                    const option = document.createElement('option');
                    option.value = merchantId;
                    option.textContent = merchant.name || merchant.username || merchantId;
                    merchantSelect.appendChild(option);
                });

            const categorySelect = document.getElementById('category-filter');
            categorySelect.innerHTML = '<option value="">جميع الأقسام</option>';
            
            Object.keys(allCategories)
                .filter(catId => {
                    const productCount = categoryProductCounts[catId] || 0;
                    return productCount > 0;
                })
                .sort((a, b) => {
                    return (categoryProductCounts[b] || 0) - (categoryProductCounts[a] || 0);
                })
                .forEach(catId => {
                    const option = document.createElement('option');
                    option.value = catId;
                    option.textContent = allCategories[catId].name;
                    categorySelect.appendChild(option);
                });

            const subcategorySelect = document.getElementById('subcategory-filter');
            subcategorySelect.innerHTML = '<option value="">جميع الأقسام الفرعية</option>';
            
            Object.keys(allSubcategories)
                .filter(subcatId => {
                    const productCount = subcategoryProductCounts[subcatId] || 0;
                    return productCount > 0;
                })
                .sort((a, b) => {
                    return (subcategoryProductCounts[b] || 0) - (subcategoryProductCounts[a] || 0);
                })
                .forEach(subcatId => {
                    const subcategory = allSubcategories[subcatId];
                    const option = document.createElement('option');
                    option.value = subcatId;
                    option.textContent = subcategory.name;
                    subcategorySelect.appendChild(option);
                });

            const filterInputs = ['governorate', 'region', 'merchant', 'category-filter', 'subcategory-filter', 'sort-by'];
            filterInputs.forEach(inputId => {
                document.getElementById(inputId).addEventListener('change', () => {
                    updateDisplay();
                });
            });
        }

        // تحديث العرض بعد تطبيق الفلاتر
        function updateDisplay() {
            calculateProductCounts();
            displayCategories();
            displayCategorySections();
            
            setTimeout(() => {
                const firstCategory = Object.keys(allCategories)
                    .filter(catId => (calculateCategoryCountsWithFilters()[catId] || 0) > 0)
                    .sort((a, b) => (calculateCategoryCountsWithFilters()[b] || 0) - (calculateCategoryCountsWithFilters()[a] || 0))[0];
                
                if (firstCategory) {
                    setActiveCategory(firstCategory, true);
                }
            }, 300);
        }

        // ==========================================
        // 🖼️ وظائف معرض الصور
        // ==========================================
        function openImageGallery(product, images, startIndex = 0, productId = null) {
            currentProduct = product;
            currentProductId = productId;
            galleryImages = images;
            currentGalleryIndex = startIndex;
            isImageZoomed = false;

            document.getElementById('gallery-product-name-full').textContent = product.name || 'منتج بدون اسم';
            showGalleryImage(startIndex);
            updateProductCard(product);
            loadProductStats(productId);
            loadComments(productId);

            const gallery = document.getElementById('image-gallery');
            gallery.classList.add('active');
            document.body.style.overflow = 'hidden';

            setupMerchantButton(product);
        }

        function closeImageGallery() {
            const gallery = document.getElementById('image-gallery');
            gallery.classList.remove('active');
            
            document.getElementById('comments-section').classList.remove('active');
            
            document.body.style.overflow = '';
            isImageZoomed = false;
        }

        function showGalleryImage(index) {
            if (galleryImages.length === 0) {
                const mainImage = document.getElementById('gallery-main-image');
                mainImage.src = 'https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w1600';
                mainImage.alt = 'لا توجد صورة';
                return;
            }

            if (index < 0) currentGalleryIndex = galleryImages.length - 1;
            else if (index >= galleryImages.length) currentGalleryIndex = 0;
            else currentGalleryIndex = index;

            const mainImage = document.getElementById('gallery-main-image');
            mainImage.src = formatDriveUrl(galleryImages[currentGalleryIndex], 'main');
            mainImage.alt = `صورة ${currentGalleryIndex + 1}`;
            mainImage.classList.remove('zoomed');
            isImageZoomed = false;

            const prevBtn = document.getElementById('gallery-prev');
            const nextBtn = document.getElementById('gallery-next');
            const imageCounter = document.getElementById('image-counter');
            
            if (galleryImages.length > 1) {
                prevBtn.style.display = 'flex';
                nextBtn.style.display = 'flex';
                imageCounter.style.display = 'block';
                imageCounter.textContent = `${currentGalleryIndex + 1}/${galleryImages.length}`;
            } else {
                prevBtn.style.display = 'none';
                nextBtn.style.display = 'none';
                imageCounter.style.display = 'none';
            }
        }

        function navigateGallery(direction) {
            showGalleryImage(currentGalleryIndex + direction);
        }

        function toggleImageZoom() {
            const mainImage = document.getElementById('gallery-main-image');
            isImageZoomed = !isImageZoomed;
            mainImage.classList.toggle('zoomed', isImageZoomed);
        }

        // تحديث بطاقة بيانات المنتج في المعرض
        function updateProductCard(product) {
            const priceElement = document.getElementById('gallery-product-price');
            const price = product.price ? parseFloat(product.price) : 0;
            priceElement.textContent = `${price} ريال`;
            
            const descElement = document.getElementById('gallery-product-description');
            let descriptionText = product.description || '';
            
            if (product.date) {
                const dateText = `\n\nتاريخ الإضافة: ${formatDate(product.date)}`;
                descriptionText += dateText;
            }
            
            if (descriptionText.trim()) {
                descElement.textContent = descriptionText;
                descElement.style.display = 'block';
            } else {
                descElement.style.display = 'none';
            }
            
            const detailsContainer = document.getElementById('gallery-product-details');
            detailsContainer.innerHTML = '';
            
            if (product.status) {
                const statusDetail = document.createElement('div');
                statusDetail.className = 'gallery-product-detail';
                statusDetail.innerHTML = `<span class="label">الحالة:</span> ${product.status}`;
                detailsContainer.appendChild(statusDetail);
            }
            
            if (product.location) {
                const locationDetail = document.createElement('div');
                locationDetail.className = 'gallery-product-detail';
                locationDetail.innerHTML = `<span class="label">الموقع:</span> ${product.location}`;
                detailsContainer.appendChild(locationDetail);
            }
        }

        // إعداد زر التاجر
        function setupMerchantButton(product) {
            const merchantBtn = document.getElementById('merchant-btn');
            const merchantNameText = document.getElementById('merchant-name-text');
            
            if (product.userId && allMerchants[product.userId] && isMerchant(allMerchants[product.userId])) {
                const merchant = allMerchants[product.userId];
                const merchantName = merchant.name || merchant.username || "تاجر";
                merchantBtn.style.display = 'block';
                merchantNameText.textContent = merchantName;
                merchantBtn.onclick = () => openMerchantPage(merchantName, product.userId, product.name || 'منتج');
            } else {
                merchantBtn.style.display = 'none';
            }
        }

        // نظام الإعجابات والمفضلة
        async function loadProductStats(productId) {
            try {
                const statsRef = ref(db, `products_stats/${productId}`);
                onValue(statsRef, (snapshot) => {
                    const stats = snapshot.val() || {};
                    
                    const likes = Array.isArray(stats.likes) ? stats.likes.length : 0;
                    document.getElementById('like-count').textContent = likes;

                    const commentsRef = ref(db, `comments/${productId}`);
                    onValue(commentsRef, (commentsSnapshot) => {
                        const commentsData = commentsSnapshot.val() || {};
                        const commentCount = Object.keys(commentsData).length;
                        document.getElementById('comment-count').textContent = commentCount;
                    });

                    const views = (stats.views || 0) + 150;
                    document.getElementById('view-count').textContent = views;

                    const likeBtn = document.getElementById('like-btn');
                    const userId = getUserId();
                    const isLiked = Array.isArray(stats.likes) && stats.likes.includes(userId);
                    likeBtn.classList.toggle('active', isLiked);

                    const favoriteBtn = document.getElementById('favorite-btn');
                    favoriteBtn.classList.toggle('active', favoriteProducts[productId]);
                });
            } catch (error) {
                console.error('خطأ في تحميل الإحصائيات:', error);
            }
        }

        async function handleLike() {
            if (!currentProductId) return;
            
            const userId = getUserId();
            const statsRef = ref(db, `products_stats/${currentProductId}`);
            
            try {
                const snapshot = await get(statsRef);
                const currentStats = snapshot.val() || {};
                let likes = Array.isArray(currentStats.likes) ? currentStats.likes : [];
                
                const userIndex = likes.indexOf(userId);
                if (userIndex === -1) {
                    likes.push(userId);
                } else {
                    likes.splice(userIndex, 1);
                }
                
                await update(statsRef, { likes: likes });
                
            } catch (error) {
                console.error('خطأ في معالجة الإعجاب:', error);
            }
        }

        function toggleFavorite() {
            if (!currentProductId) return;
            
            if (favoriteProducts[currentProductId]) {
                delete favoriteProducts[currentProductId];
            } else {
                favoriteProducts[currentProductId] = true;
            }
            
            localStorage.setItem('favoriteProducts', JSON.stringify(favoriteProducts));
            loadProductStats(currentProductId);
        }

        // نظام التعليقات
        function toggleComments() {
            const commentsSection = document.getElementById('comments-section');
            commentsSection.classList.toggle('active');
            
            if (commentsSection.classList.contains('active')) {
                commentsSection.scrollIntoView({ behavior: 'smooth' });
            }
        }

        async function loadComments(productId) {
            const commentsList = document.getElementById('comments-list');
            
            try {
                const commentsRef = ref(db, `comments/${productId}`);
                onValue(commentsRef, (snapshot) => {
                    const commentsData = snapshot.val() || {};
                    const comments = Object.entries(commentsData).map(([id, comment]) => ({ id, ...comment }));
                    displayComments(comments);
                    
                    const commentCount = Object.keys(commentsData).length;
                    document.getElementById('comment-count').textContent = commentCount;
                });
            } catch (error) {
                console.error('خطأ في تحميل التعليقات:', error);
                commentsList.innerHTML = '<div class="error">حدث خطأ في تحميل التعليقات</div>';
            }
        }

        function displayComments(comments) {
            const commentsList = document.getElementById('comments-list');
            
            commentsList.innerHTML = '';

            if (comments.length === 0) {
                commentsList.innerHTML = '<div class="no-comments">لا توجد تعليقات بعد</div>';
                return;
            }

            comments.sort((a, b) => new Date(b.date || 0) - new Date(a.date || 0));
            
            comments.forEach(comment => {
                const commentItem = document.createElement('div');
                commentItem.className = 'comment-item';
                commentItem.innerHTML = `
                    <div class="comment-header">
                        <span>${escapeHtml(comment.author || 'مستخدم')}</span>
                        <span class="comment-date">${formatDate(comment.date)}</span>
                    </div>
                    <div class="comment-text">${escapeHtml(comment.text || '')}</div>
                `;
                commentsList.appendChild(commentItem);
            });
        }

        async function addComment() {
            if (!currentProductId) return;
            
            const commentText = document.getElementById('comment-text').value.trim();
            if (!commentText) {
                return;
            }

            try {
                const commentId = Date.now().toString();
                const comment = {
                    text: commentText,
                    author: 'مستخدم',
                    date: new Date().toISOString()
                };

                const commentRef = ref(db, `comments/${currentProductId}/${commentId}`);
                await set(commentRef, comment);
                
                document.getElementById('comment-text').value = '';
                
            } catch (error) {
                console.error('خطأ في إضافة التعليق:', error);
            }
        }

        // نظام المشاركة
        function shareProduct() {
            if (!currentProduct) return;
            
            const productName = currentProduct.name || 'منتج';
            const productUrl = window.location.href;
            const shareText = `تفضل بتصفح ${productName}`;
            
            if (navigator.share) {
                navigator.share({
                    title: productName,
                    text: shareText,
                    url: productUrl
                })
                .catch(err => {
                    console.log('خطأ في المشاركة:', err);
                    copyToClipboard(shareText + '\n' + productUrl);
                });
            } else {
                copyToClipboard(shareText + '\n' + productUrl);
            }
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text)
                .catch(() => {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                });
        }

        // فتح صفحة التاجر
        function openMerchantPage(merchantName, merchantId, productName) {
            const selectedMerchantData = {
                name: merchantName,
                id: merchantId,
                productName: productName
            };
            
            localStorage.setItem('selectedMerchantName', merchantName);
            localStorage.setItem('selectedMerchantId', merchantId);
            localStorage.setItem('selectedProductName', productName);
            
            window.open('ard_tagr.html', '_blank');
        }

        // وظائف مساعدة
        function extractImageUrls(product) {
            let imageUrls = [];
            if (product.imageUrls) {
                if (Array.isArray(product.imageUrls)) 
                    imageUrls = product.imageUrls.filter(u => u && u.trim() !== '');
                else if (typeof product.imageUrls === 'string') 
                    imageUrls = product.imageUrls.split(',').map(u => u.trim()).filter(Boolean);
            }
            if (imageUrls.length === 0 && product.image && typeof product.image === 'string') {
                imageUrls = product.image.split(/[,\n]/).map(u => u.trim()).filter(Boolean);
            }
            
            if (imageUrls.length === 0) {
                imageUrls = ['https://drive.google.com/thumbnail?id=1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC&sz=w800'];
            }
            
            return imageUrls;
        }

        function formatDriveUrl(url, mode = 'thumb') {
            if (!url) return '';
            
            if (url.includes('1-qn1bTCIhgF1E5wm5RVRdm1pYLeNZCNC')) {
                return url;
            }
            
            let id = '';
            
            if (url.includes('/d/')) {
                id = url.split('/d/')[1].split('/')[0];
            } 
            else if (url.includes('id=')) {
                try { 
                    id = new URLSearchParams(url.split('?')[1]).get('id') || ''; 
                } catch { 
                    return url; 
                }
            }
            else if (url.includes('/file/d/')) {
                id = url.split('/file/d/')[1].split('/')[0];
            }
            else if (url.includes('drive.google.com/uc?id=')) {
                id = url.split('drive.google.com/uc?id=')[1].split('&')[0];
            }
            
            if (!id) return url;

            if (mode === 'thumb') {
                return `https://drive.google.com/thumbnail?id=${id}&sz=w800`;
            } else if (mode === 'main') {
                return `https://drive.google.com/thumbnail?id=${id}&sz=w1600`;
            }
            return url;
        }

        function formatDate(dateString) {
            if (!dateString) return 'غير محدد';
            try { 
                return new Date(dateString).toLocaleDateString('ar-EG'); 
            } catch { 
                return dateString; 
            }
        }

        function getUserId() {
            let userId = localStorage.getItem('userId');
            if (!userId) { 
                userId = 'user_' + Math.random().toString(36).substr(2, 9); 
                localStorage.setItem('userId', userId); 
            }
            return userId;
        }

        function escapeHtml(text) { 
            const div = document.createElement('div'); 
            div.textContent = text; 
            return div.innerHTML; 
        }

        // إعداد مستمعي الأحداث
        function setupEventListeners() {
            let searchTimeout;
            searchInput.addEventListener('input', () => {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    updateDisplay();
                }, 500);
            });

            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    updateDisplay();
                }
            });

            filterToggle.addEventListener('click', () => {
                filterToggle.classList.toggle('active');
                filterBar.classList.toggle('active');
                
                // إضافة أو إزالة padding-top من body عند ظهور/إخفاء شريط الفلاتر
                if (filterBar.classList.contains('active')) {
                    document.body.classList.add('filter-bar-active');
                } else {
                    document.body.classList.remove('filter-bar-active');
                }
            });

            document.addEventListener('click', (e) => {
                if (!filterBar.contains(e.target) && !filterToggle.contains(e.target)) {
                    filterToggle.classList.remove('active');
                    filterBar.classList.remove('active');
                    document.body.classList.remove('filter-bar-active');
                }
            });

            // إغلاق قائمة المنتجات
            document.getElementById('products-modal-close').addEventListener('click', closeProductsModal);

            // إغلاق قائمة المنتجات بالنقر خارجها
            document.getElementById('products-modal').addEventListener('click', (e) => {
                if (e.target.id === 'products-modal') {
                    closeProductsModal();
                }
            });

            // معرض الصور
            document.getElementById('gallery-close').addEventListener('click', closeImageGallery);
            document.getElementById('gallery-prev').addEventListener('click', () => navigateGallery(-1));
            document.getElementById('gallery-next').addEventListener('click', () => navigateGallery(1));
            document.getElementById('gallery-main-image').addEventListener('click', toggleImageZoom);

            document.getElementById('like-btn').addEventListener('click', handleLike);
            document.getElementById('favorite-btn').addEventListener('click', toggleFavorite);
            document.getElementById('comment-btn').addEventListener('click', toggleComments);
            document.getElementById('share-btn').addEventListener('click', shareProduct);
            document.getElementById('submit-comment').addEventListener('click', addComment);
            document.getElementById('close-comments').addEventListener('click', () => {
                document.getElementById('comments-section').classList.remove('active');
            });

            document.getElementById('image-gallery').addEventListener('click', (e) => {
                if (e.target.id === 'image-gallery') {
                    closeImageGallery();
                }
            });

            // اختصارات لوحة المفاتيح
            document.addEventListener('keydown', (e) => {
                // قائمة المنتجات
                const productsModal = document.getElementById('products-modal');
                if (productsModal.classList.contains('active')) {
                    switch(e.key) {
                        case 'Escape':
                            closeProductsModal();
                            break;
                        case 'ArrowLeft':
                            if (selectedModalProductIndex > 0) {
                                selectModalProduct(selectedModalProductIndex - 1);
                            }
                            break;
                        case 'ArrowRight':
                            if (selectedModalProductIndex < modalProducts.length - 1) {
                                selectModalProduct(selectedModalProductIndex + 1);
                            }
                            break;
                        case 'Enter':
                            openGalleryFromModal();
                            break;
                    }
                }
                
                // معرض الصور
                const gallery = document.getElementById('image-gallery');
                if (gallery.classList.contains('active')) {
                    switch(e.key) {
                        case 'Escape':
                            closeImageGallery();
                            break;
                        case 'ArrowLeft':
                            navigateGallery(1);
                            break;
                        case 'ArrowRight':
                            navigateGallery(-1);
                            break;
                        case ' ':
                            e.preventDefault();
                            toggleImageZoom();
                            break;
                    }
                }
            });
        }

        // جعل الدوال متاحة عالمياً
        window.openMerchantPage = openMerchantPage;
        window.setActiveCategory = setActiveCategory;
    </script>

    <!-- Font Awesome للأيقونات -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</body>
</html>
