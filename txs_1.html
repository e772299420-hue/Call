<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>نظام المشتركين — أضفني / المشتركين</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --primary: #3498db;
            --secondary: #2c3e50;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
            --light: #ecf0f1;
            --dark: #2c3e50;
            --gray: #7f8c8d;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: 'Tahoma', 'Arial', sans-serif;
            margin: 0;
            background: #f6f8fa;
            color: #333;
            line-height: 1.6;
        }
        
        .header {
            background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
            color: white;
            padding: 1rem;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .tabs {
            display: flex;
            background: var(--dark);
            color: #fff;
            border-radius: 5px;
            overflow: hidden;
            margin: 0 auto;
            max-width: 500px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }
        
        .tab.active {
            background: var(--primary);
            box-shadow: inset 0 -3px 0 white;
        }
        
        .tab:hover:not(.active) {
            background: rgba(255,255,255,0.1);
        }
        
        .container {
            padding: 16px;
            max-width: 1000px;
            margin: 0 auto;
        }
        
        .card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: transform 0.3s ease;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.12);
        }
        
        h3 {
            color: var(--secondary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
        }
        
        label {
            display: block;
            margin-top: 15px;
            font-weight: bold;
            color: var(--dark);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-top: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-family: inherit;
            transition: border 0.3s ease;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        fieldset {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        legend {
            font-weight: bold;
            color: var(--dark);
            padding: 0 10px;
        }
        
        table.days {
            width: 100%;
            border-collapse: collapse;
        }
        
        table.days td {
            padding: 8px;
            text-align: center;
        }
        
        button {
            background: var(--primary);
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: bold;
            width: 100%;
            transition: all 0.3s ease;
        }
        
        button:hover {
            background: #2980b9;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        #map-container {
            position: relative;
            width: 100%;
            height: 60vh;
            border: 1px solid #ddd;
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }
        
        #map {
            width: 100%;
            height: 100%;
        }
        
        .map-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            z-index: 1000;
            background: white;
            padding: 8px;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 6px;
        }
        
        .map-control-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        
        .map-control-btn:hover {
            background: #2980b9;
            transform: scale(1.1);
        }
        
        .map-control-btn i {
            font-size: 16px;
        }
        
        .gps-status {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            padding: 8px;
            border-radius: 5px;
            background: #f8f9fa;
        }
        
        .gps-status i {
            margin-left: 8px;
            font-size: 18px;
        }
        
        .gps-success {
            color: var(--success);
            background: rgba(46, 204, 113, 0.1);
        }
        
        .gps-warning {
            color: var(--warning);
            background: rgba(243, 156, 18, 0.1);
        }
        
        .gps-error {
            color: var(--danger);
            background: rgba(231, 76, 60, 0.1);
        }
        
        .subscriber-card {
            background: #fff;
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            cursor: pointer;
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary);
        }
        
        .subscriber-card:hover {
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.12);
        }
        
        .small {
            font-size: 13px;
            color: var(--gray);
        }
        
        .hidden {
            display: none;
        }
        
        .note {
            color: var(--danger);
            margin-top: 6px;
            font-size: 13px;
        }
        
        .phone-link {
            color: var(--primary);
            text-decoration: none;
            margin-left: 15px;
            cursor: pointer;
            display: inline-block;
            padding: 5px 10px;
            border-radius: 4px;
            background: rgba(52, 152, 219, 0.1);
            transition: all 0.3s ease;
        }
        
        .phone-link:hover {
            background: rgba(52, 152, 219, 0.2);
            transform: translateY(-2px);
        }
        
        .subscriber-details {
            background: #f9f9f9;
            padding: 15px;
            margin-top: 10px;
            border-radius: 6px;
            border-right: 3px solid var(--primary);
        }
        
        .loading {
            text-align: center;
            padding: 30px;
            color: var(--gray);
        }
        
        .status-message {
            padding: 15px;
            margin: 15px 0;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
        }
        
        .status-success {
            background: rgba(46, 204, 113, 0.15);
            color: #27ae60;
            border: 1px solid #2ecc71;
        }
        
        .status-error {
            background: rgba(231, 76, 60, 0.15);
            color: #c0392b;
            border: 1px solid #e74c3c;
        }
        
        .status-info {
            background: rgba(52, 152, 219, 0.15);
            color: #2980b9;
            border: 1px solid #3498db;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .action-buttons button {
            flex: 1;
            margin-top: 0;
        }
        
        .btn-secondary {
            background: var(--gray);
        }
        
        .btn-secondary:hover {
            background: #6c757d;
        }
        
        .location-help {
            display: flex;
            align-items: center;
            margin-top: 10px;
            padding: 10px;
            background: rgba(52, 152, 219, 0.1);
            border-radius: 6px;
            color: var(--dark);
        }
        
        .location-help i {
            margin-left: 10px;
            color: var(--primary);
            font-size: 20px;
        }
        
        .bus-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            margin-right: 5px;
            color: #fff;
            background-color: #e74c3c;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            font-size: 12px;
        }
        
        .retry-button {
            background: var(--warning);
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            margin-right: 10px;
            font-size: 12px;
            transition: all 0.3s ease;
        }
        
        .retry-button:hover {
            background: #e67e22;
        }
        
        .distance-badge {
            background-color: var(--primary);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 8px;
        }
        
        .filter-container {
            display: flex;
            gap: 15px;
            margin: 15px 0;
            padding: 10px;
            background-color: #f8f9fa;
            border-radius: 8px;
            flex-wrap: wrap;
        }
        
        .filter-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .filter-group label {
            margin: 0;
            font-weight: bold;
            color: var(--dark);
        }
        
        .filter-group select {
            width: auto;
            margin: 0;
        }
        
        @media (max-width: 768px) {
            .tabs {
                flex-direction: column;
            }
            
            .container {
                padding: 10px;
            }
            
            #map-container {
                height: 50vh;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .map-controls {
                left: 5px;
                top: 5px;
                padding: 6px;
            }
            
            .map-control-btn {
                width: 32px;
                height: 32px;
            }
            
            .map-control-btn i {
                font-size: 14px;
            }
            
            .gps-status {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .retry-button {
                margin-top: 8px;
                margin-right: 0;
                width: 100%;
            }
            
            .filter-container {
                flex-direction: column;
                gap: 10px;
            }
            
            .filter-group {
                width: 100%;
            }
            
            .filter-group select {
                width: 100%;
            }
        }
        
        .leaflet-popup-content {
            text-align: center;
            font-family: Tahoma, Arial, sans-serif;
        }
        
        .leaflet-popup-content strong {
            color: var(--primary);
        }
        
        .offline-notice {
            position: absolute;
            bottom: 10px;
            right: 10px;
            z-index: 1000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .jobtype-badge {
            background-color: var(--success);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            margin-right: 8px;
        }
    </style>
</head>
<body>

<div class="header">
    <h1>نظام المشتركين - سائقي الباصات</h1>
    <p>أضف بياناتك أو استعرض سائقي الباصات الآخرين</p>
</div>

<div class="tabs">
    <div class="tab active" id="tab-add">أضفني كمشترك</div>
    <div class="tab" id="tab-list">سائقي الباصات</div>
</div>

<div class="container">
    <div id="statusMessage" class="status-message hidden"></div>
    
    <div id="content-add">
        <div class="card">
            <h3><i class="fas fa-user-plus"></i> أضفني كمشترك</h3>
            <form id="formAdd">
                <label>الاسم الرباعي <span class="small">* مطلوب</span></label>
                <input id="fullname" placeholder="مثال: أحمد محمد علي سالم" required>
                <div id="fullnameNote" class="note hidden">يجب إدخال الاسم الرباعي (4 كلمات)</div>

                <label>الاسم الوظيفي <span class="small">* مطلوب</span></label>
                <input id="jobname" placeholder="مثال: سائق باص" required>

                <fieldset>
                    <legend>أيام الدوام</legend>
                    <table class="days">
                        <tr>
                            <td><label><input type="checkbox" class="day" value="السبت"> السبت</label></td>
                            <td><label><input type="checkbox" class="day" value="الأحد"> الأحد</label></td>
                            <td><label><input type="checkbox" class="day" value="الاثنين"> الاثنين</label></td>
                            <td><label><input type="checkbox" class="day" value="الثلاثاء"> الثلاثاء</label></td>
                            <td><label><input type="checkbox" class="day" value="الأربعاء"> الأربعاء</label></td>
                            <td><label><input type="checkbox" class="day" value="الخميس"> الخميس</label></td>
                            <td><label><input type="checkbox" class="day" value="الجمعة"> الجمعة</label></td>
                        </tr>
                    </table>
                    <label style="margin-top:8px"><input type="checkbox" id="selectAllDays"> اختيار الكل</label>
                </fieldset>

                <fieldset>
                    <legend>وقت الدوام</legend>
                    <label>من الساعة</label>
                    <input type="time" id="fromTime">
                    <label>حتى الساعة</label>
                    <input type="time" id="toTime">
                </fieldset>

                <label>رقم الجوال 1 <span class="small">* مطلوب (9 أرقام)</span></label>
                <input id="phone1" maxlength="9" placeholder="مثال: 712345678" required>
                <div id="phone1Note" class="note hidden">رقم الجوال يجب أن يتكون من 9 أرقام</div>

                <label>رقم الجوال 2 (اختياري)</label>
                <input id="phone2" maxlength="9" placeholder="مثال: 712345678">
                <div id="phone2Note" class="note hidden">رقم الجوال يجب أن يتكون من 9 أرقام</div>

                <label>رقم الواتساب (اختياري)</label>
                <input id="whatsapp" maxlength="9" placeholder="مثال: 712345678">
                <div id="whatsappNote" class="note hidden">رقم الواتساب يجب أن يتكون من 9 أرقام</div>

                <label>ملاحظات (ستظهر للعملاء)</label>
                <textarea id="notes" rows="3" placeholder="ملاحظات اختيارية"></textarea>

                <label>نوع الوظيفة</label>
                <select id="jobtype" required>
                    <option value="سائق باص" selected>سائق باص</option>
                    <option value="مشرف نقل">مشرف نقل</option>
                    <option value="موظف استقبال">موظف استقبال</option>
                    <option value="إداري">إداري</option>
                    <option value="آخر">آخر</option>
                </select>

                <label>IP الهاتف (يُؤخذ تلقائياً)</label>
                <input id="ipField" disabled>

                <label>GPS الهاتف (يُؤخذ تلقائياً)</label>
                <div class="gps-status" id="gpsStatus">
                    <i class="fas fa-satellite"></i>
                    <span>جاري محاولة الحصول على الموقع...</span>
                    <button class="retry-button" onclick="retryLocation()">
                        <i class="fas fa-redo"></i> إعادة المحاولة
                    </button>
                </div>
                <input id="gpsField" disabled>
                
                <div class="location-help">
                    <i class="fas fa-info-circle"></i>
                    <span>لضمان الحصول على موقعك بدقة، يرجى تفعيل خدمة GPS في هاتفك والسماح للمتصفح بالوصول إلى موقعك</span>
                </div>

                <button type="submit"><i class="fas fa-save"></i> حفظ كمشترك</button>
            </form>
        </div>
    </div>

    <div id="content-list" class="hidden">
        <div class="card">
            <h3><i class="fas fa-bus"></i> سائقي الباصات الأقرب</h3>
            
            <div class="filter-container">
                <div class="filter-group">
                    <label>عرض السائقين ضمن مسافة:</label>
                    <select id="distanceFilter">
                        <option value="5000">5 كم</option>
                        <option value="10000">10 كم</option>
                        <option value="20000">20 كم</option>
                        <option value="50000">50 كم</option>
                        <option value="0" selected>جميع المسافات</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label>فرز حسب:</label>
                    <select id="sortBy">
                        <option value="distance" selected>الأقرب مسافة</option>
                        <option value="name">الاسم</option>
                    </select>
                </div>
            </div>
            
            <div id="map-container">
                <div id="map">جارٍ تحميل الخريطة...</div>
                <div class="map-controls">
                    <button class="map-control-btn" onclick="reloadLocation()" title="تحديث الموقع">
                        <i class="fas fa-sync-alt"></i>
                    </button>
                    <button class="map-control-btn" onclick="toggleRouteDisplay()" title="إظهار/إخفاء المسارات">
                        <i class="fas fa-route"></i>
                    </button>
                    <button class="map-control-btn" onclick="downloadMapForOffline()" title="حفظ الخريطة">
                        <i class="fas fa-download"></i>
                    </button>
                </div>
                <div id="offlineNotice" class="offline-notice hidden">
                    <i class="fas fa-wifi"></i> وضع عدم الاتصال
                </div>
            </div>
            
            <div id="listContainer"></div>
        </div>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>

<script>
/********** إعدادات Firebase **********/
const FIREBASE_DB_ROOT = 'https://chat-fat-free-default-rtdb.firebaseio.com';

/********** تبويبات **********/
const tabAdd = document.getElementById('tab-add');
const tabList = document.getElementById('tab-list');
const contentAdd = document.getElementById('content-add');
const contentList = document.getElementById('content-list');
const statusMessage = document.getElementById('statusMessage');
const gpsStatus = document.getElementById('gpsStatus');
const offlineNotice = document.getElementById('offlineNotice');
const distanceFilter = document.getElementById('distanceFilter');
const sortBy = document.getElementById('sortBy');

// متغيرات لتخزين حالة الخريطة والمسارات
let map, myMarker, routeDisplayEnabled = true;
let subscribersCache = {};
let routingLines = [];
let watchId = null;
let allSubscribers = [];

// التحقق من حالة الاتصال بالإنترنت
function updateOnlineStatus() {
    if (navigator.onLine) {
        offlineNotice.classList.add('hidden');
    } else {
        offlineNotice.classList.remove('hidden');
    }
}

// إضافة مستمعين لتغيير حالة الاتصال
window.addEventListener('online', updateOnlineStatus);
window.addEventListener('offline', updateOnlineStatus);

// دالة لعرض الرسائل
function showStatusMessage(message, type = 'info') {
    statusMessage.textContent = message;
    statusMessage.className = `status-message status-${type}`;
    statusMessage.classList.remove('hidden');
    
    // إخفاء الرسالة بعد 5 ثوانٍ
    setTimeout(() => {
        statusMessage.classList.add('hidden');
    }, 5000);
}

// تحديث حالة GPS
function updateGpsStatus(message, status) {
    const icon = status === 'success' ? 'check-circle' : 
                status === 'warning' ? 'exclamation-triangle' : 'exclamation-circle';
    
    gpsStatus.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <span>${message}</span>
        <button class="retry-button" onclick="retryLocation()">
            <i class="fas fa-redo"></i> إعادة المحاولة
        </button>
    `;
    gpsStatus.className = `gps-status gps-${status}`;
}

// إعادة محاولة الحصول على الموقع
function retryLocation() {
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
    updateGpsStatus('جاري إعادة المحاولة...', 'warning');
    fetchMyGps();
}

tabAdd.addEventListener('click', ()=>{
    tabAdd.classList.add('active');
    tabList.classList.remove('active');
    contentAdd.classList.remove('hidden');
    contentList.classList.add('hidden');
    
    // إيقاف مراقبة الموقع عند الخروج من الخريطة لتوفير البطارية
    if (watchId) {
        navigator.geolocation.clearWatch(watchId);
        watchId = null;
    }
});

tabList.addEventListener('click', ()=>{
    tabList.classList.add('active');
    tabAdd.classList.remove('active');
    contentList.classList.remove('hidden');
    contentAdd.classList.add('hidden');
    initMapAndLoad();
});

/********** عناصر الفورم **********/
const formAdd = document.getElementById('formAdd');
const fullnameEl = document.getElementById('fullname');
const fullnameNote = document.getElementById('fullnameNote');
const jobnameEl = document.getElementById('jobname');
const phone1El = document.getElementById('phone1');
const phone1Note = document.getElementById('phone1Note');
const phone2El = document.getElementById('phone2');
const phone2Note = document.getElementById('phone2Note');
const whatsappEl = document.getElementById('whatsapp');
const whatsappNote = document.getElementById('whatsappNote');
const notesEl = document.getElementById('notes');
const jobtypeEl = document.getElementById('jobtype');
const ipField = document.getElementById('ipField');
const gpsField = document.getElementById('gpsField');
const selectAllDays = document.getElementById('selectAllDays');

selectAllDays.addEventListener('change', ()=>{
    document.querySelectorAll('.day').forEach(cb => cb.checked = selectAllDays.checked);
});

let myIp = null;
let myGps = null;

// إنشاء معرف فريد للمشترك
function generateUniqueId() {
    return 'subscriber_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

function isFourNames(name){ return name.trim().split(/\s+/).length >= 4; }
function isNineDigits(s){ return /^\d{9}$/.test(s); }

async function fetchMyIp(){
    try {
        const r = await fetch('https://api.ipify.org?format=json');
        const j = await r.json();
        myIp = j.ip;
        ipField.value = myIp;
        return myIp;
    } catch(e){ 
        console.error('IP error', e); 
        myIp = 'unknown_' + Math.random().toString(36).substr(2, 9);
        ipField.value = myIp;
        return myIp;
    }
}

// أيقونة الباص المخصصة
const busIcon = L.icon({
    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA1MTIgNTEyIiBmaWxsPSIjZmZmIj48cGF0aCBkPSJNMTIwIDI1Nmg0MHY0MEgxMjBWMjU2ek0zNTIgMjk2SDQwMFYyNTZIMzUyVjI5NjpNNDQ4IDMySDY0QzI4LjcgMzIgMCA2MC43IDAgODh2MzE2YzAgMjcuMyAyOC43IDU2IDY0IDU2aDExMmMtOC44LTE2LTQwLTMyLTQwLTMyczMxLjIgMTYgNDAgMzJoMTkyYzguOCAwIDQwLTE2IDQwLTMyczMxLjIgMTYgNDAgMzJoMTEyYzM1LjMgMCA2NC0yOC43IDY0LTU2Vjg4QzUxMiA2MC43IDQ4My4zIDMyIDQ0OCAzMnptMCAzNjRINjRjLTguOCAwLTE2LTcuMi0xNi0xNlY4OGMwLTguOCA3LjItMTYgMTYtMTZoMzg0YzguOCAwIDE2IDcuMiAxNiAxNnYzMTJjMCA4LjgtNy4yIDE2LTE2IDE2ek0zOTIgMTI4YzE3LjcgMCAzMiAxNC4zIDMyIDMycy0xNC4zIDMyLTMyIDMyLTMyLTE0LjMtMzItMzIgMTQuMy0zMiAzMi0zMnptLTI3MiAwYzE3LjcgMCAzMiAxNC4zIDMyIDMycy0xNC4zIDMyLTMyIDMyLTMyLTE4LjMtMzItMzIgMTQuMy0zMiAzMi0zMnoiLz48L3N2Zz4=',
    iconSize: [25, 25],
    iconAnchor: [12, 12],
    popupAnchor: [0, -12]
});

// أيقونة المستخدم الحالي
const userIcon = L.icon({
    iconUrl: 'data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9IjAgMCA0NDggNTEyIiBmaWxsPSIjMDBlYzAwIj48cGF0aCBkPSJNMjI0IDI1Nmg3MGM0MS4xIDAgNzQuOS0zMy44IDc0OS03NHMtMzMuOC03NC05LTc0aC03MGMtNDEuMSAwLTc0LjkgMzMuOC03NSA3NHMzMy44IDc0IDc1IDc0em0wLTE5MmM3MC43IDAgMTI4IDU3LjMgMTI4IDEyOHMtNTcuMyAxMjgtMTI4IDEyOC0xMjgtNTcuMy0xMjgtMTI4IDU3LjMtMTI4IDEyOC0xMjh6bTE5OC40IDI2OC4yQzM4Ni4xIDM0My4zIDMyOS44IDMyMCAyNjQgMzIwcy0xMjIuMSAyMy4yLTE1OC40IDEyLjJDMzkuNSAzNDEuNSAwIDM4MC40IDAgNDI4LjJWNDQ4YzAgMTcuNyAxNC4zIDMyIDMyIDMyaDM4NGMxNy43IDAgMzItMTQuMyAzMi0zMnYtMTkuOGMwLTQ3LjgtMzkuNS04Ni43LTg1LjYtOTEuOHoiLz48L3N2Zz4=',
    iconSize: [25, 25],
    iconAnchor: [12, 25],
    popupAnchor: [0, -25]
});

function fetchMyGps(){
    return new Promise((resolve)=>{
        if(!navigator.geolocation) {
            updateGpsStatus('المتصفح لا يدعم خدمة الموقع', 'error');
            // استخدام موقع صنعاء كافتراضي
            resolve({ lat: 15.3694, lng: 44.1910 });
            return;
        }
        
        // التحقق من إذن الموقع أولاً
        if (navigator.permissions) {
            navigator.permissions.query({name:'geolocation'}).then(function(result) {
                if (result.state === 'denied') {
                    updateGpsStatus('تم رفض الإذن. يرجى السماح بالوصول إلى الموقع في إعدادات المتصفح', 'error');
                    resolve({ lat: 15.3694, lng: 44.1910 });
                    return;
                }
            });
        }
        
        updateGpsStatus('جاري الحصول على الموقع...', 'warning');
        
        const options = {
            enableHighAccuracy: true,
            timeout: 30000,  // زيادة الوقت إلى 30 ثانية
            maximumAge: 60000  // السماح باستخدام المواقع المخزنة خلال الدقيقة الماضية
        };
        
        // إعادة تعيين watchId إذا كان موجوداً
        if (watchId) {
            navigator.geolocation.clearWatch(watchId);
        }
        
        watchId = navigator.geolocation.watchPosition(
            pos => {
                myGps = { lat: pos.coords.latitude, lng: pos.coords.longitude };
                gpsField.value = myGps.lat.toFixed(6)+','+myGps.lng.toFixed(6);
                updateGpsStatus('تم الحصول على الموقع بنجاح', 'success');
                
                // تحديث موقع العلامة على الخريطة إذا كانت موجودة
                if (myMarker) {
                    myMarker.setLatLng([myGps.lat, myGps.lng]);
                    if (map) {
                        map.panTo([myGps.lat, myGps.lng]);
                    }
                }
                
                resolve(myGps);
            }, 
            err => {
                console.error('GPS error:', err);
                let errorMsg = 'تعذر الحصول على موقعك. ';
                
                switch(err.code) {
                    case err.PERMISSION_DENIED:
                        errorMsg += 'تم رفض الإذن بالوصول إلى الموقع.';
                        break;
                    case err.POSITION_UNAVAILABLE:
                        errorMsg += 'معلومات الموقع غير متاحة.';
                        break;
                    case err.TIMEOUT:
                        errorMsg += 'انتهت مهلة طلب الموقع. جاري استخدام موقع افتراضي.';
                        break;
                    default:
                        errorMsg += 'حدث خطأ غير معروف.';
                }
                
                updateGpsStatus(errorMsg, 'error');
                // استخدام موقع صنعاء كافتراضي
                myGps = { lat: 15.3694, lng: 44.1910 };
                gpsField.value = myGps.lat.toFixed(6)+','+myGps.lng.toFixed(6);
                resolve(myGps);
            }, 
            options
        );
    });
}

// إعادة تحميل الموقع
function reloadLocation() {
    showStatusMessage('جاري تحديث الموقع...', 'info');
    fetchMyGps().then(() => {
        if (map) {
            initMapAndLoad();
        }
    });
}

// تبديل إظهار/إخفاء المسارات
function toggleRouteDisplay() {
    routeDisplayEnabled = !routeDisplayEnabled;
    
    // إخفاء أو إظهار جميع خطوط المسارات
    routingLines.forEach(line => {
        if (routeDisplayEnabled) {
            map.addLayer(line);
        } else {
            map.removeLayer(line);
        }
    });
    
    showStatusMessage(routeDisplayEnabled ? 'تم إظهار المسارات' : 'تم إخفاء المسارات', 'info');
}

// حفظ الخريطة للعمل بدون إنترنت
function downloadMapForOffline() {
    showStatusMessage('جاري تحضير الخريطة للعمل بدون اتصال...', 'info');
    
    // تحديد نطاق الخريطة الحالي
    const bounds = map.getBounds();
    const zoom = map.getZoom();
    
    // تخزين بيانات الخريطة في localStorage
    const mapData = {
        center: map.getCenter(),
        zoom: zoom,
        bounds: {
            _southWest: bounds.getSouthWest(),
            _northEast: bounds.getNorthEast()
        },
        timestamp: Date.now()
    };
    
    localStorage.setItem('offlineMapData', JSON.stringify(mapData));
    showStatusMessage('تم حفظ الخريطة للعمل بدون اتصال', 'success');
}

// استخراج الاسم الأول فقط من الاسم الرباعي
function getFirstName(fullName) {
    const names = fullName.trim().split(/\s+/);
    return names.length > 0 ? names[0] : fullName;
}

async function saveSubscriberToDB(sub){
    const uniqueId = generateUniqueId();
    const url = `${FIREBASE_DB_ROOT}/subscribers/${encodeURIComponent(uniqueId)}.json`;
    const payload = {...sub, id: uniqueId, createdAt: Date.now()};
    const r = await fetch(url, { method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
    if(!r.ok) throw new Error('DB error');
    return await r.json();
}

async function fetchAllSubscribers(){
    const url = `${FIREBASE_DB_ROOT}/subscribers.json`;
    try {
        const r = await fetch(url);
        const j = await r.json();
        const arr = [];
        for(const k in j){ 
            if(!j[k]) continue; 
            arr.push(j[k]); 
            subscribersCache[k]=j[k]; 
        }
        return arr;
    } catch (error) {
        console.error('Error fetching subscribers:', error);
        showStatusMessage('تعذر الاتصال بالخادم. جاري استخدام البيانات المخزنة محلياً', 'warning');
        
        // محاولة استخدام البيانات المخزنة محلياً
        const storedData = localStorage.getItem('subscribersData');
        if (storedData) {
            return JSON.parse(storedData);
        }
        return [];
    }
}

function distanceMeters(lat1, lon1, lat2, lon2){
    const R = 6371e3;
    const toRad = v => v*Math.PI/180;
    const φ1=toRad(lat1), φ2=toRad(lat2);
    const Δφ=toRad(lat2-lat1), Δλ=toRad(lon2-lon1);
    const a = Math.sin(Δφ/2)**2 + Math.cos(φ1)*Math.cos(φ2)*Math.sin(Δλ/2)**2;
    const c = 2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R*c;
}

function formatDistance(meters) {
    if (meters < 1000) {
        return Math.round(meters) + " متر";
    } else {
        return (meters / 1000).toFixed(2) + " كم";
    }
}

function callNumber(phone) {
    window.location.href = "tel:967" + phone;
}

function sendWhatsApp(phone) {
    const message = `السلام عليكم ورحمة الله وبركاتة
الموضوع طلب نقل/ توصيل
ارغب الانتقال الى /
يوم /
الساعه /
موقع اللقاء /
هل انت متفرغ نعم/لا

لقد اكتشفت رقمك من متجر 
AZ التسويق الشامل لتلبية احتياجك`;
    
    const encodedMessage = encodeURIComponent(message);
    window.open(`https://wa.me/967${phone}?text=${encodedMessage}`, '_blank');
}

formAdd.addEventListener('submit', async e=>{
    e.preventDefault();
    fullnameNote.classList.add('hidden');
    phone1Note.classList.add('hidden');
    phone2Note.classList.add('hidden');
    whatsappNote.classList.add('hidden');

    const fullname = fullnameEl.value.trim();
    if(!isFourNames(fullname)){ 
        fullnameNote.classList.remove('hidden'); 
        showStatusMessage('يجب إدخال الاسم الرباعي (4 كلمات على الأقل)', 'error');
        return; 
    }
    
    const jobname = jobnameEl.value.trim();
    if(!jobname){ 
        showStatusMessage('الاسم الوظيفي مطلوب', 'error');
        return; 
    }
    
    const phone1 = phone1El.value.trim();
    if(!isNineDigits(phone1)){ 
        phone1Note.classList.remove('hidden'); 
        showStatusMessage('رقم الجوال 1 يجب أن يتكون من 9 أرقام', 'error');
        return; 
    }
    
    const phone2 = phone2El.value.trim();
    if(phone2 && !isNineDigits(phone2)){ 
        phone2Note.classList.remove('hidden'); 
        showStatusMessage('رقم الجوال 2 يجب أن يتكون من 9 أرقام', 'error');
        return; 
    }
    
    const whatsapp = whatsappEl.value.trim();
    if(whatsapp && !isNineDigits(whatsapp)){ 
        whatsappNote.classList.remove('hidden'); 
        showStatusMessage('رقم الواتساب يجب أن يتكون من 9 أرقام', 'error');
        return; 
    }
    
    const days = [...document.querySelectorAll('.day')].filter(cb=>cb.checked).map(cb=>cb.value);
    const jobtype = jobtypeEl.value;

    if(!myIp) await fetchMyIp();
    if(!myGps) await fetchMyGps();

    const sub = {
        fullname, jobname, days, jobtype,
        from: document.getElementById('fromTime').value || '',
        to: document.getElementById('toTime').value || '',
        phone1, phone2, whatsapp,
        notes: notesEl.value.trim(),
        ip: myIp || 'unknown',
        gps: myGps || null
    };

    try {
        showStatusMessage('جاري حفظ بياناتك...', 'info');
        await saveSubscriberToDB(sub);
        showStatusMessage('تم حفظ بياناتك كمشترك بنجاح', 'success');
        
        // تخزين البيانات محلياً أيضاً
        const existingData = JSON.parse(localStorage.getItem('subscribersData') || '[]');
        existingData.push({...sub, id: generateUniqueId(), createdAt: Date.now()});
        localStorage.setItem('subscribersData', JSON.stringify(existingData));
        
        // إعادة تعيين النموذج
        formAdd.reset();
        
        // الانتقال إلى قائمة المشتركين
        tabList.click();
    } catch(err){
        console.error(err);
        showStatusMessage('حدث خطأ أثناء الحفظ. جاري حفظ البيانات محلياً', 'warning');
        
        // حفظ البيانات محلياً في حالة فشل الاتصال
        const existingData = JSON.parse(localStorage.getItem('subscribersData') || '[]');
        existingData.push({...sub, id: generateUniqueId(), createdAt: Date.now()});
        localStorage.setItem('subscribersData', JSON.stringify(existingData));
        
        // الانتقال إلى قائمة المشتركين
        tabList.click();
    }
});

// تصفية المشتركين حسب المسافة
function filterSubscribersByDistance(subscribers, maxDistance) {
    if (!maxDistance || maxDistance === 0) return subscribers;
    
    return subscribers.filter(s => {
        if (!s.gps || !s.gps.lat || !s.gps.lng) return false;
        const distance = distanceMeters(myGps.lat, myGps.lng, s.gps.lat, s.gps.lng);
        return distance <= maxDistance;
    });
}

// تصفية المشتركين حسب نوع الوظيفة (سائق باص فقط)
function filterSubscribersByJobType(subscribers) {
    return subscribers.filter(s => s.jobtype === 'سائق باص');
}

// فرز المشتركين حسب المسافة أو الاسم
function sortSubscribers(subscribers, sortBy) {
    if (sortBy === 'name') {
        return subscribers.sort((a, b) => {
            const nameA = getFirstName(a.fullname).toLowerCase();
            const nameB = getFirstName(b.fullname).toLowerCase();
            return nameA.localeCompare(nameB, 'ar');
        });
    } else {
        // الفرز حسب المسافة (الإفتراضي)
        return subscribers.sort((a, b) => a.distanceMeters - b.distanceMeters);
    }
}

// تهيئة الخريطة وعرض المشتركين
async function initMapAndLoad(){
    if(!myGps){
        await fetchMyGps();
    }

    // إعادة تهيئة الخريطة إذا كانت موجودة مسبقاً
    if (map) {
        map.remove();
        routingLines = [];
    }
    
    const mapElement = document.getElementById('map');
    mapElement.innerHTML = ''; // تنظيف محتوى الخريطة
    
    // محاولة تحميل بيانات الخريطة المخزنة محلياً
    let mapCenter = [myGps.lat, myGps.lng];
    let mapZoom = 13;
    
    const offlineMapData = localStorage.getItem('offlineMapData');
    if (offlineMapData) {
        const parsedData = JSON.parse(offlineMapData);
        mapCenter = [parsedData.center.lat, parsedData.center.lng];
        mapZoom = parsedData.zoom;
    }
    
    map = L.map(mapElement).setView(mapCenter, mapZoom);
    
    // إضافة طبقة الخريطة مع التحقق من الاتصال
    if (navigator.onLine) {
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '© OpenStreetMap contributors'
        }).addTo(map);
    } else {
        // استخدام خلفية بديلة في حالة عدم الاتصال
        L.tileLayer('', {
            attribution: 'الخريطة في وضع عدم الاتصال'
        }).addTo(map);
        
        // إضافة رسالة أن الخريطة في وضع عدم الاتصال
        L.rectangle(map.getBounds(), {
            color: "#ff7800",
            weight: 1,
            fillOpacity: 0.1
        }).addTo(map).bindPopup('الخريطة في وضع عدم الاتصال. بعض الميزات قد لا تعمل بشكل صحيح.').openPopup();
    }

    // إضافة علامة للمستخدم الحالي
    myMarker = L.marker([myGps.lat, myGps.lng], {icon: userIcon}).addTo(map)
        .bindPopup('<b>أنت هنا</b>').openPopup();

    let subs = [];
    try { 
        const listContainer = document.getElementById('listContainer');
        listContainer.innerHTML = '<div class="loading"><i class="fas fa-spinner fa-spin"></i> جاري تحميل بيانات المشتركين...</div>';
        
        subs = await fetchAllSubscribers(); 
        allSubscribers = [...subs]; // حفظ جميع المشتركين
        
        // تخزين البيانات محلياً لاستخدامها لاحقاً
        localStorage.setItem('subscribersData', JSON.stringify(subs));
    } 
    catch(err){ 
        console.error(err); 
        // محاولة استخدام البيانات المخزنة محلياً
        const storedData = localStorage.getItem('subscribersData');
        if (storedData) {
            subs = JSON.parse(storedData);
            allSubscribers = [...subs];
            showStatusMessage('جاري استخدام البيانات المخزنة محلياً', 'info');
        } else {
            showStatusMessage('تعذر جلب المشتركين.', 'error'); 
            return; 
        }
    }

    // تصفية المشتركين لعرض سائقي الباصات فقط
    subs = filterSubscribersByJobType(subs);
    
    // تطبيق تصفية المسافة
    const maxDistance = parseInt(distanceFilter.value);
    subs = filterSubscribersByDistance(subs, maxDistance);
    
    subs = subs.filter(s => s.gps && s.gps.lat && s.gps.lng);
    subs = subs.map(s=>{
        const d = distanceMeters(myGps.lat, myGps.lng, s.gps.lat, s.gps.lng);
        return {...s, distanceMeters: d};
    });
    
    // تطبيق الفرز
    const sortValue = sortBy.value;
    subs = sortSubscribers(subs, sortValue);

    const listContainer = document.getElementById('listContainer');
    listContainer.innerHTML = '';

    subs.forEach(s=>{
        const distText = formatDistance(s.distanceMeters);
        
        // إضافة علامة للمشترك مع أيقونة الباص
        const marker = L.marker([s.gps.lat, s.gps.lng], {icon: busIcon}).addTo(map).bindPopup(
            `<div style="text-align: center;">
                <strong><span class="bus-icon"><i class="fas fa-bus"></i></span> ${getFirstName(s.fullname)}</strong><br>
                <span class="jobtype-badge">${s.jobtype}</span><br>
                المسافة: ${distText}<br>
                جوال1: ${s.phone1 || '-'}<br>
                جوال2: ${s.phone2 || '-'}<br>
                واتساب: ${s.whatsapp || '-'}<br>
                ملاحظات: ${s.notes || '-'}
            </div>`
        );

        // إضافة خط المسار بين المستخدم الحالي والمشترك
        const routeLine = L.polyline(
            [[myGps.lat, myGps.lng], [s.gps.lat, s.gps.lng]],
            {color: 'red', weight: 3, dashArray: '5, 10'}
        );
        
        if (routeDisplayEnabled) {
            routeLine.addTo(map);
        }
        routingLines.push(routeLine);

        const card = document.createElement('div');
        card.className = 'subscriber-card';
        card.innerHTML = `
            <div>
                <span class="distance-badge">${distText}</span>
                <span class="jobtype-badge">${s.jobtype}</span>
                <strong><span class="bus-icon"><i class="fas fa-bus"></i></span> ${getFirstName(s.fullname)}</strong> - ${s.jobname}
            </div>
            <div class="subscriber-details hidden">
                ${s.phone1 ? `<a href="tel:967${s.phone1}" class="phone-link"><i class="fas fa-phone"></i> اتصال بالجوال 1</a>` : ''}
                ${s.phone2 ? `<a href="tel:967${s.phone2}" class="phone-link"><i class="fas fa-phone"></i> اتصال بالجوال 2</a>` : ''}
                ${s.whatsapp ? `<a href="javascript:void(0)" onclick="sendWhatsApp('${s.whatsapp}')" class="phone-link"><i class="fab fa-whatsapp"></i> واتساب</a>` : ''}
                ${s.notes ? `<div class="small">ملاحظات: ${s.notes}</div>` : ''}
                ${s.days && s.days.length > 0 ? `<div class="small">أيام الدوام: ${s.days.join('، ')}</div>` : ''}
                ${s.from && s.to ? `<div class="small">وقت الدوام: من ${s.from} إلى ${s.to}</div>` : ''}
            </div>
        `;
        
        card.addEventListener('click', (e)=>{
            // منع تنفيذ الحدث عند النقر على رابط
            if (e.target.tagName === 'A') return;
            
            const details = card.querySelector('.subscriber-details');
            details.classList.toggle('hidden');
            
            map.setView([s.gps.lat, s.gps.lng], 15);
            marker.openPopup();
        });
        
        listContainer.appendChild(card);
    });

    if(subs.length === 0){
        listContainer.innerHTML = '<div class="small">لا يوجد سائقو باصات ضمن المسافة المحددة.</div>';
    }
}

// عند تحميل الصفحة: جلب IP وGPS
(async function init(){
    // التحقق من حالة الاتصال أولاً
    updateOnlineStatus();
    
    // إظهار رسالة تحميل
    showStatusMessage('جاري تحميل البيانات...', 'info');
    
    await fetchMyIp();
    await fetchMyGps();
    
    // إخفاء رسالة التحميل
    statusMessage.classList.add('hidden');
    
    // إضافة مستمعين للتصفية والفرز
    distanceFilter.addEventListener('change', () => {
        if (map) {
            initMapAndLoad();
        }
    });
    
    sortBy.addEventListener('change', () => {
        if (map) {
            initMapAndLoad();
        }
    });
    
    // السماح دائمًا بإضافة مشتركين جدد
    tabAdd.style.display = 'block';
    tabAdd.classList.add('active');
    tabList.classList.remove('active');
    contentAdd.classList.remove('hidden');
    contentList.classList.add('hidden');
})();
</script>

</body>
</html>
