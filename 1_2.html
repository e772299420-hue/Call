<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<title>Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</title>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
<style>
/* ØªÙ†Ø³ÙŠÙ‚ Ø¹Ø§Ù… */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body { 
  font-family: Tahoma, sans-serif; 
  background: #ffffff; 
  margin: 0; 
  padding-top: 140px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
  padding-bottom: 60px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„ÙÙˆØªØ± Ø§Ù„Ø«Ø§Ø¨Øª */
}

/* Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
.header {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  background: #007bff;
  color: white;
  padding: 15px 20px;
  display: flex;
  align-items: center;
  justify-content: space-between;
  z-index: 1000;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
}

.header-content {
  display: flex;
  align-items: center;
  gap: 15px;
  width: 100%;
  max-width: 1200px;
  margin: 0 auto;
}

.logo {
  font-size: 24px;
  font-weight: bold;
}

.app-name {
  flex-grow: 1;
  text-align: center;
  font-size: 18px;
}

.screen-name {
  font-size: 16px;
  opacity: 0.9;
}

/* Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø© Ø§Ù„Ø«Ø§Ø¨Øª */
.filter-bar {
  position: fixed;
  top: 70px;
  left: 0;
  width: 100%;
  background: #f8f9fa;
  padding: 10px 20px;
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  z-index: 999;
  box-shadow: 0 2px 5px rgba(0,0,0,0.1);
  align-items: center;
}

.filter-item {
  display: flex;
  align-items: center;
  gap: 5px;
}

.filter-item label {
  font-weight: bold;
  font-size: 14px;
}

.filter-item select, .filter-item input {
  padding: 6px 10px;
  border-radius: 5px;
  border: 1px solid #ccc;
  font-size: 14px;
}

.filter-item input {
  width: 200px;
}

.reset-btn {
  padding: 6px 12px;
  background: #dc3545;
  color: white;
  border: none;
  border-radius: 5px;
  cursor: pointer;
  font-size: 14px;
  transition: 0.3s;
}

.reset-btn:hover {
  background: #c82333;
}

/* Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø«Ø§Ø¨Øª */
.footer {
  position: fixed;
  bottom: 0;
  left: 0;
  width: 100%;
  background: #007bff;
  color: white;
  text-align: center;
  padding: 15px;
  z-index: 1000;
  font-size: 14px;
}

/* Ù…Ø­ØªÙˆÙ‰ Ø§Ù„ØµÙØ­Ø© */
.page-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 20px;
}

h2 { 
  text-align:center; 
  margin:20px 0; 
  color: #333;
}

.products { 
  display: flex;
  flex-wrap: wrap;
  gap: 20px;
  padding: 20px;
  justify-content: center;
}

.card {
  background: linear-gradient(145deg, #ffffff, #f0f0f0);
  border-radius: 15px; 
  box-shadow: 0 5px 15px rgba(0,0,0,0.08); 
  overflow: hidden; 
  padding: 15px; 
  transition: transform 0.3s, box-shadow 0.3s;
  position: relative;
  width: 300px;
  display: flex;
  flex-direction: column;
  align-items: center;
}
.card:hover { 
  transform: translateY(-5px); 
  box-shadow:0 10px 20px rgba(0,0,0,0.15); 
}

.card.viewed {
  border: 2px solid #007bff;
  background: linear-gradient(145deg, #f0f8ff, #e0f0ff);
}

.images-preview { 
  display: flex; 
  gap: 10px; 
  flex-wrap: wrap; 
  margin-bottom: 15px; 
  justify-content: center; 
  width: 100%;
}
.images-preview img { 
  width: 200px; 
  height: 200px; 
  object-fit: cover; 
  border-radius: 10px;
  cursor: pointer; 
  transition: 0.3s;
  border: 3px solid #007bff;
}
.images-preview img:hover { 
  transform: scale(1.05); 
  border-color: #0056b3;
}

.icons { 
  display: flex; 
  justify-content: space-around; 
  margin: 15px 0; 
  width: 100%;
}
.icon { 
  cursor: pointer; 
  font-size: 18px; 
  display: flex; 
  align-items: center; 
  gap: 5px; 
  color: #007bff; 
  transition: 0.3s; 
}
.icon:hover { 
  color: #0056b3; 
}

.info {
  width: 100%;
  text-align: center;
}

.info h3 { 
  margin: 5px 0; 
  font-size: 20px; 
  color: #333; 
  font-weight: bold;
}

.info p { 
  margin: 5px 0; 
  font-size: 14px; 
  color: #444; 
}

.info .label {
  font-weight: bold;
  color: #007bff;
  font-size: 14px;
}

.merchant-info { 
  display: flex; 
  flex-direction: column;
  gap: 5px; 
  margin: 10px 0; 
  padding: 10px;
  background-color: #f8f9fa;
  border-radius: 8px;
  width: 100%;
}
.merchant-name { 
  display: flex; 
  align-items: center; 
  justify-content: center;
  gap: 5px; 
  cursor: pointer; 
  color: #007bff; 
  font-weight: bold; 
  transition: 0.3s; 
  text-align: center;
  font-size: 16px;
}
.merchant-name:hover { 
  color: #0056b3; 
  text-decoration: underline;
}

.notes-container {
  margin: 10px 0;
  position: relative;
  width: 100%;
}

.notes-preview {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  padding: 5px;
  background: #f8f9fa;
  border-radius: 5px;
  border: 1px solid #ddd;
  font-size: 14px;
}

.view-notes-btn {
  position: absolute;
  left: 5px;
  top: 50%;
  transform: translateY(-50%);
  background: #007bff;
  color: white;
  border: none;
  border-radius: 50%;
  width: 25px;
  height: 25px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
}

/* Lightbox */
#lightbox {
  position: fixed; 
  top: 0; 
  left: 0; 
  width: 100%; 
  height: 100%; 
  background: rgba(0,0,0,0.95);
  display: none; 
  align-items: center; 
  justify-content: center; 
  z-index: 1000; 
  overflow: hidden;
  cursor: zoom-out;
}
#lightbox img { 
  max-width: 90%;
  max-height: 90%;
  object-fit: contain; 
  transform: scale(0.8) rotate(0deg); 
  transition: transform 0.5s ease; 
  border-radius: 10px;
  box-shadow: 0 0 25px rgba(0,0,0,0.5);
}

/* Modal Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª */
.modal {
  display: none;
  position: fixed;
  z-index: 1001;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.5);
}
.modal-content {
  background-color: #fefefe;
  margin: 10% auto;
  padding: 20px;
  border: 1px solid #888;
  width: 80%;
  max-width: 600px;
  border-radius: 10px;
  position: relative;
}
.close {
  color: #aaa;
  float: left;
  font-size: 28px;
  font-weight: bold;
  cursor: pointer;
}

.loading {
  text-align: center;
  padding: 20px;
  color: #007bff;
}

.error {
  text-align: center;
  padding: 20px;
  color: #dc3545;
  background-color: #f8d7da;
  border-radius: 5px;
  margin: 20px;
}

.product-details {
  margin-top: 10px;
  font-size: 14px;
  color: #666;
  text-align: center;
}

.sort-options {
  text-align: center;
  margin: 15px 0;
}

.sort-options select {
  padding: 8px 15px;
  border-radius: 5px;
  border: 1px solid #ccc;
  font-size: 14px;
}
</style>
</head>
<body>

<!-- Ø§Ù„Ù‡ÙŠØ¯Ø± Ø§Ù„Ø«Ø§Ø¨Øª -->
<header class="header">
  <div class="header-content">
    <div class="logo">AZ</div>
    <div class="app-name">AZ Ø§Ù„ØªØ³ÙˆÙŠÙ‚ Ø§Ù„Ø´Ø§Ù…Ù„</div>
    <div class="screen-name">Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª</div>
  </div>
</header>

<!-- Ø´Ø±ÙŠØ· Ø§Ù„ÙÙ„ØªØ±Ø© -->
<div class="filter-bar">
  <div class="filter-item">
    <label for="governorate">Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø©:</label>
    <select id="governorate">
      <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>
    </select>
  </div>
  
  <div class="filter-item">
    <label for="region">Ø§Ù„Ù…Ù†Ø·Ù‚Ø©:</label>
    <select id="region">
      <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>
    </select>
  </div>
  
  <div class="filter-item">
    <label for="category">Ø§Ù„ÙØ¦Ø©:</label>
    <select id="category">
      <option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>
    </select>
  </div>
  
  <div class="filter-item">
    <label for="search">Ø¨Ø­Ø«:</label>
    <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ù…Ù†ØªØ¬...">
  </div>
  
  <button class="reset-btn" id="reset-filters">Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ†</button>
</div>

<!-- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ -->
<div class="page-content">
  <h2>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØªÙˆÙØ±Ø©</h2>
  
  <div class="sort-options">
    <label for="sort-by">ØªØ±ØªÙŠØ¨ Ø­Ø³Ø¨:</label>
    <select id="sort-by">
      <option value="name">Ø§Ù„Ø§Ø³Ù…</option>
      <option value="category">Ø§Ù„ÙØ¦Ø©</option>
      <option value="date">Ø§Ù„ØªØ§Ø±ÙŠØ®</option>
      <option value="merchant">Ø§Ù„ØªØ§Ø¬Ø±</option>
    </select>
  </div>
  
  <div class="products" id="products"></div>
</div>

<!-- Ø§Ù„ÙÙˆØªØ± Ø§Ù„Ø«Ø§Ø¨Øª -->
<footer class="footer">
  Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Ù„Ø¯Ù‰ Ø§Ù„Ù…Ù…ÙŠØ² Ø³ÙˆÙØª Ù„Ù„Ø£Ù†Ø¸Ù…Ø© Ø§Ù„Ù…Ø­Ø§Ø³Ø¨ÙŠØ© Ø§Ù„Ù…ØªÙƒØ§Ù…Ù„Ø©
</footer>

<!-- Lightbox -->
<div id="lightbox" onclick="closeLightbox()">
  <img id="lightbox-img" src="">
</div>

<!-- Modal Ù„Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª -->
<div id="notesModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <h3 id="modal-product-name"></h3>
    <div id="modal-notes-content"></div>
  </div>
</div>

<script>
const firebaseConfig = { databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/" };
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„ØªØ®Ø²ÙŠÙ†
let allProducts = [];
let allMerchants = [];
let allGovernorates = [];
let allRegions = [];
let allCategories = [];

// Ø¹Ù†Ø§ØµØ± ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…
const productsContainer = document.getElementById('products');
const governorateSelect = document.getElementById('governorate');
const regionSelect = document.getElementById('region');
const categorySelect = document.getElementById('category');
const searchInput = document.getElementById('search');
const resetButton = document.getElementById('reset-filters');
const sortSelect = document.getElementById('sort-by');

// ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù†Ø¯ Ø¨Ø¯Ø¡ Ø§Ù„ØªØ´ØºÙŠÙ„
window.addEventListener('load', () => {
  loadAllData();
});

// Ø¥Ø¹Ø¯Ø§Ø¯ Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù„Ù„Ø£Ø­Ø¯Ø§Ø«
searchInput.addEventListener('input', filterProducts);
governorateSelect.addEventListener('change', filterProducts);
regionSelect.addEventListener('change', filterProducts);
categorySelect.addEventListener('change', filterProducts);
sortSelect.addEventListener('change', filterProducts);
resetButton.addEventListener('click', resetFilters);

// Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
async function loadAllData() {
  try {
    productsContainer.innerHTML = '<div class="loading">Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...</div>';
    
    const [productsSnap, merchantsSnap, governoratesSnap, regionsSnap, categoriesSnap] = await Promise.all([
      db.ref("products").once("value"),
      db.ref("merchants").once("value"),
      db.ref("governorates").once("value"),
      db.ref("regions").once("value"),
      db.ref("categories").once("value")
    ]);
    
    allProducts = productsSnap.val() || {};
    allMerchants = merchantsSnap.val() || {};
    allGovernorates = governoratesSnap.val() || {};
    allRegions = regionsSnap.val() || {};
    allCategories = categoriesSnap.val() || {};
    
    // ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©
    populateFilterOptions();
    
    // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
    displayProducts(allProducts);
    
  } catch (error) {
    console.error("Error loading data:", error);
    productsContainer.innerHTML = '<div class="error">Ø­Ø¯Ø« Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.</div>';
  }
}

// ØªØ¹Ø¨Ø¦Ø© Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„ÙÙ„ØªØ±Ø©
function populateFilterOptions() {
  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª
  governorateSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø§Øª</option>';
  for (let id in allGovernorates) {
    const option = document.createElement('option');
    option.value = id;
    option.textContent = allGovernorates[id].name || id;
    governorateSelect.appendChild(option);
  }
  
  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ù…Ù†Ø§Ø·Ù‚
  regionSelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†Ø§Ø·Ù‚</option>';
  for (let id in allRegions) {
    const option = document.createElement('option');
    option.value = id;
    option.textContent = allRegions[id].name || id;
    regionSelect.appendChild(option);
  }
  
  // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„ÙØ¦Ø§Øª
  categorySelect.innerHTML = '<option value="">Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª</option>';
  for (let id in allCategories) {
    const option = document.createElement('option');
    option.value = id;
    option.textContent = allCategories[id].name || id;
    categorySelect.appendChild(option);
  }
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function displayProducts(products) {
  productsContainer.innerHTML = '';
  
  if (!products || Object.keys(products).length === 0) {
    productsContainer.innerHTML = '<div class="error">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</div>';
    return;
  }
  
  // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ù…ØµÙÙˆÙØ© Ù„Ù„ØªØ±ØªÙŠØ¨
  let productsArray = Object.entries(products);
  
  // ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø®ÙŠØ§Ø± Ø§Ù„Ù…Ø­Ø¯Ø¯
  const sortBy = sortSelect.value;
  productsArray.sort((a, b) => {
    const productA = a[1];
    const productB = b[1];
    
    switch(sortBy) {
      case 'name':
        return (productA.name || '').localeCompare(productB.name || '');
      case 'category':
        const categoryA = productA.categoryId ? (allCategories[productA.categoryId]?.name || '') : '';
        const categoryB = productB.categoryId ? (allCategories[productB.categoryId]?.name || '') : '';
        return categoryA.localeCompare(categoryB);
      case 'date':
        return (productB.publishDate || '').localeCompare(productA.publishDate || '');
      case 'merchant':
        const merchantA = productA.userId ? (allMerchants[productA.userId]?.name || '') : '';
        const merchantB = productB.userId ? (allMerchants[productB.userId]?.name || '') : '';
        return merchantA.localeCompare(merchantB);
      default:
        return 0;
    }
  });
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø±ØªØ¨Ø©
  for (let [pid, product] of productsArray) {
    if (!product || !product.userId) continue;
    
    const merchant = allMerchants[product.userId];
    if (!merchant || merchant.status !== "active" || product.availability !== "available") continue;
    
    const merchantName = merchant.name || merchant.username || "ØªØ§Ø¬Ø±";
    const categoryName = product.categoryId ? (allCategories[product.categoryId]?.name || '') : '';
    
    const card = createProductCard(pid, product, merchantName, categoryName);
    productsContainer.appendChild(card);
  }
}

// Ø¯Ø§Ù„Ø© Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬
function createProductCard(pid, product, merchantName, categoryName) {
  const card = document.createElement("div");
  card.className = "card";
  card.id = "card-" + pid;
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„ØµÙˆØ±
  const displayDiv = document.createElement("div");
  displayDiv.className = "images-preview";
  
  let urlsArray = [];
  if (Array.isArray(product.imageUrls)) {
    urlsArray = product.imageUrls;
  } else if (typeof product.imageUrls === "string") {
    urlsArray = product.imageUrls.split(",");
  }
  
  if (urlsArray.length > 0 && urlsArray[0]) {
    const img = document.createElement("img");
    img.src = formatDriveUrl(urlsArray[0])[0];
    img.alt = product.name || "ØµÙˆØ±Ø© Ø§Ù„Ù…Ù†ØªØ¬";
    img.onclick = () => {
      openLightbox(img.src);
      incrementViews(pid, card);
    };
    displayDiv.appendChild(img);
  }
  
  card.appendChild(displayDiv);
  
  // Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
  const infoDiv = document.createElement("div");
  infoDiv.className = "info";
  
  infoDiv.innerHTML = `
    <h3>${product.name || "Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…"}</h3>
    <p>${product.description || "Ù„Ø§ ÙŠÙˆØ¬Ø¯ ÙˆØµÙ"}</p>
    <p><span class="label">Ø§Ù„Ø³Ø¹Ø±:</span> ${product.price || "ØºÙŠØ± Ù…Ø­Ø¯Ø¯"} Ø±ÙŠØ§Ù„</p>
    
    ${categoryName ? `<p><span class="label">Ø§Ù„ÙØ¦Ø©:</span> ${categoryName}</p>` : ''}
    
    ${product.publishDate ? `<p><span class="label">ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø±:</span> ${formatDate(product.publishDate)}</p>` : ''}
    
    <div class="merchant-info">
      <div class="merchant-name" onclick="openMerchantPage('${merchantName}')">
        ${merchantName} ğŸ‘ˆ
      </div>
    </div>
  `;
  
  // Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ù…ÙˆØ¬ÙˆØ¯Ø©
  if (product.notes && product.notes.trim() !== "") {
    const notesContainer = document.createElement("div");
    notesContainer.className = "notes-container";
    
    const notesPreview = document.createElement("div");
    notesPreview.className = "notes-preview";
    notesPreview.textContent = product.notes;
    
    const viewNotesBtn = document.createElement("button");
    viewNotesBtn.className = "view-notes-btn";
    viewNotesBtn.innerHTML = "ğŸ“";
    viewNotesBtn.title = "Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙƒØ§Ù…Ù„Ø©";
    viewNotesBtn.onclick = () => showNotesModal(product.name, product.notes);
    
    notesContainer.appendChild(notesPreview);
    notesContainer.appendChild(viewNotesBtn);
    
    infoDiv.appendChild(notesContainer);
  }
  
  card.appendChild(infoDiv);
  
  // Ø¥Ø¶Ø§ÙØ© Ø£ÙŠÙ‚ÙˆÙ†Ø§Øª Ø§Ù„ØªÙØ§Ø¹Ù„
  const iconsDiv = document.createElement("div");
  iconsDiv.className = "icons";
  iconsDiv.innerHTML = `
    <div class="icon like">ğŸ‘ <span class="like-count">0</span></div>
    <div class="icon dislike">ğŸ‘ <span class="dislike-count">0</span></div>
    <div class="icon views">ğŸ‘ï¸ <span class="view-count">0</span></div>
    <div class="icon comment">ğŸ’¬ <span class="comment-count">0</span></div>
  `;
  
  card.appendChild(iconsDiv);
  
  // ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª
  loadProductStats(pid, card);
  
  return card;
}

// Ø¯Ø§Ù„Ø© ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±
function openMerchantPage(merchantName) {
  // Ø­ÙØ¸ Ø§Ø³Ù… Ø§Ù„ØªØ§Ø¬Ø± ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ† Ø§Ù„Ù…Ø­Ù„ÙŠ
  localStorage.setItem('selectedMerchant', merchantName);
  // ÙØªØ­ ØµÙØ­Ø© Ø§Ù„ØªØ§Ø¬Ø±
  window.open("ard_tagr.html", "_blank");
}

// Ø¯Ø§Ù„Ø© Ø²ÙŠØ§Ø¯Ø© Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª
function incrementViews(pid, card) {
  const viewRef = db.ref(`products_stats/${pid}/views`);
  viewRef.transaction(currentViews => {
    return (currentViews || 0) + 1;
  });
  
  // ØªÙ…ÙŠÙŠØ² Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© ÙƒÙ…Ø´Ø§Ù‡Ø¯Ø©
  card.classList.add('viewed');
}

// Ø¯Ø§Ù„Ø© ÙØªØ­ Lightbox Ù„Ù„ØµÙˆØ±Ø©
function openLightbox(imageUrl) {
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  lightboxImg.src = imageUrl;
  lightbox.style.display = 'flex';
  setTimeout(() => { lightboxImg.style.transform = "scale(1) rotate(360deg)"; }, 50);
}

// Ø¯Ø§Ù„Ø© Ø¥ØºÙ„Ø§Ù‚ Lightbox
function closeLightbox() {
  const lightbox = document.getElementById('lightbox');
  const lightboxImg = document.getElementById('lightbox-img');
  lightbox.style.display = 'none';
  lightboxImg.style.transform = "scale(0.8) rotate(0deg)";
}

// Ø¯Ø§Ù„Ø© Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù„Ø§Ø­Ø¸Ø§Øª ÙÙŠ Modal
function showNotesModal(productName, notes) {
  const modal = document.getElementById('notesModal');
  const productNameElement = document.getElementById('modal-product-name');
  const notesContentElement = document.getElementById('modal-notes-content');
  
  productNameElement.textContent = productName || "Ù…Ù†ØªØ¬ Ø¨Ø¯ÙˆÙ† Ø§Ø³Ù…";
  notesContentElement.textContent = notes;
  
  modal.style.display = "block";
}

// Ø¥ØºÙ„Ø§Ù‚ Modal Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ X
document.querySelector("#notesModal .close").addEventListener("click", function() {
  document.getElementById('notesModal').style.display = "none";
});

// Ø¥ØºÙ„Ø§Ù‚ Modal Ø¹Ù†Ø¯ Ø§Ù„Ù†Ù‚Ø± Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø­ØªÙˆÙ‰
window.addEventListener("click", function(event) {
  const modal = document.getElementById('notesModal');
  if (event.target == modal) {
    modal.style.display = "none";
  }
});

// Ø¯Ø§Ù„Ø© ØªØ­Ù…ÙŠÙ„ Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª Ø§Ù„Ù…Ù†ØªØ¬
async function loadProductStats(pid, card) {
  try {
    const statsSnap = await db.ref(`products_stats/${pid}`).once("value");
    const stats = statsSnap.val() || {};
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø´Ø§Ù‡Ø¯Ø§Øª
    const viewCountEl = card.querySelector(".view-count");
    viewCountEl.textContent = stats.views || 0;
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª ÙˆØ¹Ø¯Ù… Ø§Ù„Ø¥Ø¹Ø¬Ø§Ø¨
    const likeCountEl = card.querySelector(".like-count");
    const dislikeCountEl = card.querySelector(".dislike-count");
    
    likeCountEl.textContent = Array.isArray(stats.likes) ? stats.likes.length : 0;
    dislikeCountEl.textContent = Array.isArray(stats.dislikes) ? stats.dislikes.length : 0;
    
    // Ø¥Ø¹Ø¯Ø§Ø¯ Ø£Ø­Ø¯Ø§Ø« Ø§Ù„Ù†Ù‚Ø± Ù„Ù„Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª
    const likeEl = card.querySelector(".like");
    const dislikeEl = card.querySelector(".dislike");
    
    likeEl.onclick = () => handleReaction(pid, 'likes', likeCountEl, dislikeCountEl);
    dislikeEl.onclick = () => handleReaction(pid, 'dislikes', likeCountEl, dislikeCountEl);
    
    // ØªØ­Ø¯ÙŠØ« Ø¹Ø¯Ø¯ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚Ø§Øª
    const commentCountEl = card.querySelector(".comment-count");
    commentCountEl.textContent = Array.isArray(stats.comments) ? stats.comments.length : 0;
    
  } catch (error) {
    console.error("Error loading product stats:", error);
  }
}

// Ø¯Ø§Ù„Ø© Ù…Ø¹Ø§Ù„Ø¬Ø© Ø±Ø¯ÙˆØ¯ Ø§Ù„ÙØ¹Ù„ (Ø¥Ø¹Ø¬Ø§Ø¨Ø§Øª/Ø¹Ø¯Ù… Ø¥Ø¹Ø¬Ø§Ø¨)
async function handleReaction(pid, reactionType, likeCountEl, dislikeCountEl) {
  try {
    const uid = navigator.userAgent + Math.random().toString(36).substring(2);
    const reactionRef = db.ref(`products_stats/${pid}/${reactionType}`);
    const oppositeReactionType = reactionType === 'likes' ? 'dislikes' : 'likes';
    const oppositeReactionRef = db.ref(`products_stats/${pid}/${oppositeReactionType}`);
    
    // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø§Ù„ÙŠØ©
    const [reactionSnap, oppositeReactionSnap] = await Promise.all([
      reactionRef.once("value"),
      oppositeReactionRef.once("value")
    ]);
    
    let reactionData = reactionSnap.val() || [];
    let oppositeReactionData = oppositeReactionSnap.val() || [];
    
    // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù‚Ø¯ ØªÙØ§Ø¹Ù„ Ù…Ø³Ø¨Ù‚Ø§Ù‹ØŒ Ù„Ø§ Ù†ÙØ¹Ù„ anything
    if (reactionData.includes(uid)) return;
    
    // Ø¥Ø²Ø§Ù„Ø© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ù…Ø¹Ø§ÙƒØ³ Ø¥Ø°Ø§ Ù…ÙˆØ¬ÙˆØ¯
    if (oppositeReactionData.includes(uid)) {
      oppositeReactionData = oppositeReactionData.filter(x => x !== uid);
      await oppositeReactionRef.set(oppositeReactionData);
      dislikeCountEl.textContent = oppositeReactionData.length;
    }
    
    // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙØ§Ø¹Ù„ Ø§Ù„Ø¬Ø¯ÙŠØ¯
    reactionData.push(uid);
    await reactionRef.set(reactionData);
    
    // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¹Ø¯Ø§Ø¯
    if (reactionType === 'likes') {
      likeCountEl.textContent = reactionData.length;
      dislikeCountEl.textContent = oppositeReactionData.length;
    } else {
      dislikeCountEl.textContent = reactionData.length;
      likeCountEl.textContent = oppositeReactionData.length;
    }
    
  } catch (error) {
    console.error("Error handling reaction:", error);
  }
}

// Ø¯Ø§Ù„Ø© ØªØµÙÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª
function filterProducts() {
  const governorateValue = governorateSelect.value;
  const regionValue = regionSelect.value;
  const categoryValue = categorySelect.value;
  const searchValue = searchInput.value.toLowerCase();
  
  let filteredProducts = {...allProducts};
  
  // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ø¨Ø­Ø«
  if (searchValue) {
    for (let pid in filteredProducts) {
      const product = filteredProducts[pid];
      const productName = product.name || '';
      const productDescription = product.description || '';
      
      if (!productName.toLowerCase().includes(searchValue) && 
          !productDescription.toLowerCase().includes(searchValue)) {
        delete filteredProducts[pid];
      }
    }
  }
  
  // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„ÙØ¦Ø©
  if (categoryValue) {
    for (let pid in filteredProducts) {
      const product = filteredProducts[pid];
      if (product.categoryId !== categoryValue) {
        delete filteredProducts[pid];
      }
    }
  }
  
  // Ø§Ù„ØªØµÙÙŠØ© Ø­Ø³Ø¨ Ø§Ù„Ù…Ø­Ø§ÙØ¸Ø© ÙˆØ§Ù„Ù…Ù†Ø·Ù‚Ø© (Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ§Ø¬Ø±)
  if (governorateValue || regionValue) {
    for (let pid in filteredProducts) {
      const product = filteredProducts[pid];
      const merchant = allMerchants[product.userId];
      
      if (!merchant) {
        delete filteredProducts[pid];
        continue;
      }
      
      if (governorateValue && merchant.governorateId !== governorateValue) {
        delete filteredProducts[pid];
        continue;
      }
      
      if (regionValue && merchant.regionId !== regionValue) {
        delete filteredProducts[pid];
        continue;
      }
    }
  }
  
  // Ø¹Ø±Ø¶ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…ØµÙØ§Ø©
  displayProducts(filteredProducts);
}

// Ø¯Ø§Ù„Ø© Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙÙ„Ø§ØªØ±
function resetFilters() {
  governorateSelect.value = "";
  regionSelect.value = "";
  categorySelect.value = "";
  searchInput.value = "";
  sortSelect.value = "name";
  
  displayProducts(allProducts);
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ ØªØ§Ø±ÙŠØ® Firebase Ø¥Ù„Ù‰ ØªÙ†Ø³ÙŠÙ‚ Ù…Ù‚Ø±ÙˆØ¡
function formatDate(dateString) {
  if (!dateString) return "ØºÙŠØ± Ù…Ø­Ø¯Ø¯";
  
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('ar-EG');
  } catch (e) {
    return dateString;
  }
}

// Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªØ­ÙˆÙŠÙ„ Ø±Ø§Ø¨Ø· Google Drive
function formatDriveUrl(url) {
  if (!url) return [];
  let id = "";
  if (url.includes("/d/")) id = url.split("/d/")[1].split("/")[0];
  else if (url.includes("id=")) id = new URLSearchParams(url.split("?")[1]).get("id");
  else if (url.includes("drive.usercontent.google.com")) id = new URLSearchParams(url.split("?")[1]).get("id");
  if (!id) return [url];
  return [`https://drive.google.com/thumbnail?id=${id}`];
}
</script>
</body>
</html>
