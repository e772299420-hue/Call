<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>صفحة المنتجات - التسوق الشامل</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
<style>
    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    body { background-color: #f8f9fa; color: #333; min-height: 100vh; overflow-x:hidden; }

    /* شاشة البداية - تحسينات */
    #introScreen {
        position: fixed;
        top:0; left:0;
        width:100%; height:100%;
        background: linear-gradient(135deg, #6A5ACD 0%, #2575FC 100%);
        display:flex;
        flex-direction:column;
        justify-content:center;
        align-items:center;
        z-index:3000;
        overflow:hidden;
        transition: opacity 1s ease, transform 1s ease;
    }

    /* تأثير لمعة */
    #introScreen::after {
        content:"";
        position:absolute;
        top:0; left:0;
        width:100%; height:100%;
        background: linear-gradient(120deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.3) 50%, rgba(255,255,255,0.1) 100%);
        animation: shine 2s linear infinite;
    }

    @keyframes shine {
        0% { transform: translateX(-100%); }
        100% { transform: translateX(100%); }
    }

    .intro-content {
        position:relative;
        z-index:10;
        text-align:center;
        color:white;
        animation: fadeInUp 1.5s ease-out;
    }

    @keyframes fadeInUp {
        from { opacity:0; transform: translateY(50px); }
        to { opacity:1; transform: translateY(0); }
    }

    .intro-logo {
        font-size:80px;
        font-weight:bold;
        display:flex;
        align-items:center;
        justify-content:center;
        gap:15px;
        animation: pulse 2s infinite;
    }

    @keyframes pulse {
        from { transform: scale(1); }
        50% { transform: scale(1.05); }
        to { transform: scale(1); }
    }

    .intro-logo i { 
        font-size:80px; 
        color:orange;
        animation: rotate 3s ease-in-out infinite;
    }

    @keyframes rotate {
        0% { transform: rotateY(0deg); }
        50% { transform: rotateY(180deg); }
        100% { transform: rotateY(360deg); }
    }

    .intro-title { 
        font-size:48px; 
        margin-top:20px; 
        animation: slideInFromRight 1.5s ease-out;
    }

    @keyframes slideInFromRight {
        from { opacity:0; transform: translateX(100px); }
        to { opacity:1; transform: translateX(0); }
    }

    .intro-subtitle { 
        font-size:24px; 
        margin-top:10px; 
        animation: slideInFromLeft 1.5s ease-out;
    }

    @keyframes slideInFromLeft {
        from { opacity:0; transform: translateX(-100px); }
        to { opacity:1; transform: translateX(0); }
    }

    /* الشريط العلوي - تحسينات */
    .top-navbar {
        background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
        color:white; padding:15px 20px; position:fixed;
        top:0; left:0; right:0; z-index:1000;
        display:flex; justify-content:space-between; align-items:center;
        box-shadow:0 2px 10px rgba(0,0,0,0.2);
        animation: slideDown 0.5s ease-out;
    }

    @keyframes slideDown {
        from { transform: translateY(-100%); }
        to { transform: translateY(0); }
    }

    .logo { display:flex; align-items:center; }
    .logo h1 { font-size:1.5rem; margin-left:10px; }
    .logo img { width:40px; height:40px; border-radius:5px; }

    .menu-btn { 
        background:none; border:none; color:white; font-size:1.5rem; 
        cursor:pointer; padding:5px 10px; border-radius:5px; 
        transition:background 0.3s, transform 0.3s; 
    }
    .menu-btn:hover { 
        background: rgba(255,255,255,0.2); 
        transform: scale(1.1);
    }

    .dropdown-menu {
        position: fixed; top:70px; right:20px; background:white;
        border-radius:10px; box-shadow:0 5px 15px rgba(0,0,0,0.2);
        width:250px; overflow:hidden; display:none; z-index:999; 
        animation: fadeIn 0.3s ease, slideInFromTop 0.3s ease;
    }

    @keyframes slideInFromTop {
        from { opacity:0; transform: translateY(-20px); }
        to { opacity:1; transform: translateY(0); }
    }

    @keyframes fadeIn { 
        from { opacity:0; } 
        to { opacity:1; } 
    }

    .dropdown-menu.show { display:block; }
    .dropdown-item { 
        padding:15px 20px; display:flex; align-items:center; 
        color:#333; text-decoration:none; transition:background 0.3s, transform 0.3s; 
        border-bottom:1px solid #f0f0f0; 
    }
    .dropdown-item:last-child { border-bottom:none; }
    .dropdown-item:hover { 
        background:#f8f9fa; 
        transform: translateX(-5px);
    }
    .dropdown-item i { margin-left:10px; font-size:1.2rem; color:#6a11cb; }

    /* محتوى الصفحة - تحسينات */
    .content { 
        margin-top:80px; padding:20px; 
        animation: fadeInContent 1s ease-out;
    }

    @keyframes fadeInContent {
        from { opacity:0; }
        to { opacity:1; }
    }

    .page-title { 
        text-align:center; margin-bottom:30px; color:#333; 
        animation: fadeInUpTitle 1s ease-out;
    }

    @keyframes fadeInUpTitle {
        from { opacity:0; transform: translateY(30px); }
        to { opacity:1; transform: translateY(0); }
    }

    /* تصفية المنتجات */
    .filters-container {
        background: white;
        border-radius: 15px;
        padding: 20px;
        margin-bottom: 25px;
        box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 15px;
    }
    
    .filter-group {
        margin-bottom: 15px;
    }
    
    .filter-group label {
        display: block;
        margin-bottom: 8px;
        font-weight: bold;
        color: #495057;
    }
    
    .filter-group select, .filter-group input {
        width: 100%;
        padding: 12px 15px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 16px;
        transition: border-color 0.3s, box-shadow 0.3s;
    }
    
    .filter-group select:focus, .filter-group input:focus {
        border-color: #6a11cb;
        outline: none;
        box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2);
    }
    
    .search-box {
        grid-column: 1 / -1;
        position: relative;
    }
    
    .search-box i {
        position: absolute;
        left: 15px;
        top: 50%;
        transform: translateY(-50%);
        color: #6a11cb;
    }
    
    .search-box input {
        padding-left: 40px;
    }

    .products-grid { 
        display:grid; grid-template-columns:repeat(auto-fill,minmax(280px,1fr)); 
        gap:25px; margin-bottom:40px; 
    }
    .product-card { 
        background:white; border-radius:15px; overflow:hidden; 
        box-shadow:0 5px 15px rgba(0,0,0,0.1); 
        transition: transform 0.3s, box-shadow 0.3s;
        animation: fadeInUpCard 0.8s ease-out;
        animation-fill-mode: both;
        position: relative;
    }

    .product-card:nth-child(1) { animation-delay: 0.1s; }
    .product-card:nth-child(2) { animation-delay: 0.2s; }
    .product-card:nth-child(3) { animation-delay: 0.3s; }
    .product-card:nth-child(4) { animation-delay: 0.4s; }
    .product-card:nth-child(5) { animation-delay: 0.5s; }
    .product-card:nth-child(6) { animation-delay: 0.6s; }

    @keyframes fadeInUpCard {
        from { opacity:0; transform: translateY(50px); }
        to { opacity:1; transform: translateY(0); }
    }

    .product-card:hover { 
        transform:translateY(-8px); 
        box-shadow:0 12px 25px rgba(0,0,0,0.15); 
    }

    .image123-container {
        width: 100%;
        height: 220px;
        display: flex;
        align-items: center;
        justify-content: center;
        color: #999;
        transition: all 0.5s ease;
        position: relative;
        overflow: hidden;
        cursor: pointer;
        background: linear-gradient(45deg, #f0f0f0, #e0e0e0);
    }
    .image123-container img {
        width: 100%;
        height: 100%;
        object-fit: cover;
        transition: transform 0.3s ease;
    }
    .product-card:hover .image123-container .gallery-wrapper img,
    .product-card:hover .image123-container > img {
        transform: scale(1.05);
    }
    .product-img-placeholder {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        background: rgba(0,0,0,0.05);
    }
    .product-img-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.2);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
    }
    .image123-container:hover .product-img-overlay {
        opacity: 1;
    }
    .zoom-icon {
        color: white;
        font-size: 2rem;
        background: rgba(0,0,0,0.7);
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* Image Gallery Styles */
    .gallery-wrapper {
        display: flex;
        width: 100%;
        height: 100%;
        transition: transform 0.5s ease-in-out;
    }
    .gallery-wrapper img {
        flex-shrink: 0;
    }
    .gallery-controls {
        position: absolute;
        top: 50%;
        left: 0;
        right: 0;
        display: flex;
        justify-content: space-between;
        transform: translateY(-50%);
        pointer-events: none;
    }
    .gallery-btn {
        background: rgba(0, 0, 0, 0.5);
        color: white;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        width: 35px;
        height: 35px;
        margin: 0 10px;
        border-radius: 50%;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: all;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .image123-container:hover .gallery-btn {
        opacity: 1;
    }
    .gallery-dots {
        position: absolute;
        bottom: 10px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 8px;
    }
    .gallery-dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background: rgba(255, 255, 255, 0.6);
        cursor: pointer;
        transition: background 0.3s ease;
    }
    .gallery-dot.active {
        background: white;
    }

    .product-info { padding:20px; }
    .product-title { 
        font-weight:bold; 
        margin-bottom:12px; 
        color:#333; 
        font-size: 1.2rem;
        line-height: 1.4;
    }
    .product-price { 
        color:#6a11cb; 
        font-weight:bold; 
        margin-bottom:12px; 
        font-size: 1.3rem;
    }
    .product-description {
        color: #666;
        margin-bottom: 15px;
        line-height: 1.5;
        font-size: 0.95rem;
    }
    .merchant-name {
        color: #1976d2;
        font-weight: bold;
        margin-bottom: 15px;
        font-size: 1rem;
        display: flex;
        align-items: center;
    }
    
    .merchant-name i {
        margin-left: 8px;
    }
    
    .product-actions {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #eee;
    }

    .product-views {
        display: flex;
        align-items: center;
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .product-views i {
        margin-left: 6px;
        color: #6a11cb;
    }
    
    .action-buttons-group {
        display: flex;
        gap: 12px;
    }
    
    .like-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: #ccc;
        transition: color 0.3s;
        display: flex;
        align-items: center;
    }
    
    .like-btn.active {
        color: #e91e63;
    }
    
    .like-btn .likes-count {
        margin-right: 5px;
        font-size: 0.9rem;
    }
    
    .comment-btn, .share-btn {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: #6a11cb;
        transition: color 0.3s;
    }
    
    .comment-btn:hover, .share-btn:hover {
        color: #2575fc;
    }
    
    .comments-section {
        display: none;
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 10px;
    }
    
    .comments-section.active {
        display: block;
    }
    
    .comments-list {
        max-height: 200px;
        overflow-y: auto;
        margin-bottom: 15px;
    }
    
    .comment-item {
        padding: 10px;
        background: white;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .comment-author {
        font-weight: bold;
        color: #6a11cb;
        margin-bottom: 5px;
    }
    
    .add-comment {
        display: flex;
        gap: 10px;
    }
    
    .comment-input {
        flex-grow: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 20px;
        font-size: 0.9rem;
    }
    
    .emoji-picker {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.2rem;
        color: #6a11cb;
    }
    
    .send-comment {
        background: #6a11cb;
        color: white;
        border: none;
        border-radius: 20px;
        padding: 0 15px;
        cursor: pointer;
        transition: background 0.3s;
    }
    
    .send-comment:hover {
        background: #2575fc;
    }

    .merchant-link {
        display: inline-flex;
        align-items: center;
        background: #f1f3f5;
        color: #495057;
        padding: 8px 15px;
        border-radius: 20px;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
        border: 1px solid #e9ecef;
    }
    .merchant-link:hover {
        background: #6a11cb;
        color: white;
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(106, 17, 203, 0.3);
    }
    
    .product-card-footer {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 15px;
    }

    /* This is the shrunken 'imageUrls' field */
    .imageUrls-thumb {
        width: 40px;
        height: 40px;
        border-radius: 8px;
        object-fit: cover;
        border: 1px solid #eee;
    }


    /* نافذة البيانات الموسعة */
    .merchant-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
        backdrop-filter: blur(5px);
    }
    .merchant-modal.show {
        display: flex;
        animation: fadeIn 0.3s ease;
    }
    .merchant-content {
        background: white;
        border-radius: 15px;
        width: 90%;
        max-width: 600px;
        max-height: 80vh;
        overflow-y: auto;
        padding: 25px;
        position: relative;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3);
    }
    .merchant-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
    }
    .merchant-title {
        font-size: 1.5rem;
        font-weight: bold;
        color: #333;
        margin: 0;
    }
    .close-merchant {
        background: none;
        border: none;
        font-size: 1.5rem;
        color: #666;
        cursor: pointer;
        transition: color 0.3s;
    }
    .close-merchant:hover {
        color: #000;
    }
    .merchant-details {
        margin-bottom: 20px;
    }
    .merchant-field {
        display: flex;
        align-items: center;
        margin-bottom: 15px;
        padding: 12px;
        background: #f8f9fa;
        border-radius: 10px;
        transition: background 0.3s;
    }
    .merchant-field:hover {
        background: #e9ecef;
    }
    .field-icon {
        width: 40px;
        height: 40px;
        background: #6a11cb;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-size: 1.2rem;
        margin-left: 15px;
        flex-shrink: 0;
    }
    .field-content {
        flex-grow: 1;
    }
    .field-label {
        font-weight: 600;
        color: #495057;
        margin-bottom: 5px;
        font-size: 0.9rem;
    }
    .field-value {
        color: #212529;
        font-size: 1.1rem;
        word-break: break-all;
    }
    .field-link {
        background: #6a11cb;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        text-decoration: none;
        transition: all 0.3s;
        flex-shrink: 0;
    }
    .field-link:hover {
        background: #2575fc;
        transform: scale(1.1);
    }
    
    .merchant-map {
        height: 200px;
        border-radius: 10px;
        overflow: hidden;
        margin: 15px 0;
        border: 1px solid #e9ecef;
    }
    
    .distance-info {
        padding: 10px;
        background: #e8f5e9;
        border-radius: 8px;
        text-align: center;
        margin-top: 10px;
        font-weight: bold;
        color: #2e7d32;
    }

    /* نافذة الصورة الموسعة */
    .image-modal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.9);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    .image-modal.show {
        display: flex;
        animation: fadeIn 0.3s ease;
    }
    .image-modal-content {
        max-width: 90%;
        max-height: 90%;
        position: relative;
    }
    .modal-image {
        max-width: 100%;
        max-height: 90vh;
        border-radius: 10px;
        box-shadow: 0 5px 25px rgba(0,0,0,0.5);
    }
    .close-image {
        position: absolute;
        top: -40px;
        right: 0;
        background: none;
        border: none;
        color: white;
        font-size: 2rem;
        cursor: pointer;
    }

    /* تسجيل الدخول - تحسينات */
    .login-modal { 
        position: fixed; top:0; left:0; right:0; bottom:0; 
        background: rgba(0,0,0,0.7); display: none; 
        justify-content: center; align-items: center; z-index:2000; 
        animation: fadeIn 0.5s ease; 
        backdrop-filter: blur(5px);
    }
    .login-modal.show { display:flex; }
    .login-form { 
        background:white; border-radius:15px; padding:30px; 
        width:90%; max-width:400px; box-shadow:0 10px 30px rgba(0,0,0,0.3); 
        position:relative; 
        animation: modalSlideIn 0.5s ease-out;
    }

    @keyframes modalSlideIn {
        from { opacity:0; transform: translateY(-50px) scale(0.9); }
        to { opacity:1; transform: translateY(0) scale(1); }
    }

    .login-title { text-align:center; margin-bottom:20px; color:#333; }
    .form-group { margin-bottom:20px; position: relative; }
    .form-group label { display:block; margin-bottom:8px; font-weight:bold; color:#555; }
    .form-group input { 
        width:100%; padding:12px 15px; border:1px solid #ddd; border-radius:8px; 
        font-size:16px; transition:border-color 0.3s, box-shadow 0.3s; 
    }
    .form-group input:focus { 
        border-color:#6a11cb; outline:none; 
        box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.2);
    }
    
    .password-toggle {
        position: absolute;
        left: 15px;
        top: 42px;
        cursor: pointer;
        color: #6a11cb;
    }
    
    .login-btn { 
        display:block; width:100%; background:#6a11cb; color:white; 
        padding:12px; border-radius:8px; border:none; 
        font-size:18px; font-weight:bold; cursor:pointer; 
        transition:background 0.3s, transform 0.3s; 
    }
    .login-btn:hover { 
        background:#2575fc; 
        transform: translateY(-2px);
    }
    .close-btn { 
        position:absolute; top:10px; right:10px; background:none; border:none; 
        font-size:1.5rem; color:#666; cursor:pointer; transition:color 0.3s, transform 0.3s; 
    }
    .close-btn:hover { color:#000; transform: rotate(90deg); }
    .message { 
        margin-top:20px; padding:10px; border-radius:5px; 
        text-align:center; display:none; 
        animation: fadeIn 0.5s ease;
    }
    .error { background:#ffebee; color:#d32f2f; border:1px solid #d32f2f; }
    .success { background:#e8f5e9; color:#388e3c; border:1px solid #388e3c; }

    /* التذييل - تحسينات */
    .footer { 
        background: white;
        color: #1976d2;
        text-align: center;
        padding: 15px;
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        z-index: 900;
        font-weight: bold;
    }

    /* تأثيرات التمرير */
    .fade-in {
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.8s ease, transform 0.8s ease;
    }
    
    .fade-in.visible {
        opacity: 1;
        transform: translateY(0);
    }

    /* تنسيق الإشعارات */
    .toast-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        display: flex;
        flex-direction: column;
        gap: 10px;
    }
    
    .toast {
        padding: 15px 20px;
        border-radius: 8px;
        color: white;
        display: flex;
        align-items: center;
        justify-content: space-between;
        min-width: 300px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        animation: slideIn 0.3s ease;
        transition: opacity 0.3s ease;
    }
    
    .toast.success {
        background: #4caf50;
    }
    
    .toast.error {
        background: #f44336;
    }
    
    .toast-content {
        display: flex;
        align-items: center;
        gap: 10px;
    }
    
    .toast-icon {
        font-size: 20px;
    }
    
    .toast-close {
        background: none;
        border: none;
        color: white;
        cursor: pointer;
        font-size: 18px;
        opacity: 0.8;
        transition: opacity 0.3s;
    }
    
    .toast-close:hover {
        opacity: 1;
    }
    
    .toast-progress {
        position: absolute;
        bottom: 0;
        left: 0;
        height: 4px;
        background: rgba(255, 255, 255, 0.5);
        width: 100%;
        border-radius: 0 0 8px 8px;
        overflow: hidden;
    }
    
    .toast-progress-bar {
        height: 100%;
        background: white;
        animation: progressBar 5s linear forwards;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
    
    @keyframes progressBar {
        from { width: 100%; }
        to { width: 0%; }
    }
    
    .loading-products {
        text-align: center;
        padding: 60px 20px;
        color: #666;
        grid-column: 1 / -1;
    }
    
    .loading-products i {
        font-size: 3rem;
        margin-bottom: 20px;
        color: #6a11cb;
    }
    
    .no-products {
        text-align: center;
        padding: 60px 20px;
        color: #666;
        grid-column: 1 / -1;
    }
    
    .no-products i {
        font-size: 4rem;
        margin-bottom: 20px;
        color: #ccc;
    }
    
    .no-products p {
        font-size: 1.2rem;
        margin: 0;
    }
    
    .offline-message {
        position: fixed;
        top: 70px;
        left: 0;
        right: 0;
        background: #f44336;
        color: white;
        text-align: center;
        padding: 10px;
        z-index: 1000;
        display: none;
    }
    
    @media (max-width: 768px) {
        .toast-container {
            right: 10px;
            left: 10px;
        }
        
        .toast {
            min-width: unset;
            width: 100%;
        }
        
        .products-grid {
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
        }
        
        .image123-container {
            height: 180px;
        }
        
        .merchant-content {
            width: 95%;
            padding: 15px;
        }
        
        .merchant-field {
            flex-direction: column;
            align-items: flex-start;
        }
        
        .field-icon {
            margin-left: 0;
            margin-bottom: 10px;
        }
        
        .field-link {
            margin-top: 10px;
            align-self: flex-end;
        }
        
        .filters-container {
            grid-template-columns: 1fr;
        }
    }
</style>
</head>
<body>

<!-- شاشة البداية الثابتة -->
<div id="introScreen">
    <div class="intro-content">
        <div class="intro-logo">
            <i class="fas fa-shopping-cart"></i>
            <span>AZ</span>
        </div>
        <div class="intro-title">التسويق الشامل</div>
        <div class="intro-subtitle">لتلبية احتياجك بالكامل</div>
    </div>
</div>

<!-- رسالة عدم الاتصال -->
<div class="offline-message" id="offlineMessage">
    <i class="fas fa-wifi"></i> أنت غير متصل بالإنترنت. يتم الآن العمل في الوضع غير المتصل.
</div>

<!-- الشريط العلوي -->
<div class="top-navbar">
    <button class="menu-btn" id="menuBtn">
        <i class="fas fa-bars"></i> القائمة
    </button>
    <div class="logo">
        <h1>التسوق الشامل</h1>
        <img src="https://github.com/T772299420/Call/raw/main/BackgroundEraser_%D9%A2%D9%A0%D9%A2%D9%A5%D9%A0%D9%A9%D9%A0%D9%A5_%D9%A0%D9%A0%D9%A3%D9%A5%D9%A0%D9%A1%D9%A0%D9%A0%D9%A۷.png" alt="شعار التسوق الشامل">
    </div>
</div>

<!-- القائمة المنسدلة -->
<div class="dropdown-menu" id="dropdownMenu">
    <a href="#" class="dropdown-item" id="adminSiteBtn">
        <i class="fas fa-cog"></i> <span>إدارة الموقع</span>
    </a>
    <a href="#" class="dropdown-item" id="commercialAdminBtn">
        <i class="fas fa-user-tie"></i> <span>الإدارة التجارية</span>
    </a>
</div>

<!-- محتوى الصفحة -->
<div class="content">
    <h2 class="page-title">منتجاتنا</h2>
    
    <!-- فلاتر التصنيف -->
    <div class="filters-container">
        <div class="filter-group">
            <label for="provinceFilter">المحافظة</label>
            <select id="provinceFilter">
                <option value="">جميع المحافظات</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="regionFilter">المنطقة</label>
            <select id="regionFilter">
                <option value="">جميع المناطق</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="sectionFilter">القسم</label>
            <select id="sectionFilter">
                <option value="">جميع الأقسام</option>
            </select>
        </div>
        
        <div class="filter-group">
            <label for="merchantFilter">التاجر</label>
            <select id="merchantFilter">
                <option value="">جميع التجار</option>
            </select>
        </div>
        
        <div class="filter-group search-box">
            <label for="productSearch">بحث عن المنتج</label>
            <i class="fas fa-search"></i>
            <input type="text" id="productSearch" placeholder="اكتب اسم المنتج للبحث...">
        </div>
    </div>
    
    <div class="products-grid" id="productsContainer">
        <div class="loading-products">
            <i class="fas fa-spinner fa-spin"></i>
            <p>جاري تحميل المنتجات...</p>
        </div>
    </div>
</div>

<!-- نافذة بيانات التاجر -->
<div class="merchant-modal" id="merchantModal">
    <div class="merchant-content">
        <div class="merchant-header">
            <h3 class="merchant-title">بيانات التاجر</h3>
            <button class="close-merchant" id="closeMerchant">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <div class="merchant-details" id="merchantDetails">
            <!-- سيتم ملء هذا القسم بالبيانات من JavaScript -->
        </div>
        <div id="merchantMap" class="merchant-map"></div>
        <div id="distanceInfo" class="distance-info"></div>
    </div>
</div>

<!-- نافذة الصورة الموسعة -->
<div class="image-modal" id="imageModal">
    <div class="image-modal-content">
        <img class="modal-image" id="modalImage" src="" alt="صورة المنتج">
        <button class="close-image" id="closeImage">
            <i class="fas fa-times"></i>
        </button>
    </div>
</div>

<!-- نموذج تسجيل الدخول للإدارة التجارية -->
<div class="login-modal" id="commercialLoginModal">
    <div class="login-form">
        <button class="close-btn" id="closeCommercialLogin"><i class="fas fa-times"></i></button>
        <h2 class="login-title">تسجيل الدخول للإدارة التجارية</h2>
        <form id="commercialLoginForm">
            <div class="form-group">
                <label for="commercialUsername">اسم المستخدم</label>
                <input type="text" id="commercialUsername" name="username" required>
            </div>
            <div class="form-group">
                <label for="commercialPassword">كلمة المرور</label>
                <input type="password" id="commercialPassword" name="password" required>
                <i class="fas fa-eye password-toggle" id="toggleCommercialPassword"></i>
            </div>
            <button type="submit" class="login-btn">تسجيل الدخول</button>
        </form>
        <div id="commercialLoginMessage" class="message"></div>
    </div>
</div>

<!-- نموذج تسجيل الدخول لإدارة الموقع -->
<div class="login-modal" id="adminLoginModal">
    <div class="login-form">
        <button class="close-btn" id="closeAdminLogin"><i class="fas fa-times"></i></button>
        <h2 class="login-title">تسجيل الدخول لإدارة الموقع</h2>
        <form id="adminLoginForm">
            <div class="form-group">
                <label for="adminUsername">اسم المستخدم</label>
                <input type="text" id="adminUsername" name="username" required>
            </div>
            <div class="form-group">
                <label for="adminPassword">كلمة المرور</label>
                <input type="password" id="adminPassword" name="password" required>
                <i class="fas fa-eye password-toggle" id="toggleAdminPassword"></i>
            </div>
            <button type="submit" class="login-btn">تسجيل الدخول</button>
        </form>
        <div id="adminLoginMessage" class="message"></div>
    </div>
</div>

<!-- التذييل -->
<div class="footer">
    <p>إعداد وبرمجة/ المميز سوفت للأنظمة المحاسبية المتكاملة</p>
</div>

<!-- حاوية الإشعارات -->
<div class="toast-container" id="toastContainer"></div>

<!-- مكتبة Leaflet للخرائط -->
<script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>

<script>
// تهيئة Firebase
const firebaseConfig = {
    databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/"
};

// تهيئة Firebase
firebase.initializeApp(firebaseConfig);
const database = firebase.database();

// كائن تخزين بيانات المستخدم بشكل عام (جلوبال)
const globalUser = {
    data: null,
    
    // دالة لتخزين بيانات المستخدم
    setUserData: function(userData) {
        this.data = userData;
        localStorage.setItem('globalUserData', JSON.stringify(userData));
        console.log('تم تخزين بيانات المستخدم:', userData);
    },
    
    // دالة لاسترجاع بيانات المستخدم
    getUserData: function() {
        if (this.data) {
            return this.data;
        }
        
        const storedData = localStorage.getItem('globalUserData');
        if (storedData) {
            this.data = JSON.parse(storedData);
            return this.data;
        }
        
        return null;
    },
    
    getUsername: function() {
        const userData = this.getUserData();
        return userData ? userData.username : 'زائر';
    },
    
    getUserId: function() {
        const userData = this.getUserData();
        return userData ? userData.id : null;
    },
    
    isLoggedIn: function() {
        return this.getUserData() !== null;
    },
    
    logout: function() {
        this.data = null;
        localStorage.removeItem('globalUserData');
        console.log('تم تسجيل الخروج');
    }
};

// العناصر الأساسية في الصفحة
const menuBtn = document.getElementById('menuBtn');
const dropdownMenu = document.getElementById('dropdownMenu');
const adminSiteBtn = document.getElementById('adminSiteBtn');
const commercialAdminBtn = document.getElementById('commercialAdminBtn');
const adminLoginModal = document.getElementById('adminLoginModal');
const commercialLoginModal = document.getElementById('commercialLoginModal');
const closeAdminLogin = document.getElementById('closeAdminLogin');
const closeCommercialLogin = document.getElementById('closeCommercialLogin');
const adminLoginForm = document.getElementById('adminLoginForm');
const commercialLoginForm = document.getElementById('commercialLoginForm');
const adminLoginMessage = document.getElementById('adminLoginMessage');
const commercialLoginMessage = document.getElementById('commercialLoginMessage');
const introScreen = document.getElementById('introScreen');
const toastContainer = document.getElementById('toastContainer');
const productsContainer = document.getElementById('productsContainer');
const merchantModal = document.getElementById('merchantModal');
const merchantDetails = document.getElementById('merchantDetails');
const closeMerchant = document.getElementById('closeMerchant');
const imageModal = document.getElementById('imageModal');
const modalImage = document.getElementById('modalImage');
const closeImage = document.getElementById('closeImage');
const provinceFilter = document.getElementById('provinceFilter');
const regionFilter = document.getElementById('regionFilter');
const sectionFilter = document.getElementById('sectionFilter');
const merchantFilter = document.getElementById('merchantFilter');
const productSearch = document.getElementById('productSearch');
const toggleAdminPassword = document.getElementById('toggleAdminPassword');
const toggleCommercialPassword = document.getElementById('toggleCommercialPassword');
const adminPassword = document.getElementById('adminPassword');
const commercialPassword = document.getElementById('commercialPassword');
const offlineMessage = document.getElementById('offlineMessage');
const merchantMap = document.getElementById('merchantMap');
const distanceInfo = document.getElementById('distanceInfo');

// متغيرات التخزين المؤقت
let allProducts = [];
let allMerchants = [];
let filteredProducts = [];
let merchantLocationMap = null;
let currentPosition = null;

// دالة إنشاء معرف فريد
function generateId(text) {
    return text.toLowerCase()
        .replace(/[أ-ي]/g, (match) => {
            const arabicToEnglish = {
                'أ': 'a', 'ب': 'b', 'ت': 't', 'ث': 'th', 'ج': 'j', 'ح': 'h', 'خ': 'kh',
                'د': 'd', 'ذ': 'th', 'ر': 'r', 'ز': 'z', 'س': 's', 'ش': 'sh', 'ص': 's',
                'ض': 'd', 'ط': 't', 'ظ': 'th', 'ع': 'a', 'غ': 'gh', 'ف': 'f', 'ق': 'q',
                'ك': 'k', 'ل': 'l', 'م': 'm', 'ن': 'n', 'ه': 'h', 'و': 'w', 'ي': 'y'
            };
            return arabicToEnglish[match] || match;
        })
        .replace(/\s+/g, '_')
        .replace(/[^\w]/g, '');
}

// دالة لتحويل رابط جوجل درايف إلى رابط مباشر
function convertGoogleDriveUrl(url) {
    if (typeof url !== 'string' || !url.includes('drive.google.com')) {
        return url; // ليس رابط جوجل درايف، أعد الرابط كما هو
    }
    // يستخرج معرف الملف من الرابط
    const match = url.match(/drive\.google\.com\/(?:file\/d\/|open\?id=)([a-zA-Z0-9_-]+)/);
    if (match && match[1]) {
        const fileId = match[1];
        return `https://drive.google.com/uc?export=view&id=${fileId}`;
    }
    return url; // أعد الرابط الأصلي إذا لم يتم التعرف على الصيغة
}

// وظيفة عرض الإشعار
function showToast(message, type) {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    toast.innerHTML = `
        <div class="toast-content">
            <i class="fas ${icon} toast-icon"></i>
            <span>${message}</span>
        </div>
        <button class="toast-close">
            <i class="fas fa-times"></i>
        </button>
        <div class="toast-progress">
            <div class="toast-progress-bar"></div>
        </div>
    `;
    
    toastContainer.appendChild(toast);
    
    const closeBtn = toast.querySelector('.toast-close');
    closeBtn.addEventListener('click', () => {
        toast.style.opacity = '0';
        setTimeout(() => {
            toastContainer.removeChild(toast);
        }, 300);
    });
    
    setTimeout(() => {
        if (toast.parentNode === toastContainer) {
            toast.style.opacity = '0';
            setTimeout(() => {
                toastContainer.removeChild(toast);
            }, 300);
        }
    }, 5000);
}

// إخفاء شاشة البداية بتحريك سلس
function hideIntroScreen() {
    introScreen.style.opacity = '0';
    introScreen.style.transform = 'scale(1.1)';
    setTimeout(() => {
        introScreen.style.display = 'none';
    }, 1000);
}

// التحقق من ظهور العناصر عند التمرير
function checkScroll() {
    const elements = document.querySelectorAll('.fade-in');
    elements.forEach(el => {
        const elementTop = el.getBoundingClientRect().top;
        const elementVisible = 150;
        if (elementTop < window.innerHeight - elementVisible) {
            el.classList.add('visible');
        }
    });
}

// دالة لتحميل وعرض المنتجات من Firebase
async function loadProducts() {
    try {
        // التحقق من حالة الاتصال أولاً
        if (!navigator.onLine) {
            loadCachedProducts();
            return;
        }
        
        const [productsSnapshot, merchantsSnapshot] = await Promise.all([
            database.ref('products').once('value'),
            database.ref('merchants').once('value')
        ]);
        
        const products = productsSnapshot.val() || {};
        allMerchants = merchantsSnapshot.val() || {};
        
        // تحويل كائن المنتجات إلى مصفوفة
        allProducts = Object.entries(products).map(([id, product]) => ({
            id,
            ...product
        }));
        
        // تخزين البيانات مؤقتاً للعمل دون اتصال
        localStorage.setItem('cachedProducts', JSON.stringify(allProducts));
        localStorage.setItem('cachedMerchants', JSON.stringify(allMerchants));
        
        // تحميل الفلاتر
        loadFilters();
        
        // تصفية وعرض المنتجات
        filterProducts();
        
    } catch (error) {
        console.error('خطأ في تحميل المنتجات:', error);
        showToast('حدث خطأ في تحميل المنتجات', 'error');
        loadCachedProducts();
    }
}

// تحميل المنتجات المخزنة مؤقتاً
function loadCachedProducts() {
    const cachedProducts = localStorage.getItem('cachedProducts');
    const cachedMerchants = localStorage.getItem('cachedMerchants');
    
    if (cachedProducts && cachedMerchants) {
        allProducts = JSON.parse(cachedProducts);
        allMerchants = JSON.parse(cachedMerchants);
        loadFilters();
        filterProducts();
        showToast('يتم الآن العمل في الوضع غير المتصل', 'success');
    } else {
        productsContainer.innerHTML = `
            <div class="no-products">
                <i class="fas fa-wifi-slash"></i>
                <p>لا يوجد اتصال بالإنترنت ولا توجد بيانات مخزنة</p>
            </div>
        `;
    }
}

// تحميل قوائم التصفية
function loadFilters() {
    // مسح القوائم الحالية
    provinceFilter.innerHTML = '<option value="">جميع المحافظات</option>';
    regionFilter.innerHTML = '<option value="">جميع المناطق</option>';
    sectionFilter.innerHTML = '<option value="">جميع الأقسام</option>';
    merchantFilter.innerHTML = '<option value="">جميع التجار</option>';
    
    const provinces = new Set();
    const regions = new Set();
    const sections = new Set();
    
    // جمع القيم الفريدة من المنتجات والتجار
    allProducts.forEach(product => {
        if (product.province) provinces.add(product.province);
        if (product.region) regions.add(product.region);
        if (product.section) sections.add(product.section);
    });
    
    // إضافة المحافظات
    provinces.forEach(province => {
        const option = document.createElement('option');
        option.value = province;
        option.textContent = province;
        provinceFilter.appendChild(option);
    });
    
    // إضافة المناطق
    regions.forEach(region => {
        const option = document.createElement('option');
        option.value = region;
        option.textContent = region;
        regionFilter.appendChild(option);
    });
    
    // إضافة الأقسام
    sections.forEach(section => {
        const option = document.createElement('option');
        option.value = section;
        option.textContent = section;
        sectionFilter.appendChild(option);
    });
    
    // إضافة التجار النشطين فقط
    Object.entries(allMerchants).forEach(([id, merchant]) => {
        if (merchant.status === 'active' || merchant.status === 'نشط') {
            const option = document.createElement('option');
            option.value = id;
            option.textContent = merchant.name || merchant.commercialName || id;
            merchantFilter.appendChild(option);
        }
    });
}

// تصفية المنتجات حسب الفلاتر
function filterProducts() {
    const provinceValue = provinceFilter.value;
    const regionValue = regionFilter.value;
    const sectionValue = sectionFilter.value;
    const merchantValue = merchantFilter.value;
    const searchValue = productSearch.value.toLowerCase();
    
    filteredProducts = allProducts.filter(product => {
        // التحقق من حالة التاجر أولاً
        const merchant = allMerchants[product.userId];
        if (!merchant || (merchant.status !== 'active' && merchant.status !== 'نشط')) {
            return false;
        }
        
        // تطبيق الفلاتر
        if (provinceValue && product.province !== provinceValue) return false;
        if (regionValue && product.region !== regionValue) return false;
        if (sectionValue && product.section !== sectionValue) return false;
        if (merchantValue && product.userId !== merchantValue) return false;
        if (searchValue && !product.name.toLowerCase().includes(searchValue)) return false;
        
        return true;
    });
    
    // عرض المنتجات المصفاة
    displayProducts(filteredProducts);
}

// دالة لعرض بيانات التاجر
async function showMerchantDetails(merchantId) {
    try {
        // جلب بيانات التاجر
        const merchantData = allMerchants[merchantId];
        
        if (!merchantData) {
            showToast('لم يتم العثور على بيانات التاجر', 'error');
            return;
        }
        
        // تفريغ محتوى نافذة البيانات
        merchantDetails.innerHTML = '';
        
        // إضافة الحقول المختلفة مع أيقوناتها
        const fields = [
            { 
                icon: 'fa-user', 
                label: 'اسم التاجر', 
                value: merchantData.name || merchantData.commercialName || 'غير محدد',
                show: true
            },
            { 
                icon: 'fa-phone', 
                label: 'رقم الهاتف', 
                value: merchantData.phone,
                show: !!merchantData.phone,
                link: merchantData.phone ? `tel:${merchantData.phone}` : null
            },
            { 
                icon: 'fa-mobile-alt', 
                label: 'رقم الجوال / الواتساب', 
                value: merchantData.mobile,
                show: !!merchantData.mobile,
                link: merchantData.mobile ? `https://wa.me/${merchantData.mobile}` : null,
                whatsapp: true
            },
            { 
                icon: 'fa-envelope', 
                label: 'البريد الإلكتروني', 
                value: merchantData.email,
                show: !!merchantData.email,
                link: merchantData.email ? `mailto:${merchantData.email}` : null
            },
            { 
                icon: 'fa-map-marker-alt', 
                label: 'العنوان', 
                value: merchantData.address,
                show: !!merchantData.address
            },
            { 
                icon: 'fa-globe', 
                label: 'الموقع الإلكتروني', 
                value: merchantData.website,
                show: !!merchantData.website,
                link: merchantData.website ? merchantData.website : null
            }
        ];
        
        // إضافة الحقول إلى النافذة
        fields.forEach(field => {
            if (field.show) {
                const fieldElement = document.createElement('div');
                fieldElement.className = 'merchant-field';
                
                fieldElement.innerHTML = `
                    <div class="field-icon">
                        <i class="fas ${field.icon}"></i>
                    </div>
                    <div class="field-content">
                        <div class="field-label">${field.label}</div>
                        <div class="field-value">${field.value}</div>
                    </div>
                    ${field.link ? `
                        <a href="${field.link}" target="_blank" class="field-link" ${field.whatsapp ? 'data-whatsapp="true"' : ''}>
                            <i class="fas ${field.whatsapp ? 'fa-whatsapp' : 'fa-external-link-alt'}"></i>
                        </a>
                    ` : ''}
                `;
                
                merchantDetails.appendChild(fieldElement);
            }
        });
        
        // عرض الخريطة إذا كان هناك موقع
        if (merchantData.location) {
            showMerchantOnMap(merchantData.location, merchantData.name || merchantData.commercialName);
        } else {
            merchantMap.style.display = 'none';
            distanceInfo.style.display = 'none';
        }
        
        // عرض النافذة
        merchantModal.classList.add('show');
        
    } catch (error) {
        console.error('خطأ في تحميل بيانات التاجر:', error);
        showToast('حدث خطأ في تحميل بيانات التاجر', 'error');
    }
}

// عرض موقع التاجر على الخريطة
function showMerchantOnMap(location, merchantName) {
    merchantMap.style.display = 'block';
    distanceInfo.style.display = 'block';
    
    // تهيئة الخريطة إذا لم تكن موجودة
    if (!merchantLocationMap) {
        merchantLocationMap = L.map('merchantMap').setView([location.lat, location.lng], 13);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(merchantLocationMap);
    } else {
        merchantLocationMap.setView([location.lat, location.lng], 13);
    }
    
    // مسح العلامات السابقة
    merchantLocationMap.eachLayer(layer => {
        if (layer instanceof L.Marker) {
            merchantLocationMap.removeLayer(layer);
        }
    });
    
    // إضافة علامة للمتجر
    L.marker([location.lat, location.lng])
        .addTo(merchantLocationMap)
        .bindPopup(merchantName)
        .openPopup();
    
    // حساب المسافة إذا كان الموقع الحالي متاحاً
    if (currentPosition) {
        const distance = calculateDistance(
            currentPosition.coords.latitude,
            currentPosition.coords.longitude,
            location.lat,
            location.lng
        );
        
        distanceInfo.textContent = `المسافة إلى المتجر: ${distance.toFixed(2)} كم`;
    } else {
        distanceInfo.textContent = 'تم تحديد موقع المتجر. قم بتمكين الموقع الجغرافي لمعرفة المسافة.';
    }
}

// حساب المسافة بين موقعين
function calculateDistance(lat1, lon1, lat2, lon2) {
    const R = 6371; // نصف قطر الأرض بالكيلومتر
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a = 
        Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) * 
        Math.sin(dLon/2) * Math.sin(dLon/2); 
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
    const distance = R * c;
    return distance;
}

function deg2rad(deg) {
    return deg * (Math.PI/180);
}

// دالة لزيادة عدد مشاهدات المنتج
async function incrementProductView(productId, productCardElement) {
    try {
        const productRef = database.ref(`products/${productId}/views`);
        
        // استخدام transaction لضمان التحديث الآمن
        const { committed, snapshot } = await productRef.transaction(currentViews => {
            return (currentViews || 0) + 1;
        });

        if (committed) {
            const newViews = snapshot.val();
            // تحديث البيانات المحلية
            const productIndex = allProducts.findIndex(p => p.id === productId);
            if (productIndex > -1) {
                allProducts[productIndex].views = newViews;
            }

            // تحديث الواجهة مباشرة
            if (productCardElement) {
                const viewsCountElement = productCardElement.querySelector('.views-count');
                if (viewsCountElement) {
                    viewsCountElement.textContent = newViews;
                }
            }
        }
    } catch (error) {
        console.error('فشل في زيادة عدد المشاهدات:', error);
    }
}

// دالة لعرض الصورة بشكل مكبر
function showEnlargedImage(imageUrl) {
    modalImage.src = imageUrl;
    imageModal.classList.add('show');
}

// دالة لإعداد أحداث بطاقة المنتج
function setupProductCardEvents(productCard, product, merchant, images) {
    // منطق معرض الصور
    const imageContainer = productCard.querySelector('.image123-container');
    if (images.length > 1) {
        const wrapper = imageContainer.querySelector('.gallery-wrapper');
        const dots = imageContainer.querySelectorAll('.gallery-dot');
        let currentIndex = 0;

        const updateGallery = () => {
            wrapper.style.transform = `translateX(-${currentIndex * 100}%)`;
            dots.forEach((dot, index) => {
                dot.classList.toggle('active', index === currentIndex);
            });
        };

        imageContainer.querySelector('.next').addEventListener('click', (e) => {
            e.stopPropagation();
            currentIndex = (currentIndex + 1) % images.length;
            updateGallery();
        });

        imageContainer.querySelector('.prev').addEventListener('click', (e) => {
            e.stopPropagation();
            currentIndex = (currentIndex - 1 + images.length) % images.length;
            updateGallery();
        });

        dots.forEach(dot => {
            dot.addEventListener('click', (e) => {
                e.stopPropagation();
                currentIndex = parseInt(e.target.dataset.index, 10);
                updateGallery();
            });
        });

        // إضافة حدث النقر على الحاوية لتكبير الصورة
        imageContainer.addEventListener('click', (e) => {
            if (e.target.closest('.gallery-btn') || e.target.closest('.gallery-dot')) return;
            showEnlargedImage(images[currentIndex]);
        });

    } else if (images.length === 1) {
        imageContainer.addEventListener('click', () => {
            showEnlargedImage(images[0]);
        });
    }

    // بقية الأحداث
    const merchantLink = productCard.querySelector('.merchant-link');
    merchantLink.addEventListener('click', (e) => {
        e.preventDefault();
        incrementProductView(product.id, productCard);
        showMerchantDetails(product.userId);
    });
    
    const likeBtn = productCard.querySelector('.like-btn');
    likeBtn.addEventListener('click', function() {
        this.classList.toggle('active');
        const likesCount = this.querySelector('.likes-count');
        likesCount.textContent = this.classList.contains('active') ? '1' : '0';
    });
    
    const commentBtn = productCard.querySelector('.comment-btn');
    const commentsSection = productCard.querySelector('.comments-section');
    commentBtn.addEventListener('click', () => {
        commentsSection.classList.toggle('active');
    });
    
    const shareBtn = productCard.querySelector('.share-btn');
    shareBtn.addEventListener('click', function() {
        const productName = this.getAttribute('data-product');
        const merchantMobile = this.getAttribute('data-merchant');
        if (merchantMobile) {
            const message = `أهلاً، أنا مهتم بالمنتج: ${productName}`;
            const whatsappUrl = `https://wa.me/${merchantMobile}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        } else {
            showToast('لا يوجد رقم واتساب لهذا التاجر', 'error');
        }
    });
}

// دالة لعرض المنتجات في الواجهة
function displayProducts(products) {
    if (products.length === 0) {
        productsContainer.innerHTML = `
            <div class="no-products">
                <i class="fas fa-box-open"></i>
                <p>لا توجد منتجات متاحة حالياً</p>
            </div>
        `;
        return;
    }
    
    productsContainer.innerHTML = '';
    
    products.forEach((product, index) => {
        const merchant = allMerchants[product.userId] || {};
        const productCard = document.createElement('div');
        productCard.className = 'product-card fade-in';

        // التعامل مع الصور سواء كانت مصفوفة أو نصاً
        const images = Array.isArray(product.imageUrls) ? product.imageUrls : (product.imageUrls ? [product.imageUrls] : []);
        const convertedImages = images.map(url => convertGoogleDriveUrl(url)).filter(Boolean);

        let imageHtml = '';
        if (convertedImages.length > 0) {
            if (convertedImages.length > 1) {
                // HTML لمعرض الصور
                const imageTags = convertedImages.map(src => `<img src="${src}" alt="${product.name || 'صورة المنتج'}" loading="lazy" onerror="this.style.display='none';">`).join('');
                const dotTags = convertedImages.map((_, i) => `<div class="gallery-dot ${i === 0 ? 'active' : ''}" data-index="${i}"></div>`).join('');
                imageHtml = `
                    <div class="gallery-wrapper">${imageTags}</div>
                    <div class="gallery-controls">
                        <button class="gallery-btn prev"><i class="fas fa-chevron-left"></i></button>
                        <button class="gallery-btn next"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="gallery-dots">${dotTags}</div>
                    <div class="product-img-overlay"><div class="zoom-icon"><i class="fas fa-search-plus"></i></div></div>
                `;
            } else {
                // HTML لصورة واحدة
                imageHtml = `
                    <img src="${convertedImages[0]}" alt="${product.name || 'صورة المنتج'}" loading="lazy" onerror="this.style.display='none'; this.parentElement.querySelector('.product-img-placeholder').style.display='flex';">
                    <div class="product-img-placeholder" style="display: none;"><i class="fas fa-image fa-3x"></i></div>
                    <div class="product-img-overlay"><div class="zoom-icon"><i class="fas fa-search-plus"></i></div></div>
                `;
            }
        } else {
            // HTML في حال عدم وجود صورة
            imageHtml = `<div class="product-img-placeholder" style="display: flex;"><i class="fas fa-image fa-3x"></i></div>`;
        }

        productCard.innerHTML = `
            <div class="image123-container">
                ${imageHtml}
            </div>
            <div class="product-info">
                <div class="product-title">${product.name || 'منتج بدون اسم'}</div>
                <div class="product-price">${product.price ? `${product.price} ريال` : 'السعر غير متوفر'}</div>
                ${product.description ? `<div class="product-description">${product.description}</div>` : ''}
                <div class="merchant-name">
                    <i class="fas fa-store"></i> ${merchant.name || merchant.commercialName || 'تاجر غير معروف'}
                </div>
                <div class="product-actions">
                    <div class="product-views">
                        <i class="fas fa-eye"></i>
                        <span class="views-count">${product.views || 0}</span>
                    </div>
                    <div class="action-buttons-group">
                        <button class="like-btn" data-product-id="${product.id}">
                            <span class="likes-count">0</span>
                            <i class="fas fa-heart"></i>
                        </button>
                        <button class="comment-btn">
                            <i class="fas fa-comment"></i>
                        </button>
                        <button class="share-btn" data-product="${product.name}" data-merchant="${merchant.mobile}">
                            <i class="fas fa-share-alt"></i>
                        </button>
                    </div>
                </div>
                <div class="comments-section">
                    <div class="comments-list"></div>
                    <div class="add-comment">
                        <input type="text" class="comment-input" placeholder="أضف تعليقاً...">
                        <button class="emoji-picker">😊</button>
                        <button class="send-comment"><i class="fas fa-paper-plane"></i></button>
                    </div>
                </div>
                <div class="product-card-footer">
                    <a href="#" class="merchant-link" data-merchant-id="${product.userId}">
                        <i class="fas fa-store"></i> عرض بيانات التاجر
                    </a>
                    <img class="imageUrls-thumb" src="${convertedImages.length > 0 ? convertedImages[0] : ''}" alt="صورة مصغرة" onerror="this.style.display='none'">
                </div>
            </div>
        `;
        
        productsContainer.appendChild(productCard);
        
        // إعداد الأحداث للبطاقة الجديدة
        setupProductCardEvents(productCard, product, merchant, convertedImages);
        
        // تفعيل تأثير التمرير
        setTimeout(() => {
            checkScroll();
        }, 100 + (index * 100));
    });
}

// الحصول على الموقع الحالي مع معالجة الأخطاء
function getCurrentLocation() {
    if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(
            position => {
                currentPosition = position;
            },
            error => {
                console.error('خطأ في الحصول على الموقع:', error);
                let message = 'حدث خطأ أثناء محاولة الحصول على موقعك.';
                switch (error.code) {
                    case error.PERMISSION_DENIED:
                        message = 'تم رفض إذن الوصول إلى الموقع. لن نتمكن من حساب المسافة إلى المتاجر.';
                        break;
                    case error.POSITION_UNAVAILABLE:
                        message = 'معلومات موقعك غير متاحة حاليًا.';
                        break;
                    case error.TIMEOUT:
                        message = 'انتهت مهلة طلب تحديد الموقع.';
                        break;
                }
                showToast(message, 'error');
            }
        );
    } else {
        showToast('متصفحك لا يدعم تحديد الموقع الجغرافي.', 'error');
    }
}

// أحداث النقر على الأزرار
menuBtn.addEventListener('click', ()=> dropdownMenu.classList.toggle('show'));
document.addEventListener('click', e=>{ 
    if(!menuBtn.contains(e.target) && !dropdownMenu.contains(e.target)){ 
        dropdownMenu.classList.remove('show'); 
    } 
});

// فتح نافذة تسجيل الدخول للإدارة التجارية
commercialAdminBtn.addEventListener('click', e=>{ 
    e.preventDefault(); 
    dropdownMenu.classList.remove('show'); 
    commercialLoginModal.classList.add('show'); 
});

// فتح نافذة تسجيل الدخول لإدارة الموقع
adminSiteBtn.addEventListener('click', e=>{ 
    e.preventDefault(); 
    dropdownMenu.classList.remove('show'); 
    adminLoginModal.classList.add('show'); 
});

// إغلاق النوافذ
closeAdminLogin.addEventListener('click', ()=>{ 
    adminLoginModal.classList.remove('show'); 
    adminLoginMessage.style.display='none'; 
});

closeCommercialLogin.addEventListener('click', ()=>{ 
    commercialLoginModal.classList.remove('show'); 
    commercialLoginMessage.style.display='none'; 
});

closeMerchant.addEventListener('click', ()=>{ 
    merchantModal.classList.remove('show'); 
});

closeImage.addEventListener('click', ()=>{ 
    imageModal.classList.remove('show'); 
});

// إغلاق النوافذ عند النقر خارج المحتوى
merchantModal.addEventListener('click', (e) => {
    if (e.target === merchantModal) {
        merchantModal.classList.remove('show');
    }
});

imageModal.addEventListener('click', (e) => {
    if (e.target === imageModal) {
        imageModal.classList.remove('show');
    }
});

// أحداث الفلاتر
provinceFilter.addEventListener('change', filterProducts);
regionFilter.addEventListener('change', filterProducts);
sectionFilter.addEventListener('change', filterProducts);
merchantFilter.addEventListener('change', filterProducts);
productSearch.addEventListener('input', filterProducts);

// إظهار/إخفاء كلمة المرور
toggleAdminPassword.addEventListener('click', () => {
    const type = adminPassword.getAttribute('type') === 'password' ? 'text' : 'password';
    adminPassword.setAttribute('type', type);
    toggleAdminPassword.classList.toggle('fa-eye');
    toggleAdminPassword.classList.toggle('fa-eye-slash');
});

toggleCommercialPassword.addEventListener('click', () => {
    const type = commercialPassword.getAttribute('type') === 'password' ? 'text' : 'password';
    commercialPassword.setAttribute('type', type);
    toggleCommercialPassword.classList.toggle('fa-eye');
    toggleCommercialPassword.classList.toggle('fa-eye-slash');
});

// معالجة تسجيل الدخول للإدارة التجارية
commercialLoginForm.addEventListener('submit', async function(e){
    e.preventDefault();
    
    const username = document.getElementById('commercialUsername').value.trim();
    const password = document.getElementById('commercialPassword').value;
    
    try {
        if (!username || !password) {
            throw new Error('يرجى ملء جميع الحقول');
        }
        
        const merchantId = generateId(username);
        const merchantSnapshot = await database.ref('merchants').child(merchantId).once('value');
        const merchantData = merchantSnapshot.val();
        
        if (!merchantData) {
            throw new Error('اسم المستخدم أو كلمة المرور غير صحيحة');
        }
        
        if (merchantData.password !== password) {
            throw new Error('اسم المستخدم أو كلمة المرور غير صحيحة');
        }
        
        if (merchantData.status !== 'active' && merchantData.status !== 'نشط') {
            throw new Error('المستخدم تم توقيفه من قبل مسؤول النظام');
        }
        
        const userDataToStore = {
            id: merchantId,
            username: username,
            name: merchantData.name || username,
            commercialName: merchantData.commercialName || '',
            email: merchantData.email || '',
            phone: merchantData.phone || '',
            type: 'merchant',
            loginTime: new Date().toISOString()
        };
        
        globalUser.setUserData(userDataToStore);
        
        showToast('تم تسجيل الدخول بنجاح! مرحباً ' + username, 'success');
        commercialLoginForm.reset();
        
        setTimeout(() => {
            commercialLoginModal.classList.remove('show');
        }, 1000);
        
        setTimeout(() => {
            window.location.href = 'manjr_tagr_snf.html';
        }, 2000);
        
    } catch (error) {
        showToast(error.message, 'error');
    }
});

// معالجة تسجيل الدخول لإدارة الموقع
adminLoginForm.addEventListener('submit', async function(e){
    e.preventDefault();
    
    const username = document.getElementById('adminUsername').value.trim();
    const password = document.getElementById('adminPassword').value;
    
    try {
        if (!username || !password) {
            throw new Error('يرجى ملء جميع الحقول');
        }
        
        const adminSnapshot = await database.ref('admins').child(username).once('value');
        const adminData = adminSnapshot.val();
        
        if (!adminData) {
            throw new Error('اسم المستخدم غير صحيح');
        }
        
        if (adminData.password !== password) {
            throw new Error('كلمة المرور غير صحيحة');
        }
        
        const userDataToStore = {
            id: username,
            username: username,
            name: adminData.name || username,
            type: 'admin',
            loginTime: new Date().toISOString()
        };
        
        globalUser.setUserData(userDataToStore);
        
        showToast('تم تسجيل الدخول بنجاح! مرحباً ' + username, 'success');
        adminLoginForm.reset();
        
        setTimeout(() => {
            adminLoginModal.classList.remove('show');
        }, 1000);
        
        setTimeout(() => {
            window.location.href = 'mnjr_admin.html';
        }, 2000);
        
    } catch (error) {
        showToast(error.message, 'error');
    }
});

// التحقق من حالة الاتصال
function checkOnlineStatus() {
    if (!navigator.onLine) {
        offlineMessage.style.display = 'block';
    } else {
        offlineMessage.style.display = 'none';
    }
}

// تحميل المنتجات عند تحميل الصفحة
document.addEventListener('DOMContentLoaded', function() {
    const userData = globalUser.getUserData();
    if (userData) {
        console.log('تم اكتشاف مستخدم مسجل مسبقاً:', userData.username);
    }
    
    // الحصول على الموقع الحالي
    getCurrentLocation();
    
    // التحقق من حالة الاتصال
    checkOnlineStatus();
    window.addEventListener('online', checkOnlineStatus);
    window.addEventListener('offline', checkOnlineStatus);
    
    // تحميل المنتجات
    loadProducts();
});

// إخفاء شاشة البداية بعد 2 ثواني
setTimeout(hideIntroScreen, 2000);

// التحقق من التمرير
window.addEventListener('load', checkScroll);
window.addEventListener('scroll', checkScroll);
</script>

</body>
  </html>
  
