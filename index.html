<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>تسجيل الجهاز تلقائيًا</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
<style>
  body { font-family: Tahoma, sans-serif; margin:0; background:#f0f4f8; transition: background 0.5s ease; }
  header, footer { background:#007bff; color:#fff; padding:10px 20px; text-align:center; }
  header h1 { margin:0; font-size:24px; }
  .container { max-width:400px; margin:30px auto; background:#fff; padding:20px; border-radius:10px; box-shadow:0 0 15px rgba(0,0,0,0.1); text-align:center; transition: opacity 0.5s ease; }
  h2 { color:#007bff; margin-bottom:20px; }
  .loader { font-size:32px; font-weight:bold; color:#007bff; animation: bounce 1s infinite; }
  @keyframes bounce {
    0%,100% { transform: translateY(0); }
    50% { transform: translateY(-15px); }
  }
</style>
</head>
<body>

<header>
  <h1>نظام تسجيل الجهاز التلقائي</h1>
</header>

<div class="container" id="authContainer">
  <h2>جاري التحقق من جهازك...</h2>
  <p class="loader">يرجى الانتظار...</p>
</div>

<footer>
  &copy; 2025 جميع الحقوق محفوظة
</footer>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAub8yG87hhzVoZxflqpB_smvTFNpRY-Xw",
    authDomain: "chat-fat-free.firebaseapp.com",
    databaseURL: "https://chat-fat-free-default-rtdb.firebaseio.com/",
    projectId: "chat-fat-free",
    storageBucket: "chat-fat-free.appspot.com",
    messagingSenderId: "888827487238",
    appId: "1:888827238:web:6660cd0e8b7831dff40f87"
  };
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();
  const db = firebase.database();

  function generateUUID() {
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
      const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8);
      return v.toString(16);
    });
  }

  function autoRegister(deviceUUID) {
    db.ref('users').get().then(snapshot => {
      let userCount = snapshot.exists() ? Object.keys(snapshot.val()).length : 0;
      const email = (userCount + 1) + "@gmail.com";
      const password = "1234567";

      auth.createUserWithEmailAndPassword(email,password)
      .then(cred=>{
        const userId = cred.user.uid;
        db.ref('users/'+userId+'/devices/'+deviceUUID).set({
          createdAt: Date.now()
        }).then(()=>{
          fadeOutAndRedirect();
        });
      })
      .catch(err=>{
        console.error(err);
        document.getElementById('authContainer').innerHTML = "<p>حدث خطأ أثناء التسجيل التلقائي</p>";
      });
    });
  }

  function fadeOutAndRedirect() {
    const container = document.getElementById('authContainer');
    container.style.opacity = 0;
    document.body.style.background = '#007bff';
    setTimeout(()=>{ window.location.href = '1.html'; }, 500);
  }

  function checkDevice() {
    let deviceUUID = localStorage.getItem('deviceUUID');
    if(!deviceUUID){
      deviceUUID = generateUUID();
      localStorage.setItem('deviceUUID', deviceUUID);
    }

    setTimeout(()=>{
      auth.onAuthStateChanged(user => {
        if(user){
          db.ref('users/'+user.uid+'/devices/'+deviceUUID).get().then(snapshot=>{
            if(snapshot.exists()){
              fadeOutAndRedirect();
            } else {
              autoRegister(deviceUUID);
            }
          });
        } else {
          autoRegister(deviceUUID);
        }
      });
    }, 2000);
  }

  checkDevice();
</script>
</body>
</html>
